#!/usr/bin/env bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-02-06

# estimate-tokens.sh — Estimate token count for a codebase
# Usage: ./estimate-tokens.sh [project-dir]

set -euo pipefail

PROJECT_DIR="${1:-.}"

# Validate directory
if [ ! -d "$PROJECT_DIR" ]; then
  echo "Error: Directory '$PROJECT_DIR' does not exist" >&2
  exit 1
fi

echo "=== Token Estimation for: $PROJECT_DIR ==="
echo ""

# Count lines by file type (excluding common non-source directories)
EXCLUDE_DIRS="-path '*/node_modules' -o -path '*/.venv' -o -path '*/vendor' -o -path '*/__pycache__' -o -path '*/dist' -o -path '*/build' -o -path '*/.next' -o -path '*/out' -o -path '*/.git' -o -path '*/coverage'"

count_lines() {
  local ext="$1"
  local multiplier="$2"
  local label="$3"

  local lines
  lines=$(find "$PROJECT_DIR" \( $EXCLUDE_DIRS \) -prune -o -name "*.$ext" -print 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 | awk '{print $1}')
  lines=${lines:-0}

  if [ "$lines" -gt 0 ]; then
    local tokens=$((lines * multiplier))
    printf "  %-20s %8d lines  ×%d  = %10d tokens\n" "$label" "$lines" "$multiplier" "$tokens"
    echo "$tokens"
  else
    echo "0"
  fi
}

echo "File Type             Lines         Multiplier    Tokens"
echo "------------------------------------------------------------"

TOTAL=0

# TypeScript/JavaScript (~8 tokens/line)
for ext in ts tsx js jsx; do
  result=$(count_lines "$ext" 8 ".$ext")
  TOTAL=$((TOTAL + result))
done

# Python (~7 tokens/line)
result=$(count_lines "py" 7 ".py")
TOTAL=$((TOTAL + result))

# Go (~7 tokens/line)
result=$(count_lines "go" 7 ".go")
TOTAL=$((TOTAL + result))

# Config files (~5 tokens/line)
for ext in json yaml yml toml; do
  result=$(count_lines "$ext" 5 ".$ext")
  TOTAL=$((TOTAL + result))
done

# CSS/SCSS (~6 tokens/line)
for ext in css scss sass; do
  result=$(count_lines "$ext" 6 ".$ext")
  TOTAL=$((TOTAL + result))
done

# Markdown (~6 tokens/line)
result=$(count_lines "md" 6 ".md")
TOTAL=$((TOTAL + result))

# SQL (~6 tokens/line)
result=$(count_lines "sql" 6 ".sql")
TOTAL=$((TOTAL + result))

echo "------------------------------------------------------------"
printf "  %-20s %35s\n" "TOTAL" "$TOTAL tokens"
echo ""

# Context fit assessment
echo "=== Context Fit Assessment ==="
if [ "$TOTAL" -lt 150000 ]; then
  echo "  200K context: YES (standard)"
elif [ "$TOTAL" -lt 450000 ]; then
  echo "  200K context: NO"
  echo "  500K context: YES"
elif [ "$TOTAL" -lt 950000 ]; then
  echo "  200K context: NO"
  echo "  500K context: NO"
  echo "  1M context:   YES (beta, Tier 4+)"
else
  echo "  200K context: NO"
  echo "  500K context: NO"
  echo "  1M context:   PARTIAL (need directory scoping)"
  echo ""
  echo "  Recommendation: Use /ork:verify for chunked multi-agent approach"
  echo "  or scope to specific directories with /audit-full"
fi
echo ""
