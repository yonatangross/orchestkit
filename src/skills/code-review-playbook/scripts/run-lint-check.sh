#!/bin/bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-02-14

# Run Lint Check
# Detects and runs the project's linter with unified output.
#
# Usage: ./run-lint-check.sh [OPTIONS]
#
# Options:
#   --fix     Auto-fix fixable issues
#   --help    Show this help message
#
# Supported linters (auto-detected):
#   - ruff        (Python, from pyproject.toml with [tool.ruff])
#   - eslint      (JS/TS, from .eslintrc* or eslint.config.*)
#   - biome       (JS/TS, from biome.json or biome.jsonc)
#
# Exit codes:
#   0 = no lint issues
#   1 = lint issues found
#   2 = usage error or no linter found

set -euo pipefail

# =============================================================================
# CONFIGURATION
# =============================================================================

AUTO_FIX=""
LINTER=""
LINT_EXIT=0

# =============================================================================
# ARGUMENT PARSING
# =============================================================================

while [[ $# -gt 0 ]]; do
    case "$1" in
        --fix)
            AUTO_FIX="true"
            shift
            ;;
        --help|-h)
            echo "Run Lint Check"
            echo ""
            echo "Usage: $0 [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --fix     Auto-fix fixable issues"
            echo "  --help    Show this help message"
            echo ""
            echo "Supported linters (auto-detected):"
            echo "  - ruff        Python (pyproject.toml with [tool.ruff])"
            echo "  - eslint      JS/TS (.eslintrc* or eslint.config.*)"
            echo "  - biome       JS/TS (biome.json)"
            echo ""
            echo "Exit codes:"
            echo "  0 = no lint issues"
            echo "  1 = lint issues found"
            echo "  2 = usage error"
            exit 0
            ;;
        *)
            echo "Error: Unknown option '$1'. Use --help for usage." >&2
            exit 2
            ;;
    esac
done

# =============================================================================
# LINTER DETECTION
# =============================================================================

detect_linter() {
    # Check for biome first (newer, faster)
    if [[ -f "biome.json" || -f "biome.jsonc" ]]; then
        if command -v biome >/dev/null 2>&1 || npx biome --version >/dev/null 2>&1; then
            echo "biome"
            return
        fi
    fi

    # Check for eslint
    local eslint_configs=(.eslintrc .eslintrc.js .eslintrc.cjs .eslintrc.json .eslintrc.yml .eslintrc.yaml eslint.config.js eslint.config.mjs eslint.config.cjs eslint.config.ts)
    for config in "${eslint_configs[@]}"; do
        if [[ -f "$config" ]]; then
            if command -v eslint >/dev/null 2>&1 || npx eslint --version >/dev/null 2>&1; then
                echo "eslint"
                return
            fi
        fi
    done

    # Check for ruff (Python)
    if [[ -f "pyproject.toml" ]] && grep -q '\[tool\.ruff\]' pyproject.toml 2>/dev/null; then
        if command -v ruff >/dev/null 2>&1; then
            echo "ruff"
            return
        fi
    fi

    # Check for ruff config file
    if [[ -f "ruff.toml" || -f ".ruff.toml" ]]; then
        if command -v ruff >/dev/null 2>&1; then
            echo "ruff"
            return
        fi
    fi

    echo ""
}

LINTER=$(detect_linter)

if [[ -z "$LINTER" ]]; then
    echo "Error: No supported linter detected." >&2
    echo "Supported: ruff (Python), eslint (JS/TS), biome (JS/TS)" >&2
    echo "Ensure a config file exists and the linter is installed." >&2
    exit 2
fi

# =============================================================================
# RUN LINTER
# =============================================================================

echo "============================================================================"
echo "  Lint Check: $LINTER"
echo "============================================================================"
echo ""

case "$LINTER" in
    ruff)
        if [[ -n "$AUTO_FIX" ]]; then
            echo "Running: ruff check --fix ."
            ruff check --fix . 2>&1 || LINT_EXIT=$?
        else
            echo "Running: ruff check ."
            ruff check . 2>&1 || LINT_EXIT=$?
        fi
        ;;

    eslint)
        if [[ -n "$AUTO_FIX" ]]; then
            echo "Running: eslint --fix ."
            npx eslint --fix . 2>&1 || LINT_EXIT=$?
        else
            echo "Running: eslint ."
            npx eslint . 2>&1 || LINT_EXIT=$?
        fi
        ;;

    biome)
        if [[ -n "$AUTO_FIX" ]]; then
            echo "Running: biome check --fix ."
            npx biome check --fix . 2>&1 || LINT_EXIT=$?
        else
            echo "Running: biome check ."
            npx biome check . 2>&1 || LINT_EXIT=$?
        fi
        ;;
esac

echo ""
echo "============================================================================"
if [[ $LINT_EXIT -eq 0 ]]; then
    echo "  No lint issues found"
else
    echo "  Lint issues found (exit code: $LINT_EXIT)"
fi
echo "============================================================================"

exit $LINT_EXIT
