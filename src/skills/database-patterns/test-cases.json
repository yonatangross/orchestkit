{
  "skill": "database-patterns",
  "version": "2.0.0",
  "testCases": [
    {
      "id": "alembic-autogenerate",
      "rule": "alembic-autogenerate",
      "query": "Generate an Alembic migration from SQLAlchemy model changes",
      "expectedBehavior": [
        "Uses alembic revision --autogenerate",
        "Configures async env.py with asyncpg",
        "Reviews generated SQL before applying",
        "Sets target_metadata from Base.metadata"
      ]
    },
    {
      "id": "alembic-data-migration",
      "rule": "alembic-data-migration",
      "query": "Add a NOT NULL column to a large production table",
      "expectedBehavior": [
        "Uses two-phase approach: nullable first then alter",
        "Backfills data in batches with LIMIT and FOR UPDATE SKIP LOCKED",
        "Creates indexes CONCURRENTLY outside transaction",
        "Implements proper downgrade function"
      ]
    },
    {
      "id": "alembic-branching",
      "rule": "alembic-branching",
      "query": "Merge two parallel Alembic migration branches",
      "expectedBehavior": [
        "Uses alembic merge to combine branch heads",
        "Creates merge revision with tuple down_revision",
        "Uses branch labels for feature isolation",
        "Documents merge point in migration docstring"
      ]
    },
    {
      "id": "schema-normalization",
      "rule": "schema-normalization",
      "query": "Design a normalized database schema for an e-commerce system",
      "expectedBehavior": [
        "Normalizes to 3NF with separate entity tables",
        "Uses atomic values (no comma-separated lists)",
        "Eliminates transitive dependencies",
        "Justifies any denormalization with performance evidence"
      ]
    },
    {
      "id": "schema-indexing",
      "rule": "schema-indexing",
      "query": "Optimize slow database queries with proper indexing",
      "expectedBehavior": [
        "Indexes foreign keys and WHERE clause columns",
        "Uses composite indexes with most selective column first",
        "Chooses correct index type (B-tree, GIN, HNSW)",
        "Considers partial indexes for filtered queries"
      ]
    },
    {
      "id": "schema-nosql",
      "rule": "schema-nosql",
      "query": "Design a MongoDB schema for a content management system",
      "expectedBehavior": [
        "Chooses embed vs reference based on access patterns",
        "Considers document size limits",
        "Plans sharding key for even distribution",
        "Defines schema validation rules"
      ]
    },
    {
      "id": "versioning-changelog",
      "rule": "versioning-changelog",
      "query": "Set up schema version tracking for a database",
      "expectedBehavior": [
        "Creates schema_version table with checksums",
        "Uses semantic versioning (MAJOR.MINOR.PATCH)",
        "Implements audit trail with row-level versioning or CDC",
        "Tracks applied_at, applied_by, and execution_time"
      ]
    },
    {
      "id": "versioning-rollback",
      "rule": "versioning-rollback",
      "query": "Test database migration rollback procedures",
      "expectedBehavior": [
        "Tests upgrade and downgrade cycle locally",
        "Verifies data preservation after rollback",
        "Documents destructive rollbacks in migration docstring",
        "Includes CI pipeline for migration testing"
      ]
    },
    {
      "id": "versioning-drift",
      "rule": "versioning-drift",
      "query": "Detect and prevent schema drift across environments",
      "expectedBehavior": [
        "Uses checksum verification on deployed migrations",
        "Implements advisory locks for concurrent migration prevention",
        "Configures environment-specific settings (timeouts, locks)",
        "Follows local -> CI -> staging -> production flow"
      ]
    }
  ]
}
