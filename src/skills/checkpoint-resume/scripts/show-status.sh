#!/usr/bin/env bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-02-19

# show-status.sh â€” Print a human-readable pipeline status summary
# Usage: scripts/show-status.sh [path/to/pipeline-state.json]
# Requires: jq

set -euo pipefail

if [[ "${1:-}" == "--help" ]]; then
  echo "Usage: scripts/show-status.sh [path/to/pipeline-state.json]"
  echo "Prints a human-readable summary of the pipeline state."
  exit 0
fi

STATE_FILE="${1:-.claude/pipeline-state.json}"

if [[ ! -f "$STATE_FILE" ]]; then
  echo "No pipeline state found at: $STATE_FILE"
  echo "Run /checkpoint-resume to start a new pipeline."
  exit 0
fi

if ! jq empty "$STATE_FILE" 2>/dev/null; then
  echo "ERROR: $STATE_FILE is not valid JSON"
  exit 1
fi

BRANCH=$(jq -r '.context_summary.branch // "unknown"' "$STATE_FILE")
COMPLETED=$(jq -r '.completed_phases | length' "$STATE_FILE")
REMAINING=$(jq -r '.remaining_phases | length' "$STATE_FILE")
CURRENT_NAME=$(jq -r '.current_phase.name // "none"' "$STATE_FILE")
CURRENT_PROGRESS=$(jq -r '.current_phase.progress_description // ""' "$STATE_FILE")
UPDATED=$(jq -r '.updated_at' "$STATE_FILE")

echo "Pipeline Status"
echo "==============="
echo "Branch:   $BRANCH"
echo "Updated:  $UPDATED"
echo ""
echo "Completed ($COMPLETED phases):"
jq -r '.completed_phases[] | "  \u2713 \(.name) (\(.timestamp | split("T")[1] | split("Z")[0]))\(if .commit_sha then " sha:\(.commit_sha)" else "" end)"' "$STATE_FILE" 2>/dev/null || true

echo ""
echo "In progress:"
if [[ "$CURRENT_NAME" != "none" && "$CURRENT_NAME" != "" ]]; then
  echo "  -> $CURRENT_NAME"
  [[ -n "$CURRENT_PROGRESS" ]] && echo "    $CURRENT_PROGRESS"
else
  echo "  (none)"
fi

echo ""
echo "Remaining ($REMAINING phases):"
jq -r '.remaining_phases[] | "  . \(.name)\(if (.dependencies | length) > 0 then " [needs: \(.dependencies | join(", "))]" else "" end)"' "$STATE_FILE" 2>/dev/null || true
