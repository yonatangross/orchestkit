// Generated by OrchestKit Claude Plugin
// Created: 2026-02-18

/**
 * Memory Capture - Stop Hook
 * Issue #708: Auto-capture session decisions to ~/.claude/memory/decisions.jsonl
 *
 * Only fires when session had meaningful work (>20 tool calls).
 * Also nudges /ork:remember for sessions with >50 tool calls (Issue #705).
 */

import { existsSync, statSync, mkdirSync, appendFileSync, renameSync } from 'node:fs';
import { join } from 'node:path';
import { homedir } from 'node:os';
import type { HookInput, HookResult } from '../types.js';
import { outputSilentSuccess, logHook, getProjectDir } from '../lib/common.js';
import { getTotalTools } from '../lib/metrics.js';

/**
 * Auto-capture session summary to ~/.claude/memory/decisions.jsonl
 * Only fires when session had meaningful work (>20 tools)
 */
export function memoryCapture(input: HookInput): HookResult {
  logHook('memory-capture', 'Stop hook - checking session for auto-capture');

  const totalTools = getTotalTools();

  if (totalTools < 20) {
    logHook('memory-capture', `Session had ${totalTools} tool calls (<20), skipping capture`);
    return outputSilentSuccess();
  }

  const projectDir = input.project_dir || getProjectDir();
  const memoryDir = join(homedir(), '.claude', 'memory');

  try {
    if (!existsSync(memoryDir)) {
      mkdirSync(memoryDir, { recursive: true });
    }

    const record = {
      ts: new Date().toISOString(),
      pid: input.session_id?.slice(0, 12) ?? 'unknown',
      total_tools: totalTools,
      cwd: projectDir,
      auto_captured: true,
      summary: `Session with ${totalTools} tool calls`,
    };

    const decisionsFile = join(memoryDir, 'decisions.jsonl');
    // Rotate if over 500KB â€” matches pattern in common.ts:rotateLogFile
    if (existsSync(decisionsFile) && statSync(decisionsFile).size > 500 * 1024) {
      renameSync(decisionsFile, `${decisionsFile}.old.${Date.now()}`);
    }
    appendFileSync(decisionsFile, JSON.stringify(record) + '\n');
    logHook('memory-capture', `Captured session summary (${totalTools} tools) to decisions.jsonl`);
  } catch (error) {
    logHook('memory-capture', `Error capturing memory: ${error}`, 'warn');
  }

  // Issue #705: Nudge /ork:remember for high-activity sessions
  if (totalTools > 50) {
    return {
      continue: true,
      suppressOutput: true,
      hookSpecificOutput: {
        additionalContext:
          'Use /ork:remember to save patterns from this session to your knowledge graph',
      },
    };
  }

  return outputSilentSuccess();
}
