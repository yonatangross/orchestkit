// Generated by OrchestKit Claude Plugin
// Created: 2026-02-17

/**
 * Agentation Context - UserPromptSubmit Hook (once: true)
 *
 * Injects a brief reminder to check for pending UI annotations when the
 * Agentation MCP server is configured in .mcp.json.
 *
 * Issue #638: Add prompt hook for annotation context injection.
 *
 * Hooks cannot call MCP tools directly, so this simply injects a context
 * block that prompts Claude to call agentation_get_all_pending itself.
 *
 * CC 2.1.9 Compliant: Uses hookSpecificOutput.additionalContext
 */

import type { HookInput, HookResult } from '../types.js';
import {
  outputSilentSuccess,
  outputPromptContext,
  logHook,
  getProjectDir,
} from '../lib/common.js';
import { existsSync, readFileSync } from 'node:fs';
import { join } from 'node:path';

// =============================================================================
// CONSTANTS
// =============================================================================

const HOOK_NAME = 'agentation-context';

const AGENTATION_CONTEXT = `[Agentation] Check agentation_get_all_pending for pending UI annotations before starting work.`;

// =============================================================================
// HELPERS
// =============================================================================

/**
 * Check if agentation is configured and enabled in .mcp.json
 * Checks both project-level and home-directory .mcp.json files.
 */
function isAgentationConfigured(projectDir: string): boolean {
  const candidates = [
    join(projectDir, '.mcp.json'),
    join(projectDir, '.claude', 'mcp.json'),
  ];

  for (const mcpPath of candidates) {
    if (!existsSync(mcpPath)) continue;

    try {
      const raw = readFileSync(mcpPath, 'utf8');
      const config = JSON.parse(raw);
      const servers = config.mcpServers || {};
      const agentation = servers.agentation;

      if (agentation && agentation.disabled !== true) {
        return true;
      }
    } catch {
      // Malformed JSON or read error — skip this file
    }
  }

  return false;
}

// =============================================================================
// MAIN HOOK
// =============================================================================

/**
 * Agentation context hook — injects a reminder to check pending annotations.
 *
 * Runs once per session. If the agentation MCP server is not configured,
 * returns silent success with no context injection.
 */
export function agentationContext(input: HookInput): HookResult {
  try {
    const projectDir = input.project_dir || getProjectDir();

    if (!isAgentationConfigured(projectDir)) {
      logHook(HOOK_NAME, 'Agentation MCP not configured, skipping');
      return outputSilentSuccess();
    }

    logHook(HOOK_NAME, 'Agentation MCP detected — injecting annotation reminder');
    return outputPromptContext(AGENTATION_CONTEXT);
  } catch (err) {
    logHook(HOOK_NAME, `Error checking agentation config: ${err}`, 'warn');
    return outputSilentSuccess();
  }
}
