// Generated by OrchestKit Claude Plugin
// Created: 2026-02-27

/**
 * Restrict Bash — Allowlist-based Bash command filter for read-only agents
 *
 * OWASP ASI03: Enforces least privilege by restricting Bash to read-only commands.
 * Used by agents with disallowedTools: [Write, Edit, MultiEdit] that still need
 * Bash for git, npm test, gh CLI, and basic inspection commands.
 *
 * CC 2.1.7 compliant output format
 */

import type { HookInput, HookResult } from '../types.js';
import { outputSilentSuccess, outputDeny, logHook, logPermissionFeedback } from '../lib/common.js';
import { normalizeSingle } from '../lib/normalize-command.js';

// ---------------------------------------------------------------------------
// Allowed command prefixes (read-only operations only)
// ---------------------------------------------------------------------------

const ALLOWED_PREFIXES: string[] = [
  // Git (read-only)
  'git status', 'git log', 'git diff', 'git branch', 'git show',
  'git fetch', 'git remote', 'git tag', 'git rev-parse', 'git describe',
  'git ls-files', 'git blame',
  // NPM (test/lint only)
  'npm run test', 'npm run lint', 'npm test', 'npm run typecheck',
  // GitHub CLI (read-only)
  'gh issue list', 'gh issue view', 'gh issue comment',
  'gh pr list', 'gh pr view', 'gh pr checks', 'gh pr diff',
  'gh api',
  // File inspection
  'ls', 'cat', 'head', 'tail', 'wc',
  // Search
  'grep', 'rg', 'find', 'fd',
  // Data processing
  'jq', 'yq',
  // Docker (read-only)
  'docker ps', 'docker images', 'docker logs', 'docker inspect',
  // Misc read-only
  'pwd', 'date', 'echo', 'which', 'env', 'printenv',
  'node -e', 'node --eval', 'python -c', 'python3 -c',
];

// ---------------------------------------------------------------------------
// Compound operator check
// ---------------------------------------------------------------------------

const COMPOUND_OPERATORS = ['&&', '||', '|', ';'];

function hasCompoundOperators(cmd: string): boolean {
  return COMPOUND_OPERATORS.some(op => cmd.includes(op));
}

// ---------------------------------------------------------------------------
// Hook
// ---------------------------------------------------------------------------

/**
 * Restrict Bash commands for read-only agents.
 * Allowlist-based: deny by default, only permit known safe commands.
 */
export function restrictBash(input: HookInput): HookResult {
  const command = input.tool_input.command || '';
  const agentId = process.env.CLAUDE_AGENT_ID || 'unknown';

  if (!command.trim()) {
    return outputSilentSuccess();
  }

  // Block ALL compound commands for read-only agents
  if (hasCompoundOperators(command)) {
    logPermissionFeedback('deny', `Compound command blocked for read-only agent ${agentId}`, input);
    logHook('restrict-bash', `BLOCKED compound: ${command.substring(0, 80)}`);

    return outputDeny(
      `BLOCKED: Compound commands (&&, ||, |, ;) are not permitted for read-only agents.

Agent '${agentId}' has restricted Bash access. Run commands individually.`
    );
  }

  // Normalize for matching
  const normalized = normalizeSingle(command).trim();
  const normalizedLower = normalized.toLowerCase();

  // Check against allowlist
  const allowed = ALLOWED_PREFIXES.some(prefix =>
    normalizedLower.startsWith(prefix)
  );

  if (!allowed) {
    logPermissionFeedback('deny', `Command not in allowlist for ${agentId}: ${command.substring(0, 60)}`, input);
    logHook('restrict-bash', `BLOCKED: ${command.substring(0, 80)}`);

    return outputDeny(
      `BLOCKED: Command not permitted for read-only agent '${agentId}'.

Only read-only commands are allowed: git (status/log/diff/show), npm test/lint,
gh issue/pr list/view, ls, cat, head, tail, grep, rg, find, jq, docker inspect.

This agent investigates and reports — it does not modify the system.`
    );
  }

  logPermissionFeedback('allow', `Allowed command for ${agentId}: ${normalized.substring(0, 60)}`, input);
  return outputSilentSuccess();
}
