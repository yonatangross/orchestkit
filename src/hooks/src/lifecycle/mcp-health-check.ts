// Generated by OrchestKit Claude Plugin
// Created: 2026-02-18

/**
 * MCP Health Check - Warn about misconfigured MCP servers at session start
 * Hook: SessionStart
 * CC 2.1.7 Compliant
 *
 * Checks .mcp.json for enabled MCPs and validates their requirements:
 * - tavily: TAVILY_API_KEY must be set
 * - agentation: agentation-mcp must be installed
 */

import { existsSync, readFileSync } from 'node:fs';
import { join } from 'node:path';
import type { HookInput, HookResult } from '../types.js';
import { logHook, getProjectDir, outputSilentSuccess, outputWithContext } from '../lib/common.js';

interface McpServerEntry {
  disabled?: boolean;
  command?: string;
  args?: string[];
  [key: string]: unknown;
}

interface McpConfig {
  mcpServers?: Record<string, McpServerEntry>;
}

/**
 * Check a single enabled MCP server for missing requirements.
 * Returns a warning string or null if the server is properly configured.
 */
function checkServer(name: string, projectDir: string): string | null {
  if (name === 'tavily' && !process.env.TAVILY_API_KEY) {
    return `- tavily is enabled but TAVILY_API_KEY is not set\n  Fix: export TAVILY_API_KEY="tvly-..." in ~/.zshrc, then set "disabled": false in .mcp.json`;
  }

  if (name === 'agentation') {
    const binExists = existsSync(join(projectDir, 'node_modules', '.bin', 'agentation-mcp'));
    if (binExists) return null;
    try {
      const pkg = JSON.parse(readFileSync(join(projectDir, 'package.json'), 'utf-8'));
      if ('agentation-mcp' in { ...pkg.dependencies, ...pkg.devDependencies }) return null;
    } catch { /* no package.json */ }
    return `- agentation is enabled but agentation-mcp is not installed\n  Fix: npm install -D agentation-mcp  or  set "disabled": true in .mcp.json`;
  }

  return null;
}

/**
 * MCP health check hook
 */
export function mcpHealthCheck(input: HookInput): HookResult {
  if (process.env.ORCHESTKIT_SKIP_SLOW_HOOKS === '1') {
    logHook('mcp-health-check', 'Skipping MCP check (ORCHESTKIT_SKIP_SLOW_HOOKS=1)');
    return outputSilentSuccess();
  }

  const projectDir = input.project_dir || getProjectDir();
  const mcpJsonPath = join(projectDir, '.mcp.json');

  if (!existsSync(mcpJsonPath)) {
    logHook('mcp-health-check', 'No .mcp.json found, skipping');
    return outputSilentSuccess();
  }

  let config: McpConfig;
  try {
    config = JSON.parse(readFileSync(mcpJsonPath, 'utf-8'));
  } catch {
    logHook('mcp-health-check', 'Failed to parse .mcp.json', 'warn');
    return outputSilentSuccess();
  }

  const servers = config.mcpServers;
  if (!servers || typeof servers !== 'object') return outputSilentSuccess();

  const warnings: string[] = [];
  for (const [name, entry] of Object.entries(servers)) {
    if (entry.disabled === true) continue;
    const warning = checkServer(name, projectDir);
    if (warning) warnings.push(warning);
  }

  if (warnings.length > 0) {
    const message = `MCP misconfiguration detected:\n${warnings.join('\n')}`;
    logHook('mcp-health-check', message, 'warn');
    return outputWithContext(message);
  }

  logHook('mcp-health-check', 'All enabled MCPs are properly configured');
  return outputSilentSuccess();
}
