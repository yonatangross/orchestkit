// Generated by OrchestKit Claude Plugin
// Created: 2026-02-28

/**
 * Sync Session Dispatcher — SessionStart Hook
 * Consolidates 4 synchronous SessionStart hooks into a single dispatcher.
 *
 * Consolidated hooks:
 * - session-context-loader (silent — loads context files, sets env vars)
 * - analytics-consent-check (may return systemMessage)
 * - prefill-guard (may return systemMessage via outputWarning)
 * - mcp-health-check (may return additionalContext via outputWithContext)
 *
 * NOT consolidated (remain separate in hooks.json):
 * - unified-dispatcher (async — fire-and-forget session init)
 * - pr-status-enricher (async — background PR status check)
 *
 * CC 2.1.9 Compliant: Single sync hook with merged systemMessage output
 */

import type { HookInput, HookResult } from '../types.js';
import { outputSilentSuccess, logHook, extractContext } from '../lib/common.js';

// Import consolidated hook implementations
import { sessionContextLoader } from './session-context-loader.js';
import { analyticsConsentCheck } from './analytics-consent-check.js';
import { prefillGuard } from './prefill-guard.js';
import { mcpHealthCheck } from './mcp-health-check.js';

const HOOK_NAME = 'sync-session-dispatcher';

interface SyncHookConfig {
  name: string;
  fn: (input: HookInput) => HookResult;
}

/**
 * Registry of sync SessionStart hooks, executed sequentially.
 * Order matters — context loader runs first to set up env vars.
 */
const SYNC_HOOKS: SyncHookConfig[] = [
  { name: 'session-context-loader', fn: sessionContextLoader },
  { name: 'analytics-consent-check', fn: analyticsConsentCheck },
  { name: 'prefill-guard', fn: prefillGuard },
  { name: 'mcp-health-check', fn: mcpHealthCheck },
];

/**
 * Consolidated sync SessionStart dispatcher.
 * Runs all sync hooks sequentially and merges their systemMessage outputs.
 */
export function syncSessionDispatcher(input: HookInput): HookResult {
  const messages: string[] = [];

  for (const hook of SYNC_HOOKS) {
    try {
      const result = hook.fn(input);

      // Collect systemMessage (primary output channel for SessionStart)
      if (result.systemMessage) {
        messages.push(result.systemMessage);
        logHook(HOOK_NAME, `${hook.name}: systemMessage collected`);
      }

      // Fallback: extract additionalContext (mcp-health-check uses outputWithContext)
      const context = extractContext(result);
      if (context && !result.systemMessage) {
        messages.push(context);
        logHook(HOOK_NAME, `${hook.name}: additionalContext converted to systemMessage`);
      }
    } catch (error) {
      const msg = error instanceof Error ? error.message : String(error);
      logHook(HOOK_NAME, `${hook.name} failed: ${msg}`, 'warn');
    }
  }

  if (messages.length === 0) {
    logHook(HOOK_NAME, 'All sync hooks silent');
    return outputSilentSuccess();
  }

  const merged = messages.join('\n');
  logHook(HOOK_NAME, `Merged ${messages.length} messages from sync hooks`);

  return {
    continue: true,
    systemMessage: merged,
  };
}
