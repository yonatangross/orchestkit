// Generated by OrchestKit Claude Plugin
// Created: 2026-02-06

/**
 * Team Synthesis Trigger - TeammateIdle Hook
 *
 * Detects when all teammates in a team are idle and suggests synthesis.
 * Reads team config for member list and teammate-activity.jsonl for recent idle events.
 *
 * @hook TeammateIdle
 * @since CC 2.1.33
 */

import { existsSync, readFileSync } from 'node:fs';
import { join } from 'node:path';
import type { HookInput, HookResult } from '../types.js';
import { outputSilentSuccess, outputWithContext, logHook, getProjectDir } from '../lib/common.js';
import { getTeamMembers, getTeamName } from '../lib/agent-teams.js';

/** Window within which idle events are considered "recent" */
const IDLE_WINDOW_MS = 60_000;

export function teamSynthesisTrigger(input: HookInput): HookResult {
  const teamName = getTeamName();
  if (!teamName) {
    return outputSilentSuccess();
  }

  const members = getTeamMembers();
  if (members.length === 0) {
    return outputSilentSuccess();
  }

  const projectDir = getProjectDir();
  if (!projectDir) {
    return outputSilentSuccess();
  }

  // Read recent idle events from activity log
  const logPath = join(projectDir, '.claude', 'logs', 'teammate-activity.jsonl');
  if (!existsSync(logPath)) {
    return outputSilentSuccess();
  }

  const cutoff = new Date(Date.now() - IDLE_WINDOW_MS).toISOString();
  const idleMembers = new Set<string>();

  try {
    const content = readFileSync(logPath, 'utf-8');
    const lines = content.trim().split('\n').filter(Boolean);

    // Scan recent entries (last 50 to bound cost)
    const recent = lines.slice(-50);
    for (const line of recent) {
      try {
        const entry = JSON.parse(line);
        if (
          entry.event === 'teammate_idle' &&
          entry.timestamp &&
          entry.timestamp >= cutoff
        ) {
          const id = entry.teammate_id || entry.member_name || '';
          if (id) idleMembers.add(id);
        }
      } catch {
        // Skip invalid JSONL lines
      }
    }
  } catch {
    return outputSilentSuccess();
  }

  // Add current idle event's teammate
  const currentTeammateId = input.teammate_id || input.agent_id || '';
  if (currentTeammateId) {
    idleMembers.add(currentTeammateId);
  }

  logHook(
    'team-synthesis-trigger',
    `Team "${teamName}": ${idleMembers.size}/${members.length} idle within ${IDLE_WINDOW_MS / 1000}s`,
  );

  // All members idle? Suggest synthesis
  if (idleMembers.size >= members.length) {
    return outputWithContext(
      `All ${members.length} teammates in team "${teamName}" are idle. ` +
      `Consider synthesizing results and shutting down the team.`,
    );
  }

  return outputSilentSuccess();
}
