// Generated by OrchestKit Claude Plugin
// Created: 2026-02-06

/**
 * TeammateIdle Hook: Progress Reporter
 *
 * CC 2.1.33 TeammateIdle event fires when an agent teammate becomes idle.
 * Logs idle events for workflow analytics and suggests work redistribution.
 *
 * @hook TeammateIdle
 * @since CC 2.1.33
 */

import { HookInput, HookResult } from '../types.js';
import { getProjectDir } from '../lib/common.js';
import { writeFileSync, mkdirSync, existsSync } from 'fs';
import { join } from 'path';

export async function progressReporter(input: HookInput): Promise<HookResult> {
  const projectDir = getProjectDir();
  if (!projectDir) {
    return { continue: true };
  }

  const teammateId = input.teammate_id || input.agent_id || 'unknown';
  const teammateType = input.teammate_type || input.subagent_type || 'unknown';
  const idleDuration = input.idle_duration_ms || 0;

  // Log idle event for workflow analytics
  const logsDir = join(projectDir, '.claude', 'logs');
  if (!existsSync(logsDir)) {
    mkdirSync(logsDir, { recursive: true });
  }

  const entry = {
    timestamp: new Date().toISOString(),
    event: 'teammate_idle',
    teammate_id: teammateId,
    teammate_type: teammateType,
    idle_duration_ms: idleDuration,
    session_id: input.session_id,
  };

  try {
    const logPath = join(logsDir, 'teammate-activity.jsonl');
    writeFileSync(logPath, JSON.stringify(entry) + '\n', { flag: 'a' });
  } catch {
    // Non-critical logging â€” don't block
  }

  // For long idle durations, surface as context
  if (idleDuration > 30000) {
    return {
      continue: true,
      hookSpecificOutput: {
        additionalContext: `Agent ${teammateType} (${teammateId}) has been idle for ${Math.round(idleDuration / 1000)}s. Consider reassigning pending work.`,
      },
    };
  }

  return { continue: true };
}
