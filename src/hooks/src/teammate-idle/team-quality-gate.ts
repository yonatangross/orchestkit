// Generated by OrchestKit Claude Plugin
// Created: 2026-02-06

/**
 * Team Quality Gate - TeammateIdle Hook
 *
 * Aggregates quality signals from idle teammates.
 * Surfaces a warning only if a teammate goes idle without producing meaningful output
 * AND has no recent task completion signal.
 *
 * @hook TeammateIdle
 * @since CC 2.1.33
 */

import { existsSync, readFileSync } from 'node:fs';
import { join } from 'node:path';
import type { HookInput, HookResult } from '../types.js';
import { outputSilentSuccess, outputWithContext, logHook, getProjectDir } from '../lib/common.js';
import { getTeamName } from '../lib/agent-teams.js';
import { appendEventLog } from '../lib/event-logger.js';

/** Window within which completions count as "recent" */
const COMPLETION_WINDOW_MS = 300_000;

/** Minimum output length to consider as productive work */
const MEANINGFUL_OUTPUT_MIN_CHARS = 100;

/**
 * Check if the teammate produced meaningful output (primary signal).
 * Uses last_assistant_message or agent_output from the hook input.
 */
function hasProductiveOutput(input: HookInput): boolean {
  const output = input.last_assistant_message || input.agent_output || input.output || '';
  return output.length >= MEANINGFUL_OUTPUT_MIN_CHARS;
}

/**
 * Check task-completions.jsonl for recent completion events (secondary signal).
 * Gracefully returns false if the file doesn't exist or can't be read.
 */
function hasRecentCompletion(projectDir: string): boolean {
  const completionsPath = join(projectDir, '.claude', 'logs', 'task-completions.jsonl');

  if (!existsSync(completionsPath)) {
    return false;
  }

  const cutoff = new Date(Date.now() - COMPLETION_WINDOW_MS).toISOString();

  try {
    const content = readFileSync(completionsPath, 'utf-8');
    const lines = content.trim().split('\n').filter(Boolean);
    const recent = lines.slice(-30);

    for (const line of recent) {
      try {
        const entry = JSON.parse(line);
        if (entry.timestamp && entry.timestamp >= cutoff) {
          return true;
        }
      } catch {
        // Skip invalid lines
      }
    }
  } catch {
    // Non-critical â€” proceed without completion data
  }

  return false;
}

/** Team quality gate for idle teammate detection. */
export function teamQualityGate(input: HookInput): HookResult {
  const teamName = getTeamName();
  if (!teamName) {
    return outputSilentSuccess();
  }

  const projectDir = getProjectDir();
  if (!projectDir) {
    return outputSilentSuccess();
  }

  const teammateId = input.teammate_id || input.agent_id || 'unknown';
  const teammateType = input.teammate_type || input.subagent_type || 'unknown';

  // Primary signal: did the teammate produce meaningful output?
  const productive = hasProductiveOutput(input);

  // Secondary signal: any recent completion events in the log?
  const recentCompletion = hasRecentCompletion(projectDir);

  // Log quality status
  appendEventLog('team-quality.jsonl', {
    timestamp: new Date().toISOString(),
    event: 'teammate_quality_check',
    team_name: teamName,
    teammate_id: teammateId,
    teammate_type: teammateType,
    has_productive_output: productive,
    has_recent_completion: recentCompletion,
    session_id: input.session_id,
  });

  // Only warn if BOTH signals are negative: no meaningful output AND no recent completion
  if (!productive && !recentCompletion) {
    logHook(
      'team-quality-gate',
      `Teammate "${teammateId}" (${teammateType}) idle without productive output or recent completion`,
    );
    return outputWithContext(
      `Teammate "${teammateType}" (${teammateId}) went idle without completing a task. ` +
        `Check if their work is stuck or needs reassignment.`,
    );
  }

  logHook('team-quality-gate', `Teammate "${teammateId}" quality check passed`);
  return outputSilentSuccess();
}
