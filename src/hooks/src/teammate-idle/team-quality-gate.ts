// Generated by OrchestKit Claude Plugin
// Created: 2026-02-06

/**
 * Team Quality Gate - TeammateIdle Hook
 *
 * Aggregates quality signals from idle teammates.
 * Surfaces a warning if a teammate goes idle without completing their task.
 *
 * @hook TeammateIdle
 * @since CC 2.1.33
 */

import { existsSync, readFileSync } from 'node:fs';
import { join } from 'node:path';
import type { HookInput, HookResult } from '../types.js';
import { outputSilentSuccess, outputWithContext, logHook, getProjectDir } from '../lib/common.js';
import { getTeamName } from '../lib/agent-teams.js';
import { appendEventLog } from '../lib/event-logger.js';

/** Window within which completions count as "recent" */
const COMPLETION_WINDOW_MS = 120_000;

export function teamQualityGate(input: HookInput): HookResult {
  const teamName = getTeamName();
  if (!teamName) {
    return outputSilentSuccess();
  }

  const projectDir = getProjectDir();
  if (!projectDir) {
    return outputSilentSuccess();
  }

  const teammateId = input.teammate_id || input.agent_id || 'unknown';
  const teammateType = input.teammate_type || input.subagent_type || 'unknown';

  // Check if this teammate recently completed a task
  const completionsPath = join(projectDir, '.claude', 'logs', 'task-completions.jsonl');
  let hasRecentCompletion = false;

  if (existsSync(completionsPath)) {
    const cutoff = new Date(Date.now() - COMPLETION_WINDOW_MS).toISOString();

    try {
      const content = readFileSync(completionsPath, 'utf-8');
      const lines = content.trim().split('\n').filter(Boolean);
      const recent = lines.slice(-30);

      for (const line of recent) {
        try {
          const entry = JSON.parse(line);
          if (
            entry.event === 'task_completed' &&
            entry.timestamp &&
            entry.timestamp >= cutoff
          ) {
            hasRecentCompletion = true;
            break;
          }
        } catch {
          // Skip invalid lines
        }
      }
    } catch {
      // Non-critical â€” proceed without completion data
    }
  }

  // Log quality status
  appendEventLog('team-quality.jsonl', {
    timestamp: new Date().toISOString(),
    event: 'teammate_quality_check',
    team_name: teamName,
    teammate_id: teammateId,
    teammate_type: teammateType,
    has_recent_completion: hasRecentCompletion,
    session_id: input.session_id,
  });

  if (!hasRecentCompletion) {
    logHook(
      'team-quality-gate',
      `Teammate "${teammateId}" (${teammateType}) idle without recent task completion`,
    );
    return outputWithContext(
      `Teammate "${teammateType}" (${teammateId}) went idle without completing a task. ` +
      `Check if their work is stuck or needs reassignment.`,
    );
  }

  logHook('team-quality-gate', `Teammate "${teammateId}" quality check passed`);
  return outputSilentSuccess();
}
