// Generated by OrchestKit Claude Plugin
// Created: 2026-02-27

/**
 * Unified TeammateIdle Dispatcher
 * Issue #853: Consolidate 3 TeammateIdle hooks into single dispatcher
 *
 * Reduces hooks.json entries from 3 to 1 for TeammateIdle event.
 * Internally routes to: progress-reporter, team-synthesis-trigger, team-quality-gate.
 *
 * CC 2.1.33 Compliant: Single hook with internal parallel routing
 */

import type { HookInput, HookResult } from '../types.js';
import { outputSilentSuccess, outputWithContext, logHook } from '../lib/common.js';

// Import individual TeammateIdle hook implementations
import { progressReporter } from './progress-reporter.js';
import { teamSynthesisTrigger } from './team-synthesis-trigger.js';
import { teamQualityGate } from './team-quality-gate.js';

// -----------------------------------------------------------------------------
// Types
// -----------------------------------------------------------------------------

type HookFn = (input: HookInput) => HookResult | Promise<HookResult>;

interface HookConfig {
  name: string;
  fn: HookFn;
  critical: boolean;
}

// -----------------------------------------------------------------------------
// Hook registry â€” order matters: analytics first, then synthesis, then quality
// -----------------------------------------------------------------------------

const HOOKS: HookConfig[] = [
  { name: 'progress-reporter', fn: progressReporter, critical: false },
  { name: 'team-synthesis-trigger', fn: teamSynthesisTrigger, critical: false },
  { name: 'team-quality-gate', fn: teamQualityGate, critical: false },
];

// -----------------------------------------------------------------------------
// Dispatcher
// -----------------------------------------------------------------------------

export async function unifiedTeammateIdleDispatcher(input: HookInput): Promise<HookResult> {
  const contextParts: string[] = [];

  for (const hook of HOOKS) {
    try {
      const result = await hook.fn(input);

      // Collect any additionalContext from sub-hooks
      const ctx = result?.hookSpecificOutput?.additionalContext;
      if (ctx && typeof ctx === 'string' && ctx.trim()) {
        contextParts.push(ctx.trim());
      }
    } catch (err) {
      logHook(
        'teammate-idle-dispatcher',
        `Hook "${hook.name}" failed: ${err instanceof Error ? err.message : String(err)}`,
      );
      // Non-critical hooks: log and continue
    }
  }

  if (contextParts.length > 0) {
    return outputWithContext(contextParts.join('\n'));
  }

  return outputSilentSuccess();
}
