// Generated by OrchestKit Claude Plugin
// Created: 2026-02-15

/**
 * Unit tests for commit-atomicity-checker hook
 * Tests heuristic atomicity checking for git commit commands
 */

import { describe, it, expect, vi, beforeEach } from 'vitest';

// Mock dependencies before imports
vi.mock('../../lib/common.js', () => ({
  logHook: vi.fn(),
  outputSilentSuccess: vi.fn(() => ({ continue: true, suppressOutput: true })),
  outputAllowWithContext: vi.fn((ctx: string) => ({
    continue: true,
    hookSpecificOutput: {
      hookEventName: 'PreToolUse',
      additionalContext: ctx,
      permissionDecision: 'allow',
    },
  })),
  getProjectDir: vi.fn(() => '/test/project'),
}));

vi.mock('node:child_process', () => ({
  execSync: vi.fn(() => ''),
}));

import { commitAtomicityChecker } from '../../pretool/bash/commit-atomicity-checker.js';
import type { HookInput } from '../../types.js';
import { execSync } from 'node:child_process';

function createBashInput(command: string): HookInput {
  return {
    tool_name: 'Bash',
    session_id: 'test-session-123',
    project_dir: '/test/project',
    tool_input: { command },
  };
}

describe('commit-atomicity-checker', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  // -----------------------------------------------------------------------
  // 1. Non-git-commit commands
  // -----------------------------------------------------------------------

  describe('non-git-commit commands', () => {
    it('returns silent success for npm run build', () => {
      // Arrange
      const input = createBashInput('npm run build');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('returns silent success for git status', () => {
      // Arrange
      const input = createBashInput('git status');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('returns silent success for empty command', () => {
      // Arrange
      const input = createBashInput('');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });
  });

  // -----------------------------------------------------------------------
  // 2. File count warnings
  // -----------------------------------------------------------------------

  describe('file count warnings', () => {
    it('returns silent success when <=10 staged files', () => {
      // Arrange
      const stagedFiles = Array.from({ length: 10 }, (_, i) => `src/file${i}.ts`).join('\n');
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit -m "Update files"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('warns when >10 staged files', () => {
      // Arrange
      const stagedFiles = Array.from({ length: 15 }, (_, i) => `src/file${i}.ts`).join('\n');
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit -m "Update many files"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.hookSpecificOutput?.additionalContext).toContain('15 staged files');
      expect(result.hookSpecificOutput?.additionalContext).toContain('>10');
      expect(result.hookSpecificOutput?.additionalContext).toContain('verify all changes are related');
    });

    it('warns when exactly 11 staged files', () => {
      // Arrange
      const stagedFiles = Array.from({ length: 11 }, (_, i) => `src/file${i}.ts`).join('\n');
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit -m "Test"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.hookSpecificOutput?.additionalContext).toContain('11 staged files');
    });
  });

  // -----------------------------------------------------------------------
  // 3. Directory spread warnings
  // -----------------------------------------------------------------------

  describe('directory spread warnings', () => {
    it('returns silent success when files in <=3 top-level directories', () => {
      // Arrange
      const stagedFiles = 'src/auth.ts\nsrc/user.ts\ndocs/api.md';
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit -m "Update auth"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('warns when files span >3 top-level directories', () => {
      // Arrange
      const stagedFiles = 'src/auth.ts\ndocs/api.md\ntests/auth.test.ts\nscripts/build.sh';
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit -m "Update multiple areas"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.hookSpecificOutput?.additionalContext).toContain('4 top-level dirs');
      expect(result.hookSpecificOutput?.additionalContext).toContain('src, docs, tests, scripts');
      expect(result.hookSpecificOutput?.additionalContext).toContain('may mix concerns');
    });

    it('handles files in root directory', () => {
      // Arrange
      const stagedFiles = 'README.md\npackage.json\nsrc/index.ts\ndocs/guide.md\nconfig/app.yml';
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit -m "Update config"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.hookSpecificOutput?.additionalContext).toContain('4 top-level dirs');
      expect(result.hookSpecificOutput?.additionalContext).toContain('(root), src, docs, config');
    });
  });

  // -----------------------------------------------------------------------
  // 4. Type mixing warnings
  // -----------------------------------------------------------------------

  describe('type mixing warnings', () => {
    it('returns silent success when files are in same category', () => {
      // Arrange
      const stagedFiles = 'src/auth.ts\nsrc/user.ts\nlib/util.ts';
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit -m "Update auth"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('warns when files span src/ + docs/ + config/ categories', () => {
      // Arrange
      const stagedFiles = 'src/auth.ts\ndocs/api.md\nconfig/database.yml';
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit -m "Update auth"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.hookSpecificOutput?.additionalContext).toContain('Mixed change types');
      expect(result.hookSpecificOutput?.additionalContext).toContain('source, docs, config');
      expect(result.hookSpecificOutput?.additionalContext).toContain('consider splitting');
    });

    it('categorizes test files correctly', () => {
      // Arrange
      const stagedFiles = 'tests/auth.test.ts\n__tests__/user.test.ts\nspec/integration.spec.ts';
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit -m "Add tests"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true); // Only 1 category: tests
    });

    it('warns when mixing 3+ categories', () => {
      // Arrange
      const stagedFiles = 'src/auth.ts\ntests/auth.test.ts\ndocs/api.md\nscripts/build.sh';
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit -m "Big update"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.hookSpecificOutput?.additionalContext).toContain('Mixed change types');
    });
  });

  // -----------------------------------------------------------------------
  // 5. Commit message "and" test
  // -----------------------------------------------------------------------

  describe('commit message "and" test', () => {
    it('returns silent success when message has no "and"', () => {
      // Arrange
      const stagedFiles = 'src/auth.ts';
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit -m "Fix authentication bug"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('warns when message contains " and " (lowercase)', () => {
      // Arrange
      const stagedFiles = 'src/auth.ts';
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit -m "Fix auth and update docs"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.hookSpecificOutput?.additionalContext).toContain('Commit message contains "and"');
      expect(result.hookSpecificOutput?.additionalContext).toContain('may describe multiple concerns');
    });

    it('warns when message contains " And " (uppercase)', () => {
      // Arrange
      const stagedFiles = 'src/auth.ts';
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit -m "Fix auth And update docs"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.hookSpecificOutput?.additionalContext).toContain('Commit message contains "and"');
    });

    it('warns when message contains " AND " (all caps)', () => {
      // Arrange
      const stagedFiles = 'src/auth.ts';
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit -m "Fix auth AND update docs"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.hookSpecificOutput?.additionalContext).toContain('Commit message contains "and"');
    });

    it('returns silent success for "android", "command", etc. (no space-delimited "and")', () => {
      // Arrange
      const stagedFiles = 'src/android.ts';
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit -m "Add android support"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });
  });

  // -----------------------------------------------------------------------
  // 6. Commit message extraction
  // -----------------------------------------------------------------------

  describe('commit message extraction', () => {
    it('handles -m with double quotes', () => {
      // Arrange
      const stagedFiles = 'src/auth.ts';
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit -m "Fix auth and update"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('Commit message contains "and"');
    });

    it('handles -m with single quotes', () => {
      // Arrange
      const stagedFiles = 'src/auth.ts';
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput("git commit -m 'Fix auth and update'");

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('Commit message contains "and"');
    });

    it('handles --message with equals and double quotes', () => {
      // Arrange
      const stagedFiles = 'src/auth.ts';
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit --message="Fix auth and update"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('Commit message contains "and"');
    });

    it('handles --message with space and single quotes', () => {
      // Arrange
      const stagedFiles = 'src/auth.ts';
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput("git commit --message 'Fix auth and update'");

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('Commit message contains "and"');
    });

    it('handles -m with unquoted single word', () => {
      // Arrange
      const stagedFiles = 'src/auth.ts';
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit -m fixbug');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert - should extract "fixbug" and not find "and"
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('returns silent success when no -m flag (interactive commit)', () => {
      // Arrange
      const stagedFiles = 'src/auth.ts';
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit --amend');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });
  });

  // -----------------------------------------------------------------------
  // 7. Graceful error handling
  // -----------------------------------------------------------------------

  describe('graceful error handling', () => {
    it('returns silent success when execSync fails', () => {
      // Arrange
      vi.mocked(execSync).mockImplementation(() => {
        throw new Error('not a git repository');
      });
      const input = createBashInput('git commit -m "Test"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('returns silent success when no staged files', () => {
      // Arrange
      vi.mocked(execSync).mockReturnValue('');
      const input = createBashInput('git commit -m "Test"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('returns silent success when only whitespace in git output', () => {
      // Arrange
      vi.mocked(execSync).mockReturnValue('   \n\n   ');
      const input = createBashInput('git commit -m "Test"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });
  });

  // -----------------------------------------------------------------------
  // 8. Multiple warnings
  // -----------------------------------------------------------------------

  describe('multiple warnings', () => {
    it('reports all violations when multiple heuristics fail', () => {
      // Arrange - 15 files, 4 dirs, 3 categories, message with "and"
      const stagedFiles = [
        'src/auth.ts',
        'src/user.ts',
        'src/model.ts',
        'src/api.ts',
        'src/service.ts',
        'docs/api.md',
        'docs/guide.md',
        'docs/readme.md',
        'tests/auth.test.ts',
        'tests/user.test.ts',
        'tests/api.test.ts',
        'config/db.yml',
        'config/app.yml',
        'scripts/build.sh',
        'scripts/deploy.sh',
      ].join('\n');
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit -m "Update auth and docs and tests"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert - should have all 4 warnings
      expect(result.continue).toBe(true);
      expect(result.hookSpecificOutput?.additionalContext).toContain('15 staged files');
      expect(result.hookSpecificOutput?.additionalContext).toContain('5 top-level dirs');
      expect(result.hookSpecificOutput?.additionalContext).toContain('Mixed change types');
      expect(result.hookSpecificOutput?.additionalContext).toContain('Commit message contains "and"');
    });

    it('suggests splitting atomic commits', () => {
      // Arrange
      const stagedFiles = Array.from({ length: 12 }, (_, i) => `src/file${i}.ts`).join('\n');
      vi.mocked(execSync).mockReturnValue(stagedFiles);
      const input = createBashInput('git commit -m "Update files"');

      // Act
      const result = commitAtomicityChecker(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('Consider splitting into atomic commits');
      expect(result.hookSpecificOutput?.additionalContext).toContain('if these are unrelated changes');
    });
  });
});
