// Generated by OrchestKit Claude Plugin
// Created: 2026-02-15

/**
 * Unit tests for issue-reference-checker hook
 * Tests reminder to include issue number in commit messages
 */

import { describe, it, expect, vi, beforeEach } from 'vitest';

// Mock dependencies before imports
vi.mock('../../lib/common.js', () => ({
  outputSilentSuccess: vi.fn(() => ({ continue: true, suppressOutput: true })),
  outputAllowWithContext: vi.fn((ctx: string) => ({
    continue: true,
    hookSpecificOutput: {
      hookEventName: 'PreToolUse',
      additionalContext: ctx,
      permissionDecision: 'allow',
    },
  })),
  getCachedBranch: vi.fn(() => 'main'),
}));

import { issueReferenceChecker } from '../../pretool/bash/issue-reference-checker.js';
import type { HookInput } from '../../types.js';
import { getCachedBranch } from '../../lib/common.js';

function createBashInput(command: string): HookInput {
  return {
    tool_name: 'Bash',
    session_id: 'test-session-123',
    project_dir: '/test/project',
    tool_input: { command },
  };
}

describe('issue-reference-checker', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  // -----------------------------------------------------------------------
  // 1. Non-issue branches
  // -----------------------------------------------------------------------

  describe('non-issue branches', () => {
    it('returns silent success when on main branch', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('main');
      const input = createBashInput('git commit -m "Fix bug"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('returns silent success when on dev branch', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('dev');
      const input = createBashInput('git commit -m "Update feature"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('returns silent success when on feature branch without issue number', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('feature/add-authentication');
      const input = createBashInput('git commit -m "Add auth"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('returns silent success when branch is unknown', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('unknown');
      const input = createBashInput('git commit -m "Fix"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });
  });

  // -----------------------------------------------------------------------
  // 2. Issue branch patterns
  // -----------------------------------------------------------------------

  describe('issue branch patterns', () => {
    it('extracts issue number from issue/123-desc pattern', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('issue/123-add-auth');
      const input = createBashInput('git commit -m "Add authentication module"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.hookSpecificOutput?.additionalContext).toContain('issue/123-add-auth');
      expect(result.hookSpecificOutput?.additionalContext).toContain('#123');
    });

    it('extracts issue number from fix/456-desc pattern', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('fix/456-memory-leak');
      const input = createBashInput('git commit -m "Patch memory leak"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('fix/456-memory-leak');
      expect(result.hookSpecificOutput?.additionalContext).toContain('#456');
    });

    it('extracts issue number from feat/789-desc pattern', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('feat/789-dark-mode');
      const input = createBashInput('git commit -m "Implement dark mode"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('feat/789-dark-mode');
      expect(result.hookSpecificOutput?.additionalContext).toContain('#789');
    });

    it('extracts issue number from bare number prefix 123-desc pattern', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('123-some-description');
      const input = createBashInput('git commit -m "Update docs"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('123-some-description');
      expect(result.hookSpecificOutput?.additionalContext).toContain('#123');
    });

    it('extracts issue number from bug/10-desc pattern', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('bug/10-fix-crash');
      const input = createBashInput('git commit -m "Fix crash on startup"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('#10');
    });

    it('extracts issue number from hotfix/11-desc pattern', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('hotfix/11-security-patch');
      const input = createBashInput('git commit -m "Apply security patch"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('#11');
    });

    it('extracts issue number from feature/99-desc pattern', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('feature/99-add-export');
      const input = createBashInput('git commit -m "Add export feature"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('#99');
    });
  });

  // -----------------------------------------------------------------------
  // 3. Message already contains issue reference
  // -----------------------------------------------------------------------

  describe('message contains issue reference', () => {
    it('returns silent success when message contains #123', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('issue/123-add-auth');
      const input = createBashInput('git commit -m "Add authentication module (#123)"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('returns silent success when message contains bare 123', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('issue/123-add-auth');
      const input = createBashInput('git commit -m "Add authentication module 123"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('returns silent success when message starts with #123', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('issue/123-add-auth');
      const input = createBashInput('git commit -m "#123 Add authentication"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('returns silent success for Closes #456 format', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('fix/456-bug');
      const input = createBashInput('git commit -m "Fix bug - Closes #456"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });
  });

  // -----------------------------------------------------------------------
  // 4. Reminder context
  // -----------------------------------------------------------------------

  describe('reminder context', () => {
    it('provides reminder when on issue branch without reference', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('issue/123-add-auth');
      const input = createBashInput('git commit -m "Add authentication module"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.hookSpecificOutput?.additionalContext).toContain("You're on branch");
      expect(result.hookSpecificOutput?.additionalContext).toContain('issue/123-add-auth');
      expect(result.hookSpecificOutput?.additionalContext).toContain('include #123');
      expect(result.hookSpecificOutput?.additionalContext).toContain('to link it to the issue');
    });

    it('reminder includes correct issue number for different branches', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('fix/999-urgent');
      const input = createBashInput('git commit -m "Urgent fix"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('fix/999-urgent');
      expect(result.hookSpecificOutput?.additionalContext).toContain('#999');
    });
  });

  // -----------------------------------------------------------------------
  // 5. No commit message (interactive commit)
  // -----------------------------------------------------------------------

  describe('interactive commits', () => {
    it('returns silent success when commit has no -m flag', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('issue/123-add-auth');
      const input = createBashInput('git commit --amend');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('returns silent success for git commit (no flags)', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('issue/123-add-auth');
      const input = createBashInput('git commit');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('returns silent success for git commit -v (verbose mode)', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('issue/123-add-auth');
      const input = createBashInput('git commit -v');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });
  });

  // -----------------------------------------------------------------------
  // 6. Error handling
  // -----------------------------------------------------------------------

  describe('error handling', () => {
    it('returns silent success when getCachedBranch fails', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockImplementation(() => {
        throw new Error('git error');
      });
      const input = createBashInput('git commit -m "Test"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('returns silent success when branch is null', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue(null as any);
      const input = createBashInput('git commit -m "Test"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('returns silent success for empty command', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('issue/123-test');
      const input = createBashInput('');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });
  });

  // -----------------------------------------------------------------------
  // 7. Commit message quote variations
  // -----------------------------------------------------------------------

  describe('commit message quote variations', () => {
    it('handles double quotes', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('issue/123-test');
      const input = createBashInput('git commit -m "Fix without reference"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('#123');
    });

    it('handles single quotes', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('issue/123-test');
      const input = createBashInput("git commit -m 'Fix without reference'");

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('#123');
    });

    it('handles unquoted single word', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('issue/123-test');
      const input = createBashInput('git commit -m bugfix');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('#123');
    });
  });

  // -----------------------------------------------------------------------
  // 8. Edge cases
  // -----------------------------------------------------------------------

  describe('edge cases', () => {
    it('handles branch with leading # in pattern match', () => {
      // Arrange - extractIssueNumber strips leading # if present
      vi.mocked(getCachedBranch).mockReturnValue('issue/#123-test');
      const input = createBashInput('git commit -m "Test"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert - should extract "123" without the #
      expect(result.continue).toBe(true);
      // Hook should still work, stripping the # from extracted number
    });

    it('returns silent success for non-numeric issue pattern', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('issue/abc-desc');
      const input = createBashInput('git commit -m "Test"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    it('handles multi-digit issue numbers', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('issue/99999-test');
      const input = createBashInput('git commit -m "Fix"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('#99999');
    });

    it('matches when issue number appears as substring', () => {
      // Arrange
      vi.mocked(getCachedBranch).mockReturnValue('issue/123-test');
      const input = createBashInput('git commit -m "Update v1234 release"');

      // Act
      const result = issueReferenceChecker(input);

      // Assert - "1234" contains "123" as substring, so check passes
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });
  });
});
