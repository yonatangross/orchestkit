// Generated by OrchestKit Claude Plugin
// Created: 2026-02-06

/**
 * Unit tests for team-size-gate PreToolUse[Task] hook
 *
 * Tests the team size enforcement gate:
 * 1. Allows non-team Task spawns (passthrough)
 * 2. Allows team spawns under limits
 * 3. Blocks when team size >= 6
 * 4. Blocks Opus spawns when >= 3 Opus members
 *
 * @since CC 2.1.33
 */

import { describe, test, expect, beforeEach, vi } from 'vitest';

// Mock dependencies before imports
vi.mock('../../../lib/common.js', () => ({
  outputSilentSuccess: vi.fn(() => ({ continue: true, suppressOutput: true })),
  outputDeny: vi.fn((reason: string) => ({
    continue: false,
    stopReason: reason,
    hookSpecificOutput: {
      hookEventName: 'PreToolUse',
      permissionDecision: 'deny',
      permissionDecisionReason: reason,
    },
  })),
  logHook: vi.fn(),
}));

vi.mock('../../../lib/agent-teams.js', () => ({
  getTeamMembers: vi.fn(() => []),
}));

import { teamSizeGate } from '../../../pretool/task/team-size-gate.js';
import { getTeamMembers } from '../../../lib/agent-teams.js';
import type { HookInput } from '../../../types.js';

// =============================================================================
// Helpers
// =============================================================================

function createTaskInput(toolInputOverrides: Record<string, unknown> = {}, overrides: Partial<HookInput> = {}): HookInput {
  return {
    tool_name: 'Task',
    session_id: 'test-session-001',
    tool_input: {
      subagent_type: 'general-purpose',
      description: 'Test spawn',
      ...toolInputOverrides,
    },
    ...overrides,
  };
}

// =============================================================================
// Tests
// =============================================================================

describe('team-size-gate', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    vi.mocked(getTeamMembers).mockReturnValue([]);
  });

  describe('non-team spawns (passthrough)', () => {
    test('allows Task spawn without team_name', () => {
      // Arrange
      const input = createTaskInput();

      // Act
      const result = teamSizeGate(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(getTeamMembers).not.toHaveBeenCalled();
    });

    test('allows Task spawn with empty tool_input', () => {
      // Arrange
      const input: HookInput = {
        tool_name: 'Task',
        session_id: 'test',
        tool_input: {},
      };

      // Act
      const result = teamSizeGate(input);

      // Assert
      expect(result.continue).toBe(true);
    });
  });

  describe('team size enforcement', () => {
    test('allows team spawn when under limit', () => {
      // Arrange
      vi.mocked(getTeamMembers).mockReturnValue([
        { name: 'researcher', agentType: 'sonnet' },
        { name: 'coder', agentType: 'sonnet' },
      ]);
      const input = createTaskInput({ team_name: 'my-team' });

      // Act
      const result = teamSizeGate(input);

      // Assert
      expect(result.continue).toBe(true);
    });

    test('allows team spawn at 5 members (under 6 limit)', () => {
      // Arrange
      vi.mocked(getTeamMembers).mockReturnValue(
        Array.from({ length: 5 }, (_, i) => ({
          name: `member-${i}`,
          agentType: 'sonnet',
        })),
      );
      const input = createTaskInput({ team_name: 'my-team' });

      // Act
      const result = teamSizeGate(input);

      // Assert
      expect(result.continue).toBe(true);
    });

    test('blocks team spawn at 6 members (at limit)', () => {
      // Arrange
      vi.mocked(getTeamMembers).mockReturnValue(
        Array.from({ length: 6 }, (_, i) => ({
          name: `member-${i}`,
          agentType: 'sonnet',
        })),
      );
      const input = createTaskInput({
        team_name: 'my-team',
        description: 'Spawn another agent',
      });

      // Act
      const result = teamSizeGate(input);

      // Assert
      expect(result.continue).toBe(false);
      expect(result.stopReason).toContain('Team Size Limit');
      expect(result.stopReason).toContain('6');
    });

    test('blocks team spawn above limit', () => {
      // Arrange
      vi.mocked(getTeamMembers).mockReturnValue(
        Array.from({ length: 8 }, (_, i) => ({
          name: `member-${i}`,
          agentType: 'haiku',
        })),
      );
      const input = createTaskInput({ team_name: 'big-team' });

      // Act
      const result = teamSizeGate(input);

      // Assert
      expect(result.continue).toBe(false);
    });
  });

  describe('Opus model limit', () => {
    test('allows Opus spawn when under Opus limit', () => {
      // Arrange
      vi.mocked(getTeamMembers).mockReturnValue([
        { name: 'lead', agentType: 'opus' },
        { name: 'researcher', agentType: 'opus' },
        { name: 'coder', agentType: 'sonnet' },
      ]);
      const input = createTaskInput({ team_name: 'my-team', model: 'opus' });

      // Act
      const result = teamSizeGate(input);

      // Assert
      expect(result.continue).toBe(true);
    });

    test('blocks Opus spawn when at Opus limit (3)', () => {
      // Arrange
      vi.mocked(getTeamMembers).mockReturnValue([
        { name: 'lead', agentType: 'opus' },
        { name: 'architect', agentType: 'opus' },
        { name: 'reviewer', agentType: 'opus' },
        { name: 'coder', agentType: 'sonnet' },
      ]);
      const input = createTaskInput({
        team_name: 'my-team',
        model: 'opus',
        description: 'Spawn Opus agent',
      });

      // Act
      const result = teamSizeGate(input);

      // Assert
      expect(result.continue).toBe(false);
      expect(result.stopReason).toContain('Opus Model Limit');
    });

    test('allows sonnet spawn even when Opus limit reached', () => {
      // Arrange
      vi.mocked(getTeamMembers).mockReturnValue([
        { name: 'lead', agentType: 'opus' },
        { name: 'architect', agentType: 'opus' },
        { name: 'reviewer', agentType: 'opus' },
      ]);
      const input = createTaskInput({ team_name: 'my-team', model: 'sonnet' });

      // Act
      const result = teamSizeGate(input);

      // Assert
      expect(result.continue).toBe(true);
    });

    test('allows haiku spawn even when Opus limit reached', () => {
      // Arrange
      vi.mocked(getTeamMembers).mockReturnValue([
        { name: 'lead', agentType: 'opus' },
        { name: 'architect', agentType: 'opus' },
        { name: 'reviewer', agentType: 'opus' },
      ]);
      const input = createTaskInput({ team_name: 'my-team', model: 'haiku' });

      // Act
      const result = teamSizeGate(input);

      // Assert
      expect(result.continue).toBe(true);
    });
  });
});
