// Generated by OrchestKit Claude Plugin
// Created: 2026-02-10

import { describe, it, expect, vi, beforeEach } from 'vitest';
import type { HookInput } from '../../../types.js';

// Mock node:fs
vi.mock('node:fs', () => ({
  existsSync: vi.fn(),
  readFileSync: vi.fn(),
  statSync: vi.fn(),
}));

// Mock common.ts
vi.mock('../../../lib/common.js', () => ({
  outputAllowWithContext: vi.fn((ctx: string) => ({
    continue: true,
    suppressOutput: true,
    hookSpecificOutput: { hookEventName: 'PreToolUse', additionalContext: ctx, permissionDecision: 'allow' },
  })),
  outputSilentSuccess: vi.fn(() => ({ continue: true, suppressOutput: true })),
  logHook: vi.fn(),
  estimateTokenCount: vi.fn((content: string) => Math.ceil(content.length / 3)),
}));

// Mock code-summarizer.ts
vi.mock('../../../lib/code-summarizer.js', () => ({
  isSummarizable: vi.fn((ext: string) => ['.ts', '.py', '.go', '.rs', '.sh', '.md'].includes(ext)),
  summarizeCode: vi.fn(() => '[TLDR] test.ts (600 lines, ~2100 tokens, TypeScript)\n\nFunctions (3):\n  foo\n  bar\n  baz'),
}));

import { existsSync, readFileSync, statSync } from 'node:fs';
import { outputAllowWithContext, outputSilentSuccess } from '../../../lib/common.js';
import { summarizeCode } from '../../../lib/code-summarizer.js';
import { tldrSummary } from '../../../pretool/read/tldr-summary.js';

function makeInput(overrides: Partial<HookInput['tool_input']> = {}): HookInput {
  return {
    tool_name: 'Read',
    session_id: 'test-session',
    tool_input: { file_path: '/project/src/big-file.ts', ...overrides },
  };
}

// Generate content with N lines
function makeContent(lines: number): string {
  return Array.from({ length: lines }, (_, i) => `// line ${i + 1}`).join('\n');
}

beforeEach(() => {
  vi.clearAllMocks();
  // Default: file exists, reasonable size, large content
  (existsSync as ReturnType<typeof vi.fn>).mockReturnValue(true);
  (statSync as ReturnType<typeof vi.fn>).mockReturnValue({ size: 50_000 });
  (readFileSync as ReturnType<typeof vi.fn>).mockReturnValue(makeContent(600));
});

// ---------------------------------------------------------------------------
// Guard conditions
// ---------------------------------------------------------------------------

describe('tldrSummary — guard conditions', () => {
  it('passes through when no file_path', () => {
    const result = tldrSummary(makeInput({ file_path: undefined }));
    expect(result).toEqual(outputSilentSuccess());
    expect(readFileSync).not.toHaveBeenCalled();
  });

  it('passes through when offset is set', () => {
    const result = tldrSummary(makeInput({ offset: 100 }));
    expect(result).toEqual(outputSilentSuccess());
    expect(readFileSync).not.toHaveBeenCalled();
  });

  it('passes through when limit is set', () => {
    const result = tldrSummary(makeInput({ limit: 50 }));
    expect(result).toEqual(outputSilentSuccess());
    expect(readFileSync).not.toHaveBeenCalled();
  });

  it('passes through for unsupported extension', () => {
    const result = tldrSummary(makeInput({ file_path: '/project/styles.css' }));
    expect(result).toEqual(outputSilentSuccess());
    expect(readFileSync).not.toHaveBeenCalled();
  });

  it('passes through for files without extension', () => {
    const result = tldrSummary(makeInput({ file_path: '/project/Makefile' }));
    expect(result).toEqual(outputSilentSuccess());
  });

  it('passes through when file does not exist', () => {
    (existsSync as ReturnType<typeof vi.fn>).mockReturnValue(false);
    const result = tldrSummary(makeInput());
    expect(result).toEqual(outputSilentSuccess());
    expect(readFileSync).not.toHaveBeenCalled();
  });

  it('passes through when file > 2MB', () => {
    (statSync as ReturnType<typeof vi.fn>).mockReturnValue({ size: 3_000_000 });
    const result = tldrSummary(makeInput());
    expect(result).toEqual(outputSilentSuccess());
    expect(readFileSync).not.toHaveBeenCalled();
  });

  it('passes through for small files (below both thresholds)', () => {
    const smallContent = makeContent(100); // 100 lines
    (readFileSync as ReturnType<typeof vi.fn>).mockReturnValue(smallContent);
    const result = tldrSummary(makeInput());
    expect(result).toEqual(outputSilentSuccess());
    expect(outputAllowWithContext).not.toHaveBeenCalled();
  });
});

// ---------------------------------------------------------------------------
// Summary injection
// ---------------------------------------------------------------------------

describe('tldrSummary — summary injection', () => {
  it('injects summary for large .ts files', () => {
    tldrSummary(makeInput({ file_path: '/project/src/service.ts' }));
    expect(summarizeCode).toHaveBeenCalled();
    expect(outputAllowWithContext).toHaveBeenCalledWith(expect.stringContaining('[TLDR]'));
  });

  it('injects summary for .py files', () => {
    tldrSummary(makeInput({ file_path: '/project/app/main.py' }));
    expect(outputAllowWithContext).toHaveBeenCalled();
  });

  it('injects summary for .go files', () => {
    tldrSummary(makeInput({ file_path: '/project/main.go' }));
    expect(outputAllowWithContext).toHaveBeenCalled();
  });

  it('injects summary for .rs files', () => {
    tldrSummary(makeInput({ file_path: '/project/src/lib.rs' }));
    expect(outputAllowWithContext).toHaveBeenCalled();
  });

  it('injects summary for .md files', () => {
    tldrSummary(makeInput({ file_path: '/project/docs/guide.md' }));
    expect(outputAllowWithContext).toHaveBeenCalled();
  });

  it('passes through when summarizeCode returns null', () => {
    (summarizeCode as ReturnType<typeof vi.fn>).mockReturnValueOnce(null);
    const result = tldrSummary(makeInput());
    expect(result).toEqual(outputSilentSuccess());
  });

  it('triggers on file at exactly 500 lines', () => {
    (readFileSync as ReturnType<typeof vi.fn>).mockReturnValue(makeContent(500));
    tldrSummary(makeInput());
    expect(outputAllowWithContext).toHaveBeenCalled();
  });
});

// ---------------------------------------------------------------------------
// Error handling
// ---------------------------------------------------------------------------

describe('tldrSummary — error handling', () => {
  it('returns silent success when readFileSync throws', () => {
    (readFileSync as ReturnType<typeof vi.fn>).mockImplementation(() => {
      throw new Error('EACCES: permission denied');
    });
    const result = tldrSummary(makeInput());
    expect(result).toEqual(outputSilentSuccess());
  });

  it('returns silent success when statSync throws', () => {
    (statSync as ReturnType<typeof vi.fn>).mockImplementation(() => {
      throw new Error('ENOENT');
    });
    const result = tldrSummary(makeInput());
    expect(result).toEqual(outputSilentSuccess());
  });
});
