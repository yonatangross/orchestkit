// Generated by OrchestKit Claude Plugin
// Created: 2026-02-06

/**
 * Unit tests for progress-reporter TeammateIdle hook
 *
 * Tests the CC 2.1.33 TeammateIdle event handler that:
 * 1. Logs idle events for workflow analytics
 * 2. Surfaces long idle durations (>30s) for work reassignment
 *
 * @since CC 2.1.33
 */

import { describe, test, expect, beforeEach, vi } from 'vitest';

// Mock dependencies before imports
vi.mock('../../lib/common.js', () => ({
  getProjectDir: vi.fn(() => '/test/project'),
}));

vi.mock('../../lib/event-logger.js', () => ({
  appendEventLog: vi.fn(),
}));

import { progressReporter } from '../../teammate-idle/progress-reporter.js';
import { getProjectDir } from '../../lib/common.js';
import { appendEventLog } from '../../lib/event-logger.js';
import type { HookInput } from '../../types.js';

// =============================================================================
// Helpers
// =============================================================================

function createIdleInput(overrides: Partial<HookInput> = {}): HookInput {
  return {
    tool_name: '',
    session_id: 'test-session-123',
    project_dir: '/test/project',
    tool_input: {},
    teammate_id: 'agent-xyz',
    teammate_type: 'code-reviewer',
    idle_duration_ms: 5000,
    ...overrides,
  };
}

// =============================================================================
// Tests
// =============================================================================

describe('progress-reporter', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    vi.mocked(getProjectDir).mockReturnValue('/test/project');
  });

  describe('basic behavior', () => {
    test('always returns continue: true', async () => {
      // Arrange
      const input = createIdleInput();

      // Act
      const result = await progressReporter(input);

      // Assert
      expect(result.continue).toBe(true);
    });

    test('returns early when project dir is not available', async () => {
      // Arrange
      vi.mocked(getProjectDir).mockReturnValue('');
      const input = createIdleInput();

      // Act
      const result = await progressReporter(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(appendEventLog).not.toHaveBeenCalled();
    });
  });

  describe('event logging', () => {
    test('logs teammate idle event to teammate-activity.jsonl', async () => {
      // Arrange
      const input = createIdleInput({
        teammate_id: 'agent-001',
        teammate_type: 'backend-engineer',
        idle_duration_ms: 10000,
        session_id: 'session-abc',
      });

      // Act
      await progressReporter(input);

      // Assert
      expect(appendEventLog).toHaveBeenCalledWith(
        'teammate-activity.jsonl',
        expect.objectContaining({
          event: 'teammate_idle',
          teammate_id: 'agent-001',
          teammate_type: 'backend-engineer',
          idle_duration_ms: 10000,
          session_id: 'session-abc',
        }),
      );
    });

    test('includes ISO timestamp in log entry', async () => {
      // Arrange
      const input = createIdleInput();

      // Act
      await progressReporter(input);

      // Assert
      expect(appendEventLog).toHaveBeenCalledWith(
        'teammate-activity.jsonl',
        expect.objectContaining({
          timestamp: expect.stringMatching(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/),
        }),
      );
    });

    test('falls back to agent_id when teammate_id is not set', async () => {
      // Arrange
      const input = createIdleInput({
        teammate_id: undefined,
        agent_id: 'fallback-agent-id',
      });

      // Act
      await progressReporter(input);

      // Assert
      expect(appendEventLog).toHaveBeenCalledWith(
        'teammate-activity.jsonl',
        expect.objectContaining({
          teammate_id: 'fallback-agent-id',
        }),
      );
    });

    test('falls back to subagent_type when teammate_type is not set', async () => {
      // Arrange
      const input = createIdleInput({
        teammate_type: undefined,
        subagent_type: 'test-runner',
      });

      // Act
      await progressReporter(input);

      // Assert
      expect(appendEventLog).toHaveBeenCalledWith(
        'teammate-activity.jsonl',
        expect.objectContaining({
          teammate_type: 'test-runner',
        }),
      );
    });

    test('defaults teammate_id to "unknown" when neither field is set', async () => {
      // Arrange
      const input = createIdleInput({
        teammate_id: undefined,
        agent_id: undefined,
      });

      // Act
      await progressReporter(input);

      // Assert
      expect(appendEventLog).toHaveBeenCalledWith(
        'teammate-activity.jsonl',
        expect.objectContaining({
          teammate_id: 'unknown',
        }),
      );
    });

    test('defaults teammate_type to "unknown" when neither field is set', async () => {
      // Arrange
      const input = createIdleInput({
        teammate_type: undefined,
        subagent_type: undefined,
      });

      // Act
      await progressReporter(input);

      // Assert
      expect(appendEventLog).toHaveBeenCalledWith(
        'teammate-activity.jsonl',
        expect.objectContaining({
          teammate_type: 'unknown',
        }),
      );
    });

    test('defaults idle_duration_ms to 0 when not provided', async () => {
      // Arrange
      const input = createIdleInput({ idle_duration_ms: undefined });

      // Act
      await progressReporter(input);

      // Assert
      expect(appendEventLog).toHaveBeenCalledWith(
        'teammate-activity.jsonl',
        expect.objectContaining({
          idle_duration_ms: 0,
        }),
      );
    });
  });

  describe('idle duration thresholds', () => {
    test('does NOT surface context for idle < 30s', async () => {
      // Arrange
      const input = createIdleInput({ idle_duration_ms: 29999 });

      // Act
      const result = await progressReporter(input);

      // Assert
      expect(result.hookSpecificOutput).toBeUndefined();
    });

    test('does NOT surface context for exactly 30s', async () => {
      // Arrange
      const input = createIdleInput({ idle_duration_ms: 30000 });

      // Act
      const result = await progressReporter(input);

      // Assert
      expect(result.hookSpecificOutput).toBeUndefined();
    });

    test('surfaces context for idle > 30s', async () => {
      // Arrange
      const input = createIdleInput({
        teammate_type: 'database-engineer',
        teammate_id: 'agent-db',
        idle_duration_ms: 31000,
      });

      // Act
      const result = await progressReporter(input);

      // Assert
      expect(result.hookSpecificOutput).toBeDefined();
      expect(result.hookSpecificOutput?.additionalContext).toContain(
        'Consider reassigning pending work',
      );
    });

    test('includes agent type in reassignment message', async () => {
      // Arrange
      const input = createIdleInput({
        teammate_type: 'test-runner',
        idle_duration_ms: 60000,
      });

      // Act
      const result = await progressReporter(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('test-runner');
    });

    test('includes teammate ID in reassignment message', async () => {
      // Arrange
      const input = createIdleInput({
        teammate_id: 'agent-special-123',
        idle_duration_ms: 45000,
      });

      // Act
      const result = await progressReporter(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('agent-special-123');
    });

    test('shows idle duration in seconds', async () => {
      // Arrange
      const input = createIdleInput({ idle_duration_ms: 90000 });

      // Act
      const result = await progressReporter(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('90s');
    });

    test('handles very long idle durations', async () => {
      // Arrange
      const input = createIdleInput({ idle_duration_ms: 600000 }); // 10 minutes

      // Act
      const result = await progressReporter(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.hookSpecificOutput?.additionalContext).toContain('600s');
    });
  });

  describe('edge cases', () => {
    test('handles zero idle duration', async () => {
      // Arrange
      const input = createIdleInput({ idle_duration_ms: 0 });

      // Act
      const result = await progressReporter(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.hookSpecificOutput).toBeUndefined();
    });

    test('still logs event even for short idle duration', async () => {
      // Arrange
      const input = createIdleInput({ idle_duration_ms: 100 });

      // Act
      await progressReporter(input);

      // Assert
      expect(appendEventLog).toHaveBeenCalledTimes(1);
    });
  });
});
