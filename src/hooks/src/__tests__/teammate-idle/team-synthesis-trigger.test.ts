// Generated by OrchestKit Claude Plugin
// Created: 2026-02-06

/**
 * Unit tests for team-synthesis-trigger TeammateIdle hook
 *
 * Tests the synthesis trigger:
 * 1. All teammates idle: surface synthesis suggestion
 * 2. Partial idle: silent success
 * 3. No team active: silent success
 *
 * @since CC 2.1.33
 */

import { describe, test, expect, beforeEach, vi } from 'vitest';

// Mock dependencies before imports
vi.mock('node:fs', () => ({
  existsSync: vi.fn(() => false),
  readFileSync: vi.fn(() => ''),
}));

vi.mock('../../lib/common.js', () => ({
  getProjectDir: vi.fn(() => '/test/project'),
  outputSilentSuccess: vi.fn(() => ({ continue: true, suppressOutput: true })),
  outputWithContext: vi.fn((ctx: string) => ({
    continue: true,
    suppressOutput: true,
    hookSpecificOutput: {
      hookEventName: 'PostToolUse',
      additionalContext: ctx,
    },
  })),
  logHook: vi.fn(),
}));

vi.mock('../../lib/agent-teams.js', () => ({
  getTeamName: vi.fn(() => null),
  getTeamMembers: vi.fn(() => []),
}));

import { teamSynthesisTrigger } from '../../teammate-idle/team-synthesis-trigger.js';
import { getProjectDir } from '../../lib/common.js';
import { getTeamName, getTeamMembers } from '../../lib/agent-teams.js';
import { existsSync, readFileSync } from 'node:fs';
import type { HookInput } from '../../types.js';

// =============================================================================
// Helpers
// =============================================================================

function createIdleInput(overrides: Partial<HookInput> = {}): HookInput {
  return {
    tool_name: '',
    session_id: 'test-session-001',
    tool_input: {},
    teammate_id: 'agent-1',
    teammate_type: 'researcher',
    idle_duration_ms: 5000,
    ...overrides,
  };
}

function makeActivityLog(entries: Array<{ event: string; teammate_id: string; timestamp: string }>): string {
  return entries.map((e) => JSON.stringify(e)).join('\n');
}

// =============================================================================
// Tests
// =============================================================================

describe('team-synthesis-trigger', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    vi.mocked(getProjectDir).mockReturnValue('/test/project');
    vi.mocked(getTeamName).mockReturnValue(null);
    vi.mocked(getTeamMembers).mockReturnValue([]);
    vi.mocked(existsSync).mockReturnValue(false);
  });

  describe('no team active', () => {
    test('returns silent success when no team name', () => {
      // Arrange
      vi.mocked(getTeamName).mockReturnValue(null);
      const input = createIdleInput();

      // Act
      const result = teamSynthesisTrigger(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    test('returns silent success when no team members', () => {
      // Arrange
      vi.mocked(getTeamName).mockReturnValue('my-team');
      vi.mocked(getTeamMembers).mockReturnValue([]);
      const input = createIdleInput();

      // Act
      const result = teamSynthesisTrigger(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    test('returns silent success when no project dir', () => {
      // Arrange
      vi.mocked(getTeamName).mockReturnValue('my-team');
      vi.mocked(getTeamMembers).mockReturnValue([{ name: 'a', agentType: 'sonnet' }]);
      vi.mocked(getProjectDir).mockReturnValue('');
      const input = createIdleInput();

      // Act
      const result = teamSynthesisTrigger(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });
  });

  describe('partial idle', () => {
    test('returns silent success when only some teammates are idle', () => {
      // Arrange
      vi.mocked(getTeamName).mockReturnValue('my-team');
      vi.mocked(getTeamMembers).mockReturnValue([
        { name: 'member-1', agentType: 'sonnet' },
        { name: 'member-2', agentType: 'sonnet' },
        { name: 'member-3', agentType: 'haiku' },
      ]);
      vi.mocked(existsSync).mockReturnValue(true);

      const now = new Date().toISOString();
      vi.mocked(readFileSync).mockReturnValue(
        makeActivityLog([
          { event: 'teammate_idle', teammate_id: 'member-1', timestamp: now },
        ]),
      );

      const input = createIdleInput({ teammate_id: 'member-2' });

      // Act
      const result = teamSynthesisTrigger(input);

      // Assert
      // 2 idle out of 3 → not all idle → silent
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    test('returns silent success when no activity log exists', () => {
      // Arrange
      vi.mocked(getTeamName).mockReturnValue('my-team');
      vi.mocked(getTeamMembers).mockReturnValue([
        { name: 'member-1', agentType: 'sonnet' },
      ]);
      vi.mocked(existsSync).mockReturnValue(false);

      const input = createIdleInput({ teammate_id: 'agent-1' });

      // Act
      const result = teamSynthesisTrigger(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });
  });

  describe('all teammates idle', () => {
    test('surfaces synthesis suggestion when all members idle', () => {
      // Arrange
      vi.mocked(getTeamName).mockReturnValue('audit-team');
      vi.mocked(getTeamMembers).mockReturnValue([
        { name: 'auditor-1', agentType: 'sonnet' },
        { name: 'auditor-2', agentType: 'sonnet' },
      ]);
      vi.mocked(existsSync).mockReturnValue(true);

      const now = new Date().toISOString();
      vi.mocked(readFileSync).mockReturnValue(
        makeActivityLog([
          { event: 'teammate_idle', teammate_id: 'auditor-1', timestamp: now },
          { event: 'teammate_idle', teammate_id: 'auditor-2', timestamp: now },
        ]),
      );

      const input = createIdleInput({ teammate_id: 'auditor-2' });

      // Act
      const result = teamSynthesisTrigger(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.hookSpecificOutput?.additionalContext).toContain('All 2 teammates');
      expect(result.hookSpecificOutput?.additionalContext).toContain('audit-team');
      expect(result.hookSpecificOutput?.additionalContext).toContain('synthesizing');
    });

    test('includes current idle event teammate in count', () => {
      // Arrange - 2 members, only 1 in log, current event is the 2nd
      vi.mocked(getTeamName).mockReturnValue('my-team');
      vi.mocked(getTeamMembers).mockReturnValue([
        { name: 'a', agentType: 'sonnet' },
        { name: 'b', agentType: 'sonnet' },
      ]);
      vi.mocked(existsSync).mockReturnValue(true);

      const now = new Date().toISOString();
      vi.mocked(readFileSync).mockReturnValue(
        makeActivityLog([
          { event: 'teammate_idle', teammate_id: 'a', timestamp: now },
        ]),
      );

      const input = createIdleInput({ teammate_id: 'b' });

      // Act
      const result = teamSynthesisTrigger(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('All 2 teammates');
    });
  });
});
