// Generated by OrchestKit Claude Plugin
// Created: 2026-02-06

/**
 * Unit tests for team-quality-gate TeammateIdle hook
 *
 * Tests the quality aggregation hook:
 * 1. Teammate completed task: silent success
 * 2. Teammate idle without completion: surface warning
 * 3. No team active: silent success
 *
 * @since CC 2.1.33
 */

import { describe, test, expect, beforeEach, vi } from 'vitest';

// Mock dependencies before imports
vi.mock('node:fs', () => ({
  existsSync: vi.fn(() => false),
  readFileSync: vi.fn(() => ''),
}));

vi.mock('../../lib/common.js', () => ({
  getProjectDir: vi.fn(() => '/test/project'),
  outputSilentSuccess: vi.fn(() => ({ continue: true, suppressOutput: true })),
  outputWithContext: vi.fn((ctx: string) => ({
    continue: true,
    suppressOutput: true,
    hookSpecificOutput: {
      hookEventName: 'PostToolUse',
      additionalContext: ctx,
    },
  })),
  logHook: vi.fn(),
}));

vi.mock('../../lib/agent-teams.js', () => ({
  getTeamName: vi.fn(() => null),
}));

vi.mock('../../lib/event-logger.js', () => ({
  appendEventLog: vi.fn(),
}));

import { teamQualityGate } from '../../teammate-idle/team-quality-gate.js';
import { getProjectDir } from '../../lib/common.js';
import { getTeamName } from '../../lib/agent-teams.js';
import { appendEventLog } from '../../lib/event-logger.js';
import { existsSync, readFileSync } from 'node:fs';
import type { HookInput } from '../../types.js';

// =============================================================================
// Helpers
// =============================================================================

function createIdleInput(overrides: Partial<HookInput> = {}): HookInput {
  return {
    tool_name: '',
    session_id: 'test-session-001',
    tool_input: {},
    teammate_id: 'agent-1',
    teammate_type: 'researcher',
    idle_duration_ms: 5000,
    ...overrides,
  };
}

function makeCompletionLog(entries: Array<{ event: string; timestamp: string }>): string {
  return entries.map((e) => JSON.stringify(e)).join('\n');
}

// =============================================================================
// Tests
// =============================================================================

describe('team-quality-gate', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    vi.mocked(getProjectDir).mockReturnValue('/test/project');
    vi.mocked(getTeamName).mockReturnValue(null);
    vi.mocked(existsSync).mockReturnValue(false);
  });

  describe('no team active', () => {
    test('returns silent success when no team name', () => {
      // Arrange
      vi.mocked(getTeamName).mockReturnValue(null);
      const input = createIdleInput();

      // Act
      const result = teamQualityGate(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
      expect(appendEventLog).not.toHaveBeenCalled();
    });

    test('returns silent success when no project dir', () => {
      // Arrange
      vi.mocked(getTeamName).mockReturnValue('my-team');
      vi.mocked(getProjectDir).mockReturnValue('');
      const input = createIdleInput();

      // Act
      const result = teamQualityGate(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });
  });

  describe('teammate with recent completion', () => {
    test('returns silent success when teammate has recent task completion', () => {
      // Arrange
      vi.mocked(getTeamName).mockReturnValue('my-team');
      vi.mocked(existsSync).mockReturnValue(true);

      const now = new Date().toISOString();
      vi.mocked(readFileSync).mockReturnValue(
        makeCompletionLog([
          { event: 'task_completed', timestamp: now },
        ]),
      );

      const input = createIdleInput({
        teammate_id: 'agent-1',
        teammate_type: 'code-reviewer',
      });

      // Act
      const result = teamQualityGate(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
    });

    test('logs quality check event even on success', () => {
      // Arrange
      vi.mocked(getTeamName).mockReturnValue('my-team');
      vi.mocked(existsSync).mockReturnValue(true);

      const now = new Date().toISOString();
      vi.mocked(readFileSync).mockReturnValue(
        makeCompletionLog([
          { event: 'task_completed', timestamp: now },
        ]),
      );

      const input = createIdleInput({
        teammate_id: 'agent-1',
        teammate_type: 'code-reviewer',
      });

      // Act
      teamQualityGate(input);

      // Assert
      expect(appendEventLog).toHaveBeenCalledWith(
        'team-quality.jsonl',
        expect.objectContaining({
          event: 'teammate_quality_check',
          team_name: 'my-team',
          teammate_id: 'agent-1',
          teammate_type: 'code-reviewer',
          has_recent_completion: true,
        }),
      );
    });
  });

  describe('teammate idle without completion', () => {
    test('surfaces warning when no recent task completion', () => {
      // Arrange
      vi.mocked(getTeamName).mockReturnValue('my-team');
      vi.mocked(existsSync).mockReturnValue(false); // No completions log

      const input = createIdleInput({
        teammate_id: 'agent-stuck',
        teammate_type: 'backend-engineer',
      });

      // Act
      const result = teamQualityGate(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.hookSpecificOutput?.additionalContext).toContain('backend-engineer');
      expect(result.hookSpecificOutput?.additionalContext).toContain('agent-stuck');
      expect(result.hookSpecificOutput?.additionalContext).toContain('without completing');
    });

    test('surfaces warning when completions are too old', () => {
      // Arrange
      vi.mocked(getTeamName).mockReturnValue('my-team');
      vi.mocked(existsSync).mockReturnValue(true);

      // Completion from 6+ minutes ago (outside 5-minute COMPLETION_WINDOW_MS)
      const oldTimestamp = new Date(Date.now() - 400_000).toISOString();
      vi.mocked(readFileSync).mockReturnValue(
        makeCompletionLog([
          { event: 'task_completed', timestamp: oldTimestamp },
        ]),
      );

      const input = createIdleInput({
        teammate_id: 'agent-old',
        teammate_type: 'tester',
      });

      // Act
      const result = teamQualityGate(input);

      // Assert
      expect(result.hookSpecificOutput?.additionalContext).toContain('without completing');
    });

    test('logs quality check with has_recent_completion=false', () => {
      // Arrange
      vi.mocked(getTeamName).mockReturnValue('my-team');
      vi.mocked(existsSync).mockReturnValue(false);

      const input = createIdleInput({
        teammate_id: 'agent-1',
        teammate_type: 'researcher',
      });

      // Act
      teamQualityGate(input);

      // Assert
      expect(appendEventLog).toHaveBeenCalledWith(
        'team-quality.jsonl',
        expect.objectContaining({
          has_recent_completion: false,
        }),
      );
    });
  });

  describe('fallback fields', () => {
    test('falls back to agent_id when teammate_id not set', () => {
      // Arrange
      vi.mocked(getTeamName).mockReturnValue('my-team');
      const input = createIdleInput({
        teammate_id: undefined,
        agent_id: 'fallback-id',
      });

      // Act
      teamQualityGate(input);

      // Assert
      expect(appendEventLog).toHaveBeenCalledWith(
        'team-quality.jsonl',
        expect.objectContaining({ teammate_id: 'fallback-id' }),
      );
    });

    test('defaults to "unknown" when no id fields set', () => {
      // Arrange
      vi.mocked(getTeamName).mockReturnValue('my-team');
      const input = createIdleInput({
        teammate_id: undefined,
        agent_id: undefined,
      });

      // Act
      teamQualityGate(input);

      // Assert
      expect(appendEventLog).toHaveBeenCalledWith(
        'team-quality.jsonl',
        expect.objectContaining({ teammate_id: 'unknown' }),
      );
    });

    test('falls back to subagent_type when teammate_type not set', () => {
      // Arrange
      vi.mocked(getTeamName).mockReturnValue('my-team');
      const input = createIdleInput({
        teammate_type: undefined,
        subagent_type: 'code-reviewer',
      });

      // Act
      teamQualityGate(input);

      // Assert
      expect(appendEventLog).toHaveBeenCalledWith(
        'team-quality.jsonl',
        expect.objectContaining({ teammate_type: 'code-reviewer' }),
      );
    });
  });
});
