// Generated by OrchestKit Claude Plugin
// Created: 2026-02-06

/**
 * Unit tests for team-member-start PostToolUse[Task] hook
 *
 * Tests the team member tracking hook:
 * 1. Logs team spawn events to teammate-activity.jsonl
 * 2. Returns context with spawn info
 * 3. Passes through non-team spawns silently
 * 4. Handles missing teammate name gracefully
 *
 * @since CC 2.1.33
 */

import { describe, test, expect, beforeEach, vi } from 'vitest';

// Mock dependencies before imports
vi.mock('../../../lib/common.js', () => ({
  outputSilentSuccess: vi.fn(() => ({ continue: true, suppressOutput: true })),
  outputWithContext: vi.fn((ctx: string) => ({
    continue: true,
    suppressOutput: true,
    hookSpecificOutput: {
      hookEventName: 'PostToolUse',
      additionalContext: ctx,
    },
  })),
  logHook: vi.fn(),
}));

vi.mock('../../../lib/event-logger.js', () => ({
  appendEventLog: vi.fn(),
}));

import { teamMemberStart } from '../../../posttool/task/team-member-start.js';
import { appendEventLog } from '../../../lib/event-logger.js';
import type { HookInput } from '../../../types.js';

// =============================================================================
// Helpers
// =============================================================================

function createTaskInput(toolInputOverrides: Record<string, unknown> = {}, overrides: Partial<HookInput> = {}): HookInput {
  return {
    tool_name: 'Task',
    session_id: 'test-session-001',
    tool_input: {
      subagent_type: 'general-purpose',
      description: 'Test agent',
      ...toolInputOverrides,
    },
    ...overrides,
  };
}

// =============================================================================
// Tests
// =============================================================================

describe('team-member-start', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe('non-team spawns (passthrough)', () => {
    test('returns silent success for non-team Task spawn', () => {
      // Arrange
      const input = createTaskInput();

      // Act
      const result = teamMemberStart(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(result.suppressOutput).toBe(true);
      expect(appendEventLog).not.toHaveBeenCalled();
    });

    test('returns silent success when tool_input is empty', () => {
      // Arrange
      const input: HookInput = {
        tool_name: 'Task',
        session_id: 'test',
        tool_input: {},
      };

      // Act
      const result = teamMemberStart(input);

      // Assert
      expect(result.continue).toBe(true);
      expect(appendEventLog).not.toHaveBeenCalled();
    });
  });

  describe('team member tracking', () => {
    test('logs team member start event', () => {
      // Arrange
      const input = createTaskInput({
        team_name: 'security-audit',
        name: 'researcher',
        subagent_type: 'Explore',
        model: 'sonnet',
        description: 'Research codebase',
      });

      // Act
      teamMemberStart(input);

      // Assert
      expect(appendEventLog).toHaveBeenCalledWith(
        'teammate-activity.jsonl',
        expect.objectContaining({
          event: 'team_member_start',
          team_name: 'security-audit',
          member_name: 'researcher',
          subagent_type: 'Explore',
          model: 'sonnet',
          description: 'Research codebase',
        }),
      );
    });

    test('includes ISO timestamp in log entry', () => {
      // Arrange
      const input = createTaskInput({ team_name: 'my-team', name: 'worker' });

      // Act
      teamMemberStart(input);

      // Assert
      expect(appendEventLog).toHaveBeenCalledWith(
        'teammate-activity.jsonl',
        expect.objectContaining({
          timestamp: expect.stringMatching(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/),
        }),
      );
    });

    test('includes session_id in log entry', () => {
      // Arrange
      const input = createTaskInput(
        { team_name: 'my-team', name: 'worker' },
        { session_id: 'session-xyz' },
      );

      // Act
      teamMemberStart(input);

      // Assert
      expect(appendEventLog).toHaveBeenCalledWith(
        'teammate-activity.jsonl',
        expect.objectContaining({ session_id: 'session-xyz' }),
      );
    });

    test('returns context with team spawn info', () => {
      // Arrange
      const input = createTaskInput({
        team_name: 'audit-team',
        name: 'auditor',
        subagent_type: 'security-auditor',
        model: 'opus',
      });

      // Act
      const result = teamMemberStart(input);

      // Assert
      expect(result.continue).toBe(true);
      // Issue #684: team-member-start now returns silent success (moved into async dispatcher)
      expect(result.suppressOutput).toBe(true);
    });
  });

  describe('missing fields', () => {
    test('defaults member name to "unnamed-teammate"', () => {
      // Arrange
      const input = createTaskInput({ team_name: 'my-team' });

      // Act
      teamMemberStart(input);

      // Assert
      expect(appendEventLog).toHaveBeenCalledWith(
        'teammate-activity.jsonl',
        expect.objectContaining({ member_name: 'unnamed-teammate' }),
      );
    });

    test('defaults subagent_type to "unknown"', () => {
      // Arrange
      const input = createTaskInput({
        team_name: 'my-team',
        name: 'worker',
        subagent_type: undefined,
      });

      // Act
      teamMemberStart(input);

      // Assert
      expect(appendEventLog).toHaveBeenCalledWith(
        'teammate-activity.jsonl',
        expect.objectContaining({ subagent_type: 'unknown' }),
      );
    });

    test('defaults model to "default"', () => {
      // Arrange
      const input = createTaskInput({
        team_name: 'my-team',
        name: 'worker',
      });

      // Act
      teamMemberStart(input);

      // Assert
      expect(appendEventLog).toHaveBeenCalledWith(
        'teammate-activity.jsonl',
        expect.objectContaining({ model: 'default' }),
      );
    });
  });
});
