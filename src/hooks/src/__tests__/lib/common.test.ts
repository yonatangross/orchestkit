// Generated by OrchestKit Claude Plugin
// Created: 2026-02-12

/**
 * Unit tests for common.ts output helpers
 *
 * Tests the outputStderrWarning helper (CC 2.1.39)
 */

import { describe, test, expect, vi, beforeEach } from 'vitest';

describe('outputStderrWarning', () => {
  let mockExit: ReturnType<typeof vi.spyOn>;
  let mockStderrWrite: ReturnType<typeof vi.spyOn>;

  beforeEach(() => {
    mockExit = vi.spyOn(process, 'exit').mockImplementation((() => {}) as never);
    mockStderrWrite = vi.spyOn(process.stderr, 'write').mockImplementation(() => true);
  });

  test('writes warning message to stderr with newline', async () => {
    // Dynamic import to avoid hoisting issues with mocks
    const { outputStderrWarning } = await import('../../lib/common.js');

    // Act
    outputStderrWarning('Something is deprecated');

    // Assert
    expect(mockStderrWrite).toHaveBeenCalledWith('\u26a0 Something is deprecated\n');
  });

  test('exits with code 2', async () => {
    const { outputStderrWarning } = await import('../../lib/common.js');

    // Act
    outputStderrWarning('Test warning');

    // Assert
    expect(mockExit).toHaveBeenCalledWith(2);
  });

  test('calls stderr.write before process.exit', async () => {
    const { outputStderrWarning } = await import('../../lib/common.js');

    const callOrder: string[] = [];
    mockStderrWrite.mockImplementation(() => {
      callOrder.push('stderr');
      return true;
    });
    mockExit.mockImplementation((() => {
      callOrder.push('exit');
    }) as never);

    // Act
    outputStderrWarning('Order test');

    // Assert
    expect(callOrder).toEqual(['stderr', 'exit']);
  });
});
