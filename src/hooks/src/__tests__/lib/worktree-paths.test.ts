// Generated by OrchestKit Claude Plugin
// Created: 2026-02-19

/**
 * Worktree Path Resolution Tests
 *
 * Verifies that path helpers in paths.ts work correctly when running from
 * a git worktree (CC 2.1.47+ worktree discovery support).
 */

import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import os from 'node:os';
import path from 'node:path';

// Save original env so we can restore it
const ORIGINAL_ENV = { ...process.env };

function setEnv(vars: Record<string, string | undefined>) {
  for (const [k, v] of Object.entries(vars)) {
    if (v === undefined) {
      delete process.env[k];
    } else {
      process.env[k] = v;
    }
  }
}

function restoreEnv() {
  // Remove any keys we might have added
  for (const k of ['CLAUDE_PROJECT_DIR', 'CLAUDE_PLUGIN_ROOT', 'CLAUDE_METRICS_FILE', 'CLAUDE_SESSION_ERRORS_FILE']) {
    delete process.env[k];
  }
  // Restore originals
  for (const k of ['CLAUDE_PROJECT_DIR', 'CLAUDE_PLUGIN_ROOT', 'CLAUDE_METRICS_FILE', 'CLAUDE_SESSION_ERRORS_FILE']) {
    if (ORIGINAL_ENV[k] !== undefined) {
      process.env[k] = ORIGINAL_ENV[k];
    }
  }
}

describe('worktree path resolution', () => {
  // Re-import dynamically so env changes take effect — vitest caches modules,
  // so we import the helpers once and rely on the fact that they read
  // process.env at call-time (not at import-time).
  let getProjectDir: () => string;
  let getPluginRoot: () => string;
  let getLogDir: () => string;
  let getMemoryDir: () => string;
  let getCoordinationDir: () => string;
  let getMetricsFile: () => string;
  let getSessionTempDir: (sessionId: string) => string;

  beforeEach(async () => {
    restoreEnv();
    // Import fresh each suite — paths.ts reads process.env at call time so a
    // single import is fine, but we need the module to be resolved at least once.
    const mod = await import('../../lib/paths.js');
    getProjectDir = mod.getProjectDir;
    getPluginRoot = mod.getPluginRoot;
    getLogDir = mod.getLogDir;
    getMemoryDir = mod.getMemoryDir;
    getCoordinationDir = mod.getCoordinationDir;
    getMetricsFile = mod.getMetricsFile;
    getSessionTempDir = mod.getSessionTempDir;
  });

  afterEach(() => {
    restoreEnv();
  });

  // -----------------------------------------------------------------------
  // Phase 1: paths.ts helpers with worktree-like directories
  // -----------------------------------------------------------------------

  describe('getProjectDir() with worktree path', () => {
    it('returns the worktree path from CLAUDE_PROJECT_DIR', () => {
      const worktreePath = '/tmp/orchestkit-worktree-feature-branch';
      setEnv({ CLAUDE_PROJECT_DIR: worktreePath });

      expect(getProjectDir()).toBe(worktreePath);
    });

    it('returns "." when CLAUDE_PROJECT_DIR is unset', () => {
      setEnv({ CLAUDE_PROJECT_DIR: undefined });

      expect(getProjectDir()).toBe('.');
    });
  });

  describe('getLogDir() with worktree path', () => {
    it('returns path under worktree when only CLAUDE_PROJECT_DIR is set', () => {
      const worktreePath = '/tmp/orchestkit-worktree-feature-branch';
      setEnv({ CLAUDE_PROJECT_DIR: worktreePath, CLAUDE_PLUGIN_ROOT: undefined });

      const logDir = getLogDir();

      expect(logDir).toBe(path.join(worktreePath, '.claude', 'logs'));
    });

    it('returns ork log dir under home when CLAUDE_PLUGIN_ROOT is set', () => {
      const worktreePath = '/tmp/orchestkit-worktree-feature-branch';
      const pluginRoot = '/Users/testuser/coding/orchestkit';
      setEnv({ CLAUDE_PROJECT_DIR: worktreePath, CLAUDE_PLUGIN_ROOT: pluginRoot });

      const logDir = getLogDir();
      const home = process.env.HOME || process.env.USERPROFILE || os.homedir();

      expect(logDir).toBe(path.join(home, '.claude', 'logs', 'ork'));
    });
  });

  describe('getMemoryDir() with worktree path', () => {
    it('returns memory path under worktree directory', () => {
      const worktreePath = '/tmp/orchestkit-worktree-feature-branch';
      setEnv({ CLAUDE_PROJECT_DIR: worktreePath });

      expect(getMemoryDir()).toBe(path.join(worktreePath, '.claude', 'memory'));
    });
  });

  describe('getCoordinationDir() with worktree path', () => {
    it('returns coordination path under worktree directory', () => {
      const worktreePath = '/tmp/orchestkit-worktree-feature-branch';
      setEnv({ CLAUDE_PROJECT_DIR: worktreePath });

      expect(getCoordinationDir()).toBe(path.join(worktreePath, '.claude', 'coordination'));
    });
  });

  // -----------------------------------------------------------------------
  // Phase 2: plugin root resolution in worktrees
  // -----------------------------------------------------------------------

  describe('getPluginRoot() with separate plugin root', () => {
    it('returns CLAUDE_PLUGIN_ROOT when both vars are set', () => {
      const worktreePath = '/tmp/orchestkit-worktree-feature-branch';
      const pluginRoot = '/Users/testuser/coding/orchestkit';
      setEnv({ CLAUDE_PROJECT_DIR: worktreePath, CLAUDE_PLUGIN_ROOT: pluginRoot });

      expect(getPluginRoot()).toBe(pluginRoot);
    });

    it('falls back to CLAUDE_PROJECT_DIR when CLAUDE_PLUGIN_ROOT is not set', () => {
      const worktreePath = '/tmp/orchestkit-worktree-feature-branch';
      setEnv({ CLAUDE_PROJECT_DIR: worktreePath, CLAUDE_PLUGIN_ROOT: undefined });

      expect(getPluginRoot()).toBe(worktreePath);
    });

    it('falls back to "." when neither env var is set', () => {
      setEnv({ CLAUDE_PROJECT_DIR: undefined, CLAUDE_PLUGIN_ROOT: undefined });

      expect(getPluginRoot()).toBe('.');
    });
  });

  describe('getLogDir() uses ork log dir when CLAUDE_PLUGIN_ROOT is set', () => {
    it('is under home/.claude/logs/ork regardless of worktree project dir', () => {
      const worktree1 = '/tmp/orchestkit-worktree-feat-a';
      const worktree2 = '/tmp/orchestkit-worktree-feat-b';
      const pluginRoot = '/Users/testuser/coding/orchestkit';

      setEnv({ CLAUDE_PROJECT_DIR: worktree1, CLAUDE_PLUGIN_ROOT: pluginRoot });
      const logDir1 = getLogDir();

      setEnv({ CLAUDE_PROJECT_DIR: worktree2, CLAUDE_PLUGIN_ROOT: pluginRoot });
      const logDir2 = getLogDir();

      // Both worktrees should log to the same ork log dir
      expect(logDir1).toBe(logDir2);
      expect(logDir1).toContain(path.join('.claude', 'logs', 'ork'));
    });
  });

  // -----------------------------------------------------------------------
  // Phase 3: temp file isolation between worktrees
  // -----------------------------------------------------------------------

  describe('getMetricsFile() does not depend on project dir', () => {
    it('returns temp-based path when CLAUDE_METRICS_FILE is not set', () => {
      setEnv({ CLAUDE_PROJECT_DIR: '/tmp/worktree-a', CLAUDE_METRICS_FILE: undefined });
      const file1 = getMetricsFile();

      setEnv({ CLAUDE_PROJECT_DIR: '/tmp/worktree-b', CLAUDE_METRICS_FILE: undefined });
      const file2 = getMetricsFile();

      // Metrics file should not change when only project dir changes
      expect(file1).toBe(file2);
      // Should be in system temp dir
      expect(file1).toContain(os.tmpdir().split('/').pop() ?? 'tmp');
    });

    it('returns CLAUDE_METRICS_FILE env var when set', () => {
      const customPath = '/custom/metrics.json';
      setEnv({ CLAUDE_METRICS_FILE: customPath });

      expect(getMetricsFile()).toBe(customPath);
    });
  });

  describe('getSessionTempDir() is session-scoped, not project-scoped', () => {
    it('same session ID yields same temp dir regardless of project dir', () => {
      const sessionId = 'abc-123-session';

      setEnv({ CLAUDE_PROJECT_DIR: '/tmp/worktree-a' });
      const dir1 = getSessionTempDir(sessionId);

      setEnv({ CLAUDE_PROJECT_DIR: '/tmp/worktree-b' });
      const dir2 = getSessionTempDir(sessionId);

      expect(dir1).toBe(dir2);
      expect(dir1).toContain(sessionId);
    });

    it('different session IDs yield different temp dirs', () => {
      setEnv({ CLAUDE_PROJECT_DIR: '/tmp/worktree-a' });

      const dir1 = getSessionTempDir('session-001');
      const dir2 = getSessionTempDir('session-002');

      expect(dir1).not.toBe(dir2);
    });

    it('uses system temp dir, not project dir', () => {
      const worktreePath = '/tmp/orchestkit-worktree-feature-branch';
      setEnv({ CLAUDE_PROJECT_DIR: worktreePath });

      const tempDir = getSessionTempDir('test-session');

      // Should NOT contain the worktree path
      expect(tempDir).not.toContain(worktreePath);
      // Should be inside os.tmpdir()
      expect(path.isAbsolute(tempDir)).toBe(true);
    });
  });
});
