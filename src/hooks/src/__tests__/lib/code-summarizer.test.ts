// Generated by OrchestKit Claude Plugin
// Created: 2026-02-10

import { describe, it, expect } from 'vitest';
import { isSummarizable, summarizeCode } from '../../lib/code-summarizer.js';

// ---------------------------------------------------------------------------
// isSummarizable
// ---------------------------------------------------------------------------

describe('isSummarizable', () => {
  it('returns true for supported extensions', () => {
    for (const ext of ['.ts', '.tsx', '.js', '.jsx', '.mjs', '.py', '.go', '.rs', '.sh', '.bash', '.md']) {
      expect(isSummarizable(ext)).toBe(true);
    }
  });

  it('returns false for unsupported extensions', () => {
    for (const ext of ['.css', '.html', '.json', '.yaml', '.toml', '.txt', '.png']) {
      expect(isSummarizable(ext)).toBe(false);
    }
  });
});

// ---------------------------------------------------------------------------
// TypeScript extraction
// ---------------------------------------------------------------------------

describe('summarizeCode — TypeScript', () => {
  const tsContent = `
import { Request, Response } from 'express';
import path from 'node:path';

export interface AuthConfig {
  secret: string;
  ttl: number;
}

export type UserId = string;

export abstract class BaseService {
  abstract handle(): void;
}

export class AuthService extends BaseService {
  handle(): void {}
}

export async function handleRequest(req: Request): Promise<Response> {
  return {} as Response;
}

function privateHelper(x: number): number {
  return x * 2;
}

export const validateInput = (input: string): boolean => {
  return input.length > 0;
};

export const asyncOp = async (id: string): Promise<void> => {
  await Promise.resolve();
};

export { handleRequest, validateInput };
`.trim();

  it('extracts imports', () => {
    const result = summarizeCode(tsContent, 'src/auth/service.ts')!;
    expect(result).toContain('Imports (2)');
    expect(result).toContain("import { Request, Response } from 'express'");
  });

  it('extracts functions including async and arrow', () => {
    const result = summarizeCode(tsContent, 'src/auth/service.ts')!;
    expect(result).toContain('Functions');
    expect(result).toContain('handleRequest');
    expect(result).toContain('privateHelper');
    expect(result).toContain('validateInput');
    expect(result).toContain('asyncOp');
  });

  it('extracts classes', () => {
    const result = summarizeCode(tsContent, 'src/auth/service.ts')!;
    expect(result).toContain('Classes (2)');
    expect(result).toContain('abstract class BaseService');
    expect(result).toContain('class AuthService extends BaseService');
  });

  it('extracts interfaces and types', () => {
    const result = summarizeCode(tsContent, 'src/auth/service.ts')!;
    expect(result).toContain('Types');
    expect(result).toContain('interface AuthConfig');
    expect(result).toContain('type UserId');
  });

  it('extracts exports', () => {
    const result = summarizeCode(tsContent, 'src/auth/service.ts')!;
    expect(result).toContain('Exports');
    expect(result).toContain('export { handleRequest, validateInput }');
  });

  it('includes TLDR header with path and line count', () => {
    const result = summarizeCode(tsContent, 'src/auth/service.ts')!;
    expect(result).toMatch(/^\[TLDR\] src\/auth\/service\.ts/);
    expect(result).toMatch(/\d+ lines/);
    expect(result).toMatch(/~\d+ tokens/);
    expect(result).toContain('TypeScript');
  });
});

// ---------------------------------------------------------------------------
// Python extraction
// ---------------------------------------------------------------------------

describe('summarizeCode — Python', () => {
  const pyContent = `
from fastapi import FastAPI
import os

class UserService:
    def get_user(self, user_id: str) -> dict:
        pass

    def create_user(self, data: dict) -> dict:
        pass

@router.get("/users")
async def list_users() -> list:
    pass

def helper_fn(x: int) -> int:
    return x * 2
`.trim();

  it('extracts imports', () => {
    const result = summarizeCode(pyContent, 'app/service.py')!;
    expect(result).toContain('Imports (2)');
    expect(result).toContain('from fastapi import FastAPI');
  });

  it('extracts top-level functions with decorators', () => {
    const result = summarizeCode(pyContent, 'app/service.py')!;
    expect(result).toContain('list_users');
    expect(result).toContain('@router.get');
    expect(result).toContain('helper_fn');
  });

  it('extracts classes', () => {
    const result = summarizeCode(pyContent, 'app/service.py')!;
    expect(result).toContain('Classes');
    expect(result).toContain('class UserService');
  });
});

// ---------------------------------------------------------------------------
// Go extraction
// ---------------------------------------------------------------------------

describe('summarizeCode — Go', () => {
  const goContent = `
package main

import (
	"fmt"
	"net/http"
)

type Server struct {
	port int
}

type Handler interface {
	Handle(w http.ResponseWriter, r *http.Request)
}

func (s *Server) Start() error {
	return nil
}

func NewServer(port int) *Server {
	return &Server{port: port}
}
`.trim();

  it('extracts import blocks', () => {
    const result = summarizeCode(goContent, 'main.go')!;
    expect(result).toContain('Imports (2)');
  });

  it('extracts functions with receivers', () => {
    const result = summarizeCode(goContent, 'main.go')!;
    expect(result).toContain('Functions (2)');
    expect(result).toContain('func (s *Server) Start() error');
    expect(result).toContain('func NewServer(port int) *Server');
  });

  it('extracts type definitions', () => {
    const result = summarizeCode(goContent, 'main.go')!;
    expect(result).toContain('Types (2)');
    expect(result).toContain('type Server struct');
    expect(result).toContain('type Handler interface');
  });
});

// ---------------------------------------------------------------------------
// Rust extraction
// ---------------------------------------------------------------------------

describe('summarizeCode — Rust', () => {
  const rsContent = `
use std::collections::HashMap;
use tokio::sync::Mutex;

pub struct Config {
    pub name: String,
}

pub enum Status {
    Active,
    Inactive,
}

pub trait Handler {
    fn handle(&self) -> Result<(), Error>;
}

impl Handler for Config {
    fn handle(&self) -> Result<(), Error> {
        Ok(())
    }
}

pub async fn serve(port: u16) -> Result<(), Error> {
    Ok(())
}

fn internal_helper(x: i32) -> i32 {
    x * 2
}
`.trim();

  it('extracts use statements', () => {
    const result = summarizeCode(rsContent, 'src/main.rs')!;
    expect(result).toContain('Imports (2)');
    expect(result).toContain('use std::collections::HashMap');
  });

  it('extracts functions', () => {
    const result = summarizeCode(rsContent, 'src/main.rs')!;
    expect(result).toContain('pub async fn serve(port: u16) -> Result<(), Error>');
    expect(result).toContain('fn internal_helper(x: i32) -> i32');
  });

  it('extracts structs, enums, traits, impl', () => {
    const result = summarizeCode(rsContent, 'src/main.rs')!;
    expect(result).toContain('Types');
    expect(result).toContain('pub struct Config');
    expect(result).toContain('pub enum Status');
    expect(result).toContain('pub trait Handler');
    expect(result).toContain('impl Handler for Config');
  });
});

// ---------------------------------------------------------------------------
// Shell extraction
// ---------------------------------------------------------------------------

describe('summarizeCode — Shell', () => {
  const shContent = `
#!/bin/bash
MAX_RETRIES=5
LOG_DIR="/var/log/app"
OUTPUT_FILE="result.txt"

setup() {
  mkdir -p "$LOG_DIR"
}

function cleanup {
  rm -f "$OUTPUT_FILE"
}

main() {
  setup
  cleanup
}
`.trim();

  it('extracts functions', () => {
    const result = summarizeCode(shContent, 'deploy.sh')!;
    expect(result).toContain('Functions');
    expect(result).toContain('setup');
    expect(result).toContain('cleanup');
    expect(result).toContain('main');
  });

  it('extracts uppercase variables', () => {
    const result = summarizeCode(shContent, 'deploy.sh')!;
    expect(result).toContain('Variables');
    expect(result).toContain('MAX_RETRIES');
    expect(result).toContain('LOG_DIR');
    expect(result).toContain('OUTPUT_FILE');
  });
});

// ---------------------------------------------------------------------------
// Markdown extraction
// ---------------------------------------------------------------------------

describe('summarizeCode — Markdown', () => {
  const mdContent = `
# Project Title

## Getting Started

### Prerequisites

## Installation

### Step 1

### Step 2

## Usage

#### Deep header (h4 - ignored)
`.trim();

  it('extracts h1-h3 sections', () => {
    const result = summarizeCode(mdContent, 'README.md')!;
    expect(result).toContain('Sections');
    expect(result).toContain('# Project Title');
    expect(result).toContain('## Getting Started');
    expect(result).toContain('### Prerequisites');
    expect(result).toContain('## Installation');
    expect(result).toContain('## Usage');
  });

  it('ignores h4+ headers', () => {
    const result = summarizeCode(mdContent, 'README.md')!;
    expect(result).not.toContain('Deep header');
  });
});

// ---------------------------------------------------------------------------
// Edge cases
// ---------------------------------------------------------------------------

describe('summarizeCode — edge cases', () => {
  it('returns null for unsupported extension', () => {
    expect(summarizeCode('body { color: red; }', 'style.css')).toBeNull();
  });

  it('returns null for files with no extension', () => {
    expect(summarizeCode('some content', 'Makefile')).toBeNull();
  });

  it('returns null for empty content', () => {
    expect(summarizeCode('', 'empty.ts')).toBeNull();
  });

  it('respects token budget (~1400 chars max)', () => {
    // Create a file with many imports to trigger truncation
    const manyImports = Array.from({ length: 100 }, (_, i) =>
      `import { Module${i} } from '@very-long-package-name/submodule-${i}/deep/path';`
    ).join('\n');
    const content = `${manyImports}\n\nexport function main() {}\n`;
    const result = summarizeCode(content, 'big.ts')!;
    expect(result.length).toBeLessThanOrEqual(1600); // header + budget + small margin
  });
});
