// Generated by OrchestKit Claude Plugin
// Created: 2026-02-19

/**
 * Tests for CC Version Compatibility Matrix utilities
 */

import { describe, test, expect } from 'vitest';
import {
  MIN_CC_VERSION,
  CC_FEATURE_MATRIX,
  compareCCVersions,
  getAvailableFeatures,
  getMissingFeatures,
  hasFeature,
} from '../../lib/cc-version-matrix.js';

describe('cc-version-matrix', () => {
  describe('MIN_CC_VERSION', () => {
    test('is 2.1.47', () => {
      expect(MIN_CC_VERSION).toBe('2.1.47');
    });
  });

  describe('CC_FEATURE_MATRIX', () => {
    test('contains expected number of features', () => {
      expect(CC_FEATURE_MATRIX.length).toBeGreaterThanOrEqual(15);
    });

    test('is sorted by version ascending', () => {
      for (let i = 1; i < CC_FEATURE_MATRIX.length; i++) {
        const cmp = compareCCVersions(
          CC_FEATURE_MATRIX[i - 1].minVersion,
          CC_FEATURE_MATRIX[i].minVersion,
        );
        expect(cmp).toBeLessThanOrEqual(0);
      }
    });

    test('all entries have required fields', () => {
      for (const entry of CC_FEATURE_MATRIX) {
        expect(entry.feature).toBeTruthy();
        expect(entry.minVersion).toMatch(/^\d+\.\d+\.\d+$/);
        expect(entry.description).toBeTruthy();
      }
    });
  });

  describe('compareCCVersions', () => {
    test('equal versions return 0', () => {
      expect(compareCCVersions('2.1.47', '2.1.47')).toBe(0);
    });

    test('greater version returns 1', () => {
      expect(compareCCVersions('2.1.48', '2.1.47')).toBe(1);
    });

    test('lesser version returns -1', () => {
      expect(compareCCVersions('2.1.46', '2.1.47')).toBe(-1);
    });

    test('handles major version differences', () => {
      expect(compareCCVersions('3.0.0', '2.1.47')).toBe(1);
      expect(compareCCVersions('1.0.0', '2.1.47')).toBe(-1);
    });

    test('handles minor version differences', () => {
      expect(compareCCVersions('2.2.0', '2.1.47')).toBe(1);
      expect(compareCCVersions('2.0.99', '2.1.0')).toBe(-1);
    });
  });

  describe('getAvailableFeatures', () => {
    test('all features available at latest version', () => {
      const features = getAvailableFeatures('2.1.50');
      expect(features.length).toBe(CC_FEATURE_MATRIX.length);
    });

    test('2.1.47 has all features up to 2.1.47', () => {
      const features = getAvailableFeatures('2.1.47');
      expect(features.every(f => compareCCVersions(f.minVersion, '2.1.47') <= 0)).toBe(true);
      expect(features.length).toBeGreaterThan(0);
      expect(features.length).toBeLessThan(CC_FEATURE_MATRIX.length);
    });

    test('no features available at 2.0.0', () => {
      const features = getAvailableFeatures('2.0.0');
      expect(features.length).toBe(0);
    });

    test('partial features at 2.1.9', () => {
      const features = getAvailableFeatures('2.1.9');
      expect(features.length).toBeGreaterThan(0);
      expect(features.length).toBeLessThan(CC_FEATURE_MATRIX.length);
      expect(features.some(f => f.feature === 'session_id_guaranteed')).toBe(true);
      expect(features.some(f => f.feature === 'last_assistant_message')).toBe(false);
    });
  });

  describe('getMissingFeatures', () => {
    test('no missing features at 2.1.50', () => {
      const missing = getMissingFeatures('2.1.50');
      expect(missing.length).toBe(0);
    });

    test('2.1.47 missing 2.1.49+ features', () => {
      const missing = getMissingFeatures('2.1.47');
      expect(missing.length).toBeGreaterThan(0);
      expect(missing.every(f => compareCCVersions(f.minVersion, '2.1.47') > 0)).toBe(true);
    });

    test('all missing at 2.0.0', () => {
      const missing = getMissingFeatures('2.0.0');
      expect(missing.length).toBe(CC_FEATURE_MATRIX.length);
    });

    test('2.1.45 missing 2.1.47+ features', () => {
      const missing = getMissingFeatures('2.1.45');
      expect(missing.every(f => compareCCVersions(f.minVersion, '2.1.45') > 0)).toBe(true);
      expect(missing.some(f => f.minVersion === '2.1.47')).toBe(true);
      expect(missing.some(f => f.minVersion === '2.1.50')).toBe(true);
    });
  });

  describe('hasFeature', () => {
    test('session_id available at 2.1.9', () => {
      expect(hasFeature('2.1.9', 'session_id_guaranteed')).toBe(true);
    });

    test('last_assistant_message not available at 2.1.46', () => {
      expect(hasFeature('2.1.46', 'last_assistant_message')).toBe(false);
    });

    test('last_assistant_message available at 2.1.47', () => {
      expect(hasFeature('2.1.47', 'last_assistant_message')).toBe(true);
    });

    test('returns false for unknown feature', () => {
      expect(hasFeature('2.1.47', 'nonexistent_feature' as any)).toBe(false);
    });
  });
});
