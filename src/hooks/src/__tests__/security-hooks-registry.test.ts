// Generated by OrchestKit Claude Plugin
// Created: 2026-02-20

/**
 * Security Hooks Registry Tests
 *
 * Validates that:
 * 1. All 6 security-critical hooks are registered
 * 2. isSecurityCritical correctly identifies security hooks
 * 3. assertCanToggle throws for security hooks
 * 4. Non-security hooks can be toggled
 */

import { describe, test, expect } from 'vitest';
import {
  SECURITY_HOOKS,
  isSecurityCritical,
  assertCanToggle,
} from '../lib/security-hooks-registry.js';

describe('SECURITY_HOOKS registry', () => {
  test('contains exactly 6 security-critical hooks', () => {
    expect(SECURITY_HOOKS.size).toBe(6);
  });

  test('contains all expected security hooks', () => {
    const expected = [
      'dangerous-command-blocker',
      'file-guard',
      'auto-approve-safe-bash',
      'redact-secrets',
      'git-validator',
      'security-command-audit',
    ];
    for (const hook of expected) {
      expect(SECURITY_HOOKS.has(hook)).toBe(true);
    }
  });

  test('is immutable (ReadonlySet)', () => {
    // TypeScript enforces this at compile time, but verify at runtime
    // that the Set contents are correct after any mutation attempts
    expect(SECURITY_HOOKS.size).toBe(6);
  });
});

describe('isSecurityCritical', () => {
  test('returns true for each security hook', () => {
    expect(isSecurityCritical('dangerous-command-blocker')).toBe(true);
    expect(isSecurityCritical('file-guard')).toBe(true);
    expect(isSecurityCritical('auto-approve-safe-bash')).toBe(true);
    expect(isSecurityCritical('redact-secrets')).toBe(true);
    expect(isSecurityCritical('git-validator')).toBe(true);
    expect(isSecurityCritical('security-command-audit')).toBe(true);
  });

  test('returns false for non-security hooks', () => {
    expect(isSecurityCritical('unified-advisory-dispatcher')).toBe(false);
    expect(isSecurityCritical('skill-tracker')).toBe(false);
    expect(isSecurityCritical('session-metrics')).toBe(false);
    expect(isSecurityCritical('')).toBe(false);
  });
});

describe('assertCanToggle', () => {
  test('throws for security hooks', () => {
    expect(() => assertCanToggle('dangerous-command-blocker')).toThrow(
      'Cannot disable security-critical hook'
    );
    expect(() => assertCanToggle('file-guard')).toThrow(
      'Cannot disable security-critical hook'
    );
  });

  test('does not throw for non-security hooks', () => {
    expect(() => assertCanToggle('unified-advisory-dispatcher')).not.toThrow();
    expect(() => assertCanToggle('skill-tracker')).not.toThrow();
    expect(() => assertCanToggle('session-metrics')).not.toThrow();
  });

  test('error message lists all security hooks', () => {
    try {
      assertCanToggle('dangerous-command-blocker');
    } catch (e) {
      const message = (e as Error).message;
      expect(message).toContain('dangerous-command-blocker');
      expect(message).toContain('file-guard');
      expect(message).toContain('auto-approve-safe-bash');
      expect(message).toContain('redact-secrets');
      expect(message).toContain('git-validator');
      expect(message).toContain('security-command-audit');
    }
  });
});
