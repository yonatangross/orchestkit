// Generated by OrchestKit Claude Plugin
// Created: 2026-02-09

/**
 * Cross-Project Analytics — User-Scoped JSONL
 *
 * Writes local-only analytics to ~/.claude/analytics/.
 * Privacy-by-design: no PII, no prompts, no code, no raw paths.
 * Project paths are hashed (12-char SHA256) for irreversible anonymity.
 *
 * Issue #459: Local Cross-Project Analytics System
 */

import { mkdirSync, statSync, renameSync } from 'node:fs';
import { bufferWrite } from './analytics-buffer.js';
import { createHash } from 'node:crypto';
import { getHomeDir, joinPath } from './paths.js';

function getAnalyticsDir(): string {
  return joinPath(getHomeDir(), '.claude', 'analytics');
}

/** Hash project path for privacy — irreversible, 12-char hex */
export function hashProject(projectDir: string): string {
  return createHash('sha256').update(projectDir).digest('hex').slice(0, 12);
}

/** Extract team context from env vars. Returns undefined when not in a team. */
export function getTeamContext(): { team: string } | undefined {
  const team = process.env.CLAUDE_CODE_TEAM_NAME;
  return team ? { team } : undefined;
}

/** Rotate file if it exceeds maxBytes (default 10MB). Renames to <name>.<YYYY-MM>.jsonl */
export function rotateIfNeeded(filePath: string, maxBytes = 10_485_760): void {
  try {
    const stats = statSync(filePath);
    if (stats.size > maxBytes) {
      const month = new Date().toISOString().slice(0, 7); // YYYY-MM
      const rotated = filePath.replace(/\.jsonl$/, `.${month}.jsonl`);
      renameSync(filePath, rotated);
    }
  } catch {
    // File doesn't exist or rename failed — both fine
  }
}

/** Returns true when running inside a test runner (vitest / jest). */
export function isTestEnv(): boolean {
  return !!(process.env.VITEST || process.env.JEST_WORKER_ID);
}

/** Append a JSONL entry to ~/.claude/analytics/<file>. Fire-and-forget. */
export function appendAnalytics(file: string, entry: Record<string, unknown>): void {
  if (isTestEnv()) return;
  try {
    const dir = getAnalyticsDir();
    mkdirSync(dir, { recursive: true });
    const filePath = joinPath(dir, file);
    rotateIfNeeded(filePath);
    bufferWrite(filePath, JSON.stringify(entry) + '\n');
  } catch {
    // Never block hooks
  }
}
