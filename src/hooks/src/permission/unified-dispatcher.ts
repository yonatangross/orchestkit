// Generated by OrchestKit Claude Plugin
// Created: 2026-02-20

/**
 * Unified PermissionRequest/Bash Dispatcher
 * Consolidates 2 PermissionRequest hooks for Bash into a single process spawn.
 *
 * Issue #683: Reduces 2 process spawns to 1 for PermissionRequest/Bash.
 *
 * Hooks consolidated (execution order):
 * 1. auto-approve-safe-bash — checks known-safe patterns, returns 'allow' or passthrough
 * 2. learning-tracker — checks learned patterns, returns 'allow' or passthrough
 *
 * Logic: If auto-approve-safe-bash returns an allow decision, skip learning-tracker.
 * If it passes through, try learning-tracker. If neither approves, pass through to user.
 *
 * CC 2.1.49 Compliant: includes continue field and permissionDecision in all outputs
 */

import type { HookInput, HookResult } from '../types.js';
import { outputSilentSuccess, logHook } from '../lib/common.js';
import { autoApproveSafeBash } from './auto-approve-safe-bash.js';
import { learningTracker } from './learning-tracker.js';

const HOOK_NAME = 'permission-bash-dispatcher';

/** Exposed for testing */
export const registeredHookNames = () => [
  'auto-approve-safe-bash',
  'learning-tracker',
];

/**
 * Unified PermissionRequest dispatcher for Bash commands.
 * Runs safe-bash check first, falls back to learned patterns.
 */
export function unifiedPermissionBashDispatcher(input: HookInput): HookResult {
  // --- Step 1: Check known-safe patterns ---
  try {
    const safeResult = autoApproveSafeBash(input);

    // If auto-approve returned an 'allow' decision, use it immediately
    if (safeResult.hookSpecificOutput?.permissionDecision === 'allow') {
      logHook(HOOK_NAME, 'auto-approve-safe-bash: allowed');
      return safeResult;
    }
  } catch (error) {
    const message = error instanceof Error ? error.message : String(error);
    logHook(HOOK_NAME, `auto-approve-safe-bash failed: ${message}`, 'warn');
  }

  // --- Step 2: Check learned patterns ---
  try {
    const learnedResult = learningTracker(input);

    // If learning-tracker returned an 'allow' decision, use it
    if (learnedResult.hookSpecificOutput?.permissionDecision === 'allow') {
      logHook(HOOK_NAME, 'learning-tracker: allowed via learned pattern');
      return learnedResult;
    }
  } catch (error) {
    const message = error instanceof Error ? error.message : String(error);
    logHook(HOOK_NAME, `learning-tracker failed: ${message}`, 'warn');
  }

  // --- Neither approved — pass through to user ---
  return outputSilentSuccess();
}
