// Generated by OrchestKit Claude Plugin
// Created: 2026-02-15

/**
 * Issue Context Injector - SubagentStart Hook
 * CC 2.1.7 Compliant: includes continue field in all outputs
 *
 * When on an issue branch (e.g., issue/123-add-auth), injects the GitHub
 * issue details into the subagent's context so it references the issue
 * in commits and PR descriptions.
 *
 * Graceful degradation: if gh fails, branch doesn't match, or anything
 * goes wrong, returns silent success. Never blocks agent spawning.
 *
 * Version: 1.0.0
 */

import { existsSync, readFileSync, writeFileSync, statSync, mkdirSync } from 'node:fs';
import { execFileSync } from 'node:child_process';
import { tmpdir } from 'node:os';
import { join } from 'node:path';
import type { HookInput, HookResult } from '../types.js';
import { outputSilentSuccess, logHook, getProjectDir, getCachedBranch } from '../lib/common.js';

/** Dedicated cache directory with restricted permissions */
const CACHE_DIR = join(tmpdir(), 'orchestkit-issue-cache');

/** Cache TTL in milliseconds (5 minutes) */
const CACHE_TTL_MS = 5 * 60 * 1000;

/** Timeout for gh CLI in milliseconds */
const GH_TIMEOUT_MS = 3000;

interface IssueData {
  title?: string;
  body?: string;
  labels?: Array<{ name: string }>;
}

/**
 * Extract issue number from branch name.
 * Matches patterns like: issue/123-foo, fix/456-bar, feat/789-baz,
 * bug/10-thing, hotfix/11-thing, or just 123-some-description.
 */
function extractIssueNumber(branch: string): string | null {
  const match = branch.match(/^(?:issue|fix|feat|bug|hotfix|feature)\/(\d+)/) ||
    branch.match(/^(\d+)-/);
  return match ? match[1] : null;
}

/**
 * Get cached issue data if fresh enough.
 */
function ensureCacheDir(): void {
  try {
    mkdirSync(CACHE_DIR, { recursive: true, mode: 0o700 });
  } catch {
    // Directory may already exist
  }
}

function getCachedIssue(issueNum: string): IssueData | null {
  const cachePath = join(CACHE_DIR, `${issueNum}.json`);
  try {
    if (!existsSync(cachePath)) return null;
    const stats = statSync(cachePath);
    const ageMs = Date.now() - stats.mtimeMs;
    if (ageMs > CACHE_TTL_MS) return null;
    return JSON.parse(readFileSync(cachePath, 'utf8'));
  } catch {
    return null;
  }
}

/**
 * Fetch issue data from GitHub CLI and cache it.
 */
function fetchAndCacheIssue(issueNum: string, projectDir: string): IssueData | null {
  // Defense-in-depth: validate issue number is purely numeric
  if (!/^\d+$/.test(issueNum)) return null;

  try {
    const output = execFileSync(
      'gh',
      ['issue', 'view', issueNum, '--json', 'title,body,labels'],
      {
        cwd: projectDir,
        encoding: 'utf8',
        timeout: GH_TIMEOUT_MS,
        stdio: ['pipe', 'pipe', 'pipe'],
      }
    ).trim();

    const data: IssueData = JSON.parse(output);
    try {
      ensureCacheDir();
      const cachePath = join(CACHE_DIR, `${issueNum}.json`);
      writeFileSync(cachePath, JSON.stringify(data), 'utf8');
    } catch {
      // Cache write failure is non-critical
    }
    return data;
  } catch {
    return null;
  }
}

/**
 * Build context message from issue data.
 */
function buildContextMessage(issueNum: string, issue: IssueData | null): string {
  const parts: string[] = [];

  if (issue?.title) {
    parts.push(`Working on GitHub Issue #${issueNum}: ${issue.title}`);
  } else {
    parts.push(`Working on GitHub Issue #${issueNum}`);
  }

  if (issue?.labels && issue.labels.length > 0) {
    const labelNames = issue.labels.map((l) => l.name).join(', ');
    parts.push(`Labels: ${labelNames}`);
  }

  parts.push(`Reference #${issueNum} in all commits. Use 'Closes #${issueNum}' in PR description.`);

  return parts.join('\n');
}

export function issueContextInjector(_input: HookInput): HookResult {
  try {
    const projectDir = getProjectDir();
    const branch = getCachedBranch(projectDir);

    logHook('issue-context-injector', `Branch: ${branch}`);

    const issueNum = extractIssueNumber(branch);
    if (!issueNum) {
      logHook('issue-context-injector', 'No issue number in branch name');
      return outputSilentSuccess();
    }

    logHook('issue-context-injector', `Detected issue #${issueNum}`);

    // Try cache first, then fetch from gh
    const issue = getCachedIssue(issueNum) ?? fetchAndCacheIssue(issueNum, projectDir);
    const contextMsg = buildContextMessage(issueNum, issue);

    logHook('issue-context-injector', `Injecting context for issue #${issueNum}`);

    return {
      continue: true,
      systemMessage: contextMsg,
    };
  } catch {
    logHook('issue-context-injector', 'Unexpected error, falling back to silent success', 'warn');
    return outputSilentSuccess();
  }
}
