// Generated by OrchestKit Claude Plugin
// Created: 2026-02-06

/**
 * TaskCompleted Hook: Completion Tracker
 *
 * CC 2.1.33 TaskCompleted event fires when a task completes.
 * Logs completion metrics and suggests follow-up verification.
 *
 * @hook TaskCompleted
 * @since CC 2.1.33
 */

import { HookInput, HookResult } from '../types.js';
import { getProjectDir } from '../lib/common.js';
import { writeFileSync, mkdirSync, existsSync } from 'fs';
import { join } from 'path';

export async function completionTracker(input: HookInput): Promise<HookResult> {
  const projectDir = getProjectDir();
  if (!projectDir) {
    return { continue: true };
  }

  const taskId = input.task_id || 'unknown';
  const taskSubject = input.task_subject || '';
  const taskStatus = input.task_status || 'completed';
  const duration = input.duration_ms || 0;

  // Log completion for workflow analytics
  const logsDir = join(projectDir, '.claude', 'logs');
  if (!existsSync(logsDir)) {
    mkdirSync(logsDir, { recursive: true });
  }

  const entry = {
    timestamp: new Date().toISOString(),
    event: 'task_completed',
    task_id: taskId,
    task_subject: taskSubject,
    task_status: taskStatus,
    duration_ms: duration,
    session_id: input.session_id,
  };

  try {
    const logPath = join(logsDir, 'task-completions.jsonl');
    writeFileSync(logPath, JSON.stringify(entry) + '\n', { flag: 'a' });
  } catch {
    // Non-critical logging â€” don't block
  }

  // Suggest verification for implementation tasks
  const isImplementation = /implement|create|add|fix|build|refactor/i.test(taskSubject);
  if (isImplementation && taskStatus === 'completed') {
    return {
      continue: true,
      hookSpecificOutput: {
        additionalContext: `Task "${taskSubject}" completed (${Math.round(duration / 1000)}s). Consider running tests to verify.`,
      },
    };
  }

  return { continue: true };
}
