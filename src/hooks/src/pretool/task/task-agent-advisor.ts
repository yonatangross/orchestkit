// Generated by OrchestKit Claude Plugin
// Created: 2026-02-18

/**
 * Task Agent Advisor — PreToolUse[Task] Hook
 *
 * Suggests curated ork agents when ad-hoc subagent_type names are used.
 * Analytics shows 250+ ad-hoc names being spawned instead of curated agents.
 * This hook nudges users toward the right agent via additionalContext.
 *
 * Non-blocking: always returns "continue".
 *
 * @hook PreToolUse[Task]
 * @see https://github.com/yonatangross/orchestkit/issues/706
 */

import type { HookInput, HookResult } from '../../types.js';
import { outputSilentSuccess, outputAllowWithContext, logHook } from '../../lib/common.js';

const HOOK_NAME = 'task-agent-advisor';

/**
 * Maps common ad-hoc subagent names to curated ork agents.
 * Keys are lowercase for case-insensitive matching.
 */
/**
 * Ad-hoc names that should be replaced with curated ork agents.
 */
const ORK_AGENT_SYNONYMS: Record<string, string> = {
  'frontend-dev': 'ork:frontend-ui-developer',
  'frontend-engineer': 'ork:frontend-ui-developer',
  'frontend-fixer': 'ork:frontend-ui-developer',
  'frontend-eng': 'ork:frontend-ui-developer',
  'backend-dev': 'ork:backend-system-architect',
  'backend-engineer': 'ork:backend-system-architect',
  'backend-fixer': 'ork:backend-system-architect',
  'backend-eng': 'ork:backend-system-architect',
  'security-fixer': 'ork:security-auditor',
  'security-engineer': 'ork:security-auditor',
  'code-reviewer': 'ork:code-quality-reviewer',
  'quality-reviewer': 'ork:code-quality-reviewer',
  'test-writer': 'ork:test-generator',
  'unit-tester': 'ork:test-generator',
};

/**
 * Wrong-cased built-in names that should use the correct casing.
 * These are valid built-ins — not ork agents — just mis-cased.
 */
const BUILTIN_CASING_FIXES: Record<string, string> = {
  'explore': 'Explore',
  'explorer': 'Explore',
  'explore-agent': 'Explore',
  'generalpurpose': 'general-purpose',
};

/** Built-in names that are already correct (exact casing per CC Feb 2026 spec) — never suggest replacing these. */
const VALID_BUILTINS = new Set(['Explore', 'Plan', 'general-purpose', 'Bash', 'statusline-setup']);

export function taskAgentAdvisor(input: HookInput): HookResult {
  const toolInput = input.tool_input || {};
  const agentType = (toolInput.subagent_type as string) || '';

  if (!agentType) {
    return outputSilentSuccess();
  }

  const normalizedName = agentType.toLowerCase().trim();

  // Skip already-correct built-in names
  if (VALID_BUILTINS.has(agentType)) {
    return outputSilentSuccess();
  }

  // Check ork agent synonyms first
  const orkSuggestion = ORK_AGENT_SYNONYMS[normalizedName];
  if (orkSuggestion) {
    logHook(HOOK_NAME, `Suggesting "${orkSuggestion}" instead of ad-hoc "${agentType}"`);
    return outputAllowWithContext(
      `Consider using \`${orkSuggestion}\` instead of \`${agentType}\` — it includes a curated system prompt for this task type.`,
    );
  }

  // Check built-in casing fixes
  const casingFix = BUILTIN_CASING_FIXES[normalizedName];
  if (casingFix) {
    logHook(HOOK_NAME, `Casing fix: "${agentType}" -> "${casingFix}"`);
    return outputAllowWithContext(
      `\`${casingFix}\` (capital E) is the correct built-in name — lowercase \`${agentType}\` may not resolve correctly.`,
    );
  }

  return outputSilentSuccess();
}
