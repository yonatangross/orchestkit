// Generated by OrchestKit Claude Plugin
// Created: 2026-02-06

/**
 * Team Size Gate - PreToolUse[Task] Hook
 *
 * Enforces team size limits when spawning teammates via Agent Teams.
 * - Max 6 total team members (cost control)
 * - Max 3 Opus-model members (budget guard)
 * - Passthrough for non-team Task spawns (regular subagents)
 *
 * @hook PreToolUse[Task]
 * @since CC 2.1.33
 */

import type { HookInput, HookResult } from '../../types.js';
import { outputSilentSuccess, outputDeny, logHook } from '../../lib/common.js';
import { getTeamMembers } from '../../lib/agent-teams.js';

const MAX_TEAM_SIZE = 6;
const MAX_OPUS_MEMBERS = 3;

export function teamSizeGate(input: HookInput): HookResult {
  const toolInput = input.tool_input || {};

  // Only gate team spawns â€” regular Task subagents pass through
  const teamName = toolInput.team_name as string | undefined;
  if (!teamName) {
    return outputSilentSuccess();
  }

  const model = (toolInput.model as string) || '';
  const description = (toolInput.description as string) || '';

  // Read current team membership
  const members = getTeamMembers();
  const currentSize = members.length;

  logHook('team-size-gate', `Team "${teamName}": ${currentSize} members, spawning model="${model}"`);

  // Check total team size
  if (currentSize >= MAX_TEAM_SIZE) {
    logHook('team-size-gate', `BLOCKED: Team size limit (${currentSize} >= ${MAX_TEAM_SIZE})`);
    return outputDeny(
      `Team Size Limit\n\nTeam "${teamName}" has ${currentSize} members (max ${MAX_TEAM_SIZE}).\n\n` +
      `Wait for existing teammates to complete before spawning more.\n\n` +
      `Attempted: ${description}`,
    );
  }

  // Check Opus model count
  if (model === 'opus') {
    const opusCount = members.filter(
      (m) => m.agentType.toLowerCase().includes('opus'),
    ).length;

    if (opusCount >= MAX_OPUS_MEMBERS) {
      logHook('team-size-gate', `BLOCKED: Opus limit (${opusCount} >= ${MAX_OPUS_MEMBERS})`);
      return outputDeny(
        `Opus Model Limit\n\nTeam "${teamName}" already has ${opusCount} Opus members (max ${MAX_OPUS_MEMBERS}).\n\n` +
        `Use a lighter model (sonnet/haiku) or wait for Opus teammates to finish.\n\n` +
        `Attempted: ${description}`,
      );
    }
  }

  logHook('team-size-gate', `Team spawn allowed: ${currentSize + 1}/${MAX_TEAM_SIZE}`);
  return outputSilentSuccess();
}
