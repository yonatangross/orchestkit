// Generated by OrchestKit Claude Plugin
// Created: 2026-02-15

/**
 * Issue Reference Checker Hook
 * Reminds Claude to include issue number in commit messages when on an issue branch.
 * PreToolUse hook for Bash(git commit*) — soft advisory, never blocks.
 */

import type { HookInput, HookResult } from '../../types.js';
import {
  outputSilentSuccess,
  outputAllowWithContext,
  getCachedBranch,
} from '../../lib/common.js';

/**
 * Extract the commit message from a git commit command string.
 * Handles -m "msg", -m 'msg', and -m msg (unquoted single-word).
 */
function extractCommitMessage(command: string): string | null {
  // Match -m followed by a quoted or unquoted message
  // Handles: -m "msg", -m 'msg', -m msg
  const match = command.match(/-m\s+(?:"([^"\\]*(?:\\[\s\S][^"\\]*)*)"|'([^']*)'|(\S+))/);
  if (!match) return null;
  return match[1] ?? match[2] ?? match[3] ?? null;
}

/**
 * Extract issue number from a branch name.
 * Matches patterns like: issue/123-desc, fix/123-desc, feat/123, 123-desc, prefix/123
 */
function extractIssueNumber(branch: string): string | null {
  // Match a number after a slash or at the start, optionally followed by -description
  const match = branch.match(/(?:^|\/)(#?\d+)(?:-|$)/);
  if (!match) return null;
  // Strip leading # if present
  return match[1].replace(/^#/, '');
}

/**
 * Check if commit message references the issue number.
 * Matches #123 or bare 123.
 */
function messageReferencesIssue(message: string, issueNum: string): boolean {
  // Check for #123 or bare 123
  return message.includes(`#${issueNum}`) || message.includes(issueNum);
}

/**
 * Issue reference checker — reminds to include issue number in commit messages.
 */
export function issueReferenceChecker(input: HookInput): HookResult {
  try {
    const command = input.tool_input.command || '';
    if (!command) return outputSilentSuccess();

    // Extract commit message
    const commitMessage = extractCommitMessage(command);
    if (!commitMessage) return outputSilentSuccess();

    // Get current branch
    const branch = getCachedBranch();
    if (!branch || branch === 'unknown') return outputSilentSuccess();

    // Extract issue number from branch name
    const issueNum = extractIssueNumber(branch);
    if (!issueNum) return outputSilentSuccess();

    // Check if commit message already references the issue
    if (messageReferencesIssue(commitMessage, issueNum)) {
      return outputSilentSuccess();
    }

    // Issue number found in branch but not in commit message — remind
    return outputAllowWithContext(
      `Reminder: You're on branch \`${branch}\` — include #${issueNum} in the commit message to link it to the issue.`
    );
  } catch {
    // Never block on errors
    return outputSilentSuccess();
  }
}
