// OrchestKit Hooks - stop bundle
// Generated: 2026-02-06T18:21:40.220Z

var at=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});function xi(e){return typeof e.command=="string"}function $i(e){return typeof e.file_path=="string"&&typeof e.content=="string"}function Ii(e){return typeof e.file_path=="string"&&typeof e.old_string=="string"&&typeof e.new_string=="string"}function Ri(e){return typeof e.file_path=="string"&&e.content===void 0}import{appendFileSync as gt,existsSync as ft,statSync as ps,renameSync as ls,mkdirSync as ds,readSync as gs}from"node:fs";import{execSync as fs}from"node:child_process";import Bn from"node:os";import K from"node:path";function Te(){return process.env.HOME||process.env.USERPROFILE||Bn.homedir()}function Ce(){return process.env.CLAUDE_PROJECT_DIR||"."}function ct(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function ut(){return process.env.CLAUDE_PLUGIN_ROOT?K.join(Te(),".claude","logs","ork"):K.join(Ce(),".claude","logs")}var Pi=K.join,Oi=K.sep;import{execSync as zn}from"node:child_process";import{createHash as Qn}from"node:crypto";import{existsSync as pt,readFileSync as Zn,writeFileSync as Vn,mkdirSync as Kn}from"node:fs";import{join as Pe,basename as Yn}from"node:path";var Xn=20,es=15,ts=/[^a-z0-9-]/g;function ns(e){let t=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=Yn(t);return lt(n,Xn)}function ss(e){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let t=e||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=zn("git branch --show-current",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),s=lt(n||"detached",es);return process.env.ORCHESTKIT_SESSION_BRANCH=s,s}catch{return"nobranch"}}function rs(e){let t=e||new Date,n=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");return`${n}${s}`}function os(e){let t=e||new Date,n=String(t.getHours()).padStart(2,"0"),s=String(t.getMinutes()).padStart(2,"0");return`${n}${s}`}function is(){let e=`${process.pid}-${Date.now()}-${Math.random()}`;return Qn("sha256").update(e).digest("hex").slice(0,4)}function lt(e,t){return e.toLowerCase().replace(ts,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,t)}function as(e,t){let n=ns(e),s=ss(e),r=rs(t),o=os(t),a=is();return`${n}-${s}-${r}-${o}-${a}`}function cs(e){let t=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=Pe(t,".instance","session-id.json");if(pt(n))try{let s=JSON.parse(Zn(n,"utf8"));if(s.session_id&&s.created_at){let r=Date.now()-new Date(s.created_at).getTime(),o=1440*60*1e3;if(r<o)return s.session_id}}catch{}}function us(e,t){let n=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),s=Pe(n,".instance"),r=Pe(s,"session-id.json");try{pt(s)||Kn(s,{recursive:!0}),Vn(r,JSON.stringify({session_id:e,created_at:new Date().toISOString()},null,2))}catch{}}function dt(e){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let t=cs(e);if(t)return t;let n=as(e);return us(n,e),n}function w(){return ut()}function d(){return Ce()}function Oe(){return ct()}function qi(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${Oe()}/.claude/.instance_env`}function f(){return dt()}function Gi(e){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let t=fs("git branch --show-current",{cwd:e||d(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=t,t}catch{return"unknown"}}function ms(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Ji(e){return e.replace(/\r\n/g,`
`)}function ys(e){let t=["debug","info","warn","error"];return t.indexOf(e)>=t.indexOf(ms())}function u(){return{continue:!0,suppressOutput:!0}}function Bi(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function O(e){return{continue:!1,stopReason:e,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:e}}}function k(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:e}}}function hs(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:e}}}function zi(e,t){let n={continue:!0,suppressOutput:!0};return e&&(n.systemMessage=e),t&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:t}),n}function Qi(e,t){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:e,permissionDecision:"allow"}};return t?n.systemMessage=t:n.suppressOutput=!0,n}function Zi(e){return{continue:!0,systemMessage:e}}function Vi(e){return{continue:!0,systemMessage:`\u26A0 ${e}`}}function Ki(e){return{continue:!1,stopReason:e,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:e}}}function Yi(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:e}}}var _s=200*1024,Ss=100*1024;function mt(e,t){if(ft(e))try{if(ps(e).size>t){let s=`${e}.old.${Date.now()}`;ls(e,s)}}catch{}}function yt(e){ft(e)||ds(e,{recursive:!0})}function i(e,t,n="debug"){if(!ys(n))return;let s=w(),r=`${s}/hooks.log`;try{yt(s),mt(r,_s);let o=new Date().toISOString().replace("T"," ").slice(0,19);gt(r,`[${o}] [${n.toUpperCase()}] [${e}] ${t}
`)}catch{}}function Xi(e,t,n){let s=w(),r=`${s}/permission-feedback.log`;try{yt(s),mt(r,Ss);let o=new Date().toISOString(),a=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",c=n?.session_id||f();gt(r,`${o} | ${e} | ${t} | tool=${a} | session=${c}
`)}catch{}}function ks(e){if(!e)return 0;let s=(e.match(/[{};()=><]/g)||[]).length/e.length>.03?2.8:3.5;return Math.ceil(e.length/s)}function ea(e,t,n,s,r){let o=ks(e);return s&&s.isOverBudget(n)?(i(t,`Budget exhausted for ${n}, suppressing ${o}t`),u()):(r&&r.trackTokenUsage(t,n,o),hs(e))}function ta(){try{let e=[],n=Buffer.allocUnsafe(256),s,r=0;for(;;)try{if(s=gs(r,n,0,256,null),s===0)break;e.push(Buffer.from(n.subarray(0,s)))}catch{break}let o=Buffer.concat(e).toString("utf8").trim();return o?JSON.parse(o):{tool_name:"",session_id:f(),tool_input:{}}}catch{return{tool_name:"",session_id:f(),tool_input:{}}}}function na(e,t){let n=t.replace(/^\./,"").split("."),s=e;for(let r of n){if(s==null)return;s=s[r]}return s}function sa(e){return e.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function ra(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}import{existsSync as kt,readFileSync as bs,writeFileSync as ws,mkdirSync as vs}from"node:fs";import{createHash as xs}from"node:crypto";var ht=500,Ae=3,_t=15,St=3,$s=.9;function bt(){return`${d()}/.claude/feedback/calibration-data.json`}function Is(){let e=`${d()}/.claude/feedback`;if(!kt(e))try{vs(e,{recursive:!0})}catch{}}function R(){let e=bt();if(kt(e))try{return JSON.parse(bs(e,"utf8"))}catch{i("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function je(e){Is();let t=bt();e.updatedAt=new Date().toISOString();try{ws(t,JSON.stringify(e,null,2)),i("calibration-engine","Saved calibration data")}catch(n){i("calibration-engine",`Failed to save calibration data: ${n}`)}}function Rs(e){return xs("sha256").update(e.toLowerCase().trim()).digest("hex").slice(0,16)}function ua(e,t,n,s,r,o,a){let c=R(),p={timestamp:new Date().toISOString(),sessionId:f(),agent:t,promptHash:Rs(e),matchedKeywords:n,dispatchConfidence:s,outcome:r,durationMs:o,feedback:a};c.records.push(p),c.records.length>ht&&(c.records=c.records.slice(-ht)),Ds(c,p),Ts(c),je(c),i("calibration-engine",`Recorded outcome: ${t} -> ${r} (conf: ${s})`)}function Ds(e,t){let n=t.outcome==="success",s=t.outcome==="failure"||t.outcome==="rejected";if(!n&&!s)return;let r=n?St:-St;for(let o of t.matchedKeywords){let a=e.adjustments.find(c=>c.keyword===o&&c.agent===t.agent);a?(a.adjustment=Math.max(-_t,Math.min(_t,a.adjustment+r)),a.sampleCount++,a.lastUpdated=new Date().toISOString()):e.adjustments.push({keyword:o,agent:t.agent,adjustment:r,sampleCount:1,lastUpdated:new Date().toISOString()})}}function wt(e){let t=Date.now(),n=1440*60*1e3;for(let s of e.adjustments){let r=t-new Date(s.lastUpdated).getTime();Math.floor(r/n)>7&&(s.adjustment=Math.round(s.adjustment*$s),Math.abs(s.adjustment)<1&&(s.adjustment=0))}e.adjustments=e.adjustments.filter(s=>s.adjustment!==0)}function Ts(e){let t=e.records;if(t.length===0)return;e.stats.totalDispatches=t.length;let n=t.filter(o=>o.outcome==="success").length;e.stats.successRate=n/t.length;let s=t.reduce((o,a)=>o+a.dispatchConfidence,0)/t.length;e.stats.avgConfidence=Math.round(s);let r=new Map;for(let o of t){let a=r.get(o.agent)||{count:0,success:0};a.count++,o.outcome==="success"&&a.success++,r.set(o.agent,a)}e.stats.topAgents=Array.from(r.entries()).map(([o,a])=>({agent:o,count:a.count,successRate:a.success/a.count})).sort((o,a)=>a.count-o.count).slice(0,10)}function pa(){return R().adjustments.filter(t=>t.sampleCount>=Ae)}function la(e){let n=R().records.filter(r=>r.agent===e);return n.length<Ae?null:n.filter(r=>r.outcome==="success").length/n.length}function da(){return R().stats}function ga(){return R().records.length>=Ae}import{basename as Cs}from"node:path";function Y(e){i("auto-remember-continuity","Hook triggered");let t=e.project_dir||d(),n=Cs(t)||"project",r=!!process.env.MEM0_API_KEY?"\n   [Optional] Also sync to mem0 cloud with `--mem0` flag for semantic search":"",o=`Before ending this session, consider preserving important context in the knowledge graph:

1. **Session Continuity** - If there's unfinished work or next steps:
   \`mcp__memory__create_entities\` with:
   \`\`\`json
   {"entities": [{
     "name": "session-${n}",
     "entityType": "Session",
     "observations": ["What was done: [...]", "Next steps: [...]"]
   }]}
   \`\`\`${r}

2. **Important Decisions** - If architectural/design decisions were made:
   \`mcp__memory__create_entities\` with:
   \`\`\`json
   {"entities": [{
     "name": "decision-[topic]",
     "entityType": "Decision",
     "observations": ["Decided: [...]", "Rationale: [...]"]
   }]}
   \`\`\`

3. **Patterns Learned** - If something worked well or failed:
   - Use \`/remember --success "pattern that worked"\`
   - Use \`/remember --failed "pattern that caused issues"\`

Skip if this was just a quick question/answer session.`;return i("auto-remember-continuity","Outputting memory prompt for session end"),{continue:!0,suppressOutput:!0}}import{existsSync as vt,mkdirSync as Ps,readFileSync as Os,writeFileSync as xt}from"node:fs";function X(e){i("auto-save-context","Stop hook - auto-saving context (Protocol 2.0)");let n=`${e.project_dir||d()}/.claude/context/session`,s=`${n}/state.json`;try{vt(n)||Ps(n,{recursive:!0})}catch{}let r=new Date().toISOString();try{if(vt(s)){let o=Os(s,"utf-8"),a=JSON.parse(o),c={$schema:a.$schema||"context://session/v1",_meta:a._meta||{position:"END",token_budget:500,auto_load:"always",compress:"on_threshold",description:"Session state and progress - ALWAYS loaded at END of context"},session_id:a.session_id||null,started:a.started||null,last_activity:r,current_task:a.current_task||{description:"No active task",status:"pending"},next_steps:a.next_steps||[],blockers:a.blockers||[]};xt(s,JSON.stringify(c,null,2)),i("auto-save-context","Updated session state timestamp")}else xt(s,JSON.stringify({$schema:"context://session/v1",_meta:{position:"END",token_budget:500,auto_load:"always",compress:"on_threshold",description:"Session state and progress - ALWAYS loaded at END of context"},session_id:null,started:r,last_activity:r,current_task:{description:"No active task",status:"pending"},next_steps:[],blockers:[]},null,2)),i("auto-save-context","Created new session state (Protocol 2.0 compliant)")}catch(o){i("auto-save-context",`Error saving context: ${o}`)}return u()}import{existsSync as $t,readFileSync as As}from"node:fs";import{execSync as He}from"node:child_process";var js=/^[a-zA-Z0-9_\-.:]+$/;function Es(e){return typeof e=="string"&&js.test(e)&&e.length<256}function Hs(e){let t=`${e}/.instance/id.json`;try{if(!$t(t))return null;let s=JSON.parse(As(t,"utf-8")).instance_id||null;return s&&!Es(s)?(i("cleanup-instance",`Invalid instance ID format: ${String(s).slice(0,50)}`),null):s}catch{return null}}function Ee(e,t){try{He(`sqlite3 "${e}" "${t}"`,{encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]})}catch{}}function ee(e){let t=e.project_dir||d(),n=`${t}/.claude/coordination/.claude.db`;if(!$t(n))return i("cleanup-instance","No coordination database, skipping cleanup"),u();let s=Hs(t);if(!s)return i("cleanup-instance","No instance ID to clean up"),u();i("cleanup-instance",`Cleaning up instance: ${s}`),i("cleanup-instance","Releasing all locks..."),Ee(n,`DELETE FROM file_locks WHERE instance_id = '${s}';`),i("cleanup-instance","All locks released");try{He(`sqlite3 "${n}" "SELECT count(*) FROM sqlite_master WHERE type='table' AND name='work_claims';"`,{encoding:"utf8",timeout:5e3}).trim()==="1"&&(Ee(n,`UPDATE work_claims SET status = 'abandoned', completed_at = datetime('now') WHERE instance_id = '${s}' AND status = 'active';`),i("cleanup-instance","Work claims handled"))}catch{}try{He(`sqlite3 "${n}" "SELECT count(*) FROM sqlite_master WHERE type='table' AND name='instances';"`,{encoding:"utf8",timeout:5e3}).trim()==="1"&&(Ee(n,`UPDATE instances SET status = 'terminated', last_heartbeat = datetime('now') WHERE id = '${s}';`),i("cleanup-instance","Instance status updated to terminated"))}catch{}return i("cleanup-instance","Multi-instance cleanup completed"),u()}import{existsSync as Ne,mkdirSync as Me,readFileSync as Ue,writeFileSync as N}from"node:fs";var Fe=10;function Fs(e){let t=`${e}/session/state.json`;if(!Ne(t)){i("context-compressor","No session state to archive");return}try{let n=Ue(t,"utf-8"),s=JSON.parse(n),r=s.session_id||`session-${new Date().toISOString().replace(/[:.]/g,"-")}`,o=`${e}/archive/sessions`;Me(o,{recursive:!0});let a=`${o}/${r}.json`,c={...s,ended:new Date().toISOString(),archived:!0};N(a,JSON.stringify(c,null,2)),i("context-compressor",`Archived session to ${a}`),N(t,JSON.stringify({$schema:"context://session/v1",_meta:{position:"END",token_budget:500,auto_load:"always"},session_id:null,started:null,current_task:null,files_touched:[],decisions_this_session:[],blockers:[],next_steps:[],scratchpad:{notes:[]}},null,2)),i("context-compressor","Reset session state")}catch(n){i("context-compressor",`Error archiving session: ${n}`)}}function Ns(e){let t=`${e}/knowledge/decisions/active.json`;if(Ne(t))try{let n=Ue(t,"utf-8"),s=JSON.parse(n),r=s.decisions||[];if(r.length<=Fe)return;let o=`${e}/archive/decisions`;Me(o,{recursive:!0});let a=new Date,c=`${o}/${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}.json`,p=r.slice(0,-Fe);N(c,JSON.stringify(p,null,2)),s.decisions=r.slice(-Fe),N(t,JSON.stringify(s,null,2)),i("context-compressor",`Archived ${p.length} old decisions`)}catch(n){i("context-compressor",`Error compressing decisions: ${n}`)}}function Ms(e){let t=`${e}/session/state.json`;if(Ne(t))try{let n=Ue(t,"utf-8"),s=JSON.parse(n),r={sessionId:s.session_id||"unknown",compactedAt:new Date().toISOString(),keyDecisions:(s.decisions_this_session||[]).slice(-5),filesTouched:(s.files_touched||[]).slice(-20),blockers:s.blockers||[],nextSteps:s.next_steps||[]},o=`${e}/session`;Me(o,{recursive:!0}),N(`${o}/compaction-manifest.json`,JSON.stringify(r,null,2)),i("context-compressor",`Wrote compaction manifest for session ${r.sessionId}`)}catch(n){i("context-compressor",`Error writing compaction manifest: ${n}`)}}function te(e){i("context-compressor","Starting end-of-session compression...");let n=`${e.project_dir||d()}/context`;return Ms(n),Fs(n),Ns(n),i("context-compressor","End-of-session compression complete"),u()}import{existsSync as $,readFileSync as Us,writeFileSync as Ls,mkdirSync as Ws}from"node:fs";import{execSync as D}from"node:child_process";function qs(e){let t=`${e}/.claude/hooks/logs/.last-test-run`;if(!$(t))return!0;try{let n=D("git diff --name-only HEAD",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]});if(/\.(py|js|ts|go|rs)$/.test(n))return!0}catch{return!0}return i("full-test-suite","No code changes detected, skipping tests"),!1}function Gs(e,t){let n=0;if($(`${e}/pytest.ini`)||$(`${e}/pyproject.toml`)||$(`${e}/tests`)&&$(`${e}/requirements.txt`)){i("full-test-suite","Detected Python project, running pytest...");try{D("pytest --tb=short --timeout=300 -q",{cwd:e,encoding:"utf8",timeout:3e5,stdio:["pipe","pipe","pipe"]})}catch{n=1}}if($(`${e}/package.json`)){i("full-test-suite","Detected Node.js project...");try{if(JSON.parse(Us(`${e}/package.json`,"utf-8")).scripts?.test){i("full-test-suite","Running npm test...");let r="npm test -- --passWithNoTests --watchAll=false";try{D("which pnpm",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),r="pnpm test --passWithNoTests"}catch{try{D("which yarn",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),r="yarn test --passWithNoTests"}catch{}}D(r,{cwd:e,encoding:"utf8",timeout:3e5,stdio:["pipe","pipe","pipe"]})}}catch{n=1}}if($(`${e}/go.mod`)){i("full-test-suite","Detected Go project, running go test...");try{D("go test -v -timeout 5m ./...",{cwd:e,encoding:"utf8",timeout:3e5,stdio:["pipe","pipe","pipe"]})}catch{n=1}}if($(`${e}/Cargo.toml`)){i("full-test-suite","Detected Rust project, running cargo test...");try{D("cargo test",{cwd:e,encoding:"utf8",timeout:3e5,stdio:["pipe","pipe","pipe"]})}catch{n=1}}return n===0}function ne(e){i("full-test-suite","=== Full Test Suite Started ===");let t=e.project_dir||d(),n=`${t}/.claude/hooks/logs`;try{Ws(n,{recursive:!0})}catch{}let s=`${n}/full-test-suite.log`;if(!qs(t))return u();if(Gs(t,s)){i("full-test-suite","=== All tests passed ===");try{Ls(`${n}/.last-test-run`,String(Date.now()))}catch{}}else i("full-test-suite","=== Some tests failed ===");return u()}import{existsSync as Js,readFileSync as Bs,unlinkSync as zs,rmdirSync as Qs}from"node:fs";import{execSync as M}from"node:child_process";function Zs(){try{return M("which gh",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),M("gh auth status",{encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),!0}catch{return!1}}function Vs(e){try{return M("git remote get-url origin",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).includes("github")}catch{return!1}}function Ks(e,t,n){let s=t.commits||[];if(s.length===0)return"";let r=s.map(a=>`- \`${a.sha}\`: ${a.message}`).join(`
`),o=t.tasks_completed?.length>0?`### Sub-tasks Completed
${t.tasks_completed.map(a=>`- [x] ${a}`).join(`
`)}`:"";return`## Claude Code Progress Update

**Session**: \`${n.slice(0,8)}...\`
**Branch**: \`${t.branch||"unknown"}\`

### Commits (${s.length})
${r}

${o}
---
*Automated by [OrchestKit](https://github.com/yonatangross/orchestkit)*`}function Ys(e,t){try{return M(`gh issue comment ${e} --body "${t.replace(/"/g,'\\"')}"`,{encoding:"utf8",timeout:3e4,stdio:["pipe","pipe","pipe"]}),!0}catch{return!1}}function se(e){i("issue-work-summary","Session ending, checking for issue progress to post...");let t=e.project_dir||d(),n=e.session_id||f(),r=`/tmp/claude-session-${n.replace(/[^a-zA-Z0-9_-]/g,"")}`,o=`${r}/issue-progress.json`;if(!Js(o))return i("issue-work-summary",`No progress file found at ${o}`),u();if(!Zs())return i("issue-work-summary","gh CLI not available or not authenticated, skipping"),u();if(!Vs(t))return i("issue-work-summary","Not a GitHub repository, skipping"),u();let a;try{a=JSON.parse(Bs(o,"utf-8"))}catch{return i("issue-work-summary","Failed to read progress file"),u()}let c=a.issues?Object.keys(a.issues):[];if(c.length===0)return i("issue-work-summary","No issues to process"),u();let p=0;for(let l of c){let g=a.issues[l];if((g.commits||[]).length===0){i("issue-work-summary",`No commits for issue #${l}, skipping`);continue}try{M(`gh issue view ${l} --json number`,{encoding:"utf8",timeout:1e4,stdio:["pipe","pipe","pipe"]})}catch{i("issue-work-summary",`Issue #${l} not found or not accessible, skipping`);continue}let m=Ks(l,g,n);m&&Ys(l,m)&&(p++,i("issue-work-summary",`Successfully posted comment to issue #${l}`))}i("issue-work-summary",`Posted progress comments to ${p} issue(s)`);try{zs(o);try{Qs(r)}catch{}i("issue-work-summary","Cleaned up progress file")}catch{}return u()}import{existsSync as T,readFileSync as A,mkdirSync as Xs,appendFileSync as U,writeFileSync as er}from"node:fs";import{basename as tr}from"node:path";import{spawn as nr}from"node:child_process";function sr(e,t){if(!T(e))return 0;try{let s=JSON.parse(A(e,"utf-8")).decisions||[];if(T(t)){let o=JSON.parse(A(t,"utf-8")).synced_decisions||[];return s.filter(a=>!o.includes(a.decision_id)).length}return s.length}catch{return 0}}function rr(e){if(!T(e))return{count:0,patterns:[]};try{let t=A(e,"utf-8"),n;try{n=t.split(`
`).filter(r=>r.trim()).map(r=>JSON.parse(r))}catch{n=[JSON.parse(t)]}let s=n.filter(r=>r.pending_sync===!0);return{count:s.length,patterns:s}}catch{return{count:0,patterns:[]}}}function or(e){return tr(e)||"project"}function ir(e){let t="",n="",s="",r=`${e}/.claude/context/session/state.json`;if(T(r))try{let a=JSON.parse(A(r,"utf-8"));t=a.current_task||a.task||""}catch{}let o=`${e}/.claude/logs/blockers.jsonl`;if(T(o))try{n=A(o,"utf-8").split(`
`).filter(l=>l.trim()).map(l=>JSON.parse(l)).filter(l=>!l.resolved).slice(-5).map(l=>l.description||"").join("; ")}catch{}return{currentTask:t,blockers:n,nextSteps:s}}function re(e){if(!process.env.MEM0_API_KEY)return i("mem0-pre-compaction-sync","Mem0 not configured (no MEM0_API_KEY), skipping"),u();let t=e.project_dir||d(),n=Oe(),s=`${n}/.claude/coordination/decision-log.json`,r=`${t}/.claude/logs/agent-patterns.jsonl`,o=`${n}/.claude/coordination/.decision-sync-state.json`,a=sr(s,o),{count:c,patterns:p}=rr(r),{currentTask:l,blockers:g,nextSteps:y}=ir(t);if(a===0&&c===0&&!l)return u();let m=or(t),_=`${t}/.claude/logs/mem0-sync.log`;try{Xs(`${t}/.claude/logs`,{recursive:!0})}catch{}let h=[];if(a>0&&h.push(`${a} decisions to sync`),c>0){h.push(`${c} agent patterns pending`);let Re=new Set(p.map(v=>v.agent_id||v.agent).filter(Boolean)),V=Array.from(Re).slice(0,5);V.length>0&&h.push(`agents: ${V.join(", ")}`)}let Q=h.length>0?h.join("; "):"No pending items",$e=l||"Session work";a>0&&($e+=` (${a} decisions made)`),c>0&&($e+=` (${c} patterns learned)`);let Ie=`Session Summary: ${$e}`;g&&(Ie+=` | Blockers: ${g}`),y&&(Ie+=` | Next: ${y}`);let ot=`${n}/skills/mem0-memory/scripts/crud/add-memory.py`,Jn=process.env.MEM0_API_KEY,Z;if(T(ot)&&Jn){let Re=new Date().toISOString();try{U(_,`[${Re}] Auto-sync triggered for session summary
`)}catch{}let V=JSON.stringify({type:"session_summary",status:"in_progress",project:m,has_blockers:!!g,has_next_steps:!!y,source:"orchestkit-plugin"}),v=nr("python3",[ot,"--text",Ie,"--user-id",`${m}-continuity`,"--metadata",V,"--enable-graph"],{detached:!0,stdio:["ignore","pipe","pipe"]});if(v.on("error",x=>{let b=new Date().toISOString();try{U(_,`[${b}] Sync child process error: ${x.message}
`)}catch{}}),v.on("close",x=>{let b=new Date().toISOString();try{x===0?U(_,`[${b}] Sync completed successfully
`):U(_,`[${b}] Sync exited with code ${x}
`)}catch{}}),v.stderr){let x="";v.stderr.on("data",b=>{x+=b.toString()}),v.stderr.on("end",()=>{if(x.trim()){let b=new Date().toISOString();try{U(_,`[${b}] Sync stderr: ${x.trim()}
`)}catch{}}})}if(v.unref(),c>0&&T(r))try{let b=A(r,"utf-8").split(`
`).filter(De=>De.trim()).map(De=>{let it=JSON.parse(De);return it.pending_sync=!1,JSON.stringify(it)}).join(`
`);er(r,b)}catch{}Z=`[Mem0 Sync] Auto-synced: ${Q}`}else Z=`[Mem0 Sync] ${Q} - Execute /ork:memory sync to persist session context`;return i("mem0-pre-compaction-sync",Z),{continue:!0,systemMessage:Z}}import{existsSync as oe,readFileSync as It,unlinkSync as Rt}from"node:fs";import{execSync as Dt}from"node:child_process";var Tt=/^[a-zA-Z0-9_\-.:]+$/;function ar(e){return typeof e=="string"&&Tt.test(e)&&e.length<256}function ie(e,t){try{Dt(`sqlite3 "${e}" "${t}"`,{encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]})}catch{}}function Le(e,t){if(!Tt.test(t))return!1;try{return Dt(`sqlite3 "${e}" "SELECT count(*) FROM sqlite_master WHERE type='table' AND name='${t}';"`,{encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()==="1"}catch{return!1}}function cr(e){let t=`${e}/heartbeat.pid`;if(oe(t))try{let n=parseInt(It(t,"utf-8").trim(),10);try{process.kill(n,0),process.kill(n),i("multi-instance-cleanup",`Stopped heartbeat process (PID: ${n})`)}catch{}Rt(t)}catch{}}function ur(e,t){i("multi-instance-cleanup","Releasing all locks..."),ie(e,`DELETE FROM file_locks WHERE instance_id = '${t}';`),i("multi-instance-cleanup","All locks released")}function pr(e,t){i("multi-instance-cleanup","Handling work claims..."),Le(e,"work_claims")?(ie(e,`UPDATE work_claims SET status = 'abandoned', completed_at = datetime('now') WHERE instance_id = '${t}' AND status = 'active';`),i("multi-instance-cleanup","Work claims handled")):i("multi-instance-cleanup","No work_claims table, skipping")}function lr(e,t){Le(e,"instances")?(ie(e,`UPDATE instances SET status = 'terminated', last_heartbeat = datetime('now') WHERE id = '${t}';`),i("multi-instance-cleanup","Instance status updated to terminated")):i("multi-instance-cleanup","No instances table, skipping status update")}function dr(e,t){if(!Le(e,"messages")){i("multi-instance-cleanup","No messages table, skipping broadcast");return}let n=`msg-${Math.random().toString(36).slice(2,18)}`,s=new Date().toISOString(),r=JSON.stringify({instance_id:t,timestamp:s}).replace(/'/g,"''");ie(e,`INSERT INTO messages (message_id, from_instance, to_instance, message_type, payload, expires_at) VALUES ('${n}', '${t}', NULL, 'shutdown', '${r}', datetime('now', '+1 hour'));`),i("multi-instance-cleanup","Shutdown broadcast sent")}function gr(e){let t=["knowledge_cache.json","claims.json","session_discoveries.json"];for(let n of t){let s=`${e}/${n}`;try{oe(s)&&Rt(s)}catch{}}i("multi-instance-cleanup","Instance files cleaned up")}function ae(e){let t=e.project_dir||d(),n=`${t}/.instance`,s=`${t}/.claude/coordination/.claude.db`;if(!oe(s))return i("multi-instance-cleanup","No coordination database, skipping cleanup"),u();let r=`${n}/id.json`;if(!oe(r))return i("multi-instance-cleanup","No instance identity, skipping cleanup"),u();let o;try{let a=JSON.parse(It(r,"utf-8"));if(!ar(a.instance_id))return i("multi-instance-cleanup",`Invalid instance ID format: ${String(a.instance_id).slice(0,50)}`),u();o=a.instance_id}catch{return i("multi-instance-cleanup","Failed to read instance ID"),u()}return i("multi-instance-cleanup",`Starting multi-instance cleanup for ${o}...`),cr(n),ur(s,o),pr(s,o),dr(s,o),lr(s,o),gr(n),i("multi-instance-cleanup","=== Cleanup Summary ==="),i("multi-instance-cleanup",`Instance: ${o}`),i("multi-instance-cleanup","Status: terminated"),i("multi-instance-cleanup","Multi-instance cleanup completed"),u()}import{existsSync as C,mkdirSync as fr,readFileSync as mr,writeFileSync as L,readdirSync as Ct}from"node:fs";import{execSync as I}from"node:child_process";function yr(e,t){if(!C(`${e}/package.json`)||!C(`${e}/package-lock.json`)&&!C(`${e}/yarn.lock`)&&!C(`${e}/pnpm-lock.yaml`))return null;i("security-scan","Running npm audit...");try{I("npm audit --json",{cwd:e,encoding:"utf8",timeout:12e4,stdio:["pipe","pipe","pipe"]})}catch(n){if(n.stdout){L(`${t}/npm-audit.json`,n.stdout);try{let s=JSON.parse(n.stdout);return{critical:s.metadata?.vulnerabilities?.critical||0,high:s.metadata?.vulnerabilities?.high||0}}catch{}}}return i("security-scan","npm audit complete"),{critical:0,high:0}}function hr(e,t){if(!C(`${e}/requirements.txt`)&&!C(`${e}/pyproject.toml`))return null;try{I("which pip-audit",{encoding:"utf8",stdio:["pipe","pipe","pipe"]})}catch{return i("security-scan","pip-audit not installed, skipping"),null}i("security-scan","Running pip-audit...");try{let n=I("pip-audit --format json",{cwd:e,encoding:"utf8",timeout:12e4,stdio:["pipe","pipe","pipe"]});L(`${t}/pip-audit.json`,n);let s=JSON.parse(n);return i("security-scan","pip-audit complete"),Array.isArray(s)?s.length:0}catch{return 0}}function _r(e,t){try{I("which semgrep",{encoding:"utf8",stdio:["pipe","pipe","pipe"]})}catch{return i("security-scan","semgrep not installed, skipping"),null}i("security-scan","Running semgrep...");try{let n=I("semgrep --config auto --json --quiet",{cwd:e,encoding:"utf8",timeout:3e5,stdio:["pipe","pipe","pipe"]});L(`${t}/semgrep.json`,n);let r=(JSON.parse(n).results||[]).filter(o=>o.extra?.severity==="ERROR").length;return i("security-scan","semgrep complete"),r}catch{return 0}}function Sr(e,t){try{if(!I('find . -name "*.py" -maxdepth 2 | head -1',{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()&&!C(`${e}/backend`))return null}catch{return null}try{I("which bandit",{encoding:"utf8",stdio:["pipe","pipe","pipe"]})}catch{return i("security-scan","bandit not installed, skipping"),null}i("security-scan","Running bandit...");try{return I(`bandit -r . -f json -o ${t}/bandit.json`,{cwd:e,encoding:"utf8",timeout:12e4,stdio:["pipe","pipe","pipe"]}),i("security-scan","bandit complete"),0}catch{return 0}}function kr(e,t){i("security-scan","Running secret detection...");let n=/(api[_-]?key|secret[_-]?key|password|token)\s*[=:]\s*["'][^"']{8,}/i,s=0,r=[],o=[".py",".js",".ts",".env"];function a(c){try{let p=Ct(c,{withFileTypes:!0});for(let l of p){let g=`${c}/${l.name}`;if(l.isDirectory()){["node_modules",".git","dist","build"].includes(l.name)||a(g);continue}if(o.some(y=>l.name.endsWith(y)))try{let y=mr(g,"utf-8");n.test(y)&&(r.push({file:g,type:"potential_secret"}),s++)}catch{}}}catch{}}return a(e),L(`${t}/secrets.json`,JSON.stringify({findings:r,count:s},null,2)),i("security-scan",`Secret detection complete: ${s} potential issues`),s}function br(e,t){i("security-scan","Aggregating results...");let n=0,s=0;t.npmAudit&&(n+=t.npmAudit.critical,s+=t.npmAudit.high),t.pipAudit!==null&&(s+=t.pipAudit),t.semgrep!==null&&(s+=t.semgrep);let r=Ct(e).filter(a=>a.endsWith(".json")&&!a.includes("aggregated")).map(a=>a.replace(".json","")),o={timestamp:new Date().toISOString(),summary:{critical:n,high:s,medium:0},scans_completed:r};L(`${e}/aggregated-report.json`,JSON.stringify(o,null,2)),i("security-scan","=== Security Scan Complete ==="),i("security-scan",`Critical: ${n}, High: ${s}`),n>0&&console.error(`Security: ${n} critical, ${s} high vulnerabilities found`)}function ce(e){i("security-scan","=== Security Scan Started ===");let t=e.project_dir||d(),n=`${t}/.claude/hooks/logs/security`;fr(n,{recursive:!0});let s={npmAudit:null,pipAudit:null,semgrep:null,bandit:null,secrets:0};return s.npmAudit=yr(t,n),s.pipAudit=hr(t,n),s.semgrep=_r(t,n),s.bandit=Sr(t,n),s.secrets=kr(t,n),br(n,s),u()}import{existsSync as E,mkdirSync as q,readFileSync as H,writeFileSync as de}from"node:fs";import{existsSync as Be,appendFileSync as Pr,mkdirSync as Or,readFileSync as Ht,writeFileSync as Ar}from"node:fs";import{existsSync as wr,readFileSync as vr,writeFileSync as ec,mkdirSync as tc}from"node:fs";import{execSync as Pt}from"node:child_process";import{createHash as xr}from"node:crypto";import*as Ot from"node:os";var $r=".claude/.user_identity.json",Ir="orchestkit-user-identity-v1",Rr={share_with_team:!0,share_globally:!1,share_decisions:!0,share_preferences:!0,share_skill_usage:!1,share_prompts:!1,anonymize_globally:!0},S=null,ue=null;function pe(e){return xr("sha256").update(e+Ir).digest("hex").slice(0,32)}function Dr(){try{return Ot.hostname()}catch{return"unknown-machine"}}function At(e){let t=`${e}/${$r}`;if(!wr(t))return null;try{let n=vr(t,"utf8");return JSON.parse(n)}catch(n){return i("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function Tr(e){let t={};try{t.email=Pt("git config user.email",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{t.name=Pt("git config user.name",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return t}function Cr(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function j(e){if(S)return S;let t=e||d(),n=Dr(),s=At(t);if(s?.user_id)return S={user_id:s.user_id,display_name:s.display_name||s.user_id,team_id:s.team_id,machine_id:n,source:"config",anonymous_id:pe(s.user_id),email:s.user_id.includes("@")?s.user_id:void 0},i("user-identity",`Resolved from config: ${S.anonymous_id}`,"debug"),S;let r=Tr(t);if(r.email)return S={user_id:r.email,display_name:r.name||r.email.split("@")[0],team_id:s?.team_id,machine_id:n,source:"git",anonymous_id:pe(r.email),email:r.email},i("user-identity",`Resolved from git: ${S.anonymous_id}`,"debug"),S;let o=Cr();if(o.username){let c=`${o.username}@${n}`;return S={user_id:c,display_name:o.username,team_id:s?.team_id,machine_id:n,source:"env",anonymous_id:pe(c)},i("user-identity",`Resolved from env: ${S.anonymous_id}`,"debug"),S}let a=pe(n+process.pid);return S={user_id:`anon-${a.slice(0,8)}`,display_name:"Anonymous",team_id:s?.team_id,machine_id:n,source:"anonymous",anonymous_id:a},i("user-identity",`Resolved as anonymous: ${S.anonymous_id}`,"debug"),S}function We(e){if(ue)return ue;let t=e||d(),n=At(t);return ue={...Rr,...n?.privacy},ue}function qe(e,t){let n=We();if(t==="team"&&!n.share_with_team||t==="global"&&!n.share_globally)return!1;switch(e){case"decisions":return n.share_decisions;case"preferences":return n.share_preferences;case"skill_usage":return n.share_skill_usage;case"prompts":return n.share_prompts;default:return!1}}function le(){let e=j();return{session_id:f(),user_id:e.user_id,anonymous_id:e.anonymous_id,team_id:e.team_id,machine_id:e.machine_id,identity_source:e.source,timestamp:new Date().toISOString()}}var jr=/^[a-zA-Z0-9_-]{1,128}$/;function Er(e){return jr.test(e)}function ze(e,t){let n=e||f(),s=t||d();if(!Er(n))throw new Error("Invalid session ID format");return`${s}/.claude/memory/sessions/${n}`}function Ft(e,t){return`${ze(e,t)}/events.jsonl`}function Nt(e,t){let n=ze(e,t);Be(n)||Or(n,{recursive:!0})}var W=0,jt=!1,Ge=!1,Et=0,Hr=5e3;function Mt(e,t){return`${ze(e,t)}/counter.json`}function Fr(e,t){if(!jt){jt=!0;try{let n=Mt(e,t);if(Be(n)){let s=JSON.parse(Ht(n,"utf8"));typeof s.counter=="number"&&s.counter>0&&(W=s.counter,i("session-tracker",`Loaded event counter: ${W}`,"debug"))}}catch{}}}function Nr(e,t){if(!Ge)return;let n=Date.now();if(!(n-Et<Hr))try{Nt(e,t);let s=Mt(e,t);Ar(s,JSON.stringify({counter:W,updated_at:new Date().toISOString()})),Ge=!1,Et=n}catch{}}function Mr(){return Fr(),W++,Ge=!0,Nr(),`evt-${Date.now()}-${W}`}function Ur(e,t,n={}){try{let s={event_id:Mr(),event_type:e,identity:le(),payload:{name:t,input:Je(n.input),output:Je(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?Lt(n.context,500):void 0,confidence:n.confidence}};Nt();let r=Ft();Pr(r,JSON.stringify(s)+`
`),i("session-tracker",`Tracked ${e}: ${t}`,"debug")}catch(s){i("session-tracker",`Failed to track event: ${s}`,"warn")}}function Ut(){Ur("session_end","session",{success:!0,input:{ended_at:new Date().toISOString()}})}function Qe(e){let t=Ft(e);if(!Be(t))return[];try{return Ht(t,"utf8").trim().split(`
`).filter(Boolean).map(r=>JSON.parse(r))}catch(n){return i("session-tracker",`Failed to load session events: ${n}`,"warn"),[]}}function Ze(e){let t=Qe(e),n=le(),s={skill_invoked:0,agent_spawned:0,hook_triggered:0,decision_made:0,preference_stated:0,problem_reported:0,solution_found:0,tool_used:0,session_start:0,session_end:0,communication_style_detected:0},r=new Set,o=new Set,a=new Set,c,p;for(let g of t)switch(s[g.event_type]++,g.event_type){case"skill_invoked":r.add(g.payload.name);break;case"agent_spawned":o.add(g.payload.name);break;case"hook_triggered":a.add(g.payload.name);break;case"session_start":c=g.identity.timestamp;break;case"session_end":p=g.identity.timestamp;break}let l=c&&p?new Date(p).getTime()-new Date(c).getTime():void 0;return{session_id:e||n.session_id,user_id:n.user_id,anonymous_id:n.anonymous_id,team_id:n.team_id,start_time:c,end_time:p,duration_ms:l,event_counts:s,skills_used:[...r],agents_spawned:[...o],hooks_triggered:[...a],decisions_made:s.decision_made,problems_reported:s.problem_reported,solutions_found:s.solution_found}}function Lt(e,t){return e.length<=t?e:e.slice(0,t-3)+"..."}function Je(e){if(!e)return;let t={},n=["password","secret","token","key","credential","auth"];for(let[s,r]of Object.entries(e)){if(n.some(o=>s.toLowerCase().includes(o))){t[s]="[REDACTED]";continue}if(typeof r=="string"&&r.length>500){t[s]=Lt(r,500);continue}if(typeof r=="object"&&r!==null&&!Array.isArray(r)){t[s]=Je(r);continue}t[s]=r}return t}var Lr={Grep:"search",Glob:"search",WebSearch:"web",Read:"file_read",Write:"file_write",Edit:"file_edit",MultiEdit:"file_edit",NotebookEdit:"file_edit",Bash:"execution",Task:"agent",Skill:"skill",WebFetch:"web",AskUserQuestion:"interaction",TaskCreate:"task_mgmt",TaskUpdate:"task_mgmt",TaskList:"task_mgmt",TaskGet:"task_mgmt",TaskOutput:"task_mgmt",TaskStop:"task_mgmt",EnterPlanMode:"interaction",ExitPlanMode:"interaction"};function Wt(e){return Lr[e]||"other"}function Wr(e){if(!E(e))return"";try{let n=JSON.parse(H(e,"utf-8")).tools||{};return Object.entries(n).sort(([,r],[,o])=>o-r).slice(0,10).map(([r])=>r).join(",")}catch{return""}}function qr(e){if(!E(e))return 0;try{let n=JSON.parse(H(e,"utf-8")).tools||{};return Object.values(n).reduce((s,r)=>s+r,0)}catch{return 0}}function Gr(e){return e.includes("Write")&&e.includes("Bash")&&/test|pytest|jest|vitest/i.test(e)?"test-driven-development":e.includes("Read")&&e.includes("Grep")?"code-exploration":e.includes("Edit")&&!e.includes("Write")?"refactoring":e.includes("Write")&&e.includes("Read")?"feature-development":e.includes("Bash")&&/git|gh/i.test(e)?"git-operations":"general"}function Jr(e){return"unknown"}function Br(e){if(E(e))try{return JSON.parse(H(e,"utf-8"))}catch{}return{version:"1.0.0",last_updated:null,sessions_count:0,workflow_types:{"test-driven-development":0,"code-exploration":0,refactoring:0,"feature-development":0,"git-operations":0,general:0},common_tool_sequences:[],dominant_languages:{python:0,typescript:0,javascript:0,go:0,rust:0,unknown:0},average_tools_per_session:0,average_session_duration_seconds:0,tool_frequency:{}}}function zr(e,t,n,s,r){let o=Br(e),a=new Date().toISOString();if(o.last_updated=a,o.sessions_count+=1,o.workflow_types[t]=(o.workflow_types[t]||0)+1,o.dominant_languages[n]=(o.dominant_languages[n]||0)+1,o.average_tools_per_session=(o.average_tools_per_session*(o.sessions_count-1)+s)/o.sessions_count,r.split(",").filter(Boolean).length>2){let p=new Set([r,...o.common_tool_sequences]);o.common_tool_sequences=Array.from(p).slice(0,20)}q(e.replace(/\/[^/]+$/,""),{recursive:!0}),de(e,JSON.stringify(o,null,2))}function Qr(e){if(E(e))try{return JSON.parse(H(e,"utf-8"))}catch{}return{version:"1.0",updated:"",patterns:[],categories:{},stats:{total:0,successes:0,failures:0}}}function Zr(){let e={};try{let s=Qe().filter(r=>r.event_type==="tool_used");for(let r of s){let o=r.payload.name,a=r.payload.input?.category||Wt(o);e[a]||(e[a]={}),e[a][o]=(e[a][o]||0)+1}}catch{}let t={};for(let[n,s]of Object.entries(e)){let r=Object.entries(s).sort(([,o],[,a])=>a-o);r.length>0&&(t[n]=r[0][0])}return{usageByCategory:e,preferences:t}}function Vr(e){let{usageByCategory:t,preferences:n}=Zr();if(Object.keys(n).length===0){i("session-patterns","No tool usage to aggregate");return}let s=`${e}/.claude/feedback/tool-preferences.json`,r={version:"1.0.0",updated:"",usage_by_category:{},preferences:{},sessions_aggregated:0};if(E(s))try{r=JSON.parse(H(s,"utf-8"))}catch{}for(let[a,c]of Object.entries(t)){r.usage_by_category[a]||(r.usage_by_category[a]={});for(let[p,l]of Object.entries(c))r.usage_by_category[a][p]=(r.usage_by_category[a][p]||0)+l}for(let[a,c]of Object.entries(r.usage_by_category)){let p=Object.entries(c).sort(([,l],[,g])=>g-l);p.length>0&&(r.preferences[a]=p[0][0])}r.updated=new Date().toISOString(),r.sessions_aggregated+=1,q(`${e}/.claude/feedback`,{recursive:!0}),de(s,JSON.stringify(r,null,2));let o=Object.keys(r.preferences).length;i("session-patterns",`Updated tool preferences: ${o} categories`)}function Kr(e){let t=`${e}/.claude/feedback/patterns-queue.json`,n=`${e}/.claude/feedback/learned-patterns.json`;if(!E(t)){i("session-patterns","No patterns queue found");return}let s;try{s=JSON.parse(H(t,"utf-8"))}catch{i("session-patterns","Failed to parse patterns queue");return}let r=s.patterns?.length||0;if(r===0){i("session-patterns","Patterns queue is empty");return}i("session-patterns",`Processing ${r} queued patterns...`);let o=Qr(n),a=new Date().toISOString(),c=[...o.patterns,...s.patterns],p=new Map;for(let h of c)p.set(h.text,h);let l=Array.from(p.values()),g=l.filter(h=>h.outcome==="success").length,y=l.filter(h=>h.outcome==="failed").length,m={};for(let h of l)m[h.category]=(m[h.category]||0)+1;let _={version:"1.0",updated:a,patterns:l,categories:m,stats:{total:l.length,successes:g,failures:y}};q(n.replace(/\/[^/]+$/,""),{recursive:!0}),de(n,JSON.stringify(_,null,2)),i("session-patterns","Merged patterns successfully"),de(t,JSON.stringify({patterns:[]}))}function ge(e){i("session-patterns","Session ending, processing patterns...");let t=e.project_dir||d(),n="/tmp/claude-session-metrics.json",s=`${t}/.claude/feedback/workflow-patterns.json`;q(`${t}/.claude/feedback`,{recursive:!0}),q(`${t}/.claude/logs`,{recursive:!0});let r=qr(n);if(r>=5){let o=Wr(n),a=Gr(o),c=Jr(o);zr(s,a,c,r,o),i("session-patterns",`Workflow analyzed: type=${a} lang=${c} tools=${r}`)}else i("session-patterns",`Session too short for workflow analysis (tools: ${r})`);return Vr(t),Kr(t),i("session-patterns","Pattern processing complete"),u()}import{existsSync as Zt,readFileSync as Vt}from"node:fs";import{existsSync as qt,readFileSync as Yr,writeFileSync as Xr,mkdirSync as eo}from"node:fs";function Gt(){let e=f();return`${d()}/.claude/orchestration/task-registry-${e}.json`}function to(){let e=`${d()}/.claude/orchestration`;if(!qt(e))try{eo(e,{recursive:!0})}catch{}}function Jt(){let e=Gt();if(qt(e))try{return JSON.parse(Yr(e,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:f(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function no(e){to();let t=Gt();e.updatedAt=new Date().toISOString();try{Xr(t,JSON.stringify(e,null,2))}catch(n){i("task-integration",`Failed to save registry: ${n}`)}}function Bt(e,t){return`### Delete Orphaned Task

\`\`\`
TaskUpdate:
  taskId: "${e}"
  status: "deleted"
\`\`\`

**Reason**: ${t}`}function zt(){let e=Jt(),t=new Set(e.tasks.filter(n=>n.status==="failed").map(n=>n.taskId));return t.size===0?[]:e.tasks.filter(n=>n.status!=="pending"||!n.blockedBy||n.blockedBy.length===0?!1:n.blockedBy.every(s=>t.has(s)))}function Qt(e=1440*60*1e3){let t=Jt(),n=Date.now()-e;t.tasks=t.tasks.filter(s=>s.status==="pending"||s.status==="in_progress"?!0:new Date(s.createdAt).getTime()>n),t.pipelines=t.pipelines.filter(s=>s.status==="running"?!0:new Date(s.startedAt).getTime()>n),no(t)}function fe(e){i("task-completion-check","Stop hook - checking task completion");let t=[],n=e.project_dir||d(),s=e.session_id||f(),r=`${n}/.claude/orchestration/task-registry-${s}.json`;if(Zt(r))try{let l=(JSON.parse(Vt(r,"utf-8")).tasks||[]).filter(g=>g.status==="in_progress");l.length>0&&(i("task-completion-check",`WARNING: ${l.length} orchestration tasks still in progress`),t.push(`${l.length} orchestration task(s) still in progress at session stop`))}catch(p){i("task-completion-check",`Error reading registry: ${p}`)}let o=zt(),a="";if(o.length>0){i("task-completion-check",`Found ${o.length} orphaned tasks`),a=`

## Orphaned Tasks

The following tasks are orphaned (all blockers failed) and should be deleted:
`;for(let p of o)a+=`
${Bt(p.taskId,"All blocking tasks have failed")}`}let c="/tmp/claude-active-todos.json";if(Zt(c))try{let l=JSON.parse(Vt(c,"utf-8")).filter(g=>g.status==="in_progress");l.length>0&&(i("task-completion-check",`WARNING: ${l.length} legacy tasks in progress at stop`),t.push(`${l.length} legacy task(s) still in progress`))}catch(p){i("task-completion-check",`Error reading legacy todos: ${p}`)}if(t.length>0||a){let p=`## Task Completion Warning

${t.map(l=>`- ${l}`).join(`
`)}`;return a&&(p+=a),k(p)}return u()}import{existsSync as Ve,readFileSync as so,writeFileSync as xc,mkdirSync as $c}from"node:fs";function Yt(){return`${d()}/.claude/orchestration`}function ro(){let e=f();return`${Yt()}/session-${e}.json`}function oo(){return`${d()}/.claude/orchestration/config.json`}var Kt={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function Xt(){let e=oo();if(Ve(e))try{let t=so(e,"utf8");return{...Kt,...JSON.parse(t)}}catch{}return Kt}function Ke(){let e=ro();try{if(Ve(e)){let{unlinkSync:t}=at("node:fs");t(e),i("orchestration-state","Cleared session state")}}catch{}}function Ye(){let e=Yt();if(Ve(e))try{let{readdirSync:t,statSync:n,unlinkSync:s}=at("node:fs"),r=t(e).filter(o=>o.startsWith("session-")&&o.endsWith(".json")).map(o=>({name:o,path:`${e}/${o}`,mtime:n(`${e}/${o}`).mtime.getTime()})).sort((o,a)=>a.mtime-o.mtime);for(let o of r.slice(5))try{s(o.path),i("orchestration-state",`Cleaned up old state: ${o.name}`)}catch{}}catch{}}var io=720*60*60*1e3;function ao(e){let t=Date.now()-io,n=e.records.length;e.records=e.records.filter(r=>new Date(r.timestamp).getTime()>t);let s=e.records.length;n!==s&&i("calibration-persist",`Cleaned up ${n-s} old records`)}function co(e){let t=e.stats,n=t.topAgents.slice(0,3).map(s=>`${s.agent}(${Math.round(s.successRate*100)}%)`).join(", ");return`Calibration summary: ${t.totalDispatches} dispatches, ${Math.round(t.successRate*100)}% success rate, ${e.adjustments.length} adjustments active. Top agents: ${n||"none"}`}function me(e){if(!Xt().enableCalibration)return Ke(),Ye(),u();i("calibration-persist","Running end-of-session calibration persistence...");try{let n=R();wt(n),ao(n),je(n);let s=co(n);i("calibration-persist",s)}catch(n){i("calibration-persist",`Error during calibration persist: ${n}`)}try{Ke(),Ye(),Qt(),i("calibration-persist","Cleaned up session state")}catch(n){i("calibration-persist",`Error during state cleanup: ${n}`)}return u()}import{existsSync as G,readFileSync as un,writeFileSync as pn,mkdirSync as ln}from"node:fs";import{join as _e,dirname as So}from"node:path";import{existsSync as en,readFileSync as uo,writeFileSync as jc,mkdirSync as po,appendFileSync as lo}from"node:fs";import{join as tn,dirname as go,basename as Hc}from"node:path";function fo(e){return tn(d(),".claude","memory","flows",`${e}.json`)}function mo(){return tn(d(),".claude","memory","completed-flows.jsonl")}function nn(e){let t=fo(e);if(!en(t))return null;try{let n=uo(t,"utf-8");return JSON.parse(n)}catch(n){return i("decision-flow-tracker",`Failed to load flow for ${e}: ${n}`,"warn"),null}}function yo(e){let t=mo();try{let n=go(t);en(n)||po(n,{recursive:!0});let s=JSON.stringify(e)+`
`;return lo(t,s),!0}catch(n){return i("decision-flow-tracker",`Failed to archive flow: ${n}`,"warn"),!1}}function sn(e){if(e.length<3)return"mixed";let t={exploration:0,modification:0,testing:0,building:0,agent:0,execution:0,git:0,other:0};for(let n of e)t[n.category]++;if(t.testing>=2){let n=e.map((r,o)=>r.category==="testing"?o:-1).filter(r=>r>=0),s=e.map((r,o)=>r.category==="modification"?o:-1).filter(r=>r>=0);if(n.length>=2&&s.length>0&&n[0]<s[0])return"test-first"}if(t.exploration>=3&&t.modification>0&&ho(e,"exploration")>=3)return"explore-first";if(t.modification>=2&&t.execution+t.testing>=2&&_o(e,"modification",["execution","testing"])>=2)return"iterate-fast";if(t.agent>=3||t.agent/e.length>.3)return"agent-delegate";if(t.modification>=3&&t.testing===1){let n=e.map((s,r)=>s.category==="testing"?r:-1).filter(s=>s>=0).pop();if(n&&n>e.length-3)return"big-bang"}return"mixed"}function ho(e,t){let n=0,s=0;for(let r of e)r.category===t?(s++,n=Math.max(n,s)):s=0;return n}function _o(e,t,n){let s=0,r=!1;for(let o of e){let a=o.category===t,c=n.includes(o.category);a&&!r?r=!0:c&&r&&(s++,r=!1)}return s}function rn(e){let t=e.filter(n=>n.result==="success").length;return{total_actions:e.length,reads:e.filter(n=>n.category==="exploration").length,writes:e.filter(n=>n.category==="modification").length,tests:e.filter(n=>n.category==="testing").length,builds:e.filter(n=>n.category==="building").length,agent_spawns:e.filter(n=>n.category==="agent").length,success_rate:e.length>0?t/e.length:0}}function ye(e){let t=nn(e);return t?(t.inferred_pattern=sn(t.actions),t.stats=rn(t.actions),t):null}function on(e){let t=nn(e);if(!t)return!1;t.inferred_pattern=sn(t.actions),t.stats=rn(t.actions);let n=yo(t);return n&&i("decision-flow-tracker",`Completed flow for ${e}: ${t.actions.length} actions, pattern: ${t.inferred_pattern}`,"info"),n}var ko={"test-first":"Writes tests before implementation (TDD)","explore-first":"Reads existing code before making changes","iterate-fast":"Makes quick write \u2192 test iterations","big-bang":"Writes multiple files then tests","agent-delegate":"Delegates tasks to specialized agents",mixed:"Varies approach by task"};function bo(e,t){let n=t.find(r=>r.name===e),s=n?Math.min(1,n.frequency+.1):.1;return{name:e,description:ko[e],frequency:s,tool_sequences:[]}}var he=2;var wo={1:e=>({...e,version:2,tool_preferences:e.tool_preferences||{},tool_usage_by_category:e.tool_usage_by_category||{}})};function vo(e){let t=e.version||1;for(;t<he;){let n=wo[t];if(!n){i("user-profile",`Missing migration for version ${t}`,"warn");break}e=n(e),t=e.version,i("user-profile",`Migrated profile to version ${t}`,"info")}return e}function xo(){return Te()}function $o(){return _e(xo(),".claude","orchestkit")}function dn(e){let t=e.replace(/[^a-zA-Z0-9@._-]/g,"_");return _e($o(),"users",t)}function Xe(e){return _e(dn(e),"profile.json")}function Io(e){let t=e.replace(/[^a-zA-Z0-9@._-]/g,"_");return _e(d(),".claude","memory","users",t,"profile.json")}function Ro(e){let t=Io(e),n=Xe(e);if(G(n))return!1;if(G(t))try{let s=So(n);G(s)||ln(s,{recursive:!0});let r=un(t,"utf8"),o=JSON.parse(r);pn(n,JSON.stringify(o,null,2));let a=e.replace(/@.*$/,"@***");return i("user-profile",`Migrated profile for ${a} to cross-project storage`,"info"),!0}catch(s){return i("user-profile",`Failed to migrate profile: ${s}`,"warn"),!1}return!1}function an(e){let t=j(),n=new Date().toISOString();return{user_id:e,anonymous_id:t.anonymous_id,display_name:t.display_name,team_id:t.team_id,sessions_count:0,first_seen:n,last_seen:n,version:he,skill_usage:{},agent_usage:{},tool_usage:{},decisions:[],preferences:[],workflow_patterns:[],aggregated_sessions:[]}}function gn(e){let t=e||j().user_id;Ro(t);let n=Xe(t);if(!G(n))return an(t);try{let s=un(n,"utf8"),r=JSON.parse(s),o=vo(r);return(r.version||1)<he&&(et(o),i("user-profile",`Auto-saved migrated profile (v${he})`,"info")),o}catch(s){return i("user-profile",`Failed to load profile: ${s}`,"warn"),an(t)}}function et(e){let t=dn(e.user_id),n=Xe(e.user_id);try{return G(t)||ln(t,{recursive:!0}),e.last_seen=new Date().toISOString(),pn(n,JSON.stringify(e,null,2)),i("user-profile",`Saved profile for ${e.anonymous_id}`,"debug"),!0}catch(s){return i("user-profile",`Failed to save profile: ${s}`,"error"),!1}}function cn(e,t,n){let s=new Date().toISOString();if(!e)return{count:1,success_rate:t?1:0,avg_duration_ms:n,first_used:s,last_used:s};let r=e.count+1,a=(Math.round(e.success_rate*e.count)+(t?1:0))/r,c=e.avg_duration_ms;return n!==void 0&&(e.avg_duration_ms!==void 0?c=(e.avg_duration_ms*e.count+n)/r:c=n),{count:r,success_rate:a,avg_duration_ms:c,first_used:e.first_used,last_used:s}}function fn(e,t){if(e.aggregated_sessions.includes(t.session_id))return i("user-profile",`Session ${t.session_id} already aggregated`,"debug"),e;e.sessions_count++,e.aggregated_sessions.push(t.session_id);for(let s of t.skills_used)e.skill_usage[s]=cn(e.skill_usage[s],!0);for(let s of t.agents_spawned)e.agent_usage[s]=cn(e.agent_usage[s],!0);try{let s=ye(t.session_id);if(s?.inferred_pattern&&s.inferred_pattern!=="mixed"){let r=s.inferred_pattern,o=e.workflow_patterns.findIndex(a=>a.name===r);if(o!==-1){let a=e.workflow_patterns[o];a.frequency=Math.min(1,a.frequency+.1),e.workflow_patterns.splice(o,1),e.workflow_patterns.unshift(a)}else{let a=bo(r,e.workflow_patterns);e.workflow_patterns.unshift(a)}e.workflow_patterns.length>10&&(e.workflow_patterns=e.workflow_patterns.slice(0,10)),i("user-profile",`Aggregated workflow pattern: ${r}`,"debug")}}catch(s){i("user-profile",`Failed to aggregate workflow pattern: ${s}`,"debug")}let n=100;return e.aggregated_sessions.length>n&&(e.aggregated_sessions=e.aggregated_sessions.slice(-n)),e}function mn(e){let t=e.decisions.map(n=>{let{project:s,...r}=n;return r});return{anonymous_id:e.anonymous_id,decisions:t,preferences:e.preferences}}function yn(e){try{let t=j();i("session-profile-aggregator",`Aggregating session for ${t.user_id}`,"debug");let n=Ze();if(n.skills_used.length===0&&n.agents_spawned.length===0&&n.decisions_made===0)return i("session-profile-aggregator","No meaningful activity to aggregate","debug"),u();let s=gn(t.user_id),r=fn(s,n);if(!et(r))return i("session-profile-aggregator","Failed to save profile","warn"),u();if(i("session-profile-aggregator",`Aggregated session: ${n.skills_used.length} skills, ${n.agents_spawned.length} agents, ${n.decisions_made} decisions`,"info"),We().share_globally&&qe("decisions","global")){let p=mn(r).decisions.filter(l=>l.confidence>=.8&&l.rationale);p.length>0&&i("session-profile-aggregator",`${p.length} decisions eligible for global sharing`,"info")}return u()}catch(t){return i("session-profile-aggregator",`Error aggregating session: ${t}`,"error"),u()}}function Se(e){try{return Ut(),i("session-end-tracking","Tracked session end","debug"),u()}catch(t){return i("session-end-tracking",`Error: ${t}`,"warn"),u()}}import{join as To}from"node:path";import{existsSync as tt,readFileSync as hn,unlinkSync as Do,mkdirSync as nu,renameSync as su,statSync as ru}from"node:fs";function _n(e){if(!tt(e))return[];try{let n=hn(e,"utf8").trim().split(`
`).filter(r=>r.trim()),s=[];for(let r of n)try{let o=JSON.parse(r);o.text&&o.user_id?s.push(o):i("queue-processor","Skipping invalid mem0 memory (missing text or user_id)","warn")}catch{i("queue-processor",`Failed to parse mem0 queue line: ${r.slice(0,100)}`,"warn")}return s}catch(t){return i("queue-processor",`Failed to read mem0 queue: ${t}`,"warn"),[]}}function Sn(e){let t=new Map;for(let n of e){let s=n.text.trim().toLowerCase(),r=t.get(s);(!r||n.queued_at>r.queued_at)&&t.set(s,n)}return Array.from(t.values())}function kn(e){if(!tt(e))return[];try{let n=hn(e,"utf8").trim().split(`
`).filter(r=>r.trim()),s=[];for(let r of n)try{let o=JSON.parse(r);s.push(o)}catch{i("queue-processor",`Failed to parse graph queue line: ${r.slice(0,100)}`,"warn")}return s}catch(t){return i("queue-processor",`Failed to read graph queue: ${t}`,"warn"),[]}}function bn(e){let t=[],n=[],s=[],r=new Set,o=new Set;for(let a of e){if(a.type==="create_entities"&&a.payload?.entities)for(let c of a.payload.entities)r.has(c.name)||(t.push(c),r.add(c.name));if(a.type==="create_relations"&&a.payload?.relations)for(let c of a.payload.relations){let p=`${c.from}|${c.relationType}|${c.to}`;o.has(p)||(n.push(c),o.add(p))}if(a.type==="add_observations"&&a.payload?.observations)for(let c of a.payload.observations){let p=s.find(l=>l.entityName===c.entityName);p?p.contents.push(...c.contents):s.push({...c})}}return{entities:t,relations:n,observations:s}}function ke(e){if(tt(e))try{Do(e),i("queue-processor",`Cleared queue: ${e}`,"debug")}catch(t){i("queue-processor",`Failed to clear queue ${e}: ${t}`,"warn")}}function Co(e){let{entities:t,relations:n,observations:s}=e;if(t.length===0&&n.length===0&&s.length===0)return"";let r=["## Graph Memory Sync","","The following decisions and patterns were captured this session.","To persist them to the knowledge graph, execute these MCP calls:",""];return t.length>0&&(r.push("### Create Entities"),r.push("```json"),r.push("mcp__memory__create_entities({"),r.push(`  "entities": ${JSON.stringify(t,null,2).split(`
`).map((o,a)=>a===0?o:"  "+o).join(`
`)}`),r.push("})"),r.push("```"),r.push("")),n.length>0&&(r.push("### Create Relations"),r.push("```json"),r.push("mcp__memory__create_relations({"),r.push(`  "relations": ${JSON.stringify(n,null,2).split(`
`).map((o,a)=>a===0?o:"  "+o).join(`
`)}`),r.push("})"),r.push("```"),r.push("")),s.length>0&&(r.push("### Add Observations"),r.push("```json"),r.push("mcp__memory__add_observations({"),r.push(`  "observations": ${JSON.stringify(s,null,2).split(`
`).map((o,a)=>a===0?o:"  "+o).join(`
`)}`),r.push("})"),r.push("```"),r.push("")),r.push(`**Summary:** ${t.length} entities, ${n.length} relations, ${s.length} observations to sync.`),r.join(`
`)}function be(e){let t=To(d(),".claude","memory","graph-queue.jsonl"),n=kn(t);if(n.length===0)return i("graph-queue-sync","No queued graph operations","debug"),u();i("graph-queue-sync",`Processing ${n.length} queued operations`,"info");let s=bn(n),r=Co(s);return ke(t),r?{continue:!0,systemMessage:r}:u()}import{existsSync as vn,readFileSync as Po,writeFileSync as Oo,mkdirSync as Ao}from"node:fs";import{join as jo,dirname as Eo}from"node:path";var J="workflow-preference-learner",Ho=5;function xn(){return jo(d(),".claude","memory","workflow-preferences.json")}function Fo(){let e=xn();if(!vn(e))return wn();try{let t=Po(e,"utf-8");return JSON.parse(t)}catch{return wn()}}function No(e){let t=xn();try{let n=Eo(t);return vn(n)||Ao(n,{recursive:!0}),Oo(t,JSON.stringify(e,null,2)),!0}catch(n){return i(J,`Failed to save workflow preferences: ${n}`,"warn"),!1}}function wn(){let e=["test-first","explore-first","iterate-fast","big-bang","agent-delegate","mixed"],t={},n={};for(let s of e)t[s]=0,n[s]=[];return{pattern_counts:t,pattern_success_rates:n,total_sessions:0,preferences:[],updated_at:new Date().toISOString()}}function Mo(e){let t=[],n=new Date().toISOString();for(let[s,r]of Object.entries(e.pattern_counts)){if(r===0)continue;let o=e.pattern_success_rates[s]||[],a=o.length>0?o.reduce((c,p)=>c+p,0)/o.length:0;t.push({pattern:s,frequency:e.total_sessions>0?r/e.total_sessions:0,count:r,total_sessions:e.total_sessions,avg_success_rate:a,updated_at:n})}return t.sort((s,r)=>r.frequency-s.frequency),t}function Uo(e,t){if(!t.inferred_pattern)return;let n=t.inferred_pattern,s=t.stats.success_rate;e.pattern_counts[n]=(e.pattern_counts[n]||0)+1,e.total_sessions++,e.pattern_success_rates[n]||(e.pattern_success_rates[n]=[]),e.pattern_success_rates[n].push(s),e.pattern_success_rates[n].length>20&&(e.pattern_success_rates[n]=e.pattern_success_rates[n].slice(-20)),e.preferences=Mo(e),e.updated_at=new Date().toISOString()}function we(e){let t=e.session_id||f(),n=ye(t);if(!n)return i(J,`No decision flow found for session ${t}`,"debug"),u();if(n.actions.length<Ho)return i(J,`Too few actions (${n.actions.length}) for pattern detection`,"debug"),u();if(on(t),n.inferred_pattern==="mixed")return u();let s=Fo();Uo(s,n),No(s),i(J,`Session pattern: ${n.inferred_pattern} (${n.actions.length} actions, ${(n.stats.success_rate*100).toFixed(0)}% success)`,"info");let r=s.preferences[0];return r&&r.frequency>.6&&r.count>=5&&i(J,`Strong workflow preference: ${r.pattern} (${(r.frequency*100).toFixed(0)}% of sessions)`,"info"),u()}import{join as Lo}from"node:path";function $n(){return!!process.env.MEM0_API_KEY}function Wo(e){let t=new Map;for(let n of e){let s=t.get(n.user_id)||[];s.push(n),t.set(n.user_id,s)}return t}function qo(e){if(e.length===0)return"";let t=Wo(e),n="${CLAUDE_PLUGIN_ROOT}/src/skills/mem0-memory/scripts/crud/add-memory.py",s=["## Mem0 Cloud Memory Sync","","The following decisions and patterns were captured this session.","To persist them to mem0 cloud memory, execute these CLI scripts:",""],r=1;for(let[a,c]of t){s.push(`### Scope: ${a}`),s.push("");for(let p of c){let l=JSON.stringify(p.metadata).replace(/'/g,"\\'");s.push(`**Memory ${r}:**`),s.push("```bash"),s.push(`python3 ${n} \\`),s.push(`  --text ${JSON.stringify(p.text)} \\`),s.push(`  --user-id ${JSON.stringify(p.user_id)} \\`),s.push(`  --metadata '${l}'`),s.push("```"),s.push(""),r++}}let o=new Set(e.map(a=>a.metadata.category).filter(Boolean));return s.push(`**Summary:** ${e.length} memories to sync across ${t.size} scope(s).`),o.size>0&&s.push(`Categories: ${Array.from(o).join(", ")}`),s.join(`
`)}function In(e){if(!$n())return i("mem0-queue-sync","MEM0_API_KEY not configured, skipping","debug"),u();let t=Lo(d(),".claude","memory","mem0-queue.jsonl"),n=_n(t);if(n.length===0)return i("mem0-queue-sync","No queued mem0 memories","debug"),u();i("mem0-queue-sync",`Processing ${n.length} queued memories`,"info");let s=Sn(n);s.length<n.length&&i("mem0-queue-sync",`Deduplicated ${n.length} \u2192 ${s.length} memories`,"debug");let r=qo(s);return ke(t),r?{continue:!0,systemMessage:r}:u()}import{existsSync as ve,appendFileSync as Go,mkdirSync as Jo}from"node:fs";import{execSync as Bo}from"node:child_process";function Rn(e){let t=d(),n=w(),s=`${n}/coverage-check.log`,r=parseInt(process.env.COVERAGE_THRESHOLD||"80",10);try{Jo(n,{recursive:!0})}catch{}let o=[],a=new Date().toISOString().replace("T"," ").slice(0,19);o.push(`[${a}] Coverage Check`);let c=`${t}/.coverage`,p=`${t}/coverage.xml`;if(ve(c)||ve(p))try{let y=Bo("coverage report --fail-under=0",{cwd:t,encoding:"utf8",timeout:3e4,stdio:["pipe","pipe","pipe"]}).split(`
`).find(m=>m.includes("TOTAL"));if(y){let m=y.match(/(\d+)%/);if(m){let _=parseInt(m[1],10);o.push(`Python coverage: ${_}%`),_<r?o.push(`WARNING: Coverage ${_}% is below threshold ${r}%`):o.push("Coverage meets threshold")}}}catch{}let l=`${t}/coverage`;if(ve(l)){let g=`${l}/coverage-summary.json`;ve(g)&&(o.push(""),o.push("JavaScript/TypeScript coverage report found"),o.push("Check coverage/lcov-report/index.html for details"))}try{Go(s,o.join(`
`)+`
`)}catch{}return u()}import{existsSync as P,appendFileSync as zo,mkdirSync as Qo,readdirSync as Zo}from"node:fs";function Dn(e){let t=w(),n=d(),s=`${t}/evidence-collector.log`;try{Qo(t,{recursive:!0})}catch{}let r=new Date().toISOString().replace("T"," ").slice(0,19),o=[];o.push(`[${r}] Evidence Collection`),o.push("Recent command results:");let a=process.env.CC_LAST_EXIT_CODE;a&&o.push(`  Last exit code: ${a}`),(P(`${n}/pytest.xml`)||P(`${n}/junit.xml`))&&o.push("  Test results: Found (XML format)");let c=`${n}/test-results`;if(P(c)){o.push("  Test results directory: Found");try{let p=Zo(c).slice(0,5);for(let l of p)o.push(`    ${l}`)}catch{}}(P(`${n}/.coverage`)||P(`${n}/coverage`))&&o.push("  Coverage data: Found"),(P(`${n}/lint-results.json`)||P(`${n}/eslint-report.json`))&&o.push("  Lint results: Found"),o.push("Evidence verification complete.");try{zo(s,o.join(`
`)+`
`)}catch{}return u()}import{existsSync as Vo,readFileSync as Ko}from"node:fs";var Yo=["coverage/coverage-summary.json","coverage/coverage-final.json",".vitest/coverage/coverage-summary.json","coverage.json",".coverage.json","htmlcov/status.json"];function Xo(e,t){try{let n=JSON.parse(t);return e.includes("coverage-summary.json")?n?.total?.lines?.pct??n?.total?.statements?.pct??null:e.includes("coverage.json")?n?.totals?.percent_covered??null:n?.total?.pct!==void 0?n.total.pct:null}catch{return null}}function Tn(e){let t=d(),n=parseInt(process.env.COVERAGE_THRESHOLD||"80",10),s="",r="";for(let c of Yo){let p=`${t}/${c}`;if(Vo(p)){s=p;try{r=Ko(p,"utf8")}catch{continue}break}}if(!s||!r)return u();let o=Xo(s,r);if(o===null)return u();if(Math.floor(o)<n){let c=`BLOCKED: Coverage ${o}% is below threshold ${n}%

Coverage report: ${s}

Actions required:
  1. Identify uncovered code paths
  2. Add tests for critical business logic
  3. Re-run tests with coverage:

     TypeScript: npm test -- --coverage
     Python:     pytest --cov=app --cov-report=term-missing

  4. Ensure coverage >= ${n}% before proceeding

Tip: Focus on testing:
  - Business logic (services, utils)
  - Edge cases and error handling
  - Critical user flows`;return O(c)}return u()}import{existsSync as B,readFileSync as ei}from"node:fs";import{basename as xe,dirname as F}from"node:path";function ti(e){return/\.(test|spec)\.(ts|tsx|js|jsx)$/.test(e)||/test_.*\.py$/.test(e)||/_test\.py$/.test(e)}function ni(e){if(/\.(ts|tsx|js|jsx)$/.test(e)){let t=e.replace(/\.[^.]+$/,""),n=e.split(".").pop()||"ts",s=[`${t}.test.${n}`,`${t}.spec.${n}`,`${t}.test.ts`,`${t}.test.tsx`];for(let p of s)if(B(p))return p;let r=F(e),a=xe(e).replace(/\.[^.]+$/,""),c=[`${r}/__tests__/${a}.test.${n}`,`${r}/__tests__/${a}.spec.${n}`];for(let p of c)if(B(p))return p}else if(e.endsWith(".py")){let t=F(e),s=`test_${xe(e)}`;if(B(`${t}/${s}`))return`${t}/${s}`;let r=F(t);if(B(`${r}/tests/${s}`))return`${r}/tests/${s}`;if(B(`${t}/tests/${s}`))return`${t}/tests/${s}`}return null}function si(e,t){let n=[];if(/\.(ts|tsx|js|jsx)$/.test(t)){let s=e.match(/export (function|class|const|async function)\s+([A-Za-z_][A-Za-z0-9_]*)/g);if(s)for(let r of s){let o=r.split(/\s+/).pop();o&&n.push(o)}}else if(t.endsWith(".py")){let s=e.split(`
`);for(let r of s){let o=r.match(/^(def|class)\s+([A-Za-z][A-Za-z0-9_]*)/);o&&o[2]&&n.push(o[2])}}return[...new Set(n)]}function Cn(e){let t=e.tool_input?.file_path||"",n=e.tool_input?.content||e.tool_result||"";if(!t||!n)return u();if(ti(t))return u();if(!/\.(ts|tsx|js|jsx|py)$/.test(t))return u();let s=[],r=[],o=ni(t),a=si(n,t);if(a.length>0)if(o)try{let c=ei(o,"utf8"),p=[];for(let l of a)new RegExp(`\\b${l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`).test(c)||p.push(l);if(p.length>0){r.push("TEST COVERAGE: New units without tests"),r.push(`  Implementation: ${t}`),r.push(`  Test file: ${o}`),r.push(""),r.push(`  Untested units (${p.length}/${a.length}):`);for(let l of p.slice(0,5))r.push(`    - ${l}`);r.push(""),r.push("  Add tests before committing")}}catch{}else{if(s.push("TEST COVERAGE: No test file found for implementation"),s.push(`  Implementation: ${t}`),s.push("  Expected test file:"),/\.(ts|tsx|js|jsx)$/.test(t)){let c=t.replace(/\.[^.]+$/,""),p=t.split(".").pop()||"ts",l=F(t),g=xe(t);s.push(`    - ${c}.test.${p}`),s.push(`    - ${l}/__tests__/${g}`)}else if(t.endsWith(".py")){let c=xe(t),p=F(t);s.push(`    - ${p}/test_${c}`),s.push(`    - ${F(p)}/tests/test_${c}`)}s.push(""),s.push(`  Found ${a.length} testable units:`);for(let c of a.slice(0,5))s.push(`    - ${c}`)}if(s.length>0)return O(`Missing test coverage for new code: ${s[0]}`);if(r.length>0){let c=r.join(`
`);return k(`Test coverage warnings detected:

${c}`)}return u()}import{basename as ri}from"node:path";function Pn(e){let t=e.tool_input?.file_path||"",n=e.tool_input?.content||e.tool_result||"";if(!t||!n)return u();if(!/\/routers\/.*\.py$/.test(t))return u();let s=ri(t);if(/^(deps|dependencies|__init__)\.py$/.test(s))return u();let r=[];if(/=\s*[A-Z][a-zA-Z]*Service\s*\(\s*\)/.test(n)){let o=n.match(/[A-Z][a-zA-Z]*Service\s*\(\s*\)/);r.push("INSTANTIATION: Direct service instantiation not allowed"),r.push(`  Found: ${o?.[0]||"Service()"}`),r.push("  "),r.push("  Use dependency injection:"),r.push("    service: MyService = Depends(get_my_service)")}if(/=\s*[A-Z][a-zA-Z]*(Repository|Repo)\s*\(\s*\)/.test(n)){let o=n.match(/[A-Z][a-zA-Z]*(Repository|Repo)\s*\(\s*\)/);r.push("INSTANTIATION: Direct repository instantiation not allowed"),r.push(`  Found: ${o?.[0]||"Repository()"}`),r.push("  "),r.push("  Use dependency injection:"),r.push("    repo: MyRepository = Depends(get_my_repository)")}if(/^[a-z_]+\s*=\s*[A-Z][a-zA-Z]*(Service|Repository|Repo)\s*\(/m.test(n)&&(r.push("GLOBAL: Global service/repository instance not allowed"),r.push("  "),r.push("  Global instances cause:"),r.push("    - Shared state between requests"),r.push("    - Difficult testing"),r.push("    - Connection pool issues"),r.push("  "),r.push("  Use Depends() for request-scoped instances")),/:\s*(Async)?Session[^=]*\)/.test(n)&&(/:\s*(Async)?Session\s*=\s*Depends/.test(n)||(r.push("DI: Database session must use Depends()"),r.push("  "),r.push("  BAD:  async def get_users(db: AsyncSession):"),r.push("  GOOD: async def get_users(db: AsyncSession = Depends(get_db)):"))),/@router\.(get|post|put|patch|delete)/.test(n)&&/:\s*[A-Z][a-zA-Z]*(Service|Repository|Repo)[^=)]*\)/.test(n)&&(/:\s*[A-Z][a-zA-Z]*(Service|Repository|Repo)\s*=\s*Depends/.test(n)||(r.push("DI: Service/Repository parameters must use Depends()"),r.push("  "),r.push("  BAD:  async def create_user(user_service: UserService):"),r.push("  GOOD: async def create_user(user_service: UserService = Depends(get_user_service)):"))),/async def/.test(n)){/db\.query\(/.test(n)&&(/await.*db\.query\(/.test(n)||(r.push("ASYNC: Sync database call in async function"),r.push("  Found: db.query() (sync pattern)"),r.push("  "),r.push("  Use async SQLAlchemy 2.0 patterns:"),r.push("    result = await db.execute(select(User))"),r.push("    users = result.scalars().all()")));let o=/db\.(add|delete|commit|flush|rollback|refresh)\(/;if(o.test(n)&&/AsyncSession/.test(n)){let a=n.split(`
`);for(let c of a)if(o.test(c)&&!c.includes("await")){r.push("ASYNC: Missing await for async database operation"),r.push("  "),r.push("  With AsyncSession, use await:"),r.push("    await db.commit()"),r.push("    await db.refresh(user)");break}}}if(r.length>0){i("di-pattern-enforcer",`BLOCKED: DI violation in ${t}`);let o=`Dependency injection violation in ${t}. See stderr for details.`;return k(o)}return u()}import{readFileSync as ii,readdirSync as ai}from"node:fs";import{execSync as oi}from"node:child_process";function On(e){let t=e||d();try{return oi("git rev-parse --show-toplevel",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return t}}function ci(e,t){let n=[];if(/\.(ts|tsx|js|jsx)$/.test(t)){let s=e.match(/(function|class|const|export function|export class)\s+[A-Za-z_][A-Za-z0-9_]*/g);s&&n.push(...s)}else if(t.endsWith(".py")){let s=e.split(`
`);for(let r of s){let o=r.match(/^(def|class)\s+[A-Za-z_][A-Za-z0-9_]*/);o&&n.push(o[0])}}return[...new Set(n)]}function ui(e,t){let n=[],s=["node_modules",".venv","venv","__pycache__","dist","build",".next",".git"];function r(o){try{let a=ai(o,{withFileTypes:!0});for(let c of a){let p=`${o}/${c.name}`;c.isDirectory()?s.includes(c.name)||r(p):c.isFile()&&t.test(c.name)&&n.push(p)}}catch{}}return r(e),n}function pi(e){let t=[],n=e.split(`
`),s="",r=0,o=0;for(let a=0;a<n.length;a++){let c=n[a].trim();c&&c===s?(r++,r>=3&&t.push(`Line ${o}: ${s.substring(0,50)}`)):(s=c,r=1,o=a+1)}return t}function li(e,t){let n=[],s=[];if(/\.(ts|tsx|js|jsx)$/.test(t)){/new Date.*toLocaleDateString/.test(e)&&(n.push("UTILITY: Direct date formatting detected"),n.push("  Use centralized date utilities: import { formatDate } from '@/lib/dates'"));let r=(e.match(/fetch\s*\(\s*['"]/g)||[]).length;r>2&&(s.push(`UTILITY: Multiple fetch calls detected (${r})`),s.push("  Consider using centralized API client or custom hook"));let o=(e.match(/if\s*\([^)]*\.test\([^)]*\)/g)||[]).length;o>3&&(s.push(`UTILITY: Multiple inline validations detected (${o})`),s.push("  Use Zod schemas: const schema = z.object({...})"))}if(t.endsWith(".py")){let r=(e.match(/json\.loads/g)||[]).length;r>3&&(s.push(`UTILITY: Multiple json.loads detected (${r})`),s.push("  Consider centralized JSON handling with error recovery"));let o=(e.match(/os\.getenv|os\.environ/g)||[]).length;o>5&&(s.push(`UTILITY: Multiple environment variable accesses (${o})`),s.push("  Use Settings/Config class with Pydantic validation"))}return{errors:n,warnings:s}}function An(e){let t=e.tool_input?.file_path||"",n=e.tool_input?.content||e.tool_result||"";if(!t||!n)return u();if(!/\.(ts|tsx|js|jsx|py)$/.test(t))return u();let s=[],r=[],o=ci(n,t);if(o.length>0){let p=On()||d(),l=ui(p,/\.(ts|tsx|js|jsx|py)$/);for(let g of o){let y=g.split(/\s+/).pop()||"";if(y){for(let m of l)if(m!==t)try{let _=ii(m,"utf8");if(new RegExp(`\\b${y.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`).test(_)&&_.includes(g)){let Q=m.replace(p+"/","");r.push(`DUPLICATE: '${y}' already exists in:`),r.push(`  - ${Q}`),r.push("  Consider:"),r.push("    1. Reusing existing implementation"),r.push("    2. Extracting to shared utility"),r.push("    3. Using different name if intentionally different");break}}catch{}}}}let a=pi(n);if(a.length>0){r.push("COPY-PASTE: Repeated code blocks detected:");for(let p of a.slice(0,5))r.push(`  ${p}`);r.push("  Refactor repeated logic into functions")}let c=li(n,t);if(s.push(...c.errors),r.push(...c.warnings),s.length>0){let p=`Duplicate code violation in ${t}. See stderr for details.`;return k(p)}if(r.length>0){let p=`Potential code duplication detected in ${t}. Review warnings on stderr.`;return k(p)}return u()}import{existsSync as nt,readFileSync as jn,readdirSync as di}from"node:fs";function En(e){let t=d(),n=[];n.push("::group::LLM Evaluation Summary");let s=`${t}/eval_results.json`;if(nt(s)){n.push("Evaluation results found:");try{let a=jn(s,"utf8"),c=JSON.parse(a);if(typeof c=="object"&&c!==null){for(let[p,l]of Object.entries(c))if(typeof l=="number"){let g=Number.isInteger(l)?l.toString():l.toFixed(2);n.push(`  ${p}: ${g}`)}}}catch{try{let c=jn(s,"utf8").split(`
`).slice(0,20);n.push(...c)}catch{n.push("  (Unable to read file)")}}}let r=`${t}/.deepeval`;if(nt(r)){n.push(""),n.push("DeepEval results directory found");try{let a=di(r).slice(0,5);for(let c of a)n.push(`  ${c}`)}catch{}}let o=`${t}/ragas_results.json`;nt(o)&&(n.push(""),n.push("RAGAS evaluation results found")),n.push(""),n.push("Evaluation complete - review metrics above"),n.push("::endgroup::");for(let a of n)process.stderr.write(a+`
`);return u()}import{existsSync as gi,readFileSync as fi}from"node:fs";import{execSync as mi}from"node:child_process";import{basename as yi}from"node:path";function Hn(e){let t=e.tool_input?.file_path||process.env.CC_TOOL_FILE_PATH||"";if(!t)return u();if(!t.includes("alembic/versions")||!t.endsWith(".py"))return u();if(!gi(t))return u();process.stderr.write(`::group::Migration Validation: ${yi(t)}
`);let n=[],s;try{s=fi(t,"utf8")}catch{return n.push("Cannot read migration file"),k(`Migration validation failed for ${t}`)}s.includes("def upgrade")||n.push("Missing upgrade() function in migration"),s.includes("def downgrade")||n.push("Missing downgrade() function in migration"),/^revision = /m.test(s)||n.push("Missing revision ID in migration");try{mi(`python3 -m py_compile "${t}"`,{encoding:"utf8",timeout:1e4,stdio:["pipe","pipe","pipe"]})}catch{n.push("Python syntax error in migration")}if(n.length>0){process.stderr.write(`::error::Migration validation failed
`);for(let o of n)process.stderr.write(`  - ${o}
`);process.stderr.write(`::endgroup::
`),i("migration-validator",`BLOCKED: ${n[0]}`);let r=`Migration validation failed for ${t}. See stderr for details.`;return k(r)}return process.stderr.write(`Migration file is valid
`),process.stderr.write(`::endgroup::
`),u()}import{appendFileSync as hi,mkdirSync as _i}from"node:fs";function Fn(e){let t=w(),n=`${t}/review-summary.log`;try{_i(t,{recursive:!0})}catch{}let r=`[${new Date().toISOString().replace("T"," ").slice(0,19)}] Code Review Summary
Review checklist:
  [ ] All blocking issues addressed
  [ ] Non-blocking suggestions noted
  [ ] Tests pass
  [ ] No security concerns
  [ ] Documentation updated if needed

Conventional comment prefixes used:
  - blocking: Must fix before merge
  - suggestion: Consider this improvement
  - nitpick: Minor style issue
  - question: Needs clarification
  - praise: Good work!
`;try{hi(n,r+`
`)}catch{}return u()}import{appendFileSync as Si,mkdirSync as ki}from"node:fs";function Nn(e){let t=w(),n=`${t}/security-summary.log`;try{ki(t,{recursive:!0})}catch{}let r=`[${new Date().toISOString().replace("T"," ").slice(0,19)}] Security Scan Complete
Review findings for:
  - Critical/High vulnerabilities (fix immediately)
  - Dependency CVEs (update packages)
  - Hardcoded secrets (move to env vars)
  - OWASP Top 10 violations

Next steps:
  1. Triage findings by severity
  2. Create issues for critical/high
  3. Update dependencies with CVEs
`;try{Si(n,r+`
`)}catch{}return u()}function bi(e){return!!(/\.(test|spec)\.(ts|tsx|js|jsx)$/.test(e)||/(^|\/)test_[^/]*\.py$/.test(e)||/_test\.py$/.test(e))}function Mn(e){let t=e.tool_input?.file_path||"",n=e.tool_input?.content||e.tool_result||"";if(!t||!n)return u();if(!bi(t))return u();let s=[];if(/\.(ts|tsx|js|jsx)$/.test(t)){let r=n.match(/(test|it)\(['"][^'"]{1,10}['"]/g);r&&r.some(p=>/test[0-9]|works|^test$/i.test(p))&&(s.push("Test names too short or generic. Use descriptive names:"),s.push("  BAD:  test('test1'), test('works')"),s.push("  GOOD: test('should return user when ID exists')")),/^let [a-zA-Z_][a-zA-Z0-9_]* =/m.test(n)&&(/beforeEach\s*\(\s*(async\s*)?\(\s*\)\s*=>/.test(n)||(s.push("Shared mutable state detected without beforeEach reset:"),s.push("  Add beforeEach(() => { /* reset state */ }) to ensure test isolation")));let o=(n.match(/expect\(/g)||[]).length,a=(n.match(/(test|it)\s*\(/g)||[]).length||1,c=Math.floor(o/a);c>5&&(s.push(`High assertion count (avg ${c} per test):`),s.push("  Consider splitting into focused tests with 1-3 assertions each"),s.push("  Or add AAA comments (// Arrange, // Act, // Assert)")),/console\.(log|warn|error)\(/.test(n)&&(s.push("console.log found in test file:"),s.push("  Remove debugging statements before committing"),s.push("  Use proper assertions instead")),/(test|it|describe)\.only\(/.test(n)&&(s.push(".only() found - this skips other tests:"),s.push("  Remove .only() before committing")),/(test|it|describe)\.skip\(/.test(n)&&(/TODO|FIXME|skip.*because|temporarily/i.test(n)||(s.push(".skip() found without explanation:"),s.push("  Add a comment explaining why the test is skipped"),s.push("  Example: test.skip('reason: waiting for API fix')")))}return t.endsWith(".py")&&(/def test[A-Z]/.test(n)&&(s.push("Test names must use snake_case, not camelCase:"),s.push("  BAD:  def testUserCreation()"),s.push("  GOOD: def test_user_creation()")),/def (setUp|tearDown|setUpClass|tearDownClass)\s*\(/.test(n)&&(s.push("Use pytest fixtures instead of unittest setUp/tearDown:"),s.push("  BAD:  def setUp(self): ..."),s.push("  GOOD: @pytest.fixture\\n        def setup_data(): ...")),/class Test.*:/.test(n)&&(/^\s+[a-z_]+ = \[\]/m.test(n)||/^\s+[a-z_]+ = \{\}/m.test(n))&&(s.push("Class-level mutable defaults can cause test pollution:"),s.push("  BAD:  class TestUser:\\n            items = []"),s.push("  GOOD: Use @pytest.fixture to create fresh instances")),/^\s+print\(/m.test(n)&&(s.push("print() found in test file:"),s.push("  Remove debugging statements before committing"),s.push("  Use proper assertions or pytest's capfd fixture")),(/@pytest\.mark\.skip\s*$/.test(n)||/@pytest\.mark\.skip\(\s*\)/.test(n))&&(s.push("@pytest.mark.skip without reason:"),s.push("  Add reason: @pytest.mark.skip(reason='waiting for fix')")),/async def test_/.test(n)&&(/@pytest\.mark\.asyncio/.test(n)||(s.push("Async test found without @pytest.mark.asyncio:"),s.push("  Add: @pytest.mark.asyncio"),s.push("  Or set asyncio_mode = auto in pytest.ini")))),s.length>0?(i("test-pattern-validator",`BLOCKED: ${s[0]}`),O(`Test pattern violations detected in ${t}`)):u()}import{existsSync as Un}from"node:fs";import{execSync as z}from"node:child_process";import{basename as st,dirname as rt}from"node:path";function wi(e){let t=e;for(;t!=="/";){if(Un(`${t}/package.json`))return t;t=rt(t)}return null}function Ln(e){let t=e.tool_input?.file_path||process.env.CC_TOOL_FILE_PATH||"";if(!t)return u();if(/test.*\.py$/.test(t)||/_test\.py$/.test(t)){process.stderr.write(`::group::Auto-running Python test: ${st(t)}
`);let n=rt(t);try{if(Un(`${n}/pyproject.toml`))try{z("command -v poetry",{stdio:["pipe","pipe","pipe"]});let r=z(`poetry run pytest "${t}" -v --tb=short`,{cwd:n,encoding:"utf8",timeout:6e4,stdio:["pipe","pipe","pipe"]}).split(`
`).slice(-30);process.stderr.write(r.join(`
`)+`
`)}catch{}try{z("command -v pytest",{stdio:["pipe","pipe","pipe"]});let r=z(`pytest "${t}" -v --tb=short`,{cwd:n,encoding:"utf8",timeout:6e4,stdio:["pipe","pipe","pipe"]}).split(`
`).slice(-30);process.stderr.write(r.join(`
`)+`
`)}catch{process.stderr.write(`pytest not found - skipping auto-run
`)}}catch(s){s instanceof Error&&process.stderr.write(`Test execution error: ${s.message}
`)}process.stderr.write(`::endgroup::
`)}if(/\.(test|spec)\.(ts|tsx|js|jsx)$/.test(t)){process.stderr.write(`::group::Auto-running TypeScript test: ${st(t)}
`);let n=wi(rt(t));if(n)try{let s=st(t).replace(/\.[^.]+$/,"").replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),o=z(`npm test -- --testPathPattern="${s}"`,{cwd:n,encoding:"utf8",timeout:6e4,stdio:["pipe","pipe","pipe"]}).split(`
`).slice(-30);process.stderr.write(o.join(`
`)+`
`)}catch(s){s instanceof Error&&process.stderr.write(`Test execution error: ${s.message}
`)}process.stderr.write(`::endgroup::
`)}return u()}var Wn=[{name:"auto-save-context",fn:X},{name:"session-patterns",fn:ge},{name:"issue-work-summary",fn:se},{name:"calibration-persist",fn:me},{name:"session-profile-aggregator",fn:yn},{name:"session-end-tracking",fn:Se},{name:"graph-queue-sync",fn:be},{name:"workflow-preference-learner",fn:we},{name:"mem0-queue-sync",fn:In},{name:"mem0-pre-compaction-sync",fn:re},{name:"multi-instance-cleanup",fn:ae},{name:"cleanup-instance",fn:ee},{name:"task-completion-check",fn:fe},{name:"context-compressor",fn:te},{name:"auto-remember-continuity",fn:Y},{name:"security-scan-aggregator",fn:ce},{name:"coverage-check",fn:Rn},{name:"evidence-collector",fn:Dn},{name:"coverage-threshold-gate",fn:Tn},{name:"cross-instance-test-validator",fn:Cn},{name:"di-pattern-enforcer",fn:Pn},{name:"duplicate-code-detector",fn:An},{name:"eval-metrics-collector",fn:En},{name:"migration-validator",fn:Hn},{name:"review-summary-generator",fn:Fn},{name:"security-summary",fn:Nn},{name:"test-pattern-validator",fn:Mn},{name:"test-runner",fn:Ln},{name:"full-test-suite",fn:ne}];async function qn(e){if(e.stop_hook_active)return i("stop-dispatcher","Skipping: stop_hook_active=true (re-entry prevention)"),u();let n=(await Promise.allSettled(Wn.map(async s=>{try{let r=s.fn(e);return r instanceof Promise&&await r,{hook:s.name,status:"success"}}catch(r){let o=r instanceof Error?r.message:String(r);return i("stop-dispatcher",`${s.name} failed: ${o}`),{hook:s.name,status:"error",message:o}}}))).filter(s=>s.status==="rejected"||s.status==="fulfilled"&&s.value.status==="error");return n.length>0&&i("stop-dispatcher",`${n.length}/${Wn.length} hooks had errors`),u()}var Gn={"stop/auto-remember-continuity":Y,"stop/auto-save-context":X,"stop/cleanup-instance":ee,"stop/context-compressor":te,"stop/full-test-suite":ne,"stop/issue-work-summary":se,"stop/mem0-pre-compaction-sync":re,"stop/multi-instance-cleanup":ae,"stop/security-scan-aggregator":ce,"stop/session-patterns":ge,"stop/task-completion-check":fe,"stop/calibration-persist":me,"stop/unified-dispatcher":qn,"stop/workflow-preference-learner":we,"stop/graph-queue-sync":be,"stop/session-end-tracking":Se};function wl(e){return Gn[e]}function vl(){return Object.keys(Gn)}export{wt as applyDecay,ra as escapeRegex,ks as estimateTokenCount,pa as getAdjustments,la as getAgentSuccessRate,Gi as getCachedBranch,da as getCalibrationStats,qi as getEnvFile,na as getField,wl as getHook,w as getLogDir,ms as getLogLevel,Oe as getPluginRoot,d as getProjectDir,f as getSessionId,ga as hasMinimalCalibrationData,Rs as hashPrompt,Gn as hooks,xi as isBashInput,Ii as isEditInput,Ri as isReadInput,$i as isWriteInput,vl as listHooks,R as loadCalibrationData,i as logHook,Xi as logPermissionFeedback,sa as normalizeCommand,Ji as normalizeLineEndings,Qi as outputAllowWithContext,O as outputBlock,Ki as outputDeny,Zi as outputError,hs as outputPromptContext,ea as outputPromptContextBudgeted,Bi as outputSilentAllow,u as outputSilentSuccess,Vi as outputWarning,k as outputWithContext,zi as outputWithNotification,Yi as outputWithUpdatedInput,ta as readHookInput,ua as recordOutcome,je as saveCalibrationData,ys as shouldLog};
//# sourceMappingURL=stop.mjs.map
