// OrchestKit Hooks - setup bundle
// Generated: 2026-02-28T13:40:06.913Z

function En(e){return typeof e.command=="string"}function _n(e){return typeof e.file_path=="string"&&typeof e.content=="string"}function xn(e){return typeof e.file_path=="string"&&typeof e.old_string=="string"&&typeof e.new_string=="string"}function Rn(e){return typeof e.file_path=="string"&&e.content===void 0}import{existsSync as N,statSync as pt,renameSync as lt,mkdirSync as _e,readSync as ft,readFileSync as gt,writeFileSync as dt}from"node:fs";import{join as mt}from"node:path";import{appendFileSync as Ve,mkdirSync as Ke}from"node:fs";import{dirname as Je}from"node:path";var H=[],Z=!1,me=!1;function Q(e,t){H.push({filePath:e,content:t}),qe()}function Y(){if(Z||H.length===0)return;Z=!0;let e=new Map;for(let t of H){let n=e.get(t.filePath);n?n.push(t.content):e.set(t.filePath,[t.content])}for(let[t,n]of e)try{Ke(Je(t),{recursive:!0}),Ve(t,n.join(""))}catch{}H.length=0,Z=!1}function qe(){me||(me=!0,process.on("exit",Y),process.on("SIGTERM",()=>{Y(),process.exit(0)}),process.on("SIGINT",()=>{Y(),process.exit(0)}))}import{execSync as ht}from"node:child_process";import he from"node:os";import P from"node:path";function ee(){return process.env.HOME||process.env.USERPROFILE||he.homedir()}function ke(){return he.tmpdir()}function te(){return process.env.CLAUDE_PROJECT_DIR||"."}function ye(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function Se(){return process.env.CLAUDE_PLUGIN_ROOT?P.join(ee(),".claude","logs","ork"):P.join(te(),".claude","logs")}var Hn=P.join,Pn=P.sep;import{execSync as Be}from"node:child_process";import{createHash as ze}from"node:crypto";import{existsSync as ve,readFileSync as Ge,writeFileSync as Xe,mkdirSync as Ze}from"node:fs";import{join as ne,basename as Ye}from"node:path";var Qe=20,et=15,tt=/[^a-z0-9-]/g;function nt(e){let t=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=Ye(t);return $e(n,Qe)}function ot(e){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let t=e||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=Be("git branch --show-current",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),o=$e(n||"detached",et);return process.env.ORCHESTKIT_SESSION_BRANCH=o,o}catch{return"nobranch"}}function rt(e){let t=e||new Date,n=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${n}${o}`}function st(e){let t=e||new Date,n=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0");return`${n}${o}`}function it(){let e=`${process.pid}-${Date.now()}-${Math.random()}`;return ze("sha256").update(e).digest("hex").slice(0,4)}function $e(e,t){return e.toLowerCase().replace(tt,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,t)}function ct(e,t){let n=nt(e),o=ot(e),r=rt(t),c=st(t),i=it();return`${n}-${o}-${r}-${c}-${i}`}function at(e){let t=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=ne(t,".instance","session-id.json");if(ve(n))try{let o=JSON.parse(Ge(n,"utf8"));if(o.session_id&&o.created_at){let r=Date.now()-new Date(o.created_at).getTime(),c=1440*60*1e3;if(r<c)return o.session_id}}catch{}}function ut(e,t){let n=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),o=ne(n,".instance"),r=ne(o,"session-id.json");try{ve(o)||Ze(o,{recursive:!0}),Xe(r,JSON.stringify({session_id:e,created_at:new Date().toISOString()},null,2))}catch{}}function Ce(e){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let t=at(e);if(t)return t;let n=ct(e);return ut(n,e),n}function xe(){return Se()}function E(){return te()}function y(){return ye()}function Bn(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${y()}/.claude/.instance_env`}function oe(){return Ce()}function zn(e){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let t=ht("git branch --show-current",{cwd:e||E(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=t,t}catch{return"unknown"}}function kt(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Gn(e){return e.replace(/\r\n/g,`
`)}function yt(e){let t=["debug","info","warn","error"];return t.indexOf(e)>=t.indexOf(kt())}function g(){return{continue:!0,suppressOutput:!0}}function Xn(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function Zn(e){return{continue:!1,stopReason:e,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:e}}}function d(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:e}}}function St(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:e}}}function Yn(e,t){let n={continue:!0,suppressOutput:!0};return e&&(n.systemMessage=e),t&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:t}),n}function Qn(e,t){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:e,permissionDecision:"allow"}};return t?n.systemMessage=t:n.suppressOutput=!0,n}function eo(e){return{continue:!0,systemMessage:e}}function to(e){return{continue:!0,systemMessage:`\u26A0 ${e}`}}function no(e){process.stderr.write(`\u26A0 ${e}
`),process.exit(2)}function oo(e){return{continue:!1,stopReason:e,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:e}}}function ro(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:e}}}var vt=200*1024,$t=100*1024;function Re(e,t){if(N(e))try{if(pt(e).size>t){let o=`${e}.old.${Date.now()}`;lt(e,o)}}catch{}}function De(e){N(e)||_e(e,{recursive:!0})}function s(e,t,n="debug"){if(!yt(n))return;let o=xe(),r=`${o}/hooks.log`;try{De(o),Re(r,vt);let c=new Date().toISOString().replace("T"," ").slice(0,19);Q(r,`[${c}] [${n.toUpperCase()}] [${e}] ${t}
`)}catch{}}function so(e,t,n){let o=xe(),r=`${o}/permission-feedback.log`;try{De(o),Re(r,$t);let c=new Date().toISOString(),i=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",a=n?.session_id||oe();Q(r,`${c} | ${e} | ${t} | tool=${i} | session=${a}
`)}catch{}}function be(e){return e.hookSpecificOutput?.additionalContext?e.hookSpecificOutput.additionalContext:e.systemMessage&&typeof e.systemMessage=="string"?e.systemMessage:null}function Ct(e){if(!e)return 0;let o=(e.match(/[{};()=><]/g)||[]).length/e.length>.03?2.8:3.5;return Math.ceil(e.length/o)}function io(e,t,n,o,r){let c=Ct(e);return o?.isOverBudget(n)?(s(t,`Budget exhausted for ${n}, suppressing ${c}t`),g()):(r&&r.trackTokenUsage(t,n,c),St(e))}function Ee(e){let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return(t>>>0).toString(16).padStart(8,"0")}function co(e,t,n,o){let r=mt(e,t);if(N(r))try{let c=gt(r,"utf8");if(Ee(c)===Ee(n))return s(o,`Rules file ${t} unchanged, skipping write`),!1}catch{}return N(e)||_e(e,{recursive:!0}),dt(r,n,"utf8"),s(o,`Wrote rules file: ${r}`),!0}function ao(){try{let e=[],n=Buffer.allocUnsafe(256),o,r=0;for(;;)try{if(o=ft(r,n,0,256,null),o===0)break;e.push(Buffer.from(n.subarray(0,o)))}catch{break}let c=Buffer.concat(e).toString("utf8").trim();return c?JSON.parse(c):{tool_name:"",session_id:oe(),tool_input:{}}}catch{return{tool_name:"",session_id:oe(),tool_input:{}}}}function uo(e,t){let n=t.replace(/^\./,"").split("."),o=e;for(let r of n){if(o==null)return;o=o[r]}return o}function po(e,...t){return e.split(`
`).some(n=>t.every(o=>n.includes(o)))}function lo(e,...t){return e.split(`
`).some(n=>{let o=n.toLowerCase();return t.every(r=>o.includes(r.toLowerCase()))})}function fo(e){return e.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function go(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}import{existsSync as _,readFileSync as se,writeFileSync as Et,mkdirSync as _t}from"node:fs";var xt=[{package:"lodash",pattern:"<4.17.21",severity:"high",cve:"CVE-2021-23337",description:"Prototype pollution"},{package:"minimist",pattern:"<1.2.6",severity:"critical",cve:"CVE-2021-44906",description:"Prototype pollution"},{package:"node-fetch",pattern:"<2.6.7",severity:"high",cve:"CVE-2022-0235",description:"Information exposure"},{package:"axios",pattern:"<0.21.2",severity:"high",cve:"CVE-2021-3749",description:"ReDoS vulnerability"},{package:"jsonwebtoken",pattern:"<9.0.0",severity:"critical",cve:"CVE-2022-23529",description:"Insecure token verification"},{package:"express",pattern:"<4.17.3",severity:"medium",cve:"CVE-2022-24999",description:"Open redirect"},{package:"tar",pattern:"<6.1.11",severity:"critical",cve:"CVE-2021-37701",description:"Arbitrary file overwrite"},{package:"path-parse",pattern:"<1.0.7",severity:"medium",cve:"CVE-2021-23343",description:"ReDoS vulnerability"},{package:"django",pattern:"<3.2.14",severity:"high",cve:"CVE-2022-34265",description:"SQL injection"},{package:"flask",pattern:"<2.0.2",severity:"medium",cve:"CVE-2021-28091",description:"Path traversal"},{package:"requests",pattern:"<2.28.0",severity:"medium",cve:"CVE-2023-32681",description:"Information disclosure"},{package:"urllib3",pattern:"<1.26.5",severity:"high",cve:"CVE-2021-33503",description:"ReDoS vulnerability"},{package:"pillow",pattern:"<9.0.0",severity:"high",cve:"CVE-2022-22817",description:"Buffer overflow"},{package:"pyyaml",pattern:"<5.4",severity:"critical",cve:"CVE-2020-14343",description:"Arbitrary code execution"},{package:"jinja2",pattern:"<3.0.3",severity:"medium",cve:"CVE-2020-28493",description:"XSS vulnerability"},{package:"sqlalchemy",pattern:"<1.4.46",severity:"medium",cve:"CVE-2023-30533",description:"SQL injection"}],Rt=24;function Dt(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function bt(e,t){let n=e.split(".").map(r=>parseInt(r,10)||0),o=t.split(".").map(r=>parseInt(r,10)||0);for(let r=0;r<Math.max(n.length,o.length);r++){let c=n[r]||0,i=o[r]||0;if(c<i)return!0;if(c>i)return!1}return!1}function It(e,t){let n=t.charAt(0),o=t.substring(1);return n==="<"?bt(e,o):n==="="?e===o:!1}function Ot(e){return e.replace(/^[^~>=<]/,"").replace(/,.*$/,"").trim()}function Ie(e,t){let n=Ot(t),o=e.toLowerCase();for(let r of xt)if(o===r.package&&It(n,r.pattern))return r;return null}function wt(e){if(!_(e))return null;try{let t=JSON.parse(se(e,"utf-8"));if((Date.now()-t.timestamp)/(1e3*60*60)<Rt)return t.warnings}catch{}return null}function re(e,t){try{_t(e.replace(/\/[^/]+$/,""),{recursive:!0});let n={warnings:t,timestamp:Date.now()};Et(e,JSON.stringify(n,null,2))}catch{}}function Tt(e){let t=0,n=0,o="";if(!_(e))return{criticalCount:t,highCount:n,warnings:o};try{let r=JSON.parse(se(e,"utf-8")),c={...r.dependencies,...r.devDependencies};for(let[i,a]of Object.entries(c)){let u=Ie(i,a);u&&(u.severity==="critical"&&t++,u.severity==="high"&&n++,o+=`
- ${i}@${a}: ${u.description} (${u.cve}, ${u.severity}) - upgrade to ${u.pattern}`)}}catch{}return{criticalCount:t,highCount:n,warnings:o}}function Ht(e){let t=0,n=0,o="";if(!_(e))return{criticalCount:t,highCount:n,warnings:o};try{let c=se(e,"utf-8").split(`
`);for(let i of c){let a=i.trim();if(!a||a.startsWith("#"))continue;let u=a.match(/^([a-zA-Z0-9_-]+)(?:==|>=|~=|!=|<|>)\s*([0-9.]+)/);if(!u)continue;let[,l,f]=u,p=Ie(l,f);p&&(p.severity==="critical"&&t++,p.severity==="high"&&n++,o+=`
- ${l}==${f}: ${p.description} (${p.cve}, ${p.severity}) - upgrade to ${p.pattern}`)}}catch{}return{criticalCount:t,highCount:n,warnings:o}}function Oe(e){if(Dt())return s("dependency-version-check","Skipping dependency check (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),g();s("dependency-version-check","Starting dependency version check");let t=e.project_dir||E(),n=`${t}/.claude/feedback/dependency-check-cache.json`,o=_(`${t}/package.json`),r=_(`${t}/requirements.txt`),c=_(`${t}/pyproject.toml`),i=_(`${t}/go.mod`);if(!o&&!r&&!c&&!i)return s("dependency-version-check","No package files found, skipping check"),re(n,"none"),g();let a=wt(n);if(a!==null)return s("dependency-version-check","Using cached dependency warnings"),a!=="none"?d(`DEPENDENCY SECURITY CHECK (cached): ${a}`):g();let u=0,l=0,f="";if(o){let p=Tt(`${t}/package.json`);u+=p.criticalCount,l+=p.highCount,p.warnings&&(f+=`

Node.js (package.json):${p.warnings}`)}if(r){let p=Ht(`${t}/requirements.txt`);u+=p.criticalCount,l+=p.highCount,p.warnings&&(f+=`

Python (requirements.txt):${p.warnings}`)}if(f){let p=`Found ${u} critical and ${l} high severity vulnerabilities`,m=`DEPENDENCY SECURITY CHECK: ${p}${f}

Run 'npm audit' or 'pip-audit' for full details.`;if(re(n,m),s("dependency-version-check",p),u>0||l>0)return d(m)}else re(n,"none"),s("dependency-version-check","No known vulnerabilities found");return g()}var A=[{name:"dependency-version-check",fn:Oe}];async function M(e){s("setup-dispatcher",`Running ${A.length} Setup hooks in parallel`);let t=await Promise.allSettled(A.map(async o=>{try{let r=o.fn(e);return r instanceof Promise&&await r,{hook:o.name,status:"success"}}catch(r){let c=r instanceof Error?r.message:String(r);return s("setup-dispatcher",`${o.name} failed: ${c}`),{hook:o.name,status:"error",message:c}}})),n=[];for(let o of t)o.status==="rejected"?n.push("unknown"):o.value.status==="error"&&n.push(o.value.hook);return n.length>0?s("setup-dispatcher",`${n.length}/${A.length} hooks failed: ${n.join(", ")}`):s("setup-dispatcher",`All ${A.length} Setup hooks completed successfully`),g()}import{existsSync as we,mkdirSync as Pt,writeFileSync as Te,readdirSync as ce,chmodSync as Nt}from"node:fs";import{execSync as v}from"node:child_process";var ie="4.25.0";function At(){s("first-run-setup","Phase 1: Detecting environment");let e={os:process.platform};try{let n=v("python3 --version",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}).match(/(\d+\.\d+)/);n&&(e.python=n[1],s("first-run-setup",`Python: ${n[1]}`))}catch{}try{let n=v("node --version",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}).match(/(\d+\.\d+)/);n&&(e.nodejs=n[1],s("first-run-setup",`Node.js: ${n[1]}`))}catch{}try{v("which git",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),e.git=!0,s("first-run-setup","Git: available")}catch{}try{v("which docker",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),e.docker=!0,s("first-run-setup","Docker: available")}catch{}try{v("which sqlite3",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),e.sqlite3=!0,s("first-run-setup","SQLite3: available (multi-instance coordination enabled)")}catch{}return e}function Mt(){s("first-run-setup","Phase 2: Validating dependencies");let e=[],t=[];try{v("which jq",{encoding:"utf8",stdio:["pipe","pipe","pipe"]})}catch{e.push("jq (required for JSON processing)")}try{v("which sqlite3",{encoding:"utf8",stdio:["pipe","pipe","pipe"]})}catch{t.push("sqlite3 not found - multi-instance coordination disabled")}try{v('python3 -c "import anthropic"',{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),s("first-run-setup","Anthropic SDK: available (Memory Fabric Agent enabled)")}catch{t.push("anthropic SDK not found - Memory Fabric Agent will use fallback mode"),t.push("  Install with: pip install 'orchestkit[memory]'")}if(e.length>0){s("first-run-setup","ERROR: Missing required dependencies:");for(let n of e)s("first-run-setup",`  - ${n}`)}for(let n of t)s("first-run-setup",`WARN: ${n}`);return{valid:e.length===0,missing:e,warnings:t}}function Ft(e){let t={complete:{preset:"complete",description:"Full AI-assisted development toolkit",features:{skills:!0,agents:!0,hooks:!0,mcp:!0,coordination:!0,statusline:!0},hook_groups:{safety:!0,quality:!0,productivity:!0,observability:!0}},standard:{preset:"standard",description:"Skills and hooks without agent orchestration",features:{skills:!0,agents:!1,hooks:!0,mcp:!0,coordination:!0,statusline:!0},hook_groups:{safety:!0,quality:!0,productivity:!0,observability:!0}},lite:{preset:"lite",description:"Essential skills for constrained environments",features:{skills:!0,agents:!1,hooks:!0,mcp:!1,coordination:!1,statusline:!1},hook_groups:{safety:!0,quality:!0,productivity:!1,observability:!1}},"hooks-only":{preset:"hooks-only",description:"Safety hooks only for pure automation",features:{skills:!1,agents:!1,hooks:!0,mcp:!1,coordination:!1,statusline:!1},hook_groups:{safety:!0,quality:!1,productivity:!1,observability:!1}}};return t[e]||t.complete}function jt(e,t,n){s("first-run-setup",`Phase 4: Applying configuration (preset: ${e})`);let o=Ft(e),r=[`${n}/.claude/defaults`,`${n}/.claude/context/session`,`${n}/.claude/context/knowledge`,`${n}/.claude/logs`];for(let i of r)try{Pt(i,{recursive:!0})}catch{}let c=`${n}/.claude/defaults/config.json`;we(c)||(Te(c,JSON.stringify(o,null,2)),s("first-run-setup",`Created config file: ${c}`));try{let i=`${n}/hooks`;if(we(i)){let a=u=>{try{let l=ce(u,{withFileTypes:!0});for(let f of l){let p=`${u}/${f.name}`;if(f.isDirectory())a(p);else if(f.name.endsWith(".sh"))try{Nt(p,493)}catch{}}}catch{}};a(i),s("first-run-setup","Made hooks executable")}}catch{}return o}function Lt(e,t,n){s("first-run-setup","Phase 5: Creating marker file");let o=new Date().toISOString(),r=0,c=0,i=0;try{let l=(f,p)=>{let m=0,C=S=>{try{let D=ce(S,{withFileTypes:!0});for(let h of D){let w=`${S}/${h.name}`;h.isDirectory()?C(w):p.test(h.name)&&m++}}catch{}};return C(f),m};r=l(`${n}/hooks`,/\.sh$/),c=l(`${n}/skills`,/SKILL\.md$/),i=l(`${n}/agents`,/\.md$/)}catch{}let a={version:ie,setup_date:o,preset:e,components:{hooks:{count:r,valid:!0},skills:{count:c,valid:!0},agents:{count:i,valid:!0}},last_health_check:o,last_maintenance:o,environment:t,user_preferences:{onboarding_completed:!0,mcp_configured:!1,statusline_configured:!1}},u=`${n}/.setup-complete`;Te(u,JSON.stringify(a,null,2)),s("first-run-setup",`Marker file created: ${u}`)}function F(e){let t=y(),n=process.argv.includes("--silent")?"silent":"interactive";s("first-run-setup",`First-run setup starting (mode: ${n})`);let o=At(),{valid:r,missing:c}=Mt();if(!r){s("first-run-setup","ERROR: Dependency validation failed");let p=`OrchestKit setup failed: Missing required dependencies. Install ${c.join(", ")}.`;return d(p)}let i="complete";n==="interactive"?s("first-run-setup","Interactive mode - using complete preset (wizard via Claude conversation)"):s("first-run-setup","Silent mode - using complete preset"),jt(i,o,t),Lt(i,o,t);let a=0,u=0,l=0;try{let p=(m,C)=>{let S=0,D=h=>{try{let w=ce(h,{withFileTypes:!0});for(let X of w){let We=`${h}/${X.name}`;X.isDirectory()?D(We):C.test(X.name)&&S++}}catch{}};return D(m),S};a=p(`${t}/hooks`,/\.sh$/),u=p(`${t}/skills`,/SKILL\.md$/),l=p(`${t}/agents`,/\.md$/)}catch{}s("first-run-setup",`Setup complete: ${u} skills, ${l} agents, ${a} hooks`);let f=n==="interactive"?`OrchestKit v${ie} setup complete! Loaded ${u} skills, ${l} agents, and ${a} hooks. Use /ork:configure to customize settings.`:`OrchestKit v${ie} initialized (silent mode).`;return d(f)}import{existsSync as j,readFileSync as Ut,readdirSync as He}from"node:fs";var Wt=["pnpm-workspace.yaml","lerna.json","nx.json","turbo.json","rush.json"];function Vt(e){let t=0;try{let n=He(e,{withFileTypes:!0});for(let o of n){if(!o.isDirectory()||o.name.startsWith(".")||o.name==="node_modules")continue;let r=`${e}/${o.name}`;j(`${r}/package.json`)&&t++;try{let c=He(r,{withFileTypes:!0});for(let i of c)!i.isDirectory()||i.name.startsWith(".")||i.name==="node_modules"||j(`${r}/${i.name}/package.json`)&&t++}catch{}}}catch{}return t}function L(e){if(s("monorepo-detector","Checking for monorepo structure"),e.added_dirs&&e.added_dirs.length>0){s("monorepo-detector",`${e.added_dirs.length} added_dirs active, surfacing context`);let i=[];for(let a of e.added_dirs)try{let u=`${a}/package.json`;if(j(u)){let l=JSON.parse(Ut(u,"utf8"));l.name&&i.push(l.name)}}catch{}return i.length>0?d(`**Multi-directory context active** (${e.added_dirs.length} dirs)

Packages: ${i.join(", ")}

Each directory may have its own CLAUDE.md with targeted instructions.`):g()}if(process.env.CLAUDE_CODE_ADDITIONAL_DIRECTORIES_CLAUDE_MD==="1")return s("monorepo-detector","CLAUDE_CODE_ADDITIONAL_DIRECTORIES_CLAUDE_MD already set, skipping"),g();let t=e.project_dir||E(),n=[];for(let i of Wt)j(`${t}/${i}`)&&n.push(i);let o=Vt(t);if(!(n.length>0||o>=3))return s("monorepo-detector","No monorepo detected"),g();let c=n.length>0?`Detected: ${n.join(", ")}`:`Found ${o} nested packages`;return s("monorepo-detector",`Monorepo detected: ${c}`),d(`**Monorepo Detected** (${c})

CC 2.1.20 supports multi-directory context with \`--add-dir\`. Each service can have its own CLAUDE.md for targeted instructions.

Set \`CLAUDE_CODE_ADDITIONAL_DIRECTORIES_CLAUDE_MD=1\` to auto-load CLAUDE.md from added directories.`)}import{existsSync as $,readFileSync as ue,readdirSync as Kt,writeFileSync as Jt}from"node:fs";import{spawn as ae}from"node:child_process";var T="4.25.0";function Pe(e,t){if(!$(e))return null;try{let n=JSON.parse(ue(e,"utf-8")),o=t.split("."),r=n;for(let c of o){if(r==null)return null;r=r[c]}return r}catch{return null}}function qt(e){let t=0,n=`${e}/.claude/defaults/config.json`;if($(n))try{JSON.parse(ue(n,"utf-8"))}catch{s("setup-check","WARN: config.json is invalid JSON"),t++}let o=0;if($(`${e}/hooks`))try{let i=(a,u=0)=>{if(u>3)return 0;let l=0;try{let f=Kt(a,{withFileTypes:!0});for(let p of f.slice(0,100)){let m=`${a}/${p.name}`;p.isDirectory()&&!p.name.startsWith(".")?l+=i(m,u+1):p.name.endsWith(".sh")&&l++}}catch{}return l};o=i(`${e}/hooks`)}catch{}o<10&&s("setup-check",`WARN: Only ${o} hooks found (expected 50+)`);let r=`${e}/.setup-complete`,c=Pe(r,"version");return c&&c!==T?(s("setup-check",`INFO: Version mismatch - marker: ${c}, current: ${T}`),2):t}function Bt(e){let t=Pe(e,"last_maintenance");if(!t)return!0;try{let n=new Date(t).getTime();return(Date.now()-n)/(1e3*60*60)>=24}catch{return!0}}function zt(e,t,n){if($(e))try{let o=JSON.parse(ue(e,"utf-8"));o[t]=n,Jt(e,JSON.stringify(o,null,2))}catch{}}function U(e){if(process.env.ORCHESTKIT_SKIP_SETUP==="1"||process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1")return g();let t=y(),n=`${t}/.setup-complete`,o=`${t}/hooks/setup`;s("setup-check",`Setup check starting (v${T})`);let r=process.argv;if(r.includes("--init")||r.includes("init"))return s("setup-check","Explicit --init: Running full setup"),{continue:!0,systemMessage:"Running first-run setup..."};if(r.includes("--init-only")||r.includes("init-only"))return s("setup-check","CI/CD mode (--init-only): Running silent setup"),{continue:!0,systemMessage:"Running silent setup..."};if(r.includes("--maintenance")||r.includes("maintenance"))return s("setup-check","Explicit --maintenance: Running maintenance tasks"),{continue:!0,systemMessage:"Running maintenance tasks..."};if(!$(n))return s("setup-check","No marker file found - first run detected"),(e.hook_event||process.env.HOOK_EVENT)==="Setup"?{continue:!0,systemMessage:"First run detected. Running setup..."}:d("OrchestKit setup not complete. Run 'claude --init' to configure the plugin.");switch(s("setup-check","Marker file exists - running quick validation"),qt(t)){case 0:if(Bt(n)){s("setup-check","Maintenance due - queueing background tasks");let i=`${o}/setup-maintenance.sh`;$(i)&&ae(i,["--background"],{detached:!0,stdio:"ignore"}).unref()}return s("setup-check","Setup check passed (fast path)"),g();case 1:{s("setup-check","Validation failed - triggering self-healing repair");let i=`${o}/setup-repair.sh`;return $(i)&&ae(i,[],{detached:!0,stdio:"ignore"}).unref(),d("OrchestKit setup validation failed. Repair running in background.")}case 2:{s("setup-check","Version mismatch - running migration");let i=`${o}/setup-maintenance.sh`;return $(i)&&ae(i,["--migrate"],{detached:!0,stdio:"ignore"}).unref(),zt(n,"version",T),d(`OrchestKit upgraded to v${T}.`)}default:return g()}}import{existsSync as x,mkdirSync as Gt,readFileSync as le,writeFileSync as Xt,renameSync as Ne,readdirSync as b,unlinkSync as fe,rmSync as Zt,statSync as I,chmodSync as Yt}from"node:fs";import{execSync as pe}from"node:child_process";function W(){return!!(process.env.CLAUDE_CODE_TEAM_NAME||process.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS==="1")}var V="4.25.0",k=[];function Ae(e,t){if(!x(e))return null;try{return JSON.parse(le(e,"utf-8"))[t.replace(/^\./,"")]}catch{return null}}function ge(e,t,n){if(x(e))try{let o=JSON.parse(le(e,"utf-8"));o[t.replace(/^\./,"")]=n,Xt(e,JSON.stringify(o,null,2))}catch{}}function Qt(e){if(!e)return 999;try{let t=new Date(e).getTime();return(Date.now()-t)/(1e3*60*60)}catch{return 999}}function en(e){s("setup-maintenance","Task: Log rotation");let t=[`${e}/.claude/logs`,`${ee()}/.claude/logs/ork`],n=0;for(let o of t)if(x(o))try{let r=b(o);for(let i of r){if(!i.endsWith(".log"))continue;let a=`${o}/${i}`;try{if(I(a).size>204800){let l=`${a}.old.${Date.now()}`;Ne(a,l),n++;try{pe(`gzip "${l}"`,{stdio:["pipe","pipe","pipe"]})}catch{}}}catch{}}let c=r.filter(i=>i.includes(".log.old.")).sort().reverse();for(let i of c.slice(5))try{fe(`${o}/${i}`)}catch{}}catch{}n>0&&k.push(`Rotated ${n} log files`)}function tn(e){s("setup-maintenance","Task: Stale lock cleanup");let t=`${e}/.claude/coordination/.claude.db`,n=0;if(x(t)&&!W())try{pe(`sqlite3 "${t}" "DELETE FROM file_locks WHERE datetime(acquired_at) < datetime('now', '-24 hours');"`,{timeout:5e3,stdio:["pipe","pipe","pipe"]});let o=pe(`sqlite3 "${t}" "SELECT COUNT(*) FROM file_locks;"`,{encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();s("setup-maintenance",`Coordination locks remaining: ${o}`),n=1}catch{}try{let o=(r,c=0)=>{if(!(c>3))try{let i=b(r,{withFileTypes:!0});for(let a of i){let u=`${r}/${a.name}`;if(a.isDirectory()&&!a.name.startsWith("."))o(u,c+1);else if(a.name.endsWith(".lock"))try{let l=I(u);(Date.now()-l.mtimeMs)/(1e3*60*60)>24&&(fe(u),n++)}catch{}}}catch{}};o(e)}catch{}n>0&&k.push("Cleaned stale locks")}function nn(e){s("setup-maintenance","Task: Session cleanup");let t=`${e}/.claude/context/sessions`,n=`${e}/.claude/context/archive`;if(!x(t))return;let o=0;try{Gt(n,{recursive:!0});let c=b(t,{withFileTypes:!0});for(let i of c){if(!i.isDirectory())continue;let a=`${t}/${i.name}`;try{let u=I(a);(Date.now()-u.mtimeMs)/(1e3*60*60*24)>7&&(Ne(a,`${n}/${i.name}`),o++)}catch{}}}catch{}let r=ke();try{let c=b(r);for(let i of c){if(!i.startsWith("claude-session-"))continue;let a=`${r}/${i}`;try{let u=I(a);(Date.now()-u.mtimeMs)/(1e3*60*60*24)>7&&u.isDirectory()&&Zt(a,{recursive:!0,force:!0})}catch{}}}catch{}o>0&&k.push(`Archived ${o} old sessions`)}function on(e){s("setup-maintenance","Task: Memory Fabric cleanup");let t=0,n=`${e}/.claude/logs`;if(x(n))try{let o=b(n);for(let r of o){if(!r.startsWith(".pending-sync-"))continue;let c=`${n}/${r}`;try{let i=I(c);(Date.now()-i.mtimeMs)/(1e3*60*60*24)>7&&(fe(c),t++)}catch{}}}catch{}t>0&&k.push(`Cleaned ${t} Memory Fabric files`)}function rn(e,t){s("setup-maintenance","Task: Full health validation");let n=0,o=0,r=(i,a=0)=>{if(!(a>4))try{let u=b(i,{withFileTypes:!0});for(let l of u){let f=`${i}/${l.name}`;if(l.isDirectory()&&!l.name.startsWith("."))r(f,a+1);else if(l.name.endsWith(".sh"))try{I(f).mode&73||(Yt(f,493),o++)}catch{}}}catch{}};r(`${e}/hooks`),o>0&&(s("setup-maintenance",`WARN: ${o} hooks were not executable`),n++);let c=`${e}/.claude/defaults/config.json`;if(x(c))try{JSON.parse(le(c,"utf-8"))}catch{s("setup-maintenance","WARN: config.json is invalid"),n++}ge(t,"last_health_check",new Date().toISOString()),n===0?k.push("Health validation passed"):k.push(`Health validation found ${n} issues (auto-fixed)`)}function sn(e){s("setup-maintenance","Task: Version migration");let t=Ae(e,"version");!t||t===V||(s("setup-maintenance",`Migrating from ${t} to ${V}`),ge(e,"version",V),k.push(`Migrated from ${t} to ${V}`))}function K(e){let t=y(),n=e.project_dir||E(),o=`${t}/.setup-complete`,r=process.argv,c="auto";r.includes("--force")?c="force":r.includes("--migrate")?c="migrate":r.includes("--background")&&(c="background"),s("setup-maintenance",`Maintenance starting (mode: ${c})`);let i=new Date().toISOString(),a=Ae(o,"last_maintenance"),u=Qt(a),l=!1,f=!1;switch(c){case"force":l=!0,f=!0;break;case"migrate":sn(o);break;case"background":case"auto":u>=24&&(l=!0),u>=168&&(f=!0);break}if(l&&(s("setup-maintenance","Running daily maintenance tasks"),en(t),tn(t),nn(t),on(n)),f&&(s("setup-maintenance","Running weekly maintenance tasks"),rn(t,o)),ge(o,"last_maintenance",i),k.length>0){s("setup-maintenance",`Maintenance complete: ${k.length} tasks`);let p=`Completed: ${k.join(", ")}`;return c==="background"?g():d(`Maintenance: ${p}`)}return s("setup-maintenance","No maintenance tasks needed"),g()}import{existsSync as de,mkdirSync as Me,readFileSync as cn,writeFileSync as Fe,renameSync as an,readdirSync as q,statSync as un,chmodSync as pn}from"node:fs";var ln="4.25.0",R=[],J=[],B=!1;function fn(e){let t=`${e}/.claude/defaults/config.json`,n=`${e}/.claude/defaults`;try{Me(n,{recursive:!0})}catch{}if(de(t))try{JSON.parse(cn(t,"utf-8"));return}catch{let r=`${t}.corrupt.${Date.now()}`;try{an(t,r),s("setup-repair",`Backed up corrupt config to ${r}`),B=!0}catch{}}Fe(t,JSON.stringify({preset:"complete",description:"Full AI-assisted development toolkit (restored by repair)",features:{skills:!0,agents:!0,hooks:!0,mcp:!0,coordination:!0,statusline:!0},hook_groups:{safety:!0,quality:!0,productivity:!0,observability:!0}},null,2)),R.push("config.json restored"),s("setup-repair","Restored default config.json")}function gn(e){let t=0,n=(o,r=0)=>{if(!(r>5))try{let c=q(o,{withFileTypes:!0});for(let i of c){let a=`${o}/${i.name}`;if(i.isDirectory()&&!i.name.startsWith("."))n(a,r+1);else if(i.name.endsWith(".sh"))try{un(a).mode&73||(pn(a,493),t++)}catch{}}}catch{}};n(`${e}/hooks`),t>0&&(R.push(`${t} hook permissions fixed`),s("setup-repair",`Fixed permissions on ${t} hooks`))}function dn(e){let t=0,n=[`${e}/.claude/defaults`,`${e}/.claude/context/session`,`${e}/.claude/context/knowledge`,`${e}/.claude/logs`,...W()?[]:[`${e}/.claude/coordination`]];for(let o of n)if(!de(o))try{Me(o,{recursive:!0}),t++}catch{}t>0&&(R.push(`${t} directories created`),s("setup-repair",`Created ${t} missing directories`))}function mn(e){let t=new Date().toISOString(),n=0,o=0,r=0,c=(u,l,f=5)=>{let p=0,m=(C,S)=>{if(!(S>f))try{let D=q(C,{withFileTypes:!0});for(let h of D){let w=`${C}/${h.name}`;h.isDirectory()&&!h.name.startsWith(".")?m(w,S+1):l.test(h.name)&&p++}}catch{}};return m(u,0),p};try{n=c(`${e}/hooks`,/\.sh$/),o=c(`${e}/skills`,/SKILL\.md$/),r=c(`${e}/agents`,/\.md$/)}catch{}let i={version:ln,setup_date:t,preset:"complete",repaired_at:t,components:{hooks:{count:n,valid:!0},skills:{count:o,valid:!0},agents:{count:r,valid:!0}},last_health_check:t,last_maintenance:t,environment:{os:process.platform},user_preferences:{onboarding_completed:!0,mcp_configured:!1,statusline_configured:!1}},a=`${e}/.setup-complete`;Fe(a,JSON.stringify(i,null,2)),R.push("marker file regenerated"),s("setup-repair","Regenerated marker file")}function hn(e){let t=0,n=0;try{n=(c=>{let i=0,a=(u,l)=>{if(!(l>4))try{let f=q(u,{withFileTypes:!0});for(let p of f){let m=`${u}/${p.name}`;p.isDirectory()&&!p.name.startsWith(".")?a(m,l+1):p.name.endsWith(".sh")&&i++}}catch{}};return a(c,0),i})(`${e}/hooks`)}catch{}n<20&&(s("setup-repair",`CRITICAL: Only ${n} hooks found (expected 50+)`),t++);let o=0;try{o=(c=>{let i=0,a=(u,l)=>{if(!(l>2))try{let f=q(u,{withFileTypes:!0});for(let p of f){let m=`${u}/${p.name}`;p.isDirectory()&&!p.name.startsWith(".")?a(m,l+1):p.name==="SKILL.md"&&i++}}catch{}};return a(c,0),i})(`${e}/skills`)}catch{}return o<50&&(s("setup-repair",`CRITICAL: Only ${o} skills found (expected 100+)`),t++),de(`${e}/hooks/_lib/common.sh`)||(s("setup-repair","CRITICAL: hooks/_lib/common.sh missing"),t++),t>=2?(J.push("Multiple critical components missing - reinstall recommended"),B=!0,!1):!0}function z(e){let t=y();s("setup-repair","Setup repair starting"),dn(t),fn(t),gn(t),hn(t)||s("setup-repair","WARN: Critical components missing, repair incomplete"),mn(t);let n="";return R.length>0&&(n=`Repairs: ${R.join(", ")}`),J.length>0&&(n=`${n?`${n}. `:""}Issues: ${J.join(", ")}`,B=!0),s("setup-repair",`Repair complete: ${R.length} repairs made, ${J.length} issues`),B&&n?d(`OrchestKit auto-repair: ${n}`):g()}import{existsSync as kn,writeFileSync as yn,mkdirSync as Sn}from"node:fs";import{join as G}from"node:path";import{homedir as je}from"node:os";var O="sync-setup-dispatcher";function vn(e){let t=G(je(),".claude","ork","once-markers"),n=G(t,`${e}.done`);return kn(n)}function $n(e){let t=G(je(),".claude","ork","once-markers");Sn(t,{recursive:!0}),yn(G(t,`${e}.done`),new Date().toISOString())}var Cn=[{name:"unified-dispatcher",fn:M},{name:"setup-check",fn:U,once:!0},{name:"first-run-setup",fn:F,once:!0},{name:"setup-maintenance",fn:K},{name:"setup-repair",fn:z},{name:"monorepo-detector",fn:L,once:!0}];async function Le(e){let t=[];for(let o of Cn){if(o.once&&vn(o.name)){s(O,`${o.name}: skipped (already ran once)`);continue}try{let r=o.fn(e),c=r instanceof Promise?await r:r;o.once&&$n(o.name),c.systemMessage&&(t.push(c.systemMessage),s(O,`${o.name}: systemMessage collected`));let i=be(c);i&&!c.systemMessage&&(t.push(i),s(O,`${o.name}: additionalContext converted to systemMessage`))}catch(r){let c=r instanceof Error?r.message:String(r);s(O,`${o.name} failed: ${c}`,"warn")}}if(t.length===0)return s(O,"All Setup hooks silent"),g();let n=t.join(`
`);return s(O,`Merged ${t.length} messages from Setup hooks`),{continue:!0,systemMessage:n}}var Ue={"setup/unified-dispatcher":M,"setup/first-run-setup":F,"setup/monorepo-detector":L,"setup/setup-check":U,"setup/setup-maintenance":K,"setup/setup-repair":z,"setup/sync-setup-dispatcher":Le};function ar(e){return Ue[e]}function ur(){return Object.keys(Ue)}export{go as escapeRegex,Ct as estimateTokenCount,be as extractContext,Ee as fnv1aHash,zn as getCachedBranch,Bn as getEnvFile,uo as getField,ar as getHook,xe as getLogDir,kt as getLogLevel,y as getPluginRoot,E as getProjectDir,oe as getSessionId,Ue as hooks,En as isBashInput,xn as isEditInput,Rn as isReadInput,_n as isWriteInput,po as lineContainsAll,lo as lineContainsAllCI,ur as listHooks,s as logHook,so as logPermissionFeedback,fo as normalizeCommand,Gn as normalizeLineEndings,Qn as outputAllowWithContext,Zn as outputBlock,oo as outputDeny,eo as outputError,St as outputPromptContext,io as outputPromptContextBudgeted,Xn as outputSilentAllow,g as outputSilentSuccess,no as outputStderrWarning,to as outputWarning,d as outputWithContext,Yn as outputWithNotification,ro as outputWithUpdatedInput,ao as readHookInput,yt as shouldLog,co as writeRulesFile};
//# sourceMappingURL=setup.mjs.map
