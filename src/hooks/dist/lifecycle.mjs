// OrchestKit Hooks - lifecycle bundle
// Generated: 2026-02-06T08:09:05.511Z

function No(t){return typeof t.command=="string"}function Fo(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function Ao(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function Lo(t){return typeof t.file_path=="string"&&t.content===void 0}import{appendFileSync as gt,existsSync as ft,statSync as Fe,renameSync as Ae,mkdirSync as Le,readSync as Me}from"node:fs";import{execSync as Ue}from"node:child_process";import ke from"node:os";import w from"node:path";function S(){return process.env.HOME||process.env.USERPROFILE||ke.homedir()}function J(){return process.env.CLAUDE_PROJECT_DIR||"."}function ut(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function lt(){return process.env.CLAUDE_PLUGIN_ROOT?w.join(S(),".claude","logs","ork"):w.join(J(),".claude","logs")}var Ko=w.join,Bo=w.sep;import{execSync as _e}from"node:child_process";import{createHash as ve}from"node:crypto";import{existsSync as pt,readFileSync as be,writeFileSync as Ie,mkdirSync as xe}from"node:fs";import{join as K,basename as $e}from"node:path";var we=20,He=15,Ce=/[^a-z0-9-]/g;function Re(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=$e(e);return dt(n,we)}function Oe(t){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=_e("git branch --show-current",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),r=dt(n||"detached",He);return process.env.ORCHESTKIT_SESSION_BRANCH=r,r}catch{return"nobranch"}}function Ee(t){let e=t||new Date,n=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${n}${r}`}function De(t){let e=t||new Date,n=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0");return`${n}${r}`}function Pe(){let t=`${process.pid}-${Date.now()}-${Math.random()}`;return ve("sha256").update(t).digest("hex").slice(0,4)}function dt(t,e){return t.toLowerCase().replace(Ce,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,e)}function je(t,e){let n=Re(t),r=Oe(t),o=Ee(e),s=De(e),c=Pe();return`${n}-${r}-${o}-${s}-${c}`}function Te(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=K(e,".instance","session-id.json");if(pt(n))try{let r=JSON.parse(be(n,"utf8"));if(r.session_id&&r.created_at){let o=Date.now()-new Date(r.created_at).getTime(),s=1440*60*1e3;if(o<s)return r.session_id}}catch{}}function Ne(t,e){let n=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),r=K(n,".instance"),o=K(r,"session-id.json");try{pt(r)||xe(r,{recursive:!0}),Ie(o,JSON.stringify({session_id:t,created_at:new Date().toISOString()},null,2))}catch{}}function mt(t){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let e=Te(t);if(e)return e;let n=je(t);return Ne(n,t),n}function x(){return lt()}function l(){return J()}function B(){return ut()}function yt(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${B()}/.claude/.instance_env`}function g(){return mt()}function ht(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let e=Ue("git branch --show-current",{cwd:t||l(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function Je(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function ei(t){return t.replace(/\r\n/g,`
`)}function Ke(t){let e=["debug","info","warn","error"];return e.indexOf(t)>=e.indexOf(Je())}function a(){return{continue:!0,suppressOutput:!0}}function ni(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function ri(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function W(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function Be(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function oi(t,e){let n={continue:!0,suppressOutput:!0};return t&&(n.systemMessage=t),e&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:e}),n}function ii(t,e){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?n.systemMessage=e:n.suppressOutput=!0,n}function si(t){return{continue:!0,systemMessage:t}}function St(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function ci(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}function ai(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:t}}}var We=200*1024,ze=100*1024;function kt(t,e){if(ft(t))try{if(Fe(t).size>e){let r=`${t}.old.${Date.now()}`;Ae(t,r)}}catch{}}function _t(t){ft(t)||Le(t,{recursive:!0})}function i(t,e,n="debug"){if(!Ke(n))return;let r=x(),o=`${r}/hooks.log`;try{_t(r),kt(o,We);let s=new Date().toISOString().replace("T"," ").slice(0,19);gt(o,`[${s}] [${n.toUpperCase()}] [${t}] ${e}
`)}catch{}}function ui(t,e,n){let r=x(),o=`${r}/permission-feedback.log`;try{_t(r),kt(o,ze);let s=new Date().toISOString(),c=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",u=n?.session_id||g();gt(o,`${s} | ${t} | ${e} | tool=${c} | session=${u}
`)}catch{}}function Ge(t){if(!t)return 0;let r=(t.match(/[{};()=><]/g)||[]).length/t.length>.03?2.8:3.5;return Math.ceil(t.length/r)}function li(t,e,n,r,o){let s=Ge(t);return r&&r.isOverBudget(n)?(i(e,`Budget exhausted for ${n}, suppressing ${s}t`),a()):(o&&o.trackTokenUsage(e,n,s),Be(t))}function pi(){try{let t=[],n=Buffer.allocUnsafe(256),r,o=0;for(;;)try{if(r=Me(o,n,0,256,null),r===0)break;t.push(Buffer.from(n.subarray(0,r)))}catch{break}let s=Buffer.concat(t).toString("utf8").trim();return s?JSON.parse(s):{tool_name:"",session_id:g(),tool_input:{}}}catch{return{tool_name:"",session_id:g(),tool_input:{}}}}function di(t,e){let n=e.replace(/^\./,"").split("."),r=t;for(let o of n){if(r==null)return;r=r[o]}return r}function mi(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function gi(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}import{execSync as v}from"node:child_process";function Ve(t){let e=t||l();try{return v("git branch --show-current",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return"unknown"}}function qe(t){let e=t||Ve();return["dev","main","master"].includes(e)}function Si(t){let e=t||l();try{return v("git rev-parse --show-toplevel",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return e}}function ki(t){let e=t||l();try{return v("git rev-parse --git-dir",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),!0}catch{return!1}}function Ye(t){let e=t||l();try{return v("git status --short",{cwd:e,encoding:"utf8",timeout:1e4,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function _i(t){return Ye(t).length>0}function vi(t){let e=t||l();try{return v("git rev-parse --verify main",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"main"}catch{try{return v("git rev-parse --verify master",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"master"}catch{return"main"}}}function Ze(t){let e=[/issue\/(\d+)/i,/feature\/(\d+)/i,/fix\/(\d+)/i,/bug\/(\d+)/i,/feat\/(\d+)/i,/^(\d+)-/,/-(\d+)$/,/#(\d+)/];for(let n of e){let r=t.match(n);if(r)return parseInt(r[1],10)}return null}function bi(t){if(qe(t))return null;let e=["issue/","feature/","fix/","bug/","feat/","chore/","docs/","refactor/","test/","ci/","perf/","style/","release/","hotfix/"];return e.some(r=>t.startsWith(r))?t.startsWith("issue/")&&!Ze(t)?"issue/ branches should include an issue number (e.g., issue/123-description)":null:`Branch name should start with a valid prefix: ${e.join(", ")}`}import{existsSync as vt,readFileSync as bt}from"node:fs";function Qe(t){let e=`${t}/.claude/feedback/consent-status.json`;if(!vt(e))return{consented:!1,asked:!1};try{let n=JSON.parse(bt(e,"utf-8"));return{consented:n.consented===!0,asked:n.asked===!0}}catch{return{consented:!1,asked:!1}}}function Xe(t){let e=`${t}/.claude/feedback/consent-log.json`;if(!vt(e))return null;try{let n=JSON.parse(bt(e,"utf-8"));if(n.events&&n.events.length>0)return n.events[n.events.length-1]}catch{}return null}function tn(t){try{let e=new Date(t);return Math.floor((new Date().getTime()-e.getTime())/(1e3*60*60*24))>=30}catch{return!1}}function It(t){let e=t.project_dir||l(),n=Qe(e);if(n.consented)return i("analytics-consent-check","User has consented to analytics"),a();if(n.asked){let r=Xe(e);return r&&(r.action==="declined"||r.action==="revoked")&&tn(r.timestamp)?(i("analytics-consent-check","Showing 30-day reminder"),{continue:!0,systemMessage:"Reminder: Anonymous analytics help improve OrchestKit. Enable with /ork:feedback opt-in"}):(i("analytics-consent-check","User recently declined, not prompting"),a())}return i("analytics-consent-check","First time user, showing brief notice"),{continue:!0,systemMessage:"OrchestKit collects local usage metrics. Share anonymously with /ork:feedback opt-in"}}import{existsSync as H,readFileSync as xt,writeFileSync as en,unlinkSync as nn}from"node:fs";function rn(t){let e=`${t}/.claude/.instance_env`;if(!H(e))return null;try{let r=xt(e,"utf-8").match(/CLAUDE_INSTANCE_ID=([^\n]+)/);if(r)return r[1].trim()}catch{}return null}function on(t,e){let r=`${`${t}/.claude/coordination/heartbeats`}/${e}.json`;if(H(r))try{let o=JSON.parse(xt(r,"utf-8"));o.status="stopping",en(r,JSON.stringify(o,null,2)),i("coordination-cleanup",`Updated heartbeat status to 'stopping' for ${e}`)}catch(o){i("coordination-cleanup",`Failed to update heartbeat: ${o}`)}}function sn(t,e){let n=`${t}/.claude/coordination/.claude.db`;if(!H(n)){i("coordination-cleanup","No coordination database found");return}i("coordination-cleanup",`Would unregister instance: ${e}`)}function cn(t){let e=`${t}/.claude/.instance_env`;try{H(e)&&(nn(e),i("coordination-cleanup","Removed instance environment file"))}catch(n){i("coordination-cleanup",`Failed to remove instance env: ${n}`)}}function $t(t){i("coordination-cleanup","Starting coordination cleanup");let e=t.project_dir||l(),n=rn(e);return n&&(on(e,n),sn(e,n)),cn(e),i("coordination-cleanup","Coordination cleanup complete"),a()}import{existsSync as an,readFileSync as un,writeFileSync as ln,mkdirSync as wt,appendFileSync as pn}from"node:fs";function dn(){return process.env.CLAUDE_MULTI_INSTANCE==="1"}function mn(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function gn(t){let e=`${t}/.claude/context/session/state.json`;if(!an(e))return"General development";try{return JSON.parse(un(e,"utf-8")).current_task?.description||"General development"}catch{return"General development"}}function fn(){return process.env.CLAUDE_SUBAGENT_ROLE||"main"}function yn(){let t=g(),e=new Date().toISOString().replace(/[-:T.Z]/g,"").slice(0,14),n=Math.random().toString(36).substring(2,8);return`${t.slice(0,8)}-${e}-${n}`}function hn(t,e){let n=yt();try{wt(`${t}/.claude`,{recursive:!0}),pn(n,`CLAUDE_INSTANCE_ID=${e}
`),i("coordination-init",`Saved instance ID: ${e}`)}catch(r){i("coordination-init",`Failed to save instance ID: ${r}`)}}function Sn(t,e,n,r){let o=`${t}/.claude/coordination/heartbeats`;try{wt(o,{recursive:!0});let s={instance_id:e,task:n,role:r,status:"active",started_at:new Date().toISOString(),last_heartbeat:new Date().toISOString()};ln(`${o}/${e}.json`,JSON.stringify(s,null,2)),i("coordination-init",`Initialized heartbeat for ${e}`)}catch(s){i("coordination-init",`Failed to initialize heartbeat: ${s}`)}}function Ht(t){if(!dn())return i("coordination-init","Multi-instance not enabled, skipping"),a();if(mn())return i("coordination-init","Skipping coordination init (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();i("coordination-init","Starting coordination initialization");let e=t.project_dir||l(),n=gn(e),r=fn(),o=yn();return process.env.CLAUDE_INSTANCE_ID=o,hn(e,o),Sn(e,o,n,r),i("coordination-init",`Coordination initialized: ${o}`),a()}import{existsSync as z,readFileSync as G,writeFileSync as Ct,readdirSync as kn,unlinkSync as _n,mkdirSync as vn}from"node:fs";function bn(){return process.env.CLAUDE_MULTI_INSTANCE==="1"}function In(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function xn(){return process.env.CLAUDE_INSTANCE_ID||g()}function $n(t){let e=`${t}/.claude/.instance_env`;if(!z(e))return null;try{let r=G(e,"utf-8").match(/CLAUDE_INSTANCE_ID=([^\n]+)/);if(r)return r[1].trim()}catch{}return null}function wn(t,e){let n=`${t}/.claude/coordination/heartbeats`,r=`${n}/${e}.json`;if(!z(r)){vn(n,{recursive:!0});let o={instance_id:e,status:"active",last_heartbeat:new Date().toISOString()};Ct(r,JSON.stringify(o,null,2)),i("instance-heartbeat",`Created heartbeat for ${e}`);return}try{let o=JSON.parse(G(r,"utf-8"));o.last_heartbeat=new Date().toISOString(),o.status="active",Ct(r,JSON.stringify(o,null,2)),i("instance-heartbeat",`Updated heartbeat for ${e}`)}catch(o){i("instance-heartbeat",`Failed to update heartbeat: ${o}`)}}function Hn(t,e){let n=`${t}/.claude/coordination/heartbeats`;if(!z(n))return 0;let r=300*1e3,o=Date.now(),s=0;try{let c=kn(n).filter(u=>u.endsWith(".json"));for(let u of c){let p=`${n}/${u}`;try{let d=JSON.parse(G(p,"utf-8"));if(d.instance_id===e)continue;let f=new Date(d.last_heartbeat).getTime();o-f>r&&(_n(p),s++,i("instance-heartbeat",`Cleaned up stale instance: ${d.instance_id}`))}catch{}}}catch(c){i("instance-heartbeat",`Failed to scan heartbeats: ${c}`)}return s}function C(t){if(!bn())return a();if(In())return i("instance-heartbeat","Skipping instance heartbeat (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();let e=t.project_dir||l(),n=xn();if((!n||n==="unknown")&&(n=$n(e)||n),!n)return i("instance-heartbeat","No instance ID available"),a();wn(e,n);let r=Hn(e,n);return r>0&&i("instance-heartbeat",`Cleaned up ${r} stale instance(s)`),a()}import{mkdirSync as Cn,appendFileSync as Rn}from"node:fs";function On(){return!!process.env.MEM0_API_KEY}function R(t){i("mem0-analytics-tracker","Mem0 analytics tracker starting");let e=t.project_dir||l(),n=`${e}/.claude/logs/mem0-analytics.jsonl`,r=t.session_id||g(),o=new Date().toISOString(),s=JSON.stringify({session_id:r,timestamp:o,event:"session_start",mem0_available:On()});try{Cn(`${e}/.claude/logs`,{recursive:!0}),Rn(n,s+`
`),i("mem0-analytics-tracker","Mem0 analytics tracked")}catch(c){i("mem0-analytics-tracker",`Failed to write analytics: ${c}`)}return a()}import{existsSync as En,readFileSync as Ot,mkdirSync as Dn,renameSync as Pn}from"node:fs";import{basename as Et}from"node:path";function jn(t){return(Et(t)||"unknown").toLowerCase().replace(/\s+/g,"-")}function Tn(){return!!process.env.MEM0_API_KEY}function Rt(t){if(!En(t))return!1;try{let e=Ot(t,"utf-8"),n=JSON.parse(e);return!(!n||Object.keys(n).length===0)}catch{return!1}}function Nn(t,e){let n=`${e}/.claude/logs/mem0-processed`,r=new Date().toISOString().replace(/[:.]/g,"-");try{Dn(n,{recursive:!0});let s=(Et(t)||"pending-sync").replace(".json",`.processed-${r}.json`),c=`${n}/${s}`;Pn(t,c),i("mem0-context-retrieval",`Archived pending sync to ${c}`)}catch(o){i("mem0-context-retrieval",`Warning: Could not archive ${t}: ${o}`)}}function O(t){i("mem0-context-retrieval","Mem0 context retrieval starting");let e=t.project_dir||l(),n=jn(e),r=`${e}/.mem0-pending-sync.json`,o=`${S()}/.claude/.mem0-pending-sync.json`,s=null;if(Rt(r))s=r,i("mem0-context-retrieval",`Found pending sync in project: ${r}`);else if(Rt(o))try{let c=JSON.parse(Ot(o,"utf-8"));c.project_id===n?(s=o,i("mem0-context-retrieval","Found pending sync in global location for this project")):i("mem0-context-retrieval",`Global pending sync exists but for different project: ${c.project_id}`)}catch{}return s&&(i("mem0-context-retrieval","Found pending sync, archiving for processing"),Nn(s,e),i("mem0-context-retrieval","Pending sync archived - will be processed on next memory operation")),Tn()?i("mem0-context-retrieval","Graph + mem0 available for this session"):i("mem0-context-retrieval","Graph available (mem0 not configured) for this session"),a()}import{writeFileSync as Fn,mkdirSync as An}from"node:fs";function Ln(){return!!process.env.MEM0_API_KEY}function Mn(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Dt(t){if(Mn())return i("mem0-webhook-setup","Skipping mem0 webhook setup (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();if(i("mem0-webhook-setup","Mem0 webhook setup starting"),!Ln())return i("mem0-webhook-setup","Mem0 not available, skipping webhook setup"),a();let e=t.project_dir||l(),n=`${e}/.claude/mem0-webhooks.json`,r="orchestkit-auto-sync",o=["memory.created","memory.updated","memory.deleted"],s=process.env.MEM0_WEBHOOK_URL||"https://example.com/webhook/mem0";i("mem0-webhook-setup","Checking for existing webhooks"),process.env.MEM0_WEBHOOK_URL||i("mem0-webhook-setup","Webhook URL not configured (set MEM0_WEBHOOK_URL), skipping creation");try{An(`${e}/.claude`,{recursive:!0}),Fn(n,JSON.stringify({webhook_name:r,events:o,url:s},null,2)),i("mem0-webhook-setup","Webhook config saved")}catch(c){i("mem0-webhook-setup",`Failed to save webhook config: ${c}`)}return i("mem0-webhook-setup","Webhook setup complete"),a()}import{existsSync as y,readFileSync as Un,writeFileSync as Pt,mkdirSync as E}from"node:fs";import{basename as jt}from"node:path";import{execSync as V}from"node:child_process";function Jn(){return process.env.CLAUDE_MULTI_INSTANCE==="1"}function Kn(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Bn(){try{return V("which sqlite3",{encoding:"utf-8",stdio:"pipe"}),!0}catch{return!1}}function Wn(){return process.env.CLAUDE_MODEL||"sonnet"}function zn(t){let e=jt(t)||"unknown",n=new Date().toISOString().replace(/[-:T.Z]/g,"").slice(0,14),r=Math.random().toString(16).substring(2,10);return`${e}-${n}-${r}`}function Gn(t){try{return V("git branch --show-current",{cwd:t,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim()}catch{return"unknown"}}function Vn(t){let e=[];return(y(`${t}/backend`)||y(`${t}/src/backend`))&&e.push("backend"),(y(`${t}/frontend`)||y(`${t}/src/frontend`)||y(`${t}/package.json`))&&e.push("frontend"),(y(`${t}/tests`)||y(`${t}/__tests__`))&&e.push("testing"),(y(`${t}/infrastructure`)||y(`${t}/docker-compose.yml`)||y(`${t}/Dockerfile`))&&e.push("devops"),e}function qn(t,e){let n=Gn(t),r=Vn(t),o=new Date().toISOString(),s={instance_id:e,worktree_name:jt(t)||"unknown",worktree_path:t,branch:n,capabilities:r,agent_type:null,model:Wn(),priority:1,created_at:o,status:"active",heartbeat_interval_ms:5e3,last_heartbeat:o},c=`${t}/.instance`;return E(c,{recursive:!0}),Pt(`${c}/id.json`,JSON.stringify(s,null,2)),i("multi-instance-init",`Instance identity created: ${e}`),s}function Yn(t){let e=`${t}/.claude/coordination`,n=`${e}/.claude.db`,r=`${e}/schema.sql`;if(y(n))return!0;if(!y(r))return i("multi-instance-init",`WARNING: Schema file not found at ${r}`),!1;try{return E(e,{recursive:!0}),V(`sqlite3 "${n}" < "${r}"`,{encoding:"utf-8",stdio:["pipe","pipe","pipe"]}),i("multi-instance-init","Database initialized from schema"),!0}catch(o){return i("multi-instance-init",`Failed to initialize database: ${o}`),!1}}function Zn(t,e){let n=`${t}/.instance`;Pt(`${n}/heartbeat.pid`,String(process.pid)),i("multi-instance-init",`Heartbeat marker created for ${e}`)}function D(t){if(!Jn())return a();if(!Bn())return i("multi-instance-init","sqlite3 not available, skipping"),a();if(Kn())return i("multi-instance-init","Skipping multi-instance init (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();i("multi-instance-init","Starting multi-instance coordination initialization...");let e=t.project_dir||l(),n=`${e}/.instance`,r=`${e}/.claude/coordination`;if(E(`${r}/locks`,{recursive:!0}),E(n,{recursive:!0}),!Yn(e))return i("multi-instance-init","ERROR: Failed to initialize database"),a();let o=`${n}/id.json`,s=`${n}/heartbeat.pid`;if(y(o)&&y(s))try{let u=JSON.parse(Un(o,"utf-8"));return i("multi-instance-init",`Reusing existing instance: ${u.instance_id}`),a()}catch{}let c=zn(e);return qn(e,c),Zn(e,c),i("multi-instance-init","Multi-instance coordination initialized successfully"),a()}import{existsSync as P,readFileSync as q,writeFileSync as Qn,statSync as Xn,mkdirSync as tr}from"node:fs";var er=1*1024*1024;function nr(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function rr(t){let e=`${t}/.claude/feedback/sync-config.json`;if(!P(e))return!0;try{return JSON.parse(q(e,"utf-8")).sync_enabled!==!1}catch{return!0}}function Tt(t){if(!P(t))return!0;try{let e=Xn(t);return e.size>er?(i("pattern-sync-pull",`WARN: Skipping - file too large: ${t} (${e.size} bytes)`),!1):!0}catch{return!0}}function or(t){let n=`${S()}/.claude/global-patterns.json`,r=`${t}/.claude/feedback/learned-patterns.json`;if(!P(n)){i("pattern-sync-pull","No global patterns file found");return}try{let s=JSON.parse(q(n,"utf-8")).patterns||[];if(s.length===0){i("pattern-sync-pull","No global patterns to pull");return}let c={version:"1.0",patterns:[]};if(P(r))try{c=JSON.parse(q(r,"utf-8"))}catch{}let u=c.patterns||[],p=new Set(u.map(m=>m.text)),d=s.filter(m=>!p.has(m.text));if(d.length===0){i("pattern-sync-pull","All global patterns already in project");return}let f=[...u,...d];c.patterns=f,tr(`${t}/.claude/feedback`,{recursive:!0}),Qn(r,JSON.stringify(c,null,2)),i("pattern-sync-pull",`Pulled ${d.length} new patterns from global`)}catch(o){i("pattern-sync-pull",`Failed to pull global patterns: ${o}`)}}function j(t){if(nr())return i("pattern-sync-pull","Skipping pattern sync (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();let e=t.project_dir||l();if(!rr(e))return i("pattern-sync-pull","Global sync disabled, skipping pull"),a();let n=`${S()}/.claude/global-patterns.json`,r=`${e}/.claude/feedback/learned-patterns.json`;return!Tt(n)||!Tt(r)?(i("pattern-sync-pull","Skipping pattern sync due to large files"),a()):(i("pattern-sync-pull","Pulling global patterns..."),or(e),i("pattern-sync-pull","Global patterns pulled successfully"),a())}import{existsSync as Y,readFileSync as Z,writeFileSync as ir,mkdirSync as sr}from"node:fs";function cr(t){let e=`${t}/.claude/feedback/sync-config.json`;if(!Y(e))return!0;try{return JSON.parse(Z(e,"utf-8")).sync_enabled!==!1}catch{return!0}}function ar(t){let e=`${t}/.claude/feedback/learned-patterns.json`,n=S(),r=`${n}/.claude/global-patterns.json`;if(!Y(e)){i("pattern-sync-push","No project patterns file found");return}try{let s=JSON.parse(Z(e,"utf-8")).patterns||[];if(s.length===0){i("pattern-sync-push","No project patterns to push");return}let c={version:"1.0",patterns:[],updated:""};if(Y(r))try{c=JSON.parse(Z(r,"utf-8"))}catch{}let u=c.patterns||[],p=new Set(u.map(m=>m.text)),d=s.filter(m=>!p.has(m.text));if(d.length===0){i("pattern-sync-push","All project patterns already in global");return}let f=[...u,...d];c.patterns=f,c.updated=new Date().toISOString(),sr(`${n}/.claude`,{recursive:!0}),ir(r,JSON.stringify(c,null,2)),i("pattern-sync-push",`Pushed ${d.length} new patterns to global`)}catch(o){i("pattern-sync-push",`Failed to push project patterns: ${o}`)}}function Nt(t){let e=t.project_dir||l();return cr(e)?(i("pattern-sync-push","Pushing project patterns to global..."),ar(e),a()):(i("pattern-sync-push","Global sync disabled, skipping push"),a())}import{execSync as Ft}from"node:child_process";var ur=new Set(["main","master","dev","develop"]);function At(t){i("pr-status-enricher","Checking for open PR on current branch");let e=t.project_dir||l(),n;try{n=ht(e)}catch{return i("pr-status-enricher","Could not determine branch, skipping"),a()}if(!n||ur.has(n))return i("pr-status-enricher",`Branch "${n}" skipped for PR detection`),a();try{let r=Ft("gh pr view --json state,reviewDecision,url,title,isDraft",{cwd:e,timeout:1e4,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim(),o=JSON.parse(r);if(!o.url)return i("pr-status-enricher","No PR found for current branch"),a();process.env.ORCHESTKIT_PR_URL=o.url,process.env.ORCHESTKIT_PR_STATE=o.state;let s=0;try{let d=Ft("gh pr view --json reviewThreads",{cwd:e,timeout:1e4,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim();s=(JSON.parse(d).reviewThreads||[]).filter(m=>!m.isResolved).length}catch{}let c=o.isDraft?" (DRAFT)":"",u=o.reviewDecision?` | Review: ${o.reviewDecision}`:"",p=s>0?` | ${s} unresolved`:"";i("pr-status-enricher",`PR: ${o.title}${c} [${o.state}${u}${p}]`),i("pr-status-enricher",`URL: ${o.url}`)}catch{i("pr-status-enricher","No PR found or gh CLI unavailable")}return a()}import{existsSync as b,readFileSync as Mt,writeFileSync as lr,mkdirSync as pr,readdirSync as Ut,unlinkSync as Jt,copyFileSync as dr}from"node:fs";import{join as Lt}from"node:path";import{homedir as mr}from"node:os";function gr(t){if(!b(t))return 0;try{let n=JSON.parse(Mt(t,"utf-8")).tools||{};return Object.values(n).reduce((r,o)=>r+o,0)}catch{return 0}}function fr(t,e){if(!b(t))return;let n=gr(t);if(n<=5){i("session-cleanup",`Session had only ${n} tool calls, not archiving`);return}try{pr(e,{recursive:!0});let o=`session-${new Date().toISOString().replace(/[:.]/g,"-")}.json`,s=`${e}/${o}`;dr(t,s),i("session-cleanup",`Archived session metrics to ${o}`)}catch(r){i("session-cleanup",`Failed to archive metrics: ${r}`)}}function yr(t,e=20){if(b(t))try{let n=Ut(t).filter(o=>o.startsWith("session-")&&o.endsWith(".json")).sort().reverse();if(n.length<=e)return;let r=n.slice(e);for(let o of r)try{Jt(`${t}/${o}`),i("session-cleanup",`Deleted old archive: ${o}`)}catch{}}catch(n){i("session-cleanup",`Failed to cleanup old archives: ${n}`)}}function hr(t){if(!b(t))return;let e=["hooks.log.old*","audit.log.old*"];for(let n of e)try{let r=n.replace("*",""),o=Ut(t).filter(c=>c.startsWith(r)).sort().reverse();if(o.length<=5)continue;let s=o.slice(5);for(let c of s)try{Jt(`${t}/${c}`)}catch{}}catch{}}function Sr(t){if(!t||typeof t!="string"||t==="No prompt")return t||"";let e=t;if(e.includes("<task-notification>")){let s=e.match(/<summary>(.*?)<\/summary>/s);return s?s[1].trim():"(background task)"}let n=e.match(/<command-args>(.*?)(?:<\/command-args>|$)/s),r=e.match(/<command-name>(.*?)<\/command-name>/);if(r||n){let s=[];if(r&&s.push(r[1].trim()),n){let c=n[1].trim();c&&s.push(c)}if(s.length>0)return s.join(" ")}e=e.replace(/<[^>]+>/g," "),e=e.replace(/[\u2500-\u259f]/g,"");let o=e.indexOf("\u276F");return o!==-1?e=e.slice(o+1):(e=e.replace(/Claude Code v[\d.]+/g,""),e=e.replace(/Opus [\d.]+\s*[·.]\s*Claude Max/g,"")),e=e.replace(/[✻⏺⎿]\s*/g,""),e=e.replace(/Conversation compacted[^)]*\)/g,""),e=e.replace(/Referenced file [^\s]+/g,""),e=e.replace(/\s+(Bash|Read|Write|Edit|Glob|Grep|Task|Skill)\(.*$/s,""),e=e.replace(/~\/[\w/._-]+/g,""),e=e.replace(/[…]+/g,""),e=e.replace(/\s+/g," ").trim(),e}function kr(t){let e=mr(),n=Lt(e,".claude","projects");if(!b(n))return;let r=t.replace(/\//g,"-"),o=Lt(n,r,"sessions-index.json");if(!b(o)){i("session-cleanup","No sessions-index.json found");return}try{let s=JSON.parse(Mt(o,"utf-8")),c=0;for(let u of s.entries){if(!u.firstPrompt||u.firstPrompt==="No prompt")continue;let p=Sr(u.firstPrompt);(!p||p.length<10)&&(p=u.summary||u.firstPrompt),p!==u.firstPrompt&&(u.firstPrompt=p,c++)}c>0&&(lr(o,JSON.stringify(s,null,4)),i("session-cleanup",`Sanitized ${c} session firstPrompt entries`))}catch(s){i("session-cleanup",`Failed to sanitize sessions index: ${s}`,"warn")}}function Kt(t){i("session-cleanup","Session cleanup starting");let e=t.project_dir||l(),n="/tmp/claude-session-metrics.json",r=`${e}/.claude/logs/sessions`,o=`${e}/.claude/logs`;return kr(e),fr(n,r),yr(r,20),hr(o),i("session-cleanup","Session cleanup complete"),a()}import{existsSync as Q,readFileSync as Bt}from"node:fs";function T(t){if(!Q(t))return!1;try{return JSON.parse(Bt(t,"utf-8")),!0}catch{return!1}}function Wt(t){i("session-context-loader","Session starting - loading context (Protocol 2.0)");let e=t.project_dir||l(),n=0,r=process.env.AGENT_TYPE||"",o=`${e}/.claude/context/session/state.json`,s=`${e}/.claude/context/identity.json`,c=`${e}/.claude/context/knowledge/index.json`;T(o)&&(i("session-context-loader","Session state loaded"),n++),T(s)&&(i("session-context-loader","Identity loaded"),n++),T(c)&&(i("session-context-loader","Knowledge index available"),n++);let u=`${e}/docs/CURRENT_STATUS.md`;if(Q(u)&&i("session-context-loader","Current status document exists"),r){i("session-context-loader",`Agent-type aware initialization: ${r}`);let d=`${e}/.claude/agents/${r}.md`;Q(d)&&(i("session-context-loader",`Agent configuration found: ${d}`),n++)}let p=`${e}/.claude/context/session/compaction-manifest.json`;if(T(p))try{let d=JSON.parse(Bt(p,"utf-8"));i("session-context-loader",`Compaction manifest loaded: session=${d.sessionId}, decisions=${(d.keyDecisions||[]).length}, files=${(d.filesTouched||[]).length}`),process.env.ORCHESTKIT_LAST_SESSION=d.sessionId||"",process.env.ORCHESTKIT_LAST_DECISIONS=JSON.stringify(d.keyDecisions||[]),n++}catch(d){i("session-context-loader",`Error loading compaction manifest: ${d}`)}return n>0&&(r?i("session-context-loader",`Session context loaded (Protocol 2.0) - Agent: ${r}`):i("session-context-loader","Session context loaded (Protocol 2.0)")),a()}import{existsSync as _r,readFileSync as vr,writeFileSync as zt,mkdirSync as br}from"node:fs";import{execSync as Ir}from"node:child_process";function xr(t){try{return Ir("git branch --show-current",{cwd:t,encoding:"utf-8",timeout:500,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function N(t){i("session-env-setup","Setting up session environment");let e=t.project_dir||l(),n=t.session_id||g(),r="/tmp/claude-session-metrics.json";try{br(`${e}/.claude/logs`,{recursive:!0})}catch{}let o=process.env.AGENT_TYPE||"";!o&&t.agent_type&&(o=t.agent_type);let s={session_id:n,started_at:new Date().toISOString(),agent_type:o,tools:{},errors:0,warnings:0};try{zt(r,JSON.stringify(s,null,2)),i("session-env-setup","Initialized session metrics")}catch(p){i("session-env-setup",`Failed to initialize metrics: ${p}`)}let c=`${e}/.claude/context/session/state.json`;if(_r(c)&&o)try{let p=JSON.parse(vr(c,"utf-8"));p.agent_type=o,p.session_id=n,p.last_activity=new Date().toISOString(),zt(c,JSON.stringify(p,null,2)),i("session-env-setup",`Updated session state with agent_type: ${o}`)}catch(p){i("session-env-setup",`Failed to update session state: ${p}`)}let u=xr(e);return u&&i("session-env-setup",`Git branch: ${u}`),o&&i("session-env-setup",`Agent type: ${o}`),a()}import{existsSync as Qt,appendFileSync as Tr,mkdirSync as Nr,readFileSync as Fr,writeFileSync as Ar}from"node:fs";import{existsSync as $r,readFileSync as wr,writeFileSync as $s,mkdirSync as ws}from"node:fs";import{execSync as Gt}from"node:child_process";import{createHash as Hr}from"node:crypto";import*as Vt from"node:os";var Cr=".claude/.user_identity.json",Rr="orchestkit-user-identity-v1";var h=null;function F(t){return Hr("sha256").update(t+Rr).digest("hex").slice(0,32)}function Or(){try{return Vt.hostname()}catch{return"unknown-machine"}}function Er(t){let e=`${t}/${Cr}`;if(!$r(e))return null;try{let n=wr(e,"utf8");return JSON.parse(n)}catch(n){return i("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function Dr(t){let e={};try{e.email=Gt("git config user.email",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{e.name=Gt("git config user.name",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return e}function Pr(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function jr(t){if(h)return h;let e=t||l(),n=Or(),r=Er(e);if(r?.user_id)return h={user_id:r.user_id,display_name:r.display_name||r.user_id,team_id:r.team_id,machine_id:n,source:"config",anonymous_id:F(r.user_id),email:r.user_id.includes("@")?r.user_id:void 0},i("user-identity",`Resolved from config: ${h.anonymous_id}`,"debug"),h;let o=Dr(e);if(o.email)return h={user_id:o.email,display_name:o.name||o.email.split("@")[0],team_id:r?.team_id,machine_id:n,source:"git",anonymous_id:F(o.email),email:o.email},i("user-identity",`Resolved from git: ${h.anonymous_id}`,"debug"),h;let s=Pr();if(s.username){let u=`${s.username}@${n}`;return h={user_id:u,display_name:s.username,team_id:r?.team_id,machine_id:n,source:"env",anonymous_id:F(u)},i("user-identity",`Resolved from env: ${h.anonymous_id}`,"debug"),h}let c=F(n+process.pid);return h={user_id:`anon-${c.slice(0,8)}`,display_name:"Anonymous",team_id:r?.team_id,machine_id:n,source:"anonymous",anonymous_id:c},i("user-identity",`Resolved as anonymous: ${h.anonymous_id}`,"debug"),h}function qt(){let t=jr();return{session_id:g(),user_id:t.user_id,anonymous_id:t.anonymous_id,team_id:t.team_id,machine_id:t.machine_id,identity_source:t.source,timestamp:new Date().toISOString()}}var Lr=/^[a-zA-Z0-9_-]{1,128}$/;function Mr(t){return Lr.test(t)}function et(t,e){let n=t||g(),r=e||l();if(!Mr(n))throw new Error("Invalid session ID format");return`${r}/.claude/memory/sessions/${n}`}function Ur(t,e){return`${et(t,e)}/events.jsonl`}function Xt(t,e){let n=et(t,e);Qt(n)||Nr(n,{recursive:!0})}var $=0,Yt=!1,X=!1,Zt=0,Jr=5e3;function te(t,e){return`${et(t,e)}/counter.json`}function Kr(t,e){if(!Yt){Yt=!0;try{let n=te(t,e);if(Qt(n)){let r=JSON.parse(Fr(n,"utf8"));typeof r.counter=="number"&&r.counter>0&&($=r.counter,i("session-tracker",`Loaded event counter: ${$}`,"debug"))}}catch{}}}function Br(t,e){if(!X)return;let n=Date.now();if(!(n-Zt<Jr))try{Xt(t,e);let r=te(t,e);Ar(r,JSON.stringify({counter:$,updated_at:new Date().toISOString()})),X=!1,Zt=n}catch{}}function Wr(){return Kr(),$++,X=!0,Br(),`evt-${Date.now()}-${$}`}function zr(t,e,n={}){try{let r={event_id:Wr(),event_type:t,identity:qt(),payload:{name:e,input:tt(n.input),output:tt(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?ne(n.context,500):void 0,confidence:n.confidence}};Xt();let o=Ur();Tr(o,JSON.stringify(r)+`
`),i("session-tracker",`Tracked ${t}: ${e}`,"debug")}catch(r){i("session-tracker",`Failed to track event: ${r}`,"warn")}}function Gr(t){return t>=5&&t<12?"morning":t>=12&&t<17?"afternoon":t>=17&&t<21?"evening":"night"}function ee(t){let e=new Date,n={project_dir:t?.project_dir,git_branch:t?.git_branch,time_of_day:t?.time_of_day||Gr(e.getHours()),started_at:e.toISOString()};zr("session_start","session",{success:!0,input:n})}function ne(t,e){return t.length<=e?t:t.slice(0,e-3)+"..."}function tt(t){if(!t)return;let e={},n=["password","secret","token","key","credential","auth"];for(let[r,o]of Object.entries(t)){if(n.some(s=>r.toLowerCase().includes(s))){e[r]="[REDACTED]";continue}if(typeof o=="string"&&o.length>500){e[r]=ne(o,500);continue}if(typeof o=="object"&&o!==null&&!Array.isArray(o)){e[r]=tt(o);continue}e[r]=o}return e}import{execSync as Vr}from"node:child_process";function qr(t){try{return Vr("git rev-parse --abbrev-ref HEAD",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()||void 0}catch{return}}function A(t){try{let e=t.project_dir||l(),n=qr(e);return ee({project_dir:e,git_branch:n}),i("session-tracking",`Tracked session start: branch=${n||"unknown"}`,"debug"),a()}catch(e){return i("session-tracking",`Error: ${e}`,"warn"),a()}}import{existsSync as Yr,readFileSync as Zr}from"node:fs";function re(t){i("session-metrics-summary","Session ending - generating summary");let e="/tmp/claude-session-metrics.json";if(!Yr(e))return i("session-metrics-summary","No metrics file found"),a();try{let n=JSON.parse(Zr(e,"utf-8")),r=n.tools||{},o=n.errors||0,s=Object.values(r).reduce((u,p)=>u+p,0),c=Object.entries(r).sort(([,u],[,p])=>p-u).slice(0,3).map(([u,p])=>`${u}: ${p}`).join(", ");i("session-metrics-summary",`Session stats: ${s} tool calls, ${o} errors`),s>0&&i("session-metrics-summary",`Top tools: ${c}`)}catch(n){i("session-metrics-summary",`Failed to read metrics: ${n}`)}return a()}import{existsSync as _,readFileSync as rt,writeFileSync as Qr,mkdirSync as Xr}from"node:fs";var to=[{package:"lodash",pattern:"<4.17.21",severity:"high",cve:"CVE-2021-23337",description:"Prototype pollution"},{package:"minimist",pattern:"<1.2.6",severity:"critical",cve:"CVE-2021-44906",description:"Prototype pollution"},{package:"node-fetch",pattern:"<2.6.7",severity:"high",cve:"CVE-2022-0235",description:"Information exposure"},{package:"axios",pattern:"<0.21.2",severity:"high",cve:"CVE-2021-3749",description:"ReDoS vulnerability"},{package:"jsonwebtoken",pattern:"<9.0.0",severity:"critical",cve:"CVE-2022-23529",description:"Insecure token verification"},{package:"express",pattern:"<4.17.3",severity:"medium",cve:"CVE-2022-24999",description:"Open redirect"},{package:"tar",pattern:"<6.1.11",severity:"critical",cve:"CVE-2021-37701",description:"Arbitrary file overwrite"},{package:"path-parse",pattern:"<1.0.7",severity:"medium",cve:"CVE-2021-23343",description:"ReDoS vulnerability"},{package:"django",pattern:"<3.2.14",severity:"high",cve:"CVE-2022-34265",description:"SQL injection"},{package:"flask",pattern:"<2.0.2",severity:"medium",cve:"CVE-2021-28091",description:"Path traversal"},{package:"requests",pattern:"<2.28.0",severity:"medium",cve:"CVE-2023-32681",description:"Information disclosure"},{package:"urllib3",pattern:"<1.26.5",severity:"high",cve:"CVE-2021-33503",description:"ReDoS vulnerability"},{package:"pillow",pattern:"<9.0.0",severity:"high",cve:"CVE-2022-22817",description:"Buffer overflow"},{package:"pyyaml",pattern:"<5.4",severity:"critical",cve:"CVE-2020-14343",description:"Arbitrary code execution"},{package:"jinja2",pattern:"<3.0.3",severity:"medium",cve:"CVE-2020-28493",description:"XSS vulnerability"},{package:"sqlalchemy",pattern:"<1.4.46",severity:"medium",cve:"CVE-2023-30533",description:"SQL injection"}],eo=24;function no(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function ro(t,e){let n=t.split(".").map(o=>parseInt(o,10)||0),r=e.split(".").map(o=>parseInt(o,10)||0);for(let o=0;o<Math.max(n.length,r.length);o++){let s=n[o]||0,c=r[o]||0;if(s<c)return!0;if(s>c)return!1}return!1}function oo(t,e){let n=e.charAt(0),r=e.substring(1);return n==="<"?ro(t,r):n==="="?t===r:!1}function io(t){return t.replace(/^[^~>=<]/,"").replace(/,.*$/,"").trim()}function oe(t,e){let n=io(e),r=t.toLowerCase();for(let o of to)if(r===o.package&&oo(n,o.pattern))return o;return null}function so(t){if(!_(t))return null;try{let e=JSON.parse(rt(t,"utf-8"));if((Date.now()-e.timestamp)/(1e3*60*60)<eo)return e.warnings}catch{}return null}function nt(t,e){try{Xr(t.replace(/\/[^/]+$/,""),{recursive:!0});let n={warnings:e,timestamp:Date.now()};Qr(t,JSON.stringify(n,null,2))}catch{}}function co(t){let e=0,n=0,r="";if(!_(t))return{criticalCount:e,highCount:n,warnings:r};try{let o=JSON.parse(rt(t,"utf-8")),s={...o.dependencies,...o.devDependencies};for(let[c,u]of Object.entries(s)){let p=oe(c,u);p&&(p.severity==="critical"&&e++,p.severity==="high"&&n++,r+=`
- ${c}@${u}: ${p.description} (${p.cve}, ${p.severity}) - upgrade to ${p.pattern}`)}}catch{}return{criticalCount:e,highCount:n,warnings:r}}function ao(t){let e=0,n=0,r="";if(!_(t))return{criticalCount:e,highCount:n,warnings:r};try{let s=rt(t,"utf-8").split(`
`);for(let c of s){let u=c.trim();if(!u||u.startsWith("#"))continue;let p=u.match(/^([a-zA-Z0-9_-]+)(?:==|>=|~=|!=|<|>)\s*([0-9.]+)/);if(!p)continue;let[,d,f]=p,m=oe(d,f);m&&(m.severity==="critical"&&e++,m.severity==="high"&&n++,r+=`
- ${d}==${f}: ${m.description} (${m.cve}, ${m.severity}) - upgrade to ${m.pattern}`)}}catch{}return{criticalCount:e,highCount:n,warnings:r}}function ie(t){if(no())return i("dependency-version-check","Skipping dependency check (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();i("dependency-version-check","Starting dependency version check");let e=t.project_dir||l(),n=`${e}/.claude/feedback/dependency-check-cache.json`,r=_(`${e}/package.json`),o=_(`${e}/requirements.txt`),s=_(`${e}/pyproject.toml`),c=_(`${e}/go.mod`);if(!r&&!o&&!s&&!c)return i("dependency-version-check","No package files found, skipping check"),nt(n,"none"),a();let u=so(n);if(u!==null)return i("dependency-version-check","Using cached dependency warnings"),u!=="none"?W(`DEPENDENCY SECURITY CHECK (cached): ${u}`):a();let p=0,d=0,f="";if(r){let m=co(`${e}/package.json`);p+=m.criticalCount,d+=m.highCount,m.warnings&&(f+=`

Node.js (package.json):${m.warnings}`)}if(o){let m=ao(`${e}/requirements.txt`);p+=m.criticalCount,d+=m.highCount,m.warnings&&(f+=`

Python (requirements.txt):${m.warnings}`)}if(f){let m=`Found ${p} critical and ${d} high severity vulnerabilities`,at=`DEPENDENCY SECURITY CHECK: ${m}${f}

Run 'npm audit' or 'pip-audit' for full details.`;if(nt(n,at),i("dependency-version-check",m),p>0||d>0)return W(at)}else nt(n,"none"),i("dependency-version-check","No known vulnerabilities found");return a()}import{existsSync as M,readFileSync as ot,appendFileSync as uo,mkdirSync as lo}from"node:fs";import{join as k,dirname as po}from"node:path";function L(t){if(!M(t))return 0;try{return ot(t,"utf8").trim().split(`
`).filter(n=>n.trim()).length}catch{return 0}}function se(t,e){let n={};if(!M(t))return n;try{let o=ot(t,"utf8").trim().split(`
`).filter(s=>s.trim());for(let s of o)try{let c=JSON.parse(s),u=e.includes(".")?e.split(".").reduce((p,d)=>p?.[d],c):c[e];u&&typeof u=="string"&&(n[u]=(n[u]||0)+1)}catch{}}catch{}return n}function mo(t){if(!M(t))return 0;try{let n=ot(t,"utf8").trim().split(`
`).filter(o=>o.trim()),r=0;for(let o of n)try{JSON.parse(o).event==="session_start"&&r++}catch{}return r}catch{return 0}}function it(t){let e=t||l(),n=k(e,".claude","memory"),r=k(e,".claude","logs"),o=k(n,"decisions.jsonl"),s=k(n,"graph-queue.jsonl"),c=k(n,"mem0-queue.jsonl"),u=k(n,"completed-flows.jsonl"),p=k(r,"mem0-analytics.jsonl");return{timestamp:new Date().toISOString(),decisions:{total:L(o),byCategory:se(o,"metadata.category"),byType:se(o,"type")},queues:{graphQueueDepth:L(s),mem0QueueDepth:L(c)},completedFlows:L(u),sessionCount:mo(p),mem0Available:!!process.env.MEM0_API_KEY}}function ce(t,e){let n=t||l(),r=k(n,".claude","logs","memory-metrics.jsonl"),o=e||it(n);try{let s=po(r);M(s)||lo(s,{recursive:!0}),uo(r,JSON.stringify(o)+`
`),i("memory-metrics",`Metrics snapshot appended: ${o.decisions.total} decisions`,"debug")}catch(s){i("memory-metrics",`Failed to write metrics: ${s}`,"warn")}}function ae(t){i("memory-metrics-collector","Collecting memory metrics");try{let e=t.project_dir||l(),n=it(e);ce(e,n)}catch(e){i("memory-metrics-collector",`Failed to collect metrics: ${e}`,"warn")}return a()}var ue=[{name:"mem0-context-retrieval",fn:O},{name:"mem0-analytics-tracker",fn:R},{name:"pattern-sync-pull",fn:j},{name:"multi-instance-init",fn:D},{name:"instance-heartbeat",fn:C},{name:"session-env-setup",fn:N},{name:"session-tracking",fn:A},{name:"memory-metrics-collector",fn:ae}];async function le(t){let e=await Promise.allSettled(ue.map(async r=>{try{let o=r.fn(t);return o instanceof Promise&&await o,{hook:r.name,status:"success"}}catch(o){let s=o instanceof Error?o.message:String(o);return i("session-start-dispatcher",`${r.name} failed: ${s}`),{hook:r.name,status:"error",message:s}}})),n=[];for(let r of e)r.status==="rejected"?n.push("unknown"):r.value.status==="error"&&n.push(r.value.hook);return n.length>0&&i("session-start-dispatcher",`${n.length}/${ue.length} hooks failed: ${n.join(", ")}`),a()}import{writeFileSync as go,existsSync as U,readFileSync as st,mkdirSync as fo,appendFileSync as yo,readdirSync as ho}from"node:fs";import{join as I}from"node:path";function So(){let t=x(),e=I(t,"sessions");return U(e)||fo(e,{recursive:!0}),I(e,`${g()}-state.json`)}function ko(t){try{if(U(t))return JSON.parse(st(t,"utf8"))}catch{}return{}}function _o(){let t=I(l(),".claude","memory");if(!U(t))return 0;try{let e=ho(t).filter(r=>r.endsWith(".jsonl")),n=0;for(let r of e)try{let o=st(I(t,r),"utf8");n+=o.trim().split(`
`).filter(Boolean).length}catch{}return n}catch{return 0}}function vo(){let t=I(l(),".claude","logs","decisions.jsonl");if(!U(t))return[];try{return st(t,"utf8").trim().split(`
`).filter(Boolean).slice(-10).map(r=>{try{let o=JSON.parse(r);return o.summary||o.decision||r}catch{return r}})}catch{return[]}}function bo(t){if(t.length<2)return 0;let e=[];for(let n=1;n<t.length;n++){let r=new Date(t[n-1].timestamp).getTime(),o=new Date(t[n].timestamp).getTime();o>r&&e.push(o-r)}return e.length===0?0:Math.round(e.reduce((n,r)=>n+r,0)/e.length)}function pe(t){try{let e=So(),n=ko(e),r=new Date().toISOString();n.lastCompaction=r,n.compactionCount=(n.compactionCount||0)+1,n.compactionHistory||(n.compactionHistory=[]),n.compactionHistory.push({timestamp:r}),n.compactionHistory.length>10&&(n.compactionHistory=n.compactionHistory.slice(-10)),n.avgCompactionIntervalMs=bo(n.compactionHistory);let o=_o(),s=vo();n.preservedContext={branch:process.env.ORCHESTKIT_BRANCH||void 0,sessionNotes:`Compaction #${n.compactionCount} at ${r}`,decisionLog:s,memoryTierSnapshot:{localEntries:o,mem0Available:!!process.env.MEM0_API_KEY}},go(e,JSON.stringify(n,null,2));let c=I(x(),"compaction-history.jsonl");try{yo(c,JSON.stringify({session:g(),timestamp:r,count:n.compactionCount,avgIntervalMs:n.avgCompactionIntervalMs,localMemoryEntries:o,decisionsPreserved:s.length})+`
`)}catch{}i("pre-compact-saver",`Saved state before compaction #${n.compactionCount} (${o} memory entries, ${s.length} decisions preserved)`)}catch(e){let n=e instanceof Error?e.message:String(e);i("pre-compact-saver",`Failed to save state: ${n}`,"warn")}return a()}import{existsSync as de,readFileSync as Io,readdirSync as xo,statSync as $o}from"node:fs";import{join as ct}from"node:path";var wo=[/\bprefill\b/i,/\bpre-fill\b/i,/assistant.*content.*:\s*["']/i,/\bprefilled?\s+(assistant|response|message)/i,/role.*assistant.*content.*(?!$)/i];function Ho(t){return wo.some(e=>e.test(t))}function Co(t){let e=ct(t,"skills"),n=[];if(!de(e))return n;try{let r=xo(e).filter(o=>{try{return $o(ct(e,o)).isDirectory()}catch{return!1}});for(let o of r){let s=ct(e,o,"SKILL.md");if(de(s))try{let c=Io(s,"utf-8");Ho(c)&&n.push(o)}catch{}}}catch{}return n}function Ro(){let t=process.env.CLAUDE_MODEL||"";return/opus/i.test(t)}function me(t){if(!Ro())return a();let e=B(),n=Co(e);return n.length===0?(i("prefill-guard","No prefilling patterns detected in skills"),a()):(i("prefill-guard",`Found prefilling patterns in ${n.length} skills: ${n.join(", ")}`,"warn"),St(`Opus 4.6 breaking change: ${n.length} skill(s) reference response prefilling which is no longer supported. Affected: ${n.slice(0,5).join(", ")}${n.length>5?"...":""}. Migration: use structured outputs or system prompt instructions instead of prefilled assistant messages.`))}import{writeFileSync as Oo,mkdirSync as Eo,existsSync as Do}from"fs";import{join as ge}from"path";async function fe(t){let e=l();if(!e)return{continue:!0};let n=t.teammate_id||t.agent_id||"unknown",r=t.teammate_type||t.subagent_type||"unknown",o=t.idle_duration_ms||0,s=ge(e,".claude","logs");Do(s)||Eo(s,{recursive:!0});let c={timestamp:new Date().toISOString(),event:"teammate_idle",teammate_id:n,teammate_type:r,idle_duration_ms:o,session_id:t.session_id};try{let u=ge(s,"teammate-activity.jsonl");Oo(u,JSON.stringify(c)+`
`,{flag:"a"})}catch{}return o>3e4?{continue:!0,hookSpecificOutput:{additionalContext:`Agent ${r} (${n}) has been idle for ${Math.round(o/1e3)}s. Consider reassigning pending work.`}}:{continue:!0}}import{writeFileSync as Po,mkdirSync as jo,existsSync as To}from"fs";import{join as ye}from"path";async function he(t){let e=l();if(!e)return{continue:!0};let n=t.task_id||"unknown",r=t.task_subject||"",o=t.task_status||"completed",s=t.duration_ms||0,c=ye(e,".claude","logs");To(c)||jo(c,{recursive:!0});let u={timestamp:new Date().toISOString(),event:"task_completed",task_id:n,task_subject:r,task_status:o,duration_ms:s,session_id:t.session_id};try{let d=ye(c,"task-completions.jsonl");Po(d,JSON.stringify(u)+`
`,{flag:"a"})}catch{}return/implement|create|add|fix|build|refactor/i.test(r)&&o==="completed"?{continue:!0,hookSpecificOutput:{additionalContext:`Task "${r}" completed (${Math.round(s/1e3)}s). Consider running tests to verify.`}}:{continue:!0}}var Se={"lifecycle/analytics-consent-check":It,"lifecycle/coordination-cleanup":$t,"lifecycle/coordination-init":Ht,"lifecycle/instance-heartbeat":C,"lifecycle/mem0-analytics-tracker":R,"lifecycle/mem0-context-retrieval":O,"lifecycle/mem0-webhook-setup":Dt,"lifecycle/multi-instance-init":D,"lifecycle/pattern-sync-pull":j,"lifecycle/pattern-sync-push":Nt,"lifecycle/pr-status-enricher":At,"lifecycle/session-cleanup":Kt,"lifecycle/session-context-loader":Wt,"lifecycle/session-env-setup":N,"lifecycle/session-tracking":A,"lifecycle/session-metrics-summary":re,"lifecycle/dependency-version-check":ie,"lifecycle/unified-dispatcher":le,"lifecycle/pre-compact-saver":pe,"lifecycle/prefill-guard":me,"teammate-idle/progress-reporter":fe,"task-completed/completion-tracker":he};function zc(t){return Se[t]}function Gc(){return Object.keys(Se)}export{gi as escapeRegex,Ge as estimateTokenCount,Ze as extractIssueNumber,ht as getCachedBranch,Ve as getCurrentBranch,vi as getDefaultBranch,yt as getEnvFile,di as getField,Ye as getGitStatus,zc as getHook,x as getLogDir,Je as getLogLevel,B as getPluginRoot,l as getProjectDir,Si as getRepoRoot,g as getSessionId,_i as hasUncommittedChanges,Se as hooks,No as isBashInput,Ao as isEditInput,ki as isGitRepo,qe as isProtectedBranch,Lo as isReadInput,Fo as isWriteInput,Gc as listHooks,i as logHook,ui as logPermissionFeedback,mi as normalizeCommand,ei as normalizeLineEndings,ii as outputAllowWithContext,ri as outputBlock,ci as outputDeny,si as outputError,Be as outputPromptContext,li as outputPromptContextBudgeted,ni as outputSilentAllow,a as outputSilentSuccess,St as outputWarning,W as outputWithContext,oi as outputWithNotification,ai as outputWithUpdatedInput,pi as readHookInput,Ke as shouldLog,bi as validateBranchName};
//# sourceMappingURL=lifecycle.mjs.map
