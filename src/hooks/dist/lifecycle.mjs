// OrchestKit Hooks - lifecycle bundle
// Generated: 2026-03-01T09:37:00.300Z

function ts(e){return typeof e.command=="string"}function ns(e){return typeof e.file_path=="string"&&typeof e.content=="string"}function rs(e){return typeof e.file_path=="string"&&typeof e.old_string=="string"&&typeof e.new_string=="string"}function os(e){return typeof e.file_path=="string"&&e.content===void 0}import{existsSync as W,statSync as fn,renameSync as gn,mkdirSync as Ue,readSync as yn,readFileSync as hn,writeFileSync as Sn}from"node:fs";import{join as kn}from"node:path";import{appendFileSync as Bt,mkdirSync as zt}from"node:fs";import{dirname as Gt}from"node:path";var J=[],ue=!1,Pe=!1;function h(e,t){J.push({filePath:e,content:t}),Vt()}function le(){if(ue||J.length===0)return;ue=!0;let e=new Map;for(let t of J){let n=e.get(t.filePath);n?n.push(t.content):e.set(t.filePath,[t.content])}for(let[t,n]of e)try{zt(Gt(t),{recursive:!0}),Bt(t,n.join(""))}catch{}J.length=0,ue=!1}function Vt(){Pe||(Pe=!0,process.on("exit",le),process.on("SIGTERM",()=>{le(),process.exit(0)}),process.on("SIGINT",()=>{le(),process.exit(0)}))}import{execSync as _n}from"node:child_process";import je from"node:os";import j from"node:path";function k(){return process.env.HOME||process.env.USERPROFILE||je.homedir()}function qt(){return je.tmpdir()}function pe(){return process.env.CLAUDE_PROJECT_DIR||"."}function De(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function Ne(){return process.env.CLAUDE_PLUGIN_ROOT?j.join(k(),".claude","logs","ork"):j.join(pe(),".claude","logs")}function v(){return process.env.CLAUDE_METRICS_FILE||j.join(qt(),"claude-session-metrics.json")}var me=j.join,ps=j.sep;import{execSync as Yt}from"node:child_process";import{createHash as Qt}from"node:crypto";import{existsSync as Ae,readFileSync as Xt,writeFileSync as Zt,mkdirSync as en}from"node:fs";import{join as de,basename as tn}from"node:path";var nn=20,rn=15,on=/[^a-z0-9-]/g;function sn(e){let t=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=tn(t);return Fe(n,nn)}function cn(e){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let t=e||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=Yt("git branch --show-current",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),r=Fe(n||"detached",rn);return process.env.ORCHESTKIT_SESSION_BRANCH=r,r}catch{return"nobranch"}}function an(e){let t=e||new Date,n=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");return`${n}${r}`}function un(e){let t=e||new Date,n=String(t.getHours()).padStart(2,"0"),r=String(t.getMinutes()).padStart(2,"0");return`${n}${r}`}function ln(){let e=`${process.pid}-${Date.now()}-${Math.random()}`;return Qt("sha256").update(e).digest("hex").slice(0,4)}function Fe(e,t){return e.toLowerCase().replace(on,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,t)}function pn(e,t){let n=sn(e),r=cn(e),o=an(t),i=un(t),c=ln();return`${n}-${r}-${o}-${i}-${c}`}function mn(e){let t=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=de(t,".instance","session-id.json");if(Ae(n))try{let r=JSON.parse(Xt(n,"utf8"));if(r.session_id&&r.created_at){let o=Date.now()-new Date(r.created_at).getTime(),i=1440*60*1e3;if(o<i)return r.session_id}}catch{}}function dn(e,t){let n=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),r=de(n,".instance"),o=de(r,"session-id.json");try{Ae(r)||en(r,{recursive:!0}),Zt(o,JSON.stringify({session_id:e,created_at:new Date().toISOString()},null,2))}catch{}}function Me(e){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let t=mn(e);if(t)return t;let n=pn(e);return dn(n,e),n}function D(){return Ne()}function p(){return pe()}function fe(){return De()}function Cs(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${fe()}/.claude/.instance_env`}function y(){return Me()}function ws(e){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let t=_n("git branch --show-current",{cwd:e||p(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=t,t}catch{return"unknown"}}function vn(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Is(e){return e.replace(/\r\n/g,`
`)}function xn(e){let t=["debug","info","warn","error"];return t.indexOf(e)>=t.indexOf(vn())}function a(){return{continue:!0,suppressOutput:!0}}function Es(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function Hs(e){return{continue:!1,stopReason:e,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:e}}}function S(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:e}}}function x(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:e}}}function $s(e,t){let n={continue:!0,suppressOutput:!0};return e&&(n.systemMessage=e),t&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:t}),n}function Ts(e,t){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:e,permissionDecision:"allow"}};return t?n.systemMessage=t:n.suppressOutput=!0,n}function Rs(e){return{continue:!0,systemMessage:e}}function Je(e){return{continue:!0,systemMessage:`\u26A0 ${e}`}}function Os(e){process.stderr.write(`\u26A0 ${e}
`),process.exit(2)}function Ps(e){return{continue:!1,stopReason:e,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:e}}}function js(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:e}}}var bn=200*1024,Cn=100*1024;function We(e,t){if(W(e))try{if(fn(e).size>t){let r=`${e}.old.${Date.now()}`;gn(e,r)}}catch{}}function Ke(e){W(e)||Ue(e,{recursive:!0})}function s(e,t,n="debug"){if(!xn(n))return;let r=D(),o=`${r}/hooks.log`;try{Ke(r),We(o,bn);let i=new Date().toISOString().replace("T"," ").slice(0,19);h(o,`[${i}] [${n.toUpperCase()}] [${e}] ${t}
`)}catch{}}function Ds(e,t,n){let r=D(),o=`${r}/permission-feedback.log`;try{Ke(r),We(o,Cn);let i=new Date().toISOString(),c=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",l=n?.session_id||y();h(o,`${i} | ${e} | ${t} | tool=${c} | session=${l}
`)}catch{}}function Be(e){return e.hookSpecificOutput?.additionalContext?e.hookSpecificOutput.additionalContext:e.systemMessage&&typeof e.systemMessage=="string"?e.systemMessage:null}function wn(e){if(!e)return 0;let r=(e.match(/[{};()=><]/g)||[]).length/e.length>.03?2.8:3.5;return Math.ceil(e.length/r)}function Ns(e,t,n,r,o){let i=wn(e);return r?.isOverBudget(n)?(s(t,`Budget exhausted for ${n}, suppressing ${i}t`),a()):(o&&o.trackTokenUsage(t,n,i),x(e))}function Le(e){let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return(t>>>0).toString(16).padStart(8,"0")}function ze(e,t,n,r){let o=kn(e,t);if(W(o))try{let i=hn(o,"utf8");if(Le(i)===Le(n))return s(r,`Rules file ${t} unchanged, skipping write`),!1}catch{}return W(e)||Ue(e,{recursive:!0}),Sn(o,n,"utf8"),s(r,`Wrote rules file: ${o}`),!0}function As(){try{let e=[],n=Buffer.allocUnsafe(256),r,o=0;for(;;)try{if(r=yn(o,n,0,256,null),r===0)break;e.push(Buffer.from(n.subarray(0,r)))}catch{break}let i=Buffer.concat(e).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:y(),tool_input:{}}}catch{return{tool_name:"",session_id:y(),tool_input:{}}}}function Fs(e,t){let n=t.replace(/^\./,"").split("."),r=e;for(let o of n){if(r==null)return;r=r[o]}return r}function Ms(e,...t){return e.split(`
`).some(n=>t.every(r=>n.includes(r)))}function ge(e,...t){return e.split(`
`).some(n=>{let r=n.toLowerCase();return t.every(o=>r.includes(o.toLowerCase()))})}function Ls(e){return e.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function Us(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}import{execSync as b}from"node:child_process";function In(e){let t=e||p();try{return b("git branch --show-current",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return"unknown"}}function En(e){let t=e||In();return["dev","main","master"].includes(t)}function Bs(e){let t=e||p();try{return b("git rev-parse --show-toplevel",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return t}}function zs(e){let t=e||p();try{return b("git rev-parse --git-dir",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),!0}catch{return!1}}function Hn(e){let t=e||p();try{return b("git status --short",{cwd:t,encoding:"utf8",timeout:1e4,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function Gs(e){return Hn(e).length>0}function Vs(e){let t=e||p();try{return b("git rev-parse --verify main",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"main"}catch{try{return b("git rev-parse --verify master",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"master"}catch{return"main"}}}function $n(e){let t=[/issue\/(\d+)/i,/feature\/(\d+)/i,/fix\/(\d+)/i,/bug\/(\d+)/i,/feat\/(\d+)/i,/^(\d+)-/,/-(\d+)$/,/#(\d+)/];for(let n of t){let r=e.match(n);if(r)return parseInt(r[1],10)}return null}function Tn(e){let t=e||p();try{let n=b("git diff --cached --name-only",{cwd:t,encoding:"utf8",timeout:1e4,stdio:["pipe","pipe","pipe"]}).trim();return n?n.split(`
`).filter(r=>r.trim()):[]}catch{return[]}}function qs(e){let t=Tn(e),n=new Set,r=new Set,o=!1,i=!1,c=!1,l=!1;for(let u of t){let m=u.split("/");m.length>1&&(n.add(m[0]),m.length>2&&n.add(`${m[0]}/${m[1]}`));let f=u.split(".").pop()||"";r.add(f),/\.(test|spec)\.\w+$/.test(u)||/^tests?\//.test(u)||/__tests__\//.test(u)?o=!0:/\.(md|mdx|txt|rst)$/.test(u)||/^docs?\//.test(u)||u==="README.md"?c=!0:/\.(json|ya?ml|toml|ini|cfg|env)$/.test(u)||/config/i.test(u)||u==="package.json"||u==="tsconfig.json"?i=!0:l=!0}return{files:t,directories:n,extensions:r,hasTests:o,hasConfig:i,hasDocs:c,hasSource:l}}function Ys(e){if(En(e))return null;let t=["issue/","feature/","fix/","bug/","feat/","chore/","docs/","refactor/","test/","ci/","perf/","style/","release/","hotfix/"];return t.some(r=>e.startsWith(r))?e.startsWith("issue/")&&!$n(e)?"issue/ branches should include an issue number (e.g., issue/123-description)":null:`Branch name should start with a valid prefix: ${t.join(", ")}`}import{existsSync as Ge,readFileSync as Ve}from"node:fs";function Rn(e){let t=`${e}/.claude/feedback/consent-status.json`;if(!Ge(t))return{consented:!1,asked:!1};try{let n=JSON.parse(Ve(t,"utf-8"));return{consented:n.consented===!0,asked:n.asked===!0}}catch{return{consented:!1,asked:!1}}}function On(e){let t=`${e}/.claude/feedback/consent-log.json`;if(!Ge(t))return null;try{let n=JSON.parse(Ve(t,"utf-8"));if(n.events&&n.events.length>0)return n.events[n.events.length-1]}catch{}return null}function Pn(e){try{let t=new Date(e);return Math.floor((new Date().getTime()-t.getTime())/(1e3*60*60*24))>=30}catch{return!1}}function K(e){let t=e.project_dir||p(),n=Rn(t);if(n.consented)return s("analytics-consent-check","User has consented to analytics"),a();if(n.asked){let r=On(t);return r&&(r.action==="declined"||r.action==="revoked")&&Pn(r.timestamp)?(s("analytics-consent-check","Showing 30-day reminder"),{continue:!0,systemMessage:"Reminder: Anonymous analytics help improve OrchestKit. Enable with /ork:feedback opt-in"}):(s("analytics-consent-check","User recently declined, not prompting"),a())}return s("analytics-consent-check","First time user, showing brief notice"),{continue:!0,systemMessage:"OrchestKit collects local usage metrics. Share anonymously with /ork:feedback opt-in"}}import{existsSync as B,readFileSync as ye,writeFileSync as jn,statSync as Dn,mkdirSync as Nn}from"node:fs";var An=1*1024*1024;function Fn(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Mn(e){let t=`${e}/.claude/feedback/sync-config.json`;if(!B(t))return!0;try{return JSON.parse(ye(t,"utf-8")).sync_enabled!==!1}catch{return!0}}function qe(e){if(!B(e))return!0;try{let t=Dn(e);return t.size>An?(s("pattern-sync-pull",`WARN: Skipping - file too large: ${e} (${t.size} bytes)`),!1):!0}catch{return!0}}function Ln(e){let n=`${k()}/.claude/global-patterns.json`,r=`${e}/.claude/feedback/learned-patterns.json`;if(!B(n)){s("pattern-sync-pull","No global patterns file found");return}try{let i=JSON.parse(ye(n,"utf-8")).patterns||[];if(i.length===0){s("pattern-sync-pull","No global patterns to pull");return}let c={version:"1.0",patterns:[]};if(B(r))try{c=JSON.parse(ye(r,"utf-8"))}catch{}let l=c.patterns||[],u=new Set(l.map(d=>d.text)),m=i.filter(d=>!u.has(d.text));if(m.length===0){s("pattern-sync-pull","All global patterns already in project");return}let f=[...l,...m];c.patterns=f,Nn(`${e}/.claude/feedback`,{recursive:!0}),jn(r,JSON.stringify(c,null,2)),s("pattern-sync-pull",`Pulled ${m.length} new patterns from global`)}catch(o){s("pattern-sync-pull",`Failed to pull global patterns: ${o}`)}}function z(e){if(Fn())return s("pattern-sync-pull","Skipping pattern sync (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();let t=e.project_dir||p();if(!Mn(t))return s("pattern-sync-pull","Global sync disabled, skipping pull"),a();let n=`${k()}/.claude/global-patterns.json`,r=`${t}/.claude/feedback/learned-patterns.json`;return!qe(n)||!qe(r)?(s("pattern-sync-pull","Skipping pattern sync due to large files"),a()):(s("pattern-sync-pull","Pulling global patterns..."),Ln(t),s("pattern-sync-pull","Global patterns pulled successfully"),a())}import{existsSync as he,readFileSync as Se,writeFileSync as Un,mkdirSync as Jn}from"node:fs";function Wn(e){let t=`${e}/.claude/feedback/sync-config.json`;if(!he(t))return!0;try{return JSON.parse(Se(t,"utf-8")).sync_enabled!==!1}catch{return!0}}function Kn(e){let t=`${e}/.claude/feedback/learned-patterns.json`,n=k(),r=`${n}/.claude/global-patterns.json`;if(!he(t)){s("pattern-sync-push","No project patterns file found");return}try{let i=JSON.parse(Se(t,"utf-8")).patterns||[];if(i.length===0){s("pattern-sync-push","No project patterns to push");return}let c={version:"1.0",patterns:[],updated:""};if(he(r))try{c=JSON.parse(Se(r,"utf-8"))}catch{}let l=c.patterns||[],u=new Set(l.map(d=>d.text)),m=i.filter(d=>!u.has(d.text));if(m.length===0){s("pattern-sync-push","All project patterns already in global");return}let f=[...l,...m];c.patterns=f,c.updated=new Date().toISOString(),Jn(`${n}/.claude`,{recursive:!0}),Un(r,JSON.stringify(c,null,2)),s("pattern-sync-push",`Pushed ${m.length} new patterns to global`)}catch(o){s("pattern-sync-push",`Failed to push project patterns: ${o}`)}}function G(e){let t=e.project_dir||p();return Wn(t)?(s("pattern-sync-push","Pushing project patterns to global..."),Kn(t),a()):(s("pattern-sync-push","Global sync disabled, skipping push"),a())}import{existsSync as F,readFileSync as rr,writeFileSync as or,mkdirSync as sr,readdirSync as tt,unlinkSync as nt,copyFileSync as ir}from"node:fs";import{join as et}from"node:path";import{homedir as cr}from"node:os";import{existsSync as N,readFileSync as Bn,readdirSync as zn,statSync as Ye,rmSync as Gn}from"node:fs";import{join as E}from"node:path";function A(){return process.env.CLAUDE_CODE_TEAM_NAME||null}function Qe(){let e=A();if(!e)return[];let t=process.env.HOME||process.env.USERPROFILE||"";if(!t)return[];let n=E(t,".claude","teams",e,"config.json");if(!N(n))return[];try{let o=JSON.parse(Bn(n,"utf-8")).members;return Array.isArray(o)?o.map(i=>({name:i.name||"unknown",agentType:i.agentType||"unknown"})):[]}catch{return[]}}function Xe(){let e=process.env.HOME||process.env.USERPROFILE||"";if(!e)return[];let t=E(e,".claude","teams");if(!N(t))return[];try{return zn(t).filter(n=>{try{return Ye(E(t,n)).isDirectory()}catch{return!1}})}catch{return[]}}function Ze(e,t=4){let n=process.env.HOME||process.env.USERPROFILE||"";if(!n)return!1;let r=E(n,".claude","teams",e);if(!N(r))return!1;let o=E(r,"config.json");if(!N(o))return!0;try{return Date.now()-Ye(r).mtimeMs>t*36e5}catch{return!0}}function V(e){let t=process.env.HOME||process.env.USERPROFILE||"";if(!t)return!1;let n=!0;for(let r of["teams","tasks"]){let o=E(t,".claude",r,e);if(N(o))try{Gn(o,{recursive:!0,force:!0})}catch{n=!1}}return n}import{mkdirSync as Vn,statSync as qn,renameSync as Yn}from"node:fs";import{createHash as Qn}from"node:crypto";function Xn(){return me(k(),".claude","analytics")}function H(e){return Qn("sha256").update(e).digest("hex").slice(0,12)}function $(){let e=process.env.CLAUDE_CODE_TEAM_NAME;return e?{team:e}:void 0}function Zn(e,t=10485760){try{if(qn(e).size>t){let r=new Date().toISOString().slice(0,7),o=e.replace(/\.jsonl$/,`.${r}.jsonl`);Yn(e,o)}}catch{}}function er(){return!!(process.env.VITEST||process.env.JEST_WORKER_ID)}function T(e,t){if(!er())try{let n=Xn();Vn(n,{recursive:!0});let r=me(n,e);Zn(r),h(r,`${JSON.stringify(t)}
`)}catch{}}import{existsSync as tr,readFileSync as nr}from"node:fs";function ke(){let e=v();if(!tr(e))return 0;try{let n=JSON.parse(nr(e,"utf-8")).tools||{};return Object.values(n).reduce((r,o)=>r+o,0)}catch{return 0}}function ar(e,t){if(!F(e))return;let n=ke();if(n<=5){s("session-cleanup",`Session had only ${n} tool calls, not archiving`);return}try{sr(t,{recursive:!0});let o=`session-${new Date().toISOString().replace(/[:.]/g,"-")}.json`,i=`${t}/${o}`;ir(e,i),s("session-cleanup",`Archived session metrics to ${o}`)}catch(r){s("session-cleanup",`Failed to archive metrics: ${r}`)}}function ur(e,t=20){if(F(e))try{let n=tt(e).filter(o=>o.startsWith("session-")&&o.endsWith(".json")).sort().reverse();if(n.length<=t)return;let r=n.slice(t);for(let o of r)try{nt(`${e}/${o}`),s("session-cleanup",`Deleted old archive: ${o}`)}catch{}}catch(n){s("session-cleanup",`Failed to cleanup old archives: ${n}`)}}function lr(e){if(!F(e))return;let t=["hooks.log.old*","audit.log.old*"];for(let n of t)try{let r=n.replace(/\*/g,""),o=tt(e).filter(c=>c.startsWith(r)).sort().reverse();if(o.length<=5)continue;let i=o.slice(5);for(let c of i)try{nt(`${e}/${c}`)}catch{}}catch{}}function pr(e){if(!e||typeof e!="string"||e==="No prompt")return e||"";let t=e;if(t.includes("<task-notification>")){let i=t.match(/<summary>(.*?)<\/summary>/s);return i?i[1].trim():"(background task)"}let n=t.match(/<command-args>(.*?)(?:<\/command-args>|$)/s),r=t.match(/<command-name>(.*?)<\/command-name>/);if(r||n){let i=[];if(r&&i.push(r[1].trim()),n){let c=n[1].trim();c&&i.push(c)}if(i.length>0)return i.join(" ")}t=t.replace(/<[^>]+>/g," "),t=t.replace(/[\u2500-\u259f]/g,"");let o=t.indexOf("\u276F");return o!==-1?t=t.slice(o+1):(t=t.replace(/Claude Code v[\d.]+/g,""),t=t.replace(/Opus [\d.]+\s*[·.]\s*Claude Max/g,"")),t=t.replace(/[✻⏺⎿]\s*/g,""),t=t.replace(/Conversation compacted[^)]*\)/g,""),t=t.replace(/Referenced file [^\s]+/g,""),t=t.replace(/\s+(Bash|Read|Write|Edit|Glob|Grep|Task|Skill)\(.*$/s,""),t=t.replace(/~\/[\w/._-]+/g,""),t=t.replace(/[…]+/g,""),t=t.replace(/\s+/g," ").trim(),t}function mr(e){let t=cr(),n=et(t,".claude","projects");if(!F(n))return;let r=e.replace(/\//g,"-"),o=et(n,r,"sessions-index.json");if(!F(o)){s("session-cleanup","No sessions-index.json found");return}try{let i=JSON.parse(rr(o,"utf-8")),c=0;for(let l of i.entries){if(!l.firstPrompt||l.firstPrompt==="No prompt")continue;let u=pr(l.firstPrompt);(!u||u.length<10)&&(u=l.summary||l.firstPrompt),u!==l.firstPrompt&&(l.firstPrompt=u,c++)}c>0&&(or(o,JSON.stringify(i,null,4)),s("session-cleanup",`Sanitized ${c} session firstPrompt entries`))}catch(i){s("session-cleanup",`Failed to sanitize sessions index: ${i}`,"warn")}}function q(e){s("session-cleanup","Session cleanup starting");let t=e.project_dir||p(),n=v(),r=`${t}/.claude/logs/sessions`,o=`${t}/.claude/logs`;mr(t),ar(n,r),ur(r,20),lr(o);let i=process.env.CLAUDE_CODE_TEAM_NAME;if(i){let l=V(i);s("session-cleanup",l?`Cleaned team "${i}" directories`:`Warning: partial cleanup for team "${i}"`)}let c=ke();if(c>0){let l=e.last_assistant_message?.length??null;T("session-summary.jsonl",{ts:new Date().toISOString(),pid:H(t),total_tools:c,added_dirs_count:(e.added_dirs??[]).length,...l!==null&&{last_msg_len:l},...$()})}return s("session-cleanup","Session cleanup complete"),a()}import{existsSync as _e,readFileSync as rt}from"node:fs";function M(e){if(!_e(e))return!1;try{return JSON.parse(rt(e,"utf-8")),!0}catch{return!1}}function Y(e){s("session-context-loader","Session starting - loading context (Protocol 2.0)");let t=e.project_dir||p(),n=0,r=process.env.AGENT_TYPE||"",o=`${t}/.claude/context/session/state.json`,i=`${t}/.claude/context/identity.json`,c=`${t}/.claude/context/knowledge/index.json`;M(o)&&(s("session-context-loader","Session state loaded"),n++),M(i)&&(s("session-context-loader","Identity loaded"),n++),M(c)&&(s("session-context-loader","Knowledge index available"),n++);let l=`${t}/docs/CURRENT_STATUS.md`;if(_e(l)&&s("session-context-loader","Current status document exists"),r){s("session-context-loader",`Agent-type aware initialization: ${r}`);let m=`${t}/.claude/agents/${r}.md`;_e(m)&&(s("session-context-loader",`Agent configuration found: ${m}`),n++)}if(e.added_dirs&&e.added_dirs.length>0)for(let m of e.added_dirs){let f=`${m}/.claude/context/session/state.json`;M(f)&&(s("session-context-loader",`Additional context from added dir: ${m}`),n++)}let u=`${t}/.claude/context/session/compaction-manifest.json`;if(M(u))try{let m=JSON.parse(rt(u,"utf-8"));s("session-context-loader",`Compaction manifest loaded: session=${m.sessionId}, decisions=${(m.keyDecisions||[]).length}, files=${(m.filesTouched||[]).length}`),process.env.ORCHESTKIT_LAST_SESSION=m.sessionId||"",process.env.ORCHESTKIT_LAST_DECISIONS=JSON.stringify(m.keyDecisions||[]),n++}catch(m){s("session-context-loader",`Error loading compaction manifest: ${m}`)}return n>0&&(r?s("session-context-loader",`Session context loaded (Protocol 2.0) - Agent: ${r}`):s("session-context-loader","Session context loaded (Protocol 2.0)")),a()}import{existsSync as dr,readFileSync as fr,writeFileSync as ot,mkdirSync as gr}from"node:fs";import{execSync as yr}from"node:child_process";function hr(e){try{return yr("git branch --show-current",{cwd:e,encoding:"utf-8",timeout:500,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function Q(e){s("session-env-setup","Setting up session environment");let t=e.project_dir||p(),n=e.session_id||y(),r=v();try{gr(`${t}/.claude/logs`,{recursive:!0})}catch{}let o=process.env.AGENT_TYPE||"";!o&&e.agent_type&&(o=e.agent_type);let i={session_id:n,started_at:new Date().toISOString(),agent_type:o,tools:{},errors:0,warnings:0};try{ot(r,JSON.stringify(i,null,2)),s("session-env-setup","Initialized session metrics")}catch(u){s("session-env-setup",`Failed to initialize metrics: ${u}`)}let c=`${t}/.claude/context/session/state.json`;if(dr(c)&&o)try{let u=JSON.parse(fr(c,"utf-8"));u.agent_type=o,u.session_id=n,u.last_activity=new Date().toISOString(),ot(c,JSON.stringify(u,null,2)),s("session-env-setup",`Updated session state with agent_type: ${o}`)}catch(u){s("session-env-setup",`Failed to update session state: ${u}`)}let l=hr(t);return l&&s("session-env-setup",`Git branch: ${l}`),o&&s("session-env-setup",`Agent type: ${o}`),a()}import{existsSync as lt,mkdirSync as Hr,readFileSync as $r,writeFileSync as Tr}from"node:fs";import{existsSync as Sr,readFileSync as kr,writeFileSync as Fi,mkdirSync as Mi}from"node:fs";import{execSync as st}from"node:child_process";import{createHash as _r}from"node:crypto";import*as it from"node:os";var vr=".claude/.user_identity.json",xr="orchestkit-user-identity-v1";var g=null;function X(e){return _r("sha256").update(e+xr).digest("hex").slice(0,32)}function br(){try{return it.hostname()}catch{return"unknown-machine"}}function Cr(e){let t=`${e}/${vr}`;if(!Sr(t))return null;try{let n=kr(t,"utf8");return JSON.parse(n)}catch(n){return s("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function wr(e){let t={};try{t.email=st("git config user.email",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{t.name=st("git config user.name",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return t}function Ir(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function Er(e){if(g)return g;let t=e||p(),n=br(),r=Cr(t);if(r?.user_id)return g={user_id:r.user_id,display_name:r.display_name||r.user_id,team_id:r.team_id,machine_id:n,source:"config",anonymous_id:X(r.user_id),email:r.user_id.includes("@")?r.user_id:void 0},s("user-identity",`Resolved from config: ${g.anonymous_id}`,"debug"),g;let o=wr(t);if(o.email)return g={user_id:o.email,display_name:o.name||o.email.split("@")[0],team_id:r?.team_id,machine_id:n,source:"git",anonymous_id:X(o.email),email:o.email},s("user-identity",`Resolved from git: ${g.anonymous_id}`,"debug"),g;let i=Ir();if(i.username){let l=`${i.username}@${n}`;return g={user_id:l,display_name:i.username,team_id:r?.team_id,machine_id:n,source:"env",anonymous_id:X(l)},s("user-identity",`Resolved from env: ${g.anonymous_id}`,"debug"),g}let c=X(n+process.pid);return g={user_id:`anon-${c.slice(0,8)}`,display_name:"Anonymous",team_id:r?.team_id,machine_id:n,source:"anonymous",anonymous_id:c},s("user-identity",`Resolved as anonymous: ${g.anonymous_id}`,"debug"),g}function ct(){let e=Er();return{session_id:y(),user_id:e.user_id,anonymous_id:e.anonymous_id,team_id:e.team_id,machine_id:e.machine_id,identity_source:e.source,timestamp:new Date().toISOString()}}var Rr=/^[a-zA-Z0-9_-]{1,128}$/;function Or(e){return Rr.test(e)}function be(e,t){let n=e||y(),r=t||p();if(!Or(n))throw new Error("Invalid session ID format");return`${r}/.claude/memory/sessions/${n}`}function Pr(e,t){return`${be(e,t)}/events.jsonl`}function pt(e,t){let n=be(e,t);lt(n)||Hr(n,{recursive:!0})}var L=0,at=!1,ve=!1,ut=0,jr=5e3;function mt(e,t){return`${be(e,t)}/counter.json`}function Dr(e,t){if(!at){at=!0;try{let n=mt(e,t);if(lt(n)){let r=JSON.parse($r(n,"utf8"));typeof r.counter=="number"&&r.counter>0&&(L=r.counter,s("session-tracker",`Loaded event counter: ${L}`,"debug"))}}catch{}}}function Nr(e,t){if(!ve)return;let n=Date.now();if(!(n-ut<jr))try{pt(e,t);let r=mt(e,t);Tr(r,JSON.stringify({counter:L,updated_at:new Date().toISOString()})),ve=!1,ut=n}catch{}}function Ar(){return Dr(),L++,ve=!0,Nr(),`evt-${Date.now()}-${L}`}function Fr(e,t,n={}){try{let r={event_id:Ar(),event_type:e,identity:ct(),payload:{name:t,input:xe(n.input),output:xe(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?ft(n.context,500):void 0,confidence:n.confidence}};pt();let o=Pr();h(o,`${JSON.stringify(r)}
`),s("session-tracker",`Tracked ${e}: ${t}`,"debug")}catch(r){s("session-tracker",`Failed to track event: ${r}`,"warn")}}function Mr(e){return e>=5&&e<12?"morning":e>=12&&e<17?"afternoon":e>=17&&e<21?"evening":"night"}function dt(e){let t=new Date,n={project_dir:e?.project_dir,git_branch:e?.git_branch,time_of_day:e?.time_of_day||Mr(t.getHours()),started_at:t.toISOString()};Fr("session_start","session",{success:!0,input:n})}function ft(e,t){return e.length<=t?e:`${e.slice(0,t-3)}...`}function xe(e){if(!e)return;let t={},n=["password","secret","token","key","credential","auth"];for(let[r,o]of Object.entries(e)){if(n.some(i=>r.toLowerCase().includes(i))){t[r]="[REDACTED]";continue}if(typeof o=="string"&&o.length>500){t[r]=ft(o,500);continue}if(typeof o=="object"&&o!==null&&!Array.isArray(o)){t[r]=xe(o);continue}t[r]=o}return t}import{execSync as Lr}from"node:child_process";function Ur(e){try{return Lr("git rev-parse --abbrev-ref HEAD",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()||void 0}catch{return}}function Z(e){try{let t=e.project_dir||p(),n=Ur(t);return dt({project_dir:t,git_branch:n,added_dirs_count:(e.added_dirs??[]).length}),s("session-tracking",`Tracked session start: branch=${n||"unknown"}`,"debug"),a()}catch(t){return s("session-tracking",`Error: ${t}`,"warn"),a()}}import{existsSync as Jr,readFileSync as Wr}from"node:fs";function ee(e){s("session-metrics-summary","Session ending - generating summary");let t=v();if(!Jr(t))return s("session-metrics-summary","No metrics file found"),a();try{let n=JSON.parse(Wr(t,"utf-8")),r=n.tools||{},o=n.errors||0,i=Object.values(r).reduce((l,u)=>l+u,0),c=Object.entries(r).sort(([,l],[,u])=>u-l).slice(0,3).map(([l,u])=>`${l}: ${u}`).join(", ");s("session-metrics-summary",`Session stats: ${i} tool calls, ${o} errors`),i>0&&s("session-metrics-summary",`Top tools: ${c}`)}catch(n){s("session-metrics-summary",`Failed to read metrics: ${n}`)}return a()}import{existsSync as C,readFileSync as we,writeFileSync as Kr,mkdirSync as Br}from"node:fs";var zr=[{package:"lodash",pattern:"<4.17.21",severity:"high",cve:"CVE-2021-23337",description:"Prototype pollution"},{package:"minimist",pattern:"<1.2.6",severity:"critical",cve:"CVE-2021-44906",description:"Prototype pollution"},{package:"node-fetch",pattern:"<2.6.7",severity:"high",cve:"CVE-2022-0235",description:"Information exposure"},{package:"axios",pattern:"<0.21.2",severity:"high",cve:"CVE-2021-3749",description:"ReDoS vulnerability"},{package:"jsonwebtoken",pattern:"<9.0.0",severity:"critical",cve:"CVE-2022-23529",description:"Insecure token verification"},{package:"express",pattern:"<4.17.3",severity:"medium",cve:"CVE-2022-24999",description:"Open redirect"},{package:"tar",pattern:"<6.1.11",severity:"critical",cve:"CVE-2021-37701",description:"Arbitrary file overwrite"},{package:"path-parse",pattern:"<1.0.7",severity:"medium",cve:"CVE-2021-23343",description:"ReDoS vulnerability"},{package:"django",pattern:"<3.2.14",severity:"high",cve:"CVE-2022-34265",description:"SQL injection"},{package:"flask",pattern:"<2.0.2",severity:"medium",cve:"CVE-2021-28091",description:"Path traversal"},{package:"requests",pattern:"<2.28.0",severity:"medium",cve:"CVE-2023-32681",description:"Information disclosure"},{package:"urllib3",pattern:"<1.26.5",severity:"high",cve:"CVE-2021-33503",description:"ReDoS vulnerability"},{package:"pillow",pattern:"<9.0.0",severity:"high",cve:"CVE-2022-22817",description:"Buffer overflow"},{package:"pyyaml",pattern:"<5.4",severity:"critical",cve:"CVE-2020-14343",description:"Arbitrary code execution"},{package:"jinja2",pattern:"<3.0.3",severity:"medium",cve:"CVE-2020-28493",description:"XSS vulnerability"},{package:"sqlalchemy",pattern:"<1.4.46",severity:"medium",cve:"CVE-2023-30533",description:"SQL injection"}],Gr=24;function Vr(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function qr(e,t){let n=e.split(".").map(o=>parseInt(o,10)||0),r=t.split(".").map(o=>parseInt(o,10)||0);for(let o=0;o<Math.max(n.length,r.length);o++){let i=n[o]||0,c=r[o]||0;if(i<c)return!0;if(i>c)return!1}return!1}function Yr(e,t){let n=t.charAt(0),r=t.substring(1);return n==="<"?qr(e,r):n==="="?e===r:!1}function Qr(e){return e.replace(/^[^~>=<]/,"").replace(/,.*$/,"").trim()}function gt(e,t){let n=Qr(t),r=e.toLowerCase();for(let o of zr)if(r===o.package&&Yr(n,o.pattern))return o;return null}function Xr(e){if(!C(e))return null;try{let t=JSON.parse(we(e,"utf-8"));if((Date.now()-t.timestamp)/(1e3*60*60)<Gr)return t.warnings}catch{}return null}function Ce(e,t){try{Br(e.replace(/\/[^/]+$/,""),{recursive:!0});let n={warnings:t,timestamp:Date.now()};Kr(e,JSON.stringify(n,null,2))}catch{}}function Zr(e){let t=0,n=0,r="";if(!C(e))return{criticalCount:t,highCount:n,warnings:r};try{let o=JSON.parse(we(e,"utf-8")),i={...o.dependencies,...o.devDependencies};for(let[c,l]of Object.entries(i)){let u=gt(c,l);u&&(u.severity==="critical"&&t++,u.severity==="high"&&n++,r+=`
- ${c}@${l}: ${u.description} (${u.cve}, ${u.severity}) - upgrade to ${u.pattern}`)}}catch{}return{criticalCount:t,highCount:n,warnings:r}}function eo(e){let t=0,n=0,r="";if(!C(e))return{criticalCount:t,highCount:n,warnings:r};try{let i=we(e,"utf-8").split(`
`);for(let c of i){let l=c.trim();if(!l||l.startsWith("#"))continue;let u=l.match(/^([a-zA-Z0-9_-]+)(?:==|>=|~=|!=|<|>)\s*([0-9.]+)/);if(!u)continue;let[,m,f]=u,d=gt(m,f);d&&(d.severity==="critical"&&t++,d.severity==="high"&&n++,r+=`
- ${m}==${f}: ${d.description} (${d.cve}, ${d.severity}) - upgrade to ${d.pattern}`)}}catch{}return{criticalCount:t,highCount:n,warnings:r}}function yt(e){if(Vr())return s("dependency-version-check","Skipping dependency check (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();s("dependency-version-check","Starting dependency version check");let t=e.project_dir||p(),n=`${t}/.claude/feedback/dependency-check-cache.json`,r=C(`${t}/package.json`),o=C(`${t}/requirements.txt`),i=C(`${t}/pyproject.toml`),c=C(`${t}/go.mod`);if(!r&&!o&&!i&&!c)return s("dependency-version-check","No package files found, skipping check"),Ce(n,"none"),a();let l=Xr(n);if(l!==null)return s("dependency-version-check","Using cached dependency warnings"),l!=="none"?S(`DEPENDENCY SECURITY CHECK (cached): ${l}`):a();let u=0,m=0,f="";if(r){let d=Zr(`${t}/package.json`);u+=d.criticalCount,m+=d.highCount,d.warnings&&(f+=`

Node.js (package.json):${d.warnings}`)}if(o){let d=eo(`${t}/requirements.txt`);u+=d.criticalCount,m+=d.highCount,d.warnings&&(f+=`

Python (requirements.txt):${d.warnings}`)}if(f){let d=`Found ${u} critical and ${m} high severity vulnerabilities`,_=`DEPENDENCY SECURITY CHECK: ${d}${f}

Run 'npm audit' or 'pip-audit' for full details.`;if(Ce(n,_),s("dependency-version-check",d),u>0||m>0)return S(_)}else Ce(n,"none"),s("dependency-version-check","No known vulnerabilities found");return a()}import{existsSync as Ie,readFileSync as St,mkdirSync as to}from"node:fs";import{join as R,dirname as no}from"node:path";function ht(e){if(!Ie(e))return 0;try{return St(e,"utf8").trim().split(`
`).filter(n=>n.trim()).length}catch{return 0}}function ro(e){if(!Ie(e))return 0;try{let n=St(e,"utf8").trim().split(`
`).filter(o=>o.trim()),r=0;for(let o of n)try{JSON.parse(o).event==="session_start"&&r++}catch{}return r}catch{return 0}}function Ee(e){let t=e||p(),n=R(t,".claude","memory"),r=R(t,".claude","logs"),o=R(n,"graph-queue.jsonl"),i=R(n,"completed-flows.jsonl"),c=R(r,"analytics.jsonl");return{timestamp:new Date().toISOString(),decisions:{total:0,byCategory:{},byType:{}},queues:{graphQueueDepth:ht(o)},completedFlows:ht(i),sessionCount:ro(c)}}function kt(e,t){let n=e||p(),r=R(n,".claude","logs","memory-metrics.jsonl"),o=t||Ee(n);try{let i=no(r);Ie(i)||to(i,{recursive:!0}),h(r,`${JSON.stringify(o)}
`),s("memory-metrics",`Metrics snapshot appended: ${o.decisions.total} decisions`,"debug")}catch(i){s("memory-metrics",`Failed to write metrics: ${i}`,"warn")}}function _t(e){s("memory-metrics-collector","Collecting memory metrics");try{let t=e.project_dir||p(),n=Ee(t);kt(t,n)}catch(t){s("memory-metrics-collector",`Failed to collect metrics: ${t}`,"warn")}return a()}var oo=4;function vt(e){let t=Xe();if(t.length===0)return a();let n=0;for(let r of t)Ze(r,oo)&&(V(r)?n++:s("stale-team-cleanup",`Failed to clean team "${r}"`));return n>0&&s("stale-team-cleanup",`Cleaned ${n} stale team(s)`),a()}import{execSync as so}from"node:child_process";import{writeFileSync as xt,mkdirSync as io,existsSync as wt}from"node:fs";import{join as He}from"node:path";var bt=15e3;function co(e){let t=[],n=/^(.+?)\((\d+),(\d+)\):\s+error\s+(TS\d+):\s+(.+)$/gm;for(let r of e.matchAll(n))t.push({file:r[1],line:parseInt(r[2],10),column:parseInt(r[3],10),code:r[4],message:r[5]});return t}function Ct(e){let t=He(p(),".claude","cache");return wt(t)||io(t,{recursive:!0}),He(t,`type-errors-${e}.json`)}function ao(e){return wt(He(e,"tsconfig.json"))}function It(e){let t=e.project_dir||p();if(!ao(t))return s("type-error-indexer","No tsconfig.json found, skipping"),a();let n=e.session_id||"unknown";try{so("npx tsc --noEmit 2>&1",{cwd:t,timeout:bt,encoding:"utf-8",stdio:["pipe","pipe","pipe"]});let r={timestamp:performance.timeOrigin+performance.now(),errorCount:0,errors:[],summary:"No type errors found"};xt(Ct(n),JSON.stringify(r,null,2)),s("type-error-indexer","No type errors found")}catch(r){let o=r;if(o.killed)return s("type-error-indexer",`tsc timed out after ${bt}ms`,"warn"),a();let i=(o.stdout||"")+(o.stderr||""),c=co(i);if(c.length===0)return s("type-error-indexer","tsc failed but no parseable errors","warn"),a();let l=new Set(c.map(f=>f.file)),u=`${c.length} type error${c.length!==1?"s":""} in ${l.size} file${l.size!==1?"s":""}`,m={timestamp:performance.timeOrigin+performance.now(),errorCount:c.length,errors:c.slice(0,50),summary:u};xt(Ct(n),JSON.stringify(m,null,2)),s("type-error-indexer",`Cached: ${u}`)}return a()}var Et=[{name:"pattern-sync-pull",fn:z},{name:"session-env-setup",fn:Q},{name:"session-tracking",fn:Z},{name:"memory-metrics-collector",fn:_t},{name:"stale-team-cleanup",fn:vt},{name:"type-error-indexer",fn:It}];async function Ht(e){let t=await Promise.allSettled(Et.map(async r=>{try{let o=r.fn(e);return o instanceof Promise&&await o,{hook:r.name,status:"success"}}catch(o){let i=o instanceof Error?o.message:String(o);return s("session-start-dispatcher",`${r.name} failed: ${i}`),{hook:r.name,status:"error",message:i}}})),n=[];for(let r of t)r.status==="rejected"?n.push("unknown"):r.value.status==="error"&&n.push(r.value.hook);return n.length>0&&s("session-start-dispatcher",`${n.length}/${Et.length} hooks failed: ${n.join(", ")}`),a()}import{writeFileSync as uo,existsSync as U,readFileSync as te,mkdirSync as lo,readdirSync as po}from"node:fs";import{execSync as mo}from"node:child_process";import{join as w}from"node:path";function fo(){let e=D(),t=w(e,"sessions");return U(t)||lo(t,{recursive:!0}),w(t,`${y()}-state.json`)}function go(e){try{if(U(e))return JSON.parse(te(e,"utf8"))}catch{}return{}}function yo(){let e=w(p(),".claude","memory");if(!U(e))return 0;try{let t=po(e).filter(r=>r.endsWith(".jsonl")),n=0;for(let r of t)try{let o=te(w(e,r),"utf8");n+=o.trim().split(`
`).filter(Boolean).length}catch{}return n}catch{return 0}}function ho(){let e=w(p(),".claude","logs","decisions.jsonl");if(!U(e))return[];try{return te(e,"utf8").trim().split(`
`).filter(Boolean).slice(-10).map(r=>{try{let o=JSON.parse(r);return o.summary||o.decision||r}catch{return r}})}catch{return[]}}function So(e){if(e.length<2)return 0;let t=[];for(let n=1;n<e.length;n++){let r=new Date(e[n-1].timestamp).getTime(),o=new Date(e[n].timestamp).getTime();o>r&&t.push(o-r)}return t.length===0?0:Math.round(t.reduce((n,r)=>n+r,0)/t.length)}function ko(){try{return mo("git diff --name-only HEAD 2>/dev/null",{encoding:"utf8",timeout:3e3,cwd:p()}).trim().split(`
`).filter(Boolean).slice(0,20)}catch{return[]}}function _o(){let e=w(p(),".claude","logs","task-completions.jsonl");if(!U(e))return[];try{return te(e,"utf8").trim().split(`
`).filter(Boolean).slice(-5).map(r=>{try{let o=JSON.parse(r);return`${o.task_subject} [${o.task_status}]`}catch{return""}}).filter(Boolean)}catch{return[]}}function $t(e){try{let t=fo(),n=go(t),r=new Date().toISOString();n.lastCompaction=r,n.compactionCount=(n.compactionCount||0)+1,n.compactionHistory||(n.compactionHistory=[]),n.compactionHistory.push({timestamp:r}),n.compactionHistory.length>10&&(n.compactionHistory=n.compactionHistory.slice(-10)),n.avgCompactionIntervalMs=So(n.compactionHistory);let o=yo(),i=ho();n.preservedContext={branch:process.env.ORCHESTKIT_BRANCH||process.env.GIT_BRANCH||void 0,activeFiles:ko(),activeTasks:_o(),sessionNotes:`Compaction #${n.compactionCount} at ${r}`,decisionLog:i,memoryTierSnapshot:{localEntries:o}},uo(t,JSON.stringify(n,null,2));let c=w(D(),"compaction-history.jsonl");try{h(c,`${JSON.stringify({session:y(),timestamp:r,count:n.compactionCount,avgIntervalMs:n.avgCompactionIntervalMs,localMemoryEntries:o,decisionsPreserved:i.length})}
`)}catch{}s("pre-compact-saver",`Saved state before compaction #${n.compactionCount} (${o} memory entries, ${i.length} decisions preserved)`)}catch(t){let n=t instanceof Error?t.message:String(t);s("pre-compact-saver",`Failed to save state: ${n}`,"warn")}return a()}import{existsSync as ne,readFileSync as Te,writeFileSync as vo,readdirSync as xo,statSync as Rt,mkdirSync as bo}from"node:fs";import{join as re,dirname as Co}from"node:path";var Ot="1.0";function wo(e){return`${e}/.claude/cache/prefill-scan.json`}function Io(e){if(!ne(e))return[];try{return xo(e).filter(t=>{try{return Rt(re(e,t)).isDirectory()}catch{return!1}})}catch{return[]}}function Eo(e,t,n){try{if(!ne(e))return!1;let r=JSON.parse(Te(e,"utf-8"));if(r.version!==Ot)return!1;let{scannedAt:o}=r;for(let i of n){let c=re(t,i,"SKILL.md");if(ne(c)&&Rt(c).mtimeMs>o)return!1}return!0}catch{return!1}}function Ho(e){try{return JSON.parse(Te(e,"utf-8"))}catch{return null}}function Tt(e,t){try{bo(Co(e),{recursive:!0});let n={version:Ot,scannedAt:Date.now(),results:{warnings:t,count:t.length}};vo(e,JSON.stringify(n,null,2),"utf-8")}catch{}}var $o=[/\bprefill\b/i,/\bpre-fill\b/i,e=>ge(e,"assistant","content",":"),/\bprefilled?\s+(assistant|response|message)/i,e=>ge(e,"role","assistant","content")],To=[/["']output_format["']\s*:/,/output_format\s*=\s*["']/,/\boutput_format\b.*\b(json|text|xml)\b/i];function Ro(e){return $o.some(t=>typeof t=="function"?t(e):t.test(e))}function Oo(e){return/elevenlabs|mp3_\d+/i.test(e)?!1:To.some(t=>t.test(e))}function $e(e,t){let n=[];for(let r of t){let o=re(e,r,"SKILL.md");if(ne(o))try{let i=Te(o,"utf-8");(Ro(i)||Oo(i))&&n.push(r)}catch{}}return n}function Po(){let e=process.env.CLAUDE_MODEL||"";return/opus/i.test(e)}function oe(e){if(!Po())return a();let t=fe(),n=re(t,"skills"),r=wo(t),o=Io(n),i;try{if(Eo(r,n,o)){let c=Ho(r);c?(s("prefill-guard","Using cached scan results"),i=c.results.warnings):(i=$e(n,o),Tt(r,i))}else i=$e(n,o),Tt(r,i)}catch{i=$e(n,o)}return i.length===0?(s("prefill-guard","No prefilling patterns detected in skills"),a()):(s("prefill-guard",`Found prefilling patterns in ${i.length} skills: ${i.join(", ")}`,"warn"),Je(`Opus 4.6 deprecation: ${i.length} skill(s) reference deprecated patterns (prefilled assistant messages or output_format parameter). Affected: ${i.slice(0,5).join(", ")}${i.length>5?"...":""}. Migration: use structured outputs instead of prefilling; use output_config.format instead of output_format.`))}import{existsSync as Pt,readFileSync as jt}from"node:fs";import{join as Re}from"node:path";function jo(e,t){if(e==="tavily"&&!process.env.TAVILY_API_KEY)return`- tavily is enabled but TAVILY_API_KEY is not set
  Fix: export TAVILY_API_KEY="tvly-..." in ~/.zshrc, then set "disabled": false in .mcp.json`;if(e==="agentation"){if(Pt(Re(t,"node_modules",".bin","agentation-mcp")))return null;try{let r=JSON.parse(jt(Re(t,"package.json"),"utf-8"));if("agentation-mcp"in{...r.dependencies,...r.devDependencies})return null}catch{}return`- agentation is enabled but agentation-mcp is not installed
  Fix: npm install -D agentation-mcp  or  set "disabled": true in .mcp.json`}return null}function se(e){if(process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1")return s("mcp-health-check","Skipping MCP check (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();let t=e.project_dir||p(),n=Re(t,".mcp.json");if(!Pt(n))return s("mcp-health-check","No .mcp.json found, skipping"),a();let r;try{r=JSON.parse(jt(n,"utf-8"))}catch{return s("mcp-health-check","Failed to parse .mcp.json","warn"),a()}let o=r.mcpServers;if(!o||typeof o!="object")return a();let i=[];for(let[c,l]of Object.entries(o)){if(l.disabled===!0)continue;let u=jo(c,t);u&&i.push(u)}if(i.length>0){let c=`MCP misconfiguration detected:
${i.join(`
`)}`;return s("mcp-health-check",c,"warn"),S(c)}return s("mcp-health-check","All enabled MCPs are properly configured"),a()}import{join as Do}from"node:path";var No=[{pattern:"offset pagination",warning:"Offset pagination causes performance issues on large tables. Use cursor-based pagination instead."},{pattern:"manual jwt validation",warning:"Manual JWT validation is error-prone. Use established libraries like python-jose or jsonwebtoken."},{pattern:"storing passwords in plaintext",warning:"Never store passwords in plaintext. Use bcrypt, argon2, or scrypt."},{pattern:"global state",warning:"Global mutable state causes testing and concurrency issues. Use dependency injection."},{pattern:"synchronous file operations",warning:"Synchronous file I/O blocks the event loop. Use async file operations."},{pattern:"n+1 query",warning:"N+1 queries cause performance problems. Use eager loading or batch queries."},{pattern:"polling for real-time",warning:"Polling is inefficient for real-time updates. Consider SSE or WebSocket."}];function Dt(e){let n=`# Anti-Pattern Warnings

Avoid these known anti-patterns:

${No.map(({pattern:o,warning:i})=>`- **${o}**: ${i}`).join(`
`)}
`,r=Do(e,".claude","rules");ze(r,"antipatterns.md",n,"antipattern-warning")}var O="sync-session-dispatcher",Ao=[{name:"session-context-loader",fn:Y},{name:"analytics-consent-check",fn:K},{name:"prefill-guard",fn:oe},{name:"mcp-health-check",fn:se}];function Nt(e){try{let r=e.project_dir||p();Dt(r)}catch(r){s(O,`Rules materialization failed: ${r}`,"warn")}let t=[];for(let r of Ao)try{let o=r.fn(e);o.systemMessage&&(t.push(o.systemMessage),s(O,`${r.name}: systemMessage collected`));let i=Be(o);i&&!o.systemMessage&&(t.push(i),s(O,`${r.name}: additionalContext converted to systemMessage`))}catch(o){let i=o instanceof Error?o.message:String(o);s(O,`${r.name} failed: ${i}`,"warn")}if(t.length===0)return s(O,"All sync hooks silent"),a();let n=t.join(`
`);return s(O,`Merged ${t.length} messages from sync hooks`),{continue:!0,systemMessage:n}}var I="sync-session-end-dispatcher",Fo=[{name:"session-metrics-summary",fn:ee,runOnFail:!0},{name:"session-cleanup",fn:q,runOnFail:!0},{name:"pattern-sync-push",fn:G,runOnFail:!1}];function At(e){let t=[],n=!0;for(let o of Fo){if(!o.runOnFail&&!n){s(I,`${o.name}: skipped (prior hook returned continue: false)`);continue}try{let i=o.fn(e);!o.runOnFail&&i.continue===!1&&(n=!1,s(I,`${o.name}: returned continue: false`)),i.systemMessage&&(t.push(i.systemMessage),s(I,`${o.name}: systemMessage collected`))}catch(i){let c=i instanceof Error?i.message:String(i);o.runOnFail?s(I,`${o.name} failed (run_on_fail, continuing): ${c}`,"warn"):s(I,`${o.name} failed: ${c}`,"warn")}}if(t.length===0)return s(I,"All SessionEnd hooks silent"),a();let r=t.join(`
`);return s(I,`Merged ${t.length} messages from SessionEnd hooks`),{continue:!0,systemMessage:r}}import{writeFileSync as Mo,mkdirSync as Lo,existsSync as Uo}from"node:fs";import{join as Ft,basename as Jo}from"node:path";function P(e,t){let n=p();if(!n)return;let r=Ft(n,".claude","logs");Uo(r)||Lo(r,{recursive:!0});try{let o=Ft(r,Jo(e));Mo(o,`${JSON.stringify(t)}
`,{flag:"a"})}catch{}}async function ie(e){if(!p())return{continue:!0};let t=e.teammate_id||e.agent_id||"unknown",n=e.teammate_type||e.subagent_type||"unknown",r=e.idle_duration_ms||0;return P("teammate-activity.jsonl",{timestamp:new Date().toISOString(),event:"teammate_idle",teammate_id:t,teammate_type:n,idle_duration_ms:r,session_id:e.session_id}),T("team-activity.jsonl",{ts:new Date().toISOString(),pid:H(process.env.CLAUDE_PROJECT_DIR||""),event:"idle",agent:n,idle_ms:r,...$()}),r>3e4?{continue:!0,hookSpecificOutput:{additionalContext:`Agent ${n} (${t}) idle for ${Math.round(r/1e3)}s. Consider reassigning pending work.`}}:{continue:!0}}import{existsSync as Wo,readFileSync as Ko}from"node:fs";import{join as Bo}from"node:path";var Mt=6e4;function ce(e){let t=A();if(!t)return a();let n=Qe();if(n.length===0)return a();let r=p();if(!r)return a();let o=Bo(r,".claude","logs","teammate-activity.jsonl");if(!Wo(o))return a();let i=new Date(Date.now()-Mt).toISOString(),c=new Set;try{let f=Ko(o,"utf-8").trim().split(`
`).filter(Boolean).slice(-50);for(let d of f)try{let _=JSON.parse(d);if(_.event==="teammate_idle"&&_.timestamp&&_.timestamp>=i){let Oe=_.teammate_id||_.member_name||"";Oe&&c.add(Oe)}}catch{}}catch{return a()}let l=e.teammate_id||e.agent_id||"";return l&&c.add(l),s("team-synthesis-trigger",`Team "${t}": ${c.size}/${n.length} idle within ${Mt/1e3}s`),c.size>=n.length?S(`All ${n.length} teammates in team "${t}" are idle. Consider synthesizing results and shutting down the team.`):a()}import{existsSync as zo,readFileSync as Go}from"node:fs";import{join as Vo}from"node:path";var qo=3e5,Yo=100;function Qo(e){return(e.last_assistant_message||e.agent_output||e.output||"").length>=Yo}function Xo(e){let t=Vo(e,".claude","logs","task-completions.jsonl");if(!zo(t))return!1;let n=new Date(Date.now()-qo).toISOString();try{let i=Go(t,"utf-8").trim().split(`
`).filter(Boolean).slice(-30);for(let c of i)try{let l=JSON.parse(c);if(l.timestamp&&l.timestamp>=n)return!0}catch{}}catch{}return!1}function ae(e){let t=A();if(!t)return a();let n=p();if(!n)return a();let r=e.teammate_id||e.agent_id||"unknown",o=e.teammate_type||e.subagent_type||"unknown",i=Qo(e),c=Xo(n);return P("team-quality.jsonl",{timestamp:new Date().toISOString(),event:"teammate_quality_check",team_name:t,teammate_id:r,teammate_type:o,has_productive_output:i,has_recent_completion:c,session_id:e.session_id}),!i&&!c?(s("team-quality-gate",`Teammate "${r}" (${o}) idle without productive output or recent completion`),S(`Teammate "${o}" (${r}) went idle without completing a task. Check if their work is stuck or needs reassignment.`)):(s("team-quality-gate",`Teammate "${r}" quality check passed`),a())}var Zo=[{name:"progress-reporter",fn:ie,critical:!1},{name:"team-synthesis-trigger",fn:ce,critical:!1},{name:"team-quality-gate",fn:ae,critical:!1}];async function Lt(e){let t=[];for(let n of Zo)try{let o=(await n.fn(e))?.hookSpecificOutput?.additionalContext;o&&typeof o=="string"&&o.trim()&&t.push(o.trim())}catch(r){s("teammate-idle-dispatcher",`Hook "${n.name}" failed: ${r instanceof Error?r.message:String(r)}`)}return t.length>0?S(t.join(`
`)):a()}var es=/\b(?:implement|refactor|build|migrate)\b.{5,}/i;async function Ut(e){if(!p())return{continue:!0};let t=e.task_id||"unknown",n=e.task_subject||"",r=e.task_status||"completed",o=e.duration_ms||0,i=e.token_count,c=e.tool_uses;if(P("task-completions.jsonl",{timestamp:new Date().toISOString(),event:"task_completed",task_id:t,task_subject:n,task_status:r,duration_ms:o,session_id:e.session_id,...i!==void 0&&{token_count:i},...c!==void 0&&{tool_uses:c}}),T("task-usage.jsonl",{ts:new Date().toISOString(),pid:H(process.env.CLAUDE_PROJECT_DIR||""),task_status:r,duration_ms:o,...i!==void 0&&{token_count:i},...c!==void 0&&{tool_uses:c},...$()}),es.test(n)&&r==="completed"){let l=i!==void 0?`, ${i} tokens, ${c??0} tool calls`:"";return{continue:!0,hookSpecificOutput:{additionalContext:`Task "${n}" completed (${Math.round(o/1e3)}s${l}). Consider running tests to verify.`}}}return{continue:!0}}function Jt(e){let t=e.hook_event,n=e.tool_input?.file_path||e.tool_input?.path||"unknown";return t==="WorktreeCreate"?(s("worktree-lifecycle",`Worktree created: ${n}`),x(`[WorktreeCreate] A new worktree was created at: ${n}. You are now working in an isolated worktree. Changes here do not affect the main working tree.`)):t==="WorktreeRemove"?(s("worktree-lifecycle",`Worktree removed: ${n}`),x(`[WorktreeRemove] Worktree removed: ${n}. The isolated worktree has been cleaned up. You are back in the main working tree.`)):(s("worktree-lifecycle",`Unexpected event: ${t}`),a())}function Wt(e){let t=e.session_id||"unknown";return s("config-change",`Settings changed mid-session (session: ${t})`),x("[ConfigChange] Project or user settings were modified during this session. Permission rules, hook configurations, or plugin settings may have changed. If a permission was just granted or revoked, it takes effect immediately.")}var Kt={"lifecycle/analytics-consent-check":K,"lifecycle/pattern-sync-pull":z,"lifecycle/pattern-sync-push":G,"lifecycle/session-cleanup":q,"lifecycle/session-context-loader":Y,"lifecycle/session-env-setup":Q,"lifecycle/session-tracking":Z,"lifecycle/session-metrics-summary":ee,"lifecycle/dependency-version-check":yt,"lifecycle/unified-dispatcher":Ht,"lifecycle/pre-compact-saver":$t,"lifecycle/prefill-guard":oe,"lifecycle/mcp-health-check":se,"lifecycle/sync-session-dispatcher":Nt,"lifecycle/sync-session-end-dispatcher":At,"teammate-idle/unified-dispatcher":Lt,"teammate-idle/progress-reporter":ie,"teammate-idle/team-synthesis-trigger":ce,"teammate-idle/team-quality-gate":ae,"task-completed/completion-tracker":Ut,"worktree/worktree-lifecycle-logger":Jt,"config-change/settings-reload":Wt};function iu(e){return Kt[e]}function cu(){return Object.keys(Kt)}export{qs as analyzeStagedChanges,Us as escapeRegex,wn as estimateTokenCount,Be as extractContext,$n as extractIssueNumber,Le as fnv1aHash,ws as getCachedBranch,In as getCurrentBranch,Vs as getDefaultBranch,Cs as getEnvFile,Fs as getField,Hn as getGitStatus,iu as getHook,D as getLogDir,vn as getLogLevel,fe as getPluginRoot,p as getProjectDir,Bs as getRepoRoot,y as getSessionId,Tn as getStagedFiles,Gs as hasUncommittedChanges,Kt as hooks,ts as isBashInput,rs as isEditInput,zs as isGitRepo,En as isProtectedBranch,os as isReadInput,ns as isWriteInput,Ms as lineContainsAll,ge as lineContainsAllCI,cu as listHooks,s as logHook,Ds as logPermissionFeedback,Ls as normalizeCommand,Is as normalizeLineEndings,Ts as outputAllowWithContext,Hs as outputBlock,Ps as outputDeny,Rs as outputError,x as outputPromptContext,Ns as outputPromptContextBudgeted,Es as outputSilentAllow,a as outputSilentSuccess,Os as outputStderrWarning,Je as outputWarning,S as outputWithContext,$s as outputWithNotification,js as outputWithUpdatedInput,As as readHookInput,xn as shouldLog,Ys as validateBranchName,ze as writeRulesFile};
//# sourceMappingURL=lifecycle.mjs.map
