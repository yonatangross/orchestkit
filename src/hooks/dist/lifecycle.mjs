// OrchestKit Hooks - lifecycle bundle
// Generated: 2026-02-10T00:10:18.925Z

function vr(e){return typeof e.command=="string"}function br(e){return typeof e.file_path=="string"&&typeof e.content=="string"}function xr(e){return typeof e.file_path=="string"&&typeof e.old_string=="string"&&typeof e.new_string=="string"}function Ir(e){return typeof e.file_path=="string"&&e.content===void 0}import{appendFileSync as ye,existsSync as he,statSync as Mt,renameSync as Lt,mkdirSync as Ut,readSync as Jt}from"node:fs";import{execSync as Bt}from"node:child_process";import vt from"node:os";import j from"node:path";function S(){return process.env.HOME||process.env.USERPROFILE||vt.homedir()}function V(){return process.env.CLAUDE_PROJECT_DIR||"."}function le(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function me(){return process.env.CLAUDE_PLUGIN_ROOT?j.join(S(),".claude","logs","ork"):j.join(V(),".claude","logs")}var q=j.join,Rr=j.sep;import{execSync as bt}from"node:child_process";import{createHash as xt}from"node:crypto";import{existsSync as de,readFileSync as It,writeFileSync as wt,mkdirSync as Et}from"node:fs";import{join as Y,basename as Ct}from"node:path";var Rt=20,Ht=15,Tt=/[^a-z0-9-]/g;function $t(e){let t=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=Ct(t);return ge(n,Rt)}function Ot(e){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let t=e||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=bt("git branch --show-current",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),o=ge(n||"detached",Ht);return process.env.ORCHESTKIT_SESSION_BRANCH=o,o}catch{return"nobranch"}}function Pt(e){let t=e||new Date,n=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${n}${o}`}function Dt(e){let t=e||new Date,n=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0");return`${n}${o}`}function jt(){let e=`${process.pid}-${Date.now()}-${Math.random()}`;return xt("sha256").update(e).digest("hex").slice(0,4)}function ge(e,t){return e.toLowerCase().replace(Tt,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,t)}function Nt(e,t){let n=$t(e),o=Ot(e),r=Pt(t),i=Dt(t),c=jt();return`${n}-${o}-${r}-${i}-${c}`}function At(e){let t=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=Y(t,".instance","session-id.json");if(de(n))try{let o=JSON.parse(It(n,"utf8"));if(o.session_id&&o.created_at){let r=Date.now()-new Date(o.created_at).getTime(),i=1440*60*1e3;if(r<i)return o.session_id}}catch{}}function Ft(e,t){let n=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),o=Y(n,".instance"),r=Y(o,"session-id.json");try{de(o)||Et(o,{recursive:!0}),wt(r,JSON.stringify({session_id:e,created_at:new Date().toISOString()},null,2))}catch{}}function fe(e){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let t=At(e);if(t)return t;let n=Nt(e);return Ft(n,e),n}function T(){return me()}function p(){return V()}function Q(){return le()}function Mr(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${Q()}/.claude/.instance_env`}function f(){return fe()}function Se(e){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let t=Bt("git branch --show-current",{cwd:e||p(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=t,t}catch{return"unknown"}}function Kt(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Lr(e){return e.replace(/\r\n/g,`
`)}function Wt(e){let t=["debug","info","warn","error"];return t.indexOf(e)>=t.indexOf(Kt())}function a(){return{continue:!0,suppressOutput:!0}}function Ur(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function Jr(e){return{continue:!1,stopReason:e,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:e}}}function _(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:e}}}function Gt(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:e}}}function Br(e,t){let n={continue:!0,suppressOutput:!0};return e&&(n.systemMessage=e),t&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:t}),n}function Kr(e,t){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:e,permissionDecision:"allow"}};return t?n.systemMessage=t:n.suppressOutput=!0,n}function Wr(e){return{continue:!0,systemMessage:e}}function ke(e){return{continue:!0,systemMessage:`\u26A0 ${e}`}}function Gr(e){return{continue:!1,stopReason:e,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:e}}}function zr(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:e}}}var zt=200*1024,Vt=100*1024;function _e(e,t){if(he(e))try{if(Mt(e).size>t){let o=`${e}.old.${Date.now()}`;Lt(e,o)}}catch{}}function ve(e){he(e)||Ut(e,{recursive:!0})}function s(e,t,n="debug"){if(!Wt(n))return;let o=T(),r=`${o}/hooks.log`;try{ve(o),_e(r,zt);let i=new Date().toISOString().replace("T"," ").slice(0,19);ye(r,`[${i}] [${n.toUpperCase()}] [${e}] ${t}
`)}catch{}}function Vr(e,t,n){let o=T(),r=`${o}/permission-feedback.log`;try{ve(o),_e(r,Vt);let i=new Date().toISOString(),c=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",u=n?.session_id||f();ye(r,`${i} | ${e} | ${t} | tool=${c} | session=${u}
`)}catch{}}function qt(e){if(!e)return 0;let o=(e.match(/[{};()=><]/g)||[]).length/e.length>.03?2.8:3.5;return Math.ceil(e.length/o)}function qr(e,t,n,o,r){let i=qt(e);return o&&o.isOverBudget(n)?(s(t,`Budget exhausted for ${n}, suppressing ${i}t`),a()):(r&&r.trackTokenUsage(t,n,i),Gt(e))}function Yr(){try{let e=[],n=Buffer.allocUnsafe(256),o,r=0;for(;;)try{if(o=Jt(r,n,0,256,null),o===0)break;e.push(Buffer.from(n.subarray(0,o)))}catch{break}let i=Buffer.concat(e).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:f(),tool_input:{}}}catch{return{tool_name:"",session_id:f(),tool_input:{}}}}function Qr(e,t){let n=t.replace(/^\./,"").split("."),o=e;for(let r of n){if(o==null)return;o=o[r]}return o}function Xr(e){return e.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function Zr(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}import{execSync as x}from"node:child_process";function Yt(e){let t=e||p();try{return x("git branch --show-current",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return"unknown"}}function Qt(e){let t=e||Yt();return["dev","main","master"].includes(t)}function os(e){let t=e||p();try{return x("git rev-parse --show-toplevel",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return t}}function rs(e){let t=e||p();try{return x("git rev-parse --git-dir",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),!0}catch{return!1}}function Xt(e){let t=e||p();try{return x("git status --short",{cwd:t,encoding:"utf8",timeout:1e4,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function ss(e){return Xt(e).length>0}function is(e){let t=e||p();try{return x("git rev-parse --verify main",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"main"}catch{try{return x("git rev-parse --verify master",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"master"}catch{return"main"}}}function Zt(e){let t=[/issue\/(\d+)/i,/feature\/(\d+)/i,/fix\/(\d+)/i,/bug\/(\d+)/i,/feat\/(\d+)/i,/^(\d+)-/,/-(\d+)$/,/#(\d+)/];for(let n of t){let o=e.match(n);if(o)return parseInt(o[1],10)}return null}function cs(e){if(Qt(e))return null;let t=["issue/","feature/","fix/","bug/","feat/","chore/","docs/","refactor/","test/","ci/","perf/","style/","release/","hotfix/"];return t.some(o=>e.startsWith(o))?e.startsWith("issue/")&&!Zt(e)?"issue/ branches should include an issue number (e.g., issue/123-description)":null:`Branch name should start with a valid prefix: ${t.join(", ")}`}import{existsSync as be,readFileSync as xe}from"node:fs";function en(e){let t=`${e}/.claude/feedback/consent-status.json`;if(!be(t))return{consented:!1,asked:!1};try{let n=JSON.parse(xe(t,"utf-8"));return{consented:n.consented===!0,asked:n.asked===!0}}catch{return{consented:!1,asked:!1}}}function tn(e){let t=`${e}/.claude/feedback/consent-log.json`;if(!be(t))return null;try{let n=JSON.parse(xe(t,"utf-8"));if(n.events&&n.events.length>0)return n.events[n.events.length-1]}catch{}return null}function nn(e){try{let t=new Date(e);return Math.floor((new Date().getTime()-t.getTime())/(1e3*60*60*24))>=30}catch{return!1}}function Ie(e){let t=e.project_dir||p(),n=en(t);if(n.consented)return s("analytics-consent-check","User has consented to analytics"),a();if(n.asked){let o=tn(t);return o&&(o.action==="declined"||o.action==="revoked")&&nn(o.timestamp)?(s("analytics-consent-check","Showing 30-day reminder"),{continue:!0,systemMessage:"Reminder: Anonymous analytics help improve OrchestKit. Enable with /ork:feedback opt-in"}):(s("analytics-consent-check","User recently declined, not prompting"),a())}return s("analytics-consent-check","First time user, showing brief notice"),{continue:!0,systemMessage:"OrchestKit collects local usage metrics. Share anonymously with /ork:feedback opt-in"}}import{mkdirSync as on,appendFileSync as rn}from"node:fs";function sn(){return!!process.env.MEM0_API_KEY}function N(e){s("mem0-analytics-tracker","Mem0 analytics tracker starting");let t=e.project_dir||p(),n=`${t}/.claude/logs/mem0-analytics.jsonl`,o=e.session_id||f(),r=new Date().toISOString(),i=JSON.stringify({session_id:o,timestamp:r,event:"session_start",mem0_available:sn()});try{on(`${t}/.claude/logs`,{recursive:!0}),rn(n,i+`
`),s("mem0-analytics-tracker","Mem0 analytics tracked")}catch(c){s("mem0-analytics-tracker",`Failed to write analytics: ${c}`)}return a()}import{existsSync as cn,readFileSync as Ee,mkdirSync as an,renameSync as un}from"node:fs";import{basename as Ce}from"node:path";function pn(e){return(Ce(e)||"unknown").toLowerCase().replace(/\s+/g,"-")}function ln(){return!!process.env.MEM0_API_KEY}function we(e){if(!cn(e))return!1;try{let t=Ee(e,"utf-8"),n=JSON.parse(t);return!(!n||Object.keys(n).length===0)}catch{return!1}}function mn(e,t){let n=`${t}/.claude/logs/mem0-processed`,o=new Date().toISOString().replace(/[:.]/g,"-");try{an(n,{recursive:!0});let i=(Ce(e)||"pending-sync").replace(".json",`.processed-${o}.json`),c=`${n}/${i}`;un(e,c),s("mem0-context-retrieval",`Archived pending sync to ${c}`)}catch(r){s("mem0-context-retrieval",`Warning: Could not archive ${e}: ${r}`)}}function A(e){s("mem0-context-retrieval","Mem0 context retrieval starting");let t=e.project_dir||p(),n=pn(t),o=`${t}/.mem0-pending-sync.json`,r=`${S()}/.claude/.mem0-pending-sync.json`,i=null;if(we(o))i=o,s("mem0-context-retrieval",`Found pending sync in project: ${o}`);else if(we(r))try{let c=JSON.parse(Ee(r,"utf-8"));c.project_id===n?(i=r,s("mem0-context-retrieval","Found pending sync in global location for this project")):s("mem0-context-retrieval",`Global pending sync exists but for different project: ${c.project_id}`)}catch{}return i&&(s("mem0-context-retrieval","Found pending sync, archiving for processing"),mn(i,t),s("mem0-context-retrieval","Pending sync archived - will be processed on next memory operation")),ln()?s("mem0-context-retrieval","Graph + mem0 available for this session"):s("mem0-context-retrieval","Graph available (mem0 not configured) for this session"),a()}import{writeFileSync as dn,mkdirSync as gn}from"node:fs";function fn(){return!!process.env.MEM0_API_KEY}function yn(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Re(e){if(yn())return s("mem0-webhook-setup","Skipping mem0 webhook setup (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();if(s("mem0-webhook-setup","Mem0 webhook setup starting"),!fn())return s("mem0-webhook-setup","Mem0 not available, skipping webhook setup"),a();let t=e.project_dir||p(),n=`${t}/.claude/mem0-webhooks.json`,o="orchestkit-auto-sync",r=["memory.created","memory.updated","memory.deleted"],i=process.env.MEM0_WEBHOOK_URL||"https://example.com/webhook/mem0";s("mem0-webhook-setup","Checking for existing webhooks"),process.env.MEM0_WEBHOOK_URL||s("mem0-webhook-setup","Webhook URL not configured (set MEM0_WEBHOOK_URL), skipping creation");try{gn(`${t}/.claude`,{recursive:!0}),dn(n,JSON.stringify({webhook_name:o,events:r,url:i},null,2)),s("mem0-webhook-setup","Webhook config saved")}catch(c){s("mem0-webhook-setup",`Failed to save webhook config: ${c}`)}return s("mem0-webhook-setup","Webhook setup complete"),a()}import{existsSync as F,readFileSync as X,writeFileSync as hn,statSync as Sn,mkdirSync as kn}from"node:fs";var _n=1*1024*1024;function vn(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function bn(e){let t=`${e}/.claude/feedback/sync-config.json`;if(!F(t))return!0;try{return JSON.parse(X(t,"utf-8")).sync_enabled!==!1}catch{return!0}}function He(e){if(!F(e))return!0;try{let t=Sn(e);return t.size>_n?(s("pattern-sync-pull",`WARN: Skipping - file too large: ${e} (${t.size} bytes)`),!1):!0}catch{return!0}}function xn(e){let n=`${S()}/.claude/global-patterns.json`,o=`${e}/.claude/feedback/learned-patterns.json`;if(!F(n)){s("pattern-sync-pull","No global patterns file found");return}try{let i=JSON.parse(X(n,"utf-8")).patterns||[];if(i.length===0){s("pattern-sync-pull","No global patterns to pull");return}let c={version:"1.0",patterns:[]};if(F(o))try{c=JSON.parse(X(o,"utf-8"))}catch{}let u=c.patterns||[],l=new Set(u.map(m=>m.text)),d=i.filter(m=>!l.has(m.text));if(d.length===0){s("pattern-sync-pull","All global patterns already in project");return}let g=[...u,...d];c.patterns=g,kn(`${e}/.claude/feedback`,{recursive:!0}),hn(o,JSON.stringify(c,null,2)),s("pattern-sync-pull",`Pulled ${d.length} new patterns from global`)}catch(r){s("pattern-sync-pull",`Failed to pull global patterns: ${r}`)}}function M(e){if(vn())return s("pattern-sync-pull","Skipping pattern sync (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();let t=e.project_dir||p();if(!bn(t))return s("pattern-sync-pull","Global sync disabled, skipping pull"),a();let n=`${S()}/.claude/global-patterns.json`,o=`${t}/.claude/feedback/learned-patterns.json`;return!He(n)||!He(o)?(s("pattern-sync-pull","Skipping pattern sync due to large files"),a()):(s("pattern-sync-pull","Pulling global patterns..."),xn(t),s("pattern-sync-pull","Global patterns pulled successfully"),a())}import{existsSync as Z,readFileSync as ee,writeFileSync as In,mkdirSync as wn}from"node:fs";function En(e){let t=`${e}/.claude/feedback/sync-config.json`;if(!Z(t))return!0;try{return JSON.parse(ee(t,"utf-8")).sync_enabled!==!1}catch{return!0}}function Cn(e){let t=`${e}/.claude/feedback/learned-patterns.json`,n=S(),o=`${n}/.claude/global-patterns.json`;if(!Z(t)){s("pattern-sync-push","No project patterns file found");return}try{let i=JSON.parse(ee(t,"utf-8")).patterns||[];if(i.length===0){s("pattern-sync-push","No project patterns to push");return}let c={version:"1.0",patterns:[],updated:""};if(Z(o))try{c=JSON.parse(ee(o,"utf-8"))}catch{}let u=c.patterns||[],l=new Set(u.map(m=>m.text)),d=i.filter(m=>!l.has(m.text));if(d.length===0){s("pattern-sync-push","All project patterns already in global");return}let g=[...u,...d];c.patterns=g,c.updated=new Date().toISOString(),wn(`${n}/.claude`,{recursive:!0}),In(o,JSON.stringify(c,null,2)),s("pattern-sync-push",`Pushed ${d.length} new patterns to global`)}catch(r){s("pattern-sync-push",`Failed to push project patterns: ${r}`)}}function Te(e){let t=e.project_dir||p();return En(t)?(s("pattern-sync-push","Pushing project patterns to global..."),Cn(t),a()):(s("pattern-sync-push","Global sync disabled, skipping push"),a())}import{execSync as $e}from"node:child_process";var Rn=new Set(["main","master","dev","develop"]);function Oe(e){s("pr-status-enricher","Checking for open PR on current branch");let t=e.project_dir||p(),n;try{n=Se(t)}catch{return s("pr-status-enricher","Could not determine branch, skipping"),a()}if(!n||Rn.has(n))return s("pr-status-enricher",`Branch "${n}" skipped for PR detection`),a();try{let o=$e("gh pr view --json state,reviewDecision,url,title,isDraft",{cwd:t,timeout:1e4,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim(),r=JSON.parse(o);if(!r.url)return s("pr-status-enricher","No PR found for current branch"),a();process.env.ORCHESTKIT_PR_URL=r.url,process.env.ORCHESTKIT_PR_STATE=r.state;let i=0;try{let d=$e("gh pr view --json reviewThreads",{cwd:t,timeout:1e4,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim();i=(JSON.parse(d).reviewThreads||[]).filter(m=>!m.isResolved).length}catch{}let c=r.isDraft?" (DRAFT)":"",u=r.reviewDecision?` | Review: ${r.reviewDecision}`:"",l=i>0?` | ${i} unresolved`:"";s("pr-status-enricher",`PR: ${r.title}${c} [${r.state}${u}${l}]`),s("pr-status-enricher",`URL: ${r.url}`)}catch{s("pr-status-enricher","No PR found or gh CLI unavailable")}return a()}import{existsSync as R,readFileSync as Fe,writeFileSync as Mn,mkdirSync as Ln,readdirSync as Me,unlinkSync as Le,copyFileSync as Un}from"node:fs";import{join as Ae}from"node:path";import{homedir as Jn}from"node:os";import{existsSync as $,readFileSync as Hn,readdirSync as Tn,statSync as Pe,rmSync as $n}from"node:fs";import{join as I}from"node:path";function O(){return process.env.CLAUDE_CODE_TEAM_NAME||null}function De(){let e=O();if(!e)return[];let t=process.env.HOME||process.env.USERPROFILE||"";if(!t)return[];let n=I(t,".claude","teams",e,"config.json");if(!$(n))return[];try{let r=JSON.parse(Hn(n,"utf-8")).members;return Array.isArray(r)?r.map(i=>({name:i.name||"unknown",agentType:i.agentType||"unknown"})):[]}catch{return[]}}function je(){let e=process.env.HOME||process.env.USERPROFILE||"";if(!e)return[];let t=I(e,".claude","teams");if(!$(t))return[];try{return Tn(t).filter(n=>{try{return Pe(I(t,n)).isDirectory()}catch{return!1}})}catch{return[]}}function Ne(e,t=4){let n=process.env.HOME||process.env.USERPROFILE||"";if(!n)return!1;let o=I(n,".claude","teams",e);if(!$(o))return!1;let r=I(o,"config.json");if(!$(r))return!0;try{return Date.now()-Pe(o).mtimeMs>t*36e5}catch{return!0}}function L(e){let t=process.env.HOME||process.env.USERPROFILE||"";if(!t)return!1;let n=!0;for(let o of["teams","tasks"]){let r=I(t,".claude",o,e);if($(r))try{$n(r,{recursive:!0,force:!0})}catch{n=!1}}return n}import{appendFileSync as On,mkdirSync as Pn,statSync as Dn,renameSync as jn}from"node:fs";import{createHash as Nn}from"node:crypto";function An(){return q(S(),".claude","analytics")}function w(e){return Nn("sha256").update(e).digest("hex").slice(0,12)}function E(){let e=process.env.CLAUDE_CODE_TEAM_NAME;return e?{team:e}:void 0}function Fn(e,t=10485760){try{if(Dn(e).size>t){let o=new Date().toISOString().slice(0,7),r=e.replace(/\.jsonl$/,`.${o}.jsonl`);jn(e,r)}}catch{}}function C(e,t){try{let n=An();Pn(n,{recursive:!0});let o=q(n,e);Fn(o),On(o,JSON.stringify(t)+`
`)}catch{}}function Ue(e){if(!R(e))return 0;try{let n=JSON.parse(Fe(e,"utf-8")).tools||{};return Object.values(n).reduce((o,r)=>o+r,0)}catch{return 0}}function Bn(e,t){if(!R(e))return;let n=Ue(e);if(n<=5){s("session-cleanup",`Session had only ${n} tool calls, not archiving`);return}try{Ln(t,{recursive:!0});let r=`session-${new Date().toISOString().replace(/[:.]/g,"-")}.json`,i=`${t}/${r}`;Un(e,i),s("session-cleanup",`Archived session metrics to ${r}`)}catch(o){s("session-cleanup",`Failed to archive metrics: ${o}`)}}function Kn(e,t=20){if(R(e))try{let n=Me(e).filter(r=>r.startsWith("session-")&&r.endsWith(".json")).sort().reverse();if(n.length<=t)return;let o=n.slice(t);for(let r of o)try{Le(`${e}/${r}`),s("session-cleanup",`Deleted old archive: ${r}`)}catch{}}catch(n){s("session-cleanup",`Failed to cleanup old archives: ${n}`)}}function Wn(e){if(!R(e))return;let t=["hooks.log.old*","audit.log.old*"];for(let n of t)try{let o=n.replace("*",""),r=Me(e).filter(c=>c.startsWith(o)).sort().reverse();if(r.length<=5)continue;let i=r.slice(5);for(let c of i)try{Le(`${e}/${c}`)}catch{}}catch{}}function Gn(e){if(!e||typeof e!="string"||e==="No prompt")return e||"";let t=e;if(t.includes("<task-notification>")){let i=t.match(/<summary>(.*?)<\/summary>/s);return i?i[1].trim():"(background task)"}let n=t.match(/<command-args>(.*?)(?:<\/command-args>|$)/s),o=t.match(/<command-name>(.*?)<\/command-name>/);if(o||n){let i=[];if(o&&i.push(o[1].trim()),n){let c=n[1].trim();c&&i.push(c)}if(i.length>0)return i.join(" ")}t=t.replace(/<[^>]+>/g," "),t=t.replace(/[\u2500-\u259f]/g,"");let r=t.indexOf("\u276F");return r!==-1?t=t.slice(r+1):(t=t.replace(/Claude Code v[\d.]+/g,""),t=t.replace(/Opus [\d.]+\s*[·.]\s*Claude Max/g,"")),t=t.replace(/[✻⏺⎿]\s*/g,""),t=t.replace(/Conversation compacted[^)]*\)/g,""),t=t.replace(/Referenced file [^\s]+/g,""),t=t.replace(/\s+(Bash|Read|Write|Edit|Glob|Grep|Task|Skill)\(.*$/s,""),t=t.replace(/~\/[\w/._-]+/g,""),t=t.replace(/[…]+/g,""),t=t.replace(/\s+/g," ").trim(),t}function zn(e){let t=Jn(),n=Ae(t,".claude","projects");if(!R(n))return;let o=e.replace(/\//g,"-"),r=Ae(n,o,"sessions-index.json");if(!R(r)){s("session-cleanup","No sessions-index.json found");return}try{let i=JSON.parse(Fe(r,"utf-8")),c=0;for(let u of i.entries){if(!u.firstPrompt||u.firstPrompt==="No prompt")continue;let l=Gn(u.firstPrompt);(!l||l.length<10)&&(l=u.summary||u.firstPrompt),l!==u.firstPrompt&&(u.firstPrompt=l,c++)}c>0&&(Mn(r,JSON.stringify(i,null,4)),s("session-cleanup",`Sanitized ${c} session firstPrompt entries`))}catch(i){s("session-cleanup",`Failed to sanitize sessions index: ${i}`,"warn")}}function Je(e){s("session-cleanup","Session cleanup starting");let t=e.project_dir||p(),n="/tmp/claude-session-metrics.json",o=`${t}/.claude/logs/sessions`,r=`${t}/.claude/logs`;zn(t),Bn(n,o),Kn(o,20),Wn(r);let i=process.env.CLAUDE_CODE_TEAM_NAME;if(i){let u=L(i);s("session-cleanup",u?`Cleaned team "${i}" directories`:`Warning: partial cleanup for team "${i}"`)}let c=Ue(n);return C("session-summary.jsonl",{ts:new Date().toISOString(),pid:w(t),total_tools:c,...E()}),s("session-cleanup","Session cleanup complete"),a()}import{existsSync as te,readFileSync as Be}from"node:fs";function U(e){if(!te(e))return!1;try{return JSON.parse(Be(e,"utf-8")),!0}catch{return!1}}function Ke(e){s("session-context-loader","Session starting - loading context (Protocol 2.0)");let t=e.project_dir||p(),n=0,o=process.env.AGENT_TYPE||"",r=`${t}/.claude/context/session/state.json`,i=`${t}/.claude/context/identity.json`,c=`${t}/.claude/context/knowledge/index.json`;U(r)&&(s("session-context-loader","Session state loaded"),n++),U(i)&&(s("session-context-loader","Identity loaded"),n++),U(c)&&(s("session-context-loader","Knowledge index available"),n++);let u=`${t}/docs/CURRENT_STATUS.md`;if(te(u)&&s("session-context-loader","Current status document exists"),o){s("session-context-loader",`Agent-type aware initialization: ${o}`);let d=`${t}/.claude/agents/${o}.md`;te(d)&&(s("session-context-loader",`Agent configuration found: ${d}`),n++)}let l=`${t}/.claude/context/session/compaction-manifest.json`;if(U(l))try{let d=JSON.parse(Be(l,"utf-8"));s("session-context-loader",`Compaction manifest loaded: session=${d.sessionId}, decisions=${(d.keyDecisions||[]).length}, files=${(d.filesTouched||[]).length}`),process.env.ORCHESTKIT_LAST_SESSION=d.sessionId||"",process.env.ORCHESTKIT_LAST_DECISIONS=JSON.stringify(d.keyDecisions||[]),n++}catch(d){s("session-context-loader",`Error loading compaction manifest: ${d}`)}return n>0&&(o?s("session-context-loader",`Session context loaded (Protocol 2.0) - Agent: ${o}`):s("session-context-loader","Session context loaded (Protocol 2.0)")),a()}import{existsSync as Vn,readFileSync as qn,writeFileSync as We,mkdirSync as Yn}from"node:fs";import{execSync as Qn}from"node:child_process";function Xn(e){try{return Qn("git branch --show-current",{cwd:e,encoding:"utf-8",timeout:500,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function J(e){s("session-env-setup","Setting up session environment");let t=e.project_dir||p(),n=e.session_id||f(),o="/tmp/claude-session-metrics.json";try{Yn(`${t}/.claude/logs`,{recursive:!0})}catch{}let r=process.env.AGENT_TYPE||"";!r&&e.agent_type&&(r=e.agent_type);let i={session_id:n,started_at:new Date().toISOString(),agent_type:r,tools:{},errors:0,warnings:0};try{We(o,JSON.stringify(i,null,2)),s("session-env-setup","Initialized session metrics")}catch(l){s("session-env-setup",`Failed to initialize metrics: ${l}`)}let c=`${t}/.claude/context/session/state.json`;if(Vn(c)&&r)try{let l=JSON.parse(qn(c,"utf-8"));l.agent_type=r,l.session_id=n,l.last_activity=new Date().toISOString(),We(c,JSON.stringify(l,null,2)),s("session-env-setup",`Updated session state with agent_type: ${r}`)}catch(l){s("session-env-setup",`Failed to update session state: ${l}`)}let u=Xn(t);return u&&s("session-env-setup",`Git branch: ${u}`),r&&s("session-env-setup",`Agent type: ${r}`),a()}import{existsSync as Qe,appendFileSync as uo,mkdirSync as po,readFileSync as lo,writeFileSync as mo}from"node:fs";import{existsSync as Zn,readFileSync as eo,writeFileSync as ri,mkdirSync as si}from"node:fs";import{execSync as Ge}from"node:child_process";import{createHash as to}from"node:crypto";import*as ze from"node:os";var no=".claude/.user_identity.json",oo="orchestkit-user-identity-v1";var y=null;function B(e){return to("sha256").update(e+oo).digest("hex").slice(0,32)}function ro(){try{return ze.hostname()}catch{return"unknown-machine"}}function so(e){let t=`${e}/${no}`;if(!Zn(t))return null;try{let n=eo(t,"utf8");return JSON.parse(n)}catch(n){return s("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function io(e){let t={};try{t.email=Ge("git config user.email",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{t.name=Ge("git config user.name",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return t}function co(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function ao(e){if(y)return y;let t=e||p(),n=ro(),o=so(t);if(o?.user_id)return y={user_id:o.user_id,display_name:o.display_name||o.user_id,team_id:o.team_id,machine_id:n,source:"config",anonymous_id:B(o.user_id),email:o.user_id.includes("@")?o.user_id:void 0},s("user-identity",`Resolved from config: ${y.anonymous_id}`,"debug"),y;let r=io(t);if(r.email)return y={user_id:r.email,display_name:r.name||r.email.split("@")[0],team_id:o?.team_id,machine_id:n,source:"git",anonymous_id:B(r.email),email:r.email},s("user-identity",`Resolved from git: ${y.anonymous_id}`,"debug"),y;let i=co();if(i.username){let u=`${i.username}@${n}`;return y={user_id:u,display_name:i.username,team_id:o?.team_id,machine_id:n,source:"env",anonymous_id:B(u)},s("user-identity",`Resolved from env: ${y.anonymous_id}`,"debug"),y}let c=B(n+process.pid);return y={user_id:`anon-${c.slice(0,8)}`,display_name:"Anonymous",team_id:o?.team_id,machine_id:n,source:"anonymous",anonymous_id:c},s("user-identity",`Resolved as anonymous: ${y.anonymous_id}`,"debug"),y}function Ve(){let e=ao();return{session_id:f(),user_id:e.user_id,anonymous_id:e.anonymous_id,team_id:e.team_id,machine_id:e.machine_id,identity_source:e.source,timestamp:new Date().toISOString()}}var go=/^[a-zA-Z0-9_-]{1,128}$/;function fo(e){return go.test(e)}function re(e,t){let n=e||f(),o=t||p();if(!fo(n))throw new Error("Invalid session ID format");return`${o}/.claude/memory/sessions/${n}`}function yo(e,t){return`${re(e,t)}/events.jsonl`}function Xe(e,t){let n=re(e,t);Qe(n)||po(n,{recursive:!0})}var P=0,qe=!1,ne=!1,Ye=0,ho=5e3;function Ze(e,t){return`${re(e,t)}/counter.json`}function So(e,t){if(!qe){qe=!0;try{let n=Ze(e,t);if(Qe(n)){let o=JSON.parse(lo(n,"utf8"));typeof o.counter=="number"&&o.counter>0&&(P=o.counter,s("session-tracker",`Loaded event counter: ${P}`,"debug"))}}catch{}}}function ko(e,t){if(!ne)return;let n=Date.now();if(!(n-Ye<ho))try{Xe(e,t);let o=Ze(e,t);mo(o,JSON.stringify({counter:P,updated_at:new Date().toISOString()})),ne=!1,Ye=n}catch{}}function _o(){return So(),P++,ne=!0,ko(),`evt-${Date.now()}-${P}`}function vo(e,t,n={}){try{let o={event_id:_o(),event_type:e,identity:Ve(),payload:{name:t,input:oe(n.input),output:oe(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?tt(n.context,500):void 0,confidence:n.confidence}};Xe();let r=yo();uo(r,JSON.stringify(o)+`
`),s("session-tracker",`Tracked ${e}: ${t}`,"debug")}catch(o){s("session-tracker",`Failed to track event: ${o}`,"warn")}}function bo(e){return e>=5&&e<12?"morning":e>=12&&e<17?"afternoon":e>=17&&e<21?"evening":"night"}function et(e){let t=new Date,n={project_dir:e?.project_dir,git_branch:e?.git_branch,time_of_day:e?.time_of_day||bo(t.getHours()),started_at:t.toISOString()};vo("session_start","session",{success:!0,input:n})}function tt(e,t){return e.length<=t?e:e.slice(0,t-3)+"..."}function oe(e){if(!e)return;let t={},n=["password","secret","token","key","credential","auth"];for(let[o,r]of Object.entries(e)){if(n.some(i=>o.toLowerCase().includes(i))){t[o]="[REDACTED]";continue}if(typeof r=="string"&&r.length>500){t[o]=tt(r,500);continue}if(typeof r=="object"&&r!==null&&!Array.isArray(r)){t[o]=oe(r);continue}t[o]=r}return t}import{execSync as xo}from"node:child_process";function Io(e){try{return xo("git rev-parse --abbrev-ref HEAD",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()||void 0}catch{return}}function K(e){try{let t=e.project_dir||p(),n=Io(t);return et({project_dir:t,git_branch:n}),s("session-tracking",`Tracked session start: branch=${n||"unknown"}`,"debug"),a()}catch(t){return s("session-tracking",`Error: ${t}`,"warn"),a()}}import{existsSync as wo,readFileSync as Eo}from"node:fs";function nt(e){s("session-metrics-summary","Session ending - generating summary");let t="/tmp/claude-session-metrics.json";if(!wo(t))return s("session-metrics-summary","No metrics file found"),a();try{let n=JSON.parse(Eo(t,"utf-8")),o=n.tools||{},r=n.errors||0,i=Object.values(o).reduce((u,l)=>u+l,0),c=Object.entries(o).sort(([,u],[,l])=>l-u).slice(0,3).map(([u,l])=>`${u}: ${l}`).join(", ");s("session-metrics-summary",`Session stats: ${i} tool calls, ${r} errors`),i>0&&s("session-metrics-summary",`Top tools: ${c}`)}catch(n){s("session-metrics-summary",`Failed to read metrics: ${n}`)}return a()}import{existsSync as v,readFileSync as ie,writeFileSync as Co,mkdirSync as Ro}from"node:fs";var Ho=[{package:"lodash",pattern:"<4.17.21",severity:"high",cve:"CVE-2021-23337",description:"Prototype pollution"},{package:"minimist",pattern:"<1.2.6",severity:"critical",cve:"CVE-2021-44906",description:"Prototype pollution"},{package:"node-fetch",pattern:"<2.6.7",severity:"high",cve:"CVE-2022-0235",description:"Information exposure"},{package:"axios",pattern:"<0.21.2",severity:"high",cve:"CVE-2021-3749",description:"ReDoS vulnerability"},{package:"jsonwebtoken",pattern:"<9.0.0",severity:"critical",cve:"CVE-2022-23529",description:"Insecure token verification"},{package:"express",pattern:"<4.17.3",severity:"medium",cve:"CVE-2022-24999",description:"Open redirect"},{package:"tar",pattern:"<6.1.11",severity:"critical",cve:"CVE-2021-37701",description:"Arbitrary file overwrite"},{package:"path-parse",pattern:"<1.0.7",severity:"medium",cve:"CVE-2021-23343",description:"ReDoS vulnerability"},{package:"django",pattern:"<3.2.14",severity:"high",cve:"CVE-2022-34265",description:"SQL injection"},{package:"flask",pattern:"<2.0.2",severity:"medium",cve:"CVE-2021-28091",description:"Path traversal"},{package:"requests",pattern:"<2.28.0",severity:"medium",cve:"CVE-2023-32681",description:"Information disclosure"},{package:"urllib3",pattern:"<1.26.5",severity:"high",cve:"CVE-2021-33503",description:"ReDoS vulnerability"},{package:"pillow",pattern:"<9.0.0",severity:"high",cve:"CVE-2022-22817",description:"Buffer overflow"},{package:"pyyaml",pattern:"<5.4",severity:"critical",cve:"CVE-2020-14343",description:"Arbitrary code execution"},{package:"jinja2",pattern:"<3.0.3",severity:"medium",cve:"CVE-2020-28493",description:"XSS vulnerability"},{package:"sqlalchemy",pattern:"<1.4.46",severity:"medium",cve:"CVE-2023-30533",description:"SQL injection"}],To=24;function $o(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Oo(e,t){let n=e.split(".").map(r=>parseInt(r,10)||0),o=t.split(".").map(r=>parseInt(r,10)||0);for(let r=0;r<Math.max(n.length,o.length);r++){let i=n[r]||0,c=o[r]||0;if(i<c)return!0;if(i>c)return!1}return!1}function Po(e,t){let n=t.charAt(0),o=t.substring(1);return n==="<"?Oo(e,o):n==="="?e===o:!1}function Do(e){return e.replace(/^[^~>=<]/,"").replace(/,.*$/,"").trim()}function ot(e,t){let n=Do(t),o=e.toLowerCase();for(let r of Ho)if(o===r.package&&Po(n,r.pattern))return r;return null}function jo(e){if(!v(e))return null;try{let t=JSON.parse(ie(e,"utf-8"));if((Date.now()-t.timestamp)/(1e3*60*60)<To)return t.warnings}catch{}return null}function se(e,t){try{Ro(e.replace(/\/[^/]+$/,""),{recursive:!0});let n={warnings:t,timestamp:Date.now()};Co(e,JSON.stringify(n,null,2))}catch{}}function No(e){let t=0,n=0,o="";if(!v(e))return{criticalCount:t,highCount:n,warnings:o};try{let r=JSON.parse(ie(e,"utf-8")),i={...r.dependencies,...r.devDependencies};for(let[c,u]of Object.entries(i)){let l=ot(c,u);l&&(l.severity==="critical"&&t++,l.severity==="high"&&n++,o+=`
- ${c}@${u}: ${l.description} (${l.cve}, ${l.severity}) - upgrade to ${l.pattern}`)}}catch{}return{criticalCount:t,highCount:n,warnings:o}}function Ao(e){let t=0,n=0,o="";if(!v(e))return{criticalCount:t,highCount:n,warnings:o};try{let i=ie(e,"utf-8").split(`
`);for(let c of i){let u=c.trim();if(!u||u.startsWith("#"))continue;let l=u.match(/^([a-zA-Z0-9_-]+)(?:==|>=|~=|!=|<|>)\s*([0-9.]+)/);if(!l)continue;let[,d,g]=l,m=ot(d,g);m&&(m.severity==="critical"&&t++,m.severity==="high"&&n++,o+=`
- ${d}==${g}: ${m.description} (${m.cve}, ${m.severity}) - upgrade to ${m.pattern}`)}}catch{}return{criticalCount:t,highCount:n,warnings:o}}function rt(e){if($o())return s("dependency-version-check","Skipping dependency check (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();s("dependency-version-check","Starting dependency version check");let t=e.project_dir||p(),n=`${t}/.claude/feedback/dependency-check-cache.json`,o=v(`${t}/package.json`),r=v(`${t}/requirements.txt`),i=v(`${t}/pyproject.toml`),c=v(`${t}/go.mod`);if(!o&&!r&&!i&&!c)return s("dependency-version-check","No package files found, skipping check"),se(n,"none"),a();let u=jo(n);if(u!==null)return s("dependency-version-check","Using cached dependency warnings"),u!=="none"?_(`DEPENDENCY SECURITY CHECK (cached): ${u}`):a();let l=0,d=0,g="";if(o){let m=No(`${t}/package.json`);l+=m.criticalCount,d+=m.highCount,m.warnings&&(g+=`

Node.js (package.json):${m.warnings}`)}if(r){let m=Ao(`${t}/requirements.txt`);l+=m.criticalCount,d+=m.highCount,m.warnings&&(g+=`

Python (requirements.txt):${m.warnings}`)}if(g){let m=`Found ${l} critical and ${d} high severity vulnerabilities`,h=`DEPENDENCY SECURITY CHECK: ${m}${g}

Run 'npm audit' or 'pip-audit' for full details.`;if(se(n,h),s("dependency-version-check",m),l>0||d>0)return _(h)}else se(n,"none"),s("dependency-version-check","No known vulnerabilities found");return a()}import{existsSync as G,readFileSync as ce,appendFileSync as Fo,mkdirSync as Mo}from"node:fs";import{join as k,dirname as Lo}from"node:path";function W(e){if(!G(e))return 0;try{return ce(e,"utf8").trim().split(`
`).filter(n=>n.trim()).length}catch{return 0}}function st(e,t){let n={};if(!G(e))return n;try{let r=ce(e,"utf8").trim().split(`
`).filter(i=>i.trim());for(let i of r)try{let c=JSON.parse(i),u=t.includes(".")?t.split(".").reduce((l,d)=>l?.[d],c):c[t];u&&typeof u=="string"&&(n[u]=(n[u]||0)+1)}catch{}}catch{}return n}function Uo(e){if(!G(e))return 0;try{let n=ce(e,"utf8").trim().split(`
`).filter(r=>r.trim()),o=0;for(let r of n)try{JSON.parse(r).event==="session_start"&&o++}catch{}return o}catch{return 0}}function ae(e){let t=e||p(),n=k(t,".claude","memory"),o=k(t,".claude","logs"),r=k(n,"decisions.jsonl"),i=k(n,"graph-queue.jsonl"),c=k(n,"mem0-queue.jsonl"),u=k(n,"completed-flows.jsonl"),l=k(o,"mem0-analytics.jsonl");return{timestamp:new Date().toISOString(),decisions:{total:W(r),byCategory:st(r,"metadata.category"),byType:st(r,"type")},queues:{graphQueueDepth:W(i),mem0QueueDepth:W(c)},completedFlows:W(u),sessionCount:Uo(l),mem0Available:!!process.env.MEM0_API_KEY}}function it(e,t){let n=e||p(),o=k(n,".claude","logs","memory-metrics.jsonl"),r=t||ae(n);try{let i=Lo(o);G(i)||Mo(i,{recursive:!0}),Fo(o,JSON.stringify(r)+`
`),s("memory-metrics",`Metrics snapshot appended: ${r.decisions.total} decisions`,"debug")}catch(i){s("memory-metrics",`Failed to write metrics: ${i}`,"warn")}}function ct(e){s("memory-metrics-collector","Collecting memory metrics");try{let t=e.project_dir||p(),n=ae(t);it(t,n)}catch(t){s("memory-metrics-collector",`Failed to collect metrics: ${t}`,"warn")}return a()}var Jo=4;function at(e){let t=je();if(t.length===0)return a();let n=0;for(let o of t)Ne(o,Jo)&&(L(o)?n++:s("stale-team-cleanup",`Failed to clean team "${o}"`));return n>0&&s("stale-team-cleanup",`Cleaned ${n} stale team(s)`),a()}var ut=[{name:"mem0-context-retrieval",fn:A},{name:"mem0-analytics-tracker",fn:N},{name:"pattern-sync-pull",fn:M},{name:"session-env-setup",fn:J},{name:"session-tracking",fn:K},{name:"memory-metrics-collector",fn:ct},{name:"stale-team-cleanup",fn:at}];async function pt(e){let t=await Promise.allSettled(ut.map(async o=>{try{let r=o.fn(e);return r instanceof Promise&&await r,{hook:o.name,status:"success"}}catch(r){let i=r instanceof Error?r.message:String(r);return s("session-start-dispatcher",`${o.name} failed: ${i}`),{hook:o.name,status:"error",message:i}}})),n=[];for(let o of t)o.status==="rejected"?n.push("unknown"):o.value.status==="error"&&n.push(o.value.hook);return n.length>0&&s("session-start-dispatcher",`${n.length}/${ut.length} hooks failed: ${n.join(", ")}`),a()}import{writeFileSync as Bo,existsSync as D,readFileSync as z,mkdirSync as Ko,appendFileSync as Wo,readdirSync as Go}from"node:fs";import{execSync as zo}from"node:child_process";import{join as b}from"node:path";function Vo(){let e=T(),t=b(e,"sessions");return D(t)||Ko(t,{recursive:!0}),b(t,`${f()}-state.json`)}function qo(e){try{if(D(e))return JSON.parse(z(e,"utf8"))}catch{}return{}}function Yo(){let e=b(p(),".claude","memory");if(!D(e))return 0;try{let t=Go(e).filter(o=>o.endsWith(".jsonl")),n=0;for(let o of t)try{let r=z(b(e,o),"utf8");n+=r.trim().split(`
`).filter(Boolean).length}catch{}return n}catch{return 0}}function Qo(){let e=b(p(),".claude","logs","decisions.jsonl");if(!D(e))return[];try{return z(e,"utf8").trim().split(`
`).filter(Boolean).slice(-10).map(o=>{try{let r=JSON.parse(o);return r.summary||r.decision||o}catch{return o}})}catch{return[]}}function Xo(e){if(e.length<2)return 0;let t=[];for(let n=1;n<e.length;n++){let o=new Date(e[n-1].timestamp).getTime(),r=new Date(e[n].timestamp).getTime();r>o&&t.push(r-o)}return t.length===0?0:Math.round(t.reduce((n,o)=>n+o,0)/t.length)}function Zo(){try{return zo("git diff --name-only HEAD 2>/dev/null",{encoding:"utf8",timeout:3e3,cwd:p()}).trim().split(`
`).filter(Boolean).slice(0,20)}catch{return[]}}function er(){let e=b(p(),".claude","logs","task-completions.jsonl");if(!D(e))return[];try{return z(e,"utf8").trim().split(`
`).filter(Boolean).slice(-5).map(o=>{try{let r=JSON.parse(o);return`${r.task_subject} [${r.task_status}]`}catch{return""}}).filter(Boolean)}catch{return[]}}function lt(e){try{let t=Vo(),n=qo(t),o=new Date().toISOString();n.lastCompaction=o,n.compactionCount=(n.compactionCount||0)+1,n.compactionHistory||(n.compactionHistory=[]),n.compactionHistory.push({timestamp:o}),n.compactionHistory.length>10&&(n.compactionHistory=n.compactionHistory.slice(-10)),n.avgCompactionIntervalMs=Xo(n.compactionHistory);let r=Yo(),i=Qo();n.preservedContext={branch:process.env.ORCHESTKIT_BRANCH||process.env.GIT_BRANCH||void 0,activeFiles:Zo(),activeTasks:er(),sessionNotes:`Compaction #${n.compactionCount} at ${o}`,decisionLog:i,memoryTierSnapshot:{localEntries:r,mem0Available:!!process.env.MEM0_API_KEY}},Bo(t,JSON.stringify(n,null,2));let c=b(T(),"compaction-history.jsonl");try{Wo(c,JSON.stringify({session:f(),timestamp:o,count:n.compactionCount,avgIntervalMs:n.avgCompactionIntervalMs,localMemoryEntries:r,decisionsPreserved:i.length})+`
`)}catch{}s("pre-compact-saver",`Saved state before compaction #${n.compactionCount} (${r} memory entries, ${i.length} decisions preserved)`)}catch(t){let n=t instanceof Error?t.message:String(t);s("pre-compact-saver",`Failed to save state: ${n}`,"warn")}return a()}import{existsSync as mt,readFileSync as tr,readdirSync as nr,statSync as or}from"node:fs";import{join as ue}from"node:path";var rr=[/\bprefill\b/i,/\bpre-fill\b/i,/assistant.*content.*:\s*["']/i,/\bprefilled?\s+(assistant|response|message)/i,/role.*assistant.*content.*(?!$)/i],sr=[/["']output_format["']\s*:/,/output_format\s*=\s*["']/,/\boutput_format\b.*\b(json|text|xml)\b/i];function ir(e){return rr.some(t=>t.test(e))}function cr(e){return/elevenlabs|mp3_\d+/i.test(e)?!1:sr.some(t=>t.test(e))}function ar(e){let t=ue(e,"skills"),n=[];if(!mt(t))return n;try{let o=nr(t).filter(r=>{try{return or(ue(t,r)).isDirectory()}catch{return!1}});for(let r of o){let i=ue(t,r,"SKILL.md");if(mt(i))try{let c=tr(i,"utf-8");(ir(c)||cr(c))&&n.push(r)}catch{}}}catch{}return n}function ur(){let e=process.env.CLAUDE_MODEL||"";return/opus/i.test(e)}function dt(e){if(!ur())return a();let t=Q(),n=ar(t);return n.length===0?(s("prefill-guard","No prefilling patterns detected in skills"),a()):(s("prefill-guard",`Found prefilling patterns in ${n.length} skills: ${n.join(", ")}`,"warn"),ke(`Opus 4.6 deprecation: ${n.length} skill(s) reference deprecated patterns (prefilled assistant messages or output_format parameter). Affected: ${n.slice(0,5).join(", ")}${n.length>5?"...":""}. Migration: use structured outputs instead of prefilling; use output_config.format instead of output_format.`))}import{writeFileSync as pr,mkdirSync as lr,existsSync as mr}from"node:fs";import{join as gt}from"node:path";function H(e,t){let n=p();if(!n)return;let o=gt(n,".claude","logs");mr(o)||lr(o,{recursive:!0});try{let r=gt(o,e);pr(r,JSON.stringify(t)+`
`,{flag:"a"})}catch{}}async function ft(e){if(!p())return{continue:!0};let t=e.teammate_id||e.agent_id||"unknown",n=e.teammate_type||e.subagent_type||"unknown",o=e.idle_duration_ms||0;return H("teammate-activity.jsonl",{timestamp:new Date().toISOString(),event:"teammate_idle",teammate_id:t,teammate_type:n,idle_duration_ms:o,session_id:e.session_id}),C("team-activity.jsonl",{ts:new Date().toISOString(),pid:w(process.env.CLAUDE_PROJECT_DIR||""),event:"idle",agent:n,idle_ms:o,...E()}),o>3e4?{continue:!0,hookSpecificOutput:{additionalContext:`Agent ${n} (${t}) idle for ${Math.round(o/1e3)}s. Consider reassigning pending work.`}}:{continue:!0}}import{existsSync as dr,readFileSync as gr}from"node:fs";import{join as fr}from"node:path";var yt=6e4;function ht(e){let t=O();if(!t)return a();let n=De();if(n.length===0)return a();let o=p();if(!o)return a();let r=fr(o,".claude","logs","teammate-activity.jsonl");if(!dr(r))return a();let i=new Date(Date.now()-yt).toISOString(),c=new Set;try{let g=gr(r,"utf-8").trim().split(`
`).filter(Boolean).slice(-50);for(let m of g)try{let h=JSON.parse(m);if(h.event==="teammate_idle"&&h.timestamp&&h.timestamp>=i){let pe=h.teammate_id||h.member_name||"";pe&&c.add(pe)}}catch{}}catch{return a()}let u=e.teammate_id||e.agent_id||"";return u&&c.add(u),s("team-synthesis-trigger",`Team "${t}": ${c.size}/${n.length} idle within ${yt/1e3}s`),c.size>=n.length?_(`All ${n.length} teammates in team "${t}" are idle. Consider synthesizing results and shutting down the team.`):a()}import{existsSync as yr,readFileSync as hr}from"node:fs";import{join as Sr}from"node:path";var kr=12e4;function St(e){let t=O();if(!t)return a();let n=p();if(!n)return a();let o=e.teammate_id||e.agent_id||"unknown",r=e.teammate_type||e.subagent_type||"unknown",i=Sr(n,".claude","logs","task-completions.jsonl"),c=!1;if(yr(i)){let u=new Date(Date.now()-kr).toISOString();try{let g=hr(i,"utf-8").trim().split(`
`).filter(Boolean).slice(-30);for(let m of g)try{let h=JSON.parse(m);if(h.event==="task_completed"&&h.timestamp&&h.timestamp>=u){c=!0;break}}catch{}}catch{}}return H("team-quality.jsonl",{timestamp:new Date().toISOString(),event:"teammate_quality_check",team_name:t,teammate_id:o,teammate_type:r,has_recent_completion:c,session_id:e.session_id}),c?(s("team-quality-gate",`Teammate "${o}" quality check passed`),a()):(s("team-quality-gate",`Teammate "${o}" (${r}) idle without recent task completion`),_(`Teammate "${r}" (${o}) went idle without completing a task. Check if their work is stuck or needs reassignment.`))}var _r=/\b(?:implement|refactor|build|migrate)\b.{5,}/i;async function kt(e){if(!p())return{continue:!0};let t=e.task_id||"unknown",n=e.task_subject||"",o=e.task_status||"completed",r=e.duration_ms||0;return H("task-completions.jsonl",{timestamp:new Date().toISOString(),event:"task_completed",task_id:t,task_subject:n,task_status:o,duration_ms:r,session_id:e.session_id}),C("task-usage.jsonl",{ts:new Date().toISOString(),pid:w(process.env.CLAUDE_PROJECT_DIR||""),task_status:o,duration_ms:r,...E()}),_r.test(n)&&o==="completed"?{continue:!0,hookSpecificOutput:{additionalContext:`Task "${n}" completed (${Math.round(r/1e3)}s). Consider running tests to verify.`}}:{continue:!0}}var _t={"lifecycle/analytics-consent-check":Ie,"lifecycle/mem0-analytics-tracker":N,"lifecycle/mem0-context-retrieval":A,"lifecycle/mem0-webhook-setup":Re,"lifecycle/pattern-sync-pull":M,"lifecycle/pattern-sync-push":Te,"lifecycle/pr-status-enricher":Oe,"lifecycle/session-cleanup":Je,"lifecycle/session-context-loader":Ke,"lifecycle/session-env-setup":J,"lifecycle/session-tracking":K,"lifecycle/session-metrics-summary":nt,"lifecycle/dependency-version-check":rt,"lifecycle/unified-dispatcher":pt,"lifecycle/pre-compact-saver":lt,"lifecycle/prefill-guard":dt,"teammate-idle/progress-reporter":ft,"teammate-idle/team-synthesis-trigger":ht,"teammate-idle/team-quality-gate":St,"task-completed/completion-tracker":kt};function Uc(e){return _t[e]}function Jc(){return Object.keys(_t)}export{Zr as escapeRegex,qt as estimateTokenCount,Zt as extractIssueNumber,Se as getCachedBranch,Yt as getCurrentBranch,is as getDefaultBranch,Mr as getEnvFile,Qr as getField,Xt as getGitStatus,Uc as getHook,T as getLogDir,Kt as getLogLevel,Q as getPluginRoot,p as getProjectDir,os as getRepoRoot,f as getSessionId,ss as hasUncommittedChanges,_t as hooks,vr as isBashInput,xr as isEditInput,rs as isGitRepo,Qt as isProtectedBranch,Ir as isReadInput,br as isWriteInput,Jc as listHooks,s as logHook,Vr as logPermissionFeedback,Xr as normalizeCommand,Lr as normalizeLineEndings,Kr as outputAllowWithContext,Jr as outputBlock,Gr as outputDeny,Wr as outputError,Gt as outputPromptContext,qr as outputPromptContextBudgeted,Ur as outputSilentAllow,a as outputSilentSuccess,ke as outputWarning,_ as outputWithContext,Br as outputWithNotification,zr as outputWithUpdatedInput,Yr as readHookInput,Wt as shouldLog,cs as validateBranchName};
//# sourceMappingURL=lifecycle.mjs.map
