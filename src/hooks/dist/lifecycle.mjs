// OrchestKit Hooks - lifecycle bundle
// Generated: 2026-02-06T19:23:13.721Z

function Fr(t){return typeof t.command=="string"}function Ar(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function Lr(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function Mr(t){return typeof t.file_path=="string"&&t.content===void 0}import{appendFileSync as pt,existsSync as mt,statSync as Ae,renameSync as Le,mkdirSync as Me,readSync as Ue}from"node:fs";import{execSync as Je}from"node:child_process";import _e from"node:os";import R from"node:path";function S(){return process.env.HOME||process.env.USERPROFILE||_e.homedir()}function B(){return process.env.CLAUDE_PROJECT_DIR||"."}function it(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function ct(){return process.env.CLAUDE_PLUGIN_ROOT?R.join(S(),".claude","logs","ork"):R.join(B(),".claude","logs")}var Br=R.join,Wr=R.sep;import{execSync as ve}from"node:child_process";import{createHash as be}from"node:crypto";import{existsSync as at,readFileSync as xe,writeFileSync as Ie,mkdirSync as we}from"node:fs";import{join as W,basename as Ce}from"node:path";var $e=20,Ee=15,He=/[^a-z0-9-]/g;function Re(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=Ce(e);return ut(n,$e)}function Oe(t){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=ve("git branch --show-current",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),o=ut(n||"detached",Ee);return process.env.ORCHESTKIT_SESSION_BRANCH=o,o}catch{return"nobranch"}}function Te(t){let e=t||new Date,n=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${n}${o}`}function De(t){let e=t||new Date,n=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0");return`${n}${o}`}function Pe(){let t=`${process.pid}-${Date.now()}-${Math.random()}`;return be("sha256").update(t).digest("hex").slice(0,4)}function ut(t,e){return t.toLowerCase().replace(He,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,e)}function je(t,e){let n=Re(t),o=Oe(t),r=Te(e),i=De(e),c=Pe();return`${n}-${o}-${r}-${i}-${c}`}function Ne(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=W(e,".instance","session-id.json");if(at(n))try{let o=JSON.parse(xe(n,"utf8"));if(o.session_id&&o.created_at){let r=Date.now()-new Date(o.created_at).getTime(),i=1440*60*1e3;if(r<i)return o.session_id}}catch{}}function Fe(t,e){let n=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),o=W(n,".instance"),r=W(o,"session-id.json");try{at(o)||we(o,{recursive:!0}),Ie(r,JSON.stringify({session_id:t,created_at:new Date().toISOString()},null,2))}catch{}}function lt(t){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let e=Ne(t);if(e)return e;let n=je(t);return Fe(n,t),n}function C(){return ct()}function u(){return B()}function G(){return it()}function dt(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${G()}/.claude/.instance_env`}function f(){return lt()}function gt(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let e=Je("git branch --show-current",{cwd:t||u(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function Ke(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function ns(t){return t.replace(/\r\n/g,`
`)}function Be(t){let e=["debug","info","warn","error"];return e.indexOf(t)>=e.indexOf(Ke())}function a(){return{continue:!0,suppressOutput:!0}}function os(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function rs(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function _(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function We(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function ss(t,e){let n={continue:!0,suppressOutput:!0};return t&&(n.systemMessage=t),e&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:e}),n}function is(t,e){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?n.systemMessage=e:n.suppressOutput=!0,n}function cs(t){return{continue:!0,systemMessage:t}}function ft(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function as(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}function us(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:t}}}var Ge=200*1024,ze=100*1024;function yt(t,e){if(mt(t))try{if(Ae(t).size>e){let o=`${t}.old.${Date.now()}`;Le(t,o)}}catch{}}function ht(t){mt(t)||Me(t,{recursive:!0})}function s(t,e,n="debug"){if(!Be(n))return;let o=C(),r=`${o}/hooks.log`;try{ht(o),yt(r,Ge);let i=new Date().toISOString().replace("T"," ").slice(0,19);pt(r,`[${i}] [${n.toUpperCase()}] [${t}] ${e}
`)}catch{}}function ls(t,e,n){let o=C(),r=`${o}/permission-feedback.log`;try{ht(o),yt(r,ze);let i=new Date().toISOString(),c=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",l=n?.session_id||f();pt(r,`${i} | ${t} | ${e} | tool=${c} | session=${l}
`)}catch{}}function Ve(t){if(!t)return 0;let o=(t.match(/[{};()=><]/g)||[]).length/t.length>.03?2.8:3.5;return Math.ceil(t.length/o)}function ps(t,e,n,o,r){let i=Ve(t);return o&&o.isOverBudget(n)?(s(e,`Budget exhausted for ${n}, suppressing ${i}t`),a()):(r&&r.trackTokenUsage(e,n,i),We(t))}function ms(){try{let t=[],n=Buffer.allocUnsafe(256),o,r=0;for(;;)try{if(o=Ue(r,n,0,256,null),o===0)break;t.push(Buffer.from(n.subarray(0,o)))}catch{break}let i=Buffer.concat(t).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:f(),tool_input:{}}}catch{return{tool_name:"",session_id:f(),tool_input:{}}}}function ds(t,e){let n=e.replace(/^\./,"").split("."),o=t;for(let r of n){if(o==null)return;o=o[r]}return o}function gs(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function fs(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}import{execSync as x}from"node:child_process";function qe(t){let e=t||u();try{return x("git branch --show-current",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return"unknown"}}function Ye(t){let e=t||qe();return["dev","main","master"].includes(e)}function ks(t){let e=t||u();try{return x("git rev-parse --show-toplevel",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return e}}function _s(t){let e=t||u();try{return x("git rev-parse --git-dir",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),!0}catch{return!1}}function Qe(t){let e=t||u();try{return x("git status --short",{cwd:e,encoding:"utf8",timeout:1e4,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function vs(t){return Qe(t).length>0}function bs(t){let e=t||u();try{return x("git rev-parse --verify main",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"main"}catch{try{return x("git rev-parse --verify master",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"master"}catch{return"main"}}}function Ze(t){let e=[/issue\/(\d+)/i,/feature\/(\d+)/i,/fix\/(\d+)/i,/bug\/(\d+)/i,/feat\/(\d+)/i,/^(\d+)-/,/-(\d+)$/,/#(\d+)/];for(let n of e){let o=t.match(n);if(o)return parseInt(o[1],10)}return null}function xs(t){if(Ye(t))return null;let e=["issue/","feature/","fix/","bug/","feat/","chore/","docs/","refactor/","test/","ci/","perf/","style/","release/","hotfix/"];return e.some(o=>t.startsWith(o))?t.startsWith("issue/")&&!Ze(t)?"issue/ branches should include an issue number (e.g., issue/123-description)":null:`Branch name should start with a valid prefix: ${e.join(", ")}`}import{existsSync as St,readFileSync as kt}from"node:fs";function Xe(t){let e=`${t}/.claude/feedback/consent-status.json`;if(!St(e))return{consented:!1,asked:!1};try{let n=JSON.parse(kt(e,"utf-8"));return{consented:n.consented===!0,asked:n.asked===!0}}catch{return{consented:!1,asked:!1}}}function tn(t){let e=`${t}/.claude/feedback/consent-log.json`;if(!St(e))return null;try{let n=JSON.parse(kt(e,"utf-8"));if(n.events&&n.events.length>0)return n.events[n.events.length-1]}catch{}return null}function en(t){try{let e=new Date(t);return Math.floor((new Date().getTime()-e.getTime())/(1e3*60*60*24))>=30}catch{return!1}}function _t(t){let e=t.project_dir||u(),n=Xe(e);if(n.consented)return s("analytics-consent-check","User has consented to analytics"),a();if(n.asked){let o=tn(e);return o&&(o.action==="declined"||o.action==="revoked")&&en(o.timestamp)?(s("analytics-consent-check","Showing 30-day reminder"),{continue:!0,systemMessage:"Reminder: Anonymous analytics help improve OrchestKit. Enable with /ork:feedback opt-in"}):(s("analytics-consent-check","User recently declined, not prompting"),a())}return s("analytics-consent-check","First time user, showing brief notice"),{continue:!0,systemMessage:"OrchestKit collects local usage metrics. Share anonymously with /ork:feedback opt-in"}}import{existsSync as T,readFileSync as Ct,writeFileSync as mn,unlinkSync as dn}from"node:fs";import{existsSync as nn,readFileSync as on}from"node:fs";import{join as rn}from"node:path";function O(){return!!(process.env.CLAUDE_CODE_TEAM_NAME||process.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS==="1")}function $(){return process.env.CLAUDE_CODE_TEAM_NAME||null}function vt(){let t=$();if(!t)return[];let e=process.env.HOME||process.env.USERPROFILE||"";if(!e)return[];let n=rn(e,".claude","teams",t,"config.json");if(!nn(n))return[];try{let r=JSON.parse(on(n,"utf-8")).members;return Array.isArray(r)?r.map(i=>({name:i.name||"unknown",agentType:i.agentType||"unknown"})):[]}catch{return[]}}import{existsSync as bt,readFileSync as sn,writeFileSync as cn,mkdirSync as an,renameSync as un}from"node:fs";import{join as ln,dirname as pn}from"node:path";function xt(t){return ln(t,".claude","coordination","locks.json")}function It(t){try{if(bt(t)){let e=JSON.parse(sn(t,"utf8"));return{locks:Array.isArray(e.locks)?e.locks:[]}}}catch{}return{locks:[]}}function wt(t,e){let n=pn(t);bt(n)||an(n,{recursive:!0});let o=`${t}.${process.pid}.tmp`;cn(o,JSON.stringify(e,null,2)),un(o,t)}function gn(t){let e=`${t}/.claude/.instance_env`;if(!T(e))return null;try{let o=Ct(e,"utf-8").match(/CLAUDE_INSTANCE_ID=([^\n]+)/);if(o)return o[1].trim()}catch{}return null}function fn(t,e){let o=`${`${t}/.claude/coordination/heartbeats`}/${e}.json`;if(T(o))try{let r=JSON.parse(Ct(o,"utf-8"));r.status="stopping",mn(o,JSON.stringify(r,null,2)),s("coordination-cleanup",`Updated heartbeat status to 'stopping' for ${e}`)}catch(r){s("coordination-cleanup",`Failed to update heartbeat: ${r}`)}}function yn(t,e){let n=`${t}/.claude/coordination/.claude.db`;if(!T(n)){s("coordination-cleanup","No coordination database found");return}s("coordination-cleanup",`Would unregister instance: ${e}`)}function hn(t,e){try{let n=xt(t),o=It(n),r=o.locks.length;o.locks=o.locks.filter(i=>i.instance_id!==e),o.locks.length<r&&(wt(n,o),s("coordination-cleanup",`Released ${r-o.locks.length} JSON locks`))}catch{}}function Sn(t){let e=`${t}/.claude/.instance_env`;try{T(e)&&(dn(e),s("coordination-cleanup","Removed instance environment file"))}catch(n){s("coordination-cleanup",`Failed to remove instance env: ${n}`)}}function $t(t){if(O())return s("coordination-cleanup","Agent Teams active, yielding to CC native cleanup"),a();s("coordination-cleanup","Starting coordination cleanup");let e=t.project_dir||u(),n=gn(e);return n&&(fn(e,n),yn(e,n),hn(e,n)),Sn(e),s("coordination-cleanup","Coordination cleanup complete"),a()}import{existsSync as kn,readFileSync as _n,writeFileSync as vn,mkdirSync as Et,appendFileSync as bn}from"node:fs";function xn(){return process.env.CLAUDE_MULTI_INSTANCE==="1"}function In(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function wn(t){let e=`${t}/.claude/context/session/state.json`;if(!kn(e))return"General development";try{return JSON.parse(_n(e,"utf-8")).current_task?.description||"General development"}catch{return"General development"}}function Cn(){return process.env.CLAUDE_SUBAGENT_ROLE||"main"}function $n(){let t=f(),e=new Date().toISOString().replace(/[-:T.Z]/g,"").slice(0,14),n=Math.random().toString(36).substring(2,8);return`${t.slice(0,8)}-${e}-${n}`}function En(t,e){let n=dt();try{Et(`${t}/.claude`,{recursive:!0}),bn(n,`CLAUDE_INSTANCE_ID=${e}
`),s("coordination-init",`Saved instance ID: ${e}`)}catch(o){s("coordination-init",`Failed to save instance ID: ${o}`)}}function Hn(t,e,n,o){let r=`${t}/.claude/coordination/heartbeats`;try{Et(r,{recursive:!0});let i={instance_id:e,task:n,role:o,status:"active",started_at:new Date().toISOString(),last_heartbeat:new Date().toISOString()};vn(`${r}/${e}.json`,JSON.stringify(i,null,2)),s("coordination-init",`Initialized heartbeat for ${e}`)}catch(i){s("coordination-init",`Failed to initialize heartbeat: ${i}`)}}function Ht(t){if(O())return s("coordination-init","Agent Teams active, yielding to CC native registration"),a();if(!xn())return s("coordination-init","Multi-instance not enabled, skipping"),a();if(In())return s("coordination-init","Skipping coordination init (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();s("coordination-init","Starting coordination initialization");let e=t.project_dir||u(),n=wn(e),o=Cn(),r=$n();return process.env.CLAUDE_INSTANCE_ID=r,En(e,r),Hn(e,r,n,o),s("coordination-init",`Coordination initialized: ${r}`),a()}import{mkdirSync as Rn,appendFileSync as On}from"node:fs";function Tn(){return!!process.env.MEM0_API_KEY}function D(t){s("mem0-analytics-tracker","Mem0 analytics tracker starting");let e=t.project_dir||u(),n=`${e}/.claude/logs/mem0-analytics.jsonl`,o=t.session_id||f(),r=new Date().toISOString(),i=JSON.stringify({session_id:o,timestamp:r,event:"session_start",mem0_available:Tn()});try{Rn(`${e}/.claude/logs`,{recursive:!0}),On(n,i+`
`),s("mem0-analytics-tracker","Mem0 analytics tracked")}catch(c){s("mem0-analytics-tracker",`Failed to write analytics: ${c}`)}return a()}import{existsSync as Dn,readFileSync as Ot,mkdirSync as Pn,renameSync as jn}from"node:fs";import{basename as Tt}from"node:path";function Nn(t){return(Tt(t)||"unknown").toLowerCase().replace(/\s+/g,"-")}function Fn(){return!!process.env.MEM0_API_KEY}function Rt(t){if(!Dn(t))return!1;try{let e=Ot(t,"utf-8"),n=JSON.parse(e);return!(!n||Object.keys(n).length===0)}catch{return!1}}function An(t,e){let n=`${e}/.claude/logs/mem0-processed`,o=new Date().toISOString().replace(/[:.]/g,"-");try{Pn(n,{recursive:!0});let i=(Tt(t)||"pending-sync").replace(".json",`.processed-${o}.json`),c=`${n}/${i}`;jn(t,c),s("mem0-context-retrieval",`Archived pending sync to ${c}`)}catch(r){s("mem0-context-retrieval",`Warning: Could not archive ${t}: ${r}`)}}function P(t){s("mem0-context-retrieval","Mem0 context retrieval starting");let e=t.project_dir||u(),n=Nn(e),o=`${e}/.mem0-pending-sync.json`,r=`${S()}/.claude/.mem0-pending-sync.json`,i=null;if(Rt(o))i=o,s("mem0-context-retrieval",`Found pending sync in project: ${o}`);else if(Rt(r))try{let c=JSON.parse(Ot(r,"utf-8"));c.project_id===n?(i=r,s("mem0-context-retrieval","Found pending sync in global location for this project")):s("mem0-context-retrieval",`Global pending sync exists but for different project: ${c.project_id}`)}catch{}return i&&(s("mem0-context-retrieval","Found pending sync, archiving for processing"),An(i,e),s("mem0-context-retrieval","Pending sync archived - will be processed on next memory operation")),Fn()?s("mem0-context-retrieval","Graph + mem0 available for this session"):s("mem0-context-retrieval","Graph available (mem0 not configured) for this session"),a()}import{writeFileSync as Ln,mkdirSync as Mn}from"node:fs";function Un(){return!!process.env.MEM0_API_KEY}function Jn(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Dt(t){if(Jn())return s("mem0-webhook-setup","Skipping mem0 webhook setup (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();if(s("mem0-webhook-setup","Mem0 webhook setup starting"),!Un())return s("mem0-webhook-setup","Mem0 not available, skipping webhook setup"),a();let e=t.project_dir||u(),n=`${e}/.claude/mem0-webhooks.json`,o="orchestkit-auto-sync",r=["memory.created","memory.updated","memory.deleted"],i=process.env.MEM0_WEBHOOK_URL||"https://example.com/webhook/mem0";s("mem0-webhook-setup","Checking for existing webhooks"),process.env.MEM0_WEBHOOK_URL||s("mem0-webhook-setup","Webhook URL not configured (set MEM0_WEBHOOK_URL), skipping creation");try{Mn(`${e}/.claude`,{recursive:!0}),Ln(n,JSON.stringify({webhook_name:o,events:r,url:i},null,2)),s("mem0-webhook-setup","Webhook config saved")}catch(c){s("mem0-webhook-setup",`Failed to save webhook config: ${c}`)}return s("mem0-webhook-setup","Webhook setup complete"),a()}import{existsSync as j,readFileSync as z,writeFileSync as Kn,statSync as Bn,mkdirSync as Wn}from"node:fs";var Gn=1*1024*1024;function zn(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Vn(t){let e=`${t}/.claude/feedback/sync-config.json`;if(!j(e))return!0;try{return JSON.parse(z(e,"utf-8")).sync_enabled!==!1}catch{return!0}}function Pt(t){if(!j(t))return!0;try{let e=Bn(t);return e.size>Gn?(s("pattern-sync-pull",`WARN: Skipping - file too large: ${t} (${e.size} bytes)`),!1):!0}catch{return!0}}function qn(t){let n=`${S()}/.claude/global-patterns.json`,o=`${t}/.claude/feedback/learned-patterns.json`;if(!j(n)){s("pattern-sync-pull","No global patterns file found");return}try{let i=JSON.parse(z(n,"utf-8")).patterns||[];if(i.length===0){s("pattern-sync-pull","No global patterns to pull");return}let c={version:"1.0",patterns:[]};if(j(o))try{c=JSON.parse(z(o,"utf-8"))}catch{}let l=c.patterns||[],p=new Set(l.map(m=>m.text)),d=i.filter(m=>!p.has(m.text));if(d.length===0){s("pattern-sync-pull","All global patterns already in project");return}let g=[...l,...d];c.patterns=g,Wn(`${t}/.claude/feedback`,{recursive:!0}),Kn(o,JSON.stringify(c,null,2)),s("pattern-sync-pull",`Pulled ${d.length} new patterns from global`)}catch(r){s("pattern-sync-pull",`Failed to pull global patterns: ${r}`)}}function N(t){if(zn())return s("pattern-sync-pull","Skipping pattern sync (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();let e=t.project_dir||u();if(!Vn(e))return s("pattern-sync-pull","Global sync disabled, skipping pull"),a();let n=`${S()}/.claude/global-patterns.json`,o=`${e}/.claude/feedback/learned-patterns.json`;return!Pt(n)||!Pt(o)?(s("pattern-sync-pull","Skipping pattern sync due to large files"),a()):(s("pattern-sync-pull","Pulling global patterns..."),qn(e),s("pattern-sync-pull","Global patterns pulled successfully"),a())}import{existsSync as V,readFileSync as q,writeFileSync as Yn,mkdirSync as Qn}from"node:fs";function Zn(t){let e=`${t}/.claude/feedback/sync-config.json`;if(!V(e))return!0;try{return JSON.parse(q(e,"utf-8")).sync_enabled!==!1}catch{return!0}}function Xn(t){let e=`${t}/.claude/feedback/learned-patterns.json`,n=S(),o=`${n}/.claude/global-patterns.json`;if(!V(e)){s("pattern-sync-push","No project patterns file found");return}try{let i=JSON.parse(q(e,"utf-8")).patterns||[];if(i.length===0){s("pattern-sync-push","No project patterns to push");return}let c={version:"1.0",patterns:[],updated:""};if(V(o))try{c=JSON.parse(q(o,"utf-8"))}catch{}let l=c.patterns||[],p=new Set(l.map(m=>m.text)),d=i.filter(m=>!p.has(m.text));if(d.length===0){s("pattern-sync-push","All project patterns already in global");return}let g=[...l,...d];c.patterns=g,c.updated=new Date().toISOString(),Qn(`${n}/.claude`,{recursive:!0}),Yn(o,JSON.stringify(c,null,2)),s("pattern-sync-push",`Pushed ${d.length} new patterns to global`)}catch(r){s("pattern-sync-push",`Failed to push project patterns: ${r}`)}}function jt(t){let e=t.project_dir||u();return Zn(e)?(s("pattern-sync-push","Pushing project patterns to global..."),Xn(e),a()):(s("pattern-sync-push","Global sync disabled, skipping push"),a())}import{execSync as Nt}from"node:child_process";var to=new Set(["main","master","dev","develop"]);function Ft(t){s("pr-status-enricher","Checking for open PR on current branch");let e=t.project_dir||u(),n;try{n=gt(e)}catch{return s("pr-status-enricher","Could not determine branch, skipping"),a()}if(!n||to.has(n))return s("pr-status-enricher",`Branch "${n}" skipped for PR detection`),a();try{let o=Nt("gh pr view --json state,reviewDecision,url,title,isDraft",{cwd:e,timeout:1e4,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim(),r=JSON.parse(o);if(!r.url)return s("pr-status-enricher","No PR found for current branch"),a();process.env.ORCHESTKIT_PR_URL=r.url,process.env.ORCHESTKIT_PR_STATE=r.state;let i=0;try{let d=Nt("gh pr view --json reviewThreads",{cwd:e,timeout:1e4,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim();i=(JSON.parse(d).reviewThreads||[]).filter(m=>!m.isResolved).length}catch{}let c=r.isDraft?" (DRAFT)":"",l=r.reviewDecision?` | Review: ${r.reviewDecision}`:"",p=i>0?` | ${i} unresolved`:"";s("pr-status-enricher",`PR: ${r.title}${c} [${r.state}${l}${p}]`),s("pr-status-enricher",`URL: ${r.url}`)}catch{s("pr-status-enricher","No PR found or gh CLI unavailable")}return a()}import{existsSync as I,readFileSync as Lt,writeFileSync as eo,mkdirSync as no,readdirSync as Mt,unlinkSync as Ut,copyFileSync as oo}from"node:fs";import{join as At}from"node:path";import{homedir as ro}from"node:os";function so(t){if(!I(t))return 0;try{let n=JSON.parse(Lt(t,"utf-8")).tools||{};return Object.values(n).reduce((o,r)=>o+r,0)}catch{return 0}}function io(t,e){if(!I(t))return;let n=so(t);if(n<=5){s("session-cleanup",`Session had only ${n} tool calls, not archiving`);return}try{no(e,{recursive:!0});let r=`session-${new Date().toISOString().replace(/[:.]/g,"-")}.json`,i=`${e}/${r}`;oo(t,i),s("session-cleanup",`Archived session metrics to ${r}`)}catch(o){s("session-cleanup",`Failed to archive metrics: ${o}`)}}function co(t,e=20){if(I(t))try{let n=Mt(t).filter(r=>r.startsWith("session-")&&r.endsWith(".json")).sort().reverse();if(n.length<=e)return;let o=n.slice(e);for(let r of o)try{Ut(`${t}/${r}`),s("session-cleanup",`Deleted old archive: ${r}`)}catch{}}catch(n){s("session-cleanup",`Failed to cleanup old archives: ${n}`)}}function ao(t){if(!I(t))return;let e=["hooks.log.old*","audit.log.old*"];for(let n of e)try{let o=n.replace("*",""),r=Mt(t).filter(c=>c.startsWith(o)).sort().reverse();if(r.length<=5)continue;let i=r.slice(5);for(let c of i)try{Ut(`${t}/${c}`)}catch{}}catch{}}function uo(t){if(!t||typeof t!="string"||t==="No prompt")return t||"";let e=t;if(e.includes("<task-notification>")){let i=e.match(/<summary>(.*?)<\/summary>/s);return i?i[1].trim():"(background task)"}let n=e.match(/<command-args>(.*?)(?:<\/command-args>|$)/s),o=e.match(/<command-name>(.*?)<\/command-name>/);if(o||n){let i=[];if(o&&i.push(o[1].trim()),n){let c=n[1].trim();c&&i.push(c)}if(i.length>0)return i.join(" ")}e=e.replace(/<[^>]+>/g," "),e=e.replace(/[\u2500-\u259f]/g,"");let r=e.indexOf("\u276F");return r!==-1?e=e.slice(r+1):(e=e.replace(/Claude Code v[\d.]+/g,""),e=e.replace(/Opus [\d.]+\s*[·.]\s*Claude Max/g,"")),e=e.replace(/[✻⏺⎿]\s*/g,""),e=e.replace(/Conversation compacted[^)]*\)/g,""),e=e.replace(/Referenced file [^\s]+/g,""),e=e.replace(/\s+(Bash|Read|Write|Edit|Glob|Grep|Task|Skill)\(.*$/s,""),e=e.replace(/~\/[\w/._-]+/g,""),e=e.replace(/[…]+/g,""),e=e.replace(/\s+/g," ").trim(),e}function lo(t){let e=ro(),n=At(e,".claude","projects");if(!I(n))return;let o=t.replace(/\//g,"-"),r=At(n,o,"sessions-index.json");if(!I(r)){s("session-cleanup","No sessions-index.json found");return}try{let i=JSON.parse(Lt(r,"utf-8")),c=0;for(let l of i.entries){if(!l.firstPrompt||l.firstPrompt==="No prompt")continue;let p=uo(l.firstPrompt);(!p||p.length<10)&&(p=l.summary||l.firstPrompt),p!==l.firstPrompt&&(l.firstPrompt=p,c++)}c>0&&(eo(r,JSON.stringify(i,null,4)),s("session-cleanup",`Sanitized ${c} session firstPrompt entries`))}catch(i){s("session-cleanup",`Failed to sanitize sessions index: ${i}`,"warn")}}function Jt(t){s("session-cleanup","Session cleanup starting");let e=t.project_dir||u(),n="/tmp/claude-session-metrics.json",o=`${e}/.claude/logs/sessions`,r=`${e}/.claude/logs`;return lo(e),io(n,o),co(o,20),ao(r),s("session-cleanup","Session cleanup complete"),a()}import{existsSync as Y,readFileSync as Kt}from"node:fs";function F(t){if(!Y(t))return!1;try{return JSON.parse(Kt(t,"utf-8")),!0}catch{return!1}}function Bt(t){s("session-context-loader","Session starting - loading context (Protocol 2.0)");let e=t.project_dir||u(),n=0,o=process.env.AGENT_TYPE||"",r=`${e}/.claude/context/session/state.json`,i=`${e}/.claude/context/identity.json`,c=`${e}/.claude/context/knowledge/index.json`;F(r)&&(s("session-context-loader","Session state loaded"),n++),F(i)&&(s("session-context-loader","Identity loaded"),n++),F(c)&&(s("session-context-loader","Knowledge index available"),n++);let l=`${e}/docs/CURRENT_STATUS.md`;if(Y(l)&&s("session-context-loader","Current status document exists"),o){s("session-context-loader",`Agent-type aware initialization: ${o}`);let d=`${e}/.claude/agents/${o}.md`;Y(d)&&(s("session-context-loader",`Agent configuration found: ${d}`),n++)}let p=`${e}/.claude/context/session/compaction-manifest.json`;if(F(p))try{let d=JSON.parse(Kt(p,"utf-8"));s("session-context-loader",`Compaction manifest loaded: session=${d.sessionId}, decisions=${(d.keyDecisions||[]).length}, files=${(d.filesTouched||[]).length}`),process.env.ORCHESTKIT_LAST_SESSION=d.sessionId||"",process.env.ORCHESTKIT_LAST_DECISIONS=JSON.stringify(d.keyDecisions||[]),n++}catch(d){s("session-context-loader",`Error loading compaction manifest: ${d}`)}return n>0&&(o?s("session-context-loader",`Session context loaded (Protocol 2.0) - Agent: ${o}`):s("session-context-loader","Session context loaded (Protocol 2.0)")),a()}import{existsSync as po,readFileSync as mo,writeFileSync as Wt,mkdirSync as go}from"node:fs";import{execSync as fo}from"node:child_process";function yo(t){try{return fo("git branch --show-current",{cwd:t,encoding:"utf-8",timeout:500,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function A(t){s("session-env-setup","Setting up session environment");let e=t.project_dir||u(),n=t.session_id||f(),o="/tmp/claude-session-metrics.json";try{go(`${e}/.claude/logs`,{recursive:!0})}catch{}let r=process.env.AGENT_TYPE||"";!r&&t.agent_type&&(r=t.agent_type);let i={session_id:n,started_at:new Date().toISOString(),agent_type:r,tools:{},errors:0,warnings:0};try{Wt(o,JSON.stringify(i,null,2)),s("session-env-setup","Initialized session metrics")}catch(p){s("session-env-setup",`Failed to initialize metrics: ${p}`)}let c=`${e}/.claude/context/session/state.json`;if(po(c)&&r)try{let p=JSON.parse(mo(c,"utf-8"));p.agent_type=r,p.session_id=n,p.last_activity=new Date().toISOString(),Wt(c,JSON.stringify(p,null,2)),s("session-env-setup",`Updated session state with agent_type: ${r}`)}catch(p){s("session-env-setup",`Failed to update session state: ${p}`)}let l=yo(e);return l&&s("session-env-setup",`Git branch: ${l}`),r&&s("session-env-setup",`Agent type: ${r}`),a()}import{existsSync as Qt,appendFileSync as $o,mkdirSync as Eo,readFileSync as Ho,writeFileSync as Ro}from"node:fs";import{existsSync as ho,readFileSync as So,writeFileSync as $i,mkdirSync as Ei}from"node:fs";import{execSync as Gt}from"node:child_process";import{createHash as ko}from"node:crypto";import*as zt from"node:os";var _o=".claude/.user_identity.json",vo="orchestkit-user-identity-v1";var y=null;function L(t){return ko("sha256").update(t+vo).digest("hex").slice(0,32)}function bo(){try{return zt.hostname()}catch{return"unknown-machine"}}function xo(t){let e=`${t}/${_o}`;if(!ho(e))return null;try{let n=So(e,"utf8");return JSON.parse(n)}catch(n){return s("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function Io(t){let e={};try{e.email=Gt("git config user.email",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{e.name=Gt("git config user.name",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return e}function wo(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function Co(t){if(y)return y;let e=t||u(),n=bo(),o=xo(e);if(o?.user_id)return y={user_id:o.user_id,display_name:o.display_name||o.user_id,team_id:o.team_id,machine_id:n,source:"config",anonymous_id:L(o.user_id),email:o.user_id.includes("@")?o.user_id:void 0},s("user-identity",`Resolved from config: ${y.anonymous_id}`,"debug"),y;let r=Io(e);if(r.email)return y={user_id:r.email,display_name:r.name||r.email.split("@")[0],team_id:o?.team_id,machine_id:n,source:"git",anonymous_id:L(r.email),email:r.email},s("user-identity",`Resolved from git: ${y.anonymous_id}`,"debug"),y;let i=wo();if(i.username){let l=`${i.username}@${n}`;return y={user_id:l,display_name:i.username,team_id:o?.team_id,machine_id:n,source:"env",anonymous_id:L(l)},s("user-identity",`Resolved from env: ${y.anonymous_id}`,"debug"),y}let c=L(n+process.pid);return y={user_id:`anon-${c.slice(0,8)}`,display_name:"Anonymous",team_id:o?.team_id,machine_id:n,source:"anonymous",anonymous_id:c},s("user-identity",`Resolved as anonymous: ${y.anonymous_id}`,"debug"),y}function Vt(){let t=Co();return{session_id:f(),user_id:t.user_id,anonymous_id:t.anonymous_id,team_id:t.team_id,machine_id:t.machine_id,identity_source:t.source,timestamp:new Date().toISOString()}}var Oo=/^[a-zA-Z0-9_-]{1,128}$/;function To(t){return Oo.test(t)}function X(t,e){let n=t||f(),o=e||u();if(!To(n))throw new Error("Invalid session ID format");return`${o}/.claude/memory/sessions/${n}`}function Do(t,e){return`${X(t,e)}/events.jsonl`}function Zt(t,e){let n=X(t,e);Qt(n)||Eo(n,{recursive:!0})}var E=0,qt=!1,Q=!1,Yt=0,Po=5e3;function Xt(t,e){return`${X(t,e)}/counter.json`}function jo(t,e){if(!qt){qt=!0;try{let n=Xt(t,e);if(Qt(n)){let o=JSON.parse(Ho(n,"utf8"));typeof o.counter=="number"&&o.counter>0&&(E=o.counter,s("session-tracker",`Loaded event counter: ${E}`,"debug"))}}catch{}}}function No(t,e){if(!Q)return;let n=Date.now();if(!(n-Yt<Po))try{Zt(t,e);let o=Xt(t,e);Ro(o,JSON.stringify({counter:E,updated_at:new Date().toISOString()})),Q=!1,Yt=n}catch{}}function Fo(){return jo(),E++,Q=!0,No(),`evt-${Date.now()}-${E}`}function Ao(t,e,n={}){try{let o={event_id:Fo(),event_type:t,identity:Vt(),payload:{name:e,input:Z(n.input),output:Z(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?ee(n.context,500):void 0,confidence:n.confidence}};Zt();let r=Do();$o(r,JSON.stringify(o)+`
`),s("session-tracker",`Tracked ${t}: ${e}`,"debug")}catch(o){s("session-tracker",`Failed to track event: ${o}`,"warn")}}function Lo(t){return t>=5&&t<12?"morning":t>=12&&t<17?"afternoon":t>=17&&t<21?"evening":"night"}function te(t){let e=new Date,n={project_dir:t?.project_dir,git_branch:t?.git_branch,time_of_day:t?.time_of_day||Lo(e.getHours()),started_at:e.toISOString()};Ao("session_start","session",{success:!0,input:n})}function ee(t,e){return t.length<=e?t:t.slice(0,e-3)+"..."}function Z(t){if(!t)return;let e={},n=["password","secret","token","key","credential","auth"];for(let[o,r]of Object.entries(t)){if(n.some(i=>o.toLowerCase().includes(i))){e[o]="[REDACTED]";continue}if(typeof r=="string"&&r.length>500){e[o]=ee(r,500);continue}if(typeof r=="object"&&r!==null&&!Array.isArray(r)){e[o]=Z(r);continue}e[o]=r}return e}import{execSync as Mo}from"node:child_process";function Uo(t){try{return Mo("git rev-parse --abbrev-ref HEAD",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()||void 0}catch{return}}function M(t){try{let e=t.project_dir||u(),n=Uo(e);return te({project_dir:e,git_branch:n}),s("session-tracking",`Tracked session start: branch=${n||"unknown"}`,"debug"),a()}catch(e){return s("session-tracking",`Error: ${e}`,"warn"),a()}}import{existsSync as Jo,readFileSync as Ko}from"node:fs";function ne(t){s("session-metrics-summary","Session ending - generating summary");let e="/tmp/claude-session-metrics.json";if(!Jo(e))return s("session-metrics-summary","No metrics file found"),a();try{let n=JSON.parse(Ko(e,"utf-8")),o=n.tools||{},r=n.errors||0,i=Object.values(o).reduce((l,p)=>l+p,0),c=Object.entries(o).sort(([,l],[,p])=>p-l).slice(0,3).map(([l,p])=>`${l}: ${p}`).join(", ");s("session-metrics-summary",`Session stats: ${i} tool calls, ${r} errors`),i>0&&s("session-metrics-summary",`Top tools: ${c}`)}catch(n){s("session-metrics-summary",`Failed to read metrics: ${n}`)}return a()}import{existsSync as v,readFileSync as et,writeFileSync as Bo,mkdirSync as Wo}from"node:fs";var Go=[{package:"lodash",pattern:"<4.17.21",severity:"high",cve:"CVE-2021-23337",description:"Prototype pollution"},{package:"minimist",pattern:"<1.2.6",severity:"critical",cve:"CVE-2021-44906",description:"Prototype pollution"},{package:"node-fetch",pattern:"<2.6.7",severity:"high",cve:"CVE-2022-0235",description:"Information exposure"},{package:"axios",pattern:"<0.21.2",severity:"high",cve:"CVE-2021-3749",description:"ReDoS vulnerability"},{package:"jsonwebtoken",pattern:"<9.0.0",severity:"critical",cve:"CVE-2022-23529",description:"Insecure token verification"},{package:"express",pattern:"<4.17.3",severity:"medium",cve:"CVE-2022-24999",description:"Open redirect"},{package:"tar",pattern:"<6.1.11",severity:"critical",cve:"CVE-2021-37701",description:"Arbitrary file overwrite"},{package:"path-parse",pattern:"<1.0.7",severity:"medium",cve:"CVE-2021-23343",description:"ReDoS vulnerability"},{package:"django",pattern:"<3.2.14",severity:"high",cve:"CVE-2022-34265",description:"SQL injection"},{package:"flask",pattern:"<2.0.2",severity:"medium",cve:"CVE-2021-28091",description:"Path traversal"},{package:"requests",pattern:"<2.28.0",severity:"medium",cve:"CVE-2023-32681",description:"Information disclosure"},{package:"urllib3",pattern:"<1.26.5",severity:"high",cve:"CVE-2021-33503",description:"ReDoS vulnerability"},{package:"pillow",pattern:"<9.0.0",severity:"high",cve:"CVE-2022-22817",description:"Buffer overflow"},{package:"pyyaml",pattern:"<5.4",severity:"critical",cve:"CVE-2020-14343",description:"Arbitrary code execution"},{package:"jinja2",pattern:"<3.0.3",severity:"medium",cve:"CVE-2020-28493",description:"XSS vulnerability"},{package:"sqlalchemy",pattern:"<1.4.46",severity:"medium",cve:"CVE-2023-30533",description:"SQL injection"}],zo=24;function Vo(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function qo(t,e){let n=t.split(".").map(r=>parseInt(r,10)||0),o=e.split(".").map(r=>parseInt(r,10)||0);for(let r=0;r<Math.max(n.length,o.length);r++){let i=n[r]||0,c=o[r]||0;if(i<c)return!0;if(i>c)return!1}return!1}function Yo(t,e){let n=e.charAt(0),o=e.substring(1);return n==="<"?qo(t,o):n==="="?t===o:!1}function Qo(t){return t.replace(/^[^~>=<]/,"").replace(/,.*$/,"").trim()}function oe(t,e){let n=Qo(e),o=t.toLowerCase();for(let r of Go)if(o===r.package&&Yo(n,r.pattern))return r;return null}function Zo(t){if(!v(t))return null;try{let e=JSON.parse(et(t,"utf-8"));if((Date.now()-e.timestamp)/(1e3*60*60)<zo)return e.warnings}catch{}return null}function tt(t,e){try{Wo(t.replace(/\/[^/]+$/,""),{recursive:!0});let n={warnings:e,timestamp:Date.now()};Bo(t,JSON.stringify(n,null,2))}catch{}}function Xo(t){let e=0,n=0,o="";if(!v(t))return{criticalCount:e,highCount:n,warnings:o};try{let r=JSON.parse(et(t,"utf-8")),i={...r.dependencies,...r.devDependencies};for(let[c,l]of Object.entries(i)){let p=oe(c,l);p&&(p.severity==="critical"&&e++,p.severity==="high"&&n++,o+=`
- ${c}@${l}: ${p.description} (${p.cve}, ${p.severity}) - upgrade to ${p.pattern}`)}}catch{}return{criticalCount:e,highCount:n,warnings:o}}function tr(t){let e=0,n=0,o="";if(!v(t))return{criticalCount:e,highCount:n,warnings:o};try{let i=et(t,"utf-8").split(`
`);for(let c of i){let l=c.trim();if(!l||l.startsWith("#"))continue;let p=l.match(/^([a-zA-Z0-9_-]+)(?:==|>=|~=|!=|<|>)\s*([0-9.]+)/);if(!p)continue;let[,d,g]=p,m=oe(d,g);m&&(m.severity==="critical"&&e++,m.severity==="high"&&n++,o+=`
- ${d}==${g}: ${m.description} (${m.cve}, ${m.severity}) - upgrade to ${m.pattern}`)}}catch{}return{criticalCount:e,highCount:n,warnings:o}}function re(t){if(Vo())return s("dependency-version-check","Skipping dependency check (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();s("dependency-version-check","Starting dependency version check");let e=t.project_dir||u(),n=`${e}/.claude/feedback/dependency-check-cache.json`,o=v(`${e}/package.json`),r=v(`${e}/requirements.txt`),i=v(`${e}/pyproject.toml`),c=v(`${e}/go.mod`);if(!o&&!r&&!i&&!c)return s("dependency-version-check","No package files found, skipping check"),tt(n,"none"),a();let l=Zo(n);if(l!==null)return s("dependency-version-check","Using cached dependency warnings"),l!=="none"?_(`DEPENDENCY SECURITY CHECK (cached): ${l}`):a();let p=0,d=0,g="";if(o){let m=Xo(`${e}/package.json`);p+=m.criticalCount,d+=m.highCount,m.warnings&&(g+=`

Node.js (package.json):${m.warnings}`)}if(r){let m=tr(`${e}/requirements.txt`);p+=m.criticalCount,d+=m.highCount,m.warnings&&(g+=`

Python (requirements.txt):${m.warnings}`)}if(g){let m=`Found ${p} critical and ${d} high severity vulnerabilities`,h=`DEPENDENCY SECURITY CHECK: ${m}${g}

Run 'npm audit' or 'pip-audit' for full details.`;if(tt(n,h),s("dependency-version-check",m),p>0||d>0)return _(h)}else tt(n,"none"),s("dependency-version-check","No known vulnerabilities found");return a()}import{existsSync as J,readFileSync as nt,appendFileSync as er,mkdirSync as nr}from"node:fs";import{join as k,dirname as or}from"node:path";function U(t){if(!J(t))return 0;try{return nt(t,"utf8").trim().split(`
`).filter(n=>n.trim()).length}catch{return 0}}function se(t,e){let n={};if(!J(t))return n;try{let r=nt(t,"utf8").trim().split(`
`).filter(i=>i.trim());for(let i of r)try{let c=JSON.parse(i),l=e.includes(".")?e.split(".").reduce((p,d)=>p?.[d],c):c[e];l&&typeof l=="string"&&(n[l]=(n[l]||0)+1)}catch{}}catch{}return n}function rr(t){if(!J(t))return 0;try{let n=nt(t,"utf8").trim().split(`
`).filter(r=>r.trim()),o=0;for(let r of n)try{JSON.parse(r).event==="session_start"&&o++}catch{}return o}catch{return 0}}function ot(t){let e=t||u(),n=k(e,".claude","memory"),o=k(e,".claude","logs"),r=k(n,"decisions.jsonl"),i=k(n,"graph-queue.jsonl"),c=k(n,"mem0-queue.jsonl"),l=k(n,"completed-flows.jsonl"),p=k(o,"mem0-analytics.jsonl");return{timestamp:new Date().toISOString(),decisions:{total:U(r),byCategory:se(r,"metadata.category"),byType:se(r,"type")},queues:{graphQueueDepth:U(i),mem0QueueDepth:U(c)},completedFlows:U(l),sessionCount:rr(p),mem0Available:!!process.env.MEM0_API_KEY}}function ie(t,e){let n=t||u(),o=k(n,".claude","logs","memory-metrics.jsonl"),r=e||ot(n);try{let i=or(o);J(i)||nr(i,{recursive:!0}),er(o,JSON.stringify(r)+`
`),s("memory-metrics",`Metrics snapshot appended: ${r.decisions.total} decisions`,"debug")}catch(i){s("memory-metrics",`Failed to write metrics: ${i}`,"warn")}}function ce(t){s("memory-metrics-collector","Collecting memory metrics");try{let e=t.project_dir||u(),n=ot(e);ie(e,n)}catch(e){s("memory-metrics-collector",`Failed to collect metrics: ${e}`,"warn")}return a()}var ae=[{name:"mem0-context-retrieval",fn:P},{name:"mem0-analytics-tracker",fn:D},{name:"pattern-sync-pull",fn:N},{name:"session-env-setup",fn:A},{name:"session-tracking",fn:M},{name:"memory-metrics-collector",fn:ce}];async function ue(t){let e=await Promise.allSettled(ae.map(async o=>{try{let r=o.fn(t);return r instanceof Promise&&await r,{hook:o.name,status:"success"}}catch(r){let i=r instanceof Error?r.message:String(r);return s("session-start-dispatcher",`${o.name} failed: ${i}`),{hook:o.name,status:"error",message:i}}})),n=[];for(let o of e)o.status==="rejected"?n.push("unknown"):o.value.status==="error"&&n.push(o.value.hook);return n.length>0&&s("session-start-dispatcher",`${n.length}/${ae.length} hooks failed: ${n.join(", ")}`),a()}import{writeFileSync as sr,existsSync as H,readFileSync as K,mkdirSync as ir,appendFileSync as cr,readdirSync as ar}from"node:fs";import{execSync as ur}from"node:child_process";import{join as b}from"node:path";function lr(){let t=C(),e=b(t,"sessions");return H(e)||ir(e,{recursive:!0}),b(e,`${f()}-state.json`)}function pr(t){try{if(H(t))return JSON.parse(K(t,"utf8"))}catch{}return{}}function mr(){let t=b(u(),".claude","memory");if(!H(t))return 0;try{let e=ar(t).filter(o=>o.endsWith(".jsonl")),n=0;for(let o of e)try{let r=K(b(t,o),"utf8");n+=r.trim().split(`
`).filter(Boolean).length}catch{}return n}catch{return 0}}function dr(){let t=b(u(),".claude","logs","decisions.jsonl");if(!H(t))return[];try{return K(t,"utf8").trim().split(`
`).filter(Boolean).slice(-10).map(o=>{try{let r=JSON.parse(o);return r.summary||r.decision||o}catch{return o}})}catch{return[]}}function gr(t){if(t.length<2)return 0;let e=[];for(let n=1;n<t.length;n++){let o=new Date(t[n-1].timestamp).getTime(),r=new Date(t[n].timestamp).getTime();r>o&&e.push(r-o)}return e.length===0?0:Math.round(e.reduce((n,o)=>n+o,0)/e.length)}function fr(){try{return ur("git diff --name-only HEAD 2>/dev/null",{encoding:"utf8",timeout:3e3,cwd:u()}).trim().split(`
`).filter(Boolean).slice(0,20)}catch{return[]}}function yr(){let t=b(u(),".claude","logs","task-completions.jsonl");if(!H(t))return[];try{return K(t,"utf8").trim().split(`
`).filter(Boolean).slice(-5).map(o=>{try{let r=JSON.parse(o);return`${r.task_subject} [${r.task_status}]`}catch{return""}}).filter(Boolean)}catch{return[]}}function le(t){try{let e=lr(),n=pr(e),o=new Date().toISOString();n.lastCompaction=o,n.compactionCount=(n.compactionCount||0)+1,n.compactionHistory||(n.compactionHistory=[]),n.compactionHistory.push({timestamp:o}),n.compactionHistory.length>10&&(n.compactionHistory=n.compactionHistory.slice(-10)),n.avgCompactionIntervalMs=gr(n.compactionHistory);let r=mr(),i=dr();n.preservedContext={branch:process.env.ORCHESTKIT_BRANCH||process.env.GIT_BRANCH||void 0,activeFiles:fr(),activeTasks:yr(),sessionNotes:`Compaction #${n.compactionCount} at ${o}`,decisionLog:i,memoryTierSnapshot:{localEntries:r,mem0Available:!!process.env.MEM0_API_KEY}},sr(e,JSON.stringify(n,null,2));let c=b(C(),"compaction-history.jsonl");try{cr(c,JSON.stringify({session:f(),timestamp:o,count:n.compactionCount,avgIntervalMs:n.avgCompactionIntervalMs,localMemoryEntries:r,decisionsPreserved:i.length})+`
`)}catch{}s("pre-compact-saver",`Saved state before compaction #${n.compactionCount} (${r} memory entries, ${i.length} decisions preserved)`)}catch(e){let n=e instanceof Error?e.message:String(e);s("pre-compact-saver",`Failed to save state: ${n}`,"warn")}return a()}import{existsSync as pe,readFileSync as hr,readdirSync as Sr,statSync as kr}from"node:fs";import{join as rt}from"node:path";var _r=[/\bprefill\b/i,/\bpre-fill\b/i,/assistant.*content.*:\s*["']/i,/\bprefilled?\s+(assistant|response|message)/i,/role.*assistant.*content.*(?!$)/i],vr=[/["']output_format["']\s*:/,/output_format\s*=\s*["']/,/\boutput_format\b.*\b(json|text|xml)\b/i];function br(t){return _r.some(e=>e.test(t))}function xr(t){return/elevenlabs|mp3_\d+/i.test(t)?!1:vr.some(e=>e.test(t))}function Ir(t){let e=rt(t,"skills"),n=[];if(!pe(e))return n;try{let o=Sr(e).filter(r=>{try{return kr(rt(e,r)).isDirectory()}catch{return!1}});for(let r of o){let i=rt(e,r,"SKILL.md");if(pe(i))try{let c=hr(i,"utf-8");(br(c)||xr(c))&&n.push(r)}catch{}}}catch{}return n}function wr(){let t=process.env.CLAUDE_MODEL||"";return/opus/i.test(t)}function me(t){if(!wr())return a();let e=G(),n=Ir(e);return n.length===0?(s("prefill-guard","No prefilling patterns detected in skills"),a()):(s("prefill-guard",`Found prefilling patterns in ${n.length} skills: ${n.join(", ")}`,"warn"),ft(`Opus 4.6 deprecation: ${n.length} skill(s) reference deprecated patterns (prefilled assistant messages or output_format parameter). Affected: ${n.slice(0,5).join(", ")}${n.length>5?"...":""}. Migration: use structured outputs instead of prefilling; use output_config.format instead of output_format.`))}import{writeFileSync as Cr,mkdirSync as $r,existsSync as Er}from"node:fs";import{join as de}from"node:path";function w(t,e){let n=u();if(!n)return;let o=de(n,".claude","logs");Er(o)||$r(o,{recursive:!0});try{let r=de(o,t);Cr(r,JSON.stringify(e)+`
`,{flag:"a"})}catch{}}async function ge(t){if(!u())return{continue:!0};let e=t.teammate_id||t.agent_id||"unknown",n=t.teammate_type||t.subagent_type||"unknown",o=t.idle_duration_ms||0;return w("teammate-activity.jsonl",{timestamp:new Date().toISOString(),event:"teammate_idle",teammate_id:e,teammate_type:n,idle_duration_ms:o,session_id:t.session_id}),o>3e4?{continue:!0,hookSpecificOutput:{additionalContext:`Agent ${n} (${e}) idle for ${Math.round(o/1e3)}s. Consider reassigning pending work.`}}:{continue:!0}}import{existsSync as Hr,readFileSync as Rr}from"node:fs";import{join as Or}from"node:path";var fe=6e4;function ye(t){let e=$();if(!e)return a();let n=vt();if(n.length===0)return a();let o=u();if(!o)return a();let r=Or(o,".claude","logs","teammate-activity.jsonl");if(!Hr(r))return a();let i=new Date(Date.now()-fe).toISOString(),c=new Set;try{let g=Rr(r,"utf-8").trim().split(`
`).filter(Boolean).slice(-50);for(let m of g)try{let h=JSON.parse(m);if(h.event==="teammate_idle"&&h.timestamp&&h.timestamp>=i){let st=h.teammate_id||h.member_name||"";st&&c.add(st)}}catch{}}catch{return a()}let l=t.teammate_id||t.agent_id||"";return l&&c.add(l),s("team-synthesis-trigger",`Team "${e}": ${c.size}/${n.length} idle within ${fe/1e3}s`),c.size>=n.length?_(`All ${n.length} teammates in team "${e}" are idle. Consider synthesizing results and shutting down the team.`):a()}import{existsSync as Tr,readFileSync as Dr}from"node:fs";import{join as Pr}from"node:path";var jr=12e4;function he(t){let e=$();if(!e)return a();let n=u();if(!n)return a();let o=t.teammate_id||t.agent_id||"unknown",r=t.teammate_type||t.subagent_type||"unknown",i=Pr(n,".claude","logs","task-completions.jsonl"),c=!1;if(Tr(i)){let l=new Date(Date.now()-jr).toISOString();try{let g=Dr(i,"utf-8").trim().split(`
`).filter(Boolean).slice(-30);for(let m of g)try{let h=JSON.parse(m);if(h.event==="task_completed"&&h.timestamp&&h.timestamp>=l){c=!0;break}}catch{}}catch{}}return w("team-quality.jsonl",{timestamp:new Date().toISOString(),event:"teammate_quality_check",team_name:e,teammate_id:o,teammate_type:r,has_recent_completion:c,session_id:t.session_id}),c?(s("team-quality-gate",`Teammate "${o}" quality check passed`),a()):(s("team-quality-gate",`Teammate "${o}" (${r}) idle without recent task completion`),_(`Teammate "${r}" (${o}) went idle without completing a task. Check if their work is stuck or needs reassignment.`))}var Nr=/\b(?:implement|refactor|build|migrate)\b.{5,}/i;async function Se(t){if(!u())return{continue:!0};let e=t.task_id||"unknown",n=t.task_subject||"",o=t.task_status||"completed",r=t.duration_ms||0;return w("task-completions.jsonl",{timestamp:new Date().toISOString(),event:"task_completed",task_id:e,task_subject:n,task_status:o,duration_ms:r,session_id:t.session_id}),Nr.test(n)&&o==="completed"?{continue:!0,hookSpecificOutput:{additionalContext:`Task "${n}" completed (${Math.round(r/1e3)}s). Consider running tests to verify.`}}:{continue:!0}}var ke={"lifecycle/analytics-consent-check":_t,"lifecycle/coordination-cleanup":$t,"lifecycle/coordination-init":Ht,"lifecycle/mem0-analytics-tracker":D,"lifecycle/mem0-context-retrieval":P,"lifecycle/mem0-webhook-setup":Dt,"lifecycle/pattern-sync-pull":N,"lifecycle/pattern-sync-push":jt,"lifecycle/pr-status-enricher":Ft,"lifecycle/session-cleanup":Jt,"lifecycle/session-context-loader":Bt,"lifecycle/session-env-setup":A,"lifecycle/session-tracking":M,"lifecycle/session-metrics-summary":ne,"lifecycle/dependency-version-check":re,"lifecycle/unified-dispatcher":ue,"lifecycle/pre-compact-saver":le,"lifecycle/prefill-guard":me,"teammate-idle/progress-reporter":ge,"teammate-idle/team-synthesis-trigger":ye,"teammate-idle/team-quality-gate":he,"task-completed/completion-tracker":Se};function ia(t){return ke[t]}function ca(){return Object.keys(ke)}export{fs as escapeRegex,Ve as estimateTokenCount,Ze as extractIssueNumber,gt as getCachedBranch,qe as getCurrentBranch,bs as getDefaultBranch,dt as getEnvFile,ds as getField,Qe as getGitStatus,ia as getHook,C as getLogDir,Ke as getLogLevel,G as getPluginRoot,u as getProjectDir,ks as getRepoRoot,f as getSessionId,vs as hasUncommittedChanges,ke as hooks,Fr as isBashInput,Lr as isEditInput,_s as isGitRepo,Ye as isProtectedBranch,Mr as isReadInput,Ar as isWriteInput,ca as listHooks,s as logHook,ls as logPermissionFeedback,gs as normalizeCommand,ns as normalizeLineEndings,is as outputAllowWithContext,rs as outputBlock,as as outputDeny,cs as outputError,We as outputPromptContext,ps as outputPromptContextBudgeted,os as outputSilentAllow,a as outputSilentSuccess,ft as outputWarning,_ as outputWithContext,ss as outputWithNotification,us as outputWithUpdatedInput,ms as readHookInput,Be as shouldLog,xs as validateBranchName};
//# sourceMappingURL=lifecycle.mjs.map
