// OrchestKit Hooks - lifecycle bundle
// Generated: 2026-02-20T12:07:13.873Z

function No(t){return typeof t.command=="string"}function Ao(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function Fo(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function Lo(t){return typeof t.file_path=="string"&&t.content===void 0}import{existsSync as Et,statSync as rn,renameSync as on,mkdirSync as sn,readSync as cn}from"node:fs";import{appendFileSync as De,mkdirSync as Ne}from"node:fs";import{dirname as Ae}from"node:path";var L=[],q=!1,_t=!1;function S(t,e){L.push({filePath:t,content:e}),Fe()}function Y(){if(q||L.length===0)return;q=!0;let t=new Map;for(let e of L){let n=t.get(e.filePath);n?n.push(e.content):t.set(e.filePath,[e.content])}for(let[e,n]of t)try{Ne(Ae(e),{recursive:!0}),De(e,n.join(""))}catch{}L.length=0,q=!1}function Fe(){_t||(_t=!0,process.on("exit",Y),process.on("SIGTERM",()=>{Y(),process.exit(0)}),process.on("SIGINT",()=>{Y(),process.exit(0)}))}import{execSync as an}from"node:child_process";import kt from"node:os";import H from"node:path";function k(){return process.env.HOME||process.env.USERPROFILE||kt.homedir()}function Le(){return kt.tmpdir()}function X(){return process.env.CLAUDE_PROJECT_DIR||"."}function vt(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function xt(){return process.env.CLAUDE_PLUGIN_ROOT?H.join(k(),".claude","logs","ork"):H.join(X(),".claude","logs")}function v(){return process.env.CLAUDE_METRICS_FILE||H.join(Le(),"claude-session-metrics.json")}var Z=H.join,zo=H.sep;import{execSync as Me}from"node:child_process";import{createHash as Ue}from"node:crypto";import{existsSync as bt,readFileSync as Je,writeFileSync as Be,mkdirSync as Ke}from"node:fs";import{join as Q,basename as We}from"node:path";var ze=20,Ve=15,Ge=/[^a-z0-9-]/g;function qe(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=We(e);return Ct(n,ze)}function Ye(t){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=Me("git branch --show-current",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),r=Ct(n||"detached",Ve);return process.env.ORCHESTKIT_SESSION_BRANCH=r,r}catch{return"nobranch"}}function Xe(t){let e=t||new Date,n=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${n}${r}`}function Ze(t){let e=t||new Date,n=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0");return`${n}${r}`}function Qe(){let t=`${process.pid}-${Date.now()}-${Math.random()}`;return Ue("sha256").update(t).digest("hex").slice(0,4)}function Ct(t,e){return t.toLowerCase().replace(Ge,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,e)}function tn(t,e){let n=qe(t),r=Ye(t),o=Xe(e),i=Ze(e),c=Qe();return`${n}-${r}-${o}-${i}-${c}`}function en(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=Q(e,".instance","session-id.json");if(bt(n))try{let r=JSON.parse(Je(n,"utf8"));if(r.session_id&&r.created_at){let o=Date.now()-new Date(r.created_at).getTime(),i=1440*60*1e3;if(o<i)return r.session_id}}catch{}}function nn(t,e){let n=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),r=Q(n,".instance"),o=Q(r,"session-id.json");try{bt(r)||Ke(r,{recursive:!0}),Be(o,JSON.stringify({session_id:t,created_at:new Date().toISOString()},null,2))}catch{}}function It(t){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let e=en(t);if(e)return e;let n=tn(t);return nn(n,t),n}function P(){return xt()}function p(){return X()}function tt(){return vt()}function os(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${tt()}/.claude/.instance_env`}function h(){return It()}function wt(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let e=an("git branch --show-current",{cwd:t||p(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function un(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function ss(t){return t.replace(/\r\n/g,`
`)}function ln(t){let e=["debug","info","warn","error"];return e.indexOf(t)>=e.indexOf(un())}function a(){return{continue:!0,suppressOutput:!0}}function is(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function cs(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function _(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function pn(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function as(t,e){let n={continue:!0,suppressOutput:!0};return t&&(n.systemMessage=t),e&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:e}),n}function us(t,e){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?n.systemMessage=e:n.suppressOutput=!0,n}function ls(t){return{continue:!0,systemMessage:t}}function Tt(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function ps(t){process.stderr.write(`\u26A0 ${t}
`),process.exit(2)}function ds(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}function ms(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:t}}}var dn=200*1024,mn=100*1024;function Rt(t,e){if(Et(t))try{if(rn(t).size>e){let r=`${t}.old.${Date.now()}`;on(t,r)}}catch{}}function $t(t){Et(t)||sn(t,{recursive:!0})}function s(t,e,n="debug"){if(!ln(n))return;let r=P(),o=`${r}/hooks.log`;try{$t(r),Rt(o,dn);let i=new Date().toISOString().replace("T"," ").slice(0,19);S(o,`[${i}] [${n.toUpperCase()}] [${t}] ${e}
`)}catch{}}function gs(t,e,n){let r=P(),o=`${r}/permission-feedback.log`;try{$t(r),Rt(o,mn);let i=new Date().toISOString(),c=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",l=n?.session_id||h();S(o,`${i} | ${t} | ${e} | tool=${c} | session=${l}
`)}catch{}}function gn(t){if(!t)return 0;let r=(t.match(/[{};()=><]/g)||[]).length/t.length>.03?2.8:3.5;return Math.ceil(t.length/r)}function fs(t,e,n,r,o){let i=gn(t);return r?.isOverBudget(n)?(s(e,`Budget exhausted for ${n}, suppressing ${i}t`),a()):(o&&o.trackTokenUsage(e,n,i),pn(t))}function ys(){try{let t=[],n=Buffer.allocUnsafe(256),r,o=0;for(;;)try{if(r=cn(o,n,0,256,null),r===0)break;t.push(Buffer.from(n.subarray(0,r)))}catch{break}let i=Buffer.concat(t).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:h(),tool_input:{}}}catch{return{tool_name:"",session_id:h(),tool_input:{}}}}function hs(t,e){let n=e.replace(/^\./,"").split("."),r=t;for(let o of n){if(r==null)return;r=r[o]}return r}function Ss(t,...e){return t.split(`
`).some(n=>e.every(r=>n.includes(r)))}function et(t,...e){return t.split(`
`).some(n=>{let r=n.toLowerCase();return e.every(o=>r.includes(o.toLowerCase()))})}function _s(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function ks(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}import{execSync as x}from"node:child_process";function fn(t){let e=t||p();try{return x("git branch --show-current",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return"unknown"}}function yn(t){let e=t||fn();return["dev","main","master"].includes(e)}function Cs(t){let e=t||p();try{return x("git rev-parse --show-toplevel",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return e}}function Is(t){let e=t||p();try{return x("git rev-parse --git-dir",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),!0}catch{return!1}}function hn(t){let e=t||p();try{return x("git status --short",{cwd:e,encoding:"utf8",timeout:1e4,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function Es(t){return hn(t).length>0}function ws(t){let e=t||p();try{return x("git rev-parse --verify main",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"main"}catch{try{return x("git rev-parse --verify master",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"master"}catch{return"main"}}}function Sn(t){let e=[/issue\/(\d+)/i,/feature\/(\d+)/i,/fix\/(\d+)/i,/bug\/(\d+)/i,/feat\/(\d+)/i,/^(\d+)-/,/-(\d+)$/,/#(\d+)/];for(let n of e){let r=t.match(n);if(r)return parseInt(r[1],10)}return null}function _n(t){let e=t||p();try{let n=x("git diff --cached --name-only",{cwd:e,encoding:"utf8",timeout:1e4,stdio:["pipe","pipe","pipe"]}).trim();return n?n.split(`
`).filter(r=>r.trim()):[]}catch{return[]}}function Ts(t){let e=_n(t),n=new Set,r=new Set,o=!1,i=!1,c=!1,l=!1;for(let u of e){let d=u.split("/");d.length>1&&(n.add(d[0]),d.length>2&&n.add(`${d[0]}/${d[1]}`));let g=u.split(".").pop()||"";r.add(g),/\.(test|spec)\.\w+$/.test(u)||/^tests?\//.test(u)||/__tests__\//.test(u)?o=!0:/\.(md|mdx|txt|rst)$/.test(u)||/^docs?\//.test(u)||u==="README.md"?c=!0:/\.(json|ya?ml|toml|ini|cfg|env)$/.test(u)||/config/i.test(u)||u==="package.json"||u==="tsconfig.json"?i=!0:l=!0}return{files:e,directories:n,extensions:r,hasTests:o,hasConfig:i,hasDocs:c,hasSource:l}}function Rs(t){if(yn(t))return null;let e=["issue/","feature/","fix/","bug/","feat/","chore/","docs/","refactor/","test/","ci/","perf/","style/","release/","hotfix/"];return e.some(r=>t.startsWith(r))?t.startsWith("issue/")&&!Sn(t)?"issue/ branches should include an issue number (e.g., issue/123-description)":null:`Branch name should start with a valid prefix: ${e.join(", ")}`}import{existsSync as Ht,readFileSync as Pt}from"node:fs";function kn(t){let e=`${t}/.claude/feedback/consent-status.json`;if(!Ht(e))return{consented:!1,asked:!1};try{let n=JSON.parse(Pt(e,"utf-8"));return{consented:n.consented===!0,asked:n.asked===!0}}catch{return{consented:!1,asked:!1}}}function vn(t){let e=`${t}/.claude/feedback/consent-log.json`;if(!Ht(e))return null;try{let n=JSON.parse(Pt(e,"utf-8"));if(n.events&&n.events.length>0)return n.events[n.events.length-1]}catch{}return null}function xn(t){try{let e=new Date(t);return Math.floor((new Date().getTime()-e.getTime())/(1e3*60*60*24))>=30}catch{return!1}}function jt(t){let e=t.project_dir||p(),n=kn(e);if(n.consented)return s("analytics-consent-check","User has consented to analytics"),a();if(n.asked){let r=vn(e);return r&&(r.action==="declined"||r.action==="revoked")&&xn(r.timestamp)?(s("analytics-consent-check","Showing 30-day reminder"),{continue:!0,systemMessage:"Reminder: Anonymous analytics help improve OrchestKit. Enable with /ork:feedback opt-in"}):(s("analytics-consent-check","User recently declined, not prompting"),a())}return s("analytics-consent-check","First time user, showing brief notice"),{continue:!0,systemMessage:"OrchestKit collects local usage metrics. Share anonymously with /ork:feedback opt-in"}}import{existsSync as M,readFileSync as nt,writeFileSync as bn,statSync as Cn,mkdirSync as In}from"node:fs";var En=1*1024*1024;function wn(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Tn(t){let e=`${t}/.claude/feedback/sync-config.json`;if(!M(e))return!0;try{return JSON.parse(nt(e,"utf-8")).sync_enabled!==!1}catch{return!0}}function Ot(t){if(!M(t))return!0;try{let e=Cn(t);return e.size>En?(s("pattern-sync-pull",`WARN: Skipping - file too large: ${t} (${e.size} bytes)`),!1):!0}catch{return!0}}function Rn(t){let n=`${k()}/.claude/global-patterns.json`,r=`${t}/.claude/feedback/learned-patterns.json`;if(!M(n)){s("pattern-sync-pull","No global patterns file found");return}try{let i=JSON.parse(nt(n,"utf-8")).patterns||[];if(i.length===0){s("pattern-sync-pull","No global patterns to pull");return}let c={version:"1.0",patterns:[]};if(M(r))try{c=JSON.parse(nt(r,"utf-8"))}catch{}let l=c.patterns||[],u=new Set(l.map(m=>m.text)),d=i.filter(m=>!u.has(m.text));if(d.length===0){s("pattern-sync-pull","All global patterns already in project");return}let g=[...l,...d];c.patterns=g,In(`${t}/.claude/feedback`,{recursive:!0}),bn(r,JSON.stringify(c,null,2)),s("pattern-sync-pull",`Pulled ${d.length} new patterns from global`)}catch(o){s("pattern-sync-pull",`Failed to pull global patterns: ${o}`)}}function U(t){if(wn())return s("pattern-sync-pull","Skipping pattern sync (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();let e=t.project_dir||p();if(!Tn(e))return s("pattern-sync-pull","Global sync disabled, skipping pull"),a();let n=`${k()}/.claude/global-patterns.json`,r=`${e}/.claude/feedback/learned-patterns.json`;return!Ot(n)||!Ot(r)?(s("pattern-sync-pull","Skipping pattern sync due to large files"),a()):(s("pattern-sync-pull","Pulling global patterns..."),Rn(e),s("pattern-sync-pull","Global patterns pulled successfully"),a())}import{existsSync as rt,readFileSync as ot,writeFileSync as $n,mkdirSync as Hn}from"node:fs";function Pn(t){let e=`${t}/.claude/feedback/sync-config.json`;if(!rt(e))return!0;try{return JSON.parse(ot(e,"utf-8")).sync_enabled!==!1}catch{return!0}}function jn(t){let e=`${t}/.claude/feedback/learned-patterns.json`,n=k(),r=`${n}/.claude/global-patterns.json`;if(!rt(e)){s("pattern-sync-push","No project patterns file found");return}try{let i=JSON.parse(ot(e,"utf-8")).patterns||[];if(i.length===0){s("pattern-sync-push","No project patterns to push");return}let c={version:"1.0",patterns:[],updated:""};if(rt(r))try{c=JSON.parse(ot(r,"utf-8"))}catch{}let l=c.patterns||[],u=new Set(l.map(m=>m.text)),d=i.filter(m=>!u.has(m.text));if(d.length===0){s("pattern-sync-push","All project patterns already in global");return}let g=[...l,...d];c.patterns=g,c.updated=new Date().toISOString(),Hn(`${n}/.claude`,{recursive:!0}),$n(r,JSON.stringify(c,null,2)),s("pattern-sync-push",`Pushed ${d.length} new patterns to global`)}catch(o){s("pattern-sync-push",`Failed to push project patterns: ${o}`)}}function Dt(t){let e=t.project_dir||p();return Pn(e)?(s("pattern-sync-push","Pushing project patterns to global..."),jn(e),a()):(s("pattern-sync-push","Global sync disabled, skipping push"),a())}import{execSync as Nt}from"node:child_process";var On=new Set(["main","master","dev","develop"]);function At(t){s("pr-status-enricher","Checking for open PR on current branch");let e=t.project_dir||p(),n;try{n=wt(e)}catch{return s("pr-status-enricher","Could not determine branch, skipping"),a()}if(!n||On.has(n))return s("pr-status-enricher",`Branch "${n}" skipped for PR detection`),a();try{let r=Nt("gh pr view --json state,reviewDecision,url,title,isDraft",{cwd:e,timeout:1e4,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim(),o=JSON.parse(r);if(!o.url)return s("pr-status-enricher","No PR found for current branch"),a();process.env.ORCHESTKIT_PR_URL=o.url,process.env.ORCHESTKIT_PR_STATE=o.state;let i=0;try{let d=Nt("gh pr view --json reviewThreads",{cwd:e,timeout:1e4,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim();i=(JSON.parse(d).reviewThreads||[]).filter(m=>!m.isResolved).length}catch{}let c=o.isDraft?" (DRAFT)":"",l=o.reviewDecision?` | Review: ${o.reviewDecision}`:"",u=i>0?` | ${i} unresolved`:"";s("pr-status-enricher",`PR: ${o.title}${c} [${o.state}${l}${u}]`),s("pr-status-enricher",`URL: ${o.url}`)}catch{s("pr-status-enricher","No PR found or gh CLI unavailable")}return a()}import{existsSync as D,readFileSync as Vn,writeFileSync as Gn,mkdirSync as qn,readdirSync as Bt,unlinkSync as Kt,copyFileSync as Yn}from"node:fs";import{join as Jt}from"node:path";import{homedir as Xn}from"node:os";import{existsSync as j,readFileSync as Dn,readdirSync as Nn,statSync as Ft,rmSync as An}from"node:fs";import{join as I}from"node:path";function O(){return process.env.CLAUDE_CODE_TEAM_NAME||null}function Lt(){let t=O();if(!t)return[];let e=process.env.HOME||process.env.USERPROFILE||"";if(!e)return[];let n=I(e,".claude","teams",t,"config.json");if(!j(n))return[];try{let o=JSON.parse(Dn(n,"utf-8")).members;return Array.isArray(o)?o.map(i=>({name:i.name||"unknown",agentType:i.agentType||"unknown"})):[]}catch{return[]}}function Mt(){let t=process.env.HOME||process.env.USERPROFILE||"";if(!t)return[];let e=I(t,".claude","teams");if(!j(e))return[];try{return Nn(e).filter(n=>{try{return Ft(I(e,n)).isDirectory()}catch{return!1}})}catch{return[]}}function Ut(t,e=4){let n=process.env.HOME||process.env.USERPROFILE||"";if(!n)return!1;let r=I(n,".claude","teams",t);if(!j(r))return!1;let o=I(r,"config.json");if(!j(o))return!0;try{return Date.now()-Ft(r).mtimeMs>e*36e5}catch{return!0}}function J(t){let e=process.env.HOME||process.env.USERPROFILE||"";if(!e)return!1;let n=!0;for(let r of["teams","tasks"]){let o=I(e,".claude",r,t);if(j(o))try{An(o,{recursive:!0,force:!0})}catch{n=!1}}return n}import{mkdirSync as Fn,statSync as Ln,renameSync as Mn}from"node:fs";import{createHash as Un}from"node:crypto";function Jn(){return Z(k(),".claude","analytics")}function E(t){return Un("sha256").update(t).digest("hex").slice(0,12)}function w(){let t=process.env.CLAUDE_CODE_TEAM_NAME;return t?{team:t}:void 0}function Bn(t,e=10485760){try{if(Ln(t).size>e){let r=new Date().toISOString().slice(0,7),o=t.replace(/\.jsonl$/,`.${r}.jsonl`);Mn(t,o)}}catch{}}function Kn(){return!!(process.env.VITEST||process.env.JEST_WORKER_ID)}function T(t,e){if(!Kn())try{let n=Jn();Fn(n,{recursive:!0});let r=Z(n,t);Bn(r),S(r,`${JSON.stringify(e)}
`)}catch{}}import{existsSync as Wn,readFileSync as zn}from"node:fs";function st(){let t=v();if(!Wn(t))return 0;try{let n=JSON.parse(zn(t,"utf-8")).tools||{};return Object.values(n).reduce((r,o)=>r+o,0)}catch{return 0}}function Zn(t,e){if(!D(t))return;let n=st();if(n<=5){s("session-cleanup",`Session had only ${n} tool calls, not archiving`);return}try{qn(e,{recursive:!0});let o=`session-${new Date().toISOString().replace(/[:.]/g,"-")}.json`,i=`${e}/${o}`;Yn(t,i),s("session-cleanup",`Archived session metrics to ${o}`)}catch(r){s("session-cleanup",`Failed to archive metrics: ${r}`)}}function Qn(t,e=20){if(D(t))try{let n=Bt(t).filter(o=>o.startsWith("session-")&&o.endsWith(".json")).sort().reverse();if(n.length<=e)return;let r=n.slice(e);for(let o of r)try{Kt(`${t}/${o}`),s("session-cleanup",`Deleted old archive: ${o}`)}catch{}}catch(n){s("session-cleanup",`Failed to cleanup old archives: ${n}`)}}function tr(t){if(!D(t))return;let e=["hooks.log.old*","audit.log.old*"];for(let n of e)try{let r=n.replace("*",""),o=Bt(t).filter(c=>c.startsWith(r)).sort().reverse();if(o.length<=5)continue;let i=o.slice(5);for(let c of i)try{Kt(`${t}/${c}`)}catch{}}catch{}}function er(t){if(!t||typeof t!="string"||t==="No prompt")return t||"";let e=t;if(e.includes("<task-notification>")){let i=e.match(/<summary>(.*?)<\/summary>/s);return i?i[1].trim():"(background task)"}let n=e.match(/<command-args>(.*?)(?:<\/command-args>|$)/s),r=e.match(/<command-name>(.*?)<\/command-name>/);if(r||n){let i=[];if(r&&i.push(r[1].trim()),n){let c=n[1].trim();c&&i.push(c)}if(i.length>0)return i.join(" ")}e=e.replace(/<[^>]+>/g," "),e=e.replace(/[\u2500-\u259f]/g,"");let o=e.indexOf("\u276F");return o!==-1?e=e.slice(o+1):(e=e.replace(/Claude Code v[\d.]+/g,""),e=e.replace(/Opus [\d.]+\s*[·.]\s*Claude Max/g,"")),e=e.replace(/[✻⏺⎿]\s*/g,""),e=e.replace(/Conversation compacted[^)]*\)/g,""),e=e.replace(/Referenced file [^\s]+/g,""),e=e.replace(/\s+(Bash|Read|Write|Edit|Glob|Grep|Task|Skill)\(.*$/s,""),e=e.replace(/~\/[\w/._-]+/g,""),e=e.replace(/[…]+/g,""),e=e.replace(/\s+/g," ").trim(),e}function nr(t){let e=Xn(),n=Jt(e,".claude","projects");if(!D(n))return;let r=t.replace(/\//g,"-"),o=Jt(n,r,"sessions-index.json");if(!D(o)){s("session-cleanup","No sessions-index.json found");return}try{let i=JSON.parse(Vn(o,"utf-8")),c=0;for(let l of i.entries){if(!l.firstPrompt||l.firstPrompt==="No prompt")continue;let u=er(l.firstPrompt);(!u||u.length<10)&&(u=l.summary||l.firstPrompt),u!==l.firstPrompt&&(l.firstPrompt=u,c++)}c>0&&(Gn(o,JSON.stringify(i,null,4)),s("session-cleanup",`Sanitized ${c} session firstPrompt entries`))}catch(i){s("session-cleanup",`Failed to sanitize sessions index: ${i}`,"warn")}}function Wt(t){s("session-cleanup","Session cleanup starting");let e=t.project_dir||p(),n=v(),r=`${e}/.claude/logs/sessions`,o=`${e}/.claude/logs`;nr(e),Zn(n,r),Qn(r,20),tr(o);let i=process.env.CLAUDE_CODE_TEAM_NAME;if(i){let l=J(i);s("session-cleanup",l?`Cleaned team "${i}" directories`:`Warning: partial cleanup for team "${i}"`)}let c=st();if(c>0){let l=t.last_assistant_message?.length??null;T("session-summary.jsonl",{ts:new Date().toISOString(),pid:E(e),total_tools:c,added_dirs_count:(t.added_dirs??[]).length,...l!==null&&{last_msg_len:l},...w()})}return s("session-cleanup","Session cleanup complete"),a()}import{existsSync as it,readFileSync as zt}from"node:fs";function N(t){if(!it(t))return!1;try{return JSON.parse(zt(t,"utf-8")),!0}catch{return!1}}function Vt(t){s("session-context-loader","Session starting - loading context (Protocol 2.0)");let e=t.project_dir||p(),n=0,r=process.env.AGENT_TYPE||"",o=`${e}/.claude/context/session/state.json`,i=`${e}/.claude/context/identity.json`,c=`${e}/.claude/context/knowledge/index.json`;N(o)&&(s("session-context-loader","Session state loaded"),n++),N(i)&&(s("session-context-loader","Identity loaded"),n++),N(c)&&(s("session-context-loader","Knowledge index available"),n++);let l=`${e}/docs/CURRENT_STATUS.md`;if(it(l)&&s("session-context-loader","Current status document exists"),r){s("session-context-loader",`Agent-type aware initialization: ${r}`);let d=`${e}/.claude/agents/${r}.md`;it(d)&&(s("session-context-loader",`Agent configuration found: ${d}`),n++)}if(t.added_dirs&&t.added_dirs.length>0)for(let d of t.added_dirs){let g=`${d}/.claude/context/session/state.json`;N(g)&&(s("session-context-loader",`Additional context from added dir: ${d}`),n++)}let u=`${e}/.claude/context/session/compaction-manifest.json`;if(N(u))try{let d=JSON.parse(zt(u,"utf-8"));s("session-context-loader",`Compaction manifest loaded: session=${d.sessionId}, decisions=${(d.keyDecisions||[]).length}, files=${(d.filesTouched||[]).length}`),process.env.ORCHESTKIT_LAST_SESSION=d.sessionId||"",process.env.ORCHESTKIT_LAST_DECISIONS=JSON.stringify(d.keyDecisions||[]),n++}catch(d){s("session-context-loader",`Error loading compaction manifest: ${d}`)}return n>0&&(r?s("session-context-loader",`Session context loaded (Protocol 2.0) - Agent: ${r}`):s("session-context-loader","Session context loaded (Protocol 2.0)")),a()}import{existsSync as rr,readFileSync as or,writeFileSync as Gt,mkdirSync as sr}from"node:fs";import{execSync as ir}from"node:child_process";function cr(t){try{return ir("git branch --show-current",{cwd:t,encoding:"utf-8",timeout:500,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function B(t){s("session-env-setup","Setting up session environment");let e=t.project_dir||p(),n=t.session_id||h(),r=v();try{sr(`${e}/.claude/logs`,{recursive:!0})}catch{}let o=process.env.AGENT_TYPE||"";!o&&t.agent_type&&(o=t.agent_type);let i={session_id:n,started_at:new Date().toISOString(),agent_type:o,tools:{},errors:0,warnings:0};try{Gt(r,JSON.stringify(i,null,2)),s("session-env-setup","Initialized session metrics")}catch(u){s("session-env-setup",`Failed to initialize metrics: ${u}`)}let c=`${e}/.claude/context/session/state.json`;if(rr(c)&&o)try{let u=JSON.parse(or(c,"utf-8"));u.agent_type=o,u.session_id=n,u.last_activity=new Date().toISOString(),Gt(c,JSON.stringify(u,null,2)),s("session-env-setup",`Updated session state with agent_type: ${o}`)}catch(u){s("session-env-setup",`Failed to update session state: ${u}`)}let l=cr(e);return l&&s("session-env-setup",`Git branch: ${l}`),o&&s("session-env-setup",`Agent type: ${o}`),a()}import{existsSync as te,mkdirSync as Sr,readFileSync as _r,writeFileSync as kr}from"node:fs";import{existsSync as ar,readFileSync as ur,writeFileSync as ki,mkdirSync as vi}from"node:fs";import{execSync as qt}from"node:child_process";import{createHash as lr}from"node:crypto";import*as Yt from"node:os";var pr=".claude/.user_identity.json",dr="orchestkit-user-identity-v1";var f=null;function K(t){return lr("sha256").update(t+dr).digest("hex").slice(0,32)}function mr(){try{return Yt.hostname()}catch{return"unknown-machine"}}function gr(t){let e=`${t}/${pr}`;if(!ar(e))return null;try{let n=ur(e,"utf8");return JSON.parse(n)}catch(n){return s("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function fr(t){let e={};try{e.email=qt("git config user.email",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{e.name=qt("git config user.name",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return e}function yr(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function hr(t){if(f)return f;let e=t||p(),n=mr(),r=gr(e);if(r?.user_id)return f={user_id:r.user_id,display_name:r.display_name||r.user_id,team_id:r.team_id,machine_id:n,source:"config",anonymous_id:K(r.user_id),email:r.user_id.includes("@")?r.user_id:void 0},s("user-identity",`Resolved from config: ${f.anonymous_id}`,"debug"),f;let o=fr(e);if(o.email)return f={user_id:o.email,display_name:o.name||o.email.split("@")[0],team_id:r?.team_id,machine_id:n,source:"git",anonymous_id:K(o.email),email:o.email},s("user-identity",`Resolved from git: ${f.anonymous_id}`,"debug"),f;let i=yr();if(i.username){let l=`${i.username}@${n}`;return f={user_id:l,display_name:i.username,team_id:r?.team_id,machine_id:n,source:"env",anonymous_id:K(l)},s("user-identity",`Resolved from env: ${f.anonymous_id}`,"debug"),f}let c=K(n+process.pid);return f={user_id:`anon-${c.slice(0,8)}`,display_name:"Anonymous",team_id:r?.team_id,machine_id:n,source:"anonymous",anonymous_id:c},s("user-identity",`Resolved as anonymous: ${f.anonymous_id}`,"debug"),f}function Xt(){let t=hr();return{session_id:h(),user_id:t.user_id,anonymous_id:t.anonymous_id,team_id:t.team_id,machine_id:t.machine_id,identity_source:t.source,timestamp:new Date().toISOString()}}var vr=/^[a-zA-Z0-9_-]{1,128}$/;function xr(t){return vr.test(t)}function ut(t,e){let n=t||h(),r=e||p();if(!xr(n))throw new Error("Invalid session ID format");return`${r}/.claude/memory/sessions/${n}`}function br(t,e){return`${ut(t,e)}/events.jsonl`}function ee(t,e){let n=ut(t,e);te(n)||Sr(n,{recursive:!0})}var A=0,Zt=!1,ct=!1,Qt=0,Cr=5e3;function ne(t,e){return`${ut(t,e)}/counter.json`}function Ir(t,e){if(!Zt){Zt=!0;try{let n=ne(t,e);if(te(n)){let r=JSON.parse(_r(n,"utf8"));typeof r.counter=="number"&&r.counter>0&&(A=r.counter,s("session-tracker",`Loaded event counter: ${A}`,"debug"))}}catch{}}}function Er(t,e){if(!ct)return;let n=Date.now();if(!(n-Qt<Cr))try{ee(t,e);let r=ne(t,e);kr(r,JSON.stringify({counter:A,updated_at:new Date().toISOString()})),ct=!1,Qt=n}catch{}}function wr(){return Ir(),A++,ct=!0,Er(),`evt-${Date.now()}-${A}`}function Tr(t,e,n={}){try{let r={event_id:wr(),event_type:t,identity:Xt(),payload:{name:e,input:at(n.input),output:at(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?oe(n.context,500):void 0,confidence:n.confidence}};ee();let o=br();S(o,`${JSON.stringify(r)}
`),s("session-tracker",`Tracked ${t}: ${e}`,"debug")}catch(r){s("session-tracker",`Failed to track event: ${r}`,"warn")}}function Rr(t){return t>=5&&t<12?"morning":t>=12&&t<17?"afternoon":t>=17&&t<21?"evening":"night"}function re(t){let e=new Date,n={project_dir:t?.project_dir,git_branch:t?.git_branch,time_of_day:t?.time_of_day||Rr(e.getHours()),started_at:e.toISOString()};Tr("session_start","session",{success:!0,input:n})}function oe(t,e){return t.length<=e?t:`${t.slice(0,e-3)}...`}function at(t){if(!t)return;let e={},n=["password","secret","token","key","credential","auth"];for(let[r,o]of Object.entries(t)){if(n.some(i=>r.toLowerCase().includes(i))){e[r]="[REDACTED]";continue}if(typeof o=="string"&&o.length>500){e[r]=oe(o,500);continue}if(typeof o=="object"&&o!==null&&!Array.isArray(o)){e[r]=at(o);continue}e[r]=o}return e}import{execSync as $r}from"node:child_process";function Hr(t){try{return $r("git rev-parse --abbrev-ref HEAD",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()||void 0}catch{return}}function W(t){try{let e=t.project_dir||p(),n=Hr(e);return re({project_dir:e,git_branch:n,added_dirs_count:(t.added_dirs??[]).length}),s("session-tracking",`Tracked session start: branch=${n||"unknown"}`,"debug"),a()}catch(e){return s("session-tracking",`Error: ${e}`,"warn"),a()}}import{existsSync as Pr,readFileSync as jr}from"node:fs";function se(t){s("session-metrics-summary","Session ending - generating summary");let e=v();if(!Pr(e))return s("session-metrics-summary","No metrics file found"),a();try{let n=JSON.parse(jr(e,"utf-8")),r=n.tools||{},o=n.errors||0,i=Object.values(r).reduce((l,u)=>l+u,0),c=Object.entries(r).sort(([,l],[,u])=>u-l).slice(0,3).map(([l,u])=>`${l}: ${u}`).join(", ");s("session-metrics-summary",`Session stats: ${i} tool calls, ${o} errors`),i>0&&s("session-metrics-summary",`Top tools: ${c}`)}catch(n){s("session-metrics-summary",`Failed to read metrics: ${n}`)}return a()}import{existsSync as b,readFileSync as pt,writeFileSync as Or,mkdirSync as Dr}from"node:fs";var Nr=[{package:"lodash",pattern:"<4.17.21",severity:"high",cve:"CVE-2021-23337",description:"Prototype pollution"},{package:"minimist",pattern:"<1.2.6",severity:"critical",cve:"CVE-2021-44906",description:"Prototype pollution"},{package:"node-fetch",pattern:"<2.6.7",severity:"high",cve:"CVE-2022-0235",description:"Information exposure"},{package:"axios",pattern:"<0.21.2",severity:"high",cve:"CVE-2021-3749",description:"ReDoS vulnerability"},{package:"jsonwebtoken",pattern:"<9.0.0",severity:"critical",cve:"CVE-2022-23529",description:"Insecure token verification"},{package:"express",pattern:"<4.17.3",severity:"medium",cve:"CVE-2022-24999",description:"Open redirect"},{package:"tar",pattern:"<6.1.11",severity:"critical",cve:"CVE-2021-37701",description:"Arbitrary file overwrite"},{package:"path-parse",pattern:"<1.0.7",severity:"medium",cve:"CVE-2021-23343",description:"ReDoS vulnerability"},{package:"django",pattern:"<3.2.14",severity:"high",cve:"CVE-2022-34265",description:"SQL injection"},{package:"flask",pattern:"<2.0.2",severity:"medium",cve:"CVE-2021-28091",description:"Path traversal"},{package:"requests",pattern:"<2.28.0",severity:"medium",cve:"CVE-2023-32681",description:"Information disclosure"},{package:"urllib3",pattern:"<1.26.5",severity:"high",cve:"CVE-2021-33503",description:"ReDoS vulnerability"},{package:"pillow",pattern:"<9.0.0",severity:"high",cve:"CVE-2022-22817",description:"Buffer overflow"},{package:"pyyaml",pattern:"<5.4",severity:"critical",cve:"CVE-2020-14343",description:"Arbitrary code execution"},{package:"jinja2",pattern:"<3.0.3",severity:"medium",cve:"CVE-2020-28493",description:"XSS vulnerability"},{package:"sqlalchemy",pattern:"<1.4.46",severity:"medium",cve:"CVE-2023-30533",description:"SQL injection"}],Ar=24;function Fr(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Lr(t,e){let n=t.split(".").map(o=>parseInt(o,10)||0),r=e.split(".").map(o=>parseInt(o,10)||0);for(let o=0;o<Math.max(n.length,r.length);o++){let i=n[o]||0,c=r[o]||0;if(i<c)return!0;if(i>c)return!1}return!1}function Mr(t,e){let n=e.charAt(0),r=e.substring(1);return n==="<"?Lr(t,r):n==="="?t===r:!1}function Ur(t){return t.replace(/^[^~>=<]/,"").replace(/,.*$/,"").trim()}function ie(t,e){let n=Ur(e),r=t.toLowerCase();for(let o of Nr)if(r===o.package&&Mr(n,o.pattern))return o;return null}function Jr(t){if(!b(t))return null;try{let e=JSON.parse(pt(t,"utf-8"));if((Date.now()-e.timestamp)/(1e3*60*60)<Ar)return e.warnings}catch{}return null}function lt(t,e){try{Dr(t.replace(/\/[^/]+$/,""),{recursive:!0});let n={warnings:e,timestamp:Date.now()};Or(t,JSON.stringify(n,null,2))}catch{}}function Br(t){let e=0,n=0,r="";if(!b(t))return{criticalCount:e,highCount:n,warnings:r};try{let o=JSON.parse(pt(t,"utf-8")),i={...o.dependencies,...o.devDependencies};for(let[c,l]of Object.entries(i)){let u=ie(c,l);u&&(u.severity==="critical"&&e++,u.severity==="high"&&n++,r+=`
- ${c}@${l}: ${u.description} (${u.cve}, ${u.severity}) - upgrade to ${u.pattern}`)}}catch{}return{criticalCount:e,highCount:n,warnings:r}}function Kr(t){let e=0,n=0,r="";if(!b(t))return{criticalCount:e,highCount:n,warnings:r};try{let i=pt(t,"utf-8").split(`
`);for(let c of i){let l=c.trim();if(!l||l.startsWith("#"))continue;let u=l.match(/^([a-zA-Z0-9_-]+)(?:==|>=|~=|!=|<|>)\s*([0-9.]+)/);if(!u)continue;let[,d,g]=u,m=ie(d,g);m&&(m.severity==="critical"&&e++,m.severity==="high"&&n++,r+=`
- ${d}==${g}: ${m.description} (${m.cve}, ${m.severity}) - upgrade to ${m.pattern}`)}}catch{}return{criticalCount:e,highCount:n,warnings:r}}function ce(t){if(Fr())return s("dependency-version-check","Skipping dependency check (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();s("dependency-version-check","Starting dependency version check");let e=t.project_dir||p(),n=`${e}/.claude/feedback/dependency-check-cache.json`,r=b(`${e}/package.json`),o=b(`${e}/requirements.txt`),i=b(`${e}/pyproject.toml`),c=b(`${e}/go.mod`);if(!r&&!o&&!i&&!c)return s("dependency-version-check","No package files found, skipping check"),lt(n,"none"),a();let l=Jr(n);if(l!==null)return s("dependency-version-check","Using cached dependency warnings"),l!=="none"?_(`DEPENDENCY SECURITY CHECK (cached): ${l}`):a();let u=0,d=0,g="";if(r){let m=Br(`${e}/package.json`);u+=m.criticalCount,d+=m.highCount,m.warnings&&(g+=`

Node.js (package.json):${m.warnings}`)}if(o){let m=Kr(`${e}/requirements.txt`);u+=m.criticalCount,d+=m.highCount,m.warnings&&(g+=`

Python (requirements.txt):${m.warnings}`)}if(g){let m=`Found ${u} critical and ${d} high severity vulnerabilities`,y=`DEPENDENCY SECURITY CHECK: ${m}${g}

Run 'npm audit' or 'pip-audit' for full details.`;if(lt(n,y),s("dependency-version-check",m),u>0||d>0)return _(y)}else lt(n,"none"),s("dependency-version-check","No known vulnerabilities found");return a()}import{existsSync as dt,readFileSync as ue,mkdirSync as Wr}from"node:fs";import{join as R,dirname as zr}from"node:path";function ae(t){if(!dt(t))return 0;try{return ue(t,"utf8").trim().split(`
`).filter(n=>n.trim()).length}catch{return 0}}function Vr(t){if(!dt(t))return 0;try{let n=ue(t,"utf8").trim().split(`
`).filter(o=>o.trim()),r=0;for(let o of n)try{JSON.parse(o).event==="session_start"&&r++}catch{}return r}catch{return 0}}function mt(t){let e=t||p(),n=R(e,".claude","memory"),r=R(e,".claude","logs"),o=R(n,"graph-queue.jsonl"),i=R(n,"completed-flows.jsonl"),c=R(r,"analytics.jsonl");return{timestamp:new Date().toISOString(),decisions:{total:0,byCategory:{},byType:{}},queues:{graphQueueDepth:ae(o)},completedFlows:ae(i),sessionCount:Vr(c)}}function le(t,e){let n=t||p(),r=R(n,".claude","logs","memory-metrics.jsonl"),o=e||mt(n);try{let i=zr(r);dt(i)||Wr(i,{recursive:!0}),S(r,`${JSON.stringify(o)}
`),s("memory-metrics",`Metrics snapshot appended: ${o.decisions.total} decisions`,"debug")}catch(i){s("memory-metrics",`Failed to write metrics: ${i}`,"warn")}}function pe(t){s("memory-metrics-collector","Collecting memory metrics");try{let e=t.project_dir||p(),n=mt(e);le(e,n)}catch(e){s("memory-metrics-collector",`Failed to collect metrics: ${e}`,"warn")}return a()}var Gr=4;function de(t){let e=Mt();if(e.length===0)return a();let n=0;for(let r of e)Ut(r,Gr)&&(J(r)?n++:s("stale-team-cleanup",`Failed to clean team "${r}"`));return n>0&&s("stale-team-cleanup",`Cleaned ${n} stale team(s)`),a()}import{execSync as qr}from"node:child_process";import{writeFileSync as me,mkdirSync as Yr,existsSync as ye}from"node:fs";import{join as gt}from"node:path";var ge=15e3;function Xr(t){let e=[],n=/^(.+?)\((\d+),(\d+)\):\s+error\s+(TS\d+):\s+(.+)$/gm;for(let r of t.matchAll(n))e.push({file:r[1],line:parseInt(r[2],10),column:parseInt(r[3],10),code:r[4],message:r[5]});return e}function fe(t){let e=gt(p(),".claude","cache");return ye(e)||Yr(e,{recursive:!0}),gt(e,`type-errors-${t}.json`)}function Zr(t){return ye(gt(t,"tsconfig.json"))}function he(t){let e=t.project_dir||p();if(!Zr(e))return s("type-error-indexer","No tsconfig.json found, skipping"),a();let n=t.session_id||"unknown";try{qr("npx tsc --noEmit 2>&1",{cwd:e,timeout:ge,encoding:"utf-8",stdio:["pipe","pipe","pipe"]});let r={timestamp:performance.timeOrigin+performance.now(),errorCount:0,errors:[],summary:"No type errors found"};me(fe(n),JSON.stringify(r,null,2)),s("type-error-indexer","No type errors found")}catch(r){let o=r;if(o.killed)return s("type-error-indexer",`tsc timed out after ${ge}ms`,"warn"),a();let i=(o.stdout||"")+(o.stderr||""),c=Xr(i);if(c.length===0)return s("type-error-indexer","tsc failed but no parseable errors","warn"),a();let l=new Set(c.map(g=>g.file)),u=`${c.length} type error${c.length!==1?"s":""} in ${l.size} file${l.size!==1?"s":""}`,d={timestamp:performance.timeOrigin+performance.now(),errorCount:c.length,errors:c.slice(0,50),summary:u};me(fe(n),JSON.stringify(d,null,2)),s("type-error-indexer",`Cached: ${u}`)}return a()}var Se=[{name:"pattern-sync-pull",fn:U},{name:"session-env-setup",fn:B},{name:"session-tracking",fn:W},{name:"memory-metrics-collector",fn:pe},{name:"stale-team-cleanup",fn:de},{name:"type-error-indexer",fn:he}];async function _e(t){let e=await Promise.allSettled(Se.map(async r=>{try{let o=r.fn(t);return o instanceof Promise&&await o,{hook:r.name,status:"success"}}catch(o){let i=o instanceof Error?o.message:String(o);return s("session-start-dispatcher",`${r.name} failed: ${i}`),{hook:r.name,status:"error",message:i}}})),n=[];for(let r of e)r.status==="rejected"?n.push("unknown"):r.value.status==="error"&&n.push(r.value.hook);return n.length>0&&s("session-start-dispatcher",`${n.length}/${Se.length} hooks failed: ${n.join(", ")}`),a()}import{writeFileSync as Qr,existsSync as F,readFileSync as z,mkdirSync as to,readdirSync as eo}from"node:fs";import{execSync as no}from"node:child_process";import{join as C}from"node:path";function ro(){let t=P(),e=C(t,"sessions");return F(e)||to(e,{recursive:!0}),C(e,`${h()}-state.json`)}function oo(t){try{if(F(t))return JSON.parse(z(t,"utf8"))}catch{}return{}}function so(){let t=C(p(),".claude","memory");if(!F(t))return 0;try{let e=eo(t).filter(r=>r.endsWith(".jsonl")),n=0;for(let r of e)try{let o=z(C(t,r),"utf8");n+=o.trim().split(`
`).filter(Boolean).length}catch{}return n}catch{return 0}}function io(){let t=C(p(),".claude","logs","decisions.jsonl");if(!F(t))return[];try{return z(t,"utf8").trim().split(`
`).filter(Boolean).slice(-10).map(r=>{try{let o=JSON.parse(r);return o.summary||o.decision||r}catch{return r}})}catch{return[]}}function co(t){if(t.length<2)return 0;let e=[];for(let n=1;n<t.length;n++){let r=new Date(t[n-1].timestamp).getTime(),o=new Date(t[n].timestamp).getTime();o>r&&e.push(o-r)}return e.length===0?0:Math.round(e.reduce((n,r)=>n+r,0)/e.length)}function ao(){try{return no("git diff --name-only HEAD 2>/dev/null",{encoding:"utf8",timeout:3e3,cwd:p()}).trim().split(`
`).filter(Boolean).slice(0,20)}catch{return[]}}function uo(){let t=C(p(),".claude","logs","task-completions.jsonl");if(!F(t))return[];try{return z(t,"utf8").trim().split(`
`).filter(Boolean).slice(-5).map(r=>{try{let o=JSON.parse(r);return`${o.task_subject} [${o.task_status}]`}catch{return""}}).filter(Boolean)}catch{return[]}}function ke(t){try{let e=ro(),n=oo(e),r=new Date().toISOString();n.lastCompaction=r,n.compactionCount=(n.compactionCount||0)+1,n.compactionHistory||(n.compactionHistory=[]),n.compactionHistory.push({timestamp:r}),n.compactionHistory.length>10&&(n.compactionHistory=n.compactionHistory.slice(-10)),n.avgCompactionIntervalMs=co(n.compactionHistory);let o=so(),i=io();n.preservedContext={branch:process.env.ORCHESTKIT_BRANCH||process.env.GIT_BRANCH||void 0,activeFiles:ao(),activeTasks:uo(),sessionNotes:`Compaction #${n.compactionCount} at ${r}`,decisionLog:i,memoryTierSnapshot:{localEntries:o}},Qr(e,JSON.stringify(n,null,2));let c=C(P(),"compaction-history.jsonl");try{S(c,`${JSON.stringify({session:h(),timestamp:r,count:n.compactionCount,avgIntervalMs:n.avgCompactionIntervalMs,localMemoryEntries:o,decisionsPreserved:i.length})}
`)}catch{}s("pre-compact-saver",`Saved state before compaction #${n.compactionCount} (${o} memory entries, ${i.length} decisions preserved)`)}catch(e){let n=e instanceof Error?e.message:String(e);s("pre-compact-saver",`Failed to save state: ${n}`,"warn")}return a()}import{existsSync as V,readFileSync as yt,writeFileSync as lo,readdirSync as po,statSync as xe,mkdirSync as mo}from"node:fs";import{join as G,dirname as go}from"node:path";var be="1.0";function fo(t){return`${t}/.claude/cache/prefill-scan.json`}function yo(t){if(!V(t))return[];try{return po(t).filter(e=>{try{return xe(G(t,e)).isDirectory()}catch{return!1}})}catch{return[]}}function ho(t,e,n){try{if(!V(t))return!1;let r=JSON.parse(yt(t,"utf-8"));if(r.version!==be)return!1;let{scannedAt:o}=r;for(let i of n){let c=G(e,i,"SKILL.md");if(V(c)&&xe(c).mtimeMs>o)return!1}return!0}catch{return!1}}function So(t){try{return JSON.parse(yt(t,"utf-8"))}catch{return null}}function ve(t,e){try{mo(go(t),{recursive:!0});let n={version:be,scannedAt:Date.now(),results:{warnings:e,count:e.length}};lo(t,JSON.stringify(n,null,2),"utf-8")}catch{}}var _o=[/\bprefill\b/i,/\bpre-fill\b/i,t=>et(t,"assistant","content",":"),/\bprefilled?\s+(assistant|response|message)/i,t=>et(t,"role","assistant","content")],ko=[/["']output_format["']\s*:/,/output_format\s*=\s*["']/,/\boutput_format\b.*\b(json|text|xml)\b/i];function vo(t){return _o.some(e=>typeof e=="function"?e(t):e.test(t))}function xo(t){return/elevenlabs|mp3_\d+/i.test(t)?!1:ko.some(e=>e.test(t))}function ft(t,e){let n=[];for(let r of e){let o=G(t,r,"SKILL.md");if(V(o))try{let i=yt(o,"utf-8");(vo(i)||xo(i))&&n.push(r)}catch{}}return n}function bo(){let t=process.env.CLAUDE_MODEL||"";return/opus/i.test(t)}function Ce(t){if(!bo())return a();let e=tt(),n=G(e,"skills"),r=fo(e),o=yo(n),i;try{if(ho(r,n,o)){let c=So(r);c?(s("prefill-guard","Using cached scan results"),i=c.results.warnings):(i=ft(n,o),ve(r,i))}else i=ft(n,o),ve(r,i)}catch{i=ft(n,o)}return i.length===0?(s("prefill-guard","No prefilling patterns detected in skills"),a()):(s("prefill-guard",`Found prefilling patterns in ${i.length} skills: ${i.join(", ")}`,"warn"),Tt(`Opus 4.6 deprecation: ${i.length} skill(s) reference deprecated patterns (prefilled assistant messages or output_format parameter). Affected: ${i.slice(0,5).join(", ")}${i.length>5?"...":""}. Migration: use structured outputs instead of prefilling; use output_config.format instead of output_format.`))}import{existsSync as Ie,readFileSync as Ee}from"node:fs";import{join as ht}from"node:path";function Co(t,e){if(t==="tavily"&&!process.env.TAVILY_API_KEY)return`- tavily is enabled but TAVILY_API_KEY is not set
  Fix: export TAVILY_API_KEY="tvly-..." in ~/.zshrc, then set "disabled": false in .mcp.json`;if(t==="agentation"){if(Ie(ht(e,"node_modules",".bin","agentation-mcp")))return null;try{let r=JSON.parse(Ee(ht(e,"package.json"),"utf-8"));if("agentation-mcp"in{...r.dependencies,...r.devDependencies})return null}catch{}return`- agentation is enabled but agentation-mcp is not installed
  Fix: npm install -D agentation-mcp  or  set "disabled": true in .mcp.json`}return null}function we(t){if(process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1")return s("mcp-health-check","Skipping MCP check (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();let e=t.project_dir||p(),n=ht(e,".mcp.json");if(!Ie(n))return s("mcp-health-check","No .mcp.json found, skipping"),a();let r;try{r=JSON.parse(Ee(n,"utf-8"))}catch{return s("mcp-health-check","Failed to parse .mcp.json","warn"),a()}let o=r.mcpServers;if(!o||typeof o!="object")return a();let i=[];for(let[c,l]of Object.entries(o)){if(l.disabled===!0)continue;let u=Co(c,e);u&&i.push(u)}if(i.length>0){let c=`MCP misconfiguration detected:
${i.join(`
`)}`;return s("mcp-health-check",c,"warn"),_(c)}return s("mcp-health-check","All enabled MCPs are properly configured"),a()}import{writeFileSync as Io,mkdirSync as Eo,existsSync as wo}from"node:fs";import{join as Te}from"node:path";function $(t,e){let n=p();if(!n)return;let r=Te(n,".claude","logs");wo(r)||Eo(r,{recursive:!0});try{let o=Te(r,t);Io(o,`${JSON.stringify(e)}
`,{flag:"a"})}catch{}}async function Re(t){if(!p())return{continue:!0};let e=t.teammate_id||t.agent_id||"unknown",n=t.teammate_type||t.subagent_type||"unknown",r=t.idle_duration_ms||0;return $("teammate-activity.jsonl",{timestamp:new Date().toISOString(),event:"teammate_idle",teammate_id:e,teammate_type:n,idle_duration_ms:r,session_id:t.session_id}),T("team-activity.jsonl",{ts:new Date().toISOString(),pid:E(process.env.CLAUDE_PROJECT_DIR||""),event:"idle",agent:n,idle_ms:r,...w()}),r>3e4?{continue:!0,hookSpecificOutput:{additionalContext:`Agent ${n} (${e}) idle for ${Math.round(r/1e3)}s. Consider reassigning pending work.`}}:{continue:!0}}import{existsSync as To,readFileSync as Ro}from"node:fs";import{join as $o}from"node:path";var $e=6e4;function He(t){let e=O();if(!e)return a();let n=Lt();if(n.length===0)return a();let r=p();if(!r)return a();let o=$o(r,".claude","logs","teammate-activity.jsonl");if(!To(o))return a();let i=new Date(Date.now()-$e).toISOString(),c=new Set;try{let g=Ro(o,"utf-8").trim().split(`
`).filter(Boolean).slice(-50);for(let m of g)try{let y=JSON.parse(m);if(y.event==="teammate_idle"&&y.timestamp&&y.timestamp>=i){let St=y.teammate_id||y.member_name||"";St&&c.add(St)}}catch{}}catch{return a()}let l=t.teammate_id||t.agent_id||"";return l&&c.add(l),s("team-synthesis-trigger",`Team "${e}": ${c.size}/${n.length} idle within ${$e/1e3}s`),c.size>=n.length?_(`All ${n.length} teammates in team "${e}" are idle. Consider synthesizing results and shutting down the team.`):a()}import{existsSync as Ho,readFileSync as Po}from"node:fs";import{join as jo}from"node:path";var Oo=12e4;function Pe(t){let e=O();if(!e)return a();let n=p();if(!n)return a();let r=t.teammate_id||t.agent_id||"unknown",o=t.teammate_type||t.subagent_type||"unknown",i=jo(n,".claude","logs","task-completions.jsonl"),c=!1;if(Ho(i)){let l=new Date(Date.now()-Oo).toISOString();try{let g=Po(i,"utf-8").trim().split(`
`).filter(Boolean).slice(-30);for(let m of g)try{let y=JSON.parse(m);if(y.event==="task_completed"&&y.timestamp&&y.timestamp>=l){c=!0;break}}catch{}}catch{}}return $("team-quality.jsonl",{timestamp:new Date().toISOString(),event:"teammate_quality_check",team_name:e,teammate_id:r,teammate_type:o,has_recent_completion:c,session_id:t.session_id}),c?(s("team-quality-gate",`Teammate "${r}" quality check passed`),a()):(s("team-quality-gate",`Teammate "${r}" (${o}) idle without recent task completion`),_(`Teammate "${o}" (${r}) went idle without completing a task. Check if their work is stuck or needs reassignment.`))}var Do=/\b(?:implement|refactor|build|migrate)\b.{5,}/i;async function je(t){if(!p())return{continue:!0};let e=t.task_id||"unknown",n=t.task_subject||"",r=t.task_status||"completed",o=t.duration_ms||0,i=t.token_count,c=t.tool_uses;if($("task-completions.jsonl",{timestamp:new Date().toISOString(),event:"task_completed",task_id:e,task_subject:n,task_status:r,duration_ms:o,session_id:t.session_id,...i!==void 0&&{token_count:i},...c!==void 0&&{tool_uses:c}}),T("task-usage.jsonl",{ts:new Date().toISOString(),pid:E(process.env.CLAUDE_PROJECT_DIR||""),task_status:r,duration_ms:o,...i!==void 0&&{token_count:i},...c!==void 0&&{tool_uses:c},...w()}),Do.test(n)&&r==="completed"){let l=i!==void 0?`, ${i} tokens, ${c??0} tool calls`:"";return{continue:!0,hookSpecificOutput:{additionalContext:`Task "${n}" completed (${Math.round(o/1e3)}s${l}). Consider running tests to verify.`}}}return{continue:!0}}var Oe={"lifecycle/analytics-consent-check":jt,"lifecycle/pattern-sync-pull":U,"lifecycle/pattern-sync-push":Dt,"lifecycle/pr-status-enricher":At,"lifecycle/session-cleanup":Wt,"lifecycle/session-context-loader":Vt,"lifecycle/session-env-setup":B,"lifecycle/session-tracking":W,"lifecycle/session-metrics-summary":se,"lifecycle/dependency-version-check":ce,"lifecycle/unified-dispatcher":_e,"lifecycle/pre-compact-saver":ke,"lifecycle/prefill-guard":Ce,"lifecycle/mcp-health-check":we,"teammate-idle/progress-reporter":Re,"teammate-idle/team-synthesis-trigger":He,"teammate-idle/team-quality-gate":Pe,"task-completed/completion-tracker":je};function ma(t){return Oe[t]}function ga(){return Object.keys(Oe)}export{Ts as analyzeStagedChanges,ks as escapeRegex,gn as estimateTokenCount,Sn as extractIssueNumber,wt as getCachedBranch,fn as getCurrentBranch,ws as getDefaultBranch,os as getEnvFile,hs as getField,hn as getGitStatus,ma as getHook,P as getLogDir,un as getLogLevel,tt as getPluginRoot,p as getProjectDir,Cs as getRepoRoot,h as getSessionId,_n as getStagedFiles,Es as hasUncommittedChanges,Oe as hooks,No as isBashInput,Fo as isEditInput,Is as isGitRepo,yn as isProtectedBranch,Lo as isReadInput,Ao as isWriteInput,Ss as lineContainsAll,et as lineContainsAllCI,ga as listHooks,s as logHook,gs as logPermissionFeedback,_s as normalizeCommand,ss as normalizeLineEndings,us as outputAllowWithContext,cs as outputBlock,ds as outputDeny,ls as outputError,pn as outputPromptContext,fs as outputPromptContextBudgeted,is as outputSilentAllow,a as outputSilentSuccess,ps as outputStderrWarning,Tt as outputWarning,_ as outputWithContext,as as outputWithNotification,ms as outputWithUpdatedInput,ys as readHookInput,ln as shouldLog,Rs as validateBranchName};
//# sourceMappingURL=lifecycle.mjs.map
