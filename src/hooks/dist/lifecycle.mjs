// OrchestKit Hooks - lifecycle bundle
// Generated: 2026-01-28T17:08:15.144Z

function Vn(e){return typeof e.command=="string"}function zn(e){return typeof e.file_path=="string"&&typeof e.content=="string"}function Gn(e){return typeof e.file_path=="string"&&typeof e.old_string=="string"&&typeof e.new_string=="string"}function qn(e){return typeof e.file_path=="string"&&e.content===void 0}import{appendFileSync as B,existsSync as V,statSync as Te,renameSync as Pe,mkdirSync as je,readSync as De}from"node:fs";import{execSync as Fe}from"node:child_process";function z(){return process.env.CLAUDE_PLUGIN_ROOT?`${process.env.HOME||process.env.USERPROFILE||"/tmp"}/.claude/logs/ork`:`${l()}/.claude/logs`}function l(){return process.env.CLAUDE_PROJECT_DIR||"."}function Qn(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function m(){return process.env.CLAUDE_SESSION_ID||`fallback-${process.pid}-${Date.now()}`}function G(e){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let t=Fe("git branch --show-current",{cwd:e||l(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=t,t}catch{return"unknown"}}function Ne(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Le(e){let t=["debug","info","warn","error"];return t.indexOf(e)>=t.indexOf(Ne())}function c(){return{continue:!0,suppressOutput:!0}}function eo(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function to(e){return{continue:!1,stopReason:e,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:e}}}function P(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:e}}}function Ae(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:e}}}function no(e,t){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:e,permissionDecision:"allow"}};return t?n.systemMessage=t:n.suppressOutput=!0,n}function oo(e){return{continue:!0,systemMessage:e}}function ro(e){return{continue:!0,systemMessage:`\u26A0 ${e}`}}function so(e){return{continue:!1,stopReason:e,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:e}}}var Ue=200*1024,Me=100*1024;function q(e,t){if(V(e))try{if(Te(e).size>t){let o=`${e}.old.${Date.now()}`;Pe(e,o)}}catch{}}function Y(e){V(e)||je(e,{recursive:!0})}function r(e,t,n="debug"){if(!Le(n))return;let o=z(),s=`${o}/hooks.log`;try{Y(o),q(s,Ue);let i=new Date().toISOString().replace("T"," ").slice(0,19);B(s,`[${i}] [${n.toUpperCase()}] [${e}] ${t}
`)}catch{}}function io(e,t,n){let o=z(),s=`${o}/permission-feedback.log`;try{Y(o),q(s,Me);let i=new Date().toISOString(),a=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",p=n?.session_id||m();B(s,`${i} | ${e} | ${t} | tool=${a} | session=${p}
`)}catch{}}function Ke(e){if(!e)return 0;let o=(e.match(/[{};()=><]/g)||[]).length/e.length>.03?2.8:3.5;return Math.ceil(e.length/o)}function co(e,t,n,o,s){let i=Ke(e);return o&&o.isOverBudget(n)?(r(t,`Budget exhausted for ${n}, suppressing ${i}t`),c()):(s&&s.trackTokenUsage(t,n,i),Ae(e))}function ao(){try{let e=[],n=Buffer.allocUnsafe(256),o,s=0;for(;;)try{if(o=De(s,n,0,256,null),o===0)break;e.push(Buffer.from(n.subarray(0,o)))}catch{break}let i=Buffer.concat(e).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:m(),tool_input:{}}}catch{return{tool_name:"",session_id:m(),tool_input:{}}}}function uo(e,t){let n=t.replace(/^\./,"").split("."),o=e;for(let s of n){if(o==null)return;o=o[s]}return o}function lo(e){return e.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function po(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}import{execSync as k}from"node:child_process";function Je(e){let t=e||l();try{return k("git branch --show-current",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return"unknown"}}function We(e){let t=e||Je();return["dev","main","master"].includes(t)}function yo(e){let t=e||l();try{return k("git rev-parse --show-toplevel",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return t}}function ho(e){let t=e||l();try{return k("git rev-parse --git-dir",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),!0}catch{return!1}}function Be(e){let t=e||l();try{return k("git status --short",{cwd:t,encoding:"utf8",timeout:1e4,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function So(e){return Be(e).length>0}function ko(e){let t=e||l();try{return k("git rev-parse --verify main",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"main"}catch{try{return k("git rev-parse --verify master",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"master"}catch{return"main"}}}function Ve(e){let t=[/issue\/(\d+)/i,/feature\/(\d+)/i,/fix\/(\d+)/i,/bug\/(\d+)/i,/feat\/(\d+)/i,/^(\d+)-/,/-(\d+)$/,/#(\d+)/];for(let n of t){let o=e.match(n);if(o)return parseInt(o[1],10)}return null}function _o(e){if(We(e))return null;let t=["issue/","feature/","fix/","bug/","feat/","chore/","docs/","refactor/","test/","ci/","perf/","style/","release/","hotfix/"];return t.some(o=>e.startsWith(o))?e.startsWith("issue/")&&!Ve(e)?"issue/ branches should include an issue number (e.g., issue/123-description)":null:`Branch name should start with a valid prefix: ${t.join(", ")}`}import{existsSync as Z,readFileSync as X}from"node:fs";function ze(e){let t=`${e}/.claude/feedback/consent-status.json`;if(!Z(t))return{consented:!1,asked:!1};try{let n=JSON.parse(X(t,"utf-8"));return{consented:n.consented===!0,asked:n.asked===!0}}catch{return{consented:!1,asked:!1}}}function Ge(e){let t=`${e}/.claude/feedback/consent-log.json`;if(!Z(t))return null;try{let n=JSON.parse(X(t,"utf-8"));if(n.events&&n.events.length>0)return n.events[n.events.length-1]}catch{}return null}function qe(e){try{let t=new Date(e);return Math.floor((new Date().getTime()-t.getTime())/(1e3*60*60*24))>=30}catch{return!1}}function Q(e){let t=e.project_dir||l(),n=ze(t);if(n.consented)return r("analytics-consent-check","User has consented to analytics"),c();if(n.asked){let o=Ge(t);return o&&(o.action==="declined"||o.action==="revoked")&&qe(o.timestamp)?(r("analytics-consent-check","Showing 30-day reminder"),{continue:!0,systemMessage:"Reminder: Anonymous analytics help improve OrchestKit. Enable with /ork:feedback opt-in"}):(r("analytics-consent-check","User recently declined, not prompting"),c())}return r("analytics-consent-check","First time user, showing brief notice"),{continue:!0,systemMessage:"OrchestKit collects local usage metrics. Share anonymously with /ork:feedback opt-in"}}import{existsSync as _,readFileSync as ee,writeFileSync as Ye,unlinkSync as Ze}from"node:fs";function Xe(e){let t=`${e}/.claude/.instance_env`;if(!_(t))return null;try{let o=ee(t,"utf-8").match(/CLAUDE_INSTANCE_ID=([^\n]+)/);if(o)return o[1].trim()}catch{}return null}function Qe(e,t){let o=`${`${e}/.claude/coordination/heartbeats`}/${t}.json`;if(_(o))try{let s=JSON.parse(ee(o,"utf-8"));s.status="stopping",Ye(o,JSON.stringify(s,null,2)),r("coordination-cleanup",`Updated heartbeat status to 'stopping' for ${t}`)}catch(s){r("coordination-cleanup",`Failed to update heartbeat: ${s}`)}}function et(e,t){let n=`${e}/.claude/coordination/.claude.db`;if(!_(n)){r("coordination-cleanup","No coordination database found");return}r("coordination-cleanup",`Would unregister instance: ${t}`)}function tt(e){let t=`${e}/.claude/.instance_env`;try{_(t)&&(Ze(t),r("coordination-cleanup","Removed instance environment file"))}catch(n){r("coordination-cleanup",`Failed to remove instance env: ${n}`)}}function te(e){r("coordination-cleanup","Starting coordination cleanup");let t=e.project_dir||l(),n=Xe(t);return n&&(Qe(t,n),et(t,n)),tt(t),r("coordination-cleanup","Coordination cleanup complete"),c()}import{existsSync as nt,readFileSync as ot,writeFileSync as rt,mkdirSync as ne,appendFileSync as st}from"node:fs";function it(){return process.env.CLAUDE_MULTI_INSTANCE==="1"}function ct(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function at(e){let t=`${e}/.claude/context/session/state.json`;if(!nt(t))return"General development";try{return JSON.parse(ot(t,"utf-8")).current_task?.description||"General development"}catch{return"General development"}}function ut(){return process.env.CLAUDE_SUBAGENT_ROLE||"main"}function lt(){let e=m(),t=new Date().toISOString().replace(/[-:T.Z]/g,"").slice(0,14),n=Math.random().toString(36).substring(2,8);return`${e.slice(0,8)}-${t}-${n}`}function pt(e,t){let n=`${e}/.claude/.instance_env`;try{ne(`${e}/.claude`,{recursive:!0}),st(n,`CLAUDE_INSTANCE_ID=${t}
`),r("coordination-init",`Saved instance ID: ${t}`)}catch(o){r("coordination-init",`Failed to save instance ID: ${o}`)}}function dt(e,t,n,o){let s=`${e}/.claude/coordination/heartbeats`;try{ne(s,{recursive:!0});let i={instance_id:t,task:n,role:o,status:"active",started_at:new Date().toISOString(),last_heartbeat:new Date().toISOString()};rt(`${s}/${t}.json`,JSON.stringify(i,null,2)),r("coordination-init",`Initialized heartbeat for ${t}`)}catch(i){r("coordination-init",`Failed to initialize heartbeat: ${i}`)}}function oe(e){if(!it())return r("coordination-init","Multi-instance not enabled, skipping"),c();if(ct())return r("coordination-init","Skipping coordination init (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();r("coordination-init","Starting coordination initialization");let t=e.project_dir||l(),n=at(t),o=ut(),s=lt();return process.env.CLAUDE_INSTANCE_ID=s,pt(t,s),dt(t,s,n,o),r("coordination-init",`Coordination initialized: ${s}`),c()}import{existsSync as j,readFileSync as D,writeFileSync as re,readdirSync as gt,unlinkSync as mt,mkdirSync as ft}from"node:fs";function yt(){return process.env.CLAUDE_MULTI_INSTANCE==="1"}function ht(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function St(){return process.env.CLAUDE_INSTANCE_ID||m()}function kt(e){let t=`${e}/.claude/.instance_env`;if(!j(t))return null;try{let o=D(t,"utf-8").match(/CLAUDE_INSTANCE_ID=([^\n]+)/);if(o)return o[1].trim()}catch{}return null}function _t(e,t){let n=`${e}/.claude/coordination/heartbeats`,o=`${n}/${t}.json`;if(!j(o)){ft(n,{recursive:!0});let s={instance_id:t,status:"active",last_heartbeat:new Date().toISOString()};re(o,JSON.stringify(s,null,2)),r("instance-heartbeat",`Created heartbeat for ${t}`);return}try{let s=JSON.parse(D(o,"utf-8"));s.last_heartbeat=new Date().toISOString(),s.status="active",re(o,JSON.stringify(s,null,2)),r("instance-heartbeat",`Updated heartbeat for ${t}`)}catch(s){r("instance-heartbeat",`Failed to update heartbeat: ${s}`)}}function vt(e,t){let n=`${e}/.claude/coordination/heartbeats`;if(!j(n))return 0;let o=300*1e3,s=Date.now(),i=0;try{let a=gt(n).filter(p=>p.endsWith(".json"));for(let p of a){let u=`${n}/${p}`;try{let d=JSON.parse(D(u,"utf-8"));if(d.instance_id===t)continue;let f=new Date(d.last_heartbeat).getTime();s-f>o&&(mt(u),i++,r("instance-heartbeat",`Cleaned up stale instance: ${d.instance_id}`))}catch{}}}catch(a){r("instance-heartbeat",`Failed to scan heartbeats: ${a}`)}return i}function v(e){if(!yt())return c();if(ht())return r("instance-heartbeat","Skipping instance heartbeat (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();let t=e.project_dir||l(),n=St();if((!n||n==="unknown")&&(n=kt(t)||n),!n)return r("instance-heartbeat","No instance ID available"),c();_t(t,n);let o=vt(t,n);return o>0&&r("instance-heartbeat",`Cleaned up ${o} stale instance(s)`),c()}import{mkdirSync as bt,appendFileSync as It}from"node:fs";function xt(){return!!process.env.MEM0_API_KEY}function b(e){if(r("mem0-analytics-tracker","Mem0 analytics tracker starting"),!xt())return r("mem0-analytics-tracker","Mem0 not available, skipping analytics"),c();let t=e.project_dir||l(),n=`${t}/.claude/logs/mem0-analytics.jsonl`,o=e.session_id||m(),s=new Date().toISOString(),i=JSON.stringify({session_id:o,timestamp:s,event:"session_start"});try{bt(`${t}/.claude/logs`,{recursive:!0}),It(n,i+`
`),r("mem0-analytics-tracker","Mem0 analytics tracked")}catch(a){r("mem0-analytics-tracker",`Failed to write analytics: ${a}`)}return c()}import{existsSync as $t,readFileSync as ie,mkdirSync as wt,renameSync as Ht}from"node:fs";function Rt(e){let t=e.split("/");return(t[t.length-1]||"unknown").toLowerCase().replace(/\s+/g,"-")}function Ot(){return!!process.env.MEM0_API_KEY}function se(e){if(!$t(e))return!1;try{let t=ie(e,"utf-8"),n=JSON.parse(t);return!(!n||Object.keys(n).length===0)}catch{return!1}}function Et(e,t){let n=`${t}/.claude/logs/mem0-processed`,o=new Date().toISOString().replace(/[:.]/g,"-");try{wt(n,{recursive:!0});let i=(e.split("/").pop()||"pending-sync").replace(".json",`.processed-${o}.json`),a=`${n}/${i}`;Ht(e,a),r("mem0-context-retrieval",`Archived pending sync to ${a}`)}catch(s){r("mem0-context-retrieval",`Warning: Could not archive ${e}: ${s}`)}}function I(e){r("mem0-context-retrieval","Mem0 context retrieval starting");let t=e.project_dir||l(),n=Rt(t),o=`${t}/.mem0-pending-sync.json`,s=`${process.env.HOME||process.env.USERPROFILE||"/tmp"}/.claude/.mem0-pending-sync.json`,i=null;if(se(o))i=o,r("mem0-context-retrieval",`Found pending sync in project: ${o}`);else if(se(s))try{let a=JSON.parse(ie(s,"utf-8"));a.project_id===n?(i=s,r("mem0-context-retrieval","Found pending sync in global location for this project")):r("mem0-context-retrieval",`Global pending sync exists but for different project: ${a.project_id}`)}catch{}return i&&(r("mem0-context-retrieval","Found pending sync, archiving for processing"),Et(i,t),r("mem0-context-retrieval","Pending sync archived - will be processed on next memory operation")),Ot()?r("mem0-context-retrieval","Graph + mem0 available for this session"):r("mem0-context-retrieval","Graph available (mem0 not configured) for this session"),c()}import{writeFileSync as Ct,mkdirSync as Tt}from"node:fs";function Pt(){return!!process.env.MEM0_API_KEY}function jt(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function ce(e){if(jt())return r("mem0-webhook-setup","Skipping mem0 webhook setup (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();if(r("mem0-webhook-setup","Mem0 webhook setup starting"),!Pt())return r("mem0-webhook-setup","Mem0 not available, skipping webhook setup"),c();let t=e.project_dir||l(),n=`${t}/.claude/mem0-webhooks.json`,o="orchestkit-auto-sync",s=["memory.created","memory.updated","memory.deleted"],i=process.env.MEM0_WEBHOOK_URL||"https://example.com/webhook/mem0";r("mem0-webhook-setup","Checking for existing webhooks"),process.env.MEM0_WEBHOOK_URL||r("mem0-webhook-setup","Webhook URL not configured (set MEM0_WEBHOOK_URL), skipping creation");try{Tt(`${t}/.claude`,{recursive:!0}),Ct(n,JSON.stringify({webhook_name:o,events:s,url:i},null,2)),r("mem0-webhook-setup","Webhook config saved")}catch(a){r("mem0-webhook-setup",`Failed to save webhook config: ${a}`)}return r("mem0-webhook-setup","Webhook setup complete"),c()}import{existsSync as y,readFileSync as Dt,writeFileSync as ae,mkdirSync as x}from"node:fs";import{execSync as F}from"node:child_process";function Ft(){return process.env.CLAUDE_MULTI_INSTANCE==="1"}function Nt(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Lt(){try{return F("which sqlite3",{encoding:"utf-8",stdio:"pipe"}),!0}catch{return!1}}function At(e){let t=e.split("/").pop()||"unknown",n=new Date().toISOString().replace(/[-:T.Z]/g,"").slice(0,14),o=Math.random().toString(16).substring(2,10);return`${t}-${n}-${o}`}function Ut(e){try{return F("git branch --show-current",{cwd:e,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim()}catch{return"unknown"}}function Mt(e){let t=[];return(y(`${e}/backend`)||y(`${e}/src/backend`))&&t.push("backend"),(y(`${e}/frontend`)||y(`${e}/src/frontend`)||y(`${e}/package.json`))&&t.push("frontend"),(y(`${e}/tests`)||y(`${e}/__tests__`))&&t.push("testing"),(y(`${e}/infrastructure`)||y(`${e}/docker-compose.yml`)||y(`${e}/Dockerfile`))&&t.push("devops"),t}function Kt(e,t){let n=Ut(e),o=Mt(e),s=new Date().toISOString(),i={instance_id:t,worktree_name:e.split("/").pop()||"unknown",worktree_path:e,branch:n,capabilities:o,agent_type:null,model:"claude-opus-4-5-20251101",priority:1,created_at:s,status:"active",heartbeat_interval_ms:5e3,last_heartbeat:s},a=`${e}/.instance`;return x(a,{recursive:!0}),ae(`${a}/id.json`,JSON.stringify(i,null,2)),r("multi-instance-init",`Instance identity created: ${t}`),i}function Jt(e){let t=`${e}/.claude/coordination`,n=`${t}/.claude.db`,o=`${t}/schema.sql`;if(y(n))return!0;if(!y(o))return r("multi-instance-init",`WARNING: Schema file not found at ${o}`),!1;try{return x(t,{recursive:!0}),F(`sqlite3 "${n}" < "${o}"`,{encoding:"utf-8",stdio:["pipe","pipe","pipe"]}),r("multi-instance-init","Database initialized from schema"),!0}catch(s){return r("multi-instance-init",`Failed to initialize database: ${s}`),!1}}function Wt(e,t){let n=`${e}/.instance`;ae(`${n}/heartbeat.pid`,String(process.pid)),r("multi-instance-init",`Heartbeat marker created for ${t}`)}function $(e){if(!Ft())return c();if(!Lt())return r("multi-instance-init","sqlite3 not available, skipping"),c();if(Nt())return r("multi-instance-init","Skipping multi-instance init (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();r("multi-instance-init","Starting multi-instance coordination initialization...");let t=e.project_dir||l(),n=`${t}/.instance`,o=`${t}/.claude/coordination`;if(x(`${o}/locks`,{recursive:!0}),x(n,{recursive:!0}),!Jt(t))return r("multi-instance-init","ERROR: Failed to initialize database"),c();let s=`${n}/id.json`,i=`${n}/heartbeat.pid`;if(y(s)&&y(i))try{let p=JSON.parse(Dt(s,"utf-8"));return r("multi-instance-init",`Reusing existing instance: ${p.instance_id}`),c()}catch{}let a=At(t);return Kt(t,a),Wt(t,a),r("multi-instance-init","Multi-instance coordination initialized successfully"),c()}import{existsSync as w,readFileSync as N,writeFileSync as Bt,statSync as Vt,mkdirSync as zt}from"node:fs";var Gt=1*1024*1024;function qt(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Yt(e){let t=`${e}/.claude/feedback/sync-config.json`;if(!w(t))return!0;try{return JSON.parse(N(t,"utf-8")).sync_enabled!==!1}catch{return!0}}function ue(e){if(!w(e))return!0;try{let t=Vt(e);return t.size>Gt?(r("pattern-sync-pull",`WARN: Skipping - file too large: ${e} (${t.size} bytes)`),!1):!0}catch{return!0}}function Zt(e){let n=`${process.env.HOME||process.env.USERPROFILE||"/tmp"}/.claude/global-patterns.json`,o=`${e}/.claude/feedback/learned-patterns.json`;if(!w(n)){r("pattern-sync-pull","No global patterns file found");return}try{let i=JSON.parse(N(n,"utf-8")).patterns||[];if(i.length===0){r("pattern-sync-pull","No global patterns to pull");return}let a={version:"1.0",patterns:[]};if(w(o))try{a=JSON.parse(N(o,"utf-8"))}catch{}let p=a.patterns||[],u=new Set(p.map(g=>g.text)),d=i.filter(g=>!u.has(g.text));if(d.length===0){r("pattern-sync-pull","All global patterns already in project");return}let f=[...p,...d];a.patterns=f,zt(`${e}/.claude/feedback`,{recursive:!0}),Bt(o,JSON.stringify(a,null,2)),r("pattern-sync-pull",`Pulled ${d.length} new patterns from global`)}catch(s){r("pattern-sync-pull",`Failed to pull global patterns: ${s}`)}}function H(e){if(qt())return r("pattern-sync-pull","Skipping pattern sync (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();let t=e.project_dir||l();if(!Yt(t))return r("pattern-sync-pull","Global sync disabled, skipping pull"),c();let o=`${process.env.HOME||process.env.USERPROFILE||"/tmp"}/.claude/global-patterns.json`,s=`${t}/.claude/feedback/learned-patterns.json`;return!ue(o)||!ue(s)?(r("pattern-sync-pull","Skipping pattern sync due to large files"),c()):(r("pattern-sync-pull","Pulling global patterns..."),Zt(t),r("pattern-sync-pull","Global patterns pulled successfully"),c())}import{existsSync as L,readFileSync as A,writeFileSync as Xt,mkdirSync as Qt}from"node:fs";function en(e){let t=`${e}/.claude/feedback/sync-config.json`;if(!L(t))return!0;try{return JSON.parse(A(t,"utf-8")).sync_enabled!==!1}catch{return!0}}function tn(e){let t=`${e}/.claude/feedback/learned-patterns.json`,n=process.env.HOME||process.env.USERPROFILE||"/tmp",o=`${n}/.claude/global-patterns.json`;if(!L(t)){r("pattern-sync-push","No project patterns file found");return}try{let i=JSON.parse(A(t,"utf-8")).patterns||[];if(i.length===0){r("pattern-sync-push","No project patterns to push");return}let a={version:"1.0",patterns:[],updated:""};if(L(o))try{a=JSON.parse(A(o,"utf-8"))}catch{}let p=a.patterns||[],u=new Set(p.map(g=>g.text)),d=i.filter(g=>!u.has(g.text));if(d.length===0){r("pattern-sync-push","All project patterns already in global");return}let f=[...p,...d];a.patterns=f,a.updated=new Date().toISOString(),Qt(`${n}/.claude`,{recursive:!0}),Xt(o,JSON.stringify(a,null,2)),r("pattern-sync-push",`Pushed ${d.length} new patterns to global`)}catch(s){r("pattern-sync-push",`Failed to push project patterns: ${s}`)}}function le(e){let t=e.project_dir||l();return en(t)?(r("pattern-sync-push","Pushing project patterns to global..."),tn(t),c()):(r("pattern-sync-push","Global sync disabled, skipping push"),c())}import{execSync as pe}from"node:child_process";var nn=new Set(["main","master","dev","develop"]);function de(e){r("pr-status-enricher","Checking for open PR on current branch");let t=e.project_dir||l(),n;try{n=G(t)}catch{return r("pr-status-enricher","Could not determine branch, skipping"),c()}if(!n||nn.has(n))return r("pr-status-enricher",`Branch "${n}" skipped for PR detection`),c();try{let o=pe("gh pr view --json state,reviewDecision,url,title,isDraft",{cwd:t,timeout:1e4,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim(),s=JSON.parse(o);if(!s.url)return r("pr-status-enricher","No PR found for current branch"),c();process.env.ORCHESTKIT_PR_URL=s.url,process.env.ORCHESTKIT_PR_STATE=s.state;let i=0;try{let d=pe("gh pr view --json reviewThreads",{cwd:t,timeout:1e4,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim();i=(JSON.parse(d).reviewThreads||[]).filter(g=>!g.isResolved).length}catch{}let a=s.isDraft?" (DRAFT)":"",p=s.reviewDecision?` | Review: ${s.reviewDecision}`:"",u=i>0?` | ${i} unresolved`:"";r("pr-status-enricher",`PR: ${s.title}${a} [${s.state}${p}${u}]`),r("pr-status-enricher",`URL: ${s.url}`)}catch{r("pr-status-enricher","No PR found or gh CLI unavailable")}return c()}import{existsSync as R,readFileSync as on,mkdirSync as rn,readdirSync as ge,unlinkSync as me,copyFileSync as sn}from"node:fs";function cn(e){if(!R(e))return 0;try{let n=JSON.parse(on(e,"utf-8")).tools||{};return Object.values(n).reduce((o,s)=>o+s,0)}catch{return 0}}function an(e,t){if(!R(e))return;let n=cn(e);if(n<=5){r("session-cleanup",`Session had only ${n} tool calls, not archiving`);return}try{rn(t,{recursive:!0});let s=`session-${new Date().toISOString().replace(/[:.]/g,"-")}.json`,i=`${t}/${s}`;sn(e,i),r("session-cleanup",`Archived session metrics to ${s}`)}catch(o){r("session-cleanup",`Failed to archive metrics: ${o}`)}}function un(e,t=20){if(R(e))try{let n=ge(e).filter(s=>s.startsWith("session-")&&s.endsWith(".json")).sort().reverse();if(n.length<=t)return;let o=n.slice(t);for(let s of o)try{me(`${e}/${s}`),r("session-cleanup",`Deleted old archive: ${s}`)}catch{}}catch(n){r("session-cleanup",`Failed to cleanup old archives: ${n}`)}}function ln(e){if(!R(e))return;let t=["hooks.log.old*","audit.log.old*"];for(let n of t)try{let o=n.replace("*",""),s=ge(e).filter(a=>a.startsWith(o)).sort().reverse();if(s.length<=5)continue;let i=s.slice(5);for(let a of i)try{me(`${e}/${a}`)}catch{}}catch{}}function fe(e){r("session-cleanup","Session cleanup starting");let t=e.project_dir||l(),n="/tmp/claude-session-metrics.json",o=`${t}/.claude/logs/sessions`,s=`${t}/.claude/logs`;return an(n,o),un(o,20),ln(s),r("session-cleanup","Session cleanup complete"),c()}import{existsSync as U,readFileSync as ye}from"node:fs";function O(e){if(!U(e))return!1;try{return JSON.parse(ye(e,"utf-8")),!0}catch{return!1}}function he(e){r("session-context-loader","Session starting - loading context (Protocol 2.0)");let t=e.project_dir||l(),n=0,o=process.env.AGENT_TYPE||"",s=`${t}/.claude/context/session/state.json`,i=`${t}/.claude/context/identity.json`,a=`${t}/.claude/context/knowledge/index.json`;O(s)&&(r("session-context-loader","Session state loaded"),n++),O(i)&&(r("session-context-loader","Identity loaded"),n++),O(a)&&(r("session-context-loader","Knowledge index available"),n++);let p=`${t}/docs/CURRENT_STATUS.md`;if(U(p)&&r("session-context-loader","Current status document exists"),o){r("session-context-loader",`Agent-type aware initialization: ${o}`);let d=`${t}/.claude/agents/${o}.md`;U(d)&&(r("session-context-loader",`Agent configuration found: ${d}`),n++)}let u=`${t}/.claude/context/session/compaction-manifest.json`;if(O(u))try{let d=JSON.parse(ye(u,"utf-8"));r("session-context-loader",`Compaction manifest loaded: session=${d.sessionId}, decisions=${(d.keyDecisions||[]).length}, files=${(d.filesTouched||[]).length}`),process.env.ORCHESTKIT_LAST_SESSION=d.sessionId||"",process.env.ORCHESTKIT_LAST_DECISIONS=JSON.stringify(d.keyDecisions||[]),n++}catch(d){r("session-context-loader",`Error loading compaction manifest: ${d}`)}return n>0&&(o?r("session-context-loader",`Session context loaded (Protocol 2.0) - Agent: ${o}`):r("session-context-loader","Session context loaded (Protocol 2.0)")),c()}import{existsSync as pn,readFileSync as dn,writeFileSync as Se,mkdirSync as gn}from"node:fs";import{execSync as mn}from"node:child_process";function fn(e){try{return mn("git branch --show-current",{cwd:e,encoding:"utf-8",timeout:500,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function E(e){r("session-env-setup","Setting up session environment");let t=e.project_dir||l(),n=e.session_id||m(),o="/tmp/claude-session-metrics.json";try{gn(`${t}/.claude/logs`,{recursive:!0})}catch{}let s=process.env.AGENT_TYPE||"";!s&&e.agent_type&&(s=e.agent_type);let i={session_id:n,started_at:new Date().toISOString(),agent_type:s,tools:{},errors:0,warnings:0};try{Se(o,JSON.stringify(i,null,2)),r("session-env-setup","Initialized session metrics")}catch(u){r("session-env-setup",`Failed to initialize metrics: ${u}`)}let a=`${t}/.claude/context/session/state.json`;if(pn(a)&&s)try{let u=JSON.parse(dn(a,"utf-8"));u.agent_type=s,u.session_id=n,u.last_activity=new Date().toISOString(),Se(a,JSON.stringify(u,null,2)),r("session-env-setup",`Updated session state with agent_type: ${s}`)}catch(u){r("session-env-setup",`Failed to update session state: ${u}`)}let p=fn(t);return p&&r("session-env-setup",`Git branch: ${p}`),s&&r("session-env-setup",`Agent type: ${s}`),c()}import{existsSync as wn,appendFileSync as Hn,mkdirSync as Rn,readFileSync as xr,readdirSync as $r}from"node:fs";import{existsSync as yn,readFileSync as hn,writeFileSync as hr,mkdirSync as Sr}from"node:fs";import{execSync as ke}from"node:child_process";import{createHash as Sn}from"node:crypto";import*as _e from"node:os";var kn=".claude/.user_identity.json",_n="orchestkit-user-identity-v1";var h=null;function C(e){return Sn("sha256").update(e+_n).digest("hex").slice(0,16)}function vn(){try{return _e.hostname()}catch{return"unknown-machine"}}function bn(e){let t=`${e}/${kn}`;if(!yn(t))return null;try{let n=hn(t,"utf8");return JSON.parse(n)}catch(n){return r("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function In(e){let t={};try{t.email=ke("git config user.email",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{t.name=ke("git config user.name",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return t}function xn(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function $n(e){if(h)return h;let t=e||l(),n=vn(),o=bn(t);if(o?.user_id)return h={user_id:o.user_id,display_name:o.display_name||o.user_id,team_id:o.team_id,machine_id:n,source:"config",anonymous_id:C(o.user_id),email:o.user_id.includes("@")?o.user_id:void 0},r("user-identity",`Resolved from config: ${h.user_id}`,"debug"),h;let s=In(t);if(s.email)return h={user_id:s.email,display_name:s.name||s.email.split("@")[0],team_id:o?.team_id,machine_id:n,source:"git",anonymous_id:C(s.email),email:s.email},r("user-identity",`Resolved from git: ${h.user_id}`,"debug"),h;let i=xn();if(i.username){let p=`${i.username}@${n}`;return h={user_id:p,display_name:i.username,team_id:o?.team_id,machine_id:n,source:"env",anonymous_id:C(p)},r("user-identity",`Resolved from env: ${h.user_id}`,"debug"),h}let a=C(n+process.pid);return h={user_id:`anon-${a.slice(0,8)}`,display_name:"Anonymous",team_id:o?.team_id,machine_id:n,source:"anonymous",anonymous_id:a},r("user-identity",`Resolved as anonymous: ${h.user_id}`,"debug"),h}function ve(){let e=$n();return{session_id:m(),user_id:e.user_id,anonymous_id:e.anonymous_id,team_id:e.team_id,machine_id:e.machine_id,identity_source:e.source,timestamp:new Date().toISOString()}}function Ie(e){let t=e||m();return`${l()}/.claude/memory/sessions/${t}`}function On(e){return`${Ie(e)}/events.jsonl`}function En(e){let t=Ie(e);wn(t)||Rn(t,{recursive:!0})}var be=0;function Cn(){return be++,`evt-${Date.now()}-${be}`}function Tn(e,t,n={}){try{let o={event_id:Cn(),event_type:e,identity:ve(),payload:{name:t,input:M(n.input),output:M(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?$e(n.context,500):void 0,confidence:n.confidence}};En();let s=On();Hn(s,JSON.stringify(o)+`
`),r("session-tracker",`Tracked ${e}: ${t}`,"debug")}catch(o){r("session-tracker",`Failed to track event: ${o}`,"warn")}}function xe(){Tn("session_start","session",{success:!0})}function $e(e,t){return e.length<=t?e:e.slice(0,t-3)+"..."}function M(e){if(!e)return;let t={},n=["password","secret","token","key","credential","auth"];for(let[o,s]of Object.entries(e)){if(n.some(i=>o.toLowerCase().includes(i))){t[o]="[REDACTED]";continue}if(typeof s=="string"&&s.length>500){t[o]=$e(s,500);continue}if(typeof s=="object"&&s!==null&&!Array.isArray(s)){t[o]=M(s);continue}t[o]=s}return t}function T(e){try{return xe(),r("session-tracking","Tracked session start","debug"),c()}catch(t){return r("session-tracking",`Error: ${t}`,"warn"),c()}}import{existsSync as Pn,readFileSync as jn}from"node:fs";function we(e){r("session-metrics-summary","Session ending - generating summary");let t="/tmp/claude-session-metrics.json";if(!Pn(t))return r("session-metrics-summary","No metrics file found"),c();try{let n=JSON.parse(jn(t,"utf-8")),o=n.tools||{},s=n.errors||0,i=Object.values(o).reduce((p,u)=>p+u,0),a=Object.entries(o).sort(([,p],[,u])=>u-p).slice(0,3).map(([p,u])=>`${p}: ${u}`).join(", ");r("session-metrics-summary",`Session stats: ${i} tool calls, ${s} errors`),i>0&&r("session-metrics-summary",`Top tools: ${a}`)}catch(n){r("session-metrics-summary",`Failed to read metrics: ${n}`)}return c()}import{existsSync as S,readFileSync as J,writeFileSync as Dn,mkdirSync as Fn}from"node:fs";var Nn=[{package:"lodash",pattern:"<4.17.21",severity:"high",cve:"CVE-2021-23337",description:"Prototype pollution"},{package:"minimist",pattern:"<1.2.6",severity:"critical",cve:"CVE-2021-44906",description:"Prototype pollution"},{package:"node-fetch",pattern:"<2.6.7",severity:"high",cve:"CVE-2022-0235",description:"Information exposure"},{package:"axios",pattern:"<0.21.2",severity:"high",cve:"CVE-2021-3749",description:"ReDoS vulnerability"},{package:"jsonwebtoken",pattern:"<9.0.0",severity:"critical",cve:"CVE-2022-23529",description:"Insecure token verification"},{package:"express",pattern:"<4.17.3",severity:"medium",cve:"CVE-2022-24999",description:"Open redirect"},{package:"tar",pattern:"<6.1.11",severity:"critical",cve:"CVE-2021-37701",description:"Arbitrary file overwrite"},{package:"path-parse",pattern:"<1.0.7",severity:"medium",cve:"CVE-2021-23343",description:"ReDoS vulnerability"},{package:"django",pattern:"<3.2.14",severity:"high",cve:"CVE-2022-34265",description:"SQL injection"},{package:"flask",pattern:"<2.0.2",severity:"medium",cve:"CVE-2021-28091",description:"Path traversal"},{package:"requests",pattern:"<2.28.0",severity:"medium",cve:"CVE-2023-32681",description:"Information disclosure"},{package:"urllib3",pattern:"<1.26.5",severity:"high",cve:"CVE-2021-33503",description:"ReDoS vulnerability"},{package:"pillow",pattern:"<9.0.0",severity:"high",cve:"CVE-2022-22817",description:"Buffer overflow"},{package:"pyyaml",pattern:"<5.4",severity:"critical",cve:"CVE-2020-14343",description:"Arbitrary code execution"},{package:"jinja2",pattern:"<3.0.3",severity:"medium",cve:"CVE-2020-28493",description:"XSS vulnerability"},{package:"sqlalchemy",pattern:"<1.4.46",severity:"medium",cve:"CVE-2023-30533",description:"SQL injection"}],Ln=24;function An(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Un(e,t){let n=e.split(".").map(s=>parseInt(s,10)||0),o=t.split(".").map(s=>parseInt(s,10)||0);for(let s=0;s<Math.max(n.length,o.length);s++){let i=n[s]||0,a=o[s]||0;if(i<a)return!0;if(i>a)return!1}return!1}function Mn(e,t){let n=t.charAt(0),o=t.substring(1);return n==="<"?Un(e,o):n==="="?e===o:!1}function Kn(e){return e.replace(/^[^~>=<]/,"").replace(/,.*$/,"").trim()}function He(e,t){let n=Kn(t),o=e.toLowerCase();for(let s of Nn)if(o===s.package&&Mn(n,s.pattern))return s;return null}function Jn(e){if(!S(e))return null;try{let t=JSON.parse(J(e,"utf-8"));if((Date.now()-t.timestamp)/(1e3*60*60)<Ln)return t.warnings}catch{}return null}function K(e,t){try{Fn(e.replace(/\/[^/]+$/,""),{recursive:!0});let n={warnings:t,timestamp:Date.now()};Dn(e,JSON.stringify(n,null,2))}catch{}}function Wn(e){let t=0,n=0,o="";if(!S(e))return{criticalCount:t,highCount:n,warnings:o};try{let s=JSON.parse(J(e,"utf-8")),i={...s.dependencies,...s.devDependencies};for(let[a,p]of Object.entries(i)){let u=He(a,p);u&&(u.severity==="critical"&&t++,u.severity==="high"&&n++,o+=`
- ${a}@${p}: ${u.description} (${u.cve}, ${u.severity}) - upgrade to ${u.pattern}`)}}catch{}return{criticalCount:t,highCount:n,warnings:o}}function Bn(e){let t=0,n=0,o="";if(!S(e))return{criticalCount:t,highCount:n,warnings:o};try{let i=J(e,"utf-8").split(`
`);for(let a of i){let p=a.trim();if(!p||p.startsWith("#"))continue;let u=p.match(/^([a-zA-Z0-9_-]+)(?:==|>=|~=|!=|<|>)\s*([0-9.]+)/);if(!u)continue;let[,d,f]=u,g=He(d,f);g&&(g.severity==="critical"&&t++,g.severity==="high"&&n++,o+=`
- ${d}==${f}: ${g.description} (${g.cve}, ${g.severity}) - upgrade to ${g.pattern}`)}}catch{}return{criticalCount:t,highCount:n,warnings:o}}function Re(e){if(An())return r("dependency-version-check","Skipping dependency check (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),c();r("dependency-version-check","Starting dependency version check");let t=e.project_dir||l(),n=`${t}/.claude/feedback/dependency-check-cache.json`,o=S(`${t}/package.json`),s=S(`${t}/requirements.txt`),i=S(`${t}/pyproject.toml`),a=S(`${t}/go.mod`);if(!o&&!s&&!i&&!a)return r("dependency-version-check","No package files found, skipping check"),K(n,"none"),c();let p=Jn(n);if(p!==null)return r("dependency-version-check","Using cached dependency warnings"),p!=="none"?P(`DEPENDENCY SECURITY CHECK (cached): ${p}`):c();let u=0,d=0,f="";if(o){let g=Wn(`${t}/package.json`);u+=g.criticalCount,d+=g.highCount,g.warnings&&(f+=`

Node.js (package.json):${g.warnings}`)}if(s){let g=Bn(`${t}/requirements.txt`);u+=g.criticalCount,d+=g.highCount,g.warnings&&(f+=`

Python (requirements.txt):${g.warnings}`)}if(f){let g=`Found ${u} critical and ${d} high severity vulnerabilities`,W=`DEPENDENCY SECURITY CHECK: ${g}${f}

Run 'npm audit' or 'pip-audit' for full details.`;if(K(n,W),r("dependency-version-check",g),u>0||d>0)return P(W)}else K(n,"none"),r("dependency-version-check","No known vulnerabilities found");return c()}var Oe=[{name:"mem0-context-retrieval",fn:I},{name:"mem0-analytics-tracker",fn:b},{name:"pattern-sync-pull",fn:H},{name:"multi-instance-init",fn:$},{name:"instance-heartbeat",fn:v},{name:"session-env-setup",fn:E},{name:"session-tracking",fn:T}];async function Ee(e){let t=await Promise.allSettled(Oe.map(async o=>{try{let s=o.fn(e);return s instanceof Promise&&await s,{hook:o.name,status:"success"}}catch(s){let i=s instanceof Error?s.message:String(s);return r("session-start-dispatcher",`${o.name} failed: ${i}`),{hook:o.name,status:"error",message:i}}})),n=[];for(let o of t)o.status==="rejected"?n.push("unknown"):o.value.status==="error"&&n.push(o.value.hook);return n.length>0&&r("session-start-dispatcher",`${n.length}/${Oe.length} hooks failed: ${n.join(", ")}`),c()}var Ce={"lifecycle/analytics-consent-check":Q,"lifecycle/coordination-cleanup":te,"lifecycle/coordination-init":oe,"lifecycle/instance-heartbeat":v,"lifecycle/mem0-analytics-tracker":b,"lifecycle/mem0-context-retrieval":I,"lifecycle/mem0-webhook-setup":ce,"lifecycle/multi-instance-init":$,"lifecycle/pattern-sync-pull":H,"lifecycle/pattern-sync-push":le,"lifecycle/pr-status-enricher":de,"lifecycle/session-cleanup":fe,"lifecycle/session-context-loader":he,"lifecycle/session-env-setup":E,"lifecycle/session-tracking":T,"lifecycle/session-metrics-summary":we,"lifecycle/dependency-version-check":Re,"lifecycle/unified-dispatcher":Ee};function ps(e){return Ce[e]}function ds(){return Object.keys(Ce)}export{po as escapeRegex,Ke as estimateTokenCount,Ve as extractIssueNumber,G as getCachedBranch,Je as getCurrentBranch,ko as getDefaultBranch,uo as getField,Be as getGitStatus,ps as getHook,z as getLogDir,Ne as getLogLevel,Qn as getPluginRoot,l as getProjectDir,yo as getRepoRoot,m as getSessionId,So as hasUncommittedChanges,Ce as hooks,Vn as isBashInput,Gn as isEditInput,ho as isGitRepo,We as isProtectedBranch,qn as isReadInput,zn as isWriteInput,ds as listHooks,r as logHook,io as logPermissionFeedback,lo as normalizeCommand,no as outputAllowWithContext,to as outputBlock,so as outputDeny,oo as outputError,Ae as outputPromptContext,co as outputPromptContextBudgeted,eo as outputSilentAllow,c as outputSilentSuccess,ro as outputWarning,P as outputWithContext,ao as readHookInput,Le as shouldLog,_o as validateBranchName};
//# sourceMappingURL=lifecycle.mjs.map
