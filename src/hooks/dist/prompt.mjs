// OrchestKit Hooks - prompt bundle
// Generated: 2026-02-28T17:17:04.801Z

var Bt=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,n)=>(typeof require<"u"?require:e)[n]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});function Qs(t){return typeof t.command=="string"}function Zs(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function ta(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function ea(t){return typeof t.file_path=="string"&&t.content===void 0}import{existsSync as J,statSync as qn,renameSync as Jn,mkdirSync as Qt,readSync as Kn,readFileSync as Xn,writeFileSync as Vn}from"node:fs";import{join as Yn}from"node:path";import{appendFileSync as Tn,mkdirSync as vn}from"node:fs";import{dirname as In}from"node:path";var q=[],yt=!1,Wt=!1;function I(t,e){q.push({filePath:t,content:e}),En()}function bt(){if(yt||q.length===0)return;yt=!0;let t=new Map;for(let e of q){let n=t.get(e.filePath);n?n.push(e.content):t.set(e.filePath,[e.content])}for(let[e,n]of t)try{vn(In(e),{recursive:!0}),Tn(e,n.join(""))}catch{}q.length=0,yt=!1}function En(){Wt||(Wt=!0,process.on("exit",bt),process.on("SIGTERM",()=>{bt(),process.exit(0)}),process.on("SIGINT",()=>{bt(),process.exit(0)}))}import{execSync as Qn}from"node:child_process";import zt from"node:os";import N from"node:path";function P(){return process.env.HOME||process.env.USERPROFILE||zt.homedir()}function Rn(){return zt.tmpdir()}function kt(){return process.env.CLAUDE_PROJECT_DIR||"."}function qt(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function Jt(){return process.env.CLAUDE_PLUGIN_ROOT?N.join(P(),".claude","logs","ork"):N.join(kt(),".claude","logs")}function Kt(t){return N.join(Rn(),`claude-context-tracking-${t}.json`)}var ca=N.join,ua=N.sep;import{execSync as Cn}from"node:child_process";import{createHash as Pn}from"node:crypto";import{existsSync as Xt,readFileSync as An,writeFileSync as Dn,mkdirSync as $n}from"node:fs";import{join as _t,basename as On}from"node:path";var jn=20,Mn=15,Nn=/[^a-z0-9-]/g;function Hn(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=On(e);return Vt(n,jn)}function Ln(t){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=Cn("git branch --show-current",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),r=Vt(n||"detached",Mn);return process.env.ORCHESTKIT_SESSION_BRANCH=r,r}catch{return"nobranch"}}function Fn(t){let e=t||new Date,n=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${n}${r}`}function Un(t){let e=t||new Date,n=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0");return`${n}${r}`}function Gn(){let t=`${process.pid}-${Date.now()}-${Math.random()}`;return Pn("sha256").update(t).digest("hex").slice(0,4)}function Vt(t,e){return t.toLowerCase().replace(Nn,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,e)}function Bn(t,e){let n=Hn(t),r=Ln(t),o=Fn(e),i=Un(e),s=Gn();return`${n}-${r}-${o}-${i}-${s}`}function Wn(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=_t(e,".instance","session-id.json");if(Xt(n))try{let r=JSON.parse(An(n,"utf8"));if(r.session_id&&r.created_at){let o=Date.now()-new Date(r.created_at).getTime(),i=1440*60*1e3;if(o<i)return r.session_id}}catch{}}function zn(t,e){let n=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),r=_t(n,".instance"),o=_t(r,"session-id.json");try{Xt(r)||$n(r,{recursive:!0}),Dn(o,JSON.stringify({session_id:t,created_at:new Date().toISOString()},null,2))}catch{}}function Yt(t){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let e=Wn(t);if(e)return e;let n=Bn(t);return zn(n,t),n}function Zt(){return Jt()}function g(){return kt()}function St(){return qt()}function wa(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${St()}/.claude/.instance_env`}function y(){return Yt()}function xa(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let e=Qn("git branch --show-current",{cwd:t||g(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function Zn(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Ta(t){return t.replace(/\r\n/g,`
`)}function tr(t){let e=["debug","info","warn","error"];return e.indexOf(t)>=e.indexOf(Zn())}function l(){return{continue:!0,suppressOutput:!0}}function va(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function Ia(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function Ea(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function b(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function Ra(t,e){let n={continue:!0,suppressOutput:!0};return t&&(n.systemMessage=t),e&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:e}),n}function Ca(t,e){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?n.systemMessage=e:n.suppressOutput=!0,n}function Pa(t){return{continue:!0,systemMessage:t}}function Aa(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function Da(t){process.stderr.write(`\u26A0 ${t}
`),process.exit(2)}function $a(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}function Oa(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:t}}}var er=200*1024,nr=100*1024;function te(t,e){if(J(t))try{if(qn(t).size>e){let r=`${t}.old.${Date.now()}`;Jn(t,r)}}catch{}}function ee(t){J(t)||Qt(t,{recursive:!0})}function a(t,e,n="debug"){if(!tr(n))return;let r=Zt(),o=`${r}/hooks.log`;try{ee(r),te(o,er);let i=new Date().toISOString().replace("T"," ").slice(0,19);I(o,`[${i}] [${n.toUpperCase()}] [${t}] ${e}
`)}catch{}}function ja(t,e,n){let r=Zt(),o=`${r}/permission-feedback.log`;try{ee(r),te(o,nr);let i=new Date().toISOString(),s=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",c=n?.session_id||y();I(o,`${i} | ${t} | ${e} | tool=${s} | session=${c}
`)}catch{}}function ne(t){return t.hookSpecificOutput?.additionalContext?t.hookSpecificOutput.additionalContext:t.systemMessage&&typeof t.systemMessage=="string"?t.systemMessage:null}function wt(t){if(!t)return 0;let r=(t.match(/[{};()=><]/g)||[]).length/t.length>.03?2.8:3.5;return Math.ceil(t.length/r)}function Ma(t,e,n,r,o){let i=wt(t);return r?.isOverBudget(n)?(a(e,`Budget exhausted for ${n}, suppressing ${i}t`),l()):(o&&o.trackTokenUsage(e,n,i),b(t))}function K(t){let e=2166136261;for(let n=0;n<t.length;n++)e^=t.charCodeAt(n),e=Math.imul(e,16777619);return(e>>>0).toString(16).padStart(8,"0")}function H(t,e,n,r){let o=Yn(t,e);if(J(o))try{let i=Xn(o,"utf8");if(K(i)===K(n))return a(r,`Rules file ${e} unchanged, skipping write`),!1}catch{}return J(t)||Qt(t,{recursive:!0}),Vn(o,n,"utf8"),a(r,`Wrote rules file: ${o}`),!0}function Na(){try{let t=[],n=Buffer.allocUnsafe(256),r,o=0;for(;;)try{if(r=Kn(o,n,0,256,null),r===0)break;t.push(Buffer.from(n.subarray(0,r)))}catch{break}let i=Buffer.concat(t).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:y(),tool_input:{}}}catch{return{tool_name:"",session_id:y(),tool_input:{}}}}function Ha(t,e){let n=e.replace(/^\./,"").split("."),r=t;for(let o of n){if(r==null)return;r=r[o]}return r}function La(t,...e){return t.split(`
`).some(n=>e.every(r=>n.includes(r)))}function Fa(t,...e){return t.split(`
`).some(n=>{let r=n.toLowerCase();return e.every(o=>r.includes(o.toLowerCase()))})}function Ua(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function Ga(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var L={AUTO_DISPATCH:85,SKILL_INJECT:80,STRONG_RECOMMEND:70,SUGGEST:50,MINIMUM:40},Wa={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:1200,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};import{existsSync as rr,readFileSync as re,readdirSync as oe}from"node:fs";import{join as Q}from"node:path";var X={keyword:30,phrase:25,context:20,cooccurrence:15,negation:10},or=[/\b(not|don't|doesn't|won't|can't|shouldn't|avoid|without|except|unlike|instead of)\s+/i,/\b(no|never|neither|nor)\s+/i],ir=["continue","also","additionally","and","then","next","follow up","after that"],V=null,xt=null;function sr(t){if(V&&xt===t)return V;let e=new Map;try{let n=oe(t).filter(r=>r.endsWith(".md"));for(let r of n){let o=r.replace(".md",""),i=Q(t,r);try{let c=re(i,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!c)continue;let u=c[1],p=u.match(/^description:\s*(.+)$/m);if(!p)continue;let d=p[1].trim(),f=d.match(/Activates for\s+(.+?)\.?$/i),m=f?d.slice(0,d.indexOf("Activates for")).trim():d,h=[],v=[];if(f){let w=f[1].split(/,\s*/).map(k=>k.trim().toLowerCase());for(let k of w)k.includes(" ")||k.includes("-")?v.push(k):k.length>1&&h.push(k)}let R=u.match(/^skills:\s*\n((?:\s+-\s+.+\n?)+)/m),C;R&&(C=R[1].split(`
`).map(S=>S.replace(/^\s*-\s*/,"").trim()).filter(Boolean)),(h.length>0||v.length>0)&&e.set(o,{keywords:h,phrases:v,description:m||d.split(".")[0],skills:C})}catch{}}}catch{a("intent-classifier","Could not read agents directory")}return V=e,xt=t,e}var Y=null,Tt=null;function ar(t){if(Y&&Tt===t)return Y;let e=new Map;try{let n=oe(t,{withFileTypes:!0}).filter(r=>r.isDirectory()).map(r=>r.name);for(let r of n){let o=Q(t,r,"SKILL.md");if(rr(o))try{let s=re(o,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!s)continue;let c=s[1],u=c.match(/^description:\s*(.+)$/m),p=u?u[1].trim():"",d=c.match(/^tags:\s*\[([^\]]+)\]/m),f=[];d&&(f=d[1].split(",").map(h=>h.trim().toLowerCase().replace(/["']/g,"")).filter(h=>h.length>1));let m=p.toLowerCase().split(/\s+/).filter(h=>h.length>4).slice(0,5);f=[...new Set([...f,...m])],(f.length>0||p)&&e.set(r,{keywords:f,description:p})}catch{}}}catch{a("intent-classifier","Could not read skills directory")}return Y=e,Tt=t,e}function cr(t,e){let n=0,r=[],o=[];for(let s of e)if(new RegExp(`\\b${s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"i").test(t)){let u=s.length>5?25:20;n+=u,r.push(s),o.push({type:"keyword",source:"keyword-match",weight:u,matched:s})}let i=e.length*25;return{score:i>0?Math.min(n/i*100,100):0,matched:r,signals:o}}function ur(t,e){let n=0,r=[],o=[];for(let s of e)if(t.includes(s)){let c=s.split(/\s+/).length*15;n+=c,r.push(s),o.push({type:"phrase",source:"phrase-match",weight:c,matched:s})}let i=e.length*45;return{score:i>0?Math.min(n/i*100,100):0,matched:r,signals:o}}function lr(t,e,n){if(n.length===0)return{score:0,signals:[]};let r=[],o=0;for(let s of ir)if(t.includes(s)){o+=15,r.push({type:"context",source:"continuation-keyword",weight:15,matched:s});break}let i=n.slice(-3).join(" ").toLowerCase();for(let s of e.slice(0,5))i.includes(s)&&(o+=20,r.push({type:"context",source:"history-keyword",weight:20,matched:s}));return{score:Math.min(o,100),signals:r}}function dr(t){let e=[],n=0;for(let r of or)if(r.test(t)){n=25,e.push({type:"negation",source:"negation-detected",weight:-25,matched:t.match(r)?.[0]||"negation"});break}return{penalty:n,signals:e}}function pr(t,e,n){if(n.length===0)return{adjustment:0,signals:[]};let r=0,o=[];for(let i of n)i.agent===t&&e.includes(i.keyword)&&(r+=i.adjustment,o.push({type:i.adjustment>0?"boost":"penalty",source:"calibration",weight:i.adjustment,matched:`${i.keyword}:${t}`}));return{adjustment:r,signals:o}}function gr(t,e,n,r,o){let i=[],s=[],c=cr(t,n.keywords);i.push(...c.signals),s.push(...c.matched);let u=ur(t,n.phrases);i.push(...u.signals),s.push(...u.matched);let p=lr(t,n.keywords,r);i.push(...p.signals);let d=dr(t);i.push(...d.signals);let f=pr(e,s,o);i.push(...f.signals);let m=c.score*(X.keyword/100)+u.score*(X.phrase/100)+p.score*(X.context/100);return m-=d.penalty*(X.negation/100),m+=Math.max(-15,Math.min(15,f.adjustment)),m=Math.max(0,Math.min(100,m)),m<L.MINIMUM?null:{agent:e,confidence:Math.round(m),description:n.description,matchedKeywords:s,signals:i}}function fr(t,e,n){let r=[],o=[],i=0;for(let s of n.keywords)if(new RegExp(`\\b${s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"i").test(t)){let u=s.length>5?25:20;i+=u,o.push(s),r.push({type:"keyword",source:"skill-keyword",weight:u,matched:s})}return i=Math.min(i,100),i<L.MINIMUM?null:{skill:e,confidence:Math.round(i),description:n.description,matchedKeywords:o,signals:r}}function Va(t,e=[],n=[]){let r=St(),o=Q(r,"agents"),i=Q(r,"skills"),s=t.toLowerCase(),c=[],u=[],p=[],d=sr(o);for(let[S,w]of d){let k=gr(s,S,w,e,n);k&&(u.push(k),c.push(...k.signals))}let f=ar(i);for(let[S,w]of f){let k=fr(s,S,w);k&&(p.push(k),c.push(...k.signals))}u.sort((S,w)=>w.confidence-S.confidence),p.sort((S,w)=>w.confidence-S.confidence);let m=u[0],h=m?mr(m.agent,m.matchedKeywords):"general",v=Math.max(m?.confidence||0,p[0]?.confidence||0),R=m!==void 0&&m.confidence>=L.AUTO_DISPATCH,C=p.length>0&&p[0].confidence>=L.SKILL_INJECT;return{agents:u.slice(0,3),skills:p.slice(0,5),intent:h,confidence:v,signals:c,shouldAutoDispatch:R,shouldInjectSkills:C}}function mr(t,e){let n={"api-design":["api","endpoint","rest","graphql","route"],database:["database","schema","migration","sql","query"],authentication:["auth","login","jwt","oauth","session"],frontend:["react","component","ui","form","state"],testing:["test","coverage","mock","fixture","e2e"],devops:["deploy","ci","cd","release","monitor"],"ai-integration":["llm","rag","embedding","langgraph","agent"],security:["security","owasp","xss","injection","csrf"]};for(let[r,o]of Object.entries(n))for(let i of e)if(o.includes(i))return r;return t.includes("backend")||t.includes("api")?"api-design":t.includes("frontend")||t.includes("ui")?"frontend":t.includes("test")?"testing":t.includes("security")?"security":"general"}function Ya(t){return!(t.length<10||/what agents|list agents|available agents|what skills/i.test(t)||/^(yes|no|ok|thanks|done|continue|stop)$/i.test(t.trim()))}function Qa(){V=null,xt=null,Y=null,Tt=null}import{existsSync as F,readFileSync as se,writeFileSync as ae,mkdirSync as hr}from"node:fs";function vt(){return`${g()}/.claude/orchestration`}function It(){let t=y();return`${vt()}/session-${t}.json`}function ce(){return`${g()}/.claude/orchestration/config.json`}function ue(){let t=vt();if(!F(t))try{hr(t,{recursive:!0})}catch{a("orchestration-state",`Failed to create state dir: ${t}`)}}function A(){let t=It();if(F(t))try{let e=se(t,"utf8");return JSON.parse(e)}catch(e){a("orchestration-state",`Failed to load state: ${e}`)}return{sessionId:y(),activeAgents:[],injectedSkills:[],promptHistory:[],maxHistorySize:10,updatedAt:new Date().toISOString()}}function yr(t){ue();let e=It();t.updatedAt=new Date().toISOString();try{ae(e,JSON.stringify(t,null,2))}catch(n){a("orchestration-state",`Failed to save state: ${n}`)}}function j(t){let e=A();return t(e),yr(e),e}function nc(t,e,n){let r={agent:t,taskId:n,confidence:e,dispatchedAt:new Date().toISOString(),status:"pending",retryCount:0,maxRetries:3};return j(o=>{o.activeAgents=o.activeAgents.filter(i=>i.agent!==t),o.activeAgents.push(r)}),a("orchestration-state",`Tracked dispatched agent: ${t} (conf: ${e})`),r}function rc(t,e,n){j(r=>{let o=r.activeAgents.find(i=>i.agent===t);o&&(o.status=e,n&&(o.taskId=n),e==="retrying"&&o.retryCount++)}),a("orchestration-state",`Updated agent status: ${t} -> ${e}`)}function oc(t){j(e=>{e.activeAgents=e.activeAgents.filter(n=>n.agent!==t)})}function ic(){return A().activeAgents.find(e=>e.status==="in_progress")}function sc(t){return A().activeAgents.some(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function ac(t){j(e=>{e.injectedSkills.includes(t)||e.injectedSkills.push(t)})}function cc(t){return A().injectedSkills.includes(t)}function uc(){return A().injectedSkills}function lc(t){j(e=>{e.promptHistory.push(t),e.promptHistory.length>e.maxHistorySize&&(e.promptHistory=e.promptHistory.slice(-e.maxHistorySize))})}function dc(){return A().promptHistory}function pc(t){j(e=>{e.lastClassification=t})}function gc(){return A().lastClassification}var ie={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:1200,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function Et(){let t=ce();if(F(t))try{let e=se(t,"utf8");return{...ie,...JSON.parse(e)}}catch{}return ie}function fc(t){ue();let e=ce(),r={...Et(),...t};try{ae(e,JSON.stringify(r,null,2))}catch(o){a("orchestration-state",`Failed to save config: ${o}`)}}function mc(){let t=It();try{if(F(t)){let{unlinkSync:e}=Bt("node:fs");e(t),a("orchestration-state","Cleared session state")}}catch{}}function hc(){let t=vt();if(F(t))try{let{readdirSync:e,statSync:n,unlinkSync:r}=Bt("node:fs"),o=e(t).filter(i=>i.startsWith("session-")&&i.endsWith(".json")).map(i=>({name:i,path:`${t}/${i}`,mtime:n(`${t}/${i}`).mtime.getTime()})).sort((i,s)=>s.mtime-i.mtime);for(let i of o.slice(5))try{r(i.path),a("orchestration-state",`Cleaned up old state: ${i.name}`)}catch{}}catch{}}import{existsSync as le,readFileSync as br,writeFileSync as kr,mkdirSync as _r}from"node:fs";function de(){let t=y();return`${g()}/.claude/orchestration/task-registry-${t}.json`}function Sr(){let t=`${g()}/.claude/orchestration`;if(!le(t))try{_r(t,{recursive:!0})}catch{}}function x(){let t=de();if(le(t))try{return JSON.parse(br(t,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:y(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function D(t){Sr();let e=de();t.updatedAt=new Date().toISOString();try{kr(e,JSON.stringify(t,null,2))}catch(n){a("task-integration",`Failed to save registry: ${n}`)}}function wr(t,e){let r={"backend-system-architect":"Designing","frontend-ui-developer":"Building","test-generator":"Writing tests for","security-auditor":"Auditing","workflow-architect":"Architecting","database-engineer":"Implementing database for","llm-integrator":"Integrating LLM for","code-quality-reviewer":"Reviewing","ux-researcher":"Researching UX for","product-strategist":"Strategizing","debug-investigator":"Investigating","frontend-performance-engineer":"Optimizing","accessibility-specialist":"Auditing accessibility for","infrastructure-architect":"Designing infrastructure for","data-pipeline-engineer":"Building pipeline for"}[t]||"Working on",o=e.slice(0,40).toLowerCase();return`${r} ${o}`}function _c(t,e,n,r){let o=t.split("-").map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "),i={source:"orchestration",dispatchedAgent:t,dispatchConfidence:n,...r};return{subject:`${o}: ${e.slice(0,50)}`,description:`Agent dispatched automatically at ${n}% confidence.

${e}`,activeForm:wr(t,e),metadata:i}}function Sc(t,e,n,r){let o={taskId:t,status:e};return n&&n.length>0&&(o.addBlockedBy=n),r&&r.length>0&&(o.addBlocks=r),o}function wc(t){return`### Create Task for Tracking

\`\`\`
TaskCreate:
  subject: "${t.subject}"
  description: "${t.description}"
  activeForm: "${t.activeForm}"
  metadata:
    source: "${t.metadata.source}"
    dispatchedAgent: "${t.metadata.dispatchedAgent||""}"
    dispatchConfidence: ${t.metadata.dispatchConfidence||0}
\`\`\``}function xc(t,e){return{taskId:t,status:"deleted"}}function Tc(t,e){return`### Delete Orphaned Task

\`\`\`
TaskUpdate:
  taskId: "${t}"
  status: "deleted"
\`\`\`

**Reason**: ${e}`}function vc(t){let e=`### Update Task

\`\`\`
TaskUpdate:
  taskId: "${t.taskId}"`;return t.status&&(e+=`
  status: "${t.status}"`),t.addBlockedBy&&t.addBlockedBy.length>0&&(e+=`
  addBlockedBy: ${JSON.stringify(t.addBlockedBy)}`),t.addBlocks&&t.addBlocks.length>0&&(e+=`
  addBlocks: ${JSON.stringify(t.addBlocks)}`),e+="\n```",e}function pe(t,e,n,r,o,i,s){let c=x();if(c.tasks.find(p=>p.taskId===t)){a("task-integration",`Task ${t} already registered`);return}c.tasks.push({taskId:t,agent:e,confidence:n,createdAt:new Date().toISOString(),status:"pending",pipelineId:r,pipelineStep:o,blockedBy:i,blocks:s}),D(c),a("task-integration",`Registered task ${t} for agent ${e}`)}function Ic(t,e){let n=x(),r=n.tasks.find(o=>o.taskId===t);r&&(r.status=e,D(n),a("task-integration",`Updated task ${t} status to ${e}`))}function Ec(t){return x().tasks.find(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function Rc(t){return x().tasks.find(n=>n.taskId===t)}function Cc(t){return x().tasks.filter(n=>n.status==="pending"&&n.blockedBy&&n.blockedBy.includes(t))}function Pc(){let t=x(),e=new Set(t.tasks.filter(n=>n.status==="failed").map(n=>n.taskId));return e.size===0?[]:t.tasks.filter(n=>n.status!=="pending"||!n.blockedBy||n.blockedBy.length===0?!1:n.blockedBy.every(r=>e.has(r)))}function xr(t){return x().tasks.filter(n=>n.pipelineId===t).sort((n,r)=>(n.pipelineStep||0)-(r.pipelineStep||0))}function ge(t){let e=x();if(e.pipelines.find(r=>r.pipelineId===t.pipelineId)){a("task-integration",`Pipeline ${t.pipelineId} already registered`);return}e.pipelines.push(t),D(e),a("task-integration",`Registered pipeline ${t.pipelineId} (${t.type})`)}function Ac(t,e){let n=x(),r=n.pipelines.find(o=>o.pipelineId===t);r&&(Object.assign(r,e),D(n),a("task-integration",`Updated pipeline ${t}`))}function fe(){return x().pipelines.find(e=>e.status==="running")}function Dc(t,e){let n=x(),r=n.pipelines.find(i=>i.pipelineId===t);if(!r)return null;r.completedSteps.includes(e)||(r.completedSteps.push(e),r.completedSteps.sort((i,s)=>i-s));let o=xr(t);for(let i of o){let s=i.pipelineStep;if(s===void 0||r.completedSteps.includes(s)||i.status!=="pending")continue;if(s===0||r.completedSteps.includes(s-1))return r.currentStep=s,D(n),s}return r.status="completed",D(n),null}function $c(t=1440*60*1e3){let e=x(),n=Date.now()-t;e.tasks=e.tasks.filter(r=>r.status==="pending"||r.status==="in_progress"?!0:new Date(r.createdAt).getTime()>n),e.pipelines=e.pipelines.filter(r=>r.status==="running"?!0:new Date(r.startedAt).getTime()>n),D(e)}var Tr=3,vr=1e3,Ir=3e4,Er={"backend-system-architect":["database-engineer","api-designer"],"frontend-ui-developer":["rapid-ui-designer","accessibility-specialist"],"test-generator":["debug-investigator","code-quality-reviewer"],"security-auditor":["security-layer-auditor"],"workflow-architect":["llm-integrator","data-pipeline-engineer"]},Rr=[{test:t=>/permission denied/i.test(t)},{test:t=>/access denied/i.test(t)},{test:t=>/not found/i.test(t)&&/file|module|package/i.test(t)},{test:t=>/(?:file|module|package)\s+not\s+found/i.test(t)},{test:t=>/missing required/i.test(t)},{test:t=>/invalid (?:api|token|key)/i.test(t)},{test:t=>/authentication failed/i.test(t)},{test:t=>/quota exceeded/i.test(t)},{test:t=>/rate limit/i.test(t)}],Cr=[/not my specialization/i,/outside my scope/i,/better suited for/i,/consider using/i,/specialized agent/i];function Pr(t,e=vr){let n=e*2**(t-1),r=Math.random()*.1*n;return Math.min(n+r,Ir)}function Ar(t){for(let e of Rr)if(e.test(t))return!1;return!0}function Dr(t){for(let e of Cr)if(e.test(t))return!0;return!1}function Rt(t,e=[]){let n=Er[t];if(n){for(let r of n)if(!e.includes(r))return r}}function Mc(t,e,n,r=[],o=Tr){if(a("retry-manager",`Evaluating retry for ${t}, attempt ${e}`),e>=o){let s=Rt(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:o,alternativeAgent:s,reason:`Max retries (${o}) exceeded`+(s?`. Consider trying ${s} instead.`:"")}}if(!Ar(n)){let s=Rt(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:o,alternativeAgent:s,reason:`Non-retryable error detected: ${n.slice(0,100)}`}}if(Dr(n)){let s=Rt(t,r);if(s)return{shouldRetry:!1,retryCount:e,maxRetries:o,alternativeAgent:s,reason:`Error suggests using alternative agent: ${s}`}}let i=Pr(e);return{shouldRetry:!0,retryCount:e,maxRetries:o,delayMs:i,reason:`Retrying (attempt ${e+1}/${o}) after ${Math.round(i/1e3)}s`}}function Nc(t,e,n){return{agent:t,taskId:n,attemptNumber:e,startedAt:new Date().toISOString()}}function Hc(t,e,n){let r=new Date().toISOString(),o=new Date(r).getTime()-new Date(t.startedAt).getTime();return{...t,completedAt:r,outcome:e,error:n,durationMs:o}}function Lc(t){if(t.length===0)return{successRate:0,avgDuration:0,commonErrors:[]};let n=t.filter(c=>c.outcome==="success").length/t.length,r=t.filter(c=>c.durationMs!==void 0).map(c=>c.durationMs),o=r.length>0?r.reduce((c,u)=>c+u,0)/r.length:0,i=new Map;for(let c of t)if(c.error){let u=c.error.slice(0,50).toLowerCase();i.set(u,(i.get(u)||0)+1)}let s=Array.from(i.entries()).sort((c,u)=>u[1]-c[1]).slice(0,3).map(([c])=>c);return{successRate:n,avgDuration:o,commonErrors:s}}function Fc(t,e){return{...t,status:"retrying",retryCount:e.retryCount}}function Uc(t,e){if(t.shouldRetry)return`## Retry Scheduled

Agent \`${e}\` will retry after ${Math.round((t.delayMs||0)/1e3)} seconds.

**Attempt:** ${t.retryCount+1} of ${t.maxRetries}
**Reason:** ${t.reason}`;let n=`## Retry Not Recommended

Agent \`${e}\` has ${t.retryCount>=t.maxRetries?"exhausted retries":"encountered a non-retryable error"}.

**Reason:** ${t.reason}`;return t.alternativeAgent&&(n+=`

### Alternative Suggestion

Consider using \`${t.alternativeAgent}\` instead:

\`\`\`
Task tool with subagent_type: "${t.alternativeAgent}"
\`\`\``),n}import{existsSync as be,readFileSync as $r,writeFileSync as Or,mkdirSync as jr}from"node:fs";import{createHash as Mr}from"node:crypto";var me=500,Ct=3,he=15,ye=3,Nr=.9;function ke(){return`${g()}/.claude/feedback/calibration-data.json`}function Hr(){let t=`${g()}/.claude/feedback`;if(!be(t))try{jr(t,{recursive:!0})}catch{}}function U(){let t=ke();if(be(t))try{return JSON.parse($r(t,"utf8"))}catch{a("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function Lr(t){Hr();let e=ke();t.updatedAt=new Date().toISOString();try{Or(e,JSON.stringify(t,null,2)),a("calibration-engine","Saved calibration data")}catch(n){a("calibration-engine",`Failed to save calibration data: ${n}`)}}function Fr(t){return Mr("sha256").update(t.toLowerCase().trim()).digest("hex").slice(0,16)}function qc(t,e,n,r,o,i,s){let c=U(),u={timestamp:new Date().toISOString(),sessionId:y(),agent:e,promptHash:Fr(t),matchedKeywords:n,dispatchConfidence:r,outcome:o,durationMs:i,feedback:s};c.records.push(u),c.records.length>me&&(c.records=c.records.slice(-me)),Ur(c,u),Gr(c),Lr(c),a("calibration-engine",`Recorded outcome: ${e} -> ${o} (conf: ${r})`)}function Ur(t,e){let n=e.outcome==="success",r=e.outcome==="failure"||e.outcome==="rejected";if(!n&&!r)return;let o=n?ye:-ye;for(let i of e.matchedKeywords){let s=t.adjustments.find(c=>c.keyword===i&&c.agent===e.agent);s?(s.adjustment=Math.max(-he,Math.min(he,s.adjustment+o)),s.sampleCount++,s.lastUpdated=new Date().toISOString()):t.adjustments.push({keyword:i,agent:e.agent,adjustment:o,sampleCount:1,lastUpdated:new Date().toISOString()})}}function Jc(t){let e=Date.now(),n=1440*60*1e3;for(let r of t.adjustments){let o=e-new Date(r.lastUpdated).getTime();Math.floor(o/n)>7&&(r.adjustment=Math.round(r.adjustment*Nr),Math.abs(r.adjustment)<1&&(r.adjustment=0))}t.adjustments=t.adjustments.filter(r=>r.adjustment!==0)}function Gr(t){let e=t.records;if(e.length===0)return;t.stats.totalDispatches=e.length;let n=e.filter(i=>i.outcome==="success").length;t.stats.successRate=n/e.length;let r=e.reduce((i,s)=>i+s.dispatchConfidence,0)/e.length;t.stats.avgConfidence=Math.round(r);let o=new Map;for(let i of e){let s=o.get(i.agent)||{count:0,success:0};s.count++,i.outcome==="success"&&s.success++,o.set(i.agent,s)}t.stats.topAgents=Array.from(o.entries()).map(([i,s])=>({agent:i,count:s.count,successRate:s.success/s.count})).sort((i,s)=>s.count-i.count).slice(0,10)}function Kc(){return U().adjustments.filter(e=>e.sampleCount>=Ct)}function Xc(t){let n=U().records.filter(o=>o.agent===t);return n.length<Ct?null:n.filter(o=>o.outcome==="success").length/n.length}function Vc(){return U().stats}function Yc(){return U().records.length>=Ct}function _e(){return!!(process.env.CLAUDE_CODE_TEAM_NAME||process.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS==="1")}var Se=[{type:"product-thinking",name:"Product Thinking Pipeline",description:"Full product discovery and specification workflow",triggers:["should we build","product decision","feature validation","market research","user research"],steps:[{agent:"market-intelligence",description:"Analyze competitive landscape and market trends",dependsOn:[],skills:["market-research"],estimatedTokens:3e3},{agent:"ux-researcher",description:"Create personas and map user journeys",dependsOn:[0],skills:["user-research"],estimatedTokens:2500},{agent:"product-strategist",description:"Validate value proposition and alignment",dependsOn:[0,1],skills:["product-strategy"],estimatedTokens:2e3},{agent:"prioritization-analyst",description:"Score and prioritize using frameworks",dependsOn:[2],skills:["prioritization"],estimatedTokens:1500},{agent:"business-case-builder",description:"Build ROI and cost-benefit analysis",dependsOn:[2,3],skills:["business-case"],estimatedTokens:2e3},{agent:"requirements-translator",description:"Transform to PRD and user stories",dependsOn:[4],skills:["requirements"],estimatedTokens:2500}],estimatedTotalTokens:13500},{type:"full-stack-feature",name:"Full-Stack Feature Pipeline",description:"End-to-end feature implementation workflow",triggers:["full-stack feature","build a feature","implement end-to-end","create full feature","add complete feature"],steps:[{agent:"backend-system-architect",description:"Design API and database schema",dependsOn:[],skills:["api-design","database-patterns"],estimatedTokens:3e3},{agent:"frontend-ui-developer",description:"Build React components and UI",dependsOn:[0],skills:["react-server-components-framework","form-state-patterns"],estimatedTokens:3500},{agent:"test-generator",description:"Create unit and integration tests",dependsOn:[0,1],skills:["testing-patterns"],estimatedTokens:2e3},{agent:"security-auditor",description:"Audit for vulnerabilities",dependsOn:[0,1],skills:["security-patterns"],estimatedTokens:1500}],estimatedTotalTokens:1e4},{type:"ai-integration",name:"AI Integration Pipeline",description:"Add AI/LLM capabilities to application",triggers:["add rag","add llm","ai integration","implement rag","add ai feature","langgraph workflow"],steps:[{agent:"workflow-architect",description:"Design LangGraph workflow and state",dependsOn:[],skills:["langgraph"],estimatedTokens:2500},{agent:"llm-integrator",description:"Connect LLM APIs with function calling",dependsOn:[0],skills:["llm-integration"],estimatedTokens:2e3},{agent:"data-pipeline-engineer",description:"Build embeddings and data pipeline",dependsOn:[0],skills:["embeddings","rag-retrieval"],estimatedTokens:2500},{agent:"test-generator",description:"Create LLM testing infrastructure",dependsOn:[1,2],skills:["testing-patterns"],estimatedTokens:1500}],estimatedTotalTokens:8500},{type:"security-audit",name:"Security Audit Pipeline",description:"Comprehensive security review workflow",triggers:["security audit","security review","vulnerability scan","security assessment"],steps:[{agent:"security-auditor",description:"Scan for OWASP Top 10 vulnerabilities",dependsOn:[],skills:["security-patterns"],estimatedTokens:2e3},{agent:"security-layer-auditor",description:"Verify defense-in-depth layers",dependsOn:[0],skills:["security-patterns"],estimatedTokens:2e3},{agent:"ai-safety-auditor",description:"Audit AI/LLM security if applicable",dependsOn:[0],skills:["mcp-security-hardening"],estimatedTokens:1500}],estimatedTotalTokens:5500},{type:"frontend-compliance",name:"Frontend 2026 Compliance Pipeline",description:"Modernize frontend to 2026 patterns",triggers:["frontend compliance","modernize frontend","update react","frontend 2026"],steps:[{agent:"frontend-ui-developer",description:"Upgrade to React 19 patterns",dependsOn:[],skills:["react-server-components-framework","zustand-patterns"],estimatedTokens:3e3},{agent:"frontend-performance-engineer",description:"Optimize Core Web Vitals",dependsOn:[0],skills:["performance"],estimatedTokens:2e3},{agent:"accessibility-specialist",description:"Ensure WCAG 2.2 compliance",dependsOn:[0],skills:["testing-patterns","accessibility"],estimatedTokens:1500}],estimatedTotalTokens:6500}];function we(t){if(_e())return a("multi-agent-coordinator","Agent Teams active \u2014 yielding pipeline detection to native Teams"),null;let e=t.toLowerCase();for(let n of Se)for(let r of n.triggers)if(e.includes(r))return a("multi-agent-coordinator",`Detected pipeline: ${n.type} (trigger: "${r}")`),n;return null}function ru(t){return Se.find(e=>e.type===t)||null}function xe(t){let e=`pipeline-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,n=[],r={};for(let i=0;i<t.steps.length;i++){let s=t.steps[i],c=`task-${e}-${i}`;r[i]=c;let u={source:"pipeline",dispatchedAgent:s.agent,pipelineId:e,pipelineStep:i,relatedSkills:s.skills},p=s.dependsOn.map(d=>r[d]).filter(Boolean);n.push({subject:`[${t.name}] Step ${i+1}: ${s.description}`,description:`Pipeline step: ${s.agent}

${s.description}

Estimated tokens: ${s.estimatedTokens}`,activeForm:`Running ${s.agent}`,metadata:u,blockedBy:p.length>0?p:void 0})}return{execution:{pipelineId:e,type:t.type,startedAt:new Date().toISOString(),taskIds:r,currentStep:0,completedSteps:[],status:"running"},tasks:n}}function Te(t,e){ge(t);for(let n=0;n<e.length;n++){let r=e[n],o=t.taskIds[n];o&&r.metadata.dispatchedAgent&&pe(o,r.metadata.dispatchedAgent,r.metadata.dispatchConfidence||100,t.pipelineId,n)}a("multi-agent-coordinator",`Registered pipeline ${t.pipelineId} with ${e.length} tasks`)}function ve(t,e,n){let r=`## \u{1F504} Pipeline Detected: ${t.name}

${t.description}

**Pipeline ID:** \`${e.pipelineId}\`
**Estimated Total Tokens:** ~${t.estimatedTotalTokens}

### Pipeline Steps

`;for(let o=0;o<t.steps.length;o++){let i=t.steps[o],s=i.dependsOn.length>0?` (after steps: ${i.dependsOn.map(c=>c+1).join(", ")})`:" (can start immediately)";r+=`**${o+1}. ${i.agent}**${s}
   ${i.description}
   Skills: ${i.skills?.join(", ")||"none"}

`}r+=`### Task Creation Instructions

Create these tasks to track the pipeline:

`;for(let o=0;o<n.length;o++){let i=n[o];r+=`**Task ${o+1}:**
\`\`\`
TaskCreate:
  subject: "${i.subject}"
  activeForm: "${i.activeForm}"
${i.blockedBy?`  blockedBy: ${JSON.stringify(i.blockedBy)}`:""}
\`\`\`

`}return r+=`### Start Pipeline

After creating all tasks, spawn the first agent:

\`\`\`
Task tool with subagent_type: "${t.steps[0].agent}"
\`\`\`

The orchestration layer will track progress and suggest next agents as steps complete.`,r}import{existsSync as B,readFileSync as Le,writeFileSync as Fe,mkdirSync as Ue}from"node:fs";import{join as rt,dirname as co}from"node:path";import{existsSync as Br,readFileSync as Wr,writeFileSync as su,mkdirSync as au}from"node:fs";import{execSync as Ie}from"node:child_process";import{createHash as zr}from"node:crypto";import*as Ee from"node:os";var qr=".claude/.user_identity.json",Jr="orchestkit-user-identity-v1";var _=null;function Z(t){return zr("sha256").update(t+Jr).digest("hex").slice(0,32)}function Kr(){try{return Ee.hostname()}catch{return"unknown-machine"}}function Xr(t){let e=`${t}/${qr}`;if(!Br(e))return null;try{let n=Wr(e,"utf8");return JSON.parse(n)}catch(n){return a("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function Vr(t){let e={};try{e.email=Ie("git config user.email",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{e.name=Ie("git config user.name",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return e}function Yr(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function tt(t){if(_)return _;let e=t||g(),n=Kr(),r=Xr(e);if(r?.user_id)return _={user_id:r.user_id,display_name:r.display_name||r.user_id,team_id:r.team_id,machine_id:n,source:"config",anonymous_id:Z(r.user_id),email:r.user_id.includes("@")?r.user_id:void 0},a("user-identity",`Resolved from config: ${_.anonymous_id}`,"debug"),_;let o=Vr(e);if(o.email)return _={user_id:o.email,display_name:o.name||o.email.split("@")[0],team_id:r?.team_id,machine_id:n,source:"git",anonymous_id:Z(o.email),email:o.email},a("user-identity",`Resolved from git: ${_.anonymous_id}`,"debug"),_;let i=Yr();if(i.username){let c=`${i.username}@${n}`;return _={user_id:c,display_name:i.username,team_id:r?.team_id,machine_id:n,source:"env",anonymous_id:Z(c)},a("user-identity",`Resolved from env: ${_.anonymous_id}`,"debug"),_}let s=Z(n+process.pid);return _={user_id:`anon-${s.slice(0,8)}`,display_name:"Anonymous",team_id:r?.team_id,machine_id:n,source:"anonymous",anonymous_id:s},a("user-identity",`Resolved as anonymous: ${_.anonymous_id}`,"debug"),_}function et(){let t=tt();return{session_id:y(),user_id:t.user_id,anonymous_id:t.anonymous_id,team_id:t.team_id,machine_id:t.machine_id,identity_source:t.source,timestamp:new Date().toISOString()}}import{existsSync as Pe,mkdirSync as Qr,readFileSync as Zr,writeFileSync as to}from"node:fs";var eo=/^[a-zA-Z0-9_-]{1,128}$/;function no(t){return eo.test(t)}function Dt(t,e){let n=t||y(),r=e||g();if(!no(n))throw new Error("Invalid session ID format");return`${r}/.claude/memory/sessions/${n}`}function ro(t,e){return`${Dt(t,e)}/events.jsonl`}function Ae(t,e){let n=Dt(t,e);Pe(n)||Qr(n,{recursive:!0})}var G=0,Re=!1,Pt=!1,Ce=0,oo=5e3;function De(t,e){return`${Dt(t,e)}/counter.json`}function io(t,e){if(!Re){Re=!0;try{let n=De(t,e);if(Pe(n)){let r=JSON.parse(Zr(n,"utf8"));typeof r.counter=="number"&&r.counter>0&&(G=r.counter,a("session-tracker",`Loaded event counter: ${G}`,"debug"))}}catch{}}}function so(t,e){if(!Pt)return;let n=Date.now();if(!(n-Ce<oo))try{Ae(t,e);let r=De(t,e);to(r,JSON.stringify({counter:G,updated_at:new Date().toISOString()})),Pt=!1,Ce=n}catch{}}function ao(){return io(),G++,Pt=!0,so(),`evt-${Date.now()}-${G}`}function M(t,e,n={}){try{let r={event_id:ao(),event_type:t,identity:et(),payload:{name:e,input:At(n.input),output:At(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?Ne(n.context,500):void 0,confidence:n.confidence}};Ae();let o=ro();I(o,`${JSON.stringify(r)}
`),a("session-tracker",`Tracked ${t}: ${e}`,"debug")}catch(r){a("session-tracker",`Failed to track event: ${r}`,"warn")}}function $e(t,e,n){M("decision_made","decision",{context:t,input:e?{rationale:e}:void 0,confidence:n,success:!0})}function Oe(t,e){M("preference_stated","preference",{context:t,confidence:e,success:!0})}function je(t){M("problem_reported","problem",{context:t,success:!0})}function Me(t){M("communication_style_detected","communication",{input:t,success:!0})}function Ne(t,e){return t.length<=e?t:`${t.slice(0,e-3)}...`}function At(t){if(!t)return;let e={},n=["password","secret","token","key","credential","auth"];for(let[r,o]of Object.entries(t)){if(n.some(i=>r.toLowerCase().includes(i))){e[r]="[REDACTED]";continue}if(typeof o=="string"&&o.length>500){e[r]=Ne(o,500);continue}if(typeof o=="object"&&o!==null&&!Array.isArray(o)){e[r]=At(o);continue}e[r]=o}return e}var nt=2;var uo={1:t=>({...t,version:2,tool_preferences:t.tool_preferences||{},tool_usage_by_category:t.tool_usage_by_category||{}})};function lo(t){let e=t.version||1;for(;e<nt;){let n=uo[e];if(!n){a("user-profile",`Missing migration for version ${e}`,"warn");break}t=n(t),e=t.version,a("user-profile",`Migrated profile to version ${e}`,"info")}return t}function po(){return P()}function go(){return rt(po(),".claude","orchestkit")}function Ge(t){let e=t.replace(/[^a-zA-Z0-9@._-]/g,"_");return rt(go(),"users",e)}function $t(t){return rt(Ge(t),"profile.json")}function fo(t){let e=t.replace(/[^a-zA-Z0-9@._-]/g,"_");return rt(g(),".claude","memory","users",e,"profile.json")}function mo(t){let e=fo(t),n=$t(t);if(B(n))return!1;if(B(e))try{let r=co(n);B(r)||Ue(r,{recursive:!0});let o=Le(e,"utf8"),i=JSON.parse(o);Fe(n,JSON.stringify(i,null,2));let s=t.replace(/@.*$/,"@***");return a("user-profile",`Migrated profile for ${s} to cross-project storage`,"info"),!0}catch(r){return a("user-profile",`Failed to migrate profile: ${r}`,"warn"),!1}return!1}function He(t){let e=tt(),n=new Date().toISOString();return{user_id:t,anonymous_id:e.anonymous_id,display_name:e.display_name,team_id:e.team_id,sessions_count:0,first_seen:n,last_seen:n,version:nt,skill_usage:{},agent_usage:{},tool_usage:{},decisions:[],preferences:[],workflow_patterns:[],aggregated_sessions:[]}}function Be(t){let e=t||tt().user_id;mo(e);let n=$t(e);if(!B(n))return He(e);try{let r=Le(n,"utf8"),o=JSON.parse(r),i=lo(o);return(o.version||1)<nt&&(ho(i),a("user-profile",`Auto-saved migrated profile (v${nt})`,"info")),i}catch(r){return a("user-profile",`Failed to load profile: ${r}`,"warn"),He(e)}}function ho(t){let e=Ge(t.user_id),n=$t(t.user_id);try{return B(e)||Ue(e,{recursive:!0}),t.last_seen=new Date().toISOString(),Fe(n,JSON.stringify(t,null,2)),a("user-profile",`Saved profile for ${t.anonymous_id}`,"debug"),!0}catch(r){return a("user-profile",`Failed to save profile: ${r}`,"error"),!1}}function We(t,e=5){return Object.entries(t.skill_usage).map(([n,r])=>({skill:n,stats:r})).sort((n,r)=>r.stats.count-n.stats.count).slice(0,e)}function ze(t,e=5){return Object.entries(t.agent_usage).map(([n,r])=>({agent:n,stats:r})).sort((n,r)=>r.stats.count-n.stats.count).slice(0,e)}function qe(t,e=10){return t.decisions.slice(0,e)}var Ot=1200,yo=3,bo=3,ko=2,Je=50,_o=2;function So(t,e=yo){let n=We(t,e);return n.length===0?"":n.map(r=>r.skill).join(", ")}function wo(t,e=bo){let n=ze(t,e);return n.length===0?"":n.map(r=>r.agent).join(", ")}function xo(t,e=ko){let n=qe(t,e);return n.length===0?"":n.map(r=>r.what).map(r=>r.length>Je?`${r.slice(0,Je-3)}...`:r).join("; ")}function To(t,e=_o){return t.preferences.length===0?"":t.preferences.slice(0,e).map(n=>`${n.category}: ${n.preference}`).join(", ")}function vo(t){return t.sessions_count>0||Object.keys(t.skill_usage).length>0||Object.keys(t.agent_usage).length>0||t.decisions.length>0||t.preferences.length>0}function Io(t){let e=[];e.push(`## User Profile Context
`);let n=t.display_name||"User";t.sessions_count>0?e.push(`Working with **${n}** (${t.sessions_count} sessions)`):e.push(`Working with **${n}**`);let r=So(t);r&&e.push(`

**Preferred skills:** ${r}`);let o=wo(t);o&&e.push(`

**Frequently used agents:** ${o}`);let i=xo(t);i&&e.push(`

**Recent decisions:** ${i}`);let s=To(t);s&&e.push(`

**Preferences:** ${s}`);let c=e.join("");return c.length>Ot&&(c=`${c.slice(0,Ot-3)}...`,a("profile-injector",`Context truncated to ${Ot} chars`,"debug")),c}function ot(t){a("profile-injector","Loading user profile for session context");try{let e=Be();if(!vo(e))return a("profile-injector","Empty profile, skipping injection","debug"),l();let n=Io(e),r=`${P()}/.claude/rules`;return H(r,"user-profile.md",n,"profile-injector"),a("profile-injector",`Wrote profile context for ${e.display_name} to rules file (${n.length} chars)`,"info"),l()}catch(e){return a("profile-injector",`Error loading profile: ${e}`,"warn"),l()}}import{existsSync as Eo,readFileSync as Ro}from"node:fs";import{join as Ke}from"node:path";var $="memory-context-loader",Co=10,Po=3e3;function Ao(t,e){try{return Ro(t,"utf8").trim().split(`
`).filter(o=>o.length>0).slice(-e)}catch{return[]}}function Do(t){let e=[];for(let r of t)try{let o=JSON.parse(r);o?.content?.what&&e.push(o)}catch{}let n=new Map;for(let r=0;r<e.length;r++)n.set(e[r].content.what,r);return e.filter((r,o)=>{let i=e[o];return n.get(i.content.what)===o})}function $o(t){let e=[/^selected the directory of/i,/^âš \s*Warning:/i,/^Error:/i,/^inferred your workspace/i];return t.filter(n=>{let r=n.content.what;return!(e.some(o=>o.test(r))||r.trim().length<10)})}function Oo(t){let e=[];e.push("## Recent Project Decisions"),e.push("");for(let n of t){let o=`- **[${n.type==="preference"?"Preference":"Decision"}]** ${n.content.what}`;if(n.content.why&&(o+=` _(because: ${n.content.why})_`),n.entities.length>0&&(o+=` [${n.entities.join(", ")}]`),e.push(o),e.join(`
`).length>Po){e.pop(),e.push("- _(additional decisions available via mcp__memory__search_nodes)_");break}}return e.push(""),e.push("_For deeper graph traversal: use mcp__memory__search_nodes or mcp__memory__open_nodes_"),e.join(`
`)}function it(t){try{let e=t.project_dir||g(),n=Ke(e,".claude","memory","decisions.jsonl");if(!Eo(n))return a($,"No decisions.jsonl found, skipping"),l();let r=Ao(n,Co);if(r.length===0)return a($,"decisions.jsonl is empty, skipping"),l();let o=Do(r);if(o.length===0)return a($,"No valid decisions found in file"),l();let i=$o(o);if(i.length===0)return a($,"All decisions filtered as noise"),l();i.reverse();let s=Oo(i),c=Ke(e,".claude","rules");return H(c,"recent-decisions.md",s,$),a($,`Wrote ${i.length} decisions to rules file (${o.length-i.length} filtered/deduped)`),l()}catch(e){return a($,`Error loading memory context: ${e}`,"warn"),l()}}function st(t){if(/^data:image\//.test(t)||/[A-Za-z0-9+/=]{1024,}/.test(t.slice(0,5e3)))return!0;let e=t.slice(0,2e3);return e.replace(/[\x20-\x7E\n\r\t]/g,"").length/e.length>.3}var jo=[/\b(let'?s use|let'?s go with|going with|will use|should use)\s+([^.,!?\n]+)/gi,/\b(decided on|decided to use|decided to go with|decided to)\s+([^.,!?\n]+)/gi,/\b(chose|choose|selected|opting for|picked)\s+([^.,!?\n]+)/gi,/\b(using)\s+([^.,!?\n]+)\s+for\s+/gi,/\b(chose|prefer|selected|going with)\s+([\w][\w\s-]*?)\s+over\s+([\w][\w\s-]*)/gi,/\b(chose|prefer|selected|going with)\s+([\w][\w\s-]*?)\s+instead of\s+([\w][\w\s-]*)/gi,/\b(implementing|implement)\s+([^.,!?\n]+?)\s+(?:approach|pattern|solution)/gi,/\b(?:the|our)\s+(?:approach|decision|choice)\s+is\s+([^.,!?\n]+)/gi,/\bI\s+(decided|chose)\s+([^.,!?\n]+)/gi],Mo=[/\bi (prefer|like|always use|never use|want|favor)\s+([^.,!?\n]+)/gi,/\bi'd prefer\s+([^.,!?\n]+)/gi,/\b(my preference is|I'd rather|rather use)\s+([^.,!?\n]+)/gi,/\b(style should be|convention is|naming should)\s+([^.,!?\n]+)/gi,/\b(always|never)\s+(use|do|add|include)\s+([^.,!?\n]+)/gi,/\bdon't\s+(use|like|want)\s+([^.,!?\n]+)/gi],No=[/\b(issue|problem|error|bug|doesn't work|isn't working|can't|failing|broken)\b[^.!?\n]*[.!?]?/gi,/\bthe (\w[\w\s-]*) (is broken|isn't working|fails|errors|crashes)/gi,/\b(getting|seeing|having)\s+(an error|errors|issues|problems)\s+(with|in|when)\s+([^.,!?\n]+)/gi,/\b(fails|failed|failing)\s+(to|when|with)\s+([^.,!?\n]+)/gi,/\b(not working|doesn't work|won't work)\s*([^.,!?\n]*)/gi,/\b(timeout|exception|crash|hang|freeze)\s+(in|with|when|on)\s+([^.,!?\n]+)/gi],Ho=[/\bhow do I\s+([^?.\n]+)/gi,/\bhow can I\s+([^?.\n]+)/gi,/\bhow to\s+([^?.\n]+)/gi,/\bwhat is\s+([^?.\n]+)/gi,/\bwhat are\s+([^?.\n]+)/gi,/\bwhat does\s+([^?.\n]+)/gi,/\bwhy does\s+([^?.\n]+)/gi,/\bwhy is\s+([^?.\n]+)/gi,/\bwhy do\s+([^?.\n]+)/gi,/\bcan you\s+(explain|show|help)\s+([^?.\n]+)/gi,/\bwhere (is|are|do|does|can)\s+([^?.\n]+)/gi,/\bwhen (should|do|does|can)\s+([^?.\n]+)/gi],Lo=[/\bbecause\s+([^.,!?\n]+)/i,/\bsince\s+([^.,!?\n]+)/i,/\bdue to\s+([^.,!?\n]+)/i,/\bto avoid\s+([^.,!?\n]+)/i,/\bfor\s+(?:better|improved|faster|easier|simpler)\s+([^.,!?\n]+)/i,/\bso that\s+([^.,!?\n]+)/i,/\bin order to\s+([^.,!?\n]+)/i,/\bas it\s+([^.,!?\n]+)/i],Fo=[/\b(?:must|need to|required|constraint|requirement)\s+([^.,!?\n]+)/gi,/\b(?:have to|has to)\s+([^.,!?\n]+)/gi,/\b(?:mandatory|essential)\s+([^.,!?\n]+)/gi],Uo=[/\b(?:tradeoff|trade-off|downside|drawback)\s*:?\s+([^.,!?\n]+)/gi,/\bbut\s+([^.,!?\n]+)/gi,/\bhowever\s+([^.,!?\n]+)/gi,/\balthough\s+([^.,!?\n]+)/gi,/\b(?:cost|limitation)\s+is\s+([^.,!?\n]+)/gi],Go={postgresql:"postgresql",postgres:"postgresql",pgvector:"pgvector",redis:"redis",mongodb:"mongodb",sqlite:"sqlite",mysql:"mysql",dynamodb:"dynamodb",fastapi:"fastapi",django:"django",flask:"flask",express:"express",nextjs:"nextjs","next.js":"nextjs",nest:"nest",nestjs:"nest",spring:"spring",rails:"rails",react:"react",vue:"vue",angular:"angular",svelte:"svelte",solid:"solid",qwik:"qwik",astro:"astro",typescript:"typescript",python:"python",javascript:"javascript",rust:"rust",go:"go",java:"java",kotlin:"kotlin",jwt:"jwt",oauth:"oauth2",oauth2:"oauth2",passkeys:"passkeys",saml:"saml",oidc:"oauth2",langchain:"langchain",langgraph:"langgraph",langfuse:"langfuse",openai:"openai",anthropic:"anthropic",llama:"llama",docker:"docker",kubernetes:"kubernetes",k8s:"kubernetes",terraform:"terraform",aws:"aws",gcp:"gcp",azure:"azure",pytest:"pytest",jest:"jest",vitest:"vitest",playwright:"playwright",cypress:"cypress",msw:"msw",webpack:"webpack",vite:"vite",esbuild:"esbuild",turbopack:"turbopack",bun:"bun",pnpm:"pnpm",yarn:"yarn"},Bo=Object.entries(Go).map(([t,e])=>{let n=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return[new RegExp(`\\b${n}\\b`,"i"),e]}),Wo=["cursor-pagination","offset-pagination","keyset-pagination","repository-pattern","service-layer","clean-architecture","dependency-injection","event-sourcing","cqrs","saga-pattern","circuit-breaker","rate-limiting","retry-pattern","cache-aside","write-through","read-through","rag","semantic-search","vector-search","tdd","bdd","ddd","microservices","monolith","serverless","rest","graphql","grpc","websocket","sse"],zo=["grep","read","write","edit","glob","bash","task","git","gh","npm","yarn","pnpm","claude","cursor","vscode","vim","neovim"];function at(t){let e=new Set;for(let[n,r]of Bo)n.test(t)&&e.add(r);for(let n of Wo){let r=n.replace(/-/g,"[- ]?");new RegExp(`\\b${r}\\b`,"i").test(t)&&e.add(n)}for(let n of zo)new RegExp(`\\b${n}\\b`,"i").test(t)&&e.add(n);return[...e]}function qo(t,e){let n=Math.max(0,e-50),r=Math.min(t.length,e+300),o=t.slice(n,r);for(let i of Lo){let s=o.match(i);if(s?.[1])return s[1].trim().slice(0,200)}}function Jo(t,e){let n=Math.max(0,e-50),r=Math.min(t.length,e+400),o=t.slice(n,r),i=[];for(let s of Fo){s.lastIndex=0;let c=o.matchAll(s);for(let u of c){let p=(u[1]||u[2]||"").trim().slice(0,200);p.length>5&&i.push(p)}}return[...new Set(i)].slice(0,5)}function Ko(t,e){let n=Math.max(0,e-50),r=Math.min(t.length,e+400),o=t.slice(n,r),i=[];for(let s of Uo){s.lastIndex=0;let c=o.matchAll(s);for(let u of c){let p=(u[1]||u[2]||"").trim().slice(0,200);p.length>5&&i.push(p)}}return[...new Set(i)].slice(0,5)}function Xo(t,e,n,r){let o=.5;return/\b(decided|chose|selected)\b/i.test(t)&&(o+=.2),e&&(o+=.15),n&&(o+=.1),r>=1&&(o+=.05),r>=2&&(o+=.05),t.length<20&&(o-=.1),Math.min(.99,Math.max(.1,o))}function Xe(t){let e=[];if(!t||t.length<10)return{intents:[],decisions:[],preferences:[],questions:[],problems:[],summary:"No intents detected (prompt too short)"};for(let u of jo){let p=t.matchAll(u);for(let d of p){let f=d[0],m=d.index||0,h="",v;if(d[3]?(h=d[2]?.trim()||"",v=[d[3].trim()]):d[2]&&(h=d[2].trim()),!h||h.length<2)continue;let R=qo(t,m),C=at(f+(R||"")),S=Jo(t,m),w=Ko(t,m),k=Xo(f,!!R,!!v,C.length);e.push({type:"decision",confidence:k,text:f.slice(0,300),entities:C,rationale:R,alternatives:v,...S.length>0?{constraints:S}:{},...w.length>0?{tradeoffs:w}:{},position:m})}}for(let u of Mo){let p=t.matchAll(u);for(let d of p){let f=d[0],m=d.index||0,h=at(f);e.push({type:"preference",confidence:h.length>0?.8:.6,text:f.slice(0,300),entities:h,position:m})}}for(let u of No){let p=t.matchAll(u);for(let d of p){let f=d[0],m=d.index||0,h=at(f);e.push({type:"problem",confidence:.75,text:f.slice(0,300),entities:h,position:m})}}for(let u of Ho){let p=t.matchAll(u);for(let d of p){let f=d[0],m=d.index||0,h=at(f);e.push({type:"question",confidence:.8,text:f.slice(0,300),entities:h,position:m})}}let n=Vo(e),r=n.filter(u=>u.type==="decision"&&u.confidence>=.7),o=n.filter(u=>u.type==="preference"),i=n.filter(u=>u.type==="problem"),s=n.filter(u=>u.type==="question"),c=Yo(r,o,i,s);return{intents:n,decisions:r,preferences:o,questions:s,problems:i,summary:c}}function Vo(t){if(t.length<=1)return t;let e=[...t].sort((r,o)=>r.position-o.position),n=[];for(let r of e)if(!n.some(i=>{let s=i.position+i.text.length,c=r.position+r.text.length;return r.position>=i.position&&r.position<s||i.position>=r.position&&i.position<c}))n.push(r);else{let i=n.findIndex(s=>{let c=s.position+s.text.length,u=r.position+r.text.length;return s.type===r.type&&(r.position>=s.position&&r.position<c||s.position>=r.position&&s.position<u)});i>=0&&r.confidence>n[i].confidence&&(n[i]=r)}return n}function Yo(t,e,n,r){let o=[];return t.length>0&&o.push(`${t.length} decision${t.length>1?"s":""}`),e.length>0&&o.push(`${e.length} preference${e.length>1?"s":""}`),n.length>0&&o.push(`${n.length} problem${n.length>1?"s":""}`),r.length>0&&o.push(`${r.length} question${r.length>1?"s":""}`),o.length===0?"No intents detected":`Detected: ${o.join(", ")}`}import{existsSync as jt,mkdirSync as Qo,readFileSync as Zo,writeFileSync as Ve}from"node:fs";import{join as Ye,dirname as Qe,basename as ti}from"node:path";import{homedir as ei}from"node:os";function ni(t){let e=[],n=new Date().toISOString(),r={name:t.id,entityType:oi(t.type),observations:ri(t)},o=t.entities.map(s=>({name:s,entityType:ii(s),observations:[`Mentioned in ${t.type}: ${t.content.what.slice(0,100)}`]}));e.push({type:"create_entities",payload:{entities:[r,...o]},timestamp:n});let i=[];for(let s of t.entities){let c=t.type==="decision"?"CHOSE":t.type==="preference"?"PREFERS":"MENTIONS";i.push({from:t.id,to:s,relationType:c})}if(t.content.alternatives?.length)for(let s of t.content.alternatives)i.push({from:t.content.what,to:s,relationType:"CHOSE_OVER"});if(t.content.constraints?.length)for(let s of t.content.constraints)i.push({from:t.id,to:s,relationType:"CONSTRAINT"});if(t.content.tradeoffs?.length)for(let s of t.content.tradeoffs)i.push({from:t.id,to:s,relationType:"TRADEOFF"});if(t.entities.length>=2)for(let s=0;s<t.entities.length;s++)for(let c=s+1;c<t.entities.length;c++)i.push({from:t.entities[s],to:t.entities[c],relationType:"RELATES_TO"});for(let s of t.relations)i.push({from:s.from,to:s.to,relationType:s.type});return i.length>0&&e.push({type:"create_relations",payload:{relations:i},timestamp:n}),e}function ri(t){let e=[];return e.push(`What: ${t.content.what}`),t.content.why&&e.push(`Rationale: ${t.content.why}`),t.content.alternatives?.length&&e.push(`Alternatives considered: ${t.content.alternatives.join(", ")}`),t.content.constraints?.length&&e.push(`Constraints: ${t.content.constraints.join("; ")}`),t.content.tradeoffs?.length&&e.push(`Tradeoffs: ${t.content.tradeoffs.join("; ")}`),e.push(`Category: ${t.metadata.category}`),e.push(`Confidence: ${(t.metadata.confidence*100).toFixed(0)}%`),e.push(`Source: ${t.metadata.source}`),e.push(`Project: ${t.metadata.project}`),e.push(`Timestamp: ${t.metadata.timestamp}`),e}function oi(t){return{decision:"Decision",preference:"Preference","problem-solution":"Solution",pattern:"Pattern",workflow:"Workflow"}[t]||"Decision"}function ii(t){let e=t.toLowerCase();return["postgresql","postgres","redis","mongodb","fastapi","django","react","vue","angular","typescript","python","docker","kubernetes"].some(i=>e.includes(i))?"Technology":["pagination","pattern","architecture","cqrs","saga","circuit","injection","sourcing","caching","rag"].some(i=>e.includes(i))?"Pattern":["grep","read","write","bash","git","npm","jest","pytest"].some(i=>e.includes(i))?"Tool":"Technology"}function Ze(){let e=g().replace(/[\\/]/g,"-");return Ye(ei(),".claude","projects",e,"memory")}function si(){return Ye(Ze(),"MEMORY.md")}function tn(){try{let t=Ze(),e=Qe(t);return jt(e)}catch{return!1}}function ai(t){let e=[],n=t.type==="decision"?"[Decision]":t.type==="preference"?"[Preference]":t.type==="pattern"?"[Pattern]":"[Note]";return e.push(`- **${n}** ${t.content.what}`),t.content.why&&e.push(`  _(because: ${t.content.why})_`),t.entities.length>0&&e.push(`  ${t.entities.map(r=>`\`${r}\``).join(", ")}`),e.join(`
`)}function ci(t){if(!tn())return!1;try{let e=si(),n=Qe(e);jt(n)||Qo(n,{recursive:!0});let r="";jt(e)&&(r=Zo(e,"utf-8"));let o=`## Recent Project Decisions

`;r.includes("## Recent Project Decisions")||(r=o+r);let i=ai(t);if(r.includes(t.content.what.slice(0,50)))return a("memory-writer","Skipping duplicate in CC native memory","debug"),!0;let s=r.indexOf(o)+o.length,c=r.slice(0,s)+i+`
`+r.slice(s);if(c.split(`
`).filter(d=>d.startsWith("- **[")).length>50){let d=c.lastIndexOf("- **[",c.length-1),f=c.slice(0,d)+`
_...older decisions archived..._
`;Ve(e,f)}else Ve(e,c);return a("memory-writer",`Stored to CC native memory: ${e}`,"debug"),!0}catch(e){return a("memory-writer",`Failed to write CC native memory: ${e}`,"warn"),!1}}async function Mt(t){let e={graph_operations:[],cc_native:!1};e.graph_operations=ni(t),t.metadata.confidence>=.7&&tn()&&(e.cc_native=ci(t));let n=[e.graph_operations.length>0?"graph":null,e.cc_native?"cc-native":null].filter(Boolean);return n.length>0&&a("memory-writer",`Stored ${t.type} ${t.id} to: ${n.join(", ")}`,"info"),e}function ui(t,e,n){if(e<.8||!t.why)return!1;let r=["pagination","caching","authentication","authorization","testing","deployment","security","performance","database","api","architecture"];return n.some(i=>r.some(s=>i.toLowerCase().includes(s)))}function Nt(t,e,n,r){let o=new Date().toISOString(),i=li(t),s=ti(g())||"unknown",c=et(),u=r.confidence??.5,p=ui(e,u,n);return t==="decision"?$e(e.what,e.why,u):t==="preference"&&Oe(e.what,u),{id:i,type:t,content:e,entities:n,relations:[],identity:{user_id:c.user_id,anonymous_id:c.anonymous_id,team_id:c.team_id,machine_id:c.machine_id},metadata:{session_id:r.session_id,timestamp:o,confidence:u,source:r.source,project:s,category:r.category??"general",importance:r.importance,is_generalizable:p,sharing_scope:p?"global":"team"}}}function li(t){let e=Date.now().toString(36),n=Math.random().toString(36).slice(2,8);return`${t}-${e}-${n}`}import{existsSync as di,mkdirSync as pi}from"node:fs";import{join as gi,dirname as fi,basename as mi}from"node:path";var E="capture-user-intent",hi=15;function yi(t){return[/^âš \s*Warning:/i,/selected the directory of/i,/inferred your workspace/i,/^Error:/i,/^\[stderr\]/i,/detected multiple lockfiles/i].some(n=>n.test(t))}function bi(t){let e=Date.now().toString(36),n=Math.random().toString(36).slice(2,8);return`${t}-${e}-${n}`}function ki(){let t=g();return mi(t)||"unknown"}function _i(t,e){try{let n=fi(t);di(n)||pi(n,{recursive:!0});let r=`${JSON.stringify(e)}
`;return I(t,r),!0}catch(n){return a(E,`Failed to write to ${t}: ${n}`,"warn"),!1}}function Si(t,e){if(t.length===0)return 0;let n=g(),r=gi(n,".claude","memory","open-problems.jsonl"),o=ki(),i=new Date().toISOString(),s=0;for(let c of t){let u={id:bi("prob"),timestamp:i,session_id:e,type:"problem",text:c.text,confidence:c.confidence,entities:c.entities,project:o,status:"open"};_i(r,u)&&s++}return s}function en(t){if(t.length===0)return"general";let e=t.join(" ").toLowerCase(),n=[[["postgresql","postgres","mysql","sqlite","mongodb","redis","database","db"],"database"],[["react","vue","angular","svelte","frontend","css","tailwind","ui"],"frontend"],[["fastapi","django","express","nest","backend","api","rest","graphql"],"backend"],[["docker","kubernetes","k8s","ci","cd","deploy","infrastructure"],"infrastructure"],[["test","jest","vitest","pytest","testing","coverage"],"testing"],[["typescript","python","rust","go","java","language"],"language"],[["auth","security","jwt","oauth","encryption"],"security"],[["cache","caching","performance","optimization"],"performance"],[["architecture","pattern","design","structure"],"architecture"]];for(let[r,o]of n)if(r.some(i=>e.includes(i)))return o;return"general"}function wi(t,e){try{for(let n of t.decisions){let r=Nt("decision",{what:n.text,why:n.rationale,...n.alternatives?.length?{alternatives:n.alternatives}:{},...n.constraints?.length?{constraints:n.constraints}:{},...n.tradeoffs?.length?{tradeoffs:n.tradeoffs}:{}},n.entities,{session_id:e,source:"user_prompt",confidence:n.confidence,category:en(n.entities)});Mt(r).catch(o=>{a(E,`storeDecision failed for decision: ${o}`,"warn")})}for(let n of t.preferences){let r=Nt("preference",{what:n.text},n.entities,{session_id:e,source:"user_prompt",confidence:n.confidence,category:en(n.entities)});Mt(r).catch(o=>{a(E,`storeDecision failed for preference: ${o}`,"warn")})}for(let n of t.problems)je(n.text)}catch(n){a(E,`Memory pipeline storage failed: ${n}`,"warn")}}function nn(t){let e=t.prompt;if(!e||e.length<hi)return l();if(e.length>5e4)return a(E,`Prompt too large (${e.length} chars), skipping \u2014 likely image/binary data`),l();if(e.length>500&&st(e))return a(E,`Image/binary content detected (${e.length} chars), skipping intent capture`),l();if(yi(e))return l();let n=t.session_id||y(),r;try{r=Xe(e)}catch(i){return a(E,`Intent detection failed: ${i}`,"warn"),l()}if(r.intents.length===0)return l();wi(r,n);let o=Si(r.problems,n);return o>0&&a(E,`Captured: ${o} problems`,"info"),(r.decisions.length>0||r.preferences.length>0)&&a(E,`Tracked: ${r.decisions.length} decisions, ${r.preferences.length} preferences (to decisions.jsonl + queues)`,"debug"),l()}import{existsSync as ht,mkdirSync as hn,writeFileSync as yn,readFileSync as Ms}from"node:fs";import{join as z}from"node:path";import{existsSync as O,readFileSync as rn,writeFileSync as Ht,mkdirSync as ut}from"node:fs";import{join as W,dirname as Lt}from"node:path";var xi=2,Ti=2,vi=[/\bthank/i,/\bgreat\b/i,/\bperfect\b/i,/\bexcellent\b/i,/\bawesome\b/i,/\bworks?\b.*\b(well|great|perfectly)/i,/\bthat('s| is) (exactly|just) what/i,/\bnice\b/i,/\bgood job\b/i,/\bwell done\b/i,/\blooks? good\b/i,/\blgtm\b/i,/\bship it\b/i],Ii=[/\bno(t| ).*right/i,/\bwrong\b/i,/\bdoesn't work/i,/\bbroken\b/i,/\bfailed\b/i,/\btry again\b/i,/\bstart over\b/i,/\bundo\b/i,/\brevert\b/i,/\bfrustrat/i,/\bannoy/i,/\bconfus/i,/\bstill (not|doesn't)/i,/\bdidn't (work|help)/i,/\bthat's not/i];function Ei(t){for(let e of vi)if(e.test(t))return"positive";for(let e of Ii)if(e.test(t))return"negative";return"neutral"}function Ri(t){return W(t,".claude",".satisfaction-counter")}function Ci(t){let e=Ri(t),n=Lt(e);if(!O(n))try{ut(n,{recursive:!0})}catch{}let r=0;if(O(e))try{r=parseInt(rn(e,"utf8").trim(),10)||0}catch{}r++;try{Ht(e,String(r))}catch{}return r}function Pi(t,e,n,r){let o=W(r,".claude","feedback"),i=W(o,"satisfaction.log");if(!O(o))try{ut(o,{recursive:!0})}catch{return}let c=`${new Date().toISOString()} | ${t} | ${e} | ${n}
`;try{I(i,c)}catch{}}function Ai(t,e){return W(t,".claude",`.negative-count-${e}`)}function on(t,e){return W(t,".claude",`.bug-nudge-sent-${e}`)}function Di(t,e){let n=Ai(t,e),r=Lt(n);if(!O(r))try{ut(r,{recursive:!0})}catch{}let o=0;if(O(n))try{o=parseInt(rn(n,"utf8").trim(),10)||0}catch{}o++;try{Ht(n,String(o))}catch{}return o}function $i(t,e){return O(on(t,e))}function Oi(t,e){let n=on(t,e),r=Lt(n);if(!O(r))try{ut(r,{recursive:!0})}catch{}try{Ht(n,"1")}catch{}}function lt(t){let e=t.prompt||"",n=t.project_dir||g(),r=t.session_id||y(),o=parseInt(process.env.SATISFACTION_SAMPLE_RATE||"3",10),i=Ci(n);if(o>1&&i%o!==0)return l();if(a("satisfaction-detector",`Satisfaction detector hook starting (sample ${i})`),!e)return l();if(e.length<xi)return l();if(e.startsWith("/"))return l();let s=Ei(e);if(s!=="neutral"){let c=e.slice(0,50);e.length>50&&(c+="..."),Pi(r,s,c,n);try{M("preference_stated",s,{context:c,success:!0})}catch{}if(a("satisfaction-detector",`Detected ${s} satisfaction signal`),s==="negative"){let u=Di(n,r);if(u>=Ti&&!$i(n,r))return Oi(n,r),a("satisfaction-detector",`Bug nudge triggered after ${u} negative signals`,"info"),b("[Feedback] Multiple issues detected in this session. If you are experiencing an OrchestKit bug, you can run `/ork:feedback bug` to file a report.")}}return l()}import{existsSync as sn,readFileSync as ji,writeFileSync as Mi,mkdirSync as Ni}from"node:fs";import{join as Hi,dirname as Li}from"node:path";var Ft="communication-style-tracker",Fi=5,Ui=30,Gi=150,Bi=[/^(how|what|why|when|where|which|who|can\s+(you|i)|could\s+(you|i)|would\s+(you|i)|is\s+(it|there|this)|are\s+(there|these)|do\s+(you|i)|does|should|will|has|have)\b/i,/\?$/,/\b(explain|tell me|show me|help me understand)\b/i],Wi=[/^(fix|add|create|update|remove|delete|run|build|test|deploy|install|configure|set|get|make|write|read|edit|change|modify|implement|refactor)\b/i,/^(do|just|please|now|quickly)\s+(fix|add|create|update|run|build)/i,/^[a-z]+\s+(it|this|that|the)\b/i],zi=[/^(i think|i believe|maybe|perhaps|i was thinking|let's discuss|what if|consider|i'm wondering|could we|should we|might we)\b/i,/\b(alternatively|on the other hand|however|but|although|pros and cons|trade-?off)\b/i,/\b(in my experience|from what i've seen|generally|typically|usually)\b/i],qi=[/\b(what (is|are|does)|how (do|does) .* work|explain|eli5|basics?|beginner|newbie|starter|learning|tutorial)\b/i,/\b(i('m| am) (new|confused|stuck|lost)|don't understand|can you explain)\b/i,/\b(step by step|for dummies|simple|easy)\b/i],Ji=[/\b(idempoten|determin|memoiz|currying|monad|functor|polymorphi|closure|hoisting|prototype chain)\b/i,/\b(HNSW|pgvector|FAISS|embeddings?|RAG|LLM|transformer|attention|tokeniz)\b/i,/\b(sharding|partition|replica|consistency|CAP theorem|ACID|eventual consistency)\b/i,/\b(microservic|kubernetes|k8s|helm|istio|service mesh|container orchestrat)\b/i,/\b(cursor.based pagination|connection pool|deadlock|race condition|mutex|semaphore)\b/i,/\b(dependency injection|inversion of control|SOLID|DRY|KISS|YAGNI)\b/i,/\b(async|await|promise|observable|event.loop|coroutine|generator)\b/i,/\b(O\(n\)|O\(log n\)|O\(1\)|big.?O|time complexity|space complexity)\b/i],Ki=[/\b(API|REST|GraphQL|JWT|OAuth|middleware|endpoint|route|controller)\b/i,/\b(component|hook|state|props|context|redux|store|dispatch)\b/i,/\b(migration|schema|model|ORM|query|index|foreign key)\b/i,/\b(unit test|integration test|e2e|mock|stub|fixture|coverage)\b/i,/\b(git|branch|merge|rebase|commit|PR|pull request)\b/i];function Xi(t){let e=t.trim(),n=e.length,r=(e.match(/[.!?]\s+[A-Z]/g)||[]).length>=2,o=/\b(because|since|so that|in order to|the reason)\b/i.test(e),i=/\b(context|background|currently|previously|before)\b/i.test(e);return n<=Ui&&!o?"terse":n>Gi||r||o||i?"detailed":"moderate"}function an(t){let e=t.trim();for(let n of zi)if(n.test(e))return"discussion";for(let n of Bi)if(n.test(e))return"question";for(let n of Wi)if(n.test(e))return"command";return e.length<50?"command":"discussion"}function Vi(t){let e=t.trim(),n=0,r=0,o=0;for(let i of qi)i.test(e)&&(n+=2);for(let i of Ji)i.test(e)&&(o+=2);for(let i of Ki)i.test(e)&&(r+=1);return e.length<40&&!e.includes("?")&&an(e)==="command"&&(o+=1),n>o&&n>r?"beginner":o>=2||o>0&&r>=2?"expert":(r>=2||o>0,"intermediate")}function Yi(t){return{verbosity:Xi(t),interaction_type:an(t),technical_level:Vi(t)}}function Qi(t){return Hi(t,".claude",".comm-style-counter")}function Zi(t){let e=Qi(t),n=Li(e);if(!sn(n))try{Ni(n,{recursive:!0})}catch{}let r=0;if(sn(e))try{r=parseInt(ji(e,"utf8").trim(),10)||0}catch{}r++;try{Mi(e,String(r))}catch{}return r}function dt(t){let e=t.prompt||"",n=t.project_dir||g(),r=parseInt(process.env.COMM_STYLE_SAMPLE_RATE||"5",10),o=Zi(n);if(r>1&&o%r!==0)return l();if(a(Ft,`Analyzing communication style (sample ${o})`),!e||e.length<Fi)return l();if(e.startsWith("/"))return l();try{let i=Yi(e);Me(i),a(Ft,`Detected: verbosity=${i.verbosity}, type=${i.interaction_type}, level=${i.technical_level}`)}catch(i){a(Ft,`Error tracking communication style: ${i}`,"warn")}return l()}import{existsSync as cn,readFileSync as un}from"node:fs";import{join as ln}from"node:path";var ts=["implement","add","create","build","set up","setup","configure","use","write","make","develop"];function es(t){let e=t.toLowerCase();for(let n of ts)if(e.includes(n))return!0;return!1}function ns(t,e){let n=t.toLowerCase(),r=[],o=ln(e,".claude","feedback","learned-patterns.json");if(cn(o))try{let c=(JSON.parse(un(o,"utf8")).patterns||[]).filter(u=>u.outcome==="failed");for(let u of c)if(u.text){let d=u.text.toLowerCase().split(" ")[0];d&&n.includes(d)&&r.push(`Previously failed: ${u.text}`)}}catch{}let i=ln(P(),".claude","global-patterns.json");if(cn(i))try{let s=JSON.parse(un(i,"utf8"));for(let{pattern:c,warning:u}of s.antipatterns||[])n.includes(c.toLowerCase())&&r.push(`${c}: ${u}`)}catch{}return r}function pt(t){let e=t.prompt||"",n=t.project_dir||g();if(!e)return l();if(!es(e))return l();a("antipattern-warning","Checking prompt for anti-patterns...");let r=ns(e,n);if(r.length>0){a("antipattern-warning",`Found anti-pattern warnings: ${r.join(", ")}`);let o=`## Anti-Pattern Warning

The following patterns have previously caused issues:

${r.map(i=>`- ${i}`).join(`
`)}

Consider alternative approaches before proceeding.

Search knowledge graph for more context: mcp__memory__search_nodes with query="${e.slice(0,50)}"`;return b(o)}return l()}import{existsSync as rs,readFileSync as os}from"node:fs";import{join as is}from"node:path";var ss=["design","refactor","continue","resume","previous","last time","before","earlier","pattern","decision","how did we","what did we"],as=["remember","how did we","what did we","last time"],cs=["relationship","related","connected","depends","uses","recommends",["what does","recommend"],["how does","work with"]],us=20;function ls(t){let e=t.toLowerCase();for(let r of as)if(e.includes(r))return!0;let n=0;for(let r of ss)if(e.includes(r)&&(n++,n>=2))return!0;return!1}function ds(t){let e=t.toLowerCase();for(let n of cs)if(typeof n=="string"){if(e.includes(n))return!0}else{let r=e.indexOf(n[0]);if(r!==-1&&e.indexOf(n[1],r+n[0].length)!==-1)return!0}return!1}function ps(t){let e=new Set(["the","a","an","to","for","in","on","at","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","can","may","might","must","shall","i","you","we","they","it","this","that","these","those","my","your","our","their","its","and","or","but","if","then","else","when","where","how","what","which","who","whom","with","from","into","onto","about","after","before","global"]);return t.toLowerCase().replace(/[^a-z\s]/g," ").split(/\s+/).filter(r=>r.length>2&&!e.has(r)).slice(0,5).join(" ")}function gs(t){let e=process.env.CLAUDE_AGENT_ID;if(e)return e;let n=is(t,".claude","session","current-agent-id");if(rs(n))try{return os(n,"utf8").trim()}catch{}return""}function gt(t){let e=t.prompt||"",n=t.project_dir||g();if(a("memory-context","Memory context hook starting (graph-first)"),e.length<us)return a("memory-context",`Prompt too short (${e.length} chars), skipping memory search`),l();let r=e.startsWith("@global")||e.includes("cross-project")||e.includes("all projects"),o=ds(e);r&&a("memory-context","Detected @global prefix - will suggest cross-project search"),o&&a("memory-context","Detected graph-related query");let i=gs(n);if(i&&a("memory-context",`Agent context detected: ${i}`),!ls(e))return a("memory-context","No memory trigger keywords found, skipping"),l();let s=ps(e);if(!s)return a("memory-context","No search terms extracted, skipping"),l();a("memory-context",`Search terms: ${s}`);let u=`[Memory Context] For relevant past ${r?"cross-project":"project"} decisions, use mcp__memory__search_nodes with query="${s}"`;return o&&(u+=" | For relationships: mcp__memory__open_nodes on found entities | Graph traversal available"),i&&(u+=` | Agent context: ${i}`),a("memory-context",`Memory context available for: ${s}`),b(u)}import{existsSync as Ut,readFileSync as fs,writeFileSync as ms,mkdirSync as hs}from"node:fs";import{join as ys}from"node:path";var dn=.85,bs=.95,ks=8,_s=15,Ss=5;function ws(t){if(!t)return 0;let e=Date.now(),n;if(/^\d+$/.test(t))n=parseInt(t,10);else if(n=new Date(t).getTime(),Number.isNaN(n))return 0;let r=(e-n)/(1e3*60);return r<=5?10:r<=15?8:r<=30?6:r<=60?4:r<=120?2:0}function xs(t){return t>=10?10:t>=7?8:t>=4?6:t>=2?4:t>=1?2:0}function Ts(t,e){if(t.length===0||e.length===0)return 2;let n=new Set(t.map(s=>s.toLowerCase())),r=new Set(e.map(s=>s.toLowerCase())),o=0;for(let s of n)r.has(s)&&o++;let i=o/n.size;return i>=.75?10:i>=.5?8:i>=.3?6:i>=.15?4:o>0?2:0}function vs(t){let e=new Set(["the","and","for","with","from","that","this","have","will","can","should","would","could"]);return t.toLowerCase().match(/\b[a-z]{3,}\b/g)?.filter(n=>!e.has(n)).slice(0,20)||[]}function pn(){return Kt(y())}function Is(){let t=pn();if(Ut(t))try{return JSON.parse(fs(t,"utf8"))}catch{}let n={session_id:y(),updated_at:new Date().toISOString(),total_context_tokens:0,context_budget:12e3,items:[]};return ms(t,JSON.stringify(n,null,2)),n}function Es(t){let e=process.env.CLAUDE_CONTEXT_USAGE_PERCENT;if(e){let n=parseFloat(e);if(!Number.isNaN(n))return n}return t.context_budget>0?t.total_context_tokens/t.context_budget:0}function Rs(t,e){let n=[];for(let r of t.items){let o=r.last_accessed||r.loaded_at,i=r.access_count||0,s=r.tags||[],c=ws(o),u=xs(i),p=Ts(s,e),d=c+u+p;a("context-pruning-advisor",`Scored ${r.id}: R=${c} F=${u} V=${p} Total=${d}`),d<=_s&&n.push({score:d,priority:d<=ks?"HIGH":"MED",itemId:r.id,tokens:r.estimated_tokens||500})}return n.sort((r,o)=>r.score-o.score).slice(0,Ss)}function Cs(t){let e=0,n=[];for(let r=0;r<t.length;r++){let{priority:o,itemId:i,score:s,tokens:c}=t[r];e+=c;let u=i.replace(/^(skill:|file:|agent:)/,"");n.push(`  ${r+1}. [${o}] ${u} (score: ${s}, saves ~${c}t)`)}return`Context usage >85%. Pruning recommendations:
${n.join(`
`)}

Potential savings: ~${e} tokens
To prune: Archive or unload low-scoring context items.`}function ft(t){let e=t.project_dir||g(),n=t.prompt||"",r=ys(e,"logs");if(!Ut(r))try{hs(r,{recursive:!0})}catch{}let o=process.env.CLAUDE_CONTEXT_USAGE_PERCENT,i=pn();if(!o&&!Ut(i))return a("context-pruning-advisor","No context tracking data, skipping"),l();let s=Is(),c=Es(s);if(a("context-pruning-advisor",`Context usage: ${c} (trigger threshold: ${dn})`),c<dn)return a("context-pruning-advisor","Context usage within limits, no pruning needed"),l();if(c>=bs){a("context-pruning-advisor",`CRITICAL: Context usage at ${c*100}% (>95%)`);let d=`CRITICAL: Context usage at ${Math.round(c*100)}% (>95%). Use /ork:context-optimization immediately or manually archive old decisions and patterns.`;return b(d)}if(!n)return a("context-pruning-advisor","No user prompt found in hook input, skipping analysis"),l();let u=vs(n);a("context-pruning-advisor",`Extracted prompt keywords: ${u.join(", ")}`);let p=Rs(s,u);if(p.length>0){let d=Cs(p);return a("context-pruning-advisor",`Recommending ${p.length} pruning candidates`),b(d)}return l()}var Ps="skill-nudge-prompt",As=/https?:\/\/github\.com\/[\w.-]+\/[\w.-]+\/issues\/\d+(?=[/?#]|$)/;function mt(t){let e=t.prompt||"";return As.test(e)?(a(Ps,"Nudge: fix-issue for GitHub issue URL in prompt"),b("Tip: Use `/ork:fix-issue` to fix this issue with parallel analysis, automatic branch creation, and structured PR.")):l()}import{existsSync as Ds,readFileSync as $s}from"node:fs";import{join as gn}from"node:path";var Gt="agentation-context",Os="[Agentation] Check agentation_get_all_pending for pending UI annotations before starting work.";function js(t){let e=[gn(t,".mcp.json"),gn(t,".claude","mcp.json")];for(let n of e)if(Ds(n))try{let r=$s(n,"utf8"),s=(JSON.parse(r).mcpServers||{}).agentation;if(s&&s.disabled!==!0)return!0}catch{}return!1}function fn(t){try{let e=t.project_dir||g();return js(e)?(a(Gt,"Agentation MCP detected \u2014 injecting annotation reminder"),b(Os)):(a(Gt,"Agentation MCP not configured, skipping"),l())}catch(e){return a(Gt,`Error checking agentation config: ${e}`,"warn"),l()}}var T="prompt-dispatcher",mn=800,Ns=[{name:"profile-injector",fn:ot,producesContext:!0,runOnce:!0},{name:"memory-context-loader",fn:it,producesContext:!0,runOnce:!0},{name:"agentation-context",fn,producesContext:!0,runOnce:!0},{name:"satisfaction-detector",fn:lt,producesContext:!1},{name:"communication-style-tracker",fn:dt,producesContext:!1},{name:"context-pruning-advisor",fn:ft,producesContext:!0},{name:"antipattern-warning",fn:pt,producesContext:!0},{name:"memory-context",fn:gt,producesContext:!0},{name:"skill-nudge-prompt",fn:mt,producesContext:!0}];function Hs(t,e,n){let r=z(n,".claude","memory","sessions",e,"once-flags",`${t}.done`);return ht(r)}function Ls(t,e,n){let r=z(n,".claude","memory","sessions",e,"once-flags");ht(r)||hn(r,{recursive:!0}),yn(z(r,`${t}.done`),Date.now().toString(),"utf8")}function Fs(t){let e=t.split(`
`).filter(n=>n.trim().length>0);return e.length===0?!0:e.every(n=>{let r=n.trim();return!!(/^\[Cross-project context:.*\]$/.test(r)||/^\[\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}.*\]$/.test(r))})}function bn(t){let e=t.prompt||"";if(e.length>5e4)return a(T,`Prompt too large (${e.length} chars > ${5e4}), skipping \u2014 likely image/binary data`),l();if(e.length>500&&st(e))return a(T,`Image/binary content detected in prompt (${e.length} chars), skipping text analysis hooks`),l();let n=[],r=0,o=t.session_id||y(),i=t.project_dir||g();for(let d of Ns)try{if(d.runOnce){if(!o)a(T,`${d.name}: no session_id, running without once-gate`);else if(Hs(d.name,o,i)){a(T,`${d.name}: already ran this session, skipping`);continue}}let f=d.fn(t);if(d.runOnce&&o)try{Ls(d.name,o,i)}catch(v){a(T,`${d.name}: failed to write once-flag: ${v}`,"warn")}if(!d.producesContext)continue;let m=ne(f);if(!m)continue;if(Fs(m)){a(T,`${d.name}: noisy output filtered`);continue}let h=wt(m);if(r+h>mn){a(T,`Budget limit: skipping ${d.name} (${h}t would exceed ${mn}t cap)`);continue}n.push(m),r+=h,a(T,`${d.name}: +${h}t (total: ${r}t)`)}catch(f){let m=f instanceof Error?f.message:String(f);a(T,`${d.name} failed: ${m}`,"warn")}if(n.length===0)return l();let s=n.join(`

---

`),c=K(s),u=z(i,".claude","memory","sessions",o),p=z(u,"prompt-hash.txt");try{if(ht(p)&&Ms(p,"utf8").trim()===c)return a(T,`Delta skip: consolidated output unchanged (hash=${c})`),l();ht(u)||hn(u,{recursive:!0}),yn(p,c,"utf8")}catch(d){a(T,`Delta detection error: ${d}`,"warn")}return a(T,`Consolidated ${n.length} hooks into ${r}t`),b(s)}var Us=["implement","add","create","build","set up","configure","pagination","authentication","caching","database","api","endpoint"];function Gs(t){let e=t.toLowerCase();return/pagination|cursor|offset|page/i.test(e)?"pagination":/auth|jwt|oauth|login|session/i.test(e)?"authentication":/cache|redis|memo/i.test(e)?"caching":/database|sql|postgres|query/i.test(e)?"database":/api|endpoint|rest|graphql/i.test(e)?"api":/error|exception|handling/i.test(e)?"error-handling":/test|testing|spec/i.test(e)?"testing":"general"}function kn(t){let e=t.prompt||"",n=t.project_dir||g();if(e.length<30)return l();let r=e.toLowerCase(),o="";for(let c of Us)if(r.includes(c)){o=c;break}if(!o)return l();a("antipattern-detector",`Implementation keyword detected: ${o}`);let i=Gs(e);a("antipattern-detector",`Suggesting antipattern check for: ${o} (category: ${i})`);let s=`[Antipattern Check] Before implementing ${o}, check for known failures:
Use \`mcp__memory__search_nodes\` with query: "${o} failed ${i}"`;return b(s)}import{existsSync as Bs}from"node:fs";import{join as Ws}from"node:path";function _n(t){let e=t.prompt||"",n=t.project_dir||g();a("context-injector",`User prompt received (${e.length} chars)`);let r=[];if(/issue|bug|fix|#[0-9]+/.test(e)){let o=Ws(n,"docs","issues");Bs(o)&&r.push("Check docs/issues/ for issue documentation.")}return/test|testing|pytest|jest/.test(e.toLowerCase())&&r.push("Remember to use 'tee' for visible test output."),/deploy|ci|cd|pipeline|github.actions/.test(e.toLowerCase())&&r.push("Check .github/workflows/ for CI configuration."),r.length>0&&a("context-injector",`Context hints: ${r.join(" ")}`),l()}var zs=[{test:t=>/implement/i.test(t)},{test:t=>/refactor/i.test(t)},{test:t=>/add feature/i.test(t)},{test:t=>t.toLowerCase().includes("create")&&t.toLowerCase().includes("component")},{test:t=>t.toLowerCase().includes("build")&&t.toLowerCase().includes("system")},{test:t=>t.toLowerCase().includes("fix")&&t.toLowerCase().includes("multiple")},{test:t=>t.toLowerCase().includes("update")&&t.toLowerCase().includes("across")},{test:t=>/migrate/i.test(t)}],qs=500;function Sn(t){let e=t.prompt||"",n=e.length;a("todo-enforcer",`Prompt length: ${n} chars`);let r=!1;for(let o of zs)if(o.test(e)){r=!0;break}return n>qs&&(r=!0),r&&a("todo-enforcer","Complex task detected - todo tracking recommended"),l()}var Js=15,Ks=["what is","explain","how does","tell me about","describe","list","show me"];function Xs(t){let e=t.toLowerCase();for(let n of Ks)if(e.startsWith(n))return!0;return!!(t.endsWith("?")&&t.length<100)}function Vs(){let t=fe();return t!==void 0&&t.status==="running"}function wn(t){let e=t.prompt||"";if(e.length<Js)return l();if(Xs(e))return l();if(!Et().enablePipelines)return l();if(Vs())return a("pipeline-detector","Already in active pipeline, skipping detection"),l();a("pipeline-detector","Checking for pipeline triggers...");let r=we(e);if(!r)return a("pipeline-detector","No pipeline triggers detected"),l();a("pipeline-detector",`Detected pipeline: ${r.type}`);let{execution:o,tasks:i}=xe(r);Te(o,i);let s=ve(r,o,i);return a("pipeline-detector",`Created pipeline ${o.pipelineId} with ${i.length} steps`),b(s)}var xn={"prompt/unified-dispatcher":bn,"prompt/profile-injector":ot,"prompt/memory-context-loader":it,"prompt/capture-user-intent":nn,"prompt/antipattern-detector":kn,"prompt/antipattern-warning":pt,"prompt/context-injector":_n,"prompt/context-pruning-advisor":ft,"prompt/memory-context":gt,"prompt/satisfaction-detector":lt,"prompt/todo-enforcer":Sn,"prompt/pipeline-detector":wn,"prompt/communication-style-tracker":dt,"prompt/skill-nudge":mt};function _d(t){return xn[t]}function Sd(){return Object.keys(xn)}export{Wa as DEFAULT_CONFIG,Se as PIPELINES,L as THRESHOLDS,lc as addToPromptHistory,Lc as analyzeAttemptHistory,Jc as applyDecay,pc as cacheClassification,Pr as calculateBackoffDelay,Va as classifyIntent,hc as cleanupOldStates,$c as cleanupOldTasks,Qa as clearCache,mc as clearSessionState,Hc as completeAttempt,Dc as completePipelineStep,Nc as createAttempt,xe as createPipelineExecution,we as detectPipeline,Ga as escapeRegex,wt as estimateTokenCount,ne as extractContext,K as fnv1aHash,ve as formatPipelinePlan,Uc as formatRetryDecision,wc as formatTaskCreateForClaude,Tc as formatTaskDeleteForClaude,vc as formatTaskUpdateForClaude,_c as generateTaskCreateInstruction,xc as generateTaskDeleteInstruction,Sc as generateTaskUpdateInstruction,ic as getActiveAgent,fe as getActivePipeline,Kc as getAdjustments,Xc as getAgentSuccessRate,Rt as getAlternativeAgent,xa as getCachedBranch,Vc as getCalibrationStats,wa as getEnvFile,Ha as getField,_d as getHook,uc as getInjectedSkills,gc as getLastClassification,Zt as getLogDir,Zn as getLogLevel,Pc as getOrphanedTasks,ru as getPipelineByType,xr as getPipelineTasks,St as getPluginRoot,g as getProjectDir,dc as getPromptHistory,y as getSessionId,Ec as getTaskByAgent,Rc as getTaskById,Cc as getTasksBlockedBy,Yc as hasMinimalCalibrationData,Fr as hashPrompt,xn as hooks,sc as isAgentDispatched,Qs as isBashInput,ta as isEditInput,ea as isReadInput,Ar as isRetryableError,cc as isSkillInjected,Zs as isWriteInput,La as lineContainsAll,Fa as lineContainsAllCI,Sd as listHooks,U as loadCalibrationData,Et as loadConfig,A as loadState,a as logHook,ja as logPermissionFeedback,Mc as makeRetryDecision,Ua as normalizeCommand,Ta as normalizeLineEndings,Ca as outputAllowWithContext,Ia as outputBlock,$a as outputDeny,Pa as outputError,b as outputPromptContext,Ma as outputPromptContextBudgeted,va as outputSilentAllow,l as outputSilentSuccess,Da as outputStderrWarning,Aa as outputWarning,Ea as outputWithContext,Ra as outputWithNotification,Oa as outputWithUpdatedInput,Fc as prepareForRetry,Na as readHookInput,qc as recordOutcome,ge as registerPipeline,Te as registerPipelineExecution,pe as registerTask,oc as removeAgent,Lr as saveCalibrationData,fc as saveConfig,yr as saveState,Ya as shouldClassify,tr as shouldLog,Dr as suggestsAlternative,nc as trackDispatchedAgent,ac as trackInjectedSkill,rc as updateAgentStatus,Ac as updatePipeline,j as updateState,Ic as updateTaskStatus,H as writeRulesFile};
//# sourceMappingURL=prompt.mjs.map
