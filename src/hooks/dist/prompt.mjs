// OrchestKit Hooks - prompt bundle
// Generated: 2026-01-28T17:30:56.926Z

var lt=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,n)=>(typeof require<"u"?require:e)[n]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});function As(t){return typeof t.command=="string"}function $s(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function Rs(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function Es(t){return typeof t.file_path=="string"&&t.content===void 0}import{appendFileSync as ut,existsSync as dt,statSync as Te,renameSync as Ce,mkdirSync as Ae,readSync as $e}from"node:fs";import{execSync as Re}from"node:child_process";function pt(){return process.env.CLAUDE_PLUGIN_ROOT?`${process.env.HOME||process.env.USERPROFILE||"/tmp"}/.claude/logs/ork`:`${m()}/.claude/logs`}function m(){return process.env.CLAUDE_PROJECT_DIR||"."}function $(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function y(){return process.env.CLAUDE_SESSION_ID||`fallback-${process.pid}-${Date.now()}`}function Os(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let e=Re("git branch --show-current",{cwd:t||m(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function Ee(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function De(t){let e=["debug","info","warn","error"];return e.indexOf(t)>=e.indexOf(Ee())}function u(){return{continue:!0,suppressOutput:!0}}function Ps(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function Hs(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function Ns(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function b(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function Ls(t,e){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?n.systemMessage=e:n.suppressOutput=!0,n}function Us(t){return{continue:!0,systemMessage:t}}function Fs(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function Bs(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}var Me=200*1024,je=100*1024;function gt(t,e){if(dt(t))try{if(Te(t).size>e){let i=`${t}.old.${Date.now()}`;Ce(t,i)}}catch{}}function ft(t){dt(t)||Ae(t,{recursive:!0})}function c(t,e,n="debug"){if(!De(n))return;let i=pt(),s=`${i}/hooks.log`;try{ft(i),gt(s,Me);let r=new Date().toISOString().replace("T"," ").slice(0,19);ut(s,`[${r}] [${n.toUpperCase()}] [${t}] ${e}
`)}catch{}}function Gs(t,e,n){let i=pt(),s=`${i}/permission-feedback.log`;try{ft(i),gt(s,je);let r=new Date().toISOString(),o=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",a=n?.session_id||y();ut(s,`${r} | ${t} | ${e} | tool=${o} | session=${a}
`)}catch{}}function N(t){if(!t)return 0;let i=(t.match(/[{};()=><]/g)||[]).length/t.length>.03?2.8:3.5;return Math.ceil(t.length/i)}function qs(t,e,n,i,s){let r=N(t);return i&&i.isOverBudget(n)?(c(e,`Budget exhausted for ${n}, suppressing ${r}t`),u()):(s&&s.trackTokenUsage(e,n,r),b(t))}function zs(){try{let t=[],n=Buffer.allocUnsafe(256),i,s=0;for(;;)try{if(i=$e(s,n,0,256,null),i===0)break;t.push(Buffer.from(n.subarray(0,i)))}catch{break}let r=Buffer.concat(t).toString("utf8").trim();return r?JSON.parse(r):{tool_name:"",session_id:y(),tool_input:{}}}catch{return{tool_name:"",session_id:y(),tool_input:{}}}}function Ks(t,e){let n=e.replace(/^\./,"").split("."),i=t;for(let s of n){if(i==null)return;i=i[s]}return i}function Ws(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function Js(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var S={AUTO_DISPATCH:85,SKILL_INJECT:80,STRONG_RECOMMEND:70,SUGGEST:50,MINIMUM:40},Vs={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};import{existsSync as Oe,readFileSync as mt,readdirSync as ht}from"node:fs";import{join as B}from"node:path";var L={keyword:30,phrase:25,context:20,cooccurrence:15,negation:10},Pe=[/\b(not|don't|doesn't|won't|can't|shouldn't|avoid|without|except|unlike|instead of)\s+/i,/\b(no|never|neither|nor)\s+/i],He=["continue","also","additionally","and","then","next","follow up","after that"],U=null,W=null;function Ne(t){if(U&&W===t)return U;let e=new Map;try{let n=ht(t).filter(i=>i.endsWith(".md"));for(let i of n){let s=i.replace(".md",""),r=B(t,i);try{let a=mt(r,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!a)continue;let l=a[1],p=l.match(/^description:\s*(.+)$/m);if(!p)continue;let d=p[1].trim(),g=d.match(/Activates for\s+(.+?)\.?$/i),f=g?d.slice(0,d.indexOf("Activates for")).trim():d,h=[],_=[];if(g){let v=g[1].split(/,\s*/).map(k=>k.trim().toLowerCase());for(let k of v)k.includes(" ")||k.includes("-")?_.push(k):k.length>1&&h.push(k)}let C=l.match(/^skills:\s*\n((?:\s+-\s+.+\n?)+)/m),I;C&&(I=C[1].split(`
`).map(w=>w.replace(/^\s*-\s*/,"").trim()).filter(Boolean)),(h.length>0||_.length>0)&&e.set(s,{keywords:h,phrases:_,description:f||d.split(".")[0],skills:I})}catch{}}}catch{c("intent-classifier","Could not read agents directory")}return U=e,W=t,e}var F=null,J=null;function Le(t){if(F&&J===t)return F;let e=new Map;try{let n=ht(t,{withFileTypes:!0}).filter(i=>i.isDirectory()).map(i=>i.name);for(let i of n){let s=B(t,i,"SKILL.md");if(Oe(s))try{let o=mt(s,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!o)continue;let a=o[1],l=a.match(/^description:\s*(.+)$/m),p=l?l[1].trim():"",d=a.match(/^tags:\s*\[([^\]]+)\]/m),g=[];d&&(g=d[1].split(",").map(h=>h.trim().toLowerCase().replace(/["']/g,"")).filter(h=>h.length>1));let f=p.toLowerCase().split(/\s+/).filter(h=>h.length>4).slice(0,5);g=[...new Set([...g,...f])],(g.length>0||p)&&e.set(i,{keywords:g,description:p})}catch{}}}catch{c("intent-classifier","Could not read skills directory")}return F=e,J=t,e}function Ue(t,e){let n=0,i=[],s=[];for(let o of e)if(new RegExp(`\\b${o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"i").test(t)){let l=o.length>5?25:20;n+=l,i.push(o),s.push({type:"keyword",source:"keyword-match",weight:l,matched:o})}let r=e.length*25;return{score:r>0?Math.min(n/r*100,100):0,matched:i,signals:s}}function Fe(t,e){let n=0,i=[],s=[];for(let o of e)if(t.includes(o)){let a=o.split(/\s+/).length*15;n+=a,i.push(o),s.push({type:"phrase",source:"phrase-match",weight:a,matched:o})}let r=e.length*45;return{score:r>0?Math.min(n/r*100,100):0,matched:i,signals:s}}function Be(t,e,n){if(n.length===0)return{score:0,signals:[]};let i=[],s=0;for(let o of He)if(t.includes(o)){s+=15,i.push({type:"context",source:"continuation-keyword",weight:15,matched:o});break}let r=n.slice(-3).join(" ").toLowerCase();for(let o of e.slice(0,5))r.includes(o)&&(s+=20,i.push({type:"context",source:"history-keyword",weight:20,matched:o}));return{score:Math.min(s,100),signals:i}}function Ge(t){let e=[],n=0;for(let i of Pe)if(i.test(t)){n=25,e.push({type:"negation",source:"negation-detected",weight:-25,matched:t.match(i)?.[0]||"negation"});break}return{penalty:n,signals:e}}function qe(t,e,n){if(n.length===0)return{adjustment:0,signals:[]};let i=0,s=[];for(let r of n)r.agent===t&&e.includes(r.keyword)&&(i+=r.adjustment,s.push({type:r.adjustment>0?"boost":"penalty",source:"calibration",weight:r.adjustment,matched:`${r.keyword}:${t}`}));return{adjustment:i,signals:s}}function ze(t,e,n,i,s){let r=[],o=[],a=Ue(t,n.keywords);r.push(...a.signals),o.push(...a.matched);let l=Fe(t,n.phrases);r.push(...l.signals),o.push(...l.matched);let p=Be(t,n.keywords,i);r.push(...p.signals);let d=Ge(t);r.push(...d.signals);let g=qe(e,o,s);r.push(...g.signals);let f=a.score*(L.keyword/100)+l.score*(L.phrase/100)+p.score*(L.context/100);return f-=d.penalty*(L.negation/100),f+=Math.max(-15,Math.min(15,g.adjustment)),f=Math.max(0,Math.min(100,f)),f<S.MINIMUM?null:{agent:e,confidence:Math.round(f),description:n.description,matchedKeywords:o,signals:r}}function Ke(t,e,n){let i=[],s=[],r=0;for(let o of n.keywords)if(new RegExp(`\\b${o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"i").test(t)){let l=o.length>5?25:20;r+=l,s.push(o),i.push({type:"keyword",source:"skill-keyword",weight:l,matched:o})}return r=Math.min(r,100),r<S.MINIMUM?null:{skill:e,confidence:Math.round(r),description:n.description,matchedKeywords:s,signals:i}}function D(t,e=[],n=[]){let i=$(),s=B(i,"agents"),r=B(i,"skills"),o=t.toLowerCase(),a=[],l=[],p=[],d=Ne(s);for(let[w,v]of d){let k=ze(o,w,v,e,n);k&&(l.push(k),a.push(...k.signals))}let g=Le(r);for(let[w,v]of g){let k=Ke(o,w,v);k&&(p.push(k),a.push(...k.signals))}l.sort((w,v)=>v.confidence-w.confidence),p.sort((w,v)=>v.confidence-w.confidence);let f=l[0],h=f?We(f.agent,f.matchedKeywords):"general",_=Math.max(f?.confidence||0,p[0]?.confidence||0),C=f!==void 0&&f.confidence>=S.AUTO_DISPATCH,I=p.length>0&&p[0].confidence>=S.SKILL_INJECT;return{agents:l.slice(0,3),skills:p.slice(0,5),intent:h,confidence:_,signals:a,shouldAutoDispatch:C,shouldInjectSkills:I}}function We(t,e){let n={"api-design":["api","endpoint","rest","graphql","route"],database:["database","schema","migration","sql","query"],authentication:["auth","login","jwt","oauth","session"],frontend:["react","component","ui","form","state"],testing:["test","coverage","mock","fixture","e2e"],devops:["deploy","ci","cd","release","monitor"],"ai-integration":["llm","rag","embedding","langgraph","agent"],security:["security","owasp","xss","injection","csrf"]};for(let[i,s]of Object.entries(n))for(let r of e)if(s.includes(r))return i;return t.includes("backend")||t.includes("api")?"api-design":t.includes("frontend")||t.includes("ui")?"frontend":t.includes("test")?"testing":t.includes("security")?"security":"general"}function M(t){return!(t.length<10||/what agents|list agents|available agents|what skills/i.test(t)||/^(yes|no|ok|thanks|done|continue|stop)$/i.test(t.trim()))}function nr(){U=null,W=null,F=null,J=null}import{existsSync as O,readFileSync as kt,writeFileSync as bt,mkdirSync as Je}from"node:fs";function X(){return`${m()}/.claude/orchestration`}function V(){let t=y();return`${X()}/session-${t}.json`}function St(){return`${m()}/.claude/orchestration/config.json`}function wt(){let t=X();if(!O(t))try{Je(t,{recursive:!0})}catch{c("orchestration-state",`Failed to create state dir: ${t}`)}}function R(){let t=V();if(O(t))try{let e=kt(t,"utf8");return JSON.parse(e)}catch(e){c("orchestration-state",`Failed to load state: ${e}`)}return{sessionId:y(),activeAgents:[],injectedSkills:[],promptHistory:[],maxHistorySize:10,updatedAt:new Date().toISOString()}}function Xe(t){wt();let e=V();t.updatedAt=new Date().toISOString();try{bt(e,JSON.stringify(t,null,2))}catch(n){c("orchestration-state",`Failed to save state: ${n}`)}}function j(t){let e=R();return t(e),Xe(e),e}function xt(t,e,n){let i={agent:t,taskId:n,confidence:e,dispatchedAt:new Date().toISOString(),status:"pending",retryCount:0,maxRetries:3};return j(s=>{s.activeAgents=s.activeAgents.filter(r=>r.agent!==t),s.activeAgents.push(i)}),c("orchestration-state",`Tracked dispatched agent: ${t} (conf: ${e})`),i}function or(t,e,n){j(i=>{let s=i.activeAgents.find(r=>r.agent===t);s&&(s.status=e,n&&(s.taskId=n),e==="retrying"&&s.retryCount++)}),c("orchestration-state",`Updated agent status: ${t} -> ${e}`)}function ar(t){j(e=>{e.activeAgents=e.activeAgents.filter(n=>n.agent!==t)})}function cr(){return R().activeAgents.find(e=>e.status==="in_progress")}function _t(t){return R().activeAgents.some(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function It(t){j(e=>{e.injectedSkills.includes(t)||e.injectedSkills.push(t)})}function vt(t){return R().injectedSkills.includes(t)}function lr(){return R().injectedSkills}function Tt(t){j(e=>{e.promptHistory.push(t),e.promptHistory.length>e.maxHistorySize&&(e.promptHistory=e.promptHistory.slice(-e.maxHistorySize))})}function G(){return R().promptHistory}function Ct(t){j(e=>{e.lastClassification=t})}function At(){return R().lastClassification}var yt={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function A(){let t=St();if(O(t))try{let e=kt(t,"utf8");return{...yt,...JSON.parse(e)}}catch{}return yt}function ur(t){wt();let e=St(),i={...A(),...t};try{bt(e,JSON.stringify(i,null,2))}catch(s){c("orchestration-state",`Failed to save config: ${s}`)}}function dr(){let t=V();try{if(O(t)){let{unlinkSync:e}=lt("node:fs");e(t),c("orchestration-state","Cleared session state")}}catch{}}function pr(){let t=X();if(O(t))try{let{readdirSync:e,statSync:n,unlinkSync:i}=lt("node:fs"),s=e(t).filter(r=>r.startsWith("session-")&&r.endsWith(".json")).map(r=>({name:r,path:`${t}/${r}`,mtime:n(`${t}/${r}`).mtime.getTime()})).sort((r,o)=>o.mtime-r.mtime);for(let r of s.slice(5))try{i(r.path),c("orchestration-state",`Cleaned up old state: ${r.name}`)}catch{}}catch{}}import{existsSync as $t,readFileSync as Ve,writeFileSync as Ye,mkdirSync as Ze}from"node:fs";function Rt(){let t=y();return`${m()}/.claude/orchestration/task-registry-${t}.json`}function Qe(){let t=`${m()}/.claude/orchestration`;if(!$t(t))try{Ze(t,{recursive:!0})}catch{}}function T(){let t=Rt();if($t(t))try{return JSON.parse(Ve(t,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:y(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function E(t){Qe();let e=Rt();t.updatedAt=new Date().toISOString();try{Ye(e,JSON.stringify(t,null,2))}catch(n){c("task-integration",`Failed to save registry: ${n}`)}}function tn(t,e){let i={"backend-system-architect":"Designing","frontend-ui-developer":"Building","test-generator":"Writing tests for","security-auditor":"Auditing","workflow-architect":"Architecting","database-engineer":"Implementing database for","llm-integrator":"Integrating LLM for","code-quality-reviewer":"Reviewing","ux-researcher":"Researching UX for","product-strategist":"Strategizing","debug-investigator":"Investigating","performance-engineer":"Optimizing","accessibility-specialist":"Auditing accessibility for","infrastructure-architect":"Designing infrastructure for","data-pipeline-engineer":"Building pipeline for"}[t]||"Working on",s=e.slice(0,40).toLowerCase();return`${i} ${s}`}function hr(t,e,n,i){let s=t.split("-").map(o=>o.charAt(0).toUpperCase()+o.slice(1)).join(" "),r={source:"orchestration",dispatchedAgent:t,dispatchConfidence:n,...i};return{subject:`${s}: ${e.slice(0,50)}`,description:`Agent dispatched automatically at ${n}% confidence.

${e}`,activeForm:tn(t,e),metadata:r}}function yr(t,e,n,i){let s={taskId:t,status:e};return n&&n.length>0&&(s.addBlockedBy=n),i&&i.length>0&&(s.addBlocks=i),s}function kr(t){return`### Create Task for Tracking

\`\`\`
TaskCreate:
  subject: "${t.subject}"
  description: "${t.description}"
  activeForm: "${t.activeForm}"
  metadata:
    source: "${t.metadata.source}"
    dispatchedAgent: "${t.metadata.dispatchedAgent||""}"
    dispatchConfidence: ${t.metadata.dispatchConfidence||0}
\`\`\``}function br(t,e){return{taskId:t,status:"deleted"}}function Sr(t,e){return`### Delete Orphaned Task

\`\`\`
TaskUpdate:
  taskId: "${t}"
  status: "deleted"
\`\`\`

**Reason**: ${e}`}function wr(t){let e=`### Update Task

\`\`\`
TaskUpdate:
  taskId: "${t.taskId}"`;return t.status&&(e+=`
  status: "${t.status}"`),t.addBlockedBy&&t.addBlockedBy.length>0&&(e+=`
  addBlockedBy: ${JSON.stringify(t.addBlockedBy)}`),t.addBlocks&&t.addBlocks.length>0&&(e+=`
  addBlocks: ${JSON.stringify(t.addBlocks)}`),e+="\n```",e}function Et(t,e,n,i,s,r,o){let a=T();if(a.tasks.find(p=>p.taskId===t)){c("task-integration",`Task ${t} already registered`);return}a.tasks.push({taskId:t,agent:e,confidence:n,createdAt:new Date().toISOString(),status:"pending",pipelineId:i,pipelineStep:s,blockedBy:r,blocks:o}),E(a),c("task-integration",`Registered task ${t} for agent ${e}`)}function xr(t,e){let n=T(),i=n.tasks.find(s=>s.taskId===t);i&&(i.status=e,E(n),c("task-integration",`Updated task ${t} status to ${e}`))}function _r(t){return T().tasks.find(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function Ir(t){return T().tasks.find(n=>n.taskId===t)}function vr(t){return T().tasks.filter(n=>n.status==="pending"&&n.blockedBy&&n.blockedBy.includes(t))}function Tr(){let t=T(),e=new Set(t.tasks.filter(n=>n.status==="failed").map(n=>n.taskId));return e.size===0?[]:t.tasks.filter(n=>n.status!=="pending"||!n.blockedBy||n.blockedBy.length===0?!1:n.blockedBy.every(i=>e.has(i)))}function en(t){return T().tasks.filter(n=>n.pipelineId===t).sort((n,i)=>(n.pipelineStep||0)-(i.pipelineStep||0))}function Dt(t){let e=T();if(e.pipelines.find(i=>i.pipelineId===t.pipelineId)){c("task-integration",`Pipeline ${t.pipelineId} already registered`);return}e.pipelines.push(t),E(e),c("task-integration",`Registered pipeline ${t.pipelineId} (${t.type})`)}function Cr(t,e){let n=T(),i=n.pipelines.find(s=>s.pipelineId===t);i&&(Object.assign(i,e),E(n),c("task-integration",`Updated pipeline ${t}`))}function Mt(){return T().pipelines.find(e=>e.status==="running")}function Ar(t,e){let n=T(),i=n.pipelines.find(r=>r.pipelineId===t);if(!i)return null;i.completedSteps.includes(e)||(i.completedSteps.push(e),i.completedSteps.sort((r,o)=>r-o));let s=en(t);for(let r of s){let o=r.pipelineStep;if(o===void 0||i.completedSteps.includes(o)||r.status!=="pending")continue;if(o===0||i.completedSteps.includes(o-1))return i.currentStep=o,E(n),o}return i.status="completed",E(n),null}function $r(t=1440*60*1e3){let e=T(),n=Date.now()-t;e.tasks=e.tasks.filter(i=>i.status==="pending"||i.status==="in_progress"?!0:new Date(i.createdAt).getTime()>n),e.pipelines=e.pipelines.filter(i=>i.status==="running"?!0:new Date(i.startedAt).getTime()>n),E(e)}var nn=3,sn=1e3,rn=3e4,on={"backend-system-architect":["database-engineer","api-designer"],"frontend-ui-developer":["rapid-ui-designer","accessibility-specialist"],"test-generator":["debug-investigator","code-quality-reviewer"],"security-auditor":["security-layer-auditor"],"workflow-architect":["llm-integrator","data-pipeline-engineer"]},an=[/permission denied/i,/access denied/i,/not found.*(?:file|module|package)/i,/(?:file|module|package)\s+not\s+found/i,/missing required/i,/invalid (?:api|token|key)/i,/authentication failed/i,/quota exceeded/i,/rate limit/i],cn=[/not my specialization/i,/outside my scope/i,/better suited for/i,/consider using/i,/specialized agent/i];function ln(t,e=sn){let n=e*Math.pow(2,t-1),i=Math.random()*.1*n;return Math.min(n+i,rn)}function un(t){for(let e of an)if(e.test(t))return!1;return!0}function dn(t){for(let e of cn)if(e.test(t))return!0;return!1}function Y(t,e=[]){let n=on[t];if(n){for(let i of n)if(!e.includes(i))return i}}function Dr(t,e,n,i=[],s=nn){if(c("retry-manager",`Evaluating retry for ${t}, attempt ${e}`),e>=s){let o=Y(t,i);return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Max retries (${s}) exceeded`+(o?`. Consider trying ${o} instead.`:"")}}if(!un(n)){let o=Y(t,i);return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Non-retryable error detected: ${n.slice(0,100)}`}}if(dn(n)){let o=Y(t,i);if(o)return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Error suggests using alternative agent: ${o}`}}let r=ln(e);return{shouldRetry:!0,retryCount:e,maxRetries:s,delayMs:r,reason:`Retrying (attempt ${e+1}/${s}) after ${Math.round(r/1e3)}s`}}function Mr(t,e,n){return{agent:t,taskId:n,attemptNumber:e,startedAt:new Date().toISOString()}}function jr(t,e,n){let i=new Date().toISOString(),s=new Date(i).getTime()-new Date(t.startedAt).getTime();return{...t,completedAt:i,outcome:e,error:n,durationMs:s}}function Or(t){if(t.length===0)return{successRate:0,avgDuration:0,commonErrors:[]};let n=t.filter(a=>a.outcome==="success").length/t.length,i=t.filter(a=>a.durationMs!==void 0).map(a=>a.durationMs),s=i.length>0?i.reduce((a,l)=>a+l,0)/i.length:0,r=new Map;for(let a of t)if(a.error){let l=a.error.slice(0,50).toLowerCase();r.set(l,(r.get(l)||0)+1)}let o=Array.from(r.entries()).sort((a,l)=>l[1]-a[1]).slice(0,3).map(([a])=>a);return{successRate:n,avgDuration:s,commonErrors:o}}function Pr(t,e){return{...t,status:"retrying",retryCount:e.retryCount}}function Hr(t,e){if(t.shouldRetry)return`## Retry Scheduled

Agent \`${e}\` will retry after ${Math.round((t.delayMs||0)/1e3)} seconds.

**Attempt:** ${t.retryCount+1} of ${t.maxRetries}
**Reason:** ${t.reason}`;let n=`## Retry Not Recommended

Agent \`${e}\` has ${t.retryCount>=t.maxRetries?"exhausted retries":"encountered a non-retryable error"}.

**Reason:** ${t.reason}`;return t.alternativeAgent&&(n+=`

### Alternative Suggestion

Consider using \`${t.alternativeAgent}\` instead:

\`\`\`
Task tool with subagent_type: "${t.alternativeAgent}"
\`\`\``),n}import{existsSync as Ht,readFileSync as pn,writeFileSync as gn,mkdirSync as fn}from"node:fs";import{createHash as mn}from"node:crypto";var jt=500,Z=3,Ot=15,Pt=3,hn=.9;function Nt(){return`${m()}/.claude/feedback/calibration-data.json`}function yn(){let t=`${m()}/.claude/feedback`;if(!Ht(t))try{fn(t,{recursive:!0})}catch{}}function P(){let t=Nt();if(Ht(t))try{return JSON.parse(pn(t,"utf8"))}catch{c("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function kn(t){yn();let e=Nt();t.updatedAt=new Date().toISOString();try{gn(e,JSON.stringify(t,null,2)),c("calibration-engine","Saved calibration data")}catch(n){c("calibration-engine",`Failed to save calibration data: ${n}`)}}function bn(t){return mn("sha256").update(t.toLowerCase().trim()).digest("hex").slice(0,16)}function Br(t,e,n,i,s,r,o){let a=P(),l={timestamp:new Date().toISOString(),sessionId:y(),agent:e,promptHash:bn(t),matchedKeywords:n,dispatchConfidence:i,outcome:s,durationMs:r,feedback:o};a.records.push(l),a.records.length>jt&&(a.records=a.records.slice(-jt)),Sn(a,l),wn(a),kn(a),c("calibration-engine",`Recorded outcome: ${e} -> ${s} (conf: ${i})`)}function Sn(t,e){let n=e.outcome==="success",i=e.outcome==="failure"||e.outcome==="rejected";if(!n&&!i)return;let s=n?Pt:-Pt;for(let r of e.matchedKeywords){let o=t.adjustments.find(a=>a.keyword===r&&a.agent===e.agent);o?(o.adjustment=Math.max(-Ot,Math.min(Ot,o.adjustment+s)),o.sampleCount++,o.lastUpdated=new Date().toISOString()):t.adjustments.push({keyword:r,agent:e.agent,adjustment:s,sampleCount:1,lastUpdated:new Date().toISOString()})}}function Gr(t){let e=Date.now(),n=1440*60*1e3;for(let i of t.adjustments){let s=e-new Date(i.lastUpdated).getTime();Math.floor(s/n)>7&&(i.adjustment=Math.round(i.adjustment*hn),Math.abs(i.adjustment)<1&&(i.adjustment=0))}t.adjustments=t.adjustments.filter(i=>i.adjustment!==0)}function wn(t){let e=t.records;if(e.length===0)return;t.stats.totalDispatches=e.length;let n=e.filter(r=>r.outcome==="success").length;t.stats.successRate=n/e.length;let i=e.reduce((r,o)=>r+o.dispatchConfidence,0)/e.length;t.stats.avgConfidence=Math.round(i);let s=new Map;for(let r of e){let o=s.get(r.agent)||{count:0,success:0};o.count++,r.outcome==="success"&&o.success++,s.set(r.agent,o)}t.stats.topAgents=Array.from(s.entries()).map(([r,o])=>({agent:r,count:o.count,successRate:o.success/o.count})).sort((r,o)=>o.count-r.count).slice(0,10)}function Lt(){return P().adjustments.filter(e=>e.sampleCount>=Z)}function qr(t){let n=P().records.filter(s=>s.agent===t);return n.length<Z?null:n.filter(s=>s.outcome==="success").length/n.length}function zr(){return P().stats}function Kr(){return P().records.length>=Z}var Ut=[{type:"product-thinking",name:"Product Thinking Pipeline",description:"Full product discovery and specification workflow",triggers:["should we build","product decision","feature validation","market research","user research"],steps:[{agent:"market-intelligence",description:"Analyze competitive landscape and market trends",dependsOn:[],skills:["market-research"],estimatedTokens:3e3},{agent:"ux-researcher",description:"Create personas and map user journeys",dependsOn:[0],skills:["user-research"],estimatedTokens:2500},{agent:"product-strategist",description:"Validate value proposition and alignment",dependsOn:[0,1],skills:["product-strategy"],estimatedTokens:2e3},{agent:"prioritization-analyst",description:"Score and prioritize using frameworks",dependsOn:[2],skills:["prioritization"],estimatedTokens:1500},{agent:"business-case-builder",description:"Build ROI and cost-benefit analysis",dependsOn:[2,3],skills:["business-case"],estimatedTokens:2e3},{agent:"requirements-translator",description:"Transform to PRD and user stories",dependsOn:[4],skills:["requirements"],estimatedTokens:2500}],estimatedTotalTokens:13500},{type:"full-stack-feature",name:"Full-Stack Feature Pipeline",description:"End-to-end feature implementation workflow",triggers:["full-stack feature","build a feature","implement end-to-end","create full feature","add complete feature"],steps:[{agent:"backend-system-architect",description:"Design API and database schema",dependsOn:[],skills:["api-design-framework","database-schema-designer"],estimatedTokens:3e3},{agent:"frontend-ui-developer",description:"Build React components and UI",dependsOn:[0],skills:["react-server-components-framework","form-state-patterns"],estimatedTokens:3500},{agent:"test-generator",description:"Create unit and integration tests",dependsOn:[0,1],skills:["integration-testing","msw-mocking"],estimatedTokens:2e3},{agent:"security-auditor",description:"Audit for vulnerabilities",dependsOn:[0,1],skills:["owasp-top-10","auth-patterns"],estimatedTokens:1500}],estimatedTotalTokens:1e4},{type:"ai-integration",name:"AI Integration Pipeline",description:"Add AI/LLM capabilities to application",triggers:["add rag","add llm","ai integration","implement rag","add ai feature","langgraph workflow"],steps:[{agent:"workflow-architect",description:"Design LangGraph workflow and state",dependsOn:[],skills:["langgraph-state","langgraph-routing"],estimatedTokens:2500},{agent:"llm-integrator",description:"Connect LLM APIs with function calling",dependsOn:[0],skills:["function-calling","llm-streaming"],estimatedTokens:2e3},{agent:"data-pipeline-engineer",description:"Build embeddings and data pipeline",dependsOn:[0],skills:["embeddings","rag-retrieval"],estimatedTokens:2500},{agent:"test-generator",description:"Create LLM testing infrastructure",dependsOn:[1,2],skills:["llm-testing","property-based-testing"],estimatedTokens:1500}],estimatedTotalTokens:8500},{type:"security-audit",name:"Security Audit Pipeline",description:"Comprehensive security review workflow",triggers:["security audit","security review","vulnerability scan","security assessment"],steps:[{agent:"security-auditor",description:"Scan for OWASP Top 10 vulnerabilities",dependsOn:[],skills:["owasp-top-10","input-validation"],estimatedTokens:2e3},{agent:"security-layer-auditor",description:"Verify defense-in-depth layers",dependsOn:[0],skills:["defense-in-depth"],estimatedTokens:2e3},{agent:"ai-safety-auditor",description:"Audit AI/LLM security if applicable",dependsOn:[0],skills:["mcp-security-hardening"],estimatedTokens:1500}],estimatedTotalTokens:5500},{type:"frontend-compliance",name:"Frontend 2026 Compliance Pipeline",description:"Modernize frontend to 2026 patterns",triggers:["frontend compliance","modernize frontend","update react","frontend 2026"],steps:[{agent:"frontend-ui-developer",description:"Upgrade to React 19 patterns",dependsOn:[],skills:["react-server-components-framework","zustand-patterns"],estimatedTokens:3e3},{agent:"performance-engineer",description:"Optimize Core Web Vitals",dependsOn:[0],skills:["core-web-vitals","lazy-loading-patterns"],estimatedTokens:2e3},{agent:"accessibility-specialist",description:"Ensure WCAG 2.2 compliance",dependsOn:[0],skills:["a11y-testing","focus-management"],estimatedTokens:1500}],estimatedTotalTokens:6500}];function Ft(t){let e=t.toLowerCase();for(let n of Ut)for(let i of n.triggers)if(e.includes(i))return c("multi-agent-coordinator",`Detected pipeline: ${n.type} (trigger: "${i}")`),n;return null}function Vr(t){return Ut.find(e=>e.type===t)||null}function Bt(t){let e=`pipeline-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,n=[],i={};for(let r=0;r<t.steps.length;r++){let o=t.steps[r],a=`task-${e}-${r}`;i[r]=a;let l={source:"pipeline",dispatchedAgent:o.agent,pipelineId:e,pipelineStep:r,relatedSkills:o.skills},p=o.dependsOn.map(d=>i[d]).filter(Boolean);n.push({subject:`[${t.name}] Step ${r+1}: ${o.description}`,description:`Pipeline step: ${o.agent}

${o.description}

Estimated tokens: ${o.estimatedTokens}`,activeForm:`Running ${o.agent}`,metadata:l,blockedBy:p.length>0?p:void 0})}return{execution:{pipelineId:e,type:t.type,startedAt:new Date().toISOString(),taskIds:i,currentStep:0,completedSteps:[],status:"running"},tasks:n}}function Gt(t,e){Dt(t);for(let n=0;n<e.length;n++){let i=e[n],s=t.taskIds[n];s&&i.metadata.dispatchedAgent&&Et(s,i.metadata.dispatchedAgent,i.metadata.dispatchConfidence||100,t.pipelineId,n)}c("multi-agent-coordinator",`Registered pipeline ${t.pipelineId} with ${e.length} tasks`)}function qt(t,e,n){let i=`## \u{1F504} Pipeline Detected: ${t.name}

${t.description}

**Pipeline ID:** \`${e.pipelineId}\`
**Estimated Total Tokens:** ~${t.estimatedTotalTokens}

### Pipeline Steps

`;for(let s=0;s<t.steps.length;s++){let r=t.steps[s],o=r.dependsOn.length>0?` (after steps: ${r.dependsOn.map(a=>a+1).join(", ")})`:" (can start immediately)";i+=`**${s+1}. ${r.agent}**${o}
   ${r.description}
   Skills: ${r.skills?.join(", ")||"none"}

`}i+=`### Task Creation Instructions

Create these tasks to track the pipeline:

`;for(let s=0;s<n.length;s++){let r=n[s];i+=`**Task ${s+1}:**
\`\`\`
TaskCreate:
  subject: "${r.subject}"
  activeForm: "${r.activeForm}"
${r.blockedBy?`  blockedBy: ${JSON.stringify(r.blockedBy)}`:""}
\`\`\`

`}return i+=`### Start Pipeline

After creating all tasks, spawn the first agent:

\`\`\`
Task tool with subagent_type: "${t.steps[0].agent}"
\`\`\`

The orchestration layer will track progress and suggest next agents as steps complete.`,i}var xn=["implement","add","create","build","set up","configure","pagination","authentication","caching","database","api","endpoint"];function _n(t){let e=t.toLowerCase();return/pagination|cursor|offset|page/i.test(e)?"pagination":/auth|jwt|oauth|login|session/i.test(e)?"authentication":/cache|redis|memo/i.test(e)?"caching":/database|sql|postgres|query/i.test(e)?"database":/api|endpoint|rest|graphql/i.test(e)?"api":/error|exception|handling/i.test(e)?"error-handling":/test|testing|spec/i.test(e)?"testing":"general"}function In(t,e){return`project:${e.split("/").pop()||"unknown"}:${t}`}function vn(t){return`global:${t}`}function zt(t){let e=t.prompt||"",n=t.project_dir||m();if(e.length<30)return u();let i=e.toLowerCase(),s="";for(let p of xn)if(i.includes(p)){s=p;break}if(!s)return u();c("antipattern-detector",`Implementation keyword detected: ${s}`);let r=_n(e),o=In("best-practices",n),a=vn("best-practices");return c("antipattern-detector",`Suggesting antipattern check for: ${s} (category: ${r})`),{continue:!0,systemMessage:`[Antipattern Check] Before implementing ${s}, check for known failures:
\`mcp__mem0__search_memories\` with query="${s} failed" and filters={"AND":[{"user_id":"${o}"},{"metadata.outcome":"failed"}]}
Or check global: user_id="${a}"`}}import{existsSync as Kt,readFileSync as Wt}from"node:fs";import{join as Jt}from"node:path";var Tn=["implement","add","create","build","set up","setup","configure","use","write","make","develop"],Cn=[{pattern:"offset pagination",warning:"Offset pagination causes performance issues on large tables. Use cursor-based pagination instead."},{pattern:"manual jwt validation",warning:"Manual JWT validation is error-prone. Use established libraries like python-jose or jsonwebtoken."},{pattern:"storing passwords in plaintext",warning:"Never store passwords in plaintext. Use bcrypt, argon2, or scrypt."},{pattern:"global state",warning:"Global mutable state causes testing and concurrency issues. Use dependency injection."},{pattern:"synchronous file operations",warning:"Synchronous file I/O blocks the event loop. Use async file operations."},{pattern:"n+1 query",warning:"N+1 queries cause performance problems. Use eager loading or batch queries."},{pattern:"polling for real-time",warning:"Polling is inefficient for real-time updates. Consider SSE or WebSocket."}];function An(t){let e=t.toLowerCase();for(let n of Tn)if(e.includes(n))return!0;return!1}function $n(t){let e=t.toLowerCase();return/pagination|cursor|offset|page/i.test(e)?"pagination":/auth|jwt|oauth|login|session/i.test(e)?"authentication":/cache|redis|memo/i.test(e)?"caching":/database|sql|postgres|query/i.test(e)?"database":/api|endpoint|rest|graphql/i.test(e)?"api":"general"}function Rn(t,e){let n=t.toLowerCase(),i=[];for(let{pattern:o,warning:a}of Cn)n.includes(o)&&i.push(a);let s=Jt(e,".claude","feedback","learned-patterns.json");if(Kt(s))try{let a=(JSON.parse(Wt(s,"utf8")).patterns||[]).filter(l=>l.outcome==="failed");for(let l of a)if(l.text){let d=l.text.toLowerCase().split(" ")[0];d&&n.includes(d)&&i.push(`Previously failed: ${l.text}`)}}catch{}let r=Jt(process.env.HOME||process.env.USERPROFILE||"",".claude","global-patterns.json");if(Kt(r))try{let o=JSON.parse(Wt(r,"utf8"));for(let{pattern:a,warning:l}of o.antipatterns||[])n.includes(a.toLowerCase())&&i.push(`${a}: ${l}`)}catch{}return i}function En(t,e){return`project:${e.split("/").pop()||"unknown"}:${t}`}function Dn(t,e){let n=$n(t),i=En("best-practices",e);return`Before implementing, search Mem0 for relevant patterns (graph memory enabled):

1. Project anti-patterns (category: ${n}):
   mcp__mem0__search_memories with:
   {"query": "${t.slice(0,50)}", "user_id": "${i}", "filters": {"metadata.outcome": "failed"}}

2. Project best practices:
   mcp__mem0__search_memories with:
   {"query": "${t.slice(0,50)}", "user_id": "${i}", "filters": {"metadata.outcome": "success"}}

3. Cross-project failures:
   mcp__mem0__search_memories with:
   {"query": "${t.slice(0,50)}", "user_id": "global:best-practices", "filters": {"metadata.outcome": "failed"}}`}function Xt(t){let e=t.prompt||"",n=t.project_dir||m();if(!e)return u();if(!An(e))return u();c("antipattern-warning","Checking prompt for anti-patterns...");let i=Rn(e,n),s=Dn(e,n);if(i.length>0){c("antipattern-warning",`Found anti-pattern warnings: ${i.join(", ")}`);let r=`## Anti-Pattern Warning

The following patterns have previously caused issues:

${i.map(o=>`- ${o}`).join(`
`)}

Consider alternative approaches before proceeding.

${s}`;return b(r)}return/implement|build|create|develop/.test(e.toLowerCase())?b(s):u()}import{existsSync as Mn}from"node:fs";import{join as jn}from"node:path";function Vt(t){let e=t.prompt||"",n=t.project_dir||m();c("context-injector",`User prompt received (${e.length} chars)`);let i=[];if(/issue|bug|fix|#[0-9]+/.test(e)){let s=jn(n,"docs","issues");Mn(s)&&i.push("Check docs/issues/ for issue documentation.")}return/test|testing|pytest|jest/.test(e.toLowerCase())&&i.push("Remember to use 'tee' for visible test output."),/deploy|ci|cd|pipeline|github.actions/.test(e.toLowerCase())&&i.push("Check .github/workflows/ for CI configuration."),i.length>0&&c("context-injector",`Context hints: ${i.join(" ")}`),u()}import{existsSync as Zt,readFileSync as On,writeFileSync as Pn,mkdirSync as Hn}from"node:fs";import{join as Nn}from"node:path";var Yt=.7,Ln=.95,Un=8,Fn=15,Bn=5;function Gn(t){if(!t)return 0;let e=Date.now(),n;if(/^\d+$/.test(t))n=parseInt(t,10);else if(n=new Date(t).getTime(),isNaN(n))return 0;let i=(e-n)/(1e3*60);return i<=5?10:i<=15?8:i<=30?6:i<=60?4:i<=120?2:0}function qn(t){return t>=10?10:t>=7?8:t>=4?6:t>=2?4:t>=1?2:0}function zn(t,e){if(t.length===0||e.length===0)return 2;let n=new Set(t.map(o=>o.toLowerCase())),i=new Set(e.map(o=>o.toLowerCase())),s=0;for(let o of n)i.has(o)&&s++;let r=s/n.size;return r>=.75?10:r>=.5?8:r>=.3?6:r>=.15?4:s>0?2:0}function Kn(t){let e=new Set(["the","and","for","with","from","that","this","have","will","can","should","would","could"]);return t.toLowerCase().match(/\b[a-z]{3,}\b/g)?.filter(n=>!e.has(n)).slice(0,20)||[]}function Wn(){return`/tmp/claude-context-tracking-${y()}.json`}function Jn(){let t=Wn();if(Zt(t))try{return JSON.parse(On(t,"utf8"))}catch{}let n={session_id:y(),updated_at:new Date().toISOString(),total_context_tokens:0,context_budget:12e3,items:[]};return Pn(t,JSON.stringify(n,null,2)),n}function Xn(t){let e=process.env.CLAUDE_CONTEXT_USAGE_PERCENT;if(e){let n=parseFloat(e);if(!isNaN(n))return n}return t.context_budget>0?t.total_context_tokens/t.context_budget:0}function Vn(t,e){let n=[];for(let i of t.items){let s=i.last_accessed||i.loaded_at,r=i.access_count||0,o=i.tags||[],a=Gn(s),l=qn(r),p=zn(o,e),d=a+l+p;c("context-pruning-advisor",`Scored ${i.id}: R=${a} F=${l} V=${p} Total=${d}`),d<=Fn&&n.push({score:d,priority:d<=Un?"HIGH":"MED",itemId:i.id,tokens:i.estimated_tokens||500})}return n.sort((i,s)=>i.score-s.score).slice(0,Bn)}function Yn(t){let e=0,n=[];for(let i=0;i<t.length;i++){let{priority:s,itemId:r,score:o,tokens:a}=t[i];e+=a;let l=r.replace(/^(skill:|file:|agent:)/,"");n.push(`  ${i+1}. [${s}] ${l} (score: ${o}, saves ~${a}t)`)}return`Context usage >70%. Pruning recommendations:
${n.join(`
`)}

Potential savings: ~${e} tokens
To prune: Archive or unload low-scoring context items.`}function Qt(t){let e=t.project_dir||m(),n=t.prompt||"",i=Nn(e,"logs");if(!Zt(i))try{Hn(i,{recursive:!0})}catch{}let s=Jn(),r=Xn(s);if(c("context-pruning-advisor",`Context usage: ${r} (trigger threshold: ${Yt})`),r<Yt)return c("context-pruning-advisor","Context usage within limits, no pruning needed"),u();if(r>=Ln){c("context-pruning-advisor",`CRITICAL: Context usage at ${r*100}% (>95%)`);let l=`CRITICAL: Context usage at ${Math.round(r*100)}% (>95%). Use /ork:context-compression immediately or manually archive old decisions and patterns.`;return b(l)}if(!n)return c("context-pruning-advisor","No user prompt found in hook input, skipping analysis"),u();let o=Kn(n);c("context-pruning-advisor",`Extracted prompt keywords: ${o.join(", ")}`);let a=Vn(s,o);if(a.length>0){let l=Yn(a);return c("context-pruning-advisor",`Recommending ${a.length} pruning candidates`),b(l)}return u()}import{existsSync as Zn,readFileSync as Qn}from"node:fs";import{join as ti}from"node:path";var ei=["add","implement","create","build","design","refactor","update","modify","fix","change","continue","resume","remember","previous","last time","before","earlier","pattern","decision","how did we","what did we"],ni=["relationship","related","connected","depends","uses","recommends","what does.*recommend","how does.*work with"],ii=20;function si(t){let e=t.toLowerCase();for(let n of ei)if(e.includes(n))return!0;return!1}function ri(t){let e=t.toLowerCase();for(let n of ni)if(new RegExp(n,"i").test(e))return!0;return!1}function oi(t){let e=new Set(["the","a","an","to","for","in","on","at","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","can","may","might","must","shall","i","you","we","they","it","this","that","these","those","my","your","our","their","its","and","or","but","if","then","else","when","where","how","what","which","who","whom","with","from","into","onto","about","after","before","global"]);return t.toLowerCase().replace(/[^a-z\s]/g," ").split(/\s+/).filter(i=>i.length>2&&!e.has(i)).slice(0,5).join(" ")}function ai(t,e){return`project:${e.split("/").pop()||"unknown"}:${t}`}function ci(t){let e=process.env.CLAUDE_AGENT_ID;if(e)return e;let n=ti(t,".claude","session","current-agent-id");if(Zn(n))try{return Qn(n,"utf8").trim()}catch{}return""}function te(t){let e=t.prompt||"",n=t.project_dir||m(),i=!1;if(c("memory-context",`Memory context hook starting (graph-first, mem0=${i})`),e.length<ii)return c("memory-context",`Prompt too short (${e.length} chars), skipping memory search`),u();let s=e.startsWith("@global")||e.includes("cross-project")||e.includes("all projects"),r=ri(e);s&&c("memory-context","Detected @global prefix - will suggest cross-project search"),r&&c("memory-context","Detected graph-related query");let o=ci(n);if(o&&c("memory-context",`Agent context detected: ${o}`),!si(e))return c("memory-context","No memory trigger keywords found, skipping"),u();let a=oi(e);if(!a)return c("memory-context","No search terms extracted, skipping"),u();c("memory-context",`Search terms: ${a}`);let l=s?"cross-project":"project",p=ai("decisions",n),d=`[Memory Context] For relevant past ${l} decisions, use mcp__memory__search_nodes with query="${a}"`;return r&&(d+=" | For relationships: mcp__memory__open_nodes on found entities | Graph traversal available"),i&&p&&(d+=` | [Enhanced] For semantic search: mcp__mem0__search_memories query="${a}" user_id="${p}" enable_graph=true`,s||(d+=' | Cross-project: user_id="global:best-practices"')),o&&(d+=` | Agent context: ${o}`),c("memory-context",`Memory context available for: ${a}`),u()}import{existsSync as bi,appendFileSync as Si,mkdirSync as wi,readFileSync as To,readdirSync as Co}from"node:fs";import{existsSync as li,readFileSync as ui,writeFileSync as bo,mkdirSync as So}from"node:fs";import{execSync as ee}from"node:child_process";import{createHash as di}from"node:crypto";import*as ne from"node:os";var pi=".claude/.user_identity.json",gi="orchestkit-user-identity-v1";var x=null;function q(t){return di("sha256").update(t+gi).digest("hex").slice(0,16)}function fi(){try{return ne.hostname()}catch{return"unknown-machine"}}function mi(t){let e=`${t}/${pi}`;if(!li(e))return null;try{let n=ui(e,"utf8");return JSON.parse(n)}catch(n){return c("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function hi(t){let e={};try{e.email=ee("git config user.email",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{e.name=ee("git config user.name",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return e}function yi(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function ki(t){if(x)return x;let e=t||m(),n=fi(),i=mi(e);if(i?.user_id)return x={user_id:i.user_id,display_name:i.display_name||i.user_id,team_id:i.team_id,machine_id:n,source:"config",anonymous_id:q(i.user_id),email:i.user_id.includes("@")?i.user_id:void 0},c("user-identity",`Resolved from config: ${x.user_id}`,"debug"),x;let s=hi(e);if(s.email)return x={user_id:s.email,display_name:s.name||s.email.split("@")[0],team_id:i?.team_id,machine_id:n,source:"git",anonymous_id:q(s.email),email:s.email},c("user-identity",`Resolved from git: ${x.user_id}`,"debug"),x;let r=yi();if(r.username){let a=`${r.username}@${n}`;return x={user_id:a,display_name:r.username,team_id:i?.team_id,machine_id:n,source:"env",anonymous_id:q(a)},c("user-identity",`Resolved from env: ${x.user_id}`,"debug"),x}let o=q(n+process.pid);return x={user_id:`anon-${o.slice(0,8)}`,display_name:"Anonymous",team_id:i?.team_id,machine_id:n,source:"anonymous",anonymous_id:o},c("user-identity",`Resolved as anonymous: ${x.user_id}`,"debug"),x}function ie(){let t=ki();return{session_id:y(),user_id:t.user_id,anonymous_id:t.anonymous_id,team_id:t.team_id,machine_id:t.machine_id,identity_source:t.source,timestamp:new Date().toISOString()}}function re(t){let e=t||y();return`${m()}/.claude/memory/sessions/${e}`}function xi(t){return`${re(t)}/events.jsonl`}function _i(t){let e=re(t);bi(e)||wi(e,{recursive:!0})}var se=0;function Ii(){return se++,`evt-${Date.now()}-${se}`}function H(t,e,n={}){try{let i={event_id:Ii(),event_type:t,identity:ie(),payload:{name:e,input:Q(n.input),output:Q(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?le(n.context,500):void 0,confidence:n.confidence}};_i();let s=xi();Si(s,JSON.stringify(i)+`
`),c("session-tracker",`Tracked ${t}: ${e}`,"debug")}catch(i){c("session-tracker",`Failed to track event: ${i}`,"warn")}}function oe(t,e,n){H("decision_made","decision",{context:t,input:e?{rationale:e}:void 0,confidence:n,success:!0})}function ae(t,e){H("preference_stated","preference",{context:t,confidence:e,success:!0})}function ce(t){H("problem_reported","problem",{context:t,success:!0})}function le(t,e){return t.length<=e?t:t.slice(0,e-3)+"..."}function Q(t){if(!t)return;let e={},n=["password","secret","token","key","credential","auth"];for(let[i,s]of Object.entries(t)){if(n.some(r=>i.toLowerCase().includes(r))){e[i]="[REDACTED]";continue}if(typeof s=="string"&&s.length>500){e[i]=le(s,500);continue}if(typeof s=="object"&&s!==null&&!Array.isArray(s)){e[i]=Q(s);continue}e[i]=s}return e}import{existsSync as tt,readFileSync as vi,writeFileSync as Ti,appendFileSync as Ci,mkdirSync as ue}from"node:fs";import{join as et,dirname as Ai}from"node:path";var $i=2,Ri=[/\bthank/i,/\bgreat\b/i,/\bperfect\b/i,/\bexcellent\b/i,/\bawesome\b/i,/\bworks?\b.*\b(well|great|perfectly)/i,/\bthat('s| is) (exactly|just) what/i,/\bnice\b/i,/\bgood job\b/i,/\bwell done\b/i,/\blooks? good\b/i,/\blgtm\b/i,/\bship it\b/i],Ei=[/\bno(t| ).*right/i,/\bwrong\b/i,/\bdoesn't work/i,/\bbroken\b/i,/\bfailed\b/i,/\btry again\b/i,/\bstart over\b/i,/\bundo\b/i,/\brevert\b/i,/\bfrustrat/i,/\bannoy/i,/\bconfus/i,/\bstill (not|doesn't)/i,/\bdidn't (work|help)/i,/\bthat's not/i];function Di(t){for(let e of Ri)if(e.test(t))return"positive";for(let e of Ei)if(e.test(t))return"negative";return"neutral"}function Mi(t){return et(t,".claude",".satisfaction-counter")}function ji(t){let e=Mi(t),n=Ai(e);if(!tt(n))try{ue(n,{recursive:!0})}catch{}let i=0;if(tt(e))try{i=parseInt(vi(e,"utf8").trim(),10)||0}catch{}i++;try{Ti(e,String(i))}catch{}return i}function Oi(t,e,n,i){let s=et(i,".claude","feedback"),r=et(s,"satisfaction.log");if(!tt(s))try{ue(s,{recursive:!0})}catch{return}let a=`${new Date().toISOString()} | ${t} | ${e} | ${n}
`;try{Ci(r,a)}catch{}}function de(t){let e=t.prompt||"",n=t.project_dir||m(),i=t.session_id||y(),s=parseInt(process.env.SATISFACTION_SAMPLE_RATE||"3",10),r=ji(n);if(s>1&&r%s!==0)return u();if(c("satisfaction-detector",`Satisfaction detector hook starting (sample ${r})`),!e)return u();if(e.length<$i)return u();if(e.startsWith("/"))return u();let o=Di(e);if(o!=="neutral"){let a=e.slice(0,50);e.length>50&&(a+="..."),Oi(i,o,a,n);try{H("preference_stated",o,{context:a,success:!0})}catch{}c("satisfaction-detector",`Detected ${o} satisfaction signal`)}return u()}var Pi=[/implement/i,/refactor/i,/add feature/i,/create.*component/i,/build.*system/i,/fix.*multiple/i,/update.*across/i,/migrate/i],Hi=500;function pe(t){let e=t.prompt||"",n=e.length;c("todo-enforcer",`Prompt length: ${n} chars`);let i=!1;for(let s of Pi)if(s.test(e)){i=!0;break}return n>Hi&&(i=!0),i&&c("todo-enforcer","Complex task detected - todo tracking recommended"),u()}var Ni=2;function Li(t){if(t.length===0)return"";let e=t[0],n="";if(e.confidence>=S.AUTO_DISPATCH?n=`## \u{1F3AF} AGENT DISPATCH RECOMMENDED

**Agent:** \`${e.agent}\` (${e.confidence}% confidence)

This task strongly matches the agent's specialization. **Spawn this agent:**

\`\`\`
Task tool with subagent_type: "${e.agent}"
\`\`\`

Matched: ${e.matchedKeywords.slice(0,5).join(", ")}`:e.confidence>=S.STRONG_RECOMMEND?n=`## Agent Recommendation

**RECOMMENDED:** \`${e.agent}\` (${e.confidence}% match)
${e.description}

Matched keywords: ${e.matchedKeywords.slice(0,4).join(", ")}

Consider spawning with: \`Task tool, subagent_type: "${e.agent}"\``:e.confidence>=S.SUGGEST&&(n=`## Agent Suggestion

**Consider:** \`${e.agent}\` (${e.confidence}% match)

This agent specializes in: ${e.matchedKeywords.slice(0,3).join(", ")}`),t.length>1&&t[1].confidence>=S.SUGGEST){let i=t[1];n+=`

**Alternative:** \`${i.agent}\` (${i.confidence}% match)`}return n}function ge(t){let e=t.prompt||"";if(!M(e))return u();if(A().enableAutoDispatch)return c("agent-auto-suggest","Deferring to agent-orchestrator (auto-dispatch enabled)"),u();c("agent-auto-suggest","Analyzing prompt with intent classifier...");let i=G(),s=Lt(),o=D(e,i,s).agents.slice(0,Ni);if(o.length===0)return c("agent-auto-suggest","No agent matches found"),u();c("agent-auto-suggest",`Found matches: ${o.map(l=>`${l.agent}:${l.confidence}`).join(", ")}`);let a=Li(o);return a?(c("agent-auto-suggest",`Suggesting ${o[0].agent} at ${o[0].confidence}%`),b(a)):u()}function Ui(t,e){return`## \u{1F3AF} AUTO-DISPATCH: ${t.agent}

**Confidence:** ${t.confidence}% (auto-dispatch threshold: ${S.AUTO_DISPATCH}%)

This task strongly matches the agent's specialization. **IMMEDIATELY spawn this agent:**

\`\`\`
Task tool with subagent_type: "${t.agent}"
\`\`\`

**Matched Keywords:** ${t.matchedKeywords.slice(0,5).join(", ")}

### CC 2.1.16 Task Instruction
Before spawning, create a task to track this work:

\`\`\`json
TaskCreate:
{
  "subject": "${t.agent.replace(/-/g," ")} implementation",
  "description": "Agent dispatched automatically at ${t.confidence}% confidence",
  "activeForm": "Working on ${t.description.toLowerCase()}",
  "metadata": ${JSON.stringify(e)}
}
\`\`\`

After creating the task, spawn the agent with the task ID in the prompt.`}function Fi(t){return`## Agent Recommendation

**RECOMMENDED:** \`${t.agent}\` (${t.confidence}% confidence)

${t.description}

**Matched:** ${t.matchedKeywords.slice(0,4).join(", ")}

**Spawn with:**
\`\`\`
Task tool with subagent_type: "${t.agent}"
\`\`\``}function Bi(t){return`## Agent Suggestion

**Consider:** \`${t.agent}\` (${t.confidence}% match)

This agent specializes in: ${t.matchedKeywords.slice(0,3).join(", ")}`}function Gi(t){return`

**Alternative:** \`${t.agent}\` (${t.confidence}% match)`}function qi(t,e){if(t.agents.length===0)return"";let n=t.agents[0],i="";if(_t(n.agent))return c("agent-orchestrator",`Agent ${n.agent} already dispatched, skipping`),"";if(e.enableAutoDispatch&&n.confidence>=S.AUTO_DISPATCH){let s={source:"orchestration",dispatchedAgent:n.agent,dispatchConfidence:n.confidence,relatedSkills:t.skills.slice(0,3).map(r=>r.skill),dispatchSignals:n.signals.slice(0,5)};xt(n.agent,n.confidence),i=Ui(n,s)}else n.confidence>=S.STRONG_RECOMMEND?i=Fi(n):n.confidence>=S.SUGGEST&&(i=Bi(n));return t.agents.length>1&&t.agents[1].confidence>=S.SUGGEST&&(i+=Gi(t.agents[1])),i}function fe(t){let e=t.prompt||"";if(!M(e))return u();c("agent-orchestrator","Classifying intent for orchestration...");let n=A(),i=G(),s=D(e,i);if(Ct(s),Tt(e.slice(0,500)),c("agent-orchestrator",`Classification: intent=${s.intent}, agents=[${s.agents.map(o=>`${o.agent}:${o.confidence}`).join(", ")}], autoDispatch=${s.shouldAutoDispatch}`),s.agents.length===0)return c("agent-orchestrator","No agent matches found"),u();let r=qi(s,n);return r?b(r):u()}var zi=15,Ki=["what is","explain","how does","tell me about","describe","list","show me"];function Wi(t){let e=t.toLowerCase();for(let n of Ki)if(e.startsWith(n))return!0;return!!(t.endsWith("?")&&t.length<100)}function Ji(){let t=Mt();return t!==void 0&&t.status==="running"}function me(t){let e=t.prompt||"";if(e.length<zi)return u();if(Wi(e))return u();if(!A().enablePipelines)return u();if(Ji())return c("pipeline-detector","Already in active pipeline, skipping detection"),u();c("pipeline-detector","Checking for pipeline triggers...");let i=Ft(e);if(!i)return c("pipeline-detector","No pipeline triggers detected"),u();c("pipeline-detector",`Detected pipeline: ${i.type}`);let{execution:s,tasks:r}=Bt(i);Gt(s,r);let o=qt(i,s,r);return c("pipeline-detector",`Created pipeline ${s.pipelineId} with ${r.length} steps`),b(o)}import{existsSync as nt,readFileSync as it}from"node:fs";import{join as st}from"node:path";var Xi=3;var Vi=[["api","api-design-framework",80],["endpoint","api-design-framework",70],["rest","api-design-framework",75],["graphql","api-design-framework",75],["route","api-design-framework",60],["fastapi","fastapi-advanced",90],["uvicorn","fastapi-advanced",70],["starlette","fastapi-advanced",60],["middleware","fastapi-advanced",50],["pydantic","fastapi-advanced",60],["database","database-schema-designer",80],["schema","database-schema-designer",70],["table","database-schema-designer",50],["migration","alembic-migrations",85],["alembic","alembic-migrations",95],["sql","database-schema-designer",60],["postgres","database-schema-designer",70],["query","database-schema-designer",40],["index","database-schema-designer",50],["sqlalchemy","sqlalchemy-2-async",85],["async.*database","sqlalchemy-2-async",80],["orm","sqlalchemy-2-async",60],["connection.*pool","connection-pooling",90],["pool","connection-pooling",60],["pgvector","pgvector-search",95],["vector.*search","pgvector-search",85],["embedding","embeddings",80],["auth","auth-patterns",85],["login","auth-patterns",75],["jwt","auth-patterns",80],["oauth","auth-patterns",85],["passkey","auth-patterns",90],["webauthn","auth-patterns",90],["session","auth-patterns",60],["password","auth-patterns",70],["security","owasp-top-10",75],["owasp","owasp-top-10",95],["xss","owasp-top-10",80],["injection","owasp-top-10",80],["csrf","owasp-top-10",80],["validation","input-validation",70],["sanitiz","input-validation",80],["defense.*depth","defense-in-depth",95],["test","integration-testing",60],["unit.*test","pytest-advanced",80],["pytest","pytest-advanced",90],["integration.*test","integration-testing",85],["e2e","e2e-testing",90],["playwright","e2e-testing",80],["mock","msw-mocking",75],["msw","msw-mocking",95],["fixture","test-data-management",80],["test.*data","test-data-management",85],["coverage","pytest-advanced",60],["property.*test","property-based-testing",90],["hypothesis","property-based-testing",95],["contract.*test","contract-testing",95],["pact","contract-testing",95],["golden.*dataset","golden-dataset-validation",90],["performance.*test","performance-testing",90],["load.*test","performance-testing",85],["k6","performance-testing",95],["locust","performance-testing",95],["react","react-server-components-framework",70],["component","react-server-components-framework",50],["server.*component","react-server-components-framework",95],["nextjs","react-server-components-framework",85],["next\\.js","react-server-components-framework",85],["suspense","react-server-components-framework",70],["streaming.*ssr","react-server-components-framework",90],["form","form-state-patterns",70],["react.*hook.*form","form-state-patterns",95],["zod","form-state-patterns",60],["zustand","zustand-patterns",95],["state.*management","zustand-patterns",70],["tanstack","tanstack-query-advanced",90],["react.*query","tanstack-query-advanced",85],["radix","radix-primitives",95],["shadcn","radix-primitives",80],["tailwind","design-system-starter",60],["design.*system","design-system-starter",85],["animation","motion-animation-patterns",80],["framer","motion-animation-patterns",90],["core.*web.*vital","core-web-vitals",95],["lcp","core-web-vitals",80],["cls","core-web-vitals",80],["inp","core-web-vitals",80],["i18n","i18n-date-patterns",90],["internationalization","i18n-date-patterns",95],["locale","i18n-date-patterns",70],["accessibility","a11y-testing",85],["a11y","a11y-testing",95],["wcag","a11y-testing",95],["screen.*reader","focus-management",80],["keyboard.*nav","focus-management",90],["focus","focus-management",60],["aria","focus-management",70],["llm","function-calling",70],["openai","function-calling",60],["anthropic","function-calling",60],["function.*call","function-calling",90],["tool.*use","function-calling",85],["stream","llm-streaming",70],["rag","rag-retrieval",95],["retrieval","rag-retrieval",75],["context","contextual-retrieval",60],["chunk","embeddings",70],["vector","embeddings",75],["semantic.*search","embeddings",85],["langfuse","langfuse-observability",95],["llm.*observ","langfuse-observability",90],["langgraph","langgraph-state",85],["agent","agent-loops",70],["workflow","langgraph-state",60],["supervisor","langgraph-supervisor",90],["human.*in.*loop","langgraph-human-in-loop",95],["checkpoint","langgraph-checkpoints",90],["prompt.*cache","prompt-caching",95],["cache.*llm","semantic-caching",85],["eval","llm-evaluation",70],["llm.*test","llm-testing",85],["ollama","ollama-local",95],["deploy","devops-deployment",75],["ci","devops-deployment",60],["cd","devops-deployment",60],["github.*action","github-operations",85],["release","release-management",80],["changelog","release-management",70],["version","release-management",50],["observ","observability-monitoring",80],["monitor","observability-monitoring",70],["log","observability-monitoring",50],["metric","observability-monitoring",60],["trace","observability-monitoring",70],["alert","observability-monitoring",60],["git","git-workflow",70],["branch","git-workflow",60],["commit","commit",80],["rebase","git-workflow",70],["stacked.*pr","stacked-prs",95],["pr","create-pr",60],["pull.*request","create-pr",75],["recovery","git-recovery-command",80],["reflog","git-recovery-command",95],["milestone","github-operations",80],["issue","github-operations",50],["event.*sourc","event-sourcing",95],["kafka","message-queues",85],["rabbitmq","message-queues",85],["queue","message-queues",75],["pub.*sub","message-queues",80],["outbox","outbox-pattern",95],["saga","event-sourcing",70],["cqrs","event-sourcing",80],["async","asyncio-advanced",70],["asyncio","asyncio-advanced",90],["taskgroup","asyncio-advanced",95],["concurrent","asyncio-advanced",60],["background.*job","background-jobs",90],["celery","background-jobs",95],["worker","background-jobs",60],["distributed.*lock","distributed-locks",95],["redis.*lock","distributed-locks",85],["idempoten","idempotency-patterns",95],["clean.*architecture","clean-architecture",95],["ddd","domain-driven-design",95],["domain.*driven","domain-driven-design",90],["aggregate","aggregate-patterns",90],["adr","architecture-decision-record",95],["decision.*record","architecture-decision-record",85],["lint","biome-linting",70],["biome","biome-linting",95],["eslint","biome-linting",60],["format","biome-linting",50],["code.*review","code-review-playbook",90],["review","code-review-playbook",60],["quality.*gate","quality-gates",90],["error.*handl","error-handling-rfc9457",85],["rfc.*9457","error-handling-rfc9457",95],["problem.*detail","error-handling-rfc9457",90]];function he(t){let e=t.toLowerCase(),n=new Map;for(let[s,r,o]of Vi)if(new RegExp(s,"i").test(e)){let l=n.get(r)||0;o>l&&n.set(r,o)}return Array.from(n.entries()).map(([s,r])=>({skill:s,confidence:r})).sort((s,r)=>r.confidence-s.confidence).slice(0,Xi)}var Yi=800,ye=2,ke=3,be=80,Se=70,Zi=50;function Qi(t,e){let n=$(),i=st(n,"skills",t,"SKILL.md");if(!nt(i))return c("skill-resolver","Skill file not found: "+i),null;try{let s=it(i,"utf8"),r=s.match(/^---\n[\s\S]*?\n---\n/);r&&(s=s.slice(r[0].length)),s=s.replace(/^## References[\s\S]*?(?=^## |\Z)/gm,""),s=s.replace(/```[\s\S]*?```/g,a=>{let l=a.split(`
`);return l.length>12?l.slice(0,7).join(`
`)+"\n# ... truncated\n```":a}),s=s.replace(/\n{3,}/g,`

`),s=s.trim();let o=Math.floor(e*3.5);if(s.length>o){let a=s.slice(0,o),l=a.lastIndexOf(`

`);l>o*.6?s=a.slice(0,l)+`

[... truncated for context budget]`:s=a+`

[... truncated for context budget]`}return s}catch(s){return c("skill-resolver","Failed to load skill: "+String(s)),null}}function ts(t){let e=$(),n=st(e,"skills",t,"SKILL.md");if(!nt(n))return"";try{let s=it(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(s){let r=s[1].match(/^description:\s*(.+)$/m);if(r)return r[1].trim()}}catch{}return""}function es(t){let e=$(),n=st(e,"skills",t,"SKILL.md");if(!nt(n))return[];try{let i=it(n,"utf8"),s=[],r=i.match(/^## .+$/gm)||[];for(let o of r.slice(0,3)){let a=o.replace(/^## /,"").trim();a&&a!=="References"&&a.length<80&&s.push(a)}return s.slice(0,3)}catch{return[]}}function ns(t){return t.length===0?"":`## Skill Hints

`+t.map(n=>"- **"+n.skill+"** \u2014 Use `/ork:"+n.skill+"` to load").join(`
`)}function is(t){if(t.length===0)return"";let e=`## Relevant Skills

`;for(let{skill:n,confidence:i}of t){let s=ts(n),r=es(n);e+="### "+n+" ("+i+`% match)
`,s&&(e+=s+`
`),r.length>0&&(e+=r.map(o=>"- "+o).join(`
`)+`
`),e+="Use `/ork:"+n+`\` to load full content.

`}return e.trim()}function ss(t){if(t.length===0)return"";let e=`## Skill Knowledge Injected

Auto-loaded based on your prompt:

`;for(let{skill:n,content:i}of t)e+="### "+n+`

`+i+`

---

`;return e.trim()}function we(t){let e=t.prompt||"";if(!e||!M(e))return u();let n=A();c("skill-resolver","Analyzing prompt for skill resolution...");let i=At();i||(i=D(e));let s=he(e),r=rs(i.skills,s);if(r.length===0)return c("skill-resolver","No skill matches found"),u();c("skill-resolver","Found "+r.length+" skills: "+r.map(g=>g.skill+":"+g.confidence).join(", "));let o=r.filter(g=>g.confidence>=be),a=r.filter(g=>g.confidence>=Se&&g.confidence<be),l=r.filter(g=>g.confidence>=Zi&&g.confidence<Se),p=[];if(o.length>0&&n.enableSkillInjection){let g=n.maxSkillInjectionTokens||Yi,f=Math.min(o.length,ye),h=Math.floor(g/f),_=[],C=0;for(let I of o.slice(0,ye)){if(vt(I.skill))continue;let w=g-C;if(w<100)break;let v=Qi(I.skill,Math.min(h,w));if(v){let k=N(v);C+=k,_.push({skill:I.skill,content:v}),It(I.skill),c("skill-resolver","Full inject: "+I.skill+" (~"+k+"t)")}}_.length>0&&p.push(ss(_))}if(a.length>0){let g=a.slice(0,ke);p.push(is(g)),c("skill-resolver","Summary: "+g.map(f=>f.skill).join(", "))}if(l.length>0){let g=l.slice(0,ke);p.push(ns(g)),c("skill-resolver","Hints: "+g.map(f=>f.skill).join(", "))}if(p.length===0)return u();let d=p.join(`

`);return c("skill-resolver","Outputting "+p.length+" tiers (~"+N(d)+"t)"),b(d)}function rs(t,e){let n=new Map;for(let i of t){let s=n.get(i.skill)||0;i.confidence>s&&n.set(i.skill,i.confidence)}for(let i of e){let s=n.get(i.skill)||0;i.confidence>s&&n.set(i.skill,i.confidence)}return Array.from(n.entries()).map(([i,s])=>({skill:i,confidence:s})).sort((i,s)=>s.confidence-i.confidence)}var os=[/\b(let'?s use|let'?s go with|going with|will use|should use)\s+([^.,!?\n]+)/gi,/\b(decided on|decided to use|decided to go with|decided to)\s+([^.,!?\n]+)/gi,/\b(chose|choose|selected|opting for|picked)\s+([^.,!?\n]+)/gi,/\b(using)\s+([^.,!?\n]+)\s+for\s+/gi,/\b(chose|prefer|selected|going with)\s+([\w][\w\s-]*?)\s+over\s+([\w][\w\s-]*)/gi,/\b(chose|prefer|selected|going with)\s+([\w][\w\s-]*?)\s+instead of\s+([\w][\w\s-]*)/gi,/\b(implementing|implement)\s+([^.,!?\n]+?)\s+(?:approach|pattern|solution)/gi,/\b(?:the|our)\s+(?:approach|decision|choice)\s+is\s+([^.,!?\n]+)/gi,/\bI\s+(decided|chose)\s+([^.,!?\n]+)/gi],as=[/\bi (prefer|like|always use|never use|want|favor)\s+([^.,!?\n]+)/gi,/\bi'd prefer\s+([^.,!?\n]+)/gi,/\b(my preference is|I'd rather|rather use)\s+([^.,!?\n]+)/gi,/\b(style should be|convention is|naming should)\s+([^.,!?\n]+)/gi,/\b(always|never)\s+(use|do|add|include)\s+([^.,!?\n]+)/gi,/\bdon't\s+(use|like|want)\s+([^.,!?\n]+)/gi],cs=[/\b(issue|problem|error|bug|doesn't work|isn't working|can't|failing|broken)\b[^.!?\n]*[.!?]?/gi,/\bthe (\w[\w\s-]*) (is broken|isn't working|fails|errors|crashes)/gi,/\b(getting|seeing|having)\s+(an error|errors|issues|problems)\s+(with|in|when)\s+([^.,!?\n]+)/gi,/\b(fails|failed|failing)\s+(to|when|with)\s+([^.,!?\n]+)/gi,/\b(not working|doesn't work|won't work)\s*([^.,!?\n]*)/gi,/\b(timeout|exception|crash|hang|freeze)\s+(in|with|when|on)\s+([^.,!?\n]+)/gi],ls=[/\bhow do I\s+([^?.\n]+)/gi,/\bhow can I\s+([^?.\n]+)/gi,/\bhow to\s+([^?.\n]+)/gi,/\bwhat is\s+([^?.\n]+)/gi,/\bwhat are\s+([^?.\n]+)/gi,/\bwhat does\s+([^?.\n]+)/gi,/\bwhy does\s+([^?.\n]+)/gi,/\bwhy is\s+([^?.\n]+)/gi,/\bwhy do\s+([^?.\n]+)/gi,/\bcan you\s+(explain|show|help)\s+([^?.\n]+)/gi,/\bwhere (is|are|do|does|can)\s+([^?.\n]+)/gi,/\bwhen (should|do|does|can)\s+([^?.\n]+)/gi],us=[/\bbecause\s+([^.,!?\n]+)/i,/\bsince\s+([^.,!?\n]+)/i,/\bdue to\s+([^.,!?\n]+)/i,/\bto avoid\s+([^.,!?\n]+)/i,/\bfor\s+(?:better|improved|faster|easier|simpler)\s+([^.,!?\n]+)/i,/\bso that\s+([^.,!?\n]+)/i,/\bin order to\s+([^.,!?\n]+)/i,/\bas it\s+([^.,!?\n]+)/i],ds=["postgresql","postgres","pgvector","redis","mongodb","sqlite","mysql","dynamodb","fastapi","django","flask","express","nextjs","nest","spring","rails","react","vue","angular","svelte","solid","qwik","astro","typescript","python","javascript","rust","go","java","kotlin","jwt","oauth","oauth2","passkeys","saml","oidc","langchain","langgraph","langfuse","openai","anthropic","llama","docker","kubernetes","k8s","terraform","aws","gcp","azure","pytest","jest","vitest","playwright","cypress","msw","webpack","vite","esbuild","turbopack","bun","pnpm","yarn"],ps=["cursor-pagination","offset-pagination","keyset-pagination","repository-pattern","service-layer","clean-architecture","dependency-injection","event-sourcing","cqrs","saga-pattern","circuit-breaker","rate-limiting","retry-pattern","cache-aside","write-through","read-through","rag","semantic-search","vector-search","tdd","bdd","ddd","microservices","monolith","serverless","rest","graphql","grpc","websocket","sse"],gs=["grep","read","write","edit","glob","bash","task","git","gh","npm","yarn","pnpm","claude","cursor","vscode","vim","neovim"];function z(t){let e=t.toLowerCase(),n=new Set;for(let i of ds)e.includes(i)&&n.add(i);for(let i of ps){let s=i.replace(/-/g,"[- ]?");new RegExp(s,"i").test(t)&&n.add(i)}for(let i of gs)e.includes(i)&&n.add(i);return[...n]}function fs(t,e){let n=Math.max(0,e-50),i=Math.min(t.length,e+300),s=t.slice(n,i);for(let r of us){let o=s.match(r);if(o&&o[1])return o[1].trim().slice(0,200)}}function ms(t,e,n,i){let s=.5;return/\b(decided|chose|selected)\b/i.test(t)&&(s+=.2),e&&(s+=.15),n&&(s+=.1),i>=1&&(s+=.05),i>=2&&(s+=.05),t.length<20&&(s-=.1),Math.min(.99,Math.max(.1,s))}function xe(t){let e=[];if(!t||t.length<10)return{intents:[],decisions:[],preferences:[],questions:[],problems:[],summary:"No intents detected (prompt too short)"};for(let l of os){let p=t.matchAll(l);for(let d of p){let g=d[0],f=d.index||0,h="",_;if(d[3]?(h=d[2]?.trim()||"",_=[d[3].trim()]):d[2]&&(h=d[2].trim()),!h||h.length<2)continue;let C=fs(t,f),I=z(g+(C||"")),w=ms(g,!!C,!!_,I.length);e.push({type:"decision",confidence:w,text:g.slice(0,300),entities:I,rationale:C,alternatives:_,position:f})}}for(let l of as){let p=t.matchAll(l);for(let d of p){let g=d[0],f=d.index||0,h=z(g);e.push({type:"preference",confidence:h.length>0?.8:.6,text:g.slice(0,300),entities:h,position:f})}}for(let l of cs){let p=t.matchAll(l);for(let d of p){let g=d[0],f=d.index||0,h=z(g);e.push({type:"problem",confidence:.75,text:g.slice(0,300),entities:h,position:f})}}for(let l of ls){let p=t.matchAll(l);for(let d of p){let g=d[0],f=d.index||0,h=z(g);e.push({type:"question",confidence:.8,text:g.slice(0,300),entities:h,position:f})}}let n=hs(e),i=n.filter(l=>l.type==="decision"&&l.confidence>=.7),s=n.filter(l=>l.type==="preference"),r=n.filter(l=>l.type==="problem"),o=n.filter(l=>l.type==="question"),a=ys(i,s,r,o);return{intents:n,decisions:i,preferences:s,questions:o,problems:r,summary:a}}function hs(t){if(t.length<=1)return t;let e=[...t].sort((i,s)=>i.position-s.position),n=[];for(let i of e)if(!n.some(r=>{let o=r.position+r.text.length,a=i.position+i.text.length;return i.position>=r.position&&i.position<o||r.position>=i.position&&r.position<a}))n.push(i);else{let r=n.findIndex(o=>{let a=o.position+o.text.length,l=i.position+i.text.length;return o.type===i.type&&(i.position>=o.position&&i.position<a||o.position>=i.position&&o.position<l)});r>=0&&i.confidence>n[r].confidence&&(n[r]=i)}return n}function ys(t,e,n,i){let s=[];return t.length>0&&s.push(`${t.length} decision${t.length>1?"s":""}`),e.length>0&&s.push(`${e.length} preference${e.length>1?"s":""}`),n.length>0&&s.push(`${n.length} problem${n.length>1?"s":""}`),i.length>0&&s.push(`${i.length} question${i.length>1?"s":""}`),s.length===0?"No intents detected":`Detected: ${s.join(", ")}`}import{existsSync as ks,appendFileSync as bs,mkdirSync as Ss}from"node:fs";import{join as rt,dirname as ws}from"node:path";var K="capture-user-intent",xs=15,_e=.6;function ot(t){let e=Date.now().toString(36),n=Math.random().toString(36).slice(2,8);return`${t}-${e}-${n}`}function at(){return m().split("/").pop()||"unknown"}function ct(t,e){try{let n=ws(t);ks(n)||Ss(n,{recursive:!0});let i=JSON.stringify(e)+`
`;return bs(t,i),!0}catch(n){return c(K,`Failed to write to ${t}: ${n}`,"warn"),!1}}function _s(t,e){if(t.length===0)return 0;let n=m(),i=rt(n,".claude","memory","pending-decisions.jsonl"),s=at(),r=new Date().toISOString(),o=0;for(let a of t){if(a.confidence<_e)continue;let l={id:ot("dec"),timestamp:r,session_id:e,type:"decision",text:a.text,confidence:a.confidence,entities:a.entities,rationale:a.rationale,alternatives:a.alternatives,project:s,status:"pending"};ct(i,l)&&o++}return o}function Is(t,e){if(t.length===0)return 0;let n=m(),i=rt(n,".claude","memory","user-preferences.jsonl"),s=at(),r=new Date().toISOString(),o=0;for(let a of t){if(a.confidence<_e)continue;let l={id:ot("pref"),timestamp:r,session_id:e,type:"preference",text:a.text,confidence:a.confidence,entities:a.entities,project:s};ct(i,l)&&o++}return o}function vs(t,e){if(t.length===0)return 0;let n=m(),i=rt(n,".claude","memory","open-problems.jsonl"),s=at(),r=new Date().toISOString(),o=0;for(let a of t){let l={id:ot("prob"),timestamp:r,session_id:e,type:"problem",text:a.text,confidence:a.confidence,entities:a.entities,project:s,status:"open"};ct(i,l)&&o++}return o}function Ts(t){try{for(let e of t.decisions)oe(e.text,e.rationale,e.confidence);for(let e of t.preferences)ae(e.text,e.confidence);for(let e of t.problems)ce(e.text)}catch(e){c(K,`Session tracking failed: ${e}`,"warn")}}function Ie(t){let e=t.prompt;if(!e||e.length<xs)return u();let n=t.session_id||y(),i;try{i=xe(e)}catch(l){return c(K,`Intent detection failed: ${l}`,"warn"),u()}if(i.intents.length===0)return u();let s=_s(i.decisions,n),r=Is(i.preferences,n),o=vs(i.problems,n);return Ts(i),s+r+o>0&&c(K,`Captured: ${s} decisions, ${r} preferences, ${o} problems`,"info"),u()}var ve={"prompt/antipattern-detector":zt,"prompt/antipattern-warning":Xt,"prompt/context-injector":Vt,"prompt/context-pruning-advisor":Qt,"prompt/memory-context":te,"prompt/satisfaction-detector":de,"prompt/todo-enforcer":pe,"prompt/agent-auto-suggest":ge,"prompt/agent-orchestrator":fe,"prompt/pipeline-detector":me,"prompt/skill-resolver":we,"prompt/capture-user-intent":Ie};function Aa(t){return ve[t]}function $a(){return Object.keys(ve)}export{Vs as DEFAULT_CONFIG,Ut as PIPELINES,S as THRESHOLDS,Tt as addToPromptHistory,Or as analyzeAttemptHistory,Gr as applyDecay,Ct as cacheClassification,ln as calculateBackoffDelay,D as classifyIntent,pr as cleanupOldStates,$r as cleanupOldTasks,nr as clearCache,dr as clearSessionState,jr as completeAttempt,Ar as completePipelineStep,Mr as createAttempt,Bt as createPipelineExecution,Ft as detectPipeline,Js as escapeRegex,N as estimateTokenCount,qt as formatPipelinePlan,Hr as formatRetryDecision,kr as formatTaskCreateForClaude,Sr as formatTaskDeleteForClaude,wr as formatTaskUpdateForClaude,hr as generateTaskCreateInstruction,br as generateTaskDeleteInstruction,yr as generateTaskUpdateInstruction,cr as getActiveAgent,Mt as getActivePipeline,Lt as getAdjustments,qr as getAgentSuccessRate,Y as getAlternativeAgent,Os as getCachedBranch,zr as getCalibrationStats,Ks as getField,Aa as getHook,lr as getInjectedSkills,At as getLastClassification,pt as getLogDir,Ee as getLogLevel,Tr as getOrphanedTasks,Vr as getPipelineByType,en as getPipelineTasks,$ as getPluginRoot,m as getProjectDir,G as getPromptHistory,y as getSessionId,_r as getTaskByAgent,Ir as getTaskById,vr as getTasksBlockedBy,Kr as hasMinimalCalibrationData,bn as hashPrompt,ve as hooks,_t as isAgentDispatched,As as isBashInput,Rs as isEditInput,Es as isReadInput,un as isRetryableError,vt as isSkillInjected,$s as isWriteInput,$a as listHooks,P as loadCalibrationData,A as loadConfig,R as loadState,c as logHook,Gs as logPermissionFeedback,Dr as makeRetryDecision,Ws as normalizeCommand,Ls as outputAllowWithContext,Hs as outputBlock,Bs as outputDeny,Us as outputError,b as outputPromptContext,qs as outputPromptContextBudgeted,Ps as outputSilentAllow,u as outputSilentSuccess,Fs as outputWarning,Ns as outputWithContext,Pr as prepareForRetry,zs as readHookInput,Br as recordOutcome,Dt as registerPipeline,Gt as registerPipelineExecution,Et as registerTask,ar as removeAgent,kn as saveCalibrationData,ur as saveConfig,Xe as saveState,M as shouldClassify,De as shouldLog,dn as suggestsAlternative,xt as trackDispatchedAgent,It as trackInjectedSkill,or as updateAgentStatus,Cr as updatePipeline,j as updateState,xr as updateTaskStatus};
//# sourceMappingURL=prompt.mjs.map
