// OrchestKit Hooks - subagent bundle
// Generated: 2026-02-28T13:40:06.892Z

var _t=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,n)=>(typeof require<"u"?require:e)[n]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});function wo(t){return typeof t.command=="string"}function To(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function Ao(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function Co(t){return typeof t.file_path=="string"&&t.content===void 0}import{existsSync as z,statSync as Yn,renameSync as Zn,mkdirSync as me,readSync as tr,readFileSync as er,writeFileSync as nr}from"node:fs";import{join as rr}from"node:path";import{appendFileSync as Dn,mkdirSync as Rn}from"node:fs";import{dirname as En}from"node:path";var W=[],xt=!1,ie=!1;function h(t,e){W.push({filePath:t,content:e}),On()}function vt(){if(xt||W.length===0)return;xt=!0;let t=new Map;for(let e of W){let n=t.get(e.filePath);n?n.push(e.content):t.set(e.filePath,[e.content])}for(let[e,n]of t)try{Rn(En(e),{recursive:!0}),Dn(e,n.join(""))}catch{}W.length=0,xt=!1}function On(){ie||(ie=!0,process.on("exit",vt),process.on("SIGTERM",()=>{vt(),process.exit(0)}),process.on("SIGINT",()=>{vt(),process.exit(0)}))}import{execSync as sr}from"node:child_process";import oe from"node:os";import F from"node:path";function $t(){return process.env.HOME||process.env.USERPROFILE||oe.homedir()}function Pn(){return oe.tmpdir()}function It(){return process.env.CLAUDE_PROJECT_DIR||"."}function ae(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function ce(){return process.env.CLAUDE_PLUGIN_ROOT?F.join($t(),".claude","logs","ork"):F.join(It(),".claude","logs")}function ue(){return process.env.CLAUDE_METRICS_FILE||F.join(Pn(),"claude-session-metrics.json")}var wt=F.join,jo=F.sep;import{execSync as Hn}from"node:child_process";import{createHash as jn}from"node:crypto";import{existsSync as le,readFileSync as Nn,writeFileSync as Mn,mkdirSync as Fn}from"node:fs";import{join as Tt,basename as Ln}from"node:path";var Un=20,Bn=15,qn=/[^a-z0-9-]/g;function Gn(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=Ln(e);return ge(n,Un)}function Jn(t){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=Hn("git branch --show-current",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),r=ge(n||"detached",Bn);return process.env.ORCHESTKIT_SESSION_BRANCH=r,r}catch{return"nobranch"}}function Wn(t){let e=t||new Date,n=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${n}${r}`}function zn(t){let e=t||new Date,n=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0");return`${n}${r}`}function Vn(){let t=`${process.pid}-${Date.now()}-${Math.random()}`;return jn("sha256").update(t).digest("hex").slice(0,4)}function ge(t,e){return t.toLowerCase().replace(qn,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,e)}function Kn(t,e){let n=Gn(t),r=Jn(t),s=Wn(e),i=zn(e),o=Vn();return`${n}-${r}-${s}-${i}-${o}`}function Xn(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=Tt(e,".instance","session-id.json");if(le(n))try{let r=JSON.parse(Nn(n,"utf8"));if(r.session_id&&r.created_at){let s=Date.now()-new Date(r.created_at).getTime(),i=1440*60*1e3;if(s<i)return r.session_id}}catch{}}function Qn(t,e){let n=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),r=Tt(n,".instance"),s=Tt(r,"session-id.json");try{le(r)||Fn(r,{recursive:!0}),Mn(s,JSON.stringify({session_id:t,created_at:new Date().toISOString()},null,2))}catch{}}function de(t){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let e=Xn(t);if(e)return e;let n=Kn(t);return Qn(n,t),n}function fe(){return ce()}function g(){return It()}function V(){return ae()}function Ko(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${V()}/.claude/.instance_env`}function S(){return de()}function ye(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let e=sr("git branch --show-current",{cwd:t||g(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function ir(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Xo(t){return t.replace(/\r\n/g,`
`)}function or(t){let e=["debug","info","warn","error"];return e.indexOf(t)>=e.indexOf(ir())}function d(){return{continue:!0,suppressOutput:!0}}function Qo(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function Yo(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function A(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function ar(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function Zo(t,e){let n={continue:!0,suppressOutput:!0};return t&&(n.systemMessage=t),e&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:e}),n}function ta(t,e){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?n.systemMessage=e:n.suppressOutput=!0,n}function ea(t){return{continue:!0,systemMessage:t}}function C(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function na(t){process.stderr.write(`\u26A0 ${t}
`),process.exit(2)}function At(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}function ra(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:t}}}var cr=200*1024,ur=100*1024;function he(t,e){if(z(t))try{if(Yn(t).size>e){let r=`${t}.old.${Date.now()}`;Zn(t,r)}}catch{}}function ke(t){z(t)||me(t,{recursive:!0})}function c(t,e,n="debug"){if(!or(n))return;let r=fe(),s=`${r}/hooks.log`;try{ke(r),he(s,cr);let i=new Date().toISOString().replace("T"," ").slice(0,19);h(s,`[${i}] [${n.toUpperCase()}] [${t}] ${e}
`)}catch{}}function sa(t,e,n){let r=fe(),s=`${r}/permission-feedback.log`;try{ke(r),he(s,ur);let i=new Date().toISOString(),o=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",a=n?.session_id||S();h(s,`${i} | ${t} | ${e} | tool=${o} | session=${a}
`)}catch{}}function K(t){return t.hookSpecificOutput?.additionalContext?t.hookSpecificOutput.additionalContext:t.systemMessage&&typeof t.systemMessage=="string"?t.systemMessage:null}function X(t){if(!t)return 0;let r=(t.match(/[{};()=><]/g)||[]).length/t.length>.03?2.8:3.5;return Math.ceil(t.length/r)}function ia(t,e,n,r,s){let i=X(t);return r?.isOverBudget(n)?(c(e,`Budget exhausted for ${n}, suppressing ${i}t`),d()):(s&&s.trackTokenUsage(e,n,i),ar(t))}function pe(t){let e=2166136261;for(let n=0;n<t.length;n++)e^=t.charCodeAt(n),e=Math.imul(e,16777619);return(e>>>0).toString(16).padStart(8,"0")}function oa(t,e,n,r){let s=rr(t,e);if(z(s))try{let i=er(s,"utf8");if(pe(i)===pe(n))return c(r,`Rules file ${e} unchanged, skipping write`),!1}catch{}return z(t)||me(t,{recursive:!0}),nr(s,n,"utf8"),c(r,`Wrote rules file: ${s}`),!0}function aa(){try{let t=[],n=Buffer.allocUnsafe(256),r,s=0;for(;;)try{if(r=tr(s,n,0,256,null),r===0)break;t.push(Buffer.from(n.subarray(0,r)))}catch{break}let i=Buffer.concat(t).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:S(),tool_input:{}}}catch{return{tool_name:"",session_id:S(),tool_input:{}}}}function ca(t,e){let n=e.replace(/^\./,"").split("."),r=t;for(let s of n){if(r==null)return;r=r[s]}return r}function Ct(t,...e){return t.split(`
`).some(n=>e.every(r=>n.includes(r)))}function ua(t,...e){return t.split(`
`).some(n=>{let r=n.toLowerCase();return e.every(s=>r.includes(s.toLowerCase()))})}function la(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function ga(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var pa={AUTO_DISPATCH:85,SKILL_INJECT:80,STRONG_RECOMMEND:70,SUGGEST:50,MINIMUM:40},ma={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:1200,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};import{existsSync as L,readFileSync as be,writeFileSync as _e,mkdirSync as lr}from"node:fs";function Dt(){return`${g()}/.claude/orchestration`}function Rt(){let t=S();return`${Dt()}/session-${t}.json`}function xe(){return`${g()}/.claude/orchestration/config.json`}function ve(){let t=Dt();if(!L(t))try{lr(t,{recursive:!0})}catch{c("orchestration-state",`Failed to create state dir: ${t}`)}}function $(){let t=Rt();if(L(t))try{let e=be(t,"utf8");return JSON.parse(e)}catch(e){c("orchestration-state",`Failed to load state: ${e}`)}return{sessionId:S(),activeAgents:[],injectedSkills:[],promptHistory:[],maxHistorySize:10,updatedAt:new Date().toISOString()}}function gr(t){ve();let e=Rt();t.updatedAt=new Date().toISOString();try{_e(e,JSON.stringify(t,null,2))}catch(n){c("orchestration-state",`Failed to save state: ${n}`)}}function H(t){let e=$();return t(e),gr(e),e}function ka(t,e,n){let r={agent:t,taskId:n,confidence:e,dispatchedAt:new Date().toISOString(),status:"pending",retryCount:0,maxRetries:3};return H(s=>{s.activeAgents=s.activeAgents.filter(i=>i.agent!==t),s.activeAgents.push(r)}),c("orchestration-state",`Tracked dispatched agent: ${t} (conf: ${e})`),r}function E(t,e,n){H(r=>{let s=r.activeAgents.find(i=>i.agent===t);s&&(s.status=e,n&&(s.taskId=n),e==="retrying"&&s.retryCount++)}),c("orchestration-state",`Updated agent status: ${t} -> ${e}`)}function Et(t){H(e=>{e.activeAgents=e.activeAgents.filter(n=>n.agent!==t)})}function Sa(){return $().activeAgents.find(e=>e.status==="in_progress")}function ba(t){return $().activeAgents.some(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function _a(t){H(e=>{e.injectedSkills.includes(t)||e.injectedSkills.push(t)})}function xa(t){return $().injectedSkills.includes(t)}function va(){return $().injectedSkills}function $a(t){H(e=>{e.promptHistory.push(t),e.promptHistory.length>e.maxHistorySize&&(e.promptHistory=e.promptHistory.slice(-e.maxHistorySize))})}function Ia(){return $().promptHistory}function wa(t){H(e=>{e.lastClassification=t})}function Ta(){return $().lastClassification}var Se={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:1200,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function Ot(){let t=xe();if(L(t))try{let e=be(t,"utf8");return{...Se,...JSON.parse(e)}}catch{}return Se}function Aa(t){ve();let e=xe(),r={...Ot(),...t};try{_e(e,JSON.stringify(r,null,2))}catch(s){c("orchestration-state",`Failed to save config: ${s}`)}}function Ca(){let t=Rt();try{if(L(t)){let{unlinkSync:e}=_t("node:fs");e(t),c("orchestration-state","Cleared session state")}}catch{}}function Da(){let t=Dt();if(L(t))try{let{readdirSync:e,statSync:n,unlinkSync:r}=_t("node:fs"),s=e(t).filter(i=>i.startsWith("session-")&&i.endsWith(".json")).map(i=>({name:i,path:`${t}/${i}`,mtime:n(`${t}/${i}`).mtime.getTime()})).sort((i,o)=>o.mtime-i.mtime);for(let i of s.slice(5))try{r(i.path),c("orchestration-state",`Cleaned up old state: ${i.name}`)}catch{}}catch{}}var dr=3,pr=1e3,mr=3e4,fr={"backend-system-architect":["database-engineer","api-designer"],"frontend-ui-developer":["rapid-ui-designer","accessibility-specialist"],"test-generator":["debug-investigator","code-quality-reviewer"],"security-auditor":["security-layer-auditor"],"workflow-architect":["llm-integrator","data-pipeline-engineer"]},yr=[{test:t=>/permission denied/i.test(t)},{test:t=>/access denied/i.test(t)},{test:t=>/not found/i.test(t)&&/file|module|package/i.test(t)},{test:t=>/(?:file|module|package)\s+not\s+found/i.test(t)},{test:t=>/missing required/i.test(t)},{test:t=>/invalid (?:api|token|key)/i.test(t)},{test:t=>/authentication failed/i.test(t)},{test:t=>/quota exceeded/i.test(t)},{test:t=>/rate limit/i.test(t)}],hr=[/not my specialization/i,/outside my scope/i,/better suited for/i,/consider using/i,/specialized agent/i];function kr(t,e=pr){let n=e*2**(t-1),r=Math.random()*.1*n;return Math.min(n+r,mr)}function Sr(t){for(let e of yr)if(e.test(t))return!1;return!0}function br(t){for(let e of hr)if(e.test(t))return!0;return!1}function Pt(t,e=[]){let n=fr[t];if(n){for(let r of n)if(!e.includes(r))return r}}function $e(t,e,n,r=[],s=dr){if(c("retry-manager",`Evaluating retry for ${t}, attempt ${e}`),e>=s){let o=Pt(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Max retries (${s}) exceeded`+(o?`. Consider trying ${o} instead.`:"")}}if(!Sr(n)){let o=Pt(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Non-retryable error detected: ${n.slice(0,100)}`}}if(br(n)){let o=Pt(t,r);if(o)return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Error suggests using alternative agent: ${o}`}}let i=kr(e);return{shouldRetry:!0,retryCount:e,maxRetries:s,delayMs:i,reason:`Retrying (attempt ${e+1}/${s}) after ${Math.round(i/1e3)}s`}}function Ie(t,e,n){return{agent:t,taskId:n,attemptNumber:e,startedAt:new Date().toISOString()}}function we(t,e,n){let r=new Date().toISOString(),s=new Date(r).getTime()-new Date(t.startedAt).getTime();return{...t,completedAt:r,outcome:e,error:n,durationMs:s}}function Oa(t){if(t.length===0)return{successRate:0,avgDuration:0,commonErrors:[]};let n=t.filter(a=>a.outcome==="success").length/t.length,r=t.filter(a=>a.durationMs!==void 0).map(a=>a.durationMs),s=r.length>0?r.reduce((a,u)=>a+u,0)/r.length:0,i=new Map;for(let a of t)if(a.error){let u=a.error.slice(0,50).toLowerCase();i.set(u,(i.get(u)||0)+1)}let o=Array.from(i.entries()).sort((a,u)=>u[1]-a[1]).slice(0,3).map(([a])=>a);return{successRate:n,avgDuration:s,commonErrors:o}}function Pa(t,e){return{...t,status:"retrying",retryCount:e.retryCount}}function Te(t,e){if(t.shouldRetry)return`## Retry Scheduled

Agent \`${e}\` will retry after ${Math.round((t.delayMs||0)/1e3)} seconds.

**Attempt:** ${t.retryCount+1} of ${t.maxRetries}
**Reason:** ${t.reason}`;let n=`## Retry Not Recommended

Agent \`${e}\` has ${t.retryCount>=t.maxRetries?"exhausted retries":"encountered a non-retryable error"}.

**Reason:** ${t.reason}`;return t.alternativeAgent&&(n+=`

### Alternative Suggestion

Consider using \`${t.alternativeAgent}\` instead:

\`\`\`
Task tool with subagent_type: "${t.alternativeAgent}"
\`\`\``),n}import{existsSync as Re,readFileSync as _r,writeFileSync as xr,mkdirSync as vr}from"node:fs";import{createHash as $r}from"node:crypto";var Ae=500,Ht=3,Ce=15,De=3,Ir=.9;function Ee(){return`${g()}/.claude/feedback/calibration-data.json`}function wr(){let t=`${g()}/.claude/feedback`;if(!Re(t))try{vr(t,{recursive:!0})}catch{}}function U(){let t=Ee();if(Re(t))try{return JSON.parse(_r(t,"utf8"))}catch{c("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function Tr(t){wr();let e=Ee();t.updatedAt=new Date().toISOString();try{xr(e,JSON.stringify(t,null,2)),c("calibration-engine","Saved calibration data")}catch(n){c("calibration-engine",`Failed to save calibration data: ${n}`)}}function Ar(t){return $r("sha256").update(t.toLowerCase().trim()).digest("hex").slice(0,16)}function Fa(t,e,n,r,s,i,o){let a=U(),u={timestamp:new Date().toISOString(),sessionId:S(),agent:e,promptHash:Ar(t),matchedKeywords:n,dispatchConfidence:r,outcome:s,durationMs:i,feedback:o};a.records.push(u),a.records.length>Ae&&(a.records=a.records.slice(-Ae)),Cr(a,u),Dr(a),Tr(a),c("calibration-engine",`Recorded outcome: ${e} -> ${s} (conf: ${r})`)}function Cr(t,e){let n=e.outcome==="success",r=e.outcome==="failure"||e.outcome==="rejected";if(!n&&!r)return;let s=n?De:-De;for(let i of e.matchedKeywords){let o=t.adjustments.find(a=>a.keyword===i&&a.agent===e.agent);o?(o.adjustment=Math.max(-Ce,Math.min(Ce,o.adjustment+s)),o.sampleCount++,o.lastUpdated=new Date().toISOString()):t.adjustments.push({keyword:i,agent:e.agent,adjustment:s,sampleCount:1,lastUpdated:new Date().toISOString()})}}function La(t){let e=Date.now(),n=1440*60*1e3;for(let r of t.adjustments){let s=e-new Date(r.lastUpdated).getTime();Math.floor(s/n)>7&&(r.adjustment=Math.round(r.adjustment*Ir),Math.abs(r.adjustment)<1&&(r.adjustment=0))}t.adjustments=t.adjustments.filter(r=>r.adjustment!==0)}function Dr(t){let e=t.records;if(e.length===0)return;t.stats.totalDispatches=e.length;let n=e.filter(i=>i.outcome==="success").length;t.stats.successRate=n/e.length;let r=e.reduce((i,o)=>i+o.dispatchConfidence,0)/e.length;t.stats.avgConfidence=Math.round(r);let s=new Map;for(let i of e){let o=s.get(i.agent)||{count:0,success:0};o.count++,i.outcome==="success"&&o.success++,s.set(i.agent,o)}t.stats.topAgents=Array.from(s.entries()).map(([i,o])=>({agent:i,count:o.count,successRate:o.success/o.count})).sort((i,o)=>o.count-i.count).slice(0,10)}function Ua(){return U().adjustments.filter(e=>e.sampleCount>=Ht)}function Ba(t){let n=U().records.filter(s=>s.agent===t);return n.length<Ht?null:n.filter(s=>s.outcome==="success").length/n.length}function qa(){return U().stats}function Ga(){return U().records.length>=Ht}import{existsSync as Rr,statSync as Er}from"node:fs";import{resolve as Or}from"node:path";var Pr={"database-engineer":"database schema SQL PostgreSQL migration pgvector","backend-system-architect":"API REST architecture backend FastAPI microservice","frontend-ui-developer":"React frontend UI component TypeScript Tailwind","security-auditor":"security OWASP vulnerability audit authentication","test-generator":"testing unit integration coverage pytest MSW","workflow-architect":"LangGraph workflow agent orchestration state","llm-integrator":"LLM API OpenAI Anthropic embeddings RAG function-calling","data-pipeline-engineer":"data pipeline embeddings vector ETL chunking","metrics-architect":"metrics OKR KPI analytics instrumentation","ux-researcher":"UX user research persona journey accessibility","code-quality-reviewer":"code quality review linting type-check patterns","infrastructure-architect":"infrastructure cloud Docker Kubernetes deployment","ci-cd-engineer":"CI CD pipeline GitHub Actions deployment automation","accessibility-specialist":"accessibility WCAG ARIA screen-reader a11y","product-strategist":"product strategy roadmap features prioritization"};function Hr(t){return Pr[t]||t}var Oe=100;function Q(t){c("graph-memory-inject","Graph memory inject hook starting");let e=Or(g(),".claude/memory/knowledge-graph.jsonl");if(!Rr(e))return c("graph-memory-inject","No graph data file, skipping"),d();try{let u=Er(e).size;if(u<Oe)return c("graph-memory-inject",`Graph too small (${u}B < ${Oe}B), skipping`),d()}catch{return c("graph-memory-inject","Could not stat graph file, skipping"),d()}let r=(t.tool_input||{}).subagent_type||"";if(!r)return c("graph-memory-inject","No agent type detected, passing through"),d();let s=`ork:${r}`,i=Hr(r);c("graph-memory-inject",`Detected agent type: ${r} (agent_id: ${s})`);let o=`[Graph Memory - Agent Context Load]

Execute this MCP call to load graph context for ${r} agent:

## Graph Memory Entities
\`\`\`
mcp__memory__search_nodes
{"query": "${r} ${i}"}
\`\`\`

## Integration Instructions
1. Execute the graph search to retrieve relevant entities and relationships
2. Review entities for patterns, decisions, and constraints
3. Check relationships between concepts
4. Apply learned patterns to current task

Agent ID: ${s} | Domain: ${i}`,a=`[Graph Memory] Agent: ${r} | ID: ${s} | Load graph context via MCP call above`;return c("graph-memory-inject",`Outputting graph memory instructions for ${r}`),{continue:!0,systemMessage:a,hookSpecificOutput:{additionalContext:o}}}import{existsSync as B,readFileSync as Y,writeFileSync as jt,mkdirSync as jr}from"node:fs";import{dirname as Nr}from"node:path";var Mr=6,Fr=8,Lr=5,Ur=/^(test-generator|backend-system-architect|workflow-architect|security-auditor|llm-integrator)$/;function Br(){let t=process.cwd();return t.includes(".claude/worktrees/")||t.includes("/.git/worktrees/")}function qr(){return Br()?{maxBackground:10,maxPerResponse:12}:{maxBackground:Mr,maxPerResponse:Fr}}function Nt(){return`${g()}/.claude/logs/agent-state.json`}function He(){return`${g()}/.claude/logs/subagent-spawns.jsonl`}function Gr(){let t=Nt(),e=Nr(t);try{jr(e,{recursive:!0})}catch{}if(!B(t)){let n={active_background:[],session_total:0,last_cleanup:null,blocked_count:0};try{jt(t,JSON.stringify(n,null,2))}catch{}}}function Jr(){let t=He();if(!B(t))return 0;try{let r=Y(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),s=new Date(Date.now()-300*1e3).toISOString(),i=0;for(let o of r)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>s&&i++}catch{}return i}catch{return 0}}function Wr(){let t=He();if(!B(t))return 0;try{let r=Y(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),s=new Date(Date.now()-2*1e3).toISOString(),i=0;for(let o of r)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>s&&i++}catch{}return i}catch{return 0}}function zr(){let t=Nt();try{if(B(t)){let e=JSON.parse(Y(t,"utf8"));e.blocked_count=(e.blocked_count||0)+1,jt(t,JSON.stringify(e,null,2))}}catch{}}function Pe(){let t=Nt();try{if(B(t)){let e=JSON.parse(Y(t,"utf8"));e.session_total=(e.session_total||0)+1,jt(t,JSON.stringify(e,null,2))}}catch{}}function Z(t){Gr();let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"",s=e.run_in_background===!0||e.run_in_background==="true";c("context-gate",`Context gate check: ${n} (background=${s})`);let i=Jr(),o=Wr();c("context-gate",`Active background: ${i}, Current response: ${o}`);let a=qr();return o>=a.maxPerResponse?(c("context-gate",`BLOCKED: Too many agents in single response (${o} >= ${a.maxPerResponse})`),At(`Context Overflow Protection

Too many agents spawned in a single response (${o} agents).

Maximum allowed: ${a.maxPerResponse} per response

SOLUTION: Split into multiple responses or use sequential execution.
Consider using the /context-optimization skill first.

Attempted: ${n} - ${r}`)):s&&i>=a.maxBackground?(c("context-gate",`BLOCKED: Too many concurrent background agents (${i} >= ${a.maxBackground})`),zr(),At(`Background Agent Limit

Too many background agents running concurrently (${i} active).

Maximum allowed: ${a.maxBackground} concurrent background agents

SOLUTION:
1. Wait for existing agents to complete
2. Run this agent in foreground (remove run_in_background)
3. Use /context-optimization to free up context

Attempted: ${n} - ${r}`)):i>=Lr?(c("context-gate","WARNING: Approaching context budget limit"),Pe(),C(`Context Budget Warning

${i} background agents active (limit: ${a.maxBackground}).

Consider:
- Running remaining agents sequentially
- Using /context-optimization skill
- Waiting for current agents to complete

Proceeding with: ${n} - ${r}`)):Ur.test(n)&&i>=2?(c("context-gate",`WARNING: Expensive agent type with multiple active: ${n}`),C(`Spawning expensive agent (${n}) with ${i} others active`)):(Pe(),c("context-gate",`Context gate passed: ${n}`),d())}import{existsSync as tt,readFileSync as Mt,readdirSync as Vr}from"node:fs";import{homedir as Kr}from"node:os";import{join as je}from"node:path";function Xr(){return`${g()}/.claude/context/session/state.json`}function Qr(){return`${g()}/.claude/context/knowledge/decisions/active.json`}function Yr(){return`${g()}/docs/issues`}function Zr(){let t=Xr();if(!tt(t))return{count:0,summary:""};try{let n=JSON.parse(Mt(t,"utf8")).tasks_pending||[],r=n.length;if(r===0)return{count:0,summary:""};let s=n.slice(0,5).map(i=>`- ${i}`).join(`
`);return{count:r,summary:s}}catch{return{count:0,summary:""}}}function Ne(t,e){let n=Qr();if(!tt(n))return"";try{return(JSON.parse(Mt(n,"utf8")).decisions||[]).filter(o=>o.category===e||o.category==="api"||o.category==="database").slice(0,8).map(o=>`- ${o.title} (${o.status||"unknown"})`).join(`
`)}catch{return""}}function ts(t){let e=Yr();if(!tt(e))return"";try{let r=Vr(e).find(s=>s.includes(t));if(r)return`docs/issues/${r}`}catch{}return""}function es(){let t=[],e=je(Kr(),".claude","CLAUDE.md"),n=Me(e);if(n){let o=Fe(n,"global");t.push(...o)}let r=je(g(),"CLAUDE.md"),s=Me(r);if(s){let o=Fe(s,"project");t.push(...o)}return t.length===0?"":`CRITICAL RULES (inherited from CLAUDE.md):
${[...new Set(t)].slice(0,12).map(o=>`- ${o}`).join(`
`)}

`}function Me(t){try{return tt(t)?Mt(t,"utf8"):""}catch{return""}}function Fe(t,e){let n=[],r=t.split(`
`);for(let s of r){let i=s.trim();if(!(!i||i.startsWith("#")||i.startsWith("```"))){if(/^[-*]\s+/.test(i)){let o=i.replace(/^[-*]\s+/,"").trim();if(/\b(always|never|must|don't|do not|required|NEVER|MUST|DON'T)\b/i.test(o)){let a=o.length>80?`${o.substring(0,77)}...`:o;n.push(a)}}if(/^\*\*(DO|DON'T|DO NOT)\*\*:/.test(i)){let o=i.replace(/\*\*/g,"").trim();o.length<=80&&n.push(o)}}}return n}function et(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.task_description||e.description||"";c("subagent-context-stager",`Staging context for ${n}`);let s="",i=es();i&&(s+=i,c("subagent-context-stager","Injected critical rules from CLAUDE.md"));let{count:o,summary:a}=Zr();o>0&&(c("subagent-context-stager",`Found ${o} pending tasks`),s+=`ACTIVE TODOS:
${a}

`);let u=r.toLowerCase();if(/backend|api|endpoint|database|migration/.test(u)){c("subagent-context-stager","Backend task detected - staging backend decisions");let l=Ne(r,"backend");l&&(s+=`RELEVANT DECISIONS:
${l}

`)}if(/frontend|react|ui|component/.test(u)){c("subagent-context-stager","Frontend task detected - staging frontend decisions");let l=Ne(r,"frontend");l&&(s+=`RELEVANT DECISIONS:
${l}

`)}if(/test|testing|pytest|jest/.test(u)&&(c("subagent-context-stager","Testing task detected - staging test context"),s+=`TESTING REMINDERS:
- Use 'tee' for visible test output
- Check test patterns in backend/tests/ or frontend/src/**/__tests__/
- Ensure coverage meets threshold requirements

`),/issue|#\d+|bug|fix/.test(u)){c("subagent-context-stager","Issue-related task detected");let l=r.match(/#(\d+)/);if(l){let p=l[1],m=ts(p);m&&(s+=`ISSUE DOCS: ${m}

`,c("subagent-context-stager",`Staged issue documentation for #${p}`))}}if(s){let l=`${s}
Task: ${r}
Subagent: ${n}`,p=s.split(`
`).filter(Boolean).length;return c("subagent-context-stager",`Staged context with ${p} lines`),{continue:!0,systemMessage:l}}return c("subagent-context-stager","No context staged for this task"),d()}import{existsSync as q,readFileSync as Ft,mkdirSync as ns,readdirSync as rs}from"node:fs";import{join as v,dirname as ss}from"node:path";var is=new Set(["general-purpose","Explore","Plan","claude-code-guide","statusline-setup","Bash"]);function os(){return v(g(),".claude","logs","subagent-spawns.jsonl")}function as(){return v(g(),"plugin.json")}function Lt(){return v(g(),"agents")}function Ut(){return v(g(),".claude","agents")}function cs(){return v(g(),"skills")}function us(){let t=new Set(is),e=as();if(q(e))try{let s=JSON.parse(Ft(e,"utf8")).agents||[];for(let i of s)i.id&&t.add(i.id)}catch{}let n=[Lt(),Ut()];for(let r of n)if(q(r))try{let s=rs(r);for(let i of s)i.endsWith(".md")&&t.add(i.replace(".md",""))}catch{}return t}function ls(t){let e=[],n=[v(Lt(),`${t}.md`),v(Ut(),`${t}.md`)],r=null;for(let s of n)if(q(s)){r=s;break}if(!r)return e;try{let i=Ft(r,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of i){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^skills:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let l=u.match(/^\s*-\s*(.+)$/);if(l){let p=l[1].trim();e.push(p)}}}}}catch{}return e}function gs(t){let e=ls(t),n=[],r=cs();for(let s of e){let i=v(r,s,"SKILL.md");q(i)||n.push(s)}return n}function ds(t){let e=[],n=[v(Lt(),`${t}.md`),v(Ut(),`${t}.md`)],r=null;for(let s of n)if(q(s)){r=s;break}if(!r)return e;try{let i=Ft(r,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of i){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^tools:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let l=u.match(/^\s*-\s*(.+)$/);l&&e.push(l[1].trim())}}}}catch{}return e}function ps(t,e){if(e.length===0)return"";let n=e.every(o=>["Read","Glob","Grep"].includes(o)),r=e.includes("Bash"),s=e.includes("Write")||e.includes("Edit"),i="low";return r&&s?i="elevated":(r||s)&&(i="moderate"),`## Agent Permission Profile (CC 2.1.20)

**Agent**: \`${t}\`
**Tools**: ${e.join(", ")}
**Risk Level**: ${i}${n?" (read-only)":""}

${r?`> This agent requests Bash access. Review commands carefully.
`:""}`}function ms(t,e,n){let r=os(),s=ss(r);try{ns(s,{recursive:!0})}catch{}let i={timestamp:new Date().toISOString(),subagent_type:t,description:e,session_id:n};try{h(r,`${JSON.stringify(i)}
`)}catch{}}function nt(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"",s=t.session_id;c("subagent-validator",`Task invocation: ${n} - ${r}`),ms(n,r,s);let i=n.replace(/^[^:]+:/,""),o=us();!o.has(n)&&!o.has(i)&&c("subagent-validator",`WARNING: Unknown subagent type: ${n}`),c("subagent-validator",`Spawning ${n} agent: ${r}`);let a=gs(i);if(a.length>0){let l=a.join(", ");c("subagent-validator",`WARNING: Agent '${i}' references missing skills: ${l}`),console.error(`Warning: Agent '${i}' references ${a.length} missing skill(s): ${l}`)}let u=ds(i);if(u.length>0){let l=ps(i,u);return c("subagent-validator",`Agent '${i}' tools: ${u.join(", ")}`),A(l)}return d()}import{existsSync as Le,readFileSync as fs,writeFileSync as ys,mkdirSync as hs}from"node:fs";function Ue(){let t=S();return`${g()}/.claude/orchestration/task-registry-${t}.json`}function ks(){let t=`${g()}/.claude/orchestration`;if(!Le(t))try{hs(t,{recursive:!0})}catch{}}function j(){let t=Ue();if(Le(t))try{return JSON.parse(fs(t,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:S(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function Bt(t){ks();let e=Ue();t.updatedAt=new Date().toISOString();try{ys(e,JSON.stringify(t,null,2))}catch(n){c("task-integration",`Failed to save registry: ${n}`)}}function Be(t,e){return`### Delete Orphaned Task

\`\`\`
TaskUpdate:
  taskId: "${t}"
  status: "deleted"
\`\`\`

**Reason**: ${e}`}function rt(t){let e=`### Update Task

\`\`\`
TaskUpdate:
  taskId: "${t.taskId}"`;return t.status&&(e+=`
  status: "${t.status}"`),t.addBlockedBy&&t.addBlockedBy.length>0&&(e+=`
  addBlockedBy: ${JSON.stringify(t.addBlockedBy)}`),t.addBlocks&&t.addBlocks.length>0&&(e+=`
  addBlocks: ${JSON.stringify(t.addBlocks)}`),e+="\n```",e}function I(t,e){let n=j(),r=n.tasks.find(s=>s.taskId===t);r&&(r.status=e,Bt(n),c("task-integration",`Updated task ${t} status to ${e}`))}function D(t){return j().tasks.find(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function qe(t){return j().tasks.filter(n=>n.status==="pending"&&n.blockedBy&&n.blockedBy.includes(t))}function qt(t){return j().tasks.filter(n=>n.pipelineId===t).sort((n,r)=>(n.pipelineStep||0)-(r.pipelineStep||0))}function Ge(){return j().pipelines.find(e=>e.status==="running")}function Je(t,e){let n=j(),r=n.pipelines.find(i=>i.pipelineId===t);if(!r)return null;r.completedSteps.includes(e)||(r.completedSteps.push(e),r.completedSteps.sort((i,o)=>i-o));let s=qt(t);for(let i of s){let o=i.pipelineStep;if(o===void 0||r.completedSteps.includes(o)||i.status!=="pending")continue;if(o===0||r.completedSteps.includes(o-1))return r.currentStep=o,Bt(n),o}return r.status="completed",Bt(n),null}function st(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return c("task-linker","No agent type found, skipping"),d();c("task-linker",`Processing SubagentStart for: ${n}`);let r=D(n);if(!r)return c("task-linker",`No orchestration task found for agent: ${n}`),d();c("task-linker",`Found task ${r.taskId} for agent ${n}`),I(r.taskId,"in_progress"),E(n,"in_progress",r.taskId);let s=rt({taskId:r.taskId,status:"in_progress"}),i=`## Orchestration: Task Linked

Agent \`${n}\` has been linked to task **${r.taskId}**.

${s}

The task status should be updated to \`in_progress\`.`;return c("task-linker",`Linked agent ${n} to task ${r.taskId}`),A(i)}import{mkdirSync as Ss,existsSync as Gt,readFileSync as Jt}from"node:fs";import{join as it,dirname as bs}from"node:path";var _s=[/security|vulnerab|audit|penetration/i,/architect|design.*system|distributed/i,/migration.*schema|database.*design/i,/performance.*optim|profil|bottleneck/i,/langgraph|workflow.*orchestrat/i],xs=[/\b(?:list|count|check|verify|read|search)\b/i,/\b(?:simple|straightforward|quick)\b/i,/\b(?:format|lint|style|typo|rename)\b/i,/\b(?:status|progress|summary)\b/i],O=new Map,w=new Map;function Wt(t){if(O.has(t))return O.get(t);let e=V();if(!e)return O.set(t,"inherit"),"inherit";let n=it(e,"agents",`${t}.md`);if(!Gt(n))return O.set(t,"inherit"),"inherit";try{let s=Jt(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!s)return O.set(t,"inherit"),"inherit";let i=s[1].match(/^model:\s*(.+)$/m),o=i?i[1].trim():"inherit";return O.set(t,o),o}catch{return O.set(t,"inherit"),"inherit"}}function vs(t){if(w.has(t))return w.get(t);let e=V();if(!e)return w.set(t,null),null;let n=it(e,"agents",`${t}.md`);if(!Gt(n))return w.set(t,null),null;try{let s=Jt(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!s)return w.set(t,null),null;let i=s[1].match(/^skills:\s*\n((?:\s+-\s+.+\n)*)/m);if(!i)return w.set(t,null),null;let o=i[1].match(/^\s+-\s+(.+)$/gm)?.map(l=>l.trim().replace(/^-\s+/,""))||[];if(o.length===0)return w.set(t,null),null;let a={low:0,medium:1,high:2},u="low";for(let l of o.slice(0,5)){let p=it(e,"skills",l,"SKILL.md");if(!Gt(p))continue;let f=Jt(p,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!f)continue;let _=f[1].match(/^complexity:\s*(low|medium|high)$/m);if(_){let y=_[1];a[y]>a[u]&&(u=y)}}return w.set(t,u),u}catch{return w.set(t,null),null}}function We(t,e){let n=vs(t);if(n==="high")return"high";let r=_s.filter(o=>o.test(e)).length,s=Wt(t);return r>=2||s==="opus"?"high":xs.filter(o=>o.test(e)).length>=2?"low":n||"medium"}function ze(t){let e=Wt(t);return e==="inherit"?process.env.CLAUDE_MODEL||"sonnet":e}function $s(t,e){let n=We(t,e),r=ze(t);return n==="high"&&r==="haiku"?{recommended:"sonnet",current:r,reason:"High-complexity task \u2014 haiku may produce lower quality results",savingsPercent:0}:n==="low"&&r==="opus"?{recommended:"sonnet",current:r,reason:"Simple task \u2014 sonnet handles this equally well at lower cost",savingsPercent:40}:n==="medium"&&r==="opus"&&Wt(t)!=="opus"?{recommended:"sonnet",current:r,reason:"Medium-complexity task \u2014 sonnet is sufficient",savingsPercent:30}:null}function Is(t,e,n,r){let s=it(g(),".claude","logs","model-usage.jsonl");try{Ss(bs(s),{recursive:!0}),h(s,`${JSON.stringify({timestamp:new Date().toISOString(),agent:t,model:e,complexity:n,recommendation:r?.recommended||null,potentialSavings:r?.savingsPercent||0})}
`)}catch{}}function ot(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"";if(!n)return d();let s=We(n,r),i=ze(n),o=$s(n,r);return Is(n,i,s,o),o?(c("model-cost-advisor",`${n}: Recommend ${o.recommended} over ${o.current} (${o.reason})`,"info"),o.savingsPercent>=30?C(`Model cost: ${n} using ${o.current} for ${s}-complexity task. ${o.reason}. ~${o.savingsPercent}% savings with "${o.recommended}".`):d()):(c("model-cost-advisor",`${n}: ${i} appropriate for ${s} task`),d())}import{existsSync as ws,readFileSync as Ts,writeFileSync as As,statSync as Cs,mkdirSync as Ds}from"node:fs";import{execFileSync as Rs}from"node:child_process";import{tmpdir as Es}from"node:os";import{join as zt}from"node:path";var Vt=zt(Es(),"orchestkit-issue-cache"),Os=300*1e3,Ps=3e3;function Hs(t){let e=t.match(/^(?:issue|fix|feat|bug|hotfix|feature)\/(\d+)/)||t.match(/^(\d+)-/);return e?e[1]:null}function js(){try{Ds(Vt,{recursive:!0,mode:448})}catch{}}function Ns(t){let e=zt(Vt,`${t}.json`);try{if(!ws(e))return null;let n=Cs(e);return Date.now()-n.mtimeMs>Os?null:JSON.parse(Ts(e,"utf8"))}catch{return null}}function Ms(t,e){if(!/^\d+$/.test(t))return null;try{let n=Rs("gh",["issue","view",t,"--json","title,body,labels"],{cwd:e,encoding:"utf8",timeout:Ps,stdio:["pipe","pipe","pipe"]}).trim(),r=JSON.parse(n);try{js();let s=zt(Vt,`${t}.json`);As(s,JSON.stringify(r),"utf8")}catch{}return r}catch{return null}}function Fs(t,e){let n=[];if(e?.title?n.push(`Working on GitHub Issue #${t}: ${e.title}`):n.push(`Working on GitHub Issue #${t}`),e?.labels&&e.labels.length>0){let r=e.labels.map(s=>s.name).join(", ");n.push(`Labels: ${r}`)}return n.push(`Reference #${t} in all commits. Use 'Closes #${t}' in PR description.`),n.join(`
`)}function at(t){try{let e=g(),n=ye(e);c("issue-context-injector",`Branch: ${n}`);let r=Hs(n);if(!r)return c("issue-context-injector","No issue number in branch name"),d();c("issue-context-injector",`Detected issue #${r}`);let s=Ns(r)??Ms(r,e),i=Fs(r,s);return c("issue-context-injector",`Injecting context for issue #${r}`),{continue:!0,systemMessage:i}}catch{return c("issue-context-injector","Unexpected error, falling back to silent success","warn"),d()}}var P="subagent-start-dispatcher",Ve=800,Ls=[{name:"subagent-context-stager",fn:et},{name:"graph-memory-inject",fn:Q},{name:"task-linker",fn:st},{name:"model-cost-advisor",fn:ot},{name:"issue-context-injector",fn:at}];function Ke(t){try{let u=Z(t);if(!u.continue)return c(P,"context-gate blocked agent spawn"),u}catch(u){let l=u instanceof Error?u.message:String(u);c(P,`context-gate failed: ${l}`,"warn")}let e=null;try{let u=nt(t);e=K(u)}catch(u){let l=u instanceof Error?u.message:String(u);c(P,`subagent-validator failed: ${l}`,"warn")}let n=[],r=[],s=0;if(e){let u=X(e);n.push(e),s+=u}for(let u of Ls)try{let l=u.fn(t);l.systemMessage&&typeof l.systemMessage=="string"&&r.push(l.systemMessage);let p=l.hookSpecificOutput?.additionalContext;if(p){let m=X(p);if(s+m>Ve){c(P,`Budget limit: skipping ${u.name} (${m}t would exceed ${Ve}t cap)`);continue}n.push(p),s+=m,c(P,`${u.name}: +${m}t (total: ${s}t)`)}}catch(l){let p=l instanceof Error?l.message:String(l);c(P,`${u.name} failed: ${p}`,"warn")}let i=n.length>0,o=r.length>0;if(!i&&!o)return d();let a={continue:!0};if(o&&(a.systemMessage=r.join(`

`)),i){let u=n.join(`

---

`);c(P,`Consolidated ${n.length} hooks into ${s}t`),a.hookSpecificOutput={additionalContext:u}}return a}import{existsSync as Us,mkdirSync as Bs,unlinkSync as qs}from"node:fs";import{basename as Gs,dirname as Js}from"node:path";var Ws=["decided to","chose","implemented using","selected","opted for","will use","pattern:","approach:","architecture:","recommends","best practice","anti-pattern","learned that"],zs="decisions";function Vs(){return`${g()}/.claude/logs/agent-patterns.jsonl`}function Ks(){return`${g()}/.claude/session`}function Xe(){let t=g();return(Gs(t)||"default-project").toLowerCase().replace(/ /g,"-").replace(/[^a-z0-9-]/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-")}function Xs(t){return`${Xe()}-${t}`}function Qs(t){let r=(t.length>10240?t.substring(0,10240):t).toLowerCase();return/pagination|cursor|offset/.test(r)?"pagination":/security|vulnerability|exploit|injection|xss|csrf|owasp|safety|guardrail/.test(r)?"security":/database|sql|postgres|schema/.test(r)?"database":/\bapi\b|endpoint|\brest\b|graphql/.test(r)?"api":/auth|login|jwt|oauth/.test(r)?"authentication":/\btest\b|testing|pytest|jest|vitest|coverage|\bmock\b|fixture|\bspec\b/.test(r)?"testing":/deploy|\bci\b|\bcd\b|pipeline|docker|kubernetes|helm|terraform/.test(r)?"deployment":/observability|monitoring|logging|tracing|metrics|prometheus|grafana|langfuse/.test(r)?"observability":/react|component|frontend|\bui\b/.test(r)?"frontend":/performance|optimization|cache|index/.test(r)?"performance":/llm|\brag\b|embedding|vector|semantic|\bai\b|\bml\b|langchain|langgraph|openai|anthropic/.test(r)?"ai-ml":/etl|streaming|dataflow|spark/.test(r)||Ct(r,"data","pipeline")||Ct(r,"batch","processing")?"data-pipeline":/architecture|design|structure/.test(r)?"architecture":/decided|chose|selected/.test(r)?"decision":"pattern"}function Ys(t){let e=[];if(t.length<50)return e;for(let r of Ws){let s=r.toLowerCase(),i=t.split(`
`).filter(o=>o.toLowerCase().includes(s));for(let o of i){let a=o.trim().substring(0,200);a.length>20&&e.push(a)}}return[...new Set(e)].slice(0,5)}function ct(t){c("agent-memory-store","Agent memory store hook starting");let e=t.tool_input||{},n=t.subagent_type||e.subagent_type||e.type||"",r=t.tool_result,s=typeof r=="string"?r:r?.content||t.agent_output||t.output||"",i=!0;if(t.error&&(i=!1),typeof r=="object"&&r?.is_error&&(i=!1),!n)return c("agent-memory-store","No agent type in input, skipping"),d();let o=`ork:${n}`,a=`${Ks()}/current-agent-id`;try{Us(a)&&qs(a)}catch{}c("agent-memory-store",`Processing completion for agent: ${n} (agent_id: ${o}, success: ${i})`);let u=i&&s?Ys(s):[];if(u.length===0)return c("agent-memory-store",`No patterns extracted from ${n} output`),d();let l=Vs(),p=Js(l);try{Bs(p,{recursive:!0})}catch{}let m=Xe(),f=new Date().toISOString(),_=Xs(zs);for(let k of u){let J=Qs(k),se={agent:n,agent_id:o,pattern:k,project:m,timestamp:f,scope_id:_,category:J,pending_graph_sync:!0};try{h(l,`${JSON.stringify(se)}
`)}catch{}c("agent-memory-store",`Extracted pattern (${J}): ${k.substring(0,50)}...`)}return c("agent-memory-store",`Extracted ${u.length} patterns from ${n} output`),{continue:!0,systemMessage:`[Pattern Extraction] ${u.length} patterns extracted from ${n}. To persist, use mcp__memory__create_entities with entities: [{"name": "${n}-pattern", "entityType": "Pattern", "observations": ["<pattern>"]}]`}}import{existsSync as Zs,writeFileSync as Qe,mkdirSync as Kt,readFileSync as ti}from"node:fs";import{dirname as ei}from"node:path";var ni=[".env","credentials","secret","auth","password","token","api.key","private.key",".pem","oauth","jwt","session","cookie","encryption","crypto"];function ri(){let t=`${g()}/.claude/hooks/logs`;try{Kt(t,{recursive:!0})}catch{}return`${t}/auto-spawn-quality.log`}function si(){return`${g()}/.claude/context/spawn-queue.json`}function x(t){let e=ri(),n=new Date().toISOString();try{h(e,`[${n}] [auto-spawn-quality] ${t}
`)}catch{}}function ii(t){let e=t.toLowerCase();for(let n of ni)if(e.includes(n))return x(`Detected sensitive pattern: ${n}`),!0;return!1}function oi(t,e,n,r,s,i){let o=`SPAWN-${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,14)}-${Math.floor(Math.random()*1e4).toString().padStart(4,"0")}`,a=si(),u=ei(a);try{Kt(u,{recursive:!0})}catch{}let l;if(Zs(a))try{l=JSON.parse(ti(a,"utf8"))}catch{l={schema_version:"1.0.0",created_at:i,queue:[]}}else l={schema_version:"1.0.0",created_at:i,queue:[]};let p={spawn_id:o,target_agent:e,trigger_agent:t,trigger_reason:n,priority:r,timestamp:i,session_id:s,status:"queued"};l.queue.push(p);try{Qe(a,JSON.stringify(l,null,2)),x(`Queued spawn request: ${o} for ${e} (reason: ${n})`)}catch{return x(`ERROR: Failed to queue spawn request for ${e}`),""}return o}function ai(t,e,n,r,s,i){let o=`${g()}/.claude/context/handoffs`;try{Kt(o,{recursive:!0})}catch{}let a=`${o}/auto_spawn_${e}_${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,15)}.json`,u={type:"auto_spawn_suggestion",from_agent:t,to_agent:e,timestamp:i,trigger_reason:n,priority:r,session_id:s,auto_triggered:!0,status:"suggested"};try{Qe(a,JSON.stringify(u,null,2)),x(`Created spawn suggestion: ${e} (reason: ${n})`)}catch{}}function ci(t,e,n){if(n&&n!=="null")return x(`Skipping auto-spawn - agent ${t} had errors: ${n}`),null;if(t==="test-generator")return x("Rule matched: test-generator -> code-quality-reviewer"),{target:"code-quality-reviewer",reason:"test-generator completed - validating test quality and coverage",priority:"high"};if(ii(e)&&t!=="security-auditor"&&t!=="security-layer-auditor")return x("Rule matched: sensitive files detected -> security-auditor"),{target:"security-auditor",reason:"sensitive file changes detected - security audit required",priority:"critical"};if(t==="code-quality-reviewer")return x("Rule matched: code-quality-reviewer -> security-auditor"),{target:"security-auditor",reason:"code-quality-reviewer completed - proceeding with security scan",priority:"high"};if(t==="backend-system-architect"){let r=e.toLowerCase();if(/authentication|authorization|security|access.control|rbac|acl/.test(r))return x("Rule matched: backend-system-architect with auth -> security-layer-auditor"),{target:"security-layer-auditor",reason:"backend-system-architect designed auth/security layer - validation required",priority:"high"}}return null}function ut(t){let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",s=t.session_id,i=t.agent_output||t.output||"",o=t.error||"";if(x(`Checking auto-spawn conditions for agent: ${r} (session: ${s})`),r==="unknown"||!r)return x("Skipping unknown agent type"),d();let a=ci(r,i,o);if(a){let u=oi(r,a.target,a.reason,a.priority,s,e);return ai(r,a.target,a.reason,a.priority,s,e),x(`=== AUTO-SPAWN QUALITY HOOK ===
Trigger Agent: ${r}
Target Agent: ${a.target}
Reason: ${a.reason}
Priority: ${a.priority}
Spawn ID: ${u}
Timestamp: ${e}
Session: ${s}`),{continue:!0,systemMessage:`Auto-spawn queued: ${a.target} (${a.priority} priority)`}}return x(`No auto-spawn conditions matched for ${r}`),d()}import{existsSync as ui,writeFileSync as nn,mkdirSync as li,readFileSync as gi}from"node:fs";import{dirname as Xt}from"node:path";function Ye(){return`${g()}/.claude/context/knowledge/decisions/active.json`}function di(){return`${g()}/.claude/context/session/state.json`}function pi(){return`${g()}/.claude/logs/agent-context`}function lt(t){try{li(t,{recursive:!0})}catch{}}function Ze(t,e){if(!ui(t))return e;try{return JSON.parse(gi(t,"utf8"))}catch{return e}}function tn(t,e){let n=Xt(t);lt(n);try{nn(t,JSON.stringify(e,null,2))}catch{}}var en=50;function gt(t){let e=t.subagent_type||t.agent_type||"unknown",n=new Date().toISOString(),r=t.agent_output||t.output||"",s=r.substring(0,200);r.length>200&&(s+="...");let i=e!=="unknown"||s.trim().length>0,o=e.replace(/-/g,"_");if(i){let k=Ye(),J=Xt(k);lt(J);let M=Ze(k,{schema_version:"2.0.0",decisions:{}});(!M.decisions||typeof M.decisions!="object")&&(M.decisions={});let Cn={timestamp:n,agent:e,summary:s,status:"completed"};M.decisions[o]=Cn,tn(k,M)}let a=di(),u=Xt(a);lt(u);let p=Ze(a,{schema_version:"2.0.0",session_id:"",started_at:n,last_activity:n,active_agent:null,tasks_pending:[],tasks_completed:[]});if(Array.isArray(p.tasks_completed)||(p.tasks_completed=[]),Array.isArray(p.tasks_pending)||(p.tasks_pending=[]),i){let k={agent:e,timestamp:n,summary:s};p.tasks_completed.push(k),p.tasks_completed.length>en&&(p.tasks_completed=p.tasks_completed.slice(-en))}p.last_activity=n,p.active_agent=null,tn(a,p);let m=pi();lt(m);let f=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),_=`${m}/${e}_${f}.log`,y=`=== CONTEXT PUBLICATION (Protocol 2.0) ===
Agent: ${e}
Timestamp: ${n}
Decisions file: ${Ye()}
Session state: ${a}

=== AGENT OUTPUT ===
${r}
`;try{nn(_,y)}catch{}return d()}import{existsSync as mi,writeFileSync as sn,mkdirSync as Yt,readFileSync as fi}from"node:fs";import{dirname as yi}from"node:path";function Qt(){return!!(process.env.CLAUDE_CODE_TEAM_NAME||process.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS==="1")}var rn=[{type:"product-thinking",name:"Product Thinking Pipeline",description:"Full product discovery and specification workflow",triggers:["should we build","product decision","feature validation","market research","user research"],steps:[{agent:"market-intelligence",description:"Analyze competitive landscape and market trends",dependsOn:[],skills:["market-research"],estimatedTokens:3e3},{agent:"ux-researcher",description:"Create personas and map user journeys",dependsOn:[0],skills:["user-research"],estimatedTokens:2500},{agent:"product-strategist",description:"Validate value proposition and alignment",dependsOn:[0,1],skills:["product-strategy"],estimatedTokens:2e3},{agent:"prioritization-analyst",description:"Score and prioritize using frameworks",dependsOn:[2],skills:["prioritization"],estimatedTokens:1500},{agent:"business-case-builder",description:"Build ROI and cost-benefit analysis",dependsOn:[2,3],skills:["business-case"],estimatedTokens:2e3},{agent:"requirements-translator",description:"Transform to PRD and user stories",dependsOn:[4],skills:["requirements"],estimatedTokens:2500}],estimatedTotalTokens:13500},{type:"full-stack-feature",name:"Full-Stack Feature Pipeline",description:"End-to-end feature implementation workflow",triggers:["full-stack feature","build a feature","implement end-to-end","create full feature","add complete feature"],steps:[{agent:"backend-system-architect",description:"Design API and database schema",dependsOn:[],skills:["api-design","database-patterns"],estimatedTokens:3e3},{agent:"frontend-ui-developer",description:"Build React components and UI",dependsOn:[0],skills:["react-server-components-framework","form-state-patterns"],estimatedTokens:3500},{agent:"test-generator",description:"Create unit and integration tests",dependsOn:[0,1],skills:["testing-patterns"],estimatedTokens:2e3},{agent:"security-auditor",description:"Audit for vulnerabilities",dependsOn:[0,1],skills:["security-patterns"],estimatedTokens:1500}],estimatedTotalTokens:1e4},{type:"ai-integration",name:"AI Integration Pipeline",description:"Add AI/LLM capabilities to application",triggers:["add rag","add llm","ai integration","implement rag","add ai feature","langgraph workflow"],steps:[{agent:"workflow-architect",description:"Design LangGraph workflow and state",dependsOn:[],skills:["langgraph"],estimatedTokens:2500},{agent:"llm-integrator",description:"Connect LLM APIs with function calling",dependsOn:[0],skills:["llm-integration"],estimatedTokens:2e3},{agent:"data-pipeline-engineer",description:"Build embeddings and data pipeline",dependsOn:[0],skills:["embeddings","rag-retrieval"],estimatedTokens:2500},{agent:"test-generator",description:"Create LLM testing infrastructure",dependsOn:[1,2],skills:["testing-patterns"],estimatedTokens:1500}],estimatedTotalTokens:8500},{type:"security-audit",name:"Security Audit Pipeline",description:"Comprehensive security review workflow",triggers:["security audit","security review","vulnerability scan","security assessment"],steps:[{agent:"security-auditor",description:"Scan for OWASP Top 10 vulnerabilities",dependsOn:[],skills:["security-patterns"],estimatedTokens:2e3},{agent:"security-layer-auditor",description:"Verify defense-in-depth layers",dependsOn:[0],skills:["security-patterns"],estimatedTokens:2e3},{agent:"ai-safety-auditor",description:"Audit AI/LLM security if applicable",dependsOn:[0],skills:["mcp-security-hardening"],estimatedTokens:1500}],estimatedTotalTokens:5500},{type:"frontend-compliance",name:"Frontend 2026 Compliance Pipeline",description:"Modernize frontend to 2026 patterns",triggers:["frontend compliance","modernize frontend","update react","frontend 2026"],steps:[{agent:"frontend-ui-developer",description:"Upgrade to React 19 patterns",dependsOn:[],skills:["react-server-components-framework","zustand-patterns"],estimatedTokens:3e3},{agent:"frontend-performance-engineer",description:"Optimize Core Web Vitals",dependsOn:[0],skills:["performance"],estimatedTokens:2e3},{agent:"accessibility-specialist",description:"Ensure WCAG 2.2 compliance",dependsOn:[0],skills:["testing-patterns","accessibility"],estimatedTokens:1500}],estimatedTotalTokens:6500}];function hi(){return`${g()}/.claude/coordination/decision-log.json`}function ki(){let t=`${g()}/.claude/hooks/logs`;try{Yt(t,{recursive:!0})}catch{}return`${t}/agent-feedback.log`}function T(t){let e=ki(),n=new Date().toISOString();try{h(e,`[${n}] [feedback-loop] ${t}
`)}catch{}}function Si(t){let e=Ge();if(e){let r=rn.find(s=>s.type===e.type);if(r){let s=r.steps.findIndex(i=>i.agent===t);if(s>=0){let i=r.steps.filter((o,a)=>o.dependsOn.includes(s)&&a>s).map(o=>o.agent);if(i.length>0)return i.join(" ")}}}return{"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"test-generator","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer"}[t]||""}function bi(t){return{"market-intelligence":"product-thinking","product-strategist":"product-thinking","prioritization-analyst":"product-thinking","business-case-builder":"product-thinking","requirements-translator":"specification","metrics-architect":"specification","backend-system-architect":"architecture","database-engineer":"architecture","data-pipeline-engineer":"architecture","frontend-ui-developer":"frontend","rapid-ui-designer":"frontend","ux-researcher":"frontend","test-generator":"quality","code-quality-reviewer":"quality","security-auditor":"security","security-layer-auditor":"security","workflow-architect":"ai-integration","llm-integrator":"ai-integration","debug-investigator":"debugging"}[t]||"general"}function _i(){return process.env.CLAUDE_INSTANCE_ID||`${_t("node:os").hostname()}-${process.pid}`}function xi(t){let e=t.substring(0,500);return t.length>500&&(e+="..."),e}function vi(t,e,n,r,s,i,o,a){let u=hi(),l=yi(u);try{Yt(l,{recursive:!0})}catch{}let p;if(mi(u))try{p=JSON.parse(fi(u,"utf8"))}catch{p={schema_version:"2.0.0",log_created_at:o,decisions:[]}}else p={schema_version:"2.0.0",log_created_at:o,decisions:[]};let m={decision_id:t,timestamp:o,made_by:{instance_id:_i(),agent_type:e},category:n,title:`Agent ${e} completed`,description:r,impact:{scope:"agent-pipeline",downstream_agents:s.split(" ").filter(Boolean)},status:i,task_id:a};p.decisions.push(m);try{sn(u,JSON.stringify(p,null,2)),T(`Decision ${t} logged for agent ${e}`)}catch{T("ERROR: Failed to write decision to log")}}function $i(t,e,n,r,s,i,o){if(!e)return;let a=`${g()}/.claude/context/handoffs`;try{Yt(a,{recursive:!0})}catch{}let u=e.split(" ").filter(Boolean),l=new Date().toISOString().replace(/[-:]/g,"").substring(0,15);for(let p of u){let m=`${a}/${t}_to_${p}_${l}.json`,f={from_agent:t,to_agent:p,timestamp:i,decision_id:r,summary:n,session_id:s,status:"pending",feedback_loop:!0,task_id:o};try{sn(m,JSON.stringify(f,null,2)),T(`Created handoff context: ${t} -> ${p}`)}catch{}}}function dt(t){if(Qt())return d();let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",s=t.session_id,i=t.agent_output||t.output||"",o=t.error||"";if(T(`Processing feedback for agent: ${r} (session: ${s})`),r==="unknown"||!r)return T("Skipping unknown agent type"),d();let a=new Date().toISOString().replace(/[-:T.]/g,"").substring(0,8),u=Math.floor(Math.random()*1e4).toString().padStart(4,"0"),l=`DEC-${a}-${u}`,m=D(r)?.taskId,f=Si(r),_=bi(r),y,k;return o&&o!=="null"?(y=`Agent failed: ${o}`,k="failed"):(y=xi(i),k="completed"),m&&(I(m,k==="completed"?"completed":"failed"),T(`Updated task ${m} status to ${k}`)),vi(l,r,_,y,f,k,e,m),f?($i(r,f,y,l,s,e,m),T(`Routed findings to downstream agents: ${f}`)):T(`No downstream agents for ${r} (terminal agent)`),T(`=== AGENT FEEDBACK LOOP ===
Agent: ${r}
Category: ${_}
Decision ID: ${l}
Task ID: ${m||"none"}
Timestamp: ${e}
Status: ${k}
Downstream: ${f||"none"}

Summary: ${y}`),f?{continue:!0,systemMessage:`Feedback loop: routed to ${f}${m?` (task: ${m})`:""}`}:d()}import{writeFileSync as on,mkdirSync as an}from"node:fs";var Ii=new Set(["market-intelligence","product-strategist","prioritization-analyst","business-case-builder","requirements-translator","metrics-architect","backend-system-architect","code-quality-reviewer","data-pipeline-engineer","database-engineer","debug-investigator","frontend-ui-developer","llm-integrator","rapid-ui-designer","security-auditor","security-layer-auditor","system-design-reviewer","test-generator","ux-researcher","workflow-architect"]),wi={"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"code-quality-reviewer","code-quality-reviewer":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"code-quality-reviewer","database-engineer":"backend-system-architect","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer","security-auditor":"none","security-layer-auditor":"none","debug-investigator":"none","system-design-reviewer":"none"},Ti={"market-intelligence":"Next: product-strategist should define product vision based on market analysis","product-strategist":"Next: prioritization-analyst should rank features from strategy","prioritization-analyst":"Next: business-case-builder should create ROI justification","business-case-builder":"Next: requirements-translator should convert to technical specs","requirements-translator":"Next: metrics-architect should define success criteria","metrics-architect":"Next: backend-system-architect should design API endpoints","backend-system-architect":"Next: frontend-ui-developer should build UI components","frontend-ui-developer":"Next: test-generator should create test coverage","test-generator":"Next: code-quality-reviewer should validate implementation","code-quality-reviewer":"Next: security-auditor should perform security scan","workflow-architect":"Next: llm-integrator should configure LLM providers","llm-integrator":"Next: data-pipeline-engineer should set up embeddings","data-pipeline-engineer":"Next: code-quality-reviewer should validate data pipeline","database-engineer":"Next: backend-system-architect should integrate schema","rapid-ui-designer":"Next: frontend-ui-developer should implement designs","ux-researcher":"Next: rapid-ui-designer should create mockups"};function Ai(t){return wi[t]||"none"}function Ci(t){return Ti[t]||"Pipeline complete"}function Di(t,e,n,r,s){let i=`${g()}/.claude/context/handoffs`;try{an(i,{recursive:!0})}catch{}let o=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),a=`${i}/${t}_to_${e}_${o}.json`,u={from_agent:t,to_agent:e,timestamp:n,summary:r,suggestions:s,status:"ready_for_handoff"};try{on(a,JSON.stringify(u,null,2))}catch{}return a}function Ri(t,e,n,r,s,i){let o=`${g()}/.claude/logs/agent-handoffs`;try{an(o,{recursive:!0})}catch{}let a=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),u=`${o}/${t}_${a}.log`,l=`=== HANDOFF PREPARATION ===
From: ${t}
To: ${e}
Timestamp: ${n}
Handoff file: ${i}

Summary: ${r}

Next Steps: ${s}
`;try{on(u,l)}catch{}}function pt(t){let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown";if(!Ii.has(r))return d();let s=Ai(r),i=t.agent_output||t.output||"",o=i.length,a;o>0?(a=i.substring(0,300),o>300&&(a+="...")):a=`Agent ${r} completed`;let u=Ci(r),l=Di(r,s,e,a,u);return Ri(r,s,e,a,u,l),d()}import{writeFileSync as Ei,mkdirSync as cn}from"node:fs";var Oi=[".env","auth","secret","credential","password","token","apikey","api_key","api-key","jwt","session","oauth","permission",".pem",".key"];function Pi(){let t=`${g()}/.claude/logs/multi-claude`;try{cn(t,{recursive:!0})}catch{}return t}function R(t,e,n){let r=Pi(),s=new Date().toISOString().substring(0,10).replace(/-/g,""),i=`${r}/verifier_${s}.log`,o=new Date().toISOString();try{h(i,`[${o}] [${t}] ${e}: ${n}
`)}catch{}}function Hi(t){let e=t.toLowerCase();for(let n of Oi)if(e.includes(n))return!0;return!!(e.includes("config")&&e.includes("prod"))}function mt(t){let e=new Date().toISOString(),n=g(),s=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",i=t.agent_output||t.output||"",o=[];if(s==="test-generator"&&(o.push({agent:"code-quality-reviewer",reason:"Test generation complete - quality review recommended"}),R(s,"TRIGGER","test-generator completion triggers code-quality-reviewer")),s==="frontend-ui-developer"&&/form|input|validation|submit|auth|login/i.test(i)&&(o.push({agent:"security-auditor",reason:"Frontend auth/form components - security review recommended"}),R(s,"TRIGGER","frontend auth components trigger security-auditor")),s==="backend-system-architect"&&/endpoint|route|api|auth|jwt|session/i.test(i)&&(o.push({agent:"security-auditor",reason:"Backend API endpoints - security review recommended"}),R(s,"TRIGGER","backend API endpoints trigger security-auditor")),Hi(i)&&(o.some(u=>u.agent==="security-auditor")||(o.push({agent:"security-auditor",reason:"Sensitive files modified - security review required"}),R(s,"TRIGGER","sensitive file patterns detected"))),s==="database-engineer"&&(o.push({agent:"code-quality-reviewer",reason:"Database schema changes - review for consistency"}),R(s,"TRIGGER","database changes trigger code-quality-reviewer")),s==="workflow-architect"&&(o.push({agent:"security-layer-auditor",reason:"LangGraph workflow created - layer audit recommended"}),R(s,"TRIGGER","workflow-architect triggers security-layer-auditor")),o.length>0){let a=`${n}/.claude/context/verification-queue`;try{cn(a,{recursive:!0})}catch{}let u=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),l=`${a}/pending_${u}_${s}.json`,p={triggered_by:s,timestamp:e,verifications:o.map(f=>({agent:f.agent,reason:f.reason,status:"pending"}))};try{Ei(l,JSON.stringify(p,null,2))}catch{}let m="Multi-Claude Verification Triggered: "+o.map(f=>`${f.agent} (${f.reason})`).join("; ");return R(s,"QUEUE",`Created verification queue: ${l}`),{continue:!0,systemMessage:m}}return R(s,"SKIP","No verification triggers matched"),d()}import{writeFileSync as ji,mkdirSync as Ni}from"node:fs";function Mi(){let t=`${g()}/.claude/logs/agent-validation`;try{Ni(t,{recursive:!0})}catch{}return t}function ft(t){let e=t.subagent_type||t.agent_type||"unknown",n=new Date().toISOString(),r=t.agent_output||t.output||"",s=[],i=[];r||s.push("Agent produced empty output");let o=r.length;if(o<50&&i.push(`Output seems very short (${o} chars)`),/error|failed|exception/i.test(r)&&i.push("Output contains error-related keywords"),e==="backend-system-architect"&&r.includes("{")){let y=r.match(/\{[^{}]{0,1000}\}/);if(y)try{JSON.parse(y[0])}catch{i.push("JSON structure may be malformed")}}let a=s.length>0?"failed":"passed",u=t.last_assistant_message?.length??null,l=`Output Validation [${a}] - Agent: ${e}, Timestamp: ${n}, Output length: ${o} chars`+(u!==null?`, Response length: ${u} chars`:"");s.length>0&&(l+=` | Errors: ${s.join("; ")}`),i.length>0&&(l+=` | Warnings: ${i.join("; ")}`);let p=Mi(),m=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),f=`${p}/${e}_${m}.log`,_=`=== OUTPUT VALIDATION ===
${l}
${u!==null?`Response quality signal: last_assistant_message length = ${u}
`:""}
=== AGENT OUTPUT ===
${r}
`;try{ji(f,_)}catch{}return a==="failed"?{continue:!1,systemMessage:l,hookSpecificOutput:{hookEventName:"SubagentStop"}}:{continue:!0,suppressOutput:!0,systemMessage:l}}import{existsSync as ln,writeFileSync as Fi,readFileSync as gn}from"node:fs";import{join as Li}from"node:path";var Zt=ue(),yt={security_minimum:5,general_minimum:3};function Ui(t){let e=[];if(!t)return e;let n=/\*{0,2}(\w[\w\s]{0,30}?)\*{0,2}\s*:\s*(\d+(?:\.\d+)?)\s*\/\s*(\d+)/g;for(let s of t.matchAll(n)){let i=s[1].trim().toLowerCase(),o=parseFloat(s[2]),a=parseFloat(s[3]);!Number.isNaN(o)&&!Number.isNaN(a)&&a>0&&e.push({value:o,max:a,dimension:i==="score"?null:i})}let r=/"(\w+_?score|score)"\s*:\s*(\d+(?:\.\d+)?)/gi;for(let s of t.matchAll(r)){let i=s[1].toLowerCase(),o=parseFloat(s[2]);if(!Number.isNaN(o)){let a=i==="score"?null:i.replace(/_score$/,"");e.push({value:o,max:10,dimension:a})}}return e}function Bi(){let t=g();if(!t||t===".")return{};let e=Li(t,".claude","policies","verification-policy.json");if(!ln(e))return{};try{return JSON.parse(gn(e,"utf8"))}catch{return c("subagent-quality-gate","Failed to parse verification-policy.json","warn"),{}}}function qi(t,e){let n={...yt,...e.thresholds};if(t){let r=`${t}_minimum`;if(r in n)return n[r]??yt.general_minimum;if(/security|vuln|cve|owasp/i.test(t))return n.security_minimum??yt.security_minimum}return n.general_minimum??yt.general_minimum}function Gi(t){return!t||t.length<200?!0:[/\bfinding/i,/\bevidence/i,/\brecommendation/i,/\bissue/i,/\bresult/i,/\bsummary/i,/^[-*]\s/m,/^\d+\.\s/m,/^#{1,3}\s/m].some(n=>n.test(t))}function un(t){if(ln(Zt))try{let e=JSON.parse(gn(Zt,"utf8"));t==="error"?e.errors=(e.errors||0)+1:t==="threshold_failure"&&(e.threshold_failures=(e.threshold_failures||0)+1),e.quality_checks=(e.quality_checks||0)+1,Fi(Zt,JSON.stringify(e,null,2))}catch{}}function ht(t){let e=t.agent_id||"",n=t.subagent_type||"",r=t.error||"",s=t.agent_output||t.output||t.last_assistant_message||"";if(c("subagent-quality-gate",`Quality gate check: ${n} (${e})`),r&&r!=="null")return c("subagent-quality-gate",`ERROR: Subagent failed - ${r}`),un("error"),C(`Subagent ${n} failed: ${r}`);let i=Ui(s);if(i.length>0){let o=Bi();for(let a of i){let u=a.value/a.max*10,l=qi(a.dimension,o),p=a.dimension||"overall";if(u<l)return c("subagent-quality-gate",`Score below threshold: ${p}=${u.toFixed(1)}/10 (min: ${l})`,"warn"),un("threshold_failure"),C(`Quality gate: ${p} score ${a.value}/${a.max} (${u.toFixed(1)}/10) is below minimum ${l}/10. Review the ${p} findings before proceeding.`)}}return s.length>200&&!Gi(s)&&c("subagent-quality-gate",`Subagent ${n} output lacks structured findings`,"info"),d()}function Ji(t){let e=t.error||t.tool_error,n=t.exit_code;if(e&&e!=="null"&&e!==""||n!==void 0&&n!==0)return!1;let r=t.agent_output||t.output||"",s=[/\bfailed\b/i,/\berror:\s/i,/\bexception\b/i,/\bcould not\b/i,/\bunable to\b/i],i=r.slice(0,500);for(let o of s)o.test(i)&&c("task-completer",`Warning: possible error in output: ${o}`);return!0}function kt(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return c("task-completer","No agent type found, skipping"),d();c("task-completer",`Processing SubagentStop for: ${n}`);let r=D(n);if(!r)return c("task-completer",`No orchestration task found for agent: ${n}`),Et(n),d();let s=Ji(t),i=s?"completed":"failed";c("task-completer",`Agent ${n} completed with status: ${i}`),I(r.taskId,i),E(n,i);let o=`## Orchestration: Task ${s?"Completed":"Failed"}

Agent \`${n}\` has finished with status: **${i}**

${rt({taskId:r.taskId,status:s?"completed":"pending"})}
`;if(s&&r.pipelineId&&r.pipelineStep!==void 0){let a=Je(r.pipelineId,r.pipelineStep);if(a!==null){let u=qt(r.pipelineId).filter(l=>l.pipelineStep===a&&l.status==="pending");u.length>0&&(o+=`
### Pipeline Progress

Pipeline \`${r.pipelineId}\` step ${r.pipelineStep} complete.
Next step (${a}) is now unblocked.

**Next agent(s) to spawn:**
${u.map(l=>`- \`${l.agent}\` (task: ${l.taskId})`).join(`
`)}

Consider spawning the next agent to continue the pipeline.`)}else o+=`
### Pipeline Complete

Pipeline \`${r.pipelineId}\` has completed all steps.`}if(!s){let a=t.error||t.tool_error||"Unknown error";o+=`
### Error Details

The agent encountered an issue:
\`\`\`
${a.slice(0,500)}
\`\`\`

Consider:
1. Retrying with more specific instructions
2. Using an alternative agent
3. Breaking down the task further`;let u=qe(r.taskId);if(u.length>0){o+=`

### Orphaned Tasks (CC 2.1.20)

The following tasks were blocked by the failed task and should be deleted:
`;for(let l of u)o+=`
${Be(l.taskId,`Blocked by failed task ${r.taskId} (agent: ${n})`)}`,I(l.taskId,"failed")}}return i==="completed"&&Et(n),c("task-completer",`Completed task ${r.taskId} with status ${i}`),A(o)}var te=new Map;function Wi(t,e){let n=te.get(t)||[];n.push(e),n.length>10&&n.shift(),te.set(t,n)}function zi(){let t=[];for(let[e,n]of te)n.some(r=>r.outcome==="failure")&&t.push(e);return t}function Vi(t){let e=t.error||t.tool_error,n=t.exit_code,r=t.agent_output||t.output||"";if(e&&e!=="null"&&e!=="")return{outcome:"failure",error:e};if(n!==void 0&&n!==0)return{outcome:"failure",error:`Exit code: ${n}`};let s=[/i cannot|i can't|i am unable/i,/outside my scope/i,/not appropriate/i,/i refuse/i];for(let o of s)if(o.test(r.slice(0,500)))return{outcome:"rejected",error:"Agent rejected the task"};let i=[/partial(?:ly)?/i,/incomplete/i,/some.*failed/i,/couldn't finish/i];for(let o of i)if(o.test(r.slice(0,500)))return{outcome:"partial"};return{outcome:"success"}}function St(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return d();let{outcome:r,error:s}=Vi(t);if(r==="success")return d();c("retry-handler",`Agent ${n} completed with outcome: ${r}`);let i=Ot(),a=$().activeAgents.find(y=>y.agent===n),u=a?.retryCount||0,l=Ie(n,u+1,a?.taskId),p=we(l,r,s||void 0);Wi(n,p);let m=zi(),f=$e(n,u+1,s||"Unknown failure",m,i.maxRetries);if(c("retry-handler",`Retry decision for ${n}: shouldRetry=${f.shouldRetry}, alternative=${f.alternativeAgent||"none"}`),f.shouldRetry)E(n,"retrying");else{E(n,"failed");let y=D(n);y&&I(y.taskId,"failed")}let _=Te(f,n);return A(_)}import{existsSync as hn,mkdirSync as io,readFileSync as oo,writeFileSync as ao}from"node:fs";import{existsSync as Ki,readFileSync as Xi,writeFileSync as Nu,mkdirSync as Mu}from"node:fs";import{execSync as dn}from"node:child_process";import{createHash as Qi}from"node:crypto";import*as pn from"node:os";var Yi=".claude/.user_identity.json",Zi="orchestkit-user-identity-v1";var b=null;function bt(t){return Qi("sha256").update(t+Zi).digest("hex").slice(0,32)}function to(){try{return pn.hostname()}catch{return"unknown-machine"}}function eo(t){let e=`${t}/${Yi}`;if(!Ki(e))return null;try{let n=Xi(e,"utf8");return JSON.parse(n)}catch(n){return c("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function no(t){let e={};try{e.email=dn("git config user.email",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{e.name=dn("git config user.name",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return e}function ro(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function so(t){if(b)return b;let e=t||g(),n=to(),r=eo(e);if(r?.user_id)return b={user_id:r.user_id,display_name:r.display_name||r.user_id,team_id:r.team_id,machine_id:n,source:"config",anonymous_id:bt(r.user_id),email:r.user_id.includes("@")?r.user_id:void 0},c("user-identity",`Resolved from config: ${b.anonymous_id}`,"debug"),b;let s=no(e);if(s.email)return b={user_id:s.email,display_name:s.name||s.email.split("@")[0],team_id:r?.team_id,machine_id:n,source:"git",anonymous_id:bt(s.email),email:s.email},c("user-identity",`Resolved from git: ${b.anonymous_id}`,"debug"),b;let i=ro();if(i.username){let a=`${i.username}@${n}`;return b={user_id:a,display_name:i.username,team_id:r?.team_id,machine_id:n,source:"env",anonymous_id:bt(a)},c("user-identity",`Resolved from env: ${b.anonymous_id}`,"debug"),b}let o=bt(n+process.pid);return b={user_id:`anon-${o.slice(0,8)}`,display_name:"Anonymous",team_id:r?.team_id,machine_id:n,source:"anonymous",anonymous_id:o},c("user-identity",`Resolved as anonymous: ${b.anonymous_id}`,"debug"),b}function mn(){let t=so();return{session_id:S(),user_id:t.user_id,anonymous_id:t.anonymous_id,team_id:t.team_id,machine_id:t.machine_id,identity_source:t.source,timestamp:new Date().toISOString()}}var co=/^[a-zA-Z0-9_-]{1,128}$/;function uo(t){return co.test(t)}function re(t,e){let n=t||S(),r=e||g();if(!uo(n))throw new Error("Invalid session ID format");return`${r}/.claude/memory/sessions/${n}`}function lo(t,e){return`${re(t,e)}/events.jsonl`}function kn(t,e){let n=re(t,e);hn(n)||io(n,{recursive:!0})}var G=0,fn=!1,ee=!1,yn=0,go=5e3;function Sn(t,e){return`${re(t,e)}/counter.json`}function po(t,e){if(!fn){fn=!0;try{let n=Sn(t,e);if(hn(n)){let r=JSON.parse(oo(n,"utf8"));typeof r.counter=="number"&&r.counter>0&&(G=r.counter,c("session-tracker",`Loaded event counter: ${G}`,"debug"))}}catch{}}}function mo(t,e){if(!ee)return;let n=Date.now();if(!(n-yn<go))try{kn(t,e);let r=Sn(t,e);ao(r,JSON.stringify({counter:G,updated_at:new Date().toISOString()})),ee=!1,yn=n}catch{}}function fo(){return po(),G++,ee=!0,mo(),`evt-${Date.now()}-${G}`}function bn(t,e,n={}){try{let r={event_id:fo(),event_type:t,identity:mn(),payload:{name:e,input:ne(n.input),output:ne(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?_n(n.context,500):void 0,confidence:n.confidence}};kn();let s=lo();h(s,`${JSON.stringify(r)}
`),c("session-tracker",`Tracked ${t}: ${e}`,"debug")}catch(r){c("session-tracker",`Failed to track event: ${r}`,"warn")}}function _n(t,e){return t.length<=e?t:`${t.slice(0,e-3)}...`}function ne(t){if(!t)return;let e={},n=["password","secret","token","key","credential","auth"];for(let[r,s]of Object.entries(t)){if(n.some(i=>r.toLowerCase().includes(i))){e[r]="[REDACTED]";continue}if(typeof s=="string"&&s.length>500){e[r]=_n(s,500);continue}if(typeof s=="object"&&s!==null&&!Array.isArray(s)){e[r]=ne(s);continue}e[r]=s}return e}import{mkdirSync as yo,statSync as ho,renameSync as ko}from"node:fs";import{createHash as So}from"node:crypto";function bo(){return wt($t(),".claude","analytics")}function xn(t){return So("sha256").update(t).digest("hex").slice(0,12)}function vn(){let t=process.env.CLAUDE_CODE_TEAM_NAME;return t?{team:t}:void 0}function _o(t,e=10485760){try{if(ho(t).size>e){let r=new Date().toISOString().slice(0,7),s=t.replace(/\.jsonl$/,`.${r}.jsonl`);ko(t,s)}}catch{}}function xo(){return!!(process.env.VITEST||process.env.JEST_WORKER_ID)}function $n(t,e){if(!xo())try{let n=bo();yo(n,{recursive:!0});let r=wt(n,t);_o(r),h(r,`${JSON.stringify(e)}
`)}catch{}}var In=[{name:"context-publisher",fn:gt},{name:"handoff-preparer",fn:pt},{name:"feedback-loop",fn:dt},{name:"agent-memory-store",fn:ct}];function vo(t){try{let e=t.tool_input?.subagent_type||t.subagent_type||t.agent_type||"unknown",n=t.tool_input?.name||void 0,r=!t.error,s=t.duration_ms,i=t.agent_output||t.output||"",o=typeof i=="string"?i.length:0;bn("agent_spawned",e,{success:r,duration_ms:s,output:{has_output:o>0,output_length:o,has_error:!!t.error},context:t.agent_id});let a=t.tool_input?.model||process.env.CLAUDE_MODEL||"unknown";$n("agent-usage.jsonl",{ts:new Date().toISOString(),pid:xn(process.env.CLAUDE_PROJECT_DIR||""),agent:e,agent_name:n??null,model:a,duration_ms:s,success:r,output_len:o,last_msg_len:t.last_assistant_message?.length??null,...vn()})}catch{}}async function wn(t){vo(t);let n=(await Promise.allSettled(In.map(async r=>{try{let s=r.fn(t);return s instanceof Promise&&await s,{hook:r.name,status:"success"}}catch(s){let i=s instanceof Error?s.message:String(s);return c("subagent-stop-dispatcher",`${r.name} failed: ${i}`),{hook:r.name,status:"error",message:i}}}))).filter(r=>r.status==="rejected"||r.status==="fulfilled"&&r.value.status==="error");return n.length>0&&c("subagent-stop-dispatcher",`${n.length}/${In.length} hooks had errors`),d()}var N="sync-subagent-stop-dispatcher",$o=[{name:"output-validator",fn:ft},{name:"auto-spawn-quality",fn:ut},{name:"multi-claude-verifier",fn:mt},{name:"subagent-quality-gate",fn:ht},{name:"task-completer",fn:kt},{name:"retry-handler",fn:St}];function Tn(t){let e=[];for(let r of $o)try{let s=r.fn(t);if(s.continue===!1)return c(N,`${r.name}: blocked (continue: false) \u2014 short-circuiting`),s;s.systemMessage&&(e.push(s.systemMessage),c(N,`${r.name}: systemMessage collected`));let i=K(s);i&&!s.systemMessage&&(e.push(i),c(N,`${r.name}: additionalContext collected`))}catch(s){let i=s instanceof Error?s.message:String(s);c(N,`${r.name} failed: ${i}`,"warn")}if(e.length===0)return c(N,"All sync hooks silent"),d();let n=e.join(`
`);return c(N,`Merged ${e.length} messages from sync hooks`),{continue:!0,systemMessage:n}}var An={"subagent-start/graph-memory-inject":Q,"subagent-start/context-gate":Z,"subagent-start/subagent-context-stager":et,"subagent-start/subagent-validator":nt,"subagent-start/task-linker":st,"subagent-start/model-cost-advisor":ot,"subagent-start/issue-context-injector":at,"subagent-start/unified-dispatcher":Ke,"subagent-stop/agent-memory-store":ct,"subagent-stop/auto-spawn-quality":ut,"subagent-stop/context-publisher":gt,"subagent-stop/feedback-loop":dt,"subagent-stop/handoff-preparer":pt,"subagent-stop/multi-claude-verifier":mt,"subagent-stop/output-validator":ft,"subagent-stop/subagent-quality-gate":ht,"subagent-stop/task-completer":kt,"subagent-stop/retry-handler":St,"subagent-stop/unified-dispatcher":wn,"subagent-stop/sync-subagent-stop-dispatcher":Tn};function Hl(t){return An[t]}function jl(){return Object.keys(An)}export{ma as DEFAULT_CONFIG,pa as THRESHOLDS,$a as addToPromptHistory,Oa as analyzeAttemptHistory,La as applyDecay,wa as cacheClassification,kr as calculateBackoffDelay,Da as cleanupOldStates,Ca as clearSessionState,we as completeAttempt,Ie as createAttempt,ga as escapeRegex,X as estimateTokenCount,K as extractContext,pe as fnv1aHash,Te as formatRetryDecision,Sa as getActiveAgent,Ua as getAdjustments,Ba as getAgentSuccessRate,Pt as getAlternativeAgent,ye as getCachedBranch,qa as getCalibrationStats,Ko as getEnvFile,ca as getField,Hl as getHook,va as getInjectedSkills,Ta as getLastClassification,fe as getLogDir,ir as getLogLevel,V as getPluginRoot,g as getProjectDir,Ia as getPromptHistory,S as getSessionId,Ga as hasMinimalCalibrationData,Ar as hashPrompt,An as hooks,ba as isAgentDispatched,wo as isBashInput,Ao as isEditInput,Co as isReadInput,Sr as isRetryableError,xa as isSkillInjected,To as isWriteInput,Ct as lineContainsAll,ua as lineContainsAllCI,jl as listHooks,U as loadCalibrationData,Ot as loadConfig,$ as loadState,c as logHook,sa as logPermissionFeedback,$e as makeRetryDecision,la as normalizeCommand,Xo as normalizeLineEndings,ta as outputAllowWithContext,Yo as outputBlock,At as outputDeny,ea as outputError,ar as outputPromptContext,ia as outputPromptContextBudgeted,Qo as outputSilentAllow,d as outputSilentSuccess,na as outputStderrWarning,C as outputWarning,A as outputWithContext,Zo as outputWithNotification,ra as outputWithUpdatedInput,Pa as prepareForRetry,aa as readHookInput,Fa as recordOutcome,Et as removeAgent,Tr as saveCalibrationData,Aa as saveConfig,gr as saveState,or as shouldLog,br as suggestsAlternative,ka as trackDispatchedAgent,_a as trackInjectedSkill,E as updateAgentStatus,H as updateState,oa as writeRulesFile};
//# sourceMappingURL=subagent.mjs.map
