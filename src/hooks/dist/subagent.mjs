// OrchestKit Hooks - subagent bundle
// Generated: 2026-02-28T11:13:32.651Z

var bt=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,n)=>(typeof require<"u"?require:e)[n]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});function xo(t){return typeof t.command=="string"}function vo(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function $o(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function Io(t){return typeof t.file_path=="string"&&t.content===void 0}import{existsSync as de,statSync as Xn,renameSync as Qn,mkdirSync as Yn,readSync as Zn}from"node:fs";import{appendFileSync as An,mkdirSync as Dn}from"node:fs";import{dirname as Cn}from"node:path";var z=[],_t=!1,se=!1;function h(t,e){z.push({filePath:t,content:e}),Rn()}function xt(){if(_t||z.length===0)return;_t=!0;let t=new Map;for(let e of z){let n=t.get(e.filePath);n?n.push(e.content):t.set(e.filePath,[e.content])}for(let[e,n]of t)try{Dn(Cn(e),{recursive:!0}),An(e,n.join(""))}catch{}z.length=0,_t=!1}function Rn(){se||(se=!0,process.on("exit",xt),process.on("SIGTERM",()=>{xt(),process.exit(0)}),process.on("SIGINT",()=>{xt(),process.exit(0)}))}import{execSync as tr}from"node:child_process";import ie from"node:os";import L from"node:path";function vt(){return process.env.HOME||process.env.USERPROFILE||ie.homedir()}function En(){return ie.tmpdir()}function $t(){return process.env.CLAUDE_PROJECT_DIR||"."}function oe(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function ae(){return process.env.CLAUDE_PLUGIN_ROOT?L.join(vt(),".claude","logs","ork"):L.join($t(),".claude","logs")}function ce(){return process.env.CLAUDE_METRICS_FILE||L.join(En(),"claude-session-metrics.json")}var It=L.join,Eo=L.sep;import{execSync as On}from"node:child_process";import{createHash as Pn}from"node:crypto";import{existsSync as ue,readFileSync as Hn,writeFileSync as jn,mkdirSync as Nn}from"node:fs";import{join as wt,basename as Mn}from"node:path";var Ln=20,Fn=15,Un=/[^a-z0-9-]/g;function Bn(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=Mn(e);return le(n,Ln)}function qn(t){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=On("git branch --show-current",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),r=le(n||"detached",Fn);return process.env.ORCHESTKIT_SESSION_BRANCH=r,r}catch{return"nobranch"}}function Gn(t){let e=t||new Date,n=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${n}${r}`}function Jn(t){let e=t||new Date,n=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0");return`${n}${r}`}function zn(){let t=`${process.pid}-${Date.now()}-${Math.random()}`;return Pn("sha256").update(t).digest("hex").slice(0,4)}function le(t,e){return t.toLowerCase().replace(Un,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,e)}function Wn(t,e){let n=Bn(t),r=qn(t),s=Gn(e),i=Jn(e),o=zn();return`${n}-${r}-${s}-${i}-${o}`}function Vn(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=wt(e,".instance","session-id.json");if(ue(n))try{let r=JSON.parse(Hn(n,"utf8"));if(r.session_id&&r.created_at){let s=Date.now()-new Date(r.created_at).getTime(),i=1440*60*1e3;if(s<i)return r.session_id}}catch{}}function Kn(t,e){let n=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),r=wt(n,".instance"),s=wt(r,"session-id.json");try{ue(r)||Nn(r,{recursive:!0}),jn(s,JSON.stringify({session_id:t,created_at:new Date().toISOString()},null,2))}catch{}}function ge(t){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let e=Vn(t);if(e)return e;let n=Wn(t);return Kn(n,t),n}function pe(){return ae()}function g(){return $t()}function W(){return oe()}function Go(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${W()}/.claude/.instance_env`}function S(){return ge()}function me(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let e=tr("git branch --show-current",{cwd:t||g(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function er(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Jo(t){return t.replace(/\r\n/g,`
`)}function nr(t){let e=["debug","info","warn","error"];return e.indexOf(t)>=e.indexOf(er())}function d(){return{continue:!0,suppressOutput:!0}}function zo(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function Wo(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function A(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function rr(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function Vo(t,e){let n={continue:!0,suppressOutput:!0};return t&&(n.systemMessage=t),e&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:e}),n}function Ko(t,e){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?n.systemMessage=e:n.suppressOutput=!0,n}function Xo(t){return{continue:!0,systemMessage:t}}function D(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function Qo(t){process.stderr.write(`\u26A0 ${t}
`),process.exit(2)}function Tt(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}function Yo(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:t}}}var sr=200*1024,ir=100*1024;function fe(t,e){if(de(t))try{if(Xn(t).size>e){let r=`${t}.old.${Date.now()}`;Qn(t,r)}}catch{}}function ye(t){de(t)||Yn(t,{recursive:!0})}function c(t,e,n="debug"){if(!nr(n))return;let r=pe(),s=`${r}/hooks.log`;try{ye(r),fe(s,sr);let i=new Date().toISOString().replace("T"," ").slice(0,19);h(s,`[${i}] [${n.toUpperCase()}] [${t}] ${e}
`)}catch{}}function Zo(t,e,n){let r=pe(),s=`${r}/permission-feedback.log`;try{ye(r),fe(s,ir);let i=new Date().toISOString(),o=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",a=n?.session_id||S();h(s,`${i} | ${t} | ${e} | tool=${o} | session=${a}
`)}catch{}}function V(t){return t.hookSpecificOutput?.additionalContext?t.hookSpecificOutput.additionalContext:t.systemMessage&&typeof t.systemMessage=="string"?t.systemMessage:null}function K(t){if(!t)return 0;let r=(t.match(/[{};()=><]/g)||[]).length/t.length>.03?2.8:3.5;return Math.ceil(t.length/r)}function ta(t,e,n,r,s){let i=K(t);return r?.isOverBudget(n)?(c(e,`Budget exhausted for ${n}, suppressing ${i}t`),d()):(s&&s.trackTokenUsage(e,n,i),rr(t))}function ea(){try{let t=[],n=Buffer.allocUnsafe(256),r,s=0;for(;;)try{if(r=Zn(s,n,0,256,null),r===0)break;t.push(Buffer.from(n.subarray(0,r)))}catch{break}let i=Buffer.concat(t).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:S(),tool_input:{}}}catch{return{tool_name:"",session_id:S(),tool_input:{}}}}function na(t,e){let n=e.replace(/^\./,"").split("."),r=t;for(let s of n){if(r==null)return;r=r[s]}return r}function At(t,...e){return t.split(`
`).some(n=>e.every(r=>n.includes(r)))}function ra(t,...e){return t.split(`
`).some(n=>{let r=n.toLowerCase();return e.every(s=>r.includes(s.toLowerCase()))})}function sa(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function ia(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var aa={AUTO_DISPATCH:85,SKILL_INJECT:80,STRONG_RECOMMEND:70,SUGGEST:50,MINIMUM:40},ca={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:1200,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};import{existsSync as F,readFileSync as ke,writeFileSync as Se,mkdirSync as or}from"node:fs";function Dt(){return`${g()}/.claude/orchestration`}function Ct(){let t=S();return`${Dt()}/session-${t}.json`}function be(){return`${g()}/.claude/orchestration/config.json`}function _e(){let t=Dt();if(!F(t))try{or(t,{recursive:!0})}catch{c("orchestration-state",`Failed to create state dir: ${t}`)}}function $(){let t=Ct();if(F(t))try{let e=ke(t,"utf8");return JSON.parse(e)}catch(e){c("orchestration-state",`Failed to load state: ${e}`)}return{sessionId:S(),activeAgents:[],injectedSkills:[],promptHistory:[],maxHistorySize:10,updatedAt:new Date().toISOString()}}function ar(t){_e();let e=Ct();t.updatedAt=new Date().toISOString();try{Se(e,JSON.stringify(t,null,2))}catch(n){c("orchestration-state",`Failed to save state: ${n}`)}}function H(t){let e=$();return t(e),ar(e),e}function da(t,e,n){let r={agent:t,taskId:n,confidence:e,dispatchedAt:new Date().toISOString(),status:"pending",retryCount:0,maxRetries:3};return H(s=>{s.activeAgents=s.activeAgents.filter(i=>i.agent!==t),s.activeAgents.push(r)}),c("orchestration-state",`Tracked dispatched agent: ${t} (conf: ${e})`),r}function E(t,e,n){H(r=>{let s=r.activeAgents.find(i=>i.agent===t);s&&(s.status=e,n&&(s.taskId=n),e==="retrying"&&s.retryCount++)}),c("orchestration-state",`Updated agent status: ${t} -> ${e}`)}function Rt(t){H(e=>{e.activeAgents=e.activeAgents.filter(n=>n.agent!==t)})}function pa(){return $().activeAgents.find(e=>e.status==="in_progress")}function ma(t){return $().activeAgents.some(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function fa(t){H(e=>{e.injectedSkills.includes(t)||e.injectedSkills.push(t)})}function ya(t){return $().injectedSkills.includes(t)}function ha(){return $().injectedSkills}function ka(t){H(e=>{e.promptHistory.push(t),e.promptHistory.length>e.maxHistorySize&&(e.promptHistory=e.promptHistory.slice(-e.maxHistorySize))})}function Sa(){return $().promptHistory}function ba(t){H(e=>{e.lastClassification=t})}function _a(){return $().lastClassification}var he={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:1200,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function Et(){let t=be();if(F(t))try{let e=ke(t,"utf8");return{...he,...JSON.parse(e)}}catch{}return he}function xa(t){_e();let e=be(),r={...Et(),...t};try{Se(e,JSON.stringify(r,null,2))}catch(s){c("orchestration-state",`Failed to save config: ${s}`)}}function va(){let t=Ct();try{if(F(t)){let{unlinkSync:e}=bt("node:fs");e(t),c("orchestration-state","Cleared session state")}}catch{}}function $a(){let t=Dt();if(F(t))try{let{readdirSync:e,statSync:n,unlinkSync:r}=bt("node:fs"),s=e(t).filter(i=>i.startsWith("session-")&&i.endsWith(".json")).map(i=>({name:i,path:`${t}/${i}`,mtime:n(`${t}/${i}`).mtime.getTime()})).sort((i,o)=>o.mtime-i.mtime);for(let i of s.slice(5))try{r(i.path),c("orchestration-state",`Cleaned up old state: ${i.name}`)}catch{}}catch{}}var cr=3,ur=1e3,lr=3e4,gr={"backend-system-architect":["database-engineer","api-designer"],"frontend-ui-developer":["rapid-ui-designer","accessibility-specialist"],"test-generator":["debug-investigator","code-quality-reviewer"],"security-auditor":["security-layer-auditor"],"workflow-architect":["llm-integrator","data-pipeline-engineer"]},dr=[{test:t=>/permission denied/i.test(t)},{test:t=>/access denied/i.test(t)},{test:t=>/not found/i.test(t)&&/file|module|package/i.test(t)},{test:t=>/(?:file|module|package)\s+not\s+found/i.test(t)},{test:t=>/missing required/i.test(t)},{test:t=>/invalid (?:api|token|key)/i.test(t)},{test:t=>/authentication failed/i.test(t)},{test:t=>/quota exceeded/i.test(t)},{test:t=>/rate limit/i.test(t)}],pr=[/not my specialization/i,/outside my scope/i,/better suited for/i,/consider using/i,/specialized agent/i];function mr(t,e=ur){let n=e*2**(t-1),r=Math.random()*.1*n;return Math.min(n+r,lr)}function fr(t){for(let e of dr)if(e.test(t))return!1;return!0}function yr(t){for(let e of pr)if(e.test(t))return!0;return!1}function Ot(t,e=[]){let n=gr[t];if(n){for(let r of n)if(!e.includes(r))return r}}function xe(t,e,n,r=[],s=cr){if(c("retry-manager",`Evaluating retry for ${t}, attempt ${e}`),e>=s){let o=Ot(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Max retries (${s}) exceeded`+(o?`. Consider trying ${o} instead.`:"")}}if(!fr(n)){let o=Ot(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Non-retryable error detected: ${n.slice(0,100)}`}}if(yr(n)){let o=Ot(t,r);if(o)return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Error suggests using alternative agent: ${o}`}}let i=mr(e);return{shouldRetry:!0,retryCount:e,maxRetries:s,delayMs:i,reason:`Retrying (attempt ${e+1}/${s}) after ${Math.round(i/1e3)}s`}}function ve(t,e,n){return{agent:t,taskId:n,attemptNumber:e,startedAt:new Date().toISOString()}}function $e(t,e,n){let r=new Date().toISOString(),s=new Date(r).getTime()-new Date(t.startedAt).getTime();return{...t,completedAt:r,outcome:e,error:n,durationMs:s}}function Ta(t){if(t.length===0)return{successRate:0,avgDuration:0,commonErrors:[]};let n=t.filter(a=>a.outcome==="success").length/t.length,r=t.filter(a=>a.durationMs!==void 0).map(a=>a.durationMs),s=r.length>0?r.reduce((a,u)=>a+u,0)/r.length:0,i=new Map;for(let a of t)if(a.error){let u=a.error.slice(0,50).toLowerCase();i.set(u,(i.get(u)||0)+1)}let o=Array.from(i.entries()).sort((a,u)=>u[1]-a[1]).slice(0,3).map(([a])=>a);return{successRate:n,avgDuration:s,commonErrors:o}}function Aa(t,e){return{...t,status:"retrying",retryCount:e.retryCount}}function Ie(t,e){if(t.shouldRetry)return`## Retry Scheduled

Agent \`${e}\` will retry after ${Math.round((t.delayMs||0)/1e3)} seconds.

**Attempt:** ${t.retryCount+1} of ${t.maxRetries}
**Reason:** ${t.reason}`;let n=`## Retry Not Recommended

Agent \`${e}\` has ${t.retryCount>=t.maxRetries?"exhausted retries":"encountered a non-retryable error"}.

**Reason:** ${t.reason}`;return t.alternativeAgent&&(n+=`

### Alternative Suggestion

Consider using \`${t.alternativeAgent}\` instead:

\`\`\`
Task tool with subagent_type: "${t.alternativeAgent}"
\`\`\``),n}import{existsSync as De,readFileSync as hr,writeFileSync as kr,mkdirSync as Sr}from"node:fs";import{createHash as br}from"node:crypto";var we=500,Pt=3,Te=15,Ae=3,_r=.9;function Ce(){return`${g()}/.claude/feedback/calibration-data.json`}function xr(){let t=`${g()}/.claude/feedback`;if(!De(t))try{Sr(t,{recursive:!0})}catch{}}function U(){let t=Ce();if(De(t))try{return JSON.parse(hr(t,"utf8"))}catch{c("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function vr(t){xr();let e=Ce();t.updatedAt=new Date().toISOString();try{kr(e,JSON.stringify(t,null,2)),c("calibration-engine","Saved calibration data")}catch(n){c("calibration-engine",`Failed to save calibration data: ${n}`)}}function $r(t){return br("sha256").update(t.toLowerCase().trim()).digest("hex").slice(0,16)}function Oa(t,e,n,r,s,i,o){let a=U(),u={timestamp:new Date().toISOString(),sessionId:S(),agent:e,promptHash:$r(t),matchedKeywords:n,dispatchConfidence:r,outcome:s,durationMs:i,feedback:o};a.records.push(u),a.records.length>we&&(a.records=a.records.slice(-we)),Ir(a,u),wr(a),vr(a),c("calibration-engine",`Recorded outcome: ${e} -> ${s} (conf: ${r})`)}function Ir(t,e){let n=e.outcome==="success",r=e.outcome==="failure"||e.outcome==="rejected";if(!n&&!r)return;let s=n?Ae:-Ae;for(let i of e.matchedKeywords){let o=t.adjustments.find(a=>a.keyword===i&&a.agent===e.agent);o?(o.adjustment=Math.max(-Te,Math.min(Te,o.adjustment+s)),o.sampleCount++,o.lastUpdated=new Date().toISOString()):t.adjustments.push({keyword:i,agent:e.agent,adjustment:s,sampleCount:1,lastUpdated:new Date().toISOString()})}}function Pa(t){let e=Date.now(),n=1440*60*1e3;for(let r of t.adjustments){let s=e-new Date(r.lastUpdated).getTime();Math.floor(s/n)>7&&(r.adjustment=Math.round(r.adjustment*_r),Math.abs(r.adjustment)<1&&(r.adjustment=0))}t.adjustments=t.adjustments.filter(r=>r.adjustment!==0)}function wr(t){let e=t.records;if(e.length===0)return;t.stats.totalDispatches=e.length;let n=e.filter(i=>i.outcome==="success").length;t.stats.successRate=n/e.length;let r=e.reduce((i,o)=>i+o.dispatchConfidence,0)/e.length;t.stats.avgConfidence=Math.round(r);let s=new Map;for(let i of e){let o=s.get(i.agent)||{count:0,success:0};o.count++,i.outcome==="success"&&o.success++,s.set(i.agent,o)}t.stats.topAgents=Array.from(s.entries()).map(([i,o])=>({agent:i,count:o.count,successRate:o.success/o.count})).sort((i,o)=>o.count-i.count).slice(0,10)}function Ha(){return U().adjustments.filter(e=>e.sampleCount>=Pt)}function ja(t){let n=U().records.filter(s=>s.agent===t);return n.length<Pt?null:n.filter(s=>s.outcome==="success").length/n.length}function Na(){return U().stats}function Ma(){return U().records.length>=Pt}import{existsSync as Tr,statSync as Ar}from"node:fs";import{resolve as Dr}from"node:path";var Cr={"database-engineer":"database schema SQL PostgreSQL migration pgvector","backend-system-architect":"API REST architecture backend FastAPI microservice","frontend-ui-developer":"React frontend UI component TypeScript Tailwind","security-auditor":"security OWASP vulnerability audit authentication","test-generator":"testing unit integration coverage pytest MSW","workflow-architect":"LangGraph workflow agent orchestration state","llm-integrator":"LLM API OpenAI Anthropic embeddings RAG function-calling","data-pipeline-engineer":"data pipeline embeddings vector ETL chunking","metrics-architect":"metrics OKR KPI analytics instrumentation","ux-researcher":"UX user research persona journey accessibility","code-quality-reviewer":"code quality review linting type-check patterns","infrastructure-architect":"infrastructure cloud Docker Kubernetes deployment","ci-cd-engineer":"CI CD pipeline GitHub Actions deployment automation","accessibility-specialist":"accessibility WCAG ARIA screen-reader a11y","product-strategist":"product strategy roadmap features prioritization"};function Rr(t){return Cr[t]||t}var Re=100;function X(t){c("graph-memory-inject","Graph memory inject hook starting");let e=Dr(g(),".claude/memory/knowledge-graph.jsonl");if(!Tr(e))return c("graph-memory-inject","No graph data file, skipping"),d();try{let u=Ar(e).size;if(u<Re)return c("graph-memory-inject",`Graph too small (${u}B < ${Re}B), skipping`),d()}catch{return c("graph-memory-inject","Could not stat graph file, skipping"),d()}let r=(t.tool_input||{}).subagent_type||"";if(!r)return c("graph-memory-inject","No agent type detected, passing through"),d();let s=`ork:${r}`,i=Rr(r);c("graph-memory-inject",`Detected agent type: ${r} (agent_id: ${s})`);let o=`[Graph Memory - Agent Context Load]

Execute this MCP call to load graph context for ${r} agent:

## Graph Memory Entities
\`\`\`
mcp__memory__search_nodes
{"query": "${r} ${i}"}
\`\`\`

## Integration Instructions
1. Execute the graph search to retrieve relevant entities and relationships
2. Review entities for patterns, decisions, and constraints
3. Check relationships between concepts
4. Apply learned patterns to current task

Agent ID: ${s} | Domain: ${i}`,a=`[Graph Memory] Agent: ${r} | ID: ${s} | Load graph context via MCP call above`;return c("graph-memory-inject",`Outputting graph memory instructions for ${r}`),{continue:!0,systemMessage:a,hookSpecificOutput:{additionalContext:o}}}import{existsSync as B,readFileSync as Q,writeFileSync as Ht,mkdirSync as Er}from"node:fs";import{dirname as Or}from"node:path";var Pr=6,Hr=8,jr=5,Nr=/^(test-generator|backend-system-architect|workflow-architect|security-auditor|llm-integrator)$/;function Mr(){let t=process.cwd();return t.includes(".claude/worktrees/")||t.includes("/.git/worktrees/")}function Lr(){return Mr()?{maxBackground:10,maxPerResponse:12}:{maxBackground:Pr,maxPerResponse:Hr}}function jt(){return`${g()}/.claude/logs/agent-state.json`}function Oe(){return`${g()}/.claude/logs/subagent-spawns.jsonl`}function Fr(){let t=jt(),e=Or(t);try{Er(e,{recursive:!0})}catch{}if(!B(t)){let n={active_background:[],session_total:0,last_cleanup:null,blocked_count:0};try{Ht(t,JSON.stringify(n,null,2))}catch{}}}function Ur(){let t=Oe();if(!B(t))return 0;try{let r=Q(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),s=new Date(Date.now()-300*1e3).toISOString(),i=0;for(let o of r)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>s&&i++}catch{}return i}catch{return 0}}function Br(){let t=Oe();if(!B(t))return 0;try{let r=Q(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),s=new Date(Date.now()-2*1e3).toISOString(),i=0;for(let o of r)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>s&&i++}catch{}return i}catch{return 0}}function qr(){let t=jt();try{if(B(t)){let e=JSON.parse(Q(t,"utf8"));e.blocked_count=(e.blocked_count||0)+1,Ht(t,JSON.stringify(e,null,2))}}catch{}}function Ee(){let t=jt();try{if(B(t)){let e=JSON.parse(Q(t,"utf8"));e.session_total=(e.session_total||0)+1,Ht(t,JSON.stringify(e,null,2))}}catch{}}function Y(t){Fr();let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"",s=e.run_in_background===!0||e.run_in_background==="true";c("context-gate",`Context gate check: ${n} (background=${s})`);let i=Ur(),o=Br();c("context-gate",`Active background: ${i}, Current response: ${o}`);let a=Lr();return o>=a.maxPerResponse?(c("context-gate",`BLOCKED: Too many agents in single response (${o} >= ${a.maxPerResponse})`),Tt(`Context Overflow Protection

Too many agents spawned in a single response (${o} agents).

Maximum allowed: ${a.maxPerResponse} per response

SOLUTION: Split into multiple responses or use sequential execution.
Consider using the /context-optimization skill first.

Attempted: ${n} - ${r}`)):s&&i>=a.maxBackground?(c("context-gate",`BLOCKED: Too many concurrent background agents (${i} >= ${a.maxBackground})`),qr(),Tt(`Background Agent Limit

Too many background agents running concurrently (${i} active).

Maximum allowed: ${a.maxBackground} concurrent background agents

SOLUTION:
1. Wait for existing agents to complete
2. Run this agent in foreground (remove run_in_background)
3. Use /context-optimization to free up context

Attempted: ${n} - ${r}`)):i>=jr?(c("context-gate","WARNING: Approaching context budget limit"),Ee(),D(`Context Budget Warning

${i} background agents active (limit: ${a.maxBackground}).

Consider:
- Running remaining agents sequentially
- Using /context-optimization skill
- Waiting for current agents to complete

Proceeding with: ${n} - ${r}`)):Nr.test(n)&&i>=2?(c("context-gate",`WARNING: Expensive agent type with multiple active: ${n}`),D(`Spawning expensive agent (${n}) with ${i} others active`)):(Ee(),c("context-gate",`Context gate passed: ${n}`),d())}import{existsSync as Z,readFileSync as Nt,readdirSync as Gr}from"node:fs";import{homedir as Jr}from"node:os";import{join as Pe}from"node:path";function zr(){return`${g()}/.claude/context/session/state.json`}function Wr(){return`${g()}/.claude/context/knowledge/decisions/active.json`}function Vr(){return`${g()}/docs/issues`}function Kr(){let t=zr();if(!Z(t))return{count:0,summary:""};try{let n=JSON.parse(Nt(t,"utf8")).tasks_pending||[],r=n.length;if(r===0)return{count:0,summary:""};let s=n.slice(0,5).map(i=>`- ${i}`).join(`
`);return{count:r,summary:s}}catch{return{count:0,summary:""}}}function He(t,e){let n=Wr();if(!Z(n))return"";try{return(JSON.parse(Nt(n,"utf8")).decisions||[]).filter(o=>o.category===e||o.category==="api"||o.category==="database").slice(0,8).map(o=>`- ${o.title} (${o.status||"unknown"})`).join(`
`)}catch{return""}}function Xr(t){let e=Vr();if(!Z(e))return"";try{let r=Gr(e).find(s=>s.includes(t));if(r)return`docs/issues/${r}`}catch{}return""}function Qr(){let t=[],e=Pe(Jr(),".claude","CLAUDE.md"),n=je(e);if(n){let o=Ne(n,"global");t.push(...o)}let r=Pe(g(),"CLAUDE.md"),s=je(r);if(s){let o=Ne(s,"project");t.push(...o)}return t.length===0?"":`CRITICAL RULES (inherited from CLAUDE.md):
${[...new Set(t)].slice(0,12).map(o=>`- ${o}`).join(`
`)}

`}function je(t){try{return Z(t)?Nt(t,"utf8"):""}catch{return""}}function Ne(t,e){let n=[],r=t.split(`
`);for(let s of r){let i=s.trim();if(!(!i||i.startsWith("#")||i.startsWith("```"))){if(/^[-*]\s+/.test(i)){let o=i.replace(/^[-*]\s+/,"").trim();if(/\b(always|never|must|don't|do not|required|NEVER|MUST|DON'T)\b/i.test(o)){let a=o.length>80?`${o.substring(0,77)}...`:o;n.push(a)}}if(/^\*\*(DO|DON'T|DO NOT)\*\*:/.test(i)){let o=i.replace(/\*\*/g,"").trim();o.length<=80&&n.push(o)}}}return n}function tt(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.task_description||e.description||"";c("subagent-context-stager",`Staging context for ${n}`);let s="",i=Qr();i&&(s+=i,c("subagent-context-stager","Injected critical rules from CLAUDE.md"));let{count:o,summary:a}=Kr();o>0&&(c("subagent-context-stager",`Found ${o} pending tasks`),s+=`ACTIVE TODOS:
${a}

`);let u=r.toLowerCase();if(/backend|api|endpoint|database|migration/.test(u)){c("subagent-context-stager","Backend task detected - staging backend decisions");let l=He(r,"backend");l&&(s+=`RELEVANT DECISIONS:
${l}

`)}if(/frontend|react|ui|component/.test(u)){c("subagent-context-stager","Frontend task detected - staging frontend decisions");let l=He(r,"frontend");l&&(s+=`RELEVANT DECISIONS:
${l}

`)}if(/test|testing|pytest|jest/.test(u)&&(c("subagent-context-stager","Testing task detected - staging test context"),s+=`TESTING REMINDERS:
- Use 'tee' for visible test output
- Check test patterns in backend/tests/ or frontend/src/**/__tests__/
- Ensure coverage meets threshold requirements

`),/issue|#\d+|bug|fix/.test(u)){c("subagent-context-stager","Issue-related task detected");let l=r.match(/#(\d+)/);if(l){let p=l[1],m=Xr(p);m&&(s+=`ISSUE DOCS: ${m}

`,c("subagent-context-stager",`Staged issue documentation for #${p}`))}}if(s){let l=`${s}
Task: ${r}
Subagent: ${n}`,p=s.split(`
`).filter(Boolean).length;return c("subagent-context-stager",`Staged context with ${p} lines`),{continue:!0,systemMessage:l}}return c("subagent-context-stager","No context staged for this task"),d()}import{existsSync as q,readFileSync as Mt,mkdirSync as Yr,readdirSync as Zr}from"node:fs";import{join as v,dirname as ts}from"node:path";var es=new Set(["general-purpose","Explore","Plan","claude-code-guide","statusline-setup","Bash"]);function ns(){return v(g(),".claude","logs","subagent-spawns.jsonl")}function rs(){return v(g(),"plugin.json")}function Lt(){return v(g(),"agents")}function Ft(){return v(g(),".claude","agents")}function ss(){return v(g(),"skills")}function is(){let t=new Set(es),e=rs();if(q(e))try{let s=JSON.parse(Mt(e,"utf8")).agents||[];for(let i of s)i.id&&t.add(i.id)}catch{}let n=[Lt(),Ft()];for(let r of n)if(q(r))try{let s=Zr(r);for(let i of s)i.endsWith(".md")&&t.add(i.replace(".md",""))}catch{}return t}function os(t){let e=[],n=[v(Lt(),`${t}.md`),v(Ft(),`${t}.md`)],r=null;for(let s of n)if(q(s)){r=s;break}if(!r)return e;try{let i=Mt(r,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of i){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^skills:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let l=u.match(/^\s*-\s*(.+)$/);if(l){let p=l[1].trim();e.push(p)}}}}}catch{}return e}function as(t){let e=os(t),n=[],r=ss();for(let s of e){let i=v(r,s,"SKILL.md");q(i)||n.push(s)}return n}function cs(t){let e=[],n=[v(Lt(),`${t}.md`),v(Ft(),`${t}.md`)],r=null;for(let s of n)if(q(s)){r=s;break}if(!r)return e;try{let i=Mt(r,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of i){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^tools:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let l=u.match(/^\s*-\s*(.+)$/);l&&e.push(l[1].trim())}}}}catch{}return e}function us(t,e){if(e.length===0)return"";let n=e.every(o=>["Read","Glob","Grep"].includes(o)),r=e.includes("Bash"),s=e.includes("Write")||e.includes("Edit"),i="low";return r&&s?i="elevated":(r||s)&&(i="moderate"),`## Agent Permission Profile (CC 2.1.20)

**Agent**: \`${t}\`
**Tools**: ${e.join(", ")}
**Risk Level**: ${i}${n?" (read-only)":""}

${r?`> This agent requests Bash access. Review commands carefully.
`:""}`}function ls(t,e,n){let r=ns(),s=ts(r);try{Yr(s,{recursive:!0})}catch{}let i={timestamp:new Date().toISOString(),subagent_type:t,description:e,session_id:n};try{h(r,`${JSON.stringify(i)}
`)}catch{}}function et(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"",s=t.session_id;c("subagent-validator",`Task invocation: ${n} - ${r}`),ls(n,r,s);let i=n.replace(/^[^:]+:/,""),o=is();!o.has(n)&&!o.has(i)&&c("subagent-validator",`WARNING: Unknown subagent type: ${n}`),c("subagent-validator",`Spawning ${n} agent: ${r}`);let a=as(i);if(a.length>0){let l=a.join(", ");c("subagent-validator",`WARNING: Agent '${i}' references missing skills: ${l}`),console.error(`Warning: Agent '${i}' references ${a.length} missing skill(s): ${l}`)}let u=cs(i);if(u.length>0){let l=us(i,u);return c("subagent-validator",`Agent '${i}' tools: ${u.join(", ")}`),A(l)}return d()}import{existsSync as Me,readFileSync as gs,writeFileSync as ds,mkdirSync as ps}from"node:fs";function Le(){let t=S();return`${g()}/.claude/orchestration/task-registry-${t}.json`}function ms(){let t=`${g()}/.claude/orchestration`;if(!Me(t))try{ps(t,{recursive:!0})}catch{}}function j(){let t=Le();if(Me(t))try{return JSON.parse(gs(t,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:S(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function Ut(t){ms();let e=Le();t.updatedAt=new Date().toISOString();try{ds(e,JSON.stringify(t,null,2))}catch(n){c("task-integration",`Failed to save registry: ${n}`)}}function Fe(t,e){return`### Delete Orphaned Task

\`\`\`
TaskUpdate:
  taskId: "${t}"
  status: "deleted"
\`\`\`

**Reason**: ${e}`}function nt(t){let e=`### Update Task

\`\`\`
TaskUpdate:
  taskId: "${t.taskId}"`;return t.status&&(e+=`
  status: "${t.status}"`),t.addBlockedBy&&t.addBlockedBy.length>0&&(e+=`
  addBlockedBy: ${JSON.stringify(t.addBlockedBy)}`),t.addBlocks&&t.addBlocks.length>0&&(e+=`
  addBlocks: ${JSON.stringify(t.addBlocks)}`),e+="\n```",e}function I(t,e){let n=j(),r=n.tasks.find(s=>s.taskId===t);r&&(r.status=e,Ut(n),c("task-integration",`Updated task ${t} status to ${e}`))}function C(t){return j().tasks.find(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function Ue(t){return j().tasks.filter(n=>n.status==="pending"&&n.blockedBy&&n.blockedBy.includes(t))}function Bt(t){return j().tasks.filter(n=>n.pipelineId===t).sort((n,r)=>(n.pipelineStep||0)-(r.pipelineStep||0))}function Be(){return j().pipelines.find(e=>e.status==="running")}function qe(t,e){let n=j(),r=n.pipelines.find(i=>i.pipelineId===t);if(!r)return null;r.completedSteps.includes(e)||(r.completedSteps.push(e),r.completedSteps.sort((i,o)=>i-o));let s=Bt(t);for(let i of s){let o=i.pipelineStep;if(o===void 0||r.completedSteps.includes(o)||i.status!=="pending")continue;if(o===0||r.completedSteps.includes(o-1))return r.currentStep=o,Ut(n),o}return r.status="completed",Ut(n),null}function rt(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return c("task-linker","No agent type found, skipping"),d();c("task-linker",`Processing SubagentStart for: ${n}`);let r=C(n);if(!r)return c("task-linker",`No orchestration task found for agent: ${n}`),d();c("task-linker",`Found task ${r.taskId} for agent ${n}`),I(r.taskId,"in_progress"),E(n,"in_progress",r.taskId);let s=nt({taskId:r.taskId,status:"in_progress"}),i=`## Orchestration: Task Linked

Agent \`${n}\` has been linked to task **${r.taskId}**.

${s}

The task status should be updated to \`in_progress\`.`;return c("task-linker",`Linked agent ${n} to task ${r.taskId}`),A(i)}import{mkdirSync as fs,existsSync as qt,readFileSync as Gt}from"node:fs";import{join as st,dirname as ys}from"node:path";var hs=[/security|vulnerab|audit|penetration/i,/architect|design.*system|distributed/i,/migration.*schema|database.*design/i,/performance.*optim|profil|bottleneck/i,/langgraph|workflow.*orchestrat/i],ks=[/\b(?:list|count|check|verify|read|search)\b/i,/\b(?:simple|straightforward|quick)\b/i,/\b(?:format|lint|style|typo|rename)\b/i,/\b(?:status|progress|summary)\b/i],O=new Map,w=new Map;function Jt(t){if(O.has(t))return O.get(t);let e=W();if(!e)return O.set(t,"inherit"),"inherit";let n=st(e,"agents",`${t}.md`);if(!qt(n))return O.set(t,"inherit"),"inherit";try{let s=Gt(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!s)return O.set(t,"inherit"),"inherit";let i=s[1].match(/^model:\s*(.+)$/m),o=i?i[1].trim():"inherit";return O.set(t,o),o}catch{return O.set(t,"inherit"),"inherit"}}function Ss(t){if(w.has(t))return w.get(t);let e=W();if(!e)return w.set(t,null),null;let n=st(e,"agents",`${t}.md`);if(!qt(n))return w.set(t,null),null;try{let s=Gt(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!s)return w.set(t,null),null;let i=s[1].match(/^skills:\s*\n((?:\s+-\s+.+\n)*)/m);if(!i)return w.set(t,null),null;let o=i[1].match(/^\s+-\s+(.+)$/gm)?.map(l=>l.trim().replace(/^-\s+/,""))||[];if(o.length===0)return w.set(t,null),null;let a={low:0,medium:1,high:2},u="low";for(let l of o.slice(0,5)){let p=st(e,"skills",l,"SKILL.md");if(!qt(p))continue;let f=Gt(p,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!f)continue;let _=f[1].match(/^complexity:\s*(low|medium|high)$/m);if(_){let y=_[1];a[y]>a[u]&&(u=y)}}return w.set(t,u),u}catch{return w.set(t,null),null}}function Ge(t,e){let n=Ss(t);if(n==="high")return"high";let r=hs.filter(o=>o.test(e)).length,s=Jt(t);return r>=2||s==="opus"?"high":ks.filter(o=>o.test(e)).length>=2?"low":n||"medium"}function Je(t){let e=Jt(t);return e==="inherit"?process.env.CLAUDE_MODEL||"sonnet":e}function bs(t,e){let n=Ge(t,e),r=Je(t);return n==="high"&&r==="haiku"?{recommended:"sonnet",current:r,reason:"High-complexity task \u2014 haiku may produce lower quality results",savingsPercent:0}:n==="low"&&r==="opus"?{recommended:"sonnet",current:r,reason:"Simple task \u2014 sonnet handles this equally well at lower cost",savingsPercent:40}:n==="medium"&&r==="opus"&&Jt(t)!=="opus"?{recommended:"sonnet",current:r,reason:"Medium-complexity task \u2014 sonnet is sufficient",savingsPercent:30}:null}function _s(t,e,n,r){let s=st(g(),".claude","logs","model-usage.jsonl");try{fs(ys(s),{recursive:!0}),h(s,`${JSON.stringify({timestamp:new Date().toISOString(),agent:t,model:e,complexity:n,recommendation:r?.recommended||null,potentialSavings:r?.savingsPercent||0})}
`)}catch{}}function it(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"";if(!n)return d();let s=Ge(n,r),i=Je(n),o=bs(n,r);return _s(n,i,s,o),o?(c("model-cost-advisor",`${n}: Recommend ${o.recommended} over ${o.current} (${o.reason})`,"info"),o.savingsPercent>=30?D(`Model cost: ${n} using ${o.current} for ${s}-complexity task. ${o.reason}. ~${o.savingsPercent}% savings with "${o.recommended}".`):d()):(c("model-cost-advisor",`${n}: ${i} appropriate for ${s} task`),d())}import{existsSync as xs,readFileSync as vs,writeFileSync as $s,statSync as Is,mkdirSync as ws}from"node:fs";import{execFileSync as Ts}from"node:child_process";import{tmpdir as As}from"node:os";import{join as zt}from"node:path";var Wt=zt(As(),"orchestkit-issue-cache"),Ds=300*1e3,Cs=3e3;function Rs(t){let e=t.match(/^(?:issue|fix|feat|bug|hotfix|feature)\/(\d+)/)||t.match(/^(\d+)-/);return e?e[1]:null}function Es(){try{ws(Wt,{recursive:!0,mode:448})}catch{}}function Os(t){let e=zt(Wt,`${t}.json`);try{if(!xs(e))return null;let n=Is(e);return Date.now()-n.mtimeMs>Ds?null:JSON.parse(vs(e,"utf8"))}catch{return null}}function Ps(t,e){if(!/^\d+$/.test(t))return null;try{let n=Ts("gh",["issue","view",t,"--json","title,body,labels"],{cwd:e,encoding:"utf8",timeout:Cs,stdio:["pipe","pipe","pipe"]}).trim(),r=JSON.parse(n);try{Es();let s=zt(Wt,`${t}.json`);$s(s,JSON.stringify(r),"utf8")}catch{}return r}catch{return null}}function Hs(t,e){let n=[];if(e?.title?n.push(`Working on GitHub Issue #${t}: ${e.title}`):n.push(`Working on GitHub Issue #${t}`),e?.labels&&e.labels.length>0){let r=e.labels.map(s=>s.name).join(", ");n.push(`Labels: ${r}`)}return n.push(`Reference #${t} in all commits. Use 'Closes #${t}' in PR description.`),n.join(`
`)}function ot(t){try{let e=g(),n=me(e);c("issue-context-injector",`Branch: ${n}`);let r=Rs(n);if(!r)return c("issue-context-injector","No issue number in branch name"),d();c("issue-context-injector",`Detected issue #${r}`);let s=Os(r)??Ps(r,e),i=Hs(r,s);return c("issue-context-injector",`Injecting context for issue #${r}`),{continue:!0,systemMessage:i}}catch{return c("issue-context-injector","Unexpected error, falling back to silent success","warn"),d()}}var P="subagent-start-dispatcher",ze=800,js=[{name:"subagent-context-stager",fn:tt},{name:"graph-memory-inject",fn:X},{name:"task-linker",fn:rt},{name:"model-cost-advisor",fn:it},{name:"issue-context-injector",fn:ot}];function We(t){try{let u=Y(t);if(!u.continue)return c(P,"context-gate blocked agent spawn"),u}catch(u){let l=u instanceof Error?u.message:String(u);c(P,`context-gate failed: ${l}`,"warn")}let e=null;try{let u=et(t);e=V(u)}catch(u){let l=u instanceof Error?u.message:String(u);c(P,`subagent-validator failed: ${l}`,"warn")}let n=[],r=[],s=0;if(e){let u=K(e);n.push(e),s+=u}for(let u of js)try{let l=u.fn(t);l.systemMessage&&typeof l.systemMessage=="string"&&r.push(l.systemMessage);let p=l.hookSpecificOutput?.additionalContext;if(p){let m=K(p);if(s+m>ze){c(P,`Budget limit: skipping ${u.name} (${m}t would exceed ${ze}t cap)`);continue}n.push(p),s+=m,c(P,`${u.name}: +${m}t (total: ${s}t)`)}}catch(l){let p=l instanceof Error?l.message:String(l);c(P,`${u.name} failed: ${p}`,"warn")}let i=n.length>0,o=r.length>0;if(!i&&!o)return d();let a={continue:!0};if(o&&(a.systemMessage=r.join(`

`)),i){let u=n.join(`

---

`);c(P,`Consolidated ${n.length} hooks into ${s}t`),a.hookSpecificOutput={additionalContext:u}}return a}import{existsSync as Ns,mkdirSync as Ms,unlinkSync as Ls}from"node:fs";import{basename as Fs,dirname as Us}from"node:path";var Bs=["decided to","chose","implemented using","selected","opted for","will use","pattern:","approach:","architecture:","recommends","best practice","anti-pattern","learned that"],qs="decisions";function Gs(){return`${g()}/.claude/logs/agent-patterns.jsonl`}function Js(){return`${g()}/.claude/session`}function Ve(){let t=g();return(Fs(t)||"default-project").toLowerCase().replace(/ /g,"-").replace(/[^a-z0-9-]/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-")}function zs(t){return`${Ve()}-${t}`}function Ws(t){let r=(t.length>10240?t.substring(0,10240):t).toLowerCase();return/pagination|cursor|offset/.test(r)?"pagination":/security|vulnerability|exploit|injection|xss|csrf|owasp|safety|guardrail/.test(r)?"security":/database|sql|postgres|schema/.test(r)?"database":/\bapi\b|endpoint|\brest\b|graphql/.test(r)?"api":/auth|login|jwt|oauth/.test(r)?"authentication":/\btest\b|testing|pytest|jest|vitest|coverage|\bmock\b|fixture|\bspec\b/.test(r)?"testing":/deploy|\bci\b|\bcd\b|pipeline|docker|kubernetes|helm|terraform/.test(r)?"deployment":/observability|monitoring|logging|tracing|metrics|prometheus|grafana|langfuse/.test(r)?"observability":/react|component|frontend|\bui\b/.test(r)?"frontend":/performance|optimization|cache|index/.test(r)?"performance":/llm|\brag\b|embedding|vector|semantic|\bai\b|\bml\b|langchain|langgraph|openai|anthropic/.test(r)?"ai-ml":/etl|streaming|dataflow|spark/.test(r)||At(r,"data","pipeline")||At(r,"batch","processing")?"data-pipeline":/architecture|design|structure/.test(r)?"architecture":/decided|chose|selected/.test(r)?"decision":"pattern"}function Vs(t){let e=[];if(t.length<50)return e;for(let r of Bs){let s=r.toLowerCase(),i=t.split(`
`).filter(o=>o.toLowerCase().includes(s));for(let o of i){let a=o.trim().substring(0,200);a.length>20&&e.push(a)}}return[...new Set(e)].slice(0,5)}function at(t){c("agent-memory-store","Agent memory store hook starting");let e=t.tool_input||{},n=t.subagent_type||e.subagent_type||e.type||"",r=t.tool_result,s=typeof r=="string"?r:r?.content||t.agent_output||t.output||"",i=!0;if(t.error&&(i=!1),typeof r=="object"&&r?.is_error&&(i=!1),!n)return c("agent-memory-store","No agent type in input, skipping"),d();let o=`ork:${n}`,a=`${Js()}/current-agent-id`;try{Ns(a)&&Ls(a)}catch{}c("agent-memory-store",`Processing completion for agent: ${n} (agent_id: ${o}, success: ${i})`);let u=i&&s?Vs(s):[];if(u.length===0)return c("agent-memory-store",`No patterns extracted from ${n} output`),d();let l=Gs(),p=Us(l);try{Ms(p,{recursive:!0})}catch{}let m=Ve(),f=new Date().toISOString(),_=zs(qs);for(let k of u){let J=Ws(k),re={agent:n,agent_id:o,pattern:k,project:m,timestamp:f,scope_id:_,category:J,pending_graph_sync:!0};try{h(l,`${JSON.stringify(re)}
`)}catch{}c("agent-memory-store",`Extracted pattern (${J}): ${k.substring(0,50)}...`)}return c("agent-memory-store",`Extracted ${u.length} patterns from ${n} output`),{continue:!0,systemMessage:`[Pattern Extraction] ${u.length} patterns extracted from ${n}. To persist, use mcp__memory__create_entities with entities: [{"name": "${n}-pattern", "entityType": "Pattern", "observations": ["<pattern>"]}]`}}import{existsSync as Ks,writeFileSync as Ke,mkdirSync as Vt,readFileSync as Xs}from"node:fs";import{dirname as Qs}from"node:path";var Ys=[".env","credentials","secret","auth","password","token","api.key","private.key",".pem","oauth","jwt","session","cookie","encryption","crypto"];function Zs(){let t=`${g()}/.claude/hooks/logs`;try{Vt(t,{recursive:!0})}catch{}return`${t}/auto-spawn-quality.log`}function ti(){return`${g()}/.claude/context/spawn-queue.json`}function x(t){let e=Zs(),n=new Date().toISOString();try{h(e,`[${n}] [auto-spawn-quality] ${t}
`)}catch{}}function ei(t){let e=t.toLowerCase();for(let n of Ys)if(e.includes(n))return x(`Detected sensitive pattern: ${n}`),!0;return!1}function ni(t,e,n,r,s,i){let o=`SPAWN-${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,14)}-${Math.floor(Math.random()*1e4).toString().padStart(4,"0")}`,a=ti(),u=Qs(a);try{Vt(u,{recursive:!0})}catch{}let l;if(Ks(a))try{l=JSON.parse(Xs(a,"utf8"))}catch{l={schema_version:"1.0.0",created_at:i,queue:[]}}else l={schema_version:"1.0.0",created_at:i,queue:[]};let p={spawn_id:o,target_agent:e,trigger_agent:t,trigger_reason:n,priority:r,timestamp:i,session_id:s,status:"queued"};l.queue.push(p);try{Ke(a,JSON.stringify(l,null,2)),x(`Queued spawn request: ${o} for ${e} (reason: ${n})`)}catch{return x(`ERROR: Failed to queue spawn request for ${e}`),""}return o}function ri(t,e,n,r,s,i){let o=`${g()}/.claude/context/handoffs`;try{Vt(o,{recursive:!0})}catch{}let a=`${o}/auto_spawn_${e}_${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,15)}.json`,u={type:"auto_spawn_suggestion",from_agent:t,to_agent:e,timestamp:i,trigger_reason:n,priority:r,session_id:s,auto_triggered:!0,status:"suggested"};try{Ke(a,JSON.stringify(u,null,2)),x(`Created spawn suggestion: ${e} (reason: ${n})`)}catch{}}function si(t,e,n){if(n&&n!=="null")return x(`Skipping auto-spawn - agent ${t} had errors: ${n}`),null;if(t==="test-generator")return x("Rule matched: test-generator -> code-quality-reviewer"),{target:"code-quality-reviewer",reason:"test-generator completed - validating test quality and coverage",priority:"high"};if(ei(e)&&t!=="security-auditor"&&t!=="security-layer-auditor")return x("Rule matched: sensitive files detected -> security-auditor"),{target:"security-auditor",reason:"sensitive file changes detected - security audit required",priority:"critical"};if(t==="code-quality-reviewer")return x("Rule matched: code-quality-reviewer -> security-auditor"),{target:"security-auditor",reason:"code-quality-reviewer completed - proceeding with security scan",priority:"high"};if(t==="backend-system-architect"){let r=e.toLowerCase();if(/authentication|authorization|security|access.control|rbac|acl/.test(r))return x("Rule matched: backend-system-architect with auth -> security-layer-auditor"),{target:"security-layer-auditor",reason:"backend-system-architect designed auth/security layer - validation required",priority:"high"}}return null}function ct(t){let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",s=t.session_id,i=t.agent_output||t.output||"",o=t.error||"";if(x(`Checking auto-spawn conditions for agent: ${r} (session: ${s})`),r==="unknown"||!r)return x("Skipping unknown agent type"),d();let a=si(r,i,o);if(a){let u=ni(r,a.target,a.reason,a.priority,s,e);return ri(r,a.target,a.reason,a.priority,s,e),x(`=== AUTO-SPAWN QUALITY HOOK ===
Trigger Agent: ${r}
Target Agent: ${a.target}
Reason: ${a.reason}
Priority: ${a.priority}
Spawn ID: ${u}
Timestamp: ${e}
Session: ${s}`),{continue:!0,systemMessage:`Auto-spawn queued: ${a.target} (${a.priority} priority)`}}return x(`No auto-spawn conditions matched for ${r}`),d()}import{existsSync as ii,writeFileSync as tn,mkdirSync as oi,readFileSync as ai}from"node:fs";import{dirname as Kt}from"node:path";function Xe(){return`${g()}/.claude/context/knowledge/decisions/active.json`}function ci(){return`${g()}/.claude/context/session/state.json`}function ui(){return`${g()}/.claude/logs/agent-context`}function ut(t){try{oi(t,{recursive:!0})}catch{}}function Qe(t,e){if(!ii(t))return e;try{return JSON.parse(ai(t,"utf8"))}catch{return e}}function Ye(t,e){let n=Kt(t);ut(n);try{tn(t,JSON.stringify(e,null,2))}catch{}}var Ze=50;function lt(t){let e=t.subagent_type||t.agent_type||"unknown",n=new Date().toISOString(),r=t.agent_output||t.output||"",s=r.substring(0,200);r.length>200&&(s+="...");let i=e!=="unknown"||s.trim().length>0,o=e.replace(/-/g,"_");if(i){let k=Xe(),J=Kt(k);ut(J);let M=Qe(k,{schema_version:"2.0.0",decisions:{}});(!M.decisions||typeof M.decisions!="object")&&(M.decisions={});let Tn={timestamp:n,agent:e,summary:s,status:"completed"};M.decisions[o]=Tn,Ye(k,M)}let a=ci(),u=Kt(a);ut(u);let p=Qe(a,{schema_version:"2.0.0",session_id:"",started_at:n,last_activity:n,active_agent:null,tasks_pending:[],tasks_completed:[]});if(Array.isArray(p.tasks_completed)||(p.tasks_completed=[]),Array.isArray(p.tasks_pending)||(p.tasks_pending=[]),i){let k={agent:e,timestamp:n,summary:s};p.tasks_completed.push(k),p.tasks_completed.length>Ze&&(p.tasks_completed=p.tasks_completed.slice(-Ze))}p.last_activity=n,p.active_agent=null,Ye(a,p);let m=ui();ut(m);let f=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),_=`${m}/${e}_${f}.log`,y=`=== CONTEXT PUBLICATION (Protocol 2.0) ===
Agent: ${e}
Timestamp: ${n}
Decisions file: ${Xe()}
Session state: ${a}

=== AGENT OUTPUT ===
${r}
`;try{tn(_,y)}catch{}return d()}import{existsSync as li,writeFileSync as nn,mkdirSync as Qt,readFileSync as gi}from"node:fs";import{dirname as di}from"node:path";function Xt(){return!!(process.env.CLAUDE_CODE_TEAM_NAME||process.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS==="1")}var en=[{type:"product-thinking",name:"Product Thinking Pipeline",description:"Full product discovery and specification workflow",triggers:["should we build","product decision","feature validation","market research","user research"],steps:[{agent:"market-intelligence",description:"Analyze competitive landscape and market trends",dependsOn:[],skills:["market-research"],estimatedTokens:3e3},{agent:"ux-researcher",description:"Create personas and map user journeys",dependsOn:[0],skills:["user-research"],estimatedTokens:2500},{agent:"product-strategist",description:"Validate value proposition and alignment",dependsOn:[0,1],skills:["product-strategy"],estimatedTokens:2e3},{agent:"prioritization-analyst",description:"Score and prioritize using frameworks",dependsOn:[2],skills:["prioritization"],estimatedTokens:1500},{agent:"business-case-builder",description:"Build ROI and cost-benefit analysis",dependsOn:[2,3],skills:["business-case"],estimatedTokens:2e3},{agent:"requirements-translator",description:"Transform to PRD and user stories",dependsOn:[4],skills:["requirements"],estimatedTokens:2500}],estimatedTotalTokens:13500},{type:"full-stack-feature",name:"Full-Stack Feature Pipeline",description:"End-to-end feature implementation workflow",triggers:["full-stack feature","build a feature","implement end-to-end","create full feature","add complete feature"],steps:[{agent:"backend-system-architect",description:"Design API and database schema",dependsOn:[],skills:["api-design","database-patterns"],estimatedTokens:3e3},{agent:"frontend-ui-developer",description:"Build React components and UI",dependsOn:[0],skills:["react-server-components-framework","form-state-patterns"],estimatedTokens:3500},{agent:"test-generator",description:"Create unit and integration tests",dependsOn:[0,1],skills:["testing-patterns"],estimatedTokens:2e3},{agent:"security-auditor",description:"Audit for vulnerabilities",dependsOn:[0,1],skills:["security-patterns"],estimatedTokens:1500}],estimatedTotalTokens:1e4},{type:"ai-integration",name:"AI Integration Pipeline",description:"Add AI/LLM capabilities to application",triggers:["add rag","add llm","ai integration","implement rag","add ai feature","langgraph workflow"],steps:[{agent:"workflow-architect",description:"Design LangGraph workflow and state",dependsOn:[],skills:["langgraph"],estimatedTokens:2500},{agent:"llm-integrator",description:"Connect LLM APIs with function calling",dependsOn:[0],skills:["llm-integration"],estimatedTokens:2e3},{agent:"data-pipeline-engineer",description:"Build embeddings and data pipeline",dependsOn:[0],skills:["embeddings","rag-retrieval"],estimatedTokens:2500},{agent:"test-generator",description:"Create LLM testing infrastructure",dependsOn:[1,2],skills:["testing-patterns"],estimatedTokens:1500}],estimatedTotalTokens:8500},{type:"security-audit",name:"Security Audit Pipeline",description:"Comprehensive security review workflow",triggers:["security audit","security review","vulnerability scan","security assessment"],steps:[{agent:"security-auditor",description:"Scan for OWASP Top 10 vulnerabilities",dependsOn:[],skills:["security-patterns"],estimatedTokens:2e3},{agent:"security-layer-auditor",description:"Verify defense-in-depth layers",dependsOn:[0],skills:["security-patterns"],estimatedTokens:2e3},{agent:"ai-safety-auditor",description:"Audit AI/LLM security if applicable",dependsOn:[0],skills:["mcp-security-hardening"],estimatedTokens:1500}],estimatedTotalTokens:5500},{type:"frontend-compliance",name:"Frontend 2026 Compliance Pipeline",description:"Modernize frontend to 2026 patterns",triggers:["frontend compliance","modernize frontend","update react","frontend 2026"],steps:[{agent:"frontend-ui-developer",description:"Upgrade to React 19 patterns",dependsOn:[],skills:["react-server-components-framework","zustand-patterns"],estimatedTokens:3e3},{agent:"frontend-performance-engineer",description:"Optimize Core Web Vitals",dependsOn:[0],skills:["performance"],estimatedTokens:2e3},{agent:"accessibility-specialist",description:"Ensure WCAG 2.2 compliance",dependsOn:[0],skills:["testing-patterns","accessibility"],estimatedTokens:1500}],estimatedTotalTokens:6500}];function pi(){return`${g()}/.claude/coordination/decision-log.json`}function mi(){let t=`${g()}/.claude/hooks/logs`;try{Qt(t,{recursive:!0})}catch{}return`${t}/agent-feedback.log`}function T(t){let e=mi(),n=new Date().toISOString();try{h(e,`[${n}] [feedback-loop] ${t}
`)}catch{}}function fi(t){let e=Be();if(e){let r=en.find(s=>s.type===e.type);if(r){let s=r.steps.findIndex(i=>i.agent===t);if(s>=0){let i=r.steps.filter((o,a)=>o.dependsOn.includes(s)&&a>s).map(o=>o.agent);if(i.length>0)return i.join(" ")}}}return{"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"test-generator","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer"}[t]||""}function yi(t){return{"market-intelligence":"product-thinking","product-strategist":"product-thinking","prioritization-analyst":"product-thinking","business-case-builder":"product-thinking","requirements-translator":"specification","metrics-architect":"specification","backend-system-architect":"architecture","database-engineer":"architecture","data-pipeline-engineer":"architecture","frontend-ui-developer":"frontend","rapid-ui-designer":"frontend","ux-researcher":"frontend","test-generator":"quality","code-quality-reviewer":"quality","security-auditor":"security","security-layer-auditor":"security","workflow-architect":"ai-integration","llm-integrator":"ai-integration","debug-investigator":"debugging"}[t]||"general"}function hi(){return process.env.CLAUDE_INSTANCE_ID||`${bt("node:os").hostname()}-${process.pid}`}function ki(t){let e=t.substring(0,500);return t.length>500&&(e+="..."),e}function Si(t,e,n,r,s,i,o,a){let u=pi(),l=di(u);try{Qt(l,{recursive:!0})}catch{}let p;if(li(u))try{p=JSON.parse(gi(u,"utf8"))}catch{p={schema_version:"2.0.0",log_created_at:o,decisions:[]}}else p={schema_version:"2.0.0",log_created_at:o,decisions:[]};let m={decision_id:t,timestamp:o,made_by:{instance_id:hi(),agent_type:e},category:n,title:`Agent ${e} completed`,description:r,impact:{scope:"agent-pipeline",downstream_agents:s.split(" ").filter(Boolean)},status:i,task_id:a};p.decisions.push(m);try{nn(u,JSON.stringify(p,null,2)),T(`Decision ${t} logged for agent ${e}`)}catch{T("ERROR: Failed to write decision to log")}}function bi(t,e,n,r,s,i,o){if(!e)return;let a=`${g()}/.claude/context/handoffs`;try{Qt(a,{recursive:!0})}catch{}let u=e.split(" ").filter(Boolean),l=new Date().toISOString().replace(/[-:]/g,"").substring(0,15);for(let p of u){let m=`${a}/${t}_to_${p}_${l}.json`,f={from_agent:t,to_agent:p,timestamp:i,decision_id:r,summary:n,session_id:s,status:"pending",feedback_loop:!0,task_id:o};try{nn(m,JSON.stringify(f,null,2)),T(`Created handoff context: ${t} -> ${p}`)}catch{}}}function gt(t){if(Xt())return d();let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",s=t.session_id,i=t.agent_output||t.output||"",o=t.error||"";if(T(`Processing feedback for agent: ${r} (session: ${s})`),r==="unknown"||!r)return T("Skipping unknown agent type"),d();let a=new Date().toISOString().replace(/[-:T.]/g,"").substring(0,8),u=Math.floor(Math.random()*1e4).toString().padStart(4,"0"),l=`DEC-${a}-${u}`,m=C(r)?.taskId,f=fi(r),_=yi(r),y,k;return o&&o!=="null"?(y=`Agent failed: ${o}`,k="failed"):(y=ki(i),k="completed"),m&&(I(m,k==="completed"?"completed":"failed"),T(`Updated task ${m} status to ${k}`)),Si(l,r,_,y,f,k,e,m),f?(bi(r,f,y,l,s,e,m),T(`Routed findings to downstream agents: ${f}`)):T(`No downstream agents for ${r} (terminal agent)`),T(`=== AGENT FEEDBACK LOOP ===
Agent: ${r}
Category: ${_}
Decision ID: ${l}
Task ID: ${m||"none"}
Timestamp: ${e}
Status: ${k}
Downstream: ${f||"none"}

Summary: ${y}`),f?{continue:!0,systemMessage:`Feedback loop: routed to ${f}${m?` (task: ${m})`:""}`}:d()}import{writeFileSync as rn,mkdirSync as sn}from"node:fs";var _i=new Set(["market-intelligence","product-strategist","prioritization-analyst","business-case-builder","requirements-translator","metrics-architect","backend-system-architect","code-quality-reviewer","data-pipeline-engineer","database-engineer","debug-investigator","frontend-ui-developer","llm-integrator","rapid-ui-designer","security-auditor","security-layer-auditor","system-design-reviewer","test-generator","ux-researcher","workflow-architect"]),xi={"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"code-quality-reviewer","code-quality-reviewer":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"code-quality-reviewer","database-engineer":"backend-system-architect","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer","security-auditor":"none","security-layer-auditor":"none","debug-investigator":"none","system-design-reviewer":"none"},vi={"market-intelligence":"Next: product-strategist should define product vision based on market analysis","product-strategist":"Next: prioritization-analyst should rank features from strategy","prioritization-analyst":"Next: business-case-builder should create ROI justification","business-case-builder":"Next: requirements-translator should convert to technical specs","requirements-translator":"Next: metrics-architect should define success criteria","metrics-architect":"Next: backend-system-architect should design API endpoints","backend-system-architect":"Next: frontend-ui-developer should build UI components","frontend-ui-developer":"Next: test-generator should create test coverage","test-generator":"Next: code-quality-reviewer should validate implementation","code-quality-reviewer":"Next: security-auditor should perform security scan","workflow-architect":"Next: llm-integrator should configure LLM providers","llm-integrator":"Next: data-pipeline-engineer should set up embeddings","data-pipeline-engineer":"Next: code-quality-reviewer should validate data pipeline","database-engineer":"Next: backend-system-architect should integrate schema","rapid-ui-designer":"Next: frontend-ui-developer should implement designs","ux-researcher":"Next: rapid-ui-designer should create mockups"};function $i(t){return xi[t]||"none"}function Ii(t){return vi[t]||"Pipeline complete"}function wi(t,e,n,r,s){let i=`${g()}/.claude/context/handoffs`;try{sn(i,{recursive:!0})}catch{}let o=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),a=`${i}/${t}_to_${e}_${o}.json`,u={from_agent:t,to_agent:e,timestamp:n,summary:r,suggestions:s,status:"ready_for_handoff"};try{rn(a,JSON.stringify(u,null,2))}catch{}return a}function Ti(t,e,n,r,s,i){let o=`${g()}/.claude/logs/agent-handoffs`;try{sn(o,{recursive:!0})}catch{}let a=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),u=`${o}/${t}_${a}.log`,l=`=== HANDOFF PREPARATION ===
From: ${t}
To: ${e}
Timestamp: ${n}
Handoff file: ${i}

Summary: ${r}

Next Steps: ${s}
`;try{rn(u,l)}catch{}}function dt(t){let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown";if(!_i.has(r))return d();let s=$i(r),i=t.agent_output||t.output||"",o=i.length,a;o>0?(a=i.substring(0,300),o>300&&(a+="...")):a=`Agent ${r} completed`;let u=Ii(r),l=wi(r,s,e,a,u);return Ti(r,s,e,a,u,l),d()}import{writeFileSync as Ai,mkdirSync as on}from"node:fs";var Di=[".env","auth","secret","credential","password","token","apikey","api_key","api-key","jwt","session","oauth","permission",".pem",".key"];function Ci(){let t=`${g()}/.claude/logs/multi-claude`;try{on(t,{recursive:!0})}catch{}return t}function R(t,e,n){let r=Ci(),s=new Date().toISOString().substring(0,10).replace(/-/g,""),i=`${r}/verifier_${s}.log`,o=new Date().toISOString();try{h(i,`[${o}] [${t}] ${e}: ${n}
`)}catch{}}function Ri(t){let e=t.toLowerCase();for(let n of Di)if(e.includes(n))return!0;return!!(e.includes("config")&&e.includes("prod"))}function pt(t){let e=new Date().toISOString(),n=g(),s=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",i=t.agent_output||t.output||"",o=[];if(s==="test-generator"&&(o.push({agent:"code-quality-reviewer",reason:"Test generation complete - quality review recommended"}),R(s,"TRIGGER","test-generator completion triggers code-quality-reviewer")),s==="frontend-ui-developer"&&/form|input|validation|submit|auth|login/i.test(i)&&(o.push({agent:"security-auditor",reason:"Frontend auth/form components - security review recommended"}),R(s,"TRIGGER","frontend auth components trigger security-auditor")),s==="backend-system-architect"&&/endpoint|route|api|auth|jwt|session/i.test(i)&&(o.push({agent:"security-auditor",reason:"Backend API endpoints - security review recommended"}),R(s,"TRIGGER","backend API endpoints trigger security-auditor")),Ri(i)&&(o.some(u=>u.agent==="security-auditor")||(o.push({agent:"security-auditor",reason:"Sensitive files modified - security review required"}),R(s,"TRIGGER","sensitive file patterns detected"))),s==="database-engineer"&&(o.push({agent:"code-quality-reviewer",reason:"Database schema changes - review for consistency"}),R(s,"TRIGGER","database changes trigger code-quality-reviewer")),s==="workflow-architect"&&(o.push({agent:"security-layer-auditor",reason:"LangGraph workflow created - layer audit recommended"}),R(s,"TRIGGER","workflow-architect triggers security-layer-auditor")),o.length>0){let a=`${n}/.claude/context/verification-queue`;try{on(a,{recursive:!0})}catch{}let u=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),l=`${a}/pending_${u}_${s}.json`,p={triggered_by:s,timestamp:e,verifications:o.map(f=>({agent:f.agent,reason:f.reason,status:"pending"}))};try{Ai(l,JSON.stringify(p,null,2))}catch{}let m="Multi-Claude Verification Triggered: "+o.map(f=>`${f.agent} (${f.reason})`).join("; ");return R(s,"QUEUE",`Created verification queue: ${l}`),{continue:!0,systemMessage:m}}return R(s,"SKIP","No verification triggers matched"),d()}import{writeFileSync as Ei,mkdirSync as Oi}from"node:fs";function Pi(){let t=`${g()}/.claude/logs/agent-validation`;try{Oi(t,{recursive:!0})}catch{}return t}function mt(t){let e=t.subagent_type||t.agent_type||"unknown",n=new Date().toISOString(),r=t.agent_output||t.output||"",s=[],i=[];r||s.push("Agent produced empty output");let o=r.length;if(o<50&&i.push(`Output seems very short (${o} chars)`),/error|failed|exception/i.test(r)&&i.push("Output contains error-related keywords"),e==="backend-system-architect"&&r.includes("{")){let y=r.match(/\{[^{}]{0,1000}\}/);if(y)try{JSON.parse(y[0])}catch{i.push("JSON structure may be malformed")}}let a=s.length>0?"failed":"passed",u=t.last_assistant_message?.length??null,l=`Output Validation [${a}] - Agent: ${e}, Timestamp: ${n}, Output length: ${o} chars`+(u!==null?`, Response length: ${u} chars`:"");s.length>0&&(l+=` | Errors: ${s.join("; ")}`),i.length>0&&(l+=` | Warnings: ${i.join("; ")}`);let p=Pi(),m=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),f=`${p}/${e}_${m}.log`,_=`=== OUTPUT VALIDATION ===
${l}
${u!==null?`Response quality signal: last_assistant_message length = ${u}
`:""}
=== AGENT OUTPUT ===
${r}
`;try{Ei(f,_)}catch{}return a==="failed"?{continue:!1,systemMessage:l,hookSpecificOutput:{hookEventName:"SubagentStop"}}:{continue:!0,suppressOutput:!0,systemMessage:l}}import{existsSync as cn,writeFileSync as Hi,readFileSync as un}from"node:fs";import{join as ji}from"node:path";var Yt=ce(),ft={security_minimum:5,general_minimum:3};function Ni(t){let e=[];if(!t)return e;let n=/\*{0,2}(\w[\w\s]{0,30}?)\*{0,2}\s*:\s*(\d+(?:\.\d+)?)\s*\/\s*(\d+)/g;for(let s of t.matchAll(n)){let i=s[1].trim().toLowerCase(),o=parseFloat(s[2]),a=parseFloat(s[3]);!Number.isNaN(o)&&!Number.isNaN(a)&&a>0&&e.push({value:o,max:a,dimension:i==="score"?null:i})}let r=/"(\w+_?score|score)"\s*:\s*(\d+(?:\.\d+)?)/gi;for(let s of t.matchAll(r)){let i=s[1].toLowerCase(),o=parseFloat(s[2]);if(!Number.isNaN(o)){let a=i==="score"?null:i.replace(/_score$/,"");e.push({value:o,max:10,dimension:a})}}return e}function Mi(){let t=g();if(!t||t===".")return{};let e=ji(t,".claude","policies","verification-policy.json");if(!cn(e))return{};try{return JSON.parse(un(e,"utf8"))}catch{return c("subagent-quality-gate","Failed to parse verification-policy.json","warn"),{}}}function Li(t,e){let n={...ft,...e.thresholds};if(t){let r=`${t}_minimum`;if(r in n)return n[r]??ft.general_minimum;if(/security|vuln|cve|owasp/i.test(t))return n.security_minimum??ft.security_minimum}return n.general_minimum??ft.general_minimum}function Fi(t){return!t||t.length<200?!0:[/\bfinding/i,/\bevidence/i,/\brecommendation/i,/\bissue/i,/\bresult/i,/\bsummary/i,/^[-*]\s/m,/^\d+\.\s/m,/^#{1,3}\s/m].some(n=>n.test(t))}function an(t){if(cn(Yt))try{let e=JSON.parse(un(Yt,"utf8"));t==="error"?e.errors=(e.errors||0)+1:t==="threshold_failure"&&(e.threshold_failures=(e.threshold_failures||0)+1),e.quality_checks=(e.quality_checks||0)+1,Hi(Yt,JSON.stringify(e,null,2))}catch{}}function yt(t){let e=t.agent_id||"",n=t.subagent_type||"",r=t.error||"",s=t.agent_output||t.output||t.last_assistant_message||"";if(c("subagent-quality-gate",`Quality gate check: ${n} (${e})`),r&&r!=="null")return c("subagent-quality-gate",`ERROR: Subagent failed - ${r}`),an("error"),D(`Subagent ${n} failed: ${r}`);let i=Ni(s);if(i.length>0){let o=Mi();for(let a of i){let u=a.value/a.max*10,l=Li(a.dimension,o),p=a.dimension||"overall";if(u<l)return c("subagent-quality-gate",`Score below threshold: ${p}=${u.toFixed(1)}/10 (min: ${l})`,"warn"),an("threshold_failure"),D(`Quality gate: ${p} score ${a.value}/${a.max} (${u.toFixed(1)}/10) is below minimum ${l}/10. Review the ${p} findings before proceeding.`)}}return s.length>200&&!Fi(s)&&c("subagent-quality-gate",`Subagent ${n} output lacks structured findings`,"info"),d()}function Ui(t){let e=t.error||t.tool_error,n=t.exit_code;if(e&&e!=="null"&&e!==""||n!==void 0&&n!==0)return!1;let r=t.agent_output||t.output||"",s=[/\bfailed\b/i,/\berror:\s/i,/\bexception\b/i,/\bcould not\b/i,/\bunable to\b/i],i=r.slice(0,500);for(let o of s)o.test(i)&&c("task-completer",`Warning: possible error in output: ${o}`);return!0}function ht(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return c("task-completer","No agent type found, skipping"),d();c("task-completer",`Processing SubagentStop for: ${n}`);let r=C(n);if(!r)return c("task-completer",`No orchestration task found for agent: ${n}`),Rt(n),d();let s=Ui(t),i=s?"completed":"failed";c("task-completer",`Agent ${n} completed with status: ${i}`),I(r.taskId,i),E(n,i);let o=`## Orchestration: Task ${s?"Completed":"Failed"}

Agent \`${n}\` has finished with status: **${i}**

${nt({taskId:r.taskId,status:s?"completed":"pending"})}
`;if(s&&r.pipelineId&&r.pipelineStep!==void 0){let a=qe(r.pipelineId,r.pipelineStep);if(a!==null){let u=Bt(r.pipelineId).filter(l=>l.pipelineStep===a&&l.status==="pending");u.length>0&&(o+=`
### Pipeline Progress

Pipeline \`${r.pipelineId}\` step ${r.pipelineStep} complete.
Next step (${a}) is now unblocked.

**Next agent(s) to spawn:**
${u.map(l=>`- \`${l.agent}\` (task: ${l.taskId})`).join(`
`)}

Consider spawning the next agent to continue the pipeline.`)}else o+=`
### Pipeline Complete

Pipeline \`${r.pipelineId}\` has completed all steps.`}if(!s){let a=t.error||t.tool_error||"Unknown error";o+=`
### Error Details

The agent encountered an issue:
\`\`\`
${a.slice(0,500)}
\`\`\`

Consider:
1. Retrying with more specific instructions
2. Using an alternative agent
3. Breaking down the task further`;let u=Ue(r.taskId);if(u.length>0){o+=`

### Orphaned Tasks (CC 2.1.20)

The following tasks were blocked by the failed task and should be deleted:
`;for(let l of u)o+=`
${Fe(l.taskId,`Blocked by failed task ${r.taskId} (agent: ${n})`)}`,I(l.taskId,"failed")}}return i==="completed"&&Rt(n),c("task-completer",`Completed task ${r.taskId} with status ${i}`),A(o)}var Zt=new Map;function Bi(t,e){let n=Zt.get(t)||[];n.push(e),n.length>10&&n.shift(),Zt.set(t,n)}function qi(){let t=[];for(let[e,n]of Zt)n.some(r=>r.outcome==="failure")&&t.push(e);return t}function Gi(t){let e=t.error||t.tool_error,n=t.exit_code,r=t.agent_output||t.output||"";if(e&&e!=="null"&&e!=="")return{outcome:"failure",error:e};if(n!==void 0&&n!==0)return{outcome:"failure",error:`Exit code: ${n}`};let s=[/i cannot|i can't|i am unable/i,/outside my scope/i,/not appropriate/i,/i refuse/i];for(let o of s)if(o.test(r.slice(0,500)))return{outcome:"rejected",error:"Agent rejected the task"};let i=[/partial(?:ly)?/i,/incomplete/i,/some.*failed/i,/couldn't finish/i];for(let o of i)if(o.test(r.slice(0,500)))return{outcome:"partial"};return{outcome:"success"}}function kt(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return d();let{outcome:r,error:s}=Gi(t);if(r==="success")return d();c("retry-handler",`Agent ${n} completed with outcome: ${r}`);let i=Et(),a=$().activeAgents.find(y=>y.agent===n),u=a?.retryCount||0,l=ve(n,u+1,a?.taskId),p=$e(l,r,s||void 0);Bi(n,p);let m=qi(),f=xe(n,u+1,s||"Unknown failure",m,i.maxRetries);if(c("retry-handler",`Retry decision for ${n}: shouldRetry=${f.shouldRetry}, alternative=${f.alternativeAgent||"none"}`),f.shouldRetry)E(n,"retrying");else{E(n,"failed");let y=C(n);y&&I(y.taskId,"failed")}let _=Ie(f,n);return A(_)}import{existsSync as fn,mkdirSync as eo,readFileSync as no,writeFileSync as ro}from"node:fs";import{existsSync as Ji,readFileSync as zi,writeFileSync as Ru,mkdirSync as Eu}from"node:fs";import{execSync as ln}from"node:child_process";import{createHash as Wi}from"node:crypto";import*as gn from"node:os";var Vi=".claude/.user_identity.json",Ki="orchestkit-user-identity-v1";var b=null;function St(t){return Wi("sha256").update(t+Ki).digest("hex").slice(0,32)}function Xi(){try{return gn.hostname()}catch{return"unknown-machine"}}function Qi(t){let e=`${t}/${Vi}`;if(!Ji(e))return null;try{let n=zi(e,"utf8");return JSON.parse(n)}catch(n){return c("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function Yi(t){let e={};try{e.email=ln("git config user.email",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{e.name=ln("git config user.name",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return e}function Zi(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function to(t){if(b)return b;let e=t||g(),n=Xi(),r=Qi(e);if(r?.user_id)return b={user_id:r.user_id,display_name:r.display_name||r.user_id,team_id:r.team_id,machine_id:n,source:"config",anonymous_id:St(r.user_id),email:r.user_id.includes("@")?r.user_id:void 0},c("user-identity",`Resolved from config: ${b.anonymous_id}`,"debug"),b;let s=Yi(e);if(s.email)return b={user_id:s.email,display_name:s.name||s.email.split("@")[0],team_id:r?.team_id,machine_id:n,source:"git",anonymous_id:St(s.email),email:s.email},c("user-identity",`Resolved from git: ${b.anonymous_id}`,"debug"),b;let i=Zi();if(i.username){let a=`${i.username}@${n}`;return b={user_id:a,display_name:i.username,team_id:r?.team_id,machine_id:n,source:"env",anonymous_id:St(a)},c("user-identity",`Resolved from env: ${b.anonymous_id}`,"debug"),b}let o=St(n+process.pid);return b={user_id:`anon-${o.slice(0,8)}`,display_name:"Anonymous",team_id:r?.team_id,machine_id:n,source:"anonymous",anonymous_id:o},c("user-identity",`Resolved as anonymous: ${b.anonymous_id}`,"debug"),b}function dn(){let t=to();return{session_id:S(),user_id:t.user_id,anonymous_id:t.anonymous_id,team_id:t.team_id,machine_id:t.machine_id,identity_source:t.source,timestamp:new Date().toISOString()}}var so=/^[a-zA-Z0-9_-]{1,128}$/;function io(t){return so.test(t)}function ne(t,e){let n=t||S(),r=e||g();if(!io(n))throw new Error("Invalid session ID format");return`${r}/.claude/memory/sessions/${n}`}function oo(t,e){return`${ne(t,e)}/events.jsonl`}function yn(t,e){let n=ne(t,e);fn(n)||eo(n,{recursive:!0})}var G=0,pn=!1,te=!1,mn=0,ao=5e3;function hn(t,e){return`${ne(t,e)}/counter.json`}function co(t,e){if(!pn){pn=!0;try{let n=hn(t,e);if(fn(n)){let r=JSON.parse(no(n,"utf8"));typeof r.counter=="number"&&r.counter>0&&(G=r.counter,c("session-tracker",`Loaded event counter: ${G}`,"debug"))}}catch{}}}function uo(t,e){if(!te)return;let n=Date.now();if(!(n-mn<ao))try{yn(t,e);let r=hn(t,e);ro(r,JSON.stringify({counter:G,updated_at:new Date().toISOString()})),te=!1,mn=n}catch{}}function lo(){return co(),G++,te=!0,uo(),`evt-${Date.now()}-${G}`}function kn(t,e,n={}){try{let r={event_id:lo(),event_type:t,identity:dn(),payload:{name:e,input:ee(n.input),output:ee(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?Sn(n.context,500):void 0,confidence:n.confidence}};yn();let s=oo();h(s,`${JSON.stringify(r)}
`),c("session-tracker",`Tracked ${t}: ${e}`,"debug")}catch(r){c("session-tracker",`Failed to track event: ${r}`,"warn")}}function Sn(t,e){return t.length<=e?t:`${t.slice(0,e-3)}...`}function ee(t){if(!t)return;let e={},n=["password","secret","token","key","credential","auth"];for(let[r,s]of Object.entries(t)){if(n.some(i=>r.toLowerCase().includes(i))){e[r]="[REDACTED]";continue}if(typeof s=="string"&&s.length>500){e[r]=Sn(s,500);continue}if(typeof s=="object"&&s!==null&&!Array.isArray(s)){e[r]=ee(s);continue}e[r]=s}return e}import{mkdirSync as go,statSync as po,renameSync as mo}from"node:fs";import{createHash as fo}from"node:crypto";function yo(){return It(vt(),".claude","analytics")}function bn(t){return fo("sha256").update(t).digest("hex").slice(0,12)}function _n(){let t=process.env.CLAUDE_CODE_TEAM_NAME;return t?{team:t}:void 0}function ho(t,e=10485760){try{if(po(t).size>e){let r=new Date().toISOString().slice(0,7),s=t.replace(/\.jsonl$/,`.${r}.jsonl`);mo(t,s)}}catch{}}function ko(){return!!(process.env.VITEST||process.env.JEST_WORKER_ID)}function xn(t,e){if(!ko())try{let n=yo();go(n,{recursive:!0});let r=It(n,t);ho(r),h(r,`${JSON.stringify(e)}
`)}catch{}}var vn=[{name:"context-publisher",fn:lt},{name:"handoff-preparer",fn:dt},{name:"feedback-loop",fn:gt},{name:"agent-memory-store",fn:at}];function So(t){try{let e=t.tool_input?.subagent_type||t.subagent_type||t.agent_type||"unknown",n=t.tool_input?.name||void 0,r=!t.error,s=t.duration_ms,i=t.agent_output||t.output||"",o=typeof i=="string"?i.length:0;kn("agent_spawned",e,{success:r,duration_ms:s,output:{has_output:o>0,output_length:o,has_error:!!t.error},context:t.agent_id});let a=t.tool_input?.model||process.env.CLAUDE_MODEL||"unknown";xn("agent-usage.jsonl",{ts:new Date().toISOString(),pid:bn(process.env.CLAUDE_PROJECT_DIR||""),agent:e,agent_name:n??null,model:a,duration_ms:s,success:r,output_len:o,last_msg_len:t.last_assistant_message?.length??null,..._n()})}catch{}}async function $n(t){So(t);let n=(await Promise.allSettled(vn.map(async r=>{try{let s=r.fn(t);return s instanceof Promise&&await s,{hook:r.name,status:"success"}}catch(s){let i=s instanceof Error?s.message:String(s);return c("subagent-stop-dispatcher",`${r.name} failed: ${i}`),{hook:r.name,status:"error",message:i}}}))).filter(r=>r.status==="rejected"||r.status==="fulfilled"&&r.value.status==="error");return n.length>0&&c("subagent-stop-dispatcher",`${n.length}/${vn.length} hooks had errors`),d()}var N="sync-subagent-stop-dispatcher",bo=[{name:"output-validator",fn:mt},{name:"auto-spawn-quality",fn:ct},{name:"multi-claude-verifier",fn:pt},{name:"subagent-quality-gate",fn:yt},{name:"task-completer",fn:ht},{name:"retry-handler",fn:kt}];function In(t){let e=[];for(let r of bo)try{let s=r.fn(t);if(s.continue===!1)return c(N,`${r.name}: blocked (continue: false) \u2014 short-circuiting`),s;s.systemMessage&&(e.push(s.systemMessage),c(N,`${r.name}: systemMessage collected`));let i=V(s);i&&!s.systemMessage&&(e.push(i),c(N,`${r.name}: additionalContext collected`))}catch(s){let i=s instanceof Error?s.message:String(s);c(N,`${r.name} failed: ${i}`,"warn")}if(e.length===0)return c(N,"All sync hooks silent"),d();let n=e.join(`
`);return c(N,`Merged ${e.length} messages from sync hooks`),{continue:!0,systemMessage:n}}var wn={"subagent-start/graph-memory-inject":X,"subagent-start/context-gate":Y,"subagent-start/subagent-context-stager":tt,"subagent-start/subagent-validator":et,"subagent-start/task-linker":rt,"subagent-start/model-cost-advisor":it,"subagent-start/issue-context-injector":ot,"subagent-start/unified-dispatcher":We,"subagent-stop/agent-memory-store":at,"subagent-stop/auto-spawn-quality":ct,"subagent-stop/context-publisher":lt,"subagent-stop/feedback-loop":gt,"subagent-stop/handoff-preparer":dt,"subagent-stop/multi-claude-verifier":pt,"subagent-stop/output-validator":mt,"subagent-stop/subagent-quality-gate":yt,"subagent-stop/task-completer":ht,"subagent-stop/retry-handler":kt,"subagent-stop/unified-dispatcher":$n,"subagent-stop/sync-subagent-stop-dispatcher":In};function Dl(t){return wn[t]}function Cl(){return Object.keys(wn)}export{ca as DEFAULT_CONFIG,aa as THRESHOLDS,ka as addToPromptHistory,Ta as analyzeAttemptHistory,Pa as applyDecay,ba as cacheClassification,mr as calculateBackoffDelay,$a as cleanupOldStates,va as clearSessionState,$e as completeAttempt,ve as createAttempt,ia as escapeRegex,K as estimateTokenCount,V as extractContext,Ie as formatRetryDecision,pa as getActiveAgent,Ha as getAdjustments,ja as getAgentSuccessRate,Ot as getAlternativeAgent,me as getCachedBranch,Na as getCalibrationStats,Go as getEnvFile,na as getField,Dl as getHook,ha as getInjectedSkills,_a as getLastClassification,pe as getLogDir,er as getLogLevel,W as getPluginRoot,g as getProjectDir,Sa as getPromptHistory,S as getSessionId,Ma as hasMinimalCalibrationData,$r as hashPrompt,wn as hooks,ma as isAgentDispatched,xo as isBashInput,$o as isEditInput,Io as isReadInput,fr as isRetryableError,ya as isSkillInjected,vo as isWriteInput,At as lineContainsAll,ra as lineContainsAllCI,Cl as listHooks,U as loadCalibrationData,Et as loadConfig,$ as loadState,c as logHook,Zo as logPermissionFeedback,xe as makeRetryDecision,sa as normalizeCommand,Jo as normalizeLineEndings,Ko as outputAllowWithContext,Wo as outputBlock,Tt as outputDeny,Xo as outputError,rr as outputPromptContext,ta as outputPromptContextBudgeted,zo as outputSilentAllow,d as outputSilentSuccess,Qo as outputStderrWarning,D as outputWarning,A as outputWithContext,Vo as outputWithNotification,Yo as outputWithUpdatedInput,Aa as prepareForRetry,ea as readHookInput,Oa as recordOutcome,Rt as removeAgent,vr as saveCalibrationData,xa as saveConfig,ar as saveState,nr as shouldLog,yr as suggestsAlternative,da as trackDispatchedAgent,fa as trackInjectedSkill,E as updateAgentStatus,H as updateState};
//# sourceMappingURL=subagent.mjs.map
