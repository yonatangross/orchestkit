// OrchestKit Hooks - subagent bundle
// Generated: 2026-03-01T09:37:00.312Z

var yt=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,n)=>(typeof require<"u"?require:e)[n]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});function ho(t){return typeof t.command=="string"}function ko(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function So(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function _o(t){return typeof t.file_path=="string"&&t.content===void 0}import{existsSync as B,statSync as qn,renameSync as Gn,mkdirSync as ce,readSync as Jn,readFileSync as zn,writeFileSync as Wn}from"node:fs";import{join as Vn}from"node:path";import{appendFileSync as bn,mkdirSync as xn}from"node:fs";import{dirname as vn}from"node:path";var U=[],ht=!1,Zt=!1;function h(t,e){U.push({filePath:t,content:e}),$n()}function kt(){if(ht||U.length===0)return;ht=!0;let t=new Map;for(let e of U){let n=t.get(e.filePath);n?n.push(e.content):t.set(e.filePath,[e.content])}for(let[e,n]of t)try{xn(vn(e),{recursive:!0}),bn(e,n.join(""))}catch{}U.length=0,ht=!1}function $n(){Zt||(Zt=!0,process.on("exit",kt),process.on("SIGTERM",()=>{kt(),process.exit(0)}),process.on("SIGINT",()=>{kt(),process.exit(0)}))}import{execSync as Kn}from"node:child_process";import te from"node:os";import P from"node:path";function St(){return process.env.HOME||process.env.USERPROFILE||te.homedir()}function In(){return te.tmpdir()}function _t(){return process.env.CLAUDE_PROJECT_DIR||"."}function ee(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function ne(){return process.env.CLAUDE_PLUGIN_ROOT?P.join(St(),".claude","logs","ork"):P.join(_t(),".claude","logs")}function re(){return process.env.CLAUDE_METRICS_FILE||P.join(In(),"claude-session-metrics.json")}var bt=P.join,To=P.sep;import{execSync as wn}from"node:child_process";import{createHash as Tn}from"node:crypto";import{existsSync as se,readFileSync as An,writeFileSync as Dn,mkdirSync as Cn}from"node:fs";import{join as xt,basename as Rn}from"node:path";var En=20,On=15,Pn=/[^a-z0-9-]/g;function jn(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=Rn(e);return ie(n,En)}function Hn(t){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=wn("git branch --show-current",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),r=ie(n||"detached",On);return process.env.ORCHESTKIT_SESSION_BRANCH=r,r}catch{return"nobranch"}}function Nn(t){let e=t||new Date,n=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${n}${r}`}function Mn(t){let e=t||new Date,n=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0");return`${n}${r}`}function Ln(){let t=`${process.pid}-${Date.now()}-${Math.random()}`;return Tn("sha256").update(t).digest("hex").slice(0,4)}function ie(t,e){return t.toLowerCase().replace(Pn,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,e)}function Fn(t,e){let n=jn(t),r=Hn(t),s=Nn(e),i=Mn(e),o=Ln();return`${n}-${r}-${s}-${i}-${o}`}function Un(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=xt(e,".instance","session-id.json");if(se(n))try{let r=JSON.parse(An(n,"utf8"));if(r.session_id&&r.created_at){let s=Date.now()-new Date(r.created_at).getTime(),i=1440*60*1e3;if(s<i)return r.session_id}}catch{}}function Bn(t,e){let n=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),r=xt(n,".instance"),s=xt(r,"session-id.json");try{se(r)||Cn(r,{recursive:!0}),Dn(s,JSON.stringify({session_id:t,created_at:new Date().toISOString()},null,2))}catch{}}function oe(t){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let e=Un(t);if(e)return e;let n=Fn(t);return Bn(n,t),n}function ue(){return ne()}function g(){return _t()}function q(){return ee()}function Fo(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${q()}/.claude/.instance_env`}function S(){return oe()}function le(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let e=Kn("git branch --show-current",{cwd:t||g(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function Xn(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Uo(t){return t.replace(/\r\n/g,`
`)}function Qn(t){let e=["debug","info","warn","error"];return e.indexOf(t)>=e.indexOf(Xn())}function p(){return{continue:!0,suppressOutput:!0}}function Bo(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function qo(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function G(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function Yn(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function Go(t,e){let n={continue:!0,suppressOutput:!0};return t&&(n.systemMessage=t),e&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:e}),n}function Jo(t,e){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?n.systemMessage=e:n.suppressOutput=!0,n}function zo(t){return{continue:!0,systemMessage:t}}function T(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function Wo(t){process.stderr.write(`\u26A0 ${t}
`),process.exit(2)}function vt(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}function Vo(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:t}}}var Zn=200*1024,tr=100*1024;function ge(t,e){if(B(t))try{if(qn(t).size>e){let r=`${t}.old.${Date.now()}`;Gn(t,r)}}catch{}}function de(t){B(t)||ce(t,{recursive:!0})}function c(t,e,n="debug"){if(!Qn(n))return;let r=ue(),s=`${r}/hooks.log`;try{de(r),ge(s,Zn);let i=new Date().toISOString().replace("T"," ").slice(0,19);h(s,`[${i}] [${n.toUpperCase()}] [${t}] ${e}
`)}catch{}}function Ko(t,e,n){let r=ue(),s=`${r}/permission-feedback.log`;try{de(r),ge(s,tr);let i=new Date().toISOString(),o=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",a=n?.session_id||S();h(s,`${i} | ${t} | ${e} | tool=${o} | session=${a}
`)}catch{}}function J(t){return t.hookSpecificOutput?.additionalContext?t.hookSpecificOutput.additionalContext:t.systemMessage&&typeof t.systemMessage=="string"?t.systemMessage:null}function z(t){if(!t)return 0;let r=(t.match(/[{};()=><]/g)||[]).length/t.length>.03?2.8:3.5;return Math.ceil(t.length/r)}function Xo(t,e,n,r,s){let i=z(t);return r?.isOverBudget(n)?(c(e,`Budget exhausted for ${n}, suppressing ${i}t`),p()):(s&&s.trackTokenUsage(e,n,i),Yn(t))}function ae(t){let e=2166136261;for(let n=0;n<t.length;n++)e^=t.charCodeAt(n),e=Math.imul(e,16777619);return(e>>>0).toString(16).padStart(8,"0")}function Qo(t,e,n,r){let s=Vn(t,e);if(B(s))try{let i=zn(s,"utf8");if(ae(i)===ae(n))return c(r,`Rules file ${e} unchanged, skipping write`),!1}catch{}return B(t)||ce(t,{recursive:!0}),Wn(s,n,"utf8"),c(r,`Wrote rules file: ${s}`),!0}function Yo(){try{let t=[],n=Buffer.allocUnsafe(256),r,s=0;for(;;)try{if(r=Jn(s,n,0,256,null),r===0)break;t.push(Buffer.from(n.subarray(0,r)))}catch{break}let i=Buffer.concat(t).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:S(),tool_input:{}}}catch{return{tool_name:"",session_id:S(),tool_input:{}}}}function Zo(t,e){let n=e.replace(/^\./,"").split("."),r=t;for(let s of n){if(r==null)return;r=r[s]}return r}function $t(t,...e){return t.split(`
`).some(n=>e.every(r=>n.includes(r)))}function ta(t,...e){return t.split(`
`).some(n=>{let r=n.toLowerCase();return e.every(s=>r.includes(s.toLowerCase()))})}function ea(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function na(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var sa={AUTO_DISPATCH:85,SKILL_INJECT:80,STRONG_RECOMMEND:70,SUGGEST:50,MINIMUM:40},ia={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:1200,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};import{existsSync as j,readFileSync as me,writeFileSync as fe,mkdirSync as er}from"node:fs";function It(){return`${g()}/.claude/orchestration`}function wt(){let t=S();return`${It()}/session-${t}.json`}function ye(){return`${g()}/.claude/orchestration/config.json`}function he(){let t=It();if(!j(t))try{er(t,{recursive:!0})}catch{c("orchestration-state",`Failed to create state dir: ${t}`)}}function $(){let t=wt();if(j(t))try{let e=me(t,"utf8");return JSON.parse(e)}catch(e){c("orchestration-state",`Failed to load state: ${e}`)}return{sessionId:S(),activeAgents:[],injectedSkills:[],promptHistory:[],maxHistorySize:10,updatedAt:new Date().toISOString()}}function nr(t){he();let e=wt();t.updatedAt=new Date().toISOString();try{fe(e,JSON.stringify(t,null,2))}catch(n){c("orchestration-state",`Failed to save state: ${n}`)}}function R(t){let e=$();return t(e),nr(e),e}function ua(t,e,n){let r={agent:t,taskId:n,confidence:e,dispatchedAt:new Date().toISOString(),status:"pending",retryCount:0,maxRetries:3};return R(s=>{s.activeAgents=s.activeAgents.filter(i=>i.agent!==t),s.activeAgents.push(r)}),c("orchestration-state",`Tracked dispatched agent: ${t} (conf: ${e})`),r}function Tt(t,e,n){R(r=>{let s=r.activeAgents.find(i=>i.agent===t);s&&(s.status=e,n&&(s.taskId=n),e==="retrying"&&s.retryCount++)}),c("orchestration-state",`Updated agent status: ${t} -> ${e}`)}function la(t){R(e=>{e.activeAgents=e.activeAgents.filter(n=>n.agent!==t)})}function ga(){return $().activeAgents.find(e=>e.status==="in_progress")}function da(t){return $().activeAgents.some(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function pa(t){R(e=>{e.injectedSkills.includes(t)||e.injectedSkills.push(t)})}function ma(t){return $().injectedSkills.includes(t)}function fa(){return $().injectedSkills}function ya(t){R(e=>{e.promptHistory.push(t),e.promptHistory.length>e.maxHistorySize&&(e.promptHistory=e.promptHistory.slice(-e.maxHistorySize))})}function ha(){return $().promptHistory}function ka(t){R(e=>{e.lastClassification=t})}function Sa(){return $().lastClassification}var pe={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:1200,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function At(){let t=ye();if(j(t))try{let e=me(t,"utf8");return{...pe,...JSON.parse(e)}}catch{}return pe}function _a(t){he();let e=ye(),r={...At(),...t};try{fe(e,JSON.stringify(r,null,2))}catch(s){c("orchestration-state",`Failed to save config: ${s}`)}}function ba(){let t=wt();try{if(j(t)){let{unlinkSync:e}=yt("node:fs");e(t),c("orchestration-state","Cleared session state")}}catch{}}function xa(){let t=It();if(j(t))try{let{readdirSync:e,statSync:n,unlinkSync:r}=yt("node:fs"),s=e(t).filter(i=>i.startsWith("session-")&&i.endsWith(".json")).map(i=>({name:i,path:`${t}/${i}`,mtime:n(`${t}/${i}`).mtime.getTime()})).sort((i,o)=>o.mtime-i.mtime);for(let i of s.slice(5))try{r(i.path),c("orchestration-state",`Cleaned up old state: ${i.name}`)}catch{}}catch{}}var rr=3,sr=1e3,ir=3e4,or={"backend-system-architect":["database-engineer","api-designer"],"frontend-ui-developer":["rapid-ui-designer","accessibility-specialist"],"test-generator":["debug-investigator","code-quality-reviewer"],"security-auditor":["security-layer-auditor"],"workflow-architect":["llm-integrator","data-pipeline-engineer"]},ar=[{test:t=>/permission denied/i.test(t)},{test:t=>/access denied/i.test(t)},{test:t=>/not found/i.test(t)&&/file|module|package/i.test(t)},{test:t=>/(?:file|module|package)\s+not\s+found/i.test(t)},{test:t=>/missing required/i.test(t)},{test:t=>/invalid (?:api|token|key)/i.test(t)},{test:t=>/authentication failed/i.test(t)},{test:t=>/quota exceeded/i.test(t)},{test:t=>/rate limit/i.test(t)}],cr=[/not my specialization/i,/outside my scope/i,/better suited for/i,/consider using/i,/specialized agent/i];function ur(t,e=sr){let n=e*2**(t-1),r=Math.random()*.1*n;return Math.min(n+r,ir)}function lr(t){for(let e of ar)if(e.test(t))return!1;return!0}function gr(t){for(let e of cr)if(e.test(t))return!0;return!1}function Dt(t,e=[]){let n=or[t];if(n){for(let r of n)if(!e.includes(r))return r}}function ke(t,e,n,r=[],s=rr){if(c("retry-manager",`Evaluating retry for ${t}, attempt ${e}`),e>=s){let o=Dt(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Max retries (${s}) exceeded`+(o?`. Consider trying ${o} instead.`:"")}}if(!lr(n)){let o=Dt(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Non-retryable error detected: ${n.slice(0,100)}`}}if(gr(n)){let o=Dt(t,r);if(o)return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Error suggests using alternative agent: ${o}`}}let i=ur(e);return{shouldRetry:!0,retryCount:e,maxRetries:s,delayMs:i,reason:`Retrying (attempt ${e+1}/${s}) after ${Math.round(i/1e3)}s`}}function Se(t,e,n){return{agent:t,taskId:n,attemptNumber:e,startedAt:new Date().toISOString()}}function _e(t,e,n){let r=new Date().toISOString(),s=new Date(r).getTime()-new Date(t.startedAt).getTime();return{...t,completedAt:r,outcome:e,error:n,durationMs:s}}function Ia(t){if(t.length===0)return{successRate:0,avgDuration:0,commonErrors:[]};let n=t.filter(a=>a.outcome==="success").length/t.length,r=t.filter(a=>a.durationMs!==void 0).map(a=>a.durationMs),s=r.length>0?r.reduce((a,u)=>a+u,0)/r.length:0,i=new Map;for(let a of t)if(a.error){let u=a.error.slice(0,50).toLowerCase();i.set(u,(i.get(u)||0)+1)}let o=Array.from(i.entries()).sort((a,u)=>u[1]-a[1]).slice(0,3).map(([a])=>a);return{successRate:n,avgDuration:s,commonErrors:o}}function wa(t,e){return{...t,status:"retrying",retryCount:e.retryCount}}function be(t,e){if(t.shouldRetry)return`## Retry Scheduled

Agent \`${e}\` will retry after ${Math.round((t.delayMs||0)/1e3)} seconds.

**Attempt:** ${t.retryCount+1} of ${t.maxRetries}
**Reason:** ${t.reason}`;let n=`## Retry Not Recommended

Agent \`${e}\` has ${t.retryCount>=t.maxRetries?"exhausted retries":"encountered a non-retryable error"}.

**Reason:** ${t.reason}`;return t.alternativeAgent&&(n+=`

### Alternative Suggestion

Consider using \`${t.alternativeAgent}\` instead:

\`\`\`
Task tool with subagent_type: "${t.alternativeAgent}"
\`\`\``),n}import{existsSync as Ie,readFileSync as dr,writeFileSync as pr,mkdirSync as mr}from"node:fs";import{createHash as fr}from"node:crypto";var xe=500,Ct=3,ve=15,$e=3,yr=.9;function we(){return`${g()}/.claude/feedback/calibration-data.json`}function hr(){let t=`${g()}/.claude/feedback`;if(!Ie(t))try{mr(t,{recursive:!0})}catch{}}function H(){let t=we();if(Ie(t))try{return JSON.parse(dr(t,"utf8"))}catch{c("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function kr(t){hr();let e=we();t.updatedAt=new Date().toISOString();try{pr(e,JSON.stringify(t,null,2)),c("calibration-engine","Saved calibration data")}catch(n){c("calibration-engine",`Failed to save calibration data: ${n}`)}}function Sr(t){return fr("sha256").update(t.toLowerCase().trim()).digest("hex").slice(0,16)}function Ra(t,e,n,r,s,i,o){let a=H(),u={timestamp:new Date().toISOString(),sessionId:S(),agent:e,promptHash:Sr(t),matchedKeywords:n,dispatchConfidence:r,outcome:s,durationMs:i,feedback:o};a.records.push(u),a.records.length>xe&&(a.records=a.records.slice(-xe)),_r(a,u),br(a),kr(a),c("calibration-engine",`Recorded outcome: ${e} -> ${s} (conf: ${r})`)}function _r(t,e){let n=e.outcome==="success",r=e.outcome==="failure"||e.outcome==="rejected";if(!n&&!r)return;let s=n?$e:-$e;for(let i of e.matchedKeywords){let o=t.adjustments.find(a=>a.keyword===i&&a.agent===e.agent);o?(o.adjustment=Math.max(-ve,Math.min(ve,o.adjustment+s)),o.sampleCount++,o.lastUpdated=new Date().toISOString()):t.adjustments.push({keyword:i,agent:e.agent,adjustment:s,sampleCount:1,lastUpdated:new Date().toISOString()})}}function Ea(t){let e=Date.now(),n=1440*60*1e3;for(let r of t.adjustments){let s=e-new Date(r.lastUpdated).getTime();Math.floor(s/n)>7&&(r.adjustment=Math.round(r.adjustment*yr),Math.abs(r.adjustment)<1&&(r.adjustment=0))}t.adjustments=t.adjustments.filter(r=>r.adjustment!==0)}function br(t){let e=t.records;if(e.length===0)return;t.stats.totalDispatches=e.length;let n=e.filter(i=>i.outcome==="success").length;t.stats.successRate=n/e.length;let r=e.reduce((i,o)=>i+o.dispatchConfidence,0)/e.length;t.stats.avgConfidence=Math.round(r);let s=new Map;for(let i of e){let o=s.get(i.agent)||{count:0,success:0};o.count++,i.outcome==="success"&&o.success++,s.set(i.agent,o)}t.stats.topAgents=Array.from(s.entries()).map(([i,o])=>({agent:i,count:o.count,successRate:o.success/o.count})).sort((i,o)=>o.count-i.count).slice(0,10)}function Oa(){return H().adjustments.filter(e=>e.sampleCount>=Ct)}function Pa(t){let n=H().records.filter(s=>s.agent===t);return n.length<Ct?null:n.filter(s=>s.outcome==="success").length/n.length}function ja(){return H().stats}function Ha(){return H().records.length>=Ct}import{existsSync as xr,statSync as vr}from"node:fs";import{resolve as $r}from"node:path";var Ir={"database-engineer":"database schema SQL PostgreSQL migration pgvector","backend-system-architect":"API REST architecture backend FastAPI microservice","frontend-ui-developer":"React frontend UI component TypeScript Tailwind","security-auditor":"security OWASP vulnerability audit authentication","test-generator":"testing unit integration coverage pytest MSW","workflow-architect":"LangGraph workflow agent orchestration state","llm-integrator":"LLM API OpenAI Anthropic embeddings RAG function-calling","data-pipeline-engineer":"data pipeline embeddings vector ETL chunking","metrics-architect":"metrics OKR KPI analytics instrumentation","ux-researcher":"UX user research persona journey accessibility","code-quality-reviewer":"code quality review linting type-check patterns","infrastructure-architect":"infrastructure cloud Docker Kubernetes deployment","ci-cd-engineer":"CI CD pipeline GitHub Actions deployment automation","accessibility-specialist":"accessibility WCAG ARIA screen-reader a11y","product-strategist":"product strategy roadmap features prioritization"};function wr(t){return Ir[t]||t}var Te=100;function W(t){c("graph-memory-inject","Graph memory inject hook starting");let e=$r(g(),".claude/memory/knowledge-graph.jsonl");if(!xr(e))return c("graph-memory-inject","No graph data file, skipping"),p();try{let u=vr(e).size;if(u<Te)return c("graph-memory-inject",`Graph too small (${u}B < ${Te}B), skipping`),p()}catch{return c("graph-memory-inject","Could not stat graph file, skipping"),p()}let r=(t.tool_input||{}).subagent_type||"";if(!r)return c("graph-memory-inject","No agent type detected, passing through"),p();let s=`ork:${r}`,i=wr(r);c("graph-memory-inject",`Detected agent type: ${r} (agent_id: ${s})`);let o=`[Graph Memory - Agent Context Load]

Execute this MCP call to load graph context for ${r} agent:

## Graph Memory Entities
\`\`\`
mcp__memory__search_nodes
{"query": "${r} ${i}"}
\`\`\`

## Integration Instructions
1. Execute the graph search to retrieve relevant entities and relationships
2. Review entities for patterns, decisions, and constraints
3. Check relationships between concepts
4. Apply learned patterns to current task

Agent ID: ${s} | Domain: ${i}`,a=`[Graph Memory] Agent: ${r} | ID: ${s} | Load graph context via MCP call above`;return c("graph-memory-inject",`Outputting graph memory instructions for ${r}`),{continue:!0,systemMessage:a,hookSpecificOutput:{additionalContext:o}}}import{existsSync as N,readFileSync as V,writeFileSync as Rt,mkdirSync as Tr}from"node:fs";import{dirname as Ar}from"node:path";var Dr=6,Cr=8,Rr=5,Er=/^(test-generator|backend-system-architect|workflow-architect|security-auditor|llm-integrator)$/;function Or(){let t=process.cwd();return t.includes(".claude/worktrees/")||t.includes("/.git/worktrees/")}function Pr(){return Or()?{maxBackground:10,maxPerResponse:12}:{maxBackground:Dr,maxPerResponse:Cr}}function Et(){return`${g()}/.claude/logs/agent-state.json`}function De(){return`${g()}/.claude/logs/subagent-spawns.jsonl`}function jr(){let t=Et(),e=Ar(t);try{Tr(e,{recursive:!0})}catch{}if(!N(t)){let n={active_background:[],session_total:0,last_cleanup:null,blocked_count:0};try{Rt(t,JSON.stringify(n,null,2))}catch{}}}function Hr(){let t=De();if(!N(t))return 0;try{let r=V(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),s=new Date(Date.now()-300*1e3).toISOString(),i=0;for(let o of r)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>s&&i++}catch{}return i}catch{return 0}}function Nr(){let t=De();if(!N(t))return 0;try{let r=V(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),s=new Date(Date.now()-2*1e3).toISOString(),i=0;for(let o of r)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>s&&i++}catch{}return i}catch{return 0}}function Mr(){let t=Et();try{if(N(t)){let e=JSON.parse(V(t,"utf8"));e.blocked_count=(e.blocked_count||0)+1,Rt(t,JSON.stringify(e,null,2))}}catch{}}function Ae(){let t=Et();try{if(N(t)){let e=JSON.parse(V(t,"utf8"));e.session_total=(e.session_total||0)+1,Rt(t,JSON.stringify(e,null,2))}}catch{}}function K(t){jr();let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"",s=e.run_in_background===!0||e.run_in_background==="true";c("context-gate",`Context gate check: ${n} (background=${s})`);let i=Hr(),o=Nr();c("context-gate",`Active background: ${i}, Current response: ${o}`);let a=Pr();return o>=a.maxPerResponse?(c("context-gate",`BLOCKED: Too many agents in single response (${o} >= ${a.maxPerResponse})`),vt(`Context Overflow Protection

Too many agents spawned in a single response (${o} agents).

Maximum allowed: ${a.maxPerResponse} per response

SOLUTION: Split into multiple responses or use sequential execution.
Consider using the /context-optimization skill first.

Attempted: ${n} - ${r}`)):s&&i>=a.maxBackground?(c("context-gate",`BLOCKED: Too many concurrent background agents (${i} >= ${a.maxBackground})`),Mr(),vt(`Background Agent Limit

Too many background agents running concurrently (${i} active).

Maximum allowed: ${a.maxBackground} concurrent background agents

SOLUTION:
1. Wait for existing agents to complete
2. Run this agent in foreground (remove run_in_background)
3. Use /context-optimization to free up context

Attempted: ${n} - ${r}`)):i>=Rr?(c("context-gate","WARNING: Approaching context budget limit"),Ae(),T(`Context Budget Warning

${i} background agents active (limit: ${a.maxBackground}).

Consider:
- Running remaining agents sequentially
- Using /context-optimization skill
- Waiting for current agents to complete

Proceeding with: ${n} - ${r}`)):Er.test(n)&&i>=2?(c("context-gate",`WARNING: Expensive agent type with multiple active: ${n}`),T(`Spawning expensive agent (${n}) with ${i} others active`)):(Ae(),c("context-gate",`Context gate passed: ${n}`),p())}import{existsSync as X,readFileSync as Ot,readdirSync as Lr}from"node:fs";import{homedir as Fr}from"node:os";import{join as Ce}from"node:path";function Ur(){return`${g()}/.claude/context/session/state.json`}function Br(){return`${g()}/.claude/context/knowledge/decisions/active.json`}function qr(){return`${g()}/docs/issues`}function Gr(){let t=Ur();if(!X(t))return{count:0,summary:""};try{let n=JSON.parse(Ot(t,"utf8")).tasks_pending||[],r=n.length;if(r===0)return{count:0,summary:""};let s=n.slice(0,5).map(i=>`- ${i}`).join(`
`);return{count:r,summary:s}}catch{return{count:0,summary:""}}}function Re(t,e){let n=Br();if(!X(n))return"";try{return(JSON.parse(Ot(n,"utf8")).decisions||[]).filter(o=>o.category===e||o.category==="api"||o.category==="database").slice(0,8).map(o=>`- ${o.title} (${o.status||"unknown"})`).join(`
`)}catch{return""}}function Jr(t){let e=qr();if(!X(e))return"";try{let r=Lr(e).find(s=>s.includes(t));if(r)return`docs/issues/${r}`}catch{}return""}function zr(){let t=[],e=Ce(Fr(),".claude","CLAUDE.md"),n=Ee(e);if(n){let o=Oe(n,"global");t.push(...o)}let r=Ce(g(),"CLAUDE.md"),s=Ee(r);if(s){let o=Oe(s,"project");t.push(...o)}return t.length===0?"":`CRITICAL RULES (inherited from CLAUDE.md):
${[...new Set(t)].slice(0,12).map(o=>`- ${o}`).join(`
`)}

`}function Ee(t){try{return X(t)?Ot(t,"utf8"):""}catch{return""}}function Oe(t,e){let n=[],r=t.split(`
`);for(let s of r){let i=s.trim();if(!(!i||i.startsWith("#")||i.startsWith("```"))){if(/^[-*]\s+/.test(i)){let o=i.replace(/^[-*]\s+/,"").trim();if(/\b(always|never|must|don't|do not|required|NEVER|MUST|DON'T)\b/i.test(o)){let a=o.length>80?`${o.substring(0,77)}...`:o;n.push(a)}}if(/^\*\*(DO|DON'T|DO NOT)\*\*:/.test(i)){let o=i.replace(/\*\*/g,"").trim();o.length<=80&&n.push(o)}}}return n}function Q(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.task_description||e.description||"";c("subagent-context-stager",`Staging context for ${n}`);let s="",i=zr();i&&(s+=i,c("subagent-context-stager","Injected critical rules from CLAUDE.md"));let{count:o,summary:a}=Gr();o>0&&(c("subagent-context-stager",`Found ${o} pending tasks`),s+=`ACTIVE TODOS:
${a}

`);let u=r.toLowerCase();if(/backend|api|endpoint|database|migration/.test(u)){c("subagent-context-stager","Backend task detected - staging backend decisions");let l=Re(r,"backend");l&&(s+=`RELEVANT DECISIONS:
${l}

`)}if(/frontend|react|ui|component/.test(u)){c("subagent-context-stager","Frontend task detected - staging frontend decisions");let l=Re(r,"frontend");l&&(s+=`RELEVANT DECISIONS:
${l}

`)}if(/test|testing|pytest|jest/.test(u)&&(c("subagent-context-stager","Testing task detected - staging test context"),s+=`TESTING REMINDERS:
- Use 'tee' for visible test output
- Check test patterns in backend/tests/ or frontend/src/**/__tests__/
- Ensure coverage meets threshold requirements

`),/issue|#\d+|bug|fix/.test(u)){c("subagent-context-stager","Issue-related task detected");let l=r.match(/#(\d+)/);if(l){let d=l[1],m=Jr(d);m&&(s+=`ISSUE DOCS: ${m}

`,c("subagent-context-stager",`Staged issue documentation for #${d}`))}}if(s){let l=`${s}
Task: ${r}
Subagent: ${n}`,d=s.split(`
`).filter(Boolean).length;return c("subagent-context-stager",`Staged context with ${d} lines`),{continue:!0,systemMessage:l}}return c("subagent-context-stager","No context staged for this task"),p()}import{existsSync as M,readFileSync as Pt,mkdirSync as Wr,readdirSync as Vr}from"node:fs";import{join as v,dirname as Kr}from"node:path";var Xr=new Set(["general-purpose","Explore","Plan","claude-code-guide","statusline-setup","Bash"]);function Qr(){return v(g(),".claude","logs","subagent-spawns.jsonl")}function Yr(){return v(g(),"plugin.json")}function jt(){return v(g(),"agents")}function Ht(){return v(g(),".claude","agents")}function Zr(){return v(g(),"skills")}function ts(){let t=new Set(Xr),e=Yr();if(M(e))try{let s=JSON.parse(Pt(e,"utf8")).agents||[];for(let i of s)i.id&&t.add(i.id)}catch{}let n=[jt(),Ht()];for(let r of n)if(M(r))try{let s=Vr(r);for(let i of s)i.endsWith(".md")&&t.add(i.replace(".md",""))}catch{}return t}function es(t){let e=[],n=[v(jt(),`${t}.md`),v(Ht(),`${t}.md`)],r=null;for(let s of n)if(M(s)){r=s;break}if(!r)return e;try{let i=Pt(r,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of i){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^skills:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let l=u.match(/^\s*-\s*(.+)$/);if(l){let d=l[1].trim();e.push(d)}}}}}catch{}return e}function ns(t){let e=es(t),n=[],r=Zr();for(let s of e){let i=v(r,s,"SKILL.md");M(i)||n.push(s)}return n}function rs(t){let e=[],n=[v(jt(),`${t}.md`),v(Ht(),`${t}.md`)],r=null;for(let s of n)if(M(s)){r=s;break}if(!r)return e;try{let i=Pt(r,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of i){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^tools:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let l=u.match(/^\s*-\s*(.+)$/);l&&e.push(l[1].trim())}}}}catch{}return e}function ss(t,e){if(e.length===0)return"";let n=e.every(o=>["Read","Glob","Grep"].includes(o)),r=e.includes("Bash"),s=e.includes("Write")||e.includes("Edit"),i="low";return r&&s?i="elevated":(r||s)&&(i="moderate"),`## Agent Permission Profile (CC 2.1.20)

**Agent**: \`${t}\`
**Tools**: ${e.join(", ")}
**Risk Level**: ${i}${n?" (read-only)":""}

${r?`> This agent requests Bash access. Review commands carefully.
`:""}`}function is(t,e,n){let r=Qr(),s=Kr(r);try{Wr(s,{recursive:!0})}catch{}let i={timestamp:new Date().toISOString(),subagent_type:t,description:e,session_id:n};try{h(r,`${JSON.stringify(i)}
`)}catch{}}function Y(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"",s=t.session_id;c("subagent-validator",`Task invocation: ${n} - ${r}`),is(n,r,s);let i=n.replace(/^[^:]+:/,""),o=ts();!o.has(n)&&!o.has(i)&&c("subagent-validator",`WARNING: Unknown subagent type: ${n}`),c("subagent-validator",`Spawning ${n} agent: ${r}`);let a=ns(i);if(a.length>0){let l=a.join(", ");c("subagent-validator",`WARNING: Agent '${i}' references missing skills: ${l}`),console.error(`Warning: Agent '${i}' references ${a.length} missing skill(s): ${l}`)}let u=rs(i);if(u.length>0){let l=ss(i,u);return c("subagent-validator",`Agent '${i}' tools: ${u.join(", ")}`),G(l)}return p()}import{mkdirSync as os,existsSync as Nt,readFileSync as Mt}from"node:fs";import{join as Z,dirname as as}from"node:path";var cs=[/security|vulnerab|audit|penetration/i,/architect|design.*system|distributed/i,/migration.*schema|database.*design/i,/performance.*optim|profil|bottleneck/i,/langgraph|workflow.*orchestrat/i],us=[/\b(?:list|count|check|verify|read|search)\b/i,/\b(?:simple|straightforward|quick)\b/i,/\b(?:format|lint|style|typo|rename)\b/i,/\b(?:status|progress|summary)\b/i],D=new Map,I=new Map;function Lt(t){if(D.has(t))return D.get(t);let e=q();if(!e)return D.set(t,"inherit"),"inherit";let n=Z(e,"agents",`${t}.md`);if(!Nt(n))return D.set(t,"inherit"),"inherit";try{let s=Mt(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!s)return D.set(t,"inherit"),"inherit";let i=s[1].match(/^model:\s*(.+)$/m),o=i?i[1].trim():"inherit";return D.set(t,o),o}catch{return D.set(t,"inherit"),"inherit"}}function ls(t){if(I.has(t))return I.get(t);let e=q();if(!e)return I.set(t,null),null;let n=Z(e,"agents",`${t}.md`);if(!Nt(n))return I.set(t,null),null;try{let s=Mt(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!s)return I.set(t,null),null;let i=s[1].match(/^skills:\s*\n((?:\s+-\s+.+\n)*)/m);if(!i)return I.set(t,null),null;let o=i[1].match(/^\s+-\s+(.+)$/gm)?.map(l=>l.trim().replace(/^-\s+/,""))||[];if(o.length===0)return I.set(t,null),null;let a={low:0,medium:1,high:2},u="low";for(let l of o.slice(0,5)){let d=Z(e,"skills",l,"SKILL.md");if(!Nt(d))continue;let f=Mt(d,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!f)continue;let b=f[1].match(/^complexity:\s*(low|medium|high)$/m);if(b){let y=b[1];a[y]>a[u]&&(u=y)}}return I.set(t,u),u}catch{return I.set(t,null),null}}function Pe(t,e){let n=ls(t);if(n==="high")return"high";let r=cs.filter(o=>o.test(e)).length,s=Lt(t);return r>=2||s==="opus"?"high":us.filter(o=>o.test(e)).length>=2?"low":n||"medium"}function je(t){let e=Lt(t);return e==="inherit"?process.env.CLAUDE_MODEL||"sonnet":e}function gs(t,e){let n=Pe(t,e),r=je(t);return n==="high"&&r==="haiku"?{recommended:"sonnet",current:r,reason:"High-complexity task \u2014 haiku may produce lower quality results",savingsPercent:0}:n==="low"&&r==="opus"?{recommended:"sonnet",current:r,reason:"Simple task \u2014 sonnet handles this equally well at lower cost",savingsPercent:40}:n==="medium"&&r==="opus"&&Lt(t)!=="opus"?{recommended:"sonnet",current:r,reason:"Medium-complexity task \u2014 sonnet is sufficient",savingsPercent:30}:null}function ds(t,e,n,r){let s=Z(g(),".claude","logs","model-usage.jsonl");try{os(as(s),{recursive:!0}),h(s,`${JSON.stringify({timestamp:new Date().toISOString(),agent:t,model:e,complexity:n,recommendation:r?.recommended||null,potentialSavings:r?.savingsPercent||0})}
`)}catch{}}function tt(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"";if(!n)return p();let s=Pe(n,r),i=je(n),o=gs(n,r);return ds(n,i,s,o),o?(c("model-cost-advisor",`${n}: Recommend ${o.recommended} over ${o.current} (${o.reason})`,"info"),o.savingsPercent>=30?T(`Model cost: ${n} using ${o.current} for ${s}-complexity task. ${o.reason}. ~${o.savingsPercent}% savings with "${o.recommended}".`):p()):(c("model-cost-advisor",`${n}: ${i} appropriate for ${s} task`),p())}import{existsSync as ps,readFileSync as ms,writeFileSync as fs,statSync as ys,mkdirSync as hs}from"node:fs";import{execFileSync as ks}from"node:child_process";import{tmpdir as Ss}from"node:os";import{join as Ft}from"node:path";var Ut=Ft(Ss(),"orchestkit-issue-cache"),_s=300*1e3,bs=3e3;function xs(t){let e=t.match(/^(?:issue|fix|feat|bug|hotfix|feature)\/(\d+)/)||t.match(/^(\d+)-/);return e?e[1]:null}function vs(){try{hs(Ut,{recursive:!0,mode:448})}catch{}}function $s(t){let e=Ft(Ut,`${t}.json`);try{if(!ps(e))return null;let n=ys(e);return Date.now()-n.mtimeMs>_s?null:JSON.parse(ms(e,"utf8"))}catch{return null}}function Is(t,e){if(!/^\d+$/.test(t))return null;try{let n=ks("gh",["issue","view",t,"--json","title,body,labels"],{cwd:e,encoding:"utf8",timeout:bs,stdio:["pipe","pipe","pipe"]}).trim(),r=JSON.parse(n);try{vs();let s=Ft(Ut,`${t}.json`);fs(s,JSON.stringify(r),"utf8")}catch{}return r}catch{return null}}function ws(t,e){let n=[];if(e?.title?n.push(`Working on GitHub Issue #${t}: ${e.title}`):n.push(`Working on GitHub Issue #${t}`),e?.labels&&e.labels.length>0){let r=e.labels.map(s=>s.name).join(", ");n.push(`Labels: ${r}`)}return n.push(`Reference #${t} in all commits. Use 'Closes #${t}' in PR description.`),n.join(`
`)}function et(t){try{let e=g(),n=le(e);c("issue-context-injector",`Branch: ${n}`);let r=xs(n);if(!r)return c("issue-context-injector","No issue number in branch name"),p();c("issue-context-injector",`Detected issue #${r}`);let s=$s(r)??Is(r,e),i=ws(r,s);return c("issue-context-injector",`Injecting context for issue #${r}`),{continue:!0,systemMessage:i}}catch{return c("issue-context-injector","Unexpected error, falling back to silent success","warn"),p()}}var C="subagent-start-dispatcher",He=800,Ts=[{name:"subagent-context-stager",fn:Q},{name:"graph-memory-inject",fn:W},{name:"model-cost-advisor",fn:tt},{name:"issue-context-injector",fn:et}];function Ne(t){try{let u=K(t);if(!u.continue)return c(C,"context-gate blocked agent spawn"),u}catch(u){let l=u instanceof Error?u.message:String(u);c(C,`context-gate failed: ${l}`,"warn")}let e=null;try{let u=Y(t);e=J(u)}catch(u){let l=u instanceof Error?u.message:String(u);c(C,`subagent-validator failed: ${l}`,"warn")}let n=[],r=[],s=0;if(e){let u=z(e);n.push(e),s+=u}for(let u of Ts)try{let l=u.fn(t);l.systemMessage&&typeof l.systemMessage=="string"&&r.push(l.systemMessage);let d=l.hookSpecificOutput?.additionalContext;if(d){let m=z(d);if(s+m>He){c(C,`Budget limit: skipping ${u.name} (${m}t would exceed ${He}t cap)`);continue}n.push(d),s+=m,c(C,`${u.name}: +${m}t (total: ${s}t)`)}}catch(l){let d=l instanceof Error?l.message:String(l);c(C,`${u.name} failed: ${d}`,"warn")}let i=n.length>0,o=r.length>0;if(!i&&!o)return p();let a={continue:!0};if(o&&(a.systemMessage=r.join(`

`)),i){let u=n.join(`

---

`);c(C,`Consolidated ${n.length} hooks into ${s}t`),a.hookSpecificOutput={additionalContext:u}}return a}import{existsSync as As,mkdirSync as Ds,unlinkSync as Cs}from"node:fs";import{basename as Rs,dirname as Es}from"node:path";var Os=["decided to","chose","implemented using","selected","opted for","will use","pattern:","approach:","architecture:","recommends","best practice","anti-pattern","learned that"],Ps="decisions";function js(){return`${g()}/.claude/logs/agent-patterns.jsonl`}function Hs(){return`${g()}/.claude/session`}function Me(){let t=g();return(Rs(t)||"default-project").toLowerCase().replace(/ /g,"-").replace(/[^a-z0-9-]/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-")}function Ns(t){return`${Me()}-${t}`}function Ms(t){let r=(t.length>10240?t.substring(0,10240):t).toLowerCase();return/pagination|cursor|offset/.test(r)?"pagination":/security|vulnerability|exploit|injection|xss|csrf|owasp|safety|guardrail/.test(r)?"security":/database|sql|postgres|schema/.test(r)?"database":/\bapi\b|endpoint|\brest\b|graphql/.test(r)?"api":/auth|login|jwt|oauth/.test(r)?"authentication":/\btest\b|testing|pytest|jest|vitest|coverage|\bmock\b|fixture|\bspec\b/.test(r)?"testing":/deploy|\bci\b|\bcd\b|pipeline|docker|kubernetes|helm|terraform/.test(r)?"deployment":/observability|monitoring|logging|tracing|metrics|prometheus|grafana|langfuse/.test(r)?"observability":/react|component|frontend|\bui\b/.test(r)?"frontend":/performance|optimization|cache|index/.test(r)?"performance":/llm|\brag\b|embedding|vector|semantic|\bai\b|\bml\b|langchain|langgraph|openai|anthropic/.test(r)?"ai-ml":/etl|streaming|dataflow|spark/.test(r)||$t(r,"data","pipeline")||$t(r,"batch","processing")?"data-pipeline":/architecture|design|structure/.test(r)?"architecture":/decided|chose|selected/.test(r)?"decision":"pattern"}function Ls(t){let e=[];if(t.length<50)return e;for(let r of Os){let s=r.toLowerCase(),i=t.split(`
`).filter(o=>o.toLowerCase().includes(s));for(let o of i){let a=o.trim().substring(0,200);a.length>20&&e.push(a)}}return[...new Set(e)].slice(0,5)}function nt(t){c("agent-memory-store","Agent memory store hook starting");let e=t.tool_input||{},n=t.subagent_type||e.subagent_type||e.type||"",r=t.tool_result,s=typeof r=="string"?r:r?.content||t.agent_output||t.output||"",i=!0;if(t.error&&(i=!1),typeof r=="object"&&r?.is_error&&(i=!1),!n)return c("agent-memory-store","No agent type in input, skipping"),p();let o=`ork:${n}`,a=`${Hs()}/current-agent-id`;try{As(a)&&Cs(a)}catch{}c("agent-memory-store",`Processing completion for agent: ${n} (agent_id: ${o}, success: ${i})`);let u=i&&s?Ls(s):[];if(u.length===0)return c("agent-memory-store",`No patterns extracted from ${n} output`),p();let l=js(),d=Es(l);try{Ds(d,{recursive:!0})}catch{}let m=Me(),f=new Date().toISOString(),b=Ns(Ps);for(let k of u){let F=Ms(k),Yt={agent:n,agent_id:o,pattern:k,project:m,timestamp:f,scope_id:b,category:F,pending_graph_sync:!0};try{h(l,`${JSON.stringify(Yt)}
`)}catch{}c("agent-memory-store",`Extracted pattern (${F}): ${k.substring(0,50)}...`)}return c("agent-memory-store",`Extracted ${u.length} patterns from ${n} output`),{continue:!0,systemMessage:`[Pattern Extraction] ${u.length} patterns extracted from ${n}. To persist, use mcp__memory__create_entities with entities: [{"name": "${n}-pattern", "entityType": "Pattern", "observations": ["<pattern>"]}]`}}import{existsSync as Fs,writeFileSync as Le,mkdirSync as Bt,readFileSync as Us}from"node:fs";import{dirname as Bs}from"node:path";var qs=[".env","credentials","secret","auth","password","token","api.key","private.key",".pem","oauth","jwt","session","cookie","encryption","crypto"];function Gs(){let t=`${g()}/.claude/hooks/logs`;try{Bt(t,{recursive:!0})}catch{}return`${t}/auto-spawn-quality.log`}function Js(){return`${g()}/.claude/context/spawn-queue.json`}function x(t){let e=Gs(),n=new Date().toISOString();try{h(e,`[${n}] [auto-spawn-quality] ${t}
`)}catch{}}function zs(t){let e=t.toLowerCase();for(let n of qs)if(e.includes(n))return x(`Detected sensitive pattern: ${n}`),!0;return!1}function Ws(t,e,n,r,s,i){let o=`SPAWN-${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,14)}-${Math.floor(Math.random()*1e4).toString().padStart(4,"0")}`,a=Js(),u=Bs(a);try{Bt(u,{recursive:!0})}catch{}let l;if(Fs(a))try{l=JSON.parse(Us(a,"utf8"))}catch{l={schema_version:"1.0.0",created_at:i,queue:[]}}else l={schema_version:"1.0.0",created_at:i,queue:[]};let d={spawn_id:o,target_agent:e,trigger_agent:t,trigger_reason:n,priority:r,timestamp:i,session_id:s,status:"queued"};l.queue.push(d);try{Le(a,JSON.stringify(l,null,2)),x(`Queued spawn request: ${o} for ${e} (reason: ${n})`)}catch{return x(`ERROR: Failed to queue spawn request for ${e}`),""}return o}function Vs(t,e,n,r,s,i){let o=`${g()}/.claude/context/handoffs`;try{Bt(o,{recursive:!0})}catch{}let a=`${o}/auto_spawn_${e}_${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,15)}.json`,u={type:"auto_spawn_suggestion",from_agent:t,to_agent:e,timestamp:i,trigger_reason:n,priority:r,session_id:s,auto_triggered:!0,status:"suggested"};try{Le(a,JSON.stringify(u,null,2)),x(`Created spawn suggestion: ${e} (reason: ${n})`)}catch{}}function Ks(t,e,n){if(n&&n!=="null")return x(`Skipping auto-spawn - agent ${t} had errors: ${n}`),null;if(t==="test-generator")return x("Rule matched: test-generator -> code-quality-reviewer"),{target:"code-quality-reviewer",reason:"test-generator completed - validating test quality and coverage",priority:"high"};if(zs(e)&&t!=="security-auditor"&&t!=="security-layer-auditor")return x("Rule matched: sensitive files detected -> security-auditor"),{target:"security-auditor",reason:"sensitive file changes detected - security audit required",priority:"critical"};if(t==="code-quality-reviewer")return x("Rule matched: code-quality-reviewer -> security-auditor"),{target:"security-auditor",reason:"code-quality-reviewer completed - proceeding with security scan",priority:"high"};if(t==="backend-system-architect"){let r=e.toLowerCase();if(/authentication|authorization|security|access.control|rbac|acl/.test(r))return x("Rule matched: backend-system-architect with auth -> security-layer-auditor"),{target:"security-layer-auditor",reason:"backend-system-architect designed auth/security layer - validation required",priority:"high"}}return null}function rt(t){let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",s=t.session_id,i=t.agent_output||t.output||"",o=t.error||"";if(x(`Checking auto-spawn conditions for agent: ${r} (session: ${s})`),r==="unknown"||!r)return x("Skipping unknown agent type"),p();let a=Ks(r,i,o);if(a){let u=Ws(r,a.target,a.reason,a.priority,s,e);return Vs(r,a.target,a.reason,a.priority,s,e),x(`=== AUTO-SPAWN QUALITY HOOK ===
Trigger Agent: ${r}
Target Agent: ${a.target}
Reason: ${a.reason}
Priority: ${a.priority}
Spawn ID: ${u}
Timestamp: ${e}
Session: ${s}`),{continue:!0,systemMessage:`Auto-spawn queued: ${a.target} (${a.priority} priority)`}}return x(`No auto-spawn conditions matched for ${r}`),p()}import{existsSync as Xs,writeFileSync as Ge,mkdirSync as Qs,readFileSync as Ys}from"node:fs";import{dirname as qt}from"node:path";function Fe(){return`${g()}/.claude/context/knowledge/decisions/active.json`}function Zs(){return`${g()}/.claude/context/session/state.json`}function ti(){return`${g()}/.claude/logs/agent-context`}function st(t){try{Qs(t,{recursive:!0})}catch{}}function Ue(t,e){if(!Xs(t))return e;try{return JSON.parse(Ys(t,"utf8"))}catch{return e}}function Be(t,e){let n=qt(t);st(n);try{Ge(t,JSON.stringify(e,null,2))}catch{}}var qe=50;function it(t){let e=t.subagent_type||t.agent_type||"unknown",n=new Date().toISOString(),r=t.agent_output||t.output||"",s=r.substring(0,200);r.length>200&&(s+="...");let i=e!=="unknown"||s.trim().length>0,o=e.replace(/-/g,"_");if(i){let k=Fe(),F=qt(k);st(F);let O=Ue(k,{schema_version:"2.0.0",decisions:{}});(!O.decisions||typeof O.decisions!="object")&&(O.decisions={});let _n={timestamp:n,agent:e,summary:s,status:"completed"};O.decisions[o]=_n,Be(k,O)}let a=Zs(),u=qt(a);st(u);let d=Ue(a,{schema_version:"2.0.0",session_id:"",started_at:n,last_activity:n,active_agent:null,tasks_pending:[],tasks_completed:[]});if(Array.isArray(d.tasks_completed)||(d.tasks_completed=[]),Array.isArray(d.tasks_pending)||(d.tasks_pending=[]),i){let k={agent:e,timestamp:n,summary:s};d.tasks_completed.push(k),d.tasks_completed.length>qe&&(d.tasks_completed=d.tasks_completed.slice(-qe))}d.last_activity=n,d.active_agent=null,Be(a,d);let m=ti();st(m);let f=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),b=`${m}/${e}_${f}.log`,y=`=== CONTEXT PUBLICATION (Protocol 2.0) ===
Agent: ${e}
Timestamp: ${n}
Decisions file: ${Fe()}
Session state: ${a}

=== AGENT OUTPUT ===
${r}
`;try{Ge(b,y)}catch{}return p()}import{existsSync as oi,writeFileSync as Ke,mkdirSync as zt,readFileSync as ai}from"node:fs";import{dirname as ci}from"node:path";import{existsSync as Je,readFileSync as ei,writeFileSync as ni,mkdirSync as ri}from"node:fs";function ze(){let t=S();return`${g()}/.claude/orchestration/task-registry-${t}.json`}function si(){let t=`${g()}/.claude/orchestration`;if(!Je(t))try{ri(t,{recursive:!0})}catch{}}function Gt(){let t=ze();if(Je(t))try{return JSON.parse(ei(t,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:S(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function ii(t){si();let e=ze();t.updatedAt=new Date().toISOString();try{ni(e,JSON.stringify(t,null,2))}catch(n){c("task-integration",`Failed to save registry: ${n}`)}}function ot(t,e){let n=Gt(),r=n.tasks.find(s=>s.taskId===t);r&&(r.status=e,ii(n),c("task-integration",`Updated task ${t} status to ${e}`))}function at(t){return Gt().tasks.find(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function We(){return Gt().pipelines.find(e=>e.status==="running")}function Jt(){return!!(process.env.CLAUDE_CODE_TEAM_NAME||process.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS==="1")}var Ve=[{type:"product-thinking",name:"Product Thinking Pipeline",description:"Full product discovery and specification workflow",triggers:["should we build","product decision","feature validation","market research","user research"],steps:[{agent:"market-intelligence",description:"Analyze competitive landscape and market trends",dependsOn:[],skills:["market-research"],estimatedTokens:3e3},{agent:"ux-researcher",description:"Create personas and map user journeys",dependsOn:[0],skills:["user-research"],estimatedTokens:2500},{agent:"product-strategist",description:"Validate value proposition and alignment",dependsOn:[0,1],skills:["product-strategy"],estimatedTokens:2e3},{agent:"prioritization-analyst",description:"Score and prioritize using frameworks",dependsOn:[2],skills:["prioritization"],estimatedTokens:1500},{agent:"business-case-builder",description:"Build ROI and cost-benefit analysis",dependsOn:[2,3],skills:["business-case"],estimatedTokens:2e3},{agent:"requirements-translator",description:"Transform to PRD and user stories",dependsOn:[4],skills:["requirements"],estimatedTokens:2500}],estimatedTotalTokens:13500},{type:"full-stack-feature",name:"Full-Stack Feature Pipeline",description:"End-to-end feature implementation workflow",triggers:["full-stack feature","build a feature","implement end-to-end","create full feature","add complete feature"],steps:[{agent:"backend-system-architect",description:"Design API and database schema",dependsOn:[],skills:["api-design","database-patterns"],estimatedTokens:3e3},{agent:"frontend-ui-developer",description:"Build React components and UI",dependsOn:[0],skills:["react-server-components-framework","form-state-patterns"],estimatedTokens:3500},{agent:"test-generator",description:"Create unit and integration tests",dependsOn:[0,1],skills:["testing-patterns"],estimatedTokens:2e3},{agent:"security-auditor",description:"Audit for vulnerabilities",dependsOn:[0,1],skills:["security-patterns"],estimatedTokens:1500}],estimatedTotalTokens:1e4},{type:"ai-integration",name:"AI Integration Pipeline",description:"Add AI/LLM capabilities to application",triggers:["add rag","add llm","ai integration","implement rag","add ai feature","langgraph workflow"],steps:[{agent:"workflow-architect",description:"Design LangGraph workflow and state",dependsOn:[],skills:["langgraph"],estimatedTokens:2500},{agent:"llm-integrator",description:"Connect LLM APIs with function calling",dependsOn:[0],skills:["llm-integration"],estimatedTokens:2e3},{agent:"data-pipeline-engineer",description:"Build embeddings and data pipeline",dependsOn:[0],skills:["embeddings","rag-retrieval"],estimatedTokens:2500},{agent:"test-generator",description:"Create LLM testing infrastructure",dependsOn:[1,2],skills:["testing-patterns"],estimatedTokens:1500}],estimatedTotalTokens:8500},{type:"security-audit",name:"Security Audit Pipeline",description:"Comprehensive security review workflow",triggers:["security audit","security review","vulnerability scan","security assessment"],steps:[{agent:"security-auditor",description:"Scan for OWASP Top 10 vulnerabilities",dependsOn:[],skills:["security-patterns"],estimatedTokens:2e3},{agent:"security-layer-auditor",description:"Verify defense-in-depth layers",dependsOn:[0],skills:["security-patterns"],estimatedTokens:2e3},{agent:"ai-safety-auditor",description:"Audit AI/LLM security if applicable",dependsOn:[0],skills:["mcp-security-hardening"],estimatedTokens:1500}],estimatedTotalTokens:5500},{type:"frontend-compliance",name:"Frontend 2026 Compliance Pipeline",description:"Modernize frontend to 2026 patterns",triggers:["frontend compliance","modernize frontend","update react","frontend 2026"],steps:[{agent:"frontend-ui-developer",description:"Upgrade to React 19 patterns",dependsOn:[],skills:["react-server-components-framework","zustand-patterns"],estimatedTokens:3e3},{agent:"frontend-performance-engineer",description:"Optimize Core Web Vitals",dependsOn:[0],skills:["performance"],estimatedTokens:2e3},{agent:"accessibility-specialist",description:"Ensure WCAG 2.2 compliance",dependsOn:[0],skills:["testing-patterns","accessibility"],estimatedTokens:1500}],estimatedTotalTokens:6500}];function ui(){return`${g()}/.claude/coordination/decision-log.json`}function li(){let t=`${g()}/.claude/hooks/logs`;try{zt(t,{recursive:!0})}catch{}return`${t}/agent-feedback.log`}function w(t){let e=li(),n=new Date().toISOString();try{h(e,`[${n}] [feedback-loop] ${t}
`)}catch{}}function gi(t){let e=We();if(e){let r=Ve.find(s=>s.type===e.type);if(r){let s=r.steps.findIndex(i=>i.agent===t);if(s>=0){let i=r.steps.filter((o,a)=>o.dependsOn.includes(s)&&a>s).map(o=>o.agent);if(i.length>0)return i.join(" ")}}}return{"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"test-generator","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer"}[t]||""}function di(t){return{"market-intelligence":"product-thinking","product-strategist":"product-thinking","prioritization-analyst":"product-thinking","business-case-builder":"product-thinking","requirements-translator":"specification","metrics-architect":"specification","backend-system-architect":"architecture","database-engineer":"architecture","data-pipeline-engineer":"architecture","frontend-ui-developer":"frontend","rapid-ui-designer":"frontend","ux-researcher":"frontend","test-generator":"quality","code-quality-reviewer":"quality","security-auditor":"security","security-layer-auditor":"security","workflow-architect":"ai-integration","llm-integrator":"ai-integration","debug-investigator":"debugging"}[t]||"general"}function pi(){return process.env.CLAUDE_INSTANCE_ID||`${yt("node:os").hostname()}-${process.pid}`}function mi(t){let e=t.substring(0,500);return t.length>500&&(e+="..."),e}function fi(t,e,n,r,s,i,o,a){let u=ui(),l=ci(u);try{zt(l,{recursive:!0})}catch{}let d;if(oi(u))try{d=JSON.parse(ai(u,"utf8"))}catch{d={schema_version:"2.0.0",log_created_at:o,decisions:[]}}else d={schema_version:"2.0.0",log_created_at:o,decisions:[]};let m={decision_id:t,timestamp:o,made_by:{instance_id:pi(),agent_type:e},category:n,title:`Agent ${e} completed`,description:r,impact:{scope:"agent-pipeline",downstream_agents:s.split(" ").filter(Boolean)},status:i,task_id:a};d.decisions.push(m);try{Ke(u,JSON.stringify(d,null,2)),w(`Decision ${t} logged for agent ${e}`)}catch{w("ERROR: Failed to write decision to log")}}function yi(t,e,n,r,s,i,o){if(!e)return;let a=`${g()}/.claude/context/handoffs`;try{zt(a,{recursive:!0})}catch{}let u=e.split(" ").filter(Boolean),l=new Date().toISOString().replace(/[-:]/g,"").substring(0,15);for(let d of u){let m=`${a}/${t}_to_${d}_${l}.json`,f={from_agent:t,to_agent:d,timestamp:i,decision_id:r,summary:n,session_id:s,status:"pending",feedback_loop:!0,task_id:o};try{Ke(m,JSON.stringify(f,null,2)),w(`Created handoff context: ${t} -> ${d}`)}catch{}}}function ct(t){if(Jt())return p();let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",s=t.session_id,i=t.agent_output||t.output||"",o=t.error||"";if(w(`Processing feedback for agent: ${r} (session: ${s})`),r==="unknown"||!r)return w("Skipping unknown agent type"),p();let a=new Date().toISOString().replace(/[-:T.]/g,"").substring(0,8),u=Math.floor(Math.random()*1e4).toString().padStart(4,"0"),l=`DEC-${a}-${u}`,m=at(r)?.taskId,f=gi(r),b=di(r),y,k;return o&&o!=="null"?(y=`Agent failed: ${o}`,k="failed"):(y=mi(i),k="completed"),m&&(ot(m,k==="completed"?"completed":"failed"),w(`Updated task ${m} status to ${k}`)),fi(l,r,b,y,f,k,e,m),f?(yi(r,f,y,l,s,e,m),w(`Routed findings to downstream agents: ${f}`)):w(`No downstream agents for ${r} (terminal agent)`),w(`=== AGENT FEEDBACK LOOP ===
Agent: ${r}
Category: ${b}
Decision ID: ${l}
Task ID: ${m||"none"}
Timestamp: ${e}
Status: ${k}
Downstream: ${f||"none"}

Summary: ${y}`),f?{continue:!0,systemMessage:`Feedback loop: routed to ${f}${m?` (task: ${m})`:""}`}:p()}import{writeFileSync as Xe,mkdirSync as Qe}from"node:fs";var hi=new Set(["market-intelligence","product-strategist","prioritization-analyst","business-case-builder","requirements-translator","metrics-architect","backend-system-architect","code-quality-reviewer","data-pipeline-engineer","database-engineer","debug-investigator","frontend-ui-developer","llm-integrator","rapid-ui-designer","security-auditor","security-layer-auditor","system-design-reviewer","test-generator","ux-researcher","workflow-architect"]),ki={"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"code-quality-reviewer","code-quality-reviewer":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"code-quality-reviewer","database-engineer":"backend-system-architect","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer","security-auditor":"none","security-layer-auditor":"none","debug-investigator":"none","system-design-reviewer":"none"},Si={"market-intelligence":"Next: product-strategist should define product vision based on market analysis","product-strategist":"Next: prioritization-analyst should rank features from strategy","prioritization-analyst":"Next: business-case-builder should create ROI justification","business-case-builder":"Next: requirements-translator should convert to technical specs","requirements-translator":"Next: metrics-architect should define success criteria","metrics-architect":"Next: backend-system-architect should design API endpoints","backend-system-architect":"Next: frontend-ui-developer should build UI components","frontend-ui-developer":"Next: test-generator should create test coverage","test-generator":"Next: code-quality-reviewer should validate implementation","code-quality-reviewer":"Next: security-auditor should perform security scan","workflow-architect":"Next: llm-integrator should configure LLM providers","llm-integrator":"Next: data-pipeline-engineer should set up embeddings","data-pipeline-engineer":"Next: code-quality-reviewer should validate data pipeline","database-engineer":"Next: backend-system-architect should integrate schema","rapid-ui-designer":"Next: frontend-ui-developer should implement designs","ux-researcher":"Next: rapid-ui-designer should create mockups"};function _i(t){return ki[t]||"none"}function bi(t){return Si[t]||"Pipeline complete"}function xi(t,e,n,r,s){let i=`${g()}/.claude/context/handoffs`;try{Qe(i,{recursive:!0})}catch{}let o=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),a=`${i}/${t}_to_${e}_${o}.json`,u={from_agent:t,to_agent:e,timestamp:n,summary:r,suggestions:s,status:"ready_for_handoff"};try{Xe(a,JSON.stringify(u,null,2))}catch{}return a}function vi(t,e,n,r,s,i){let o=`${g()}/.claude/logs/agent-handoffs`;try{Qe(o,{recursive:!0})}catch{}let a=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),u=`${o}/${t}_${a}.log`,l=`=== HANDOFF PREPARATION ===
From: ${t}
To: ${e}
Timestamp: ${n}
Handoff file: ${i}

Summary: ${r}

Next Steps: ${s}
`;try{Xe(u,l)}catch{}}function ut(t){let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown";if(!hi.has(r))return p();let s=_i(r),i=t.agent_output||t.output||"",o=i.length,a;o>0?(a=i.substring(0,300),o>300&&(a+="...")):a=`Agent ${r} completed`;let u=bi(r),l=xi(r,s,e,a,u);return vi(r,s,e,a,u,l),p()}import{writeFileSync as $i,mkdirSync as Ye}from"node:fs";var Ii=[".env","auth","secret","credential","password","token","apikey","api_key","api-key","jwt","session","oauth","permission",".pem",".key"];function wi(){let t=`${g()}/.claude/logs/multi-claude`;try{Ye(t,{recursive:!0})}catch{}return t}function A(t,e,n){let r=wi(),s=new Date().toISOString().substring(0,10).replace(/-/g,""),i=`${r}/verifier_${s}.log`,o=new Date().toISOString();try{h(i,`[${o}] [${t}] ${e}: ${n}
`)}catch{}}function Ti(t){let e=t.toLowerCase();for(let n of Ii)if(e.includes(n))return!0;return!!(e.includes("config")&&e.includes("prod"))}function lt(t){let e=new Date().toISOString(),n=g(),s=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",i=t.agent_output||t.output||"",o=[];if(s==="test-generator"&&(o.push({agent:"code-quality-reviewer",reason:"Test generation complete - quality review recommended"}),A(s,"TRIGGER","test-generator completion triggers code-quality-reviewer")),s==="frontend-ui-developer"&&/form|input|validation|submit|auth|login/i.test(i)&&(o.push({agent:"security-auditor",reason:"Frontend auth/form components - security review recommended"}),A(s,"TRIGGER","frontend auth components trigger security-auditor")),s==="backend-system-architect"&&/endpoint|route|api|auth|jwt|session/i.test(i)&&(o.push({agent:"security-auditor",reason:"Backend API endpoints - security review recommended"}),A(s,"TRIGGER","backend API endpoints trigger security-auditor")),Ti(i)&&(o.some(u=>u.agent==="security-auditor")||(o.push({agent:"security-auditor",reason:"Sensitive files modified - security review required"}),A(s,"TRIGGER","sensitive file patterns detected"))),s==="database-engineer"&&(o.push({agent:"code-quality-reviewer",reason:"Database schema changes - review for consistency"}),A(s,"TRIGGER","database changes trigger code-quality-reviewer")),s==="workflow-architect"&&(o.push({agent:"security-layer-auditor",reason:"LangGraph workflow created - layer audit recommended"}),A(s,"TRIGGER","workflow-architect triggers security-layer-auditor")),o.length>0){let a=`${n}/.claude/context/verification-queue`;try{Ye(a,{recursive:!0})}catch{}let u=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),l=`${a}/pending_${u}_${s}.json`,d={triggered_by:s,timestamp:e,verifications:o.map(f=>({agent:f.agent,reason:f.reason,status:"pending"}))};try{$i(l,JSON.stringify(d,null,2))}catch{}let m="Multi-Claude Verification Triggered: "+o.map(f=>`${f.agent} (${f.reason})`).join("; ");return A(s,"QUEUE",`Created verification queue: ${l}`),{continue:!0,systemMessage:m}}return A(s,"SKIP","No verification triggers matched"),p()}import{writeFileSync as Ai,mkdirSync as Di}from"node:fs";function Ci(){let t=`${g()}/.claude/logs/agent-validation`;try{Di(t,{recursive:!0})}catch{}return t}function gt(t){let e=t.subagent_type||t.agent_type||"unknown",n=new Date().toISOString(),r=t.agent_output||t.output||"",s=[],i=[];r||s.push("Agent produced empty output");let o=r.length;if(o<50&&i.push(`Output seems very short (${o} chars)`),/error|failed|exception/i.test(r)&&i.push("Output contains error-related keywords"),e==="backend-system-architect"&&r.includes("{")){let y=r.match(/\{[^{}]{0,1000}\}/);if(y)try{JSON.parse(y[0])}catch{i.push("JSON structure may be malformed")}}let a=s.length>0?"failed":"passed",u=t.last_assistant_message?.length??null,l=`Output Validation [${a}] - Agent: ${e}, Timestamp: ${n}, Output length: ${o} chars`+(u!==null?`, Response length: ${u} chars`:"");s.length>0&&(l+=` | Errors: ${s.join("; ")}`),i.length>0&&(l+=` | Warnings: ${i.join("; ")}`);let d=Ci(),m=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),f=`${d}/${e}_${m}.log`,b=`=== OUTPUT VALIDATION ===
${l}
${u!==null?`Response quality signal: last_assistant_message length = ${u}
`:""}
=== AGENT OUTPUT ===
${r}
`;try{Ai(f,b)}catch{}return a==="failed"?{continue:!1,systemMessage:l,hookSpecificOutput:{hookEventName:"SubagentStop"}}:{continue:!0,suppressOutput:!0,systemMessage:l}}import{existsSync as tn,writeFileSync as Ri,readFileSync as en}from"node:fs";import{join as Ei}from"node:path";var Wt=re(),dt={security_minimum:5,general_minimum:3};function Oi(t){let e=[];if(!t)return e;let n=/\*{0,2}(\w[\w\s]{0,30}?)\*{0,2}\s*:\s*(\d+(?:\.\d+)?)\s*\/\s*(\d+)/g;for(let s of t.matchAll(n)){let i=s[1].trim().toLowerCase(),o=parseFloat(s[2]),a=parseFloat(s[3]);!Number.isNaN(o)&&!Number.isNaN(a)&&a>0&&e.push({value:o,max:a,dimension:i==="score"?null:i})}let r=/"(\w+_?score|score)"\s*:\s*(\d+(?:\.\d+)?)/gi;for(let s of t.matchAll(r)){let i=s[1].toLowerCase(),o=parseFloat(s[2]);if(!Number.isNaN(o)){let a=i==="score"?null:i.replace(/_score$/,"");e.push({value:o,max:10,dimension:a})}}return e}function Pi(){let t=g();if(!t||t===".")return{};let e=Ei(t,".claude","policies","verification-policy.json");if(!tn(e))return{};try{return JSON.parse(en(e,"utf8"))}catch{return c("subagent-quality-gate","Failed to parse verification-policy.json","warn"),{}}}function ji(t,e){let n={...dt,...e.thresholds};if(t){let r=`${t}_minimum`;if(r in n)return n[r]??dt.general_minimum;if(/security|vuln|cve|owasp/i.test(t))return n.security_minimum??dt.security_minimum}return n.general_minimum??dt.general_minimum}function Hi(t){return!t||t.length<200?!0:[/\bfinding/i,/\bevidence/i,/\brecommendation/i,/\bissue/i,/\bresult/i,/\bsummary/i,/^[-*]\s/m,/^\d+\.\s/m,/^#{1,3}\s/m].some(n=>n.test(t))}function Ze(t){if(tn(Wt))try{let e=JSON.parse(en(Wt,"utf8"));t==="error"?e.errors=(e.errors||0)+1:t==="threshold_failure"&&(e.threshold_failures=(e.threshold_failures||0)+1),e.quality_checks=(e.quality_checks||0)+1,Ri(Wt,JSON.stringify(e,null,2))}catch{}}function pt(t){let e=t.agent_id||"",n=t.subagent_type||"",r=t.error||"",s=t.agent_output||t.output||t.last_assistant_message||"";if(c("subagent-quality-gate",`Quality gate check: ${n} (${e})`),r&&r!=="null")return c("subagent-quality-gate",`ERROR: Subagent failed - ${r}`),Ze("error"),T(`Subagent ${n} failed: ${r}`);let i=Oi(s);if(i.length>0){let o=Pi();for(let a of i){let u=a.value/a.max*10,l=ji(a.dimension,o),d=a.dimension||"overall";if(u<l)return c("subagent-quality-gate",`Score below threshold: ${d}=${u.toFixed(1)}/10 (min: ${l})`,"warn"),Ze("threshold_failure"),T(`Quality gate: ${d} score ${a.value}/${a.max} (${u.toFixed(1)}/10) is below minimum ${l}/10. Review the ${d} findings before proceeding.`)}}return s.length>200&&!Hi(s)&&c("subagent-quality-gate",`Subagent ${n} output lacks structured findings`,"info"),p()}var Vt=new Map;function Ni(t,e){let n=Vt.get(t)||[];n.push(e),n.length>10&&n.shift(),Vt.set(t,n)}function Mi(){let t=[];for(let[e,n]of Vt)n.some(r=>r.outcome==="failure")&&t.push(e);return t}function Li(t){let e=t.error||t.tool_error,n=t.exit_code,r=t.agent_output||t.output||"";if(e&&e!=="null"&&e!=="")return{outcome:"failure",error:e};if(n!==void 0&&n!==0)return{outcome:"failure",error:`Exit code: ${n}`};let s=[/i cannot|i can't|i am unable/i,/outside my scope/i,/not appropriate/i,/i refuse/i];for(let o of s)if(o.test(r.slice(0,500)))return{outcome:"rejected",error:"Agent rejected the task"};let i=[/partial(?:ly)?/i,/incomplete/i,/some.*failed/i,/couldn't finish/i];for(let o of i)if(o.test(r.slice(0,500)))return{outcome:"partial"};return{outcome:"success"}}function mt(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return p();let{outcome:r,error:s}=Li(t);if(r==="success")return p();c("retry-handler",`Agent ${n} completed with outcome: ${r}`);let i=At(),a=$().activeAgents.find(y=>y.agent===n),u=a?.retryCount||0,l=Se(n,u+1,a?.taskId),d=_e(l,r,s||void 0);Ni(n,d);let m=Mi(),f=ke(n,u+1,s||"Unknown failure",m,i.maxRetries);if(c("retry-handler",`Retry decision for ${n}: shouldRetry=${f.shouldRetry}, alternative=${f.alternativeAgent||"none"}`),f.shouldRetry)Tt(n,"retrying");else{Tt(n,"failed");let y=at(n);y&&ot(y.taskId,"failed")}let b=be(f,n);return G(b)}import{existsSync as cn,mkdirSync as Xi,readFileSync as Qi,writeFileSync as Yi}from"node:fs";import{existsSync as Fi,readFileSync as Ui,writeFileSync as _u,mkdirSync as bu}from"node:fs";import{execSync as nn}from"node:child_process";import{createHash as Bi}from"node:crypto";import*as rn from"node:os";var qi=".claude/.user_identity.json",Gi="orchestkit-user-identity-v1";var _=null;function ft(t){return Bi("sha256").update(t+Gi).digest("hex").slice(0,32)}function Ji(){try{return rn.hostname()}catch{return"unknown-machine"}}function zi(t){let e=`${t}/${qi}`;if(!Fi(e))return null;try{let n=Ui(e,"utf8");return JSON.parse(n)}catch(n){return c("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function Wi(t){let e={};try{e.email=nn("git config user.email",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{e.name=nn("git config user.name",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return e}function Vi(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function Ki(t){if(_)return _;let e=t||g(),n=Ji(),r=zi(e);if(r?.user_id)return _={user_id:r.user_id,display_name:r.display_name||r.user_id,team_id:r.team_id,machine_id:n,source:"config",anonymous_id:ft(r.user_id),email:r.user_id.includes("@")?r.user_id:void 0},c("user-identity",`Resolved from config: ${_.anonymous_id}`,"debug"),_;let s=Wi(e);if(s.email)return _={user_id:s.email,display_name:s.name||s.email.split("@")[0],team_id:r?.team_id,machine_id:n,source:"git",anonymous_id:ft(s.email),email:s.email},c("user-identity",`Resolved from git: ${_.anonymous_id}`,"debug"),_;let i=Vi();if(i.username){let a=`${i.username}@${n}`;return _={user_id:a,display_name:i.username,team_id:r?.team_id,machine_id:n,source:"env",anonymous_id:ft(a)},c("user-identity",`Resolved from env: ${_.anonymous_id}`,"debug"),_}let o=ft(n+process.pid);return _={user_id:`anon-${o.slice(0,8)}`,display_name:"Anonymous",team_id:r?.team_id,machine_id:n,source:"anonymous",anonymous_id:o},c("user-identity",`Resolved as anonymous: ${_.anonymous_id}`,"debug"),_}function sn(){let t=Ki();return{session_id:S(),user_id:t.user_id,anonymous_id:t.anonymous_id,team_id:t.team_id,machine_id:t.machine_id,identity_source:t.source,timestamp:new Date().toISOString()}}var Zi=/^[a-zA-Z0-9_-]{1,128}$/;function to(t){return Zi.test(t)}function Qt(t,e){let n=t||S(),r=e||g();if(!to(n))throw new Error("Invalid session ID format");return`${r}/.claude/memory/sessions/${n}`}function eo(t,e){return`${Qt(t,e)}/events.jsonl`}function un(t,e){let n=Qt(t,e);cn(n)||Xi(n,{recursive:!0})}var L=0,on=!1,Kt=!1,an=0,no=5e3;function ln(t,e){return`${Qt(t,e)}/counter.json`}function ro(t,e){if(!on){on=!0;try{let n=ln(t,e);if(cn(n)){let r=JSON.parse(Qi(n,"utf8"));typeof r.counter=="number"&&r.counter>0&&(L=r.counter,c("session-tracker",`Loaded event counter: ${L}`,"debug"))}}catch{}}}function so(t,e){if(!Kt)return;let n=Date.now();if(!(n-an<no))try{un(t,e);let r=ln(t,e);Yi(r,JSON.stringify({counter:L,updated_at:new Date().toISOString()})),Kt=!1,an=n}catch{}}function io(){return ro(),L++,Kt=!0,so(),`evt-${Date.now()}-${L}`}function gn(t,e,n={}){try{let r={event_id:io(),event_type:t,identity:sn(),payload:{name:e,input:Xt(n.input),output:Xt(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?dn(n.context,500):void 0,confidence:n.confidence}};un();let s=eo();h(s,`${JSON.stringify(r)}
`),c("session-tracker",`Tracked ${t}: ${e}`,"debug")}catch(r){c("session-tracker",`Failed to track event: ${r}`,"warn")}}function dn(t,e){return t.length<=e?t:`${t.slice(0,e-3)}...`}function Xt(t){if(!t)return;let e={},n=["password","secret","token","key","credential","auth"];for(let[r,s]of Object.entries(t)){if(n.some(i=>r.toLowerCase().includes(i))){e[r]="[REDACTED]";continue}if(typeof s=="string"&&s.length>500){e[r]=dn(s,500);continue}if(typeof s=="object"&&s!==null&&!Array.isArray(s)){e[r]=Xt(s);continue}e[r]=s}return e}import{mkdirSync as oo,statSync as ao,renameSync as co}from"node:fs";import{createHash as uo}from"node:crypto";function lo(){return bt(St(),".claude","analytics")}function pn(t){return uo("sha256").update(t).digest("hex").slice(0,12)}function mn(){let t=process.env.CLAUDE_CODE_TEAM_NAME;return t?{team:t}:void 0}function go(t,e=10485760){try{if(ao(t).size>e){let r=new Date().toISOString().slice(0,7),s=t.replace(/\.jsonl$/,`.${r}.jsonl`);co(t,s)}}catch{}}function po(){return!!(process.env.VITEST||process.env.JEST_WORKER_ID)}function fn(t,e){if(!po())try{let n=lo();oo(n,{recursive:!0});let r=bt(n,t);go(r),h(r,`${JSON.stringify(e)}
`)}catch{}}var yn=[{name:"context-publisher",fn:it},{name:"handoff-preparer",fn:ut},{name:"feedback-loop",fn:ct},{name:"agent-memory-store",fn:nt}];function mo(t){try{let e=t.tool_input?.subagent_type||t.subagent_type||t.agent_type||"unknown",n=t.tool_input?.name||void 0,r=!t.error,s=t.duration_ms,i=t.agent_output||t.output||"",o=typeof i=="string"?i.length:0;gn("agent_spawned",e,{success:r,duration_ms:s,output:{has_output:o>0,output_length:o,has_error:!!t.error},context:t.agent_id});let a=t.tool_input?.model||process.env.CLAUDE_MODEL||"unknown";fn("agent-usage.jsonl",{ts:new Date().toISOString(),pid:pn(process.env.CLAUDE_PROJECT_DIR||""),agent:e,agent_name:n??null,model:a,duration_ms:s,success:r,output_len:o,last_msg_len:t.last_assistant_message?.length??null,...mn()})}catch{}}async function hn(t){mo(t);let n=(await Promise.allSettled(yn.map(async r=>{try{let s=r.fn(t);return s instanceof Promise&&await s,{hook:r.name,status:"success"}}catch(s){let i=s instanceof Error?s.message:String(s);return c("subagent-stop-dispatcher",`${r.name} failed: ${i}`),{hook:r.name,status:"error",message:i}}}))).filter(r=>r.status==="rejected"||r.status==="fulfilled"&&r.value.status==="error");return n.length>0&&c("subagent-stop-dispatcher",`${n.length}/${yn.length} hooks had errors`),p()}var E="sync-subagent-stop-dispatcher",fo=[{name:"output-validator",fn:gt},{name:"auto-spawn-quality",fn:rt},{name:"multi-claude-verifier",fn:lt},{name:"subagent-quality-gate",fn:pt},{name:"retry-handler",fn:mt}];function kn(t){let e=[];for(let r of fo)try{let s=r.fn(t);if(s.continue===!1)return c(E,`${r.name}: blocked (continue: false) \u2014 short-circuiting`),s;s.systemMessage&&(e.push(s.systemMessage),c(E,`${r.name}: systemMessage collected`));let i=J(s);i&&!s.systemMessage&&(e.push(i),c(E,`${r.name}: additionalContext collected`))}catch(s){let i=s instanceof Error?s.message:String(s);c(E,`${r.name} failed: ${i}`,"warn")}if(e.length===0)return c(E,"All sync hooks silent"),p();let n=e.join(`
`);return c(E,`Merged ${e.length} messages from sync hooks`),{continue:!0,systemMessage:n}}var Sn={"subagent-start/graph-memory-inject":W,"subagent-start/context-gate":K,"subagent-start/subagent-context-stager":Q,"subagent-start/subagent-validator":Y,"subagent-start/model-cost-advisor":tt,"subagent-start/issue-context-injector":et,"subagent-start/unified-dispatcher":Ne,"subagent-stop/agent-memory-store":nt,"subagent-stop/auto-spawn-quality":rt,"subagent-stop/context-publisher":it,"subagent-stop/feedback-loop":ct,"subagent-stop/handoff-preparer":ut,"subagent-stop/multi-claude-verifier":lt,"subagent-stop/output-validator":gt,"subagent-stop/subagent-quality-gate":pt,"subagent-stop/retry-handler":mt,"subagent-stop/unified-dispatcher":hn,"subagent-stop/sync-subagent-stop-dispatcher":kn};function fl(t){return Sn[t]}function yl(){return Object.keys(Sn)}export{ia as DEFAULT_CONFIG,sa as THRESHOLDS,ya as addToPromptHistory,Ia as analyzeAttemptHistory,Ea as applyDecay,ka as cacheClassification,ur as calculateBackoffDelay,xa as cleanupOldStates,ba as clearSessionState,_e as completeAttempt,Se as createAttempt,na as escapeRegex,z as estimateTokenCount,J as extractContext,ae as fnv1aHash,be as formatRetryDecision,ga as getActiveAgent,Oa as getAdjustments,Pa as getAgentSuccessRate,Dt as getAlternativeAgent,le as getCachedBranch,ja as getCalibrationStats,Fo as getEnvFile,Zo as getField,fl as getHook,fa as getInjectedSkills,Sa as getLastClassification,ue as getLogDir,Xn as getLogLevel,q as getPluginRoot,g as getProjectDir,ha as getPromptHistory,S as getSessionId,Ha as hasMinimalCalibrationData,Sr as hashPrompt,Sn as hooks,da as isAgentDispatched,ho as isBashInput,So as isEditInput,_o as isReadInput,lr as isRetryableError,ma as isSkillInjected,ko as isWriteInput,$t as lineContainsAll,ta as lineContainsAllCI,yl as listHooks,H as loadCalibrationData,At as loadConfig,$ as loadState,c as logHook,Ko as logPermissionFeedback,ke as makeRetryDecision,ea as normalizeCommand,Uo as normalizeLineEndings,Jo as outputAllowWithContext,qo as outputBlock,vt as outputDeny,zo as outputError,Yn as outputPromptContext,Xo as outputPromptContextBudgeted,Bo as outputSilentAllow,p as outputSilentSuccess,Wo as outputStderrWarning,T as outputWarning,G as outputWithContext,Go as outputWithNotification,Vo as outputWithUpdatedInput,wa as prepareForRetry,Yo as readHookInput,Ra as recordOutcome,la as removeAgent,kr as saveCalibrationData,_a as saveConfig,nr as saveState,Qn as shouldLog,gr as suggestsAlternative,ua as trackDispatchedAgent,pa as trackInjectedSkill,Tt as updateAgentStatus,R as updateState,Qo as writeRulesFile};
//# sourceMappingURL=subagent.mjs.map
