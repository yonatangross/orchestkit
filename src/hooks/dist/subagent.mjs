// OrchestKit Hooks - subagent bundle
// Generated: 2026-02-20T07:36:53.555Z

var nt=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,n)=>(typeof require<"u"?require:e)[n]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});function oo(t){return typeof t.command=="string"}function ao(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function co(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function uo(t){return typeof t.file_path=="string"&&t.content===void 0}import{existsSync as Wt,statSync as Mn,renameSync as Fn,mkdirSync as Ln,readSync as Un}from"node:fs";import{appendFileSync as yn,mkdirSync as hn}from"node:fs";import{dirname as kn}from"node:path";var G=[],rt=!1,Ft=!1;function h(t,e){G.push({filePath:t,content:e}),Sn()}function st(){if(rt||G.length===0)return;rt=!0;let t=new Map;for(let e of G){let n=t.get(e.filePath);n?n.push(e.content):t.set(e.filePath,[e.content])}for(let[e,n]of t)try{hn(kn(e),{recursive:!0}),yn(e,n.join(""))}catch{}G.length=0,rt=!1}function Sn(){Ft||(Ft=!0,process.on("exit",st),process.on("SIGTERM",()=>{st(),process.exit(0)}),process.on("SIGINT",()=>{st(),process.exit(0)}))}import{execSync as Bn}from"node:child_process";import Lt from"node:os";import N from"node:path";function it(){return process.env.HOME||process.env.USERPROFILE||Lt.homedir()}function _n(){return Lt.tmpdir()}function ot(){return process.env.CLAUDE_PROJECT_DIR||"."}function Ut(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function Bt(){return process.env.CLAUDE_PLUGIN_ROOT?N.join(it(),".claude","logs","ork"):N.join(ot(),".claude","logs")}function qt(){return process.env.CLAUDE_METRICS_FILE||N.join(_n(),"claude-session-metrics.json")}var at=N.join,ho=N.sep;import{execSync as bn}from"node:child_process";import{createHash as xn}from"node:crypto";import{existsSync as Gt,readFileSync as vn,writeFileSync as $n,mkdirSync as In}from"node:fs";import{join as ct,basename as wn}from"node:path";var Tn=20,Dn=15,An=/[^a-z0-9-]/g;function Rn(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=wn(e);return Jt(n,Tn)}function Cn(t){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=bn("git branch --show-current",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),r=Jt(n||"detached",Dn);return process.env.ORCHESTKIT_SESSION_BRANCH=r,r}catch{return"nobranch"}}function En(t){let e=t||new Date,n=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${n}${r}`}function On(t){let e=t||new Date,n=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0");return`${n}${r}`}function Pn(){let t=`${process.pid}-${Date.now()}-${Math.random()}`;return xn("sha256").update(t).digest("hex").slice(0,4)}function Jt(t,e){return t.toLowerCase().replace(An,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,e)}function jn(t,e){let n=Rn(t),r=Cn(t),s=En(e),i=On(e),o=Pn();return`${n}-${r}-${s}-${i}-${o}`}function Hn(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=ct(e,".instance","session-id.json");if(Gt(n))try{let r=JSON.parse(vn(n,"utf8"));if(r.session_id&&r.created_at){let s=Date.now()-new Date(r.created_at).getTime(),i=1440*60*1e3;if(s<i)return r.session_id}}catch{}}function Nn(t,e){let n=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),r=ct(n,".instance"),s=ct(r,"session-id.json");try{Gt(r)||In(r,{recursive:!0}),$n(s,JSON.stringify({session_id:t,created_at:new Date().toISOString()},null,2))}catch{}}function zt(t){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let e=Hn(t);if(e)return e;let n=jn(t);return Nn(n,t),n}function Vt(){return Bt()}function l(){return ot()}function J(){return Ut()}function Ao(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${J()}/.claude/.instance_env`}function S(){return zt()}function Kt(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let e=Bn("git branch --show-current",{cwd:t||l(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function qn(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Ro(t){return t.replace(/\r\n/g,`
`)}function Gn(t){let e=["debug","info","warn","error"];return e.indexOf(t)>=e.indexOf(qn())}function d(){return{continue:!0,suppressOutput:!0}}function Co(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function Eo(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function D(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function Jn(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function Oo(t,e){let n={continue:!0,suppressOutput:!0};return t&&(n.systemMessage=t),e&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:e}),n}function Po(t,e){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?n.systemMessage=e:n.suppressOutput=!0,n}function jo(t){return{continue:!0,systemMessage:t}}function C(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function Ho(t){process.stderr.write(`\u26A0 ${t}
`),process.exit(2)}function ut(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}function No(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:t}}}var zn=200*1024,Wn=100*1024;function Xt(t,e){if(Wt(t))try{if(Mn(t).size>e){let r=`${t}.old.${Date.now()}`;Fn(t,r)}}catch{}}function Qt(t){Wt(t)||Ln(t,{recursive:!0})}function c(t,e,n="debug"){if(!Gn(n))return;let r=Vt(),s=`${r}/hooks.log`;try{Qt(r),Xt(s,zn);let i=new Date().toISOString().replace("T"," ").slice(0,19);h(s,`[${i}] [${n.toUpperCase()}] [${t}] ${e}
`)}catch{}}function Mo(t,e,n){let r=Vt(),s=`${r}/permission-feedback.log`;try{Qt(r),Xt(s,Wn);let i=new Date().toISOString(),o=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",a=n?.session_id||S();h(s,`${i} | ${t} | ${e} | tool=${o} | session=${a}
`)}catch{}}function Vn(t){if(!t)return 0;let r=(t.match(/[{};()=><]/g)||[]).length/t.length>.03?2.8:3.5;return Math.ceil(t.length/r)}function Fo(t,e,n,r,s){let i=Vn(t);return r?.isOverBudget(n)?(c(e,`Budget exhausted for ${n}, suppressing ${i}t`),d()):(s&&s.trackTokenUsage(e,n,i),Jn(t))}function Lo(){try{let t=[],n=Buffer.allocUnsafe(256),r,s=0;for(;;)try{if(r=Un(s,n,0,256,null),r===0)break;t.push(Buffer.from(n.subarray(0,r)))}catch{break}let i=Buffer.concat(t).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:S(),tool_input:{}}}catch{return{tool_name:"",session_id:S(),tool_input:{}}}}function Uo(t,e){let n=e.replace(/^\./,"").split("."),r=t;for(let s of n){if(r==null)return;r=r[s]}return r}function Bo(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function qo(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var Jo={AUTO_DISPATCH:85,SKILL_INJECT:80,STRONG_RECOMMEND:70,SUGGEST:50,MINIMUM:40},zo={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:1200,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};import{existsSync as M,readFileSync as Zt,writeFileSync as te,mkdirSync as Kn}from"node:fs";function gt(){return`${l()}/.claude/orchestration`}function lt(){let t=S();return`${gt()}/session-${t}.json`}function ee(){return`${l()}/.claude/orchestration/config.json`}function ne(){let t=gt();if(!M(t))try{Kn(t,{recursive:!0})}catch{c("orchestration-state",`Failed to create state dir: ${t}`)}}function $(){let t=lt();if(M(t))try{let e=Zt(t,"utf8");return JSON.parse(e)}catch(e){c("orchestration-state",`Failed to load state: ${e}`)}return{sessionId:S(),activeAgents:[],injectedSkills:[],promptHistory:[],maxHistorySize:10,updatedAt:new Date().toISOString()}}function Xn(t){ne();let e=lt();t.updatedAt=new Date().toISOString();try{te(e,JSON.stringify(t,null,2))}catch(n){c("orchestration-state",`Failed to save state: ${n}`)}}function P(t){let e=$();return t(e),Xn(e),e}function Xo(t,e,n){let r={agent:t,taskId:n,confidence:e,dispatchedAt:new Date().toISOString(),status:"pending",retryCount:0,maxRetries:3};return P(s=>{s.activeAgents=s.activeAgents.filter(i=>i.agent!==t),s.activeAgents.push(r)}),c("orchestration-state",`Tracked dispatched agent: ${t} (conf: ${e})`),r}function E(t,e,n){P(r=>{let s=r.activeAgents.find(i=>i.agent===t);s&&(s.status=e,n&&(s.taskId=n),e==="retrying"&&s.retryCount++)}),c("orchestration-state",`Updated agent status: ${t} -> ${e}`)}function dt(t){P(e=>{e.activeAgents=e.activeAgents.filter(n=>n.agent!==t)})}function Qo(){return $().activeAgents.find(e=>e.status==="in_progress")}function Yo(t){return $().activeAgents.some(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function Zo(t){P(e=>{e.injectedSkills.includes(t)||e.injectedSkills.push(t)})}function ta(t){return $().injectedSkills.includes(t)}function ea(){return $().injectedSkills}function na(t){P(e=>{e.promptHistory.push(t),e.promptHistory.length>e.maxHistorySize&&(e.promptHistory=e.promptHistory.slice(-e.maxHistorySize))})}function ra(){return $().promptHistory}function sa(t){P(e=>{e.lastClassification=t})}function ia(){return $().lastClassification}var Yt={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:1200,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function pt(){let t=ee();if(M(t))try{let e=Zt(t,"utf8");return{...Yt,...JSON.parse(e)}}catch{}return Yt}function oa(t){ne();let e=ee(),r={...pt(),...t};try{te(e,JSON.stringify(r,null,2))}catch(s){c("orchestration-state",`Failed to save config: ${s}`)}}function aa(){let t=lt();try{if(M(t)){let{unlinkSync:e}=nt("node:fs");e(t),c("orchestration-state","Cleared session state")}}catch{}}function ca(){let t=gt();if(M(t))try{let{readdirSync:e,statSync:n,unlinkSync:r}=nt("node:fs"),s=e(t).filter(i=>i.startsWith("session-")&&i.endsWith(".json")).map(i=>({name:i,path:`${t}/${i}`,mtime:n(`${t}/${i}`).mtime.getTime()})).sort((i,o)=>o.mtime-i.mtime);for(let i of s.slice(5))try{r(i.path),c("orchestration-state",`Cleaned up old state: ${i.name}`)}catch{}}catch{}}var Qn=3,Yn=1e3,Zn=3e4,tr={"backend-system-architect":["database-engineer","api-designer"],"frontend-ui-developer":["rapid-ui-designer","accessibility-specialist"],"test-generator":["debug-investigator","code-quality-reviewer"],"security-auditor":["security-layer-auditor"],"workflow-architect":["llm-integrator","data-pipeline-engineer"]},er=[/permission denied/i,/access denied/i,/not found.*(?:file|module|package)/i,/(?:file|module|package)\s+not\s+found/i,/missing required/i,/invalid (?:api|token|key)/i,/authentication failed/i,/quota exceeded/i,/rate limit/i],nr=[/not my specialization/i,/outside my scope/i,/better suited for/i,/consider using/i,/specialized agent/i];function rr(t,e=Yn){let n=e*2**(t-1),r=Math.random()*.1*n;return Math.min(n+r,Zn)}function sr(t){for(let e of er)if(e.test(t))return!1;return!0}function ir(t){for(let e of nr)if(e.test(t))return!0;return!1}function mt(t,e=[]){let n=tr[t];if(n){for(let r of n)if(!e.includes(r))return r}}function re(t,e,n,r=[],s=Qn){if(c("retry-manager",`Evaluating retry for ${t}, attempt ${e}`),e>=s){let o=mt(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Max retries (${s}) exceeded`+(o?`. Consider trying ${o} instead.`:"")}}if(!sr(n)){let o=mt(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Non-retryable error detected: ${n.slice(0,100)}`}}if(ir(n)){let o=mt(t,r);if(o)return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Error suggests using alternative agent: ${o}`}}let i=rr(e);return{shouldRetry:!0,retryCount:e,maxRetries:s,delayMs:i,reason:`Retrying (attempt ${e+1}/${s}) after ${Math.round(i/1e3)}s`}}function se(t,e,n){return{agent:t,taskId:n,attemptNumber:e,startedAt:new Date().toISOString()}}function ie(t,e,n){let r=new Date().toISOString(),s=new Date(r).getTime()-new Date(t.startedAt).getTime();return{...t,completedAt:r,outcome:e,error:n,durationMs:s}}function la(t){if(t.length===0)return{successRate:0,avgDuration:0,commonErrors:[]};let n=t.filter(a=>a.outcome==="success").length/t.length,r=t.filter(a=>a.durationMs!==void 0).map(a=>a.durationMs),s=r.length>0?r.reduce((a,u)=>a+u,0)/r.length:0,i=new Map;for(let a of t)if(a.error){let u=a.error.slice(0,50).toLowerCase();i.set(u,(i.get(u)||0)+1)}let o=Array.from(i.entries()).sort((a,u)=>u[1]-a[1]).slice(0,3).map(([a])=>a);return{successRate:n,avgDuration:s,commonErrors:o}}function da(t,e){return{...t,status:"retrying",retryCount:e.retryCount}}function oe(t,e){if(t.shouldRetry)return`## Retry Scheduled

Agent \`${e}\` will retry after ${Math.round((t.delayMs||0)/1e3)} seconds.

**Attempt:** ${t.retryCount+1} of ${t.maxRetries}
**Reason:** ${t.reason}`;let n=`## Retry Not Recommended

Agent \`${e}\` has ${t.retryCount>=t.maxRetries?"exhausted retries":"encountered a non-retryable error"}.

**Reason:** ${t.reason}`;return t.alternativeAgent&&(n+=`

### Alternative Suggestion

Consider using \`${t.alternativeAgent}\` instead:

\`\`\`
Task tool with subagent_type: "${t.alternativeAgent}"
\`\`\``),n}import{existsSync as ge,readFileSync as or,writeFileSync as ar,mkdirSync as cr}from"node:fs";import{createHash as ur}from"node:crypto";var ae=500,ft=3,ce=15,ue=3,gr=.9;function le(){return`${l()}/.claude/feedback/calibration-data.json`}function lr(){let t=`${l()}/.claude/feedback`;if(!ge(t))try{cr(t,{recursive:!0})}catch{}}function F(){let t=le();if(ge(t))try{return JSON.parse(or(t,"utf8"))}catch{c("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function dr(t){lr();let e=le();t.updatedAt=new Date().toISOString();try{ar(e,JSON.stringify(t,null,2)),c("calibration-engine","Saved calibration data")}catch(n){c("calibration-engine",`Failed to save calibration data: ${n}`)}}function pr(t){return ur("sha256").update(t.toLowerCase().trim()).digest("hex").slice(0,16)}function ha(t,e,n,r,s,i,o){let a=F(),u={timestamp:new Date().toISOString(),sessionId:S(),agent:e,promptHash:pr(t),matchedKeywords:n,dispatchConfidence:r,outcome:s,durationMs:i,feedback:o};a.records.push(u),a.records.length>ae&&(a.records=a.records.slice(-ae)),mr(a,u),fr(a),dr(a),c("calibration-engine",`Recorded outcome: ${e} -> ${s} (conf: ${r})`)}function mr(t,e){let n=e.outcome==="success",r=e.outcome==="failure"||e.outcome==="rejected";if(!n&&!r)return;let s=n?ue:-ue;for(let i of e.matchedKeywords){let o=t.adjustments.find(a=>a.keyword===i&&a.agent===e.agent);o?(o.adjustment=Math.max(-ce,Math.min(ce,o.adjustment+s)),o.sampleCount++,o.lastUpdated=new Date().toISOString()):t.adjustments.push({keyword:i,agent:e.agent,adjustment:s,sampleCount:1,lastUpdated:new Date().toISOString()})}}function ka(t){let e=Date.now(),n=1440*60*1e3;for(let r of t.adjustments){let s=e-new Date(r.lastUpdated).getTime();Math.floor(s/n)>7&&(r.adjustment=Math.round(r.adjustment*gr),Math.abs(r.adjustment)<1&&(r.adjustment=0))}t.adjustments=t.adjustments.filter(r=>r.adjustment!==0)}function fr(t){let e=t.records;if(e.length===0)return;t.stats.totalDispatches=e.length;let n=e.filter(i=>i.outcome==="success").length;t.stats.successRate=n/e.length;let r=e.reduce((i,o)=>i+o.dispatchConfidence,0)/e.length;t.stats.avgConfidence=Math.round(r);let s=new Map;for(let i of e){let o=s.get(i.agent)||{count:0,success:0};o.count++,i.outcome==="success"&&o.success++,s.set(i.agent,o)}t.stats.topAgents=Array.from(s.entries()).map(([i,o])=>({agent:i,count:o.count,successRate:o.success/o.count})).sort((i,o)=>o.count-i.count).slice(0,10)}function Sa(){return F().adjustments.filter(e=>e.sampleCount>=ft)}function _a(t){let n=F().records.filter(s=>s.agent===t);return n.length<ft?null:n.filter(s=>s.outcome==="success").length/n.length}function ba(){return F().stats}function xa(){return F().records.length>=ft}import{existsSync as yr,statSync as hr}from"node:fs";import{resolve as kr}from"node:path";var Sr={"database-engineer":"database schema SQL PostgreSQL migration pgvector","backend-system-architect":"API REST architecture backend FastAPI microservice","frontend-ui-developer":"React frontend UI component TypeScript Tailwind","security-auditor":"security OWASP vulnerability audit authentication","test-generator":"testing unit integration coverage pytest MSW","workflow-architect":"LangGraph workflow agent orchestration state","llm-integrator":"LLM API OpenAI Anthropic embeddings RAG function-calling","data-pipeline-engineer":"data pipeline embeddings vector ETL chunking","metrics-architect":"metrics OKR KPI analytics instrumentation","ux-researcher":"UX user research persona journey accessibility","code-quality-reviewer":"code quality review linting type-check patterns","infrastructure-architect":"infrastructure cloud Docker Kubernetes deployment","ci-cd-engineer":"CI CD pipeline GitHub Actions deployment automation","accessibility-specialist":"accessibility WCAG ARIA screen-reader a11y","product-strategist":"product strategy roadmap features prioritization"};function _r(t){return Sr[t]||t}var de=100;function pe(t){c("graph-memory-inject","Graph memory inject hook starting");let e=kr(l(),".claude/memory/knowledge-graph.jsonl");if(!yr(e))return c("graph-memory-inject","No graph data file, skipping"),d();try{let u=hr(e).size;if(u<de)return c("graph-memory-inject",`Graph too small (${u}B < ${de}B), skipping`),d()}catch{return c("graph-memory-inject","Could not stat graph file, skipping"),d()}let r=(t.tool_input||{}).subagent_type||"";if(!r)return c("graph-memory-inject","No agent type detected, passing through"),d();let s=`ork:${r}`,i=_r(r);c("graph-memory-inject",`Detected agent type: ${r} (agent_id: ${s})`);let o=`[Graph Memory - Agent Context Load]

Execute this MCP call to load graph context for ${r} agent:

## Graph Memory Entities
\`\`\`
mcp__memory__search_nodes
{"query": "${r} ${i}"}
\`\`\`

## Integration Instructions
1. Execute the graph search to retrieve relevant entities and relationships
2. Review entities for patterns, decisions, and constraints
3. Check relationships between concepts
4. Apply learned patterns to current task

Agent ID: ${s} | Domain: ${i}`,a=`[Graph Memory] Agent: ${r} | ID: ${s} | Load graph context via MCP call above`;return c("graph-memory-inject",`Outputting graph memory instructions for ${r}`),{continue:!0,systemMessage:a,hookSpecificOutput:{additionalContext:o}}}import{existsSync as L,readFileSync as z,writeFileSync as yt,mkdirSync as br}from"node:fs";import{dirname as xr}from"node:path";var vr=6,$r=8,Ir=5,wr=/^(test-generator|backend-system-architect|workflow-architect|security-auditor|llm-integrator)$/;function Tr(){let t=process.cwd();return t.includes(".claude/worktrees/")||t.includes("/.git/worktrees/")}function Dr(){return Tr()?{maxBackground:10,maxPerResponse:12}:{maxBackground:vr,maxPerResponse:$r}}function ht(){return`${l()}/.claude/logs/agent-state.json`}function fe(){return`${l()}/.claude/logs/subagent-spawns.jsonl`}function Ar(){let t=ht(),e=xr(t);try{br(e,{recursive:!0})}catch{}if(!L(t)){let n={active_background:[],session_total:0,last_cleanup:null,blocked_count:0};try{yt(t,JSON.stringify(n,null,2))}catch{}}}function Rr(){let t=fe();if(!L(t))return 0;try{let r=z(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),s=new Date(Date.now()-300*1e3).toISOString(),i=0;for(let o of r)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>s&&i++}catch{}return i}catch{return 0}}function Cr(){let t=fe();if(!L(t))return 0;try{let r=z(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),s=new Date(Date.now()-2*1e3).toISOString(),i=0;for(let o of r)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>s&&i++}catch{}return i}catch{return 0}}function Er(){let t=ht();try{if(L(t)){let e=JSON.parse(z(t,"utf8"));e.blocked_count=(e.blocked_count||0)+1,yt(t,JSON.stringify(e,null,2))}}catch{}}function me(){let t=ht();try{if(L(t)){let e=JSON.parse(z(t,"utf8"));e.session_total=(e.session_total||0)+1,yt(t,JSON.stringify(e,null,2))}}catch{}}function ye(t){Ar();let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"",s=e.run_in_background===!0||e.run_in_background==="true";c("context-gate",`Context gate check: ${n} (background=${s})`);let i=Rr(),o=Cr();c("context-gate",`Active background: ${i}, Current response: ${o}`);let a=Dr();return o>=a.maxPerResponse?(c("context-gate",`BLOCKED: Too many agents in single response (${o} >= ${a.maxPerResponse})`),ut(`Context Overflow Protection

Too many agents spawned in a single response (${o} agents).

Maximum allowed: ${a.maxPerResponse} per response

SOLUTION: Split into multiple responses or use sequential execution.
Consider using the /context-optimization skill first.

Attempted: ${n} - ${r}`)):s&&i>=a.maxBackground?(c("context-gate",`BLOCKED: Too many concurrent background agents (${i} >= ${a.maxBackground})`),Er(),ut(`Background Agent Limit

Too many background agents running concurrently (${i} active).

Maximum allowed: ${a.maxBackground} concurrent background agents

SOLUTION:
1. Wait for existing agents to complete
2. Run this agent in foreground (remove run_in_background)
3. Use /context-optimization to free up context

Attempted: ${n} - ${r}`)):i>=Ir?(c("context-gate","WARNING: Approaching context budget limit"),me(),C(`Context Budget Warning

${i} background agents active (limit: ${a.maxBackground}).

Consider:
- Running remaining agents sequentially
- Using /context-optimization skill
- Waiting for current agents to complete

Proceeding with: ${n} - ${r}`)):wr.test(n)&&i>=2?(c("context-gate",`WARNING: Expensive agent type with multiple active: ${n}`),C(`Spawning expensive agent (${n}) with ${i} others active`)):(me(),c("context-gate",`Context gate passed: ${n}`),d())}import{existsSync as W,readFileSync as kt,readdirSync as Or}from"node:fs";import{homedir as Pr}from"node:os";import{join as he}from"node:path";function jr(){return`${l()}/.claude/context/session/state.json`}function Hr(){return`${l()}/.claude/context/knowledge/decisions/active.json`}function Nr(){return`${l()}/docs/issues`}function Mr(){let t=jr();if(!W(t))return{count:0,summary:""};try{let n=JSON.parse(kt(t,"utf8")).tasks_pending||[],r=n.length;if(r===0)return{count:0,summary:""};let s=n.slice(0,5).map(i=>`- ${i}`).join(`
`);return{count:r,summary:s}}catch{return{count:0,summary:""}}}function ke(t,e){let n=Hr();if(!W(n))return"";try{return(JSON.parse(kt(n,"utf8")).decisions||[]).filter(o=>o.category===e||o.category==="api"||o.category==="database").slice(0,8).map(o=>`- ${o.title} (${o.status||"unknown"})`).join(`
`)}catch{return""}}function Fr(t){let e=Nr();if(!W(e))return"";try{let r=Or(e).find(s=>s.includes(t));if(r)return`docs/issues/${r}`}catch{}return""}function Lr(){let t=[],e=he(Pr(),".claude","CLAUDE.md"),n=Se(e);if(n){let o=_e(n,"global");t.push(...o)}let r=he(l(),"CLAUDE.md"),s=Se(r);if(s){let o=_e(s,"project");t.push(...o)}return t.length===0?"":`CRITICAL RULES (inherited from CLAUDE.md):
${[...new Set(t)].slice(0,12).map(o=>`- ${o}`).join(`
`)}

`}function Se(t){try{return W(t)?kt(t,"utf8"):""}catch{return""}}function _e(t,e){let n=[],r=t.split(`
`);for(let s of r){let i=s.trim();if(!(!i||i.startsWith("#")||i.startsWith("```"))){if(/^[-*]\s+/.test(i)){let o=i.replace(/^[-*]\s+/,"").trim();if(/\b(always|never|must|don't|do not|required|NEVER|MUST|DON'T)\b/i.test(o)){let a=o.length>80?`${o.substring(0,77)}...`:o;n.push(a)}}if(/^\*\*(DO|DON'T|DO NOT)\*\*:/.test(i)){let o=i.replace(/\*\*/g,"").trim();o.length<=80&&n.push(o)}}}return n}function be(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.task_description||e.description||"";c("subagent-context-stager",`Staging context for ${n}`);let s="",i=Lr();i&&(s+=i,c("subagent-context-stager","Injected critical rules from CLAUDE.md"));let{count:o,summary:a}=Mr();o>0&&(c("subagent-context-stager",`Found ${o} pending tasks`),s+=`ACTIVE TODOS:
${a}

`);let u=r.toLowerCase();if(/backend|api|endpoint|database|migration/.test(u)){c("subagent-context-stager","Backend task detected - staging backend decisions");let g=ke(r,"backend");g&&(s+=`RELEVANT DECISIONS:
${g}

`)}if(/frontend|react|ui|component/.test(u)){c("subagent-context-stager","Frontend task detected - staging frontend decisions");let g=ke(r,"frontend");g&&(s+=`RELEVANT DECISIONS:
${g}

`)}if(/test|testing|pytest|jest/.test(u)&&(c("subagent-context-stager","Testing task detected - staging test context"),s+=`TESTING REMINDERS:
- Use 'tee' for visible test output
- Check test patterns in backend/tests/ or frontend/src/**/__tests__/
- Ensure coverage meets threshold requirements

`),/issue|#\d+|bug|fix/.test(u)){c("subagent-context-stager","Issue-related task detected");let g=r.match(/#(\d+)/);if(g){let p=g[1],f=Fr(p);f&&(s+=`ISSUE DOCS: ${f}

`,c("subagent-context-stager",`Staged issue documentation for #${p}`))}}if(s){let g=`${s}
Task: ${r}
Subagent: ${n}`,p=s.split(`
`).filter(Boolean).length;return c("subagent-context-stager",`Staged context with ${p} lines`),{continue:!0,systemMessage:g}}return c("subagent-context-stager","No context staged for this task"),d()}import{existsSync as U,readFileSync as St,mkdirSync as Ur,readdirSync as Br}from"node:fs";import{join as v,dirname as qr}from"node:path";var Gr=new Set(["general-purpose","Explore","Plan","claude-code-guide","statusline-setup","Bash"]);function Jr(){return v(l(),".claude","logs","subagent-spawns.jsonl")}function zr(){return v(l(),"plugin.json")}function _t(){return v(l(),"agents")}function bt(){return v(l(),".claude","agents")}function Wr(){return v(l(),"skills")}function Vr(){let t=new Set(Gr),e=zr();if(U(e))try{let s=JSON.parse(St(e,"utf8")).agents||[];for(let i of s)i.id&&t.add(i.id)}catch{}let n=[_t(),bt()];for(let r of n)if(U(r))try{let s=Br(r);for(let i of s)i.endsWith(".md")&&t.add(i.replace(".md",""))}catch{}return t}function Kr(t){let e=[],n=[v(_t(),`${t}.md`),v(bt(),`${t}.md`)],r=null;for(let s of n)if(U(s)){r=s;break}if(!r)return e;try{let i=St(r,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of i){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^skills:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let g=u.match(/^\s*-\s*(.+)$/);if(g){let p=g[1].trim();e.push(p)}}}}}catch{}return e}function Xr(t){let e=Kr(t),n=[],r=Wr();for(let s of e){let i=v(r,s,"SKILL.md");U(i)||n.push(s)}return n}function Qr(t){let e=[],n=[v(_t(),`${t}.md`),v(bt(),`${t}.md`)],r=null;for(let s of n)if(U(s)){r=s;break}if(!r)return e;try{let i=St(r,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of i){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^tools:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let g=u.match(/^\s*-\s*(.+)$/);g&&e.push(g[1].trim())}}}}catch{}return e}function Yr(t,e){if(e.length===0)return"";let n=e.every(o=>["Read","Glob","Grep"].includes(o)),r=e.includes("Bash"),s=e.includes("Write")||e.includes("Edit"),i="low";return r&&s?i="elevated":(r||s)&&(i="moderate"),`## Agent Permission Profile (CC 2.1.20)

**Agent**: \`${t}\`
**Tools**: ${e.join(", ")}
**Risk Level**: ${i}${n?" (read-only)":""}

${r?`> This agent requests Bash access. Review commands carefully.
`:""}`}function Zr(t,e,n){let r=Jr(),s=qr(r);try{Ur(s,{recursive:!0})}catch{}let i={timestamp:new Date().toISOString(),subagent_type:t,description:e,session_id:n};try{h(r,`${JSON.stringify(i)}
`)}catch{}}function xe(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"",s=t.session_id;c("subagent-validator",`Task invocation: ${n} - ${r}`),Zr(n,r,s);let i=n.replace(/^[^:]+:/,""),o=Vr();!o.has(n)&&!o.has(i)&&c("subagent-validator",`WARNING: Unknown subagent type: ${n}`),c("subagent-validator",`Spawning ${n} agent: ${r}`);let a=Xr(i);if(a.length>0){let g=a.join(", ");c("subagent-validator",`WARNING: Agent '${i}' references missing skills: ${g}`),console.error(`Warning: Agent '${i}' references ${a.length} missing skill(s): ${g}`)}let u=Qr(i);if(u.length>0){let g=Yr(i,u);return c("subagent-validator",`Agent '${i}' tools: ${u.join(", ")}`),D(g)}return d()}import{existsSync as ve,readFileSync as ts,writeFileSync as es,mkdirSync as ns}from"node:fs";function $e(){let t=S();return`${l()}/.claude/orchestration/task-registry-${t}.json`}function rs(){let t=`${l()}/.claude/orchestration`;if(!ve(t))try{ns(t,{recursive:!0})}catch{}}function j(){let t=$e();if(ve(t))try{return JSON.parse(ts(t,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:S(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function xt(t){rs();let e=$e();t.updatedAt=new Date().toISOString();try{es(e,JSON.stringify(t,null,2))}catch(n){c("task-integration",`Failed to save registry: ${n}`)}}function Ie(t,e){return`### Delete Orphaned Task

\`\`\`
TaskUpdate:
  taskId: "${t}"
  status: "deleted"
\`\`\`

**Reason**: ${e}`}function V(t){let e=`### Update Task

\`\`\`
TaskUpdate:
  taskId: "${t.taskId}"`;return t.status&&(e+=`
  status: "${t.status}"`),t.addBlockedBy&&t.addBlockedBy.length>0&&(e+=`
  addBlockedBy: ${JSON.stringify(t.addBlockedBy)}`),t.addBlocks&&t.addBlocks.length>0&&(e+=`
  addBlocks: ${JSON.stringify(t.addBlocks)}`),e+="\n```",e}function I(t,e){let n=j(),r=n.tasks.find(s=>s.taskId===t);r&&(r.status=e,xt(n),c("task-integration",`Updated task ${t} status to ${e}`))}function A(t){return j().tasks.find(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function we(t){return j().tasks.filter(n=>n.status==="pending"&&n.blockedBy&&n.blockedBy.includes(t))}function vt(t){return j().tasks.filter(n=>n.pipelineId===t).sort((n,r)=>(n.pipelineStep||0)-(r.pipelineStep||0))}function Te(){return j().pipelines.find(e=>e.status==="running")}function De(t,e){let n=j(),r=n.pipelines.find(i=>i.pipelineId===t);if(!r)return null;r.completedSteps.includes(e)||(r.completedSteps.push(e),r.completedSteps.sort((i,o)=>i-o));let s=vt(t);for(let i of s){let o=i.pipelineStep;if(o===void 0||r.completedSteps.includes(o)||i.status!=="pending")continue;if(o===0||r.completedSteps.includes(o-1))return r.currentStep=o,xt(n),o}return r.status="completed",xt(n),null}function Ae(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return c("task-linker","No agent type found, skipping"),d();c("task-linker",`Processing SubagentStart for: ${n}`);let r=A(n);if(!r)return c("task-linker",`No orchestration task found for agent: ${n}`),d();c("task-linker",`Found task ${r.taskId} for agent ${n}`),I(r.taskId,"in_progress"),E(n,"in_progress",r.taskId);let s=V({taskId:r.taskId,status:"in_progress"}),i=`## Orchestration: Task Linked

Agent \`${n}\` has been linked to task **${r.taskId}**.

${s}

The task status should be updated to \`in_progress\`.`;return c("task-linker",`Linked agent ${n} to task ${r.taskId}`),D(i)}import{mkdirSync as ss,existsSync as $t,readFileSync as It}from"node:fs";import{join as K,dirname as is}from"node:path";var os=[/security|vulnerab|audit|penetration/i,/architect|design.*system|distributed/i,/migration.*schema|database.*design/i,/performance.*optim|profil|bottleneck/i,/langgraph|workflow.*orchestrat/i],as=[/\b(?:list|count|check|verify|read|search)\b/i,/\b(?:simple|straightforward|quick)\b/i,/\b(?:format|lint|style|typo|rename)\b/i,/\b(?:status|progress|summary)\b/i],O=new Map,w=new Map;function wt(t){if(O.has(t))return O.get(t);let e=J();if(!e)return O.set(t,"inherit"),"inherit";let n=K(e,"agents",`${t}.md`);if(!$t(n))return O.set(t,"inherit"),"inherit";try{let s=It(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!s)return O.set(t,"inherit"),"inherit";let i=s[1].match(/^model:\s*(.+)$/m),o=i?i[1].trim():"inherit";return O.set(t,o),o}catch{return O.set(t,"inherit"),"inherit"}}function cs(t){if(w.has(t))return w.get(t);let e=J();if(!e)return w.set(t,null),null;let n=K(e,"agents",`${t}.md`);if(!$t(n))return w.set(t,null),null;try{let s=It(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!s)return w.set(t,null),null;let i=s[1].match(/^skills:\s*\n((?:\s+-\s+.+\n)*)/m);if(!i)return w.set(t,null),null;let o=i[1].match(/^\s+-\s+(.+)$/gm)?.map(g=>g.trim().replace(/^-\s+/,""))||[];if(o.length===0)return w.set(t,null),null;let a={low:0,medium:1,high:2},u="low";for(let g of o.slice(0,5)){let p=K(e,"skills",g,"SKILL.md");if(!$t(p))continue;let m=It(p,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!m)continue;let b=m[1].match(/^complexity:\s*(low|medium|high)$/m);if(b){let y=b[1];a[y]>a[u]&&(u=y)}}return w.set(t,u),u}catch{return w.set(t,null),null}}function Re(t,e){let n=cs(t);if(n==="high")return"high";let r=os.filter(o=>o.test(e)).length,s=wt(t);return r>=2||s==="opus"?"high":as.filter(o=>o.test(e)).length>=2?"low":n||"medium"}function Ce(t){let e=wt(t);return e==="inherit"?process.env.CLAUDE_MODEL||"sonnet":e}function us(t,e){let n=Re(t,e),r=Ce(t);return n==="high"&&r==="haiku"?{recommended:"sonnet",current:r,reason:"High-complexity task \u2014 haiku may produce lower quality results",savingsPercent:0}:n==="low"&&r==="opus"?{recommended:"sonnet",current:r,reason:"Simple task \u2014 sonnet handles this equally well at lower cost",savingsPercent:40}:n==="medium"&&r==="opus"&&wt(t)!=="opus"?{recommended:"sonnet",current:r,reason:"Medium-complexity task \u2014 sonnet is sufficient",savingsPercent:30}:null}function gs(t,e,n,r){let s=K(l(),".claude","logs","model-usage.jsonl");try{ss(is(s),{recursive:!0}),h(s,`${JSON.stringify({timestamp:new Date().toISOString(),agent:t,model:e,complexity:n,recommendation:r?.recommended||null,potentialSavings:r?.savingsPercent||0})}
`)}catch{}}function Ee(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"";if(!n)return d();let s=Re(n,r),i=Ce(n),o=us(n,r);return gs(n,i,s,o),o?(c("model-cost-advisor",`${n}: Recommend ${o.recommended} over ${o.current} (${o.reason})`,"info"),o.savingsPercent>=30?C(`Model cost: ${n} using ${o.current} for ${s}-complexity task. ${o.reason}. ~${o.savingsPercent}% savings with "${o.recommended}".`):d()):(c("model-cost-advisor",`${n}: ${i} appropriate for ${s} task`),d())}import{existsSync as ls,readFileSync as ds,writeFileSync as ps,statSync as ms,mkdirSync as fs}from"node:fs";import{execFileSync as ys}from"node:child_process";import{tmpdir as hs}from"node:os";import{join as Tt}from"node:path";var Dt=Tt(hs(),"orchestkit-issue-cache"),ks=300*1e3,Ss=3e3;function _s(t){let e=t.match(/^(?:issue|fix|feat|bug|hotfix|feature)\/(\d+)/)||t.match(/^(\d+)-/);return e?e[1]:null}function bs(){try{fs(Dt,{recursive:!0,mode:448})}catch{}}function xs(t){let e=Tt(Dt,`${t}.json`);try{if(!ls(e))return null;let n=ms(e);return Date.now()-n.mtimeMs>ks?null:JSON.parse(ds(e,"utf8"))}catch{return null}}function vs(t,e){if(!/^\d+$/.test(t))return null;try{let n=ys("gh",["issue","view",t,"--json","title,body,labels"],{cwd:e,encoding:"utf8",timeout:Ss,stdio:["pipe","pipe","pipe"]}).trim(),r=JSON.parse(n);try{bs();let s=Tt(Dt,`${t}.json`);ps(s,JSON.stringify(r),"utf8")}catch{}return r}catch{return null}}function $s(t,e){let n=[];if(e?.title?n.push(`Working on GitHub Issue #${t}: ${e.title}`):n.push(`Working on GitHub Issue #${t}`),e?.labels&&e.labels.length>0){let r=e.labels.map(s=>s.name).join(", ");n.push(`Labels: ${r}`)}return n.push(`Reference #${t} in all commits. Use 'Closes #${t}' in PR description.`),n.join(`
`)}function Oe(t){try{let e=l(),n=Kt(e);c("issue-context-injector",`Branch: ${n}`);let r=_s(n);if(!r)return c("issue-context-injector","No issue number in branch name"),d();c("issue-context-injector",`Detected issue #${r}`);let s=xs(r)??vs(r,e),i=$s(r,s);return c("issue-context-injector",`Injecting context for issue #${r}`),{continue:!0,systemMessage:i}}catch{return c("issue-context-injector","Unexpected error, falling back to silent success","warn"),d()}}import{existsSync as Is,mkdirSync as ws,unlinkSync as Ts}from"node:fs";import{basename as Ds,dirname as As}from"node:path";var Rs=["decided to","chose","implemented using","selected","opted for","will use","pattern:","approach:","architecture:","recommends","best practice","anti-pattern","learned that"],Cs="decisions";function Es(){return`${l()}/.claude/logs/agent-patterns.jsonl`}function Os(){return`${l()}/.claude/session`}function Pe(){let t=l();return(Ds(t)||"default-project").toLowerCase().replace(/ /g,"-").replace(/[^a-z0-9-]/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-")}function Ps(t){return`${Pe()}-${t}`}function js(t){let r=(t.length>10240?t.substring(0,10240):t).toLowerCase();return/pagination|cursor|offset/.test(r)?"pagination":/security|vulnerability|exploit|injection|xss|csrf|owasp|safety|guardrail/.test(r)?"security":/database|sql|postgres|schema/.test(r)?"database":/\bapi\b|endpoint|\brest\b|graphql/.test(r)?"api":/auth|login|jwt|oauth/.test(r)?"authentication":/\btest\b|testing|pytest|jest|vitest|coverage|\bmock\b|fixture|\bspec\b/.test(r)?"testing":/deploy|\bci\b|\bcd\b|pipeline|docker|kubernetes|helm|terraform/.test(r)?"deployment":/observability|monitoring|logging|tracing|metrics|prometheus|grafana|langfuse/.test(r)?"observability":/react|component|frontend|\bui\b/.test(r)?"frontend":/performance|optimization|cache|index/.test(r)?"performance":/llm|\brag\b|embedding|vector|semantic|\bai\b|\bml\b|langchain|langgraph|openai|anthropic/.test(r)?"ai-ml":/etl|data.*pipeline|streaming|batch.*processing|dataflow|spark/.test(r)?"data-pipeline":/architecture|design|structure/.test(r)?"architecture":/decided|chose|selected/.test(r)?"decision":"pattern"}function Hs(t){let e=[];if(t.length<50)return e;for(let r of Rs){let s=new RegExp(`^.*${r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}.*$`,"gim"),i=t.match(s)||[];for(let o of i){let a=o.trim().substring(0,200);a.length>20&&e.push(a)}}return[...new Set(e)].slice(0,5)}function X(t){c("agent-memory-store","Agent memory store hook starting");let e=t.tool_input||{},n=t.subagent_type||e.subagent_type||e.type||"",r=t.tool_result,s=typeof r=="string"?r:r?.content||t.agent_output||t.output||"",i=!0;if(t.error&&(i=!1),typeof r=="object"&&r?.is_error&&(i=!1),!n)return c("agent-memory-store","No agent type in input, skipping"),d();let o=`ork:${n}`,a=`${Os()}/current-agent-id`;try{Is(a)&&Ts(a)}catch{}c("agent-memory-store",`Processing completion for agent: ${n} (agent_id: ${o}, success: ${i})`);let u=i&&s?Hs(s):[];if(u.length===0)return c("agent-memory-store",`No patterns extracted from ${n} output`),d();let g=Es(),p=As(g);try{ws(p,{recursive:!0})}catch{}let f=Pe(),m=new Date().toISOString(),b=Ps(Cs);for(let k of u){let q=js(k),Mt={agent:n,agent_id:o,pattern:k,project:f,timestamp:m,scope_id:b,category:q,pending_graph_sync:!0};try{h(g,`${JSON.stringify(Mt)}
`)}catch{}c("agent-memory-store",`Extracted pattern (${q}): ${k.substring(0,50)}...`)}return c("agent-memory-store",`Extracted ${u.length} patterns from ${n} output`),{continue:!0,systemMessage:`[Pattern Extraction] ${u.length} patterns extracted from ${n}. To persist, use mcp__memory__create_entities with entities: [{"name": "${n}-pattern", "entityType": "Pattern", "observations": ["<pattern>"]}]`}}import{existsSync as Ns,writeFileSync as je,mkdirSync as At,readFileSync as Ms}from"node:fs";import{dirname as Fs}from"node:path";var Ls=[".env","credentials","secret","auth","password","token","api.key","private.key",".pem","oauth","jwt","session","cookie","encryption","crypto"];function Us(){let t=`${l()}/.claude/hooks/logs`;try{At(t,{recursive:!0})}catch{}return`${t}/auto-spawn-quality.log`}function Bs(){return`${l()}/.claude/context/spawn-queue.json`}function x(t){let e=Us(),n=new Date().toISOString();try{h(e,`[${n}] [auto-spawn-quality] ${t}
`)}catch{}}function qs(t){let e=t.toLowerCase();for(let n of Ls)if(e.includes(n))return x(`Detected sensitive pattern: ${n}`),!0;return!1}function Gs(t,e,n,r,s,i){let o=`SPAWN-${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,14)}-${Math.floor(Math.random()*1e4).toString().padStart(4,"0")}`,a=Bs(),u=Fs(a);try{At(u,{recursive:!0})}catch{}let g;if(Ns(a))try{g=JSON.parse(Ms(a,"utf8"))}catch{g={schema_version:"1.0.0",created_at:i,queue:[]}}else g={schema_version:"1.0.0",created_at:i,queue:[]};let p={spawn_id:o,target_agent:e,trigger_agent:t,trigger_reason:n,priority:r,timestamp:i,session_id:s,status:"queued"};g.queue.push(p);try{je(a,JSON.stringify(g,null,2)),x(`Queued spawn request: ${o} for ${e} (reason: ${n})`)}catch{return x(`ERROR: Failed to queue spawn request for ${e}`),""}return o}function Js(t,e,n,r,s,i){let o=`${l()}/.claude/context/handoffs`;try{At(o,{recursive:!0})}catch{}let a=`${o}/auto_spawn_${e}_${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,15)}.json`,u={type:"auto_spawn_suggestion",from_agent:t,to_agent:e,timestamp:i,trigger_reason:n,priority:r,session_id:s,auto_triggered:!0,status:"suggested"};try{je(a,JSON.stringify(u,null,2)),x(`Created spawn suggestion: ${e} (reason: ${n})`)}catch{}}function zs(t,e,n){if(n&&n!=="null")return x(`Skipping auto-spawn - agent ${t} had errors: ${n}`),null;if(t==="test-generator")return x("Rule matched: test-generator -> code-quality-reviewer"),{target:"code-quality-reviewer",reason:"test-generator completed - validating test quality and coverage",priority:"high"};if(qs(e)&&t!=="security-auditor"&&t!=="security-layer-auditor")return x("Rule matched: sensitive files detected -> security-auditor"),{target:"security-auditor",reason:"sensitive file changes detected - security audit required",priority:"critical"};if(t==="code-quality-reviewer")return x("Rule matched: code-quality-reviewer -> security-auditor"),{target:"security-auditor",reason:"code-quality-reviewer completed - proceeding with security scan",priority:"high"};if(t==="backend-system-architect"){let r=e.toLowerCase();if(/authentication|authorization|security|access.control|rbac|acl/.test(r))return x("Rule matched: backend-system-architect with auth -> security-layer-auditor"),{target:"security-layer-auditor",reason:"backend-system-architect designed auth/security layer - validation required",priority:"high"}}return null}function He(t){let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",s=t.session_id,i=t.agent_output||t.output||"",o=t.error||"";if(x(`Checking auto-spawn conditions for agent: ${r} (session: ${s})`),r==="unknown"||!r)return x("Skipping unknown agent type"),d();let a=zs(r,i,o);if(a){let u=Gs(r,a.target,a.reason,a.priority,s,e);return Js(r,a.target,a.reason,a.priority,s,e),x(`=== AUTO-SPAWN QUALITY HOOK ===
Trigger Agent: ${r}
Target Agent: ${a.target}
Reason: ${a.reason}
Priority: ${a.priority}
Spawn ID: ${u}
Timestamp: ${e}
Session: ${s}`),{continue:!0,systemMessage:`Auto-spawn queued: ${a.target} (${a.priority} priority)`}}return x(`No auto-spawn conditions matched for ${r}`),d()}import{existsSync as Ws,writeFileSync as Ue,mkdirSync as Vs,readFileSync as Ks}from"node:fs";import{dirname as Rt}from"node:path";function Ne(){return`${l()}/.claude/context/knowledge/decisions/active.json`}function Xs(){return`${l()}/.claude/context/session/state.json`}function Qs(){return`${l()}/.claude/logs/agent-context`}function Q(t){try{Vs(t,{recursive:!0})}catch{}}function Me(t,e){if(!Ws(t))return e;try{return JSON.parse(Ks(t,"utf8"))}catch{return e}}function Fe(t,e){let n=Rt(t);Q(n);try{Ue(t,JSON.stringify(e,null,2))}catch{}}var Le=50;function Y(t){let e=t.subagent_type||t.agent_type||"unknown",n=new Date().toISOString(),r=t.agent_output||t.output||"",s=r.substring(0,200);r.length>200&&(s+="...");let i=e!=="unknown"||s.trim().length>0,o=e.replace(/-/g,"_");if(i){let k=Ne(),q=Rt(k);Q(q);let H=Me(k,{schema_version:"2.0.0",decisions:{}});(!H.decisions||typeof H.decisions!="object")&&(H.decisions={});let fn={timestamp:n,agent:e,summary:s,status:"completed"};H.decisions[o]=fn,Fe(k,H)}let a=Xs(),u=Rt(a);Q(u);let p=Me(a,{schema_version:"2.0.0",session_id:"",started_at:n,last_activity:n,active_agent:null,tasks_pending:[],tasks_completed:[]});if(Array.isArray(p.tasks_completed)||(p.tasks_completed=[]),Array.isArray(p.tasks_pending)||(p.tasks_pending=[]),i){let k={agent:e,timestamp:n,summary:s};p.tasks_completed.push(k),p.tasks_completed.length>Le&&(p.tasks_completed=p.tasks_completed.slice(-Le))}p.last_activity=n,p.active_agent=null,Fe(a,p);let f=Qs();Q(f);let m=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),b=`${f}/${e}_${m}.log`,y=`=== CONTEXT PUBLICATION (Protocol 2.0) ===
Agent: ${e}
Timestamp: ${n}
Decisions file: ${Ne()}
Session state: ${a}

=== AGENT OUTPUT ===
${r}
`;try{Ue(b,y)}catch{}return d()}import{existsSync as Ys,writeFileSync as qe,mkdirSync as Et,readFileSync as Zs}from"node:fs";import{dirname as ti}from"node:path";function Ct(){return!!(process.env.CLAUDE_CODE_TEAM_NAME||process.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS==="1")}var Be=[{type:"product-thinking",name:"Product Thinking Pipeline",description:"Full product discovery and specification workflow",triggers:["should we build","product decision","feature validation","market research","user research"],steps:[{agent:"market-intelligence",description:"Analyze competitive landscape and market trends",dependsOn:[],skills:["market-research"],estimatedTokens:3e3},{agent:"ux-researcher",description:"Create personas and map user journeys",dependsOn:[0],skills:["user-research"],estimatedTokens:2500},{agent:"product-strategist",description:"Validate value proposition and alignment",dependsOn:[0,1],skills:["product-strategy"],estimatedTokens:2e3},{agent:"prioritization-analyst",description:"Score and prioritize using frameworks",dependsOn:[2],skills:["prioritization"],estimatedTokens:1500},{agent:"business-case-builder",description:"Build ROI and cost-benefit analysis",dependsOn:[2,3],skills:["business-case"],estimatedTokens:2e3},{agent:"requirements-translator",description:"Transform to PRD and user stories",dependsOn:[4],skills:["requirements"],estimatedTokens:2500}],estimatedTotalTokens:13500},{type:"full-stack-feature",name:"Full-Stack Feature Pipeline",description:"End-to-end feature implementation workflow",triggers:["full-stack feature","build a feature","implement end-to-end","create full feature","add complete feature"],steps:[{agent:"backend-system-architect",description:"Design API and database schema",dependsOn:[],skills:["api-design","database-patterns"],estimatedTokens:3e3},{agent:"frontend-ui-developer",description:"Build React components and UI",dependsOn:[0],skills:["react-server-components-framework","form-state-patterns"],estimatedTokens:3500},{agent:"test-generator",description:"Create unit and integration tests",dependsOn:[0,1],skills:["testing-patterns"],estimatedTokens:2e3},{agent:"security-auditor",description:"Audit for vulnerabilities",dependsOn:[0,1],skills:["security-patterns"],estimatedTokens:1500}],estimatedTotalTokens:1e4},{type:"ai-integration",name:"AI Integration Pipeline",description:"Add AI/LLM capabilities to application",triggers:["add rag","add llm","ai integration","implement rag","add ai feature","langgraph workflow"],steps:[{agent:"workflow-architect",description:"Design LangGraph workflow and state",dependsOn:[],skills:["langgraph"],estimatedTokens:2500},{agent:"llm-integrator",description:"Connect LLM APIs with function calling",dependsOn:[0],skills:["llm-integration"],estimatedTokens:2e3},{agent:"data-pipeline-engineer",description:"Build embeddings and data pipeline",dependsOn:[0],skills:["embeddings","rag-retrieval"],estimatedTokens:2500},{agent:"test-generator",description:"Create LLM testing infrastructure",dependsOn:[1,2],skills:["testing-patterns"],estimatedTokens:1500}],estimatedTotalTokens:8500},{type:"security-audit",name:"Security Audit Pipeline",description:"Comprehensive security review workflow",triggers:["security audit","security review","vulnerability scan","security assessment"],steps:[{agent:"security-auditor",description:"Scan for OWASP Top 10 vulnerabilities",dependsOn:[],skills:["security-patterns"],estimatedTokens:2e3},{agent:"security-layer-auditor",description:"Verify defense-in-depth layers",dependsOn:[0],skills:["security-patterns"],estimatedTokens:2e3},{agent:"ai-safety-auditor",description:"Audit AI/LLM security if applicable",dependsOn:[0],skills:["mcp-security-hardening"],estimatedTokens:1500}],estimatedTotalTokens:5500},{type:"frontend-compliance",name:"Frontend 2026 Compliance Pipeline",description:"Modernize frontend to 2026 patterns",triggers:["frontend compliance","modernize frontend","update react","frontend 2026"],steps:[{agent:"frontend-ui-developer",description:"Upgrade to React 19 patterns",dependsOn:[],skills:["react-server-components-framework","zustand-patterns"],estimatedTokens:3e3},{agent:"frontend-performance-engineer",description:"Optimize Core Web Vitals",dependsOn:[0],skills:["performance"],estimatedTokens:2e3},{agent:"accessibility-specialist",description:"Ensure WCAG 2.2 compliance",dependsOn:[0],skills:["testing-patterns","accessibility"],estimatedTokens:1500}],estimatedTotalTokens:6500}];function ei(){return`${l()}/.claude/coordination/decision-log.json`}function ni(){let t=`${l()}/.claude/hooks/logs`;try{Et(t,{recursive:!0})}catch{}return`${t}/agent-feedback.log`}function T(t){let e=ni(),n=new Date().toISOString();try{h(e,`[${n}] [feedback-loop] ${t}
`)}catch{}}function ri(t){let e=Te();if(e){let r=Be.find(s=>s.type===e.type);if(r){let s=r.steps.findIndex(i=>i.agent===t);if(s>=0){let i=r.steps.filter((o,a)=>o.dependsOn.includes(s)&&a>s).map(o=>o.agent);if(i.length>0)return i.join(" ")}}}return{"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"test-generator","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer"}[t]||""}function si(t){return{"market-intelligence":"product-thinking","product-strategist":"product-thinking","prioritization-analyst":"product-thinking","business-case-builder":"product-thinking","requirements-translator":"specification","metrics-architect":"specification","backend-system-architect":"architecture","database-engineer":"architecture","data-pipeline-engineer":"architecture","frontend-ui-developer":"frontend","rapid-ui-designer":"frontend","ux-researcher":"frontend","test-generator":"quality","code-quality-reviewer":"quality","security-auditor":"security","security-layer-auditor":"security","workflow-architect":"ai-integration","llm-integrator":"ai-integration","debug-investigator":"debugging"}[t]||"general"}function ii(){return process.env.CLAUDE_INSTANCE_ID||`${nt("node:os").hostname()}-${process.pid}`}function oi(t){let e=t.substring(0,500);return t.length>500&&(e+="..."),e}function ai(t,e,n,r,s,i,o,a){let u=ei(),g=ti(u);try{Et(g,{recursive:!0})}catch{}let p;if(Ys(u))try{p=JSON.parse(Zs(u,"utf8"))}catch{p={schema_version:"2.0.0",log_created_at:o,decisions:[]}}else p={schema_version:"2.0.0",log_created_at:o,decisions:[]};let f={decision_id:t,timestamp:o,made_by:{instance_id:ii(),agent_type:e},category:n,title:`Agent ${e} completed`,description:r,impact:{scope:"agent-pipeline",downstream_agents:s.split(" ").filter(Boolean)},status:i,task_id:a};p.decisions.push(f);try{qe(u,JSON.stringify(p,null,2)),T(`Decision ${t} logged for agent ${e}`)}catch{T("ERROR: Failed to write decision to log")}}function ci(t,e,n,r,s,i,o){if(!e)return;let a=`${l()}/.claude/context/handoffs`;try{Et(a,{recursive:!0})}catch{}let u=e.split(" ").filter(Boolean),g=new Date().toISOString().replace(/[-:]/g,"").substring(0,15);for(let p of u){let f=`${a}/${t}_to_${p}_${g}.json`,m={from_agent:t,to_agent:p,timestamp:i,decision_id:r,summary:n,session_id:s,status:"pending",feedback_loop:!0,task_id:o};try{qe(f,JSON.stringify(m,null,2)),T(`Created handoff context: ${t} -> ${p}`)}catch{}}}function Z(t){if(Ct())return d();let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",s=t.session_id,i=t.agent_output||t.output||"",o=t.error||"";if(T(`Processing feedback for agent: ${r} (session: ${s})`),r==="unknown"||!r)return T("Skipping unknown agent type"),d();let a=new Date().toISOString().replace(/[-:T.]/g,"").substring(0,8),u=Math.floor(Math.random()*1e4).toString().padStart(4,"0"),g=`DEC-${a}-${u}`,f=A(r)?.taskId,m=ri(r),b=si(r),y,k;return o&&o!=="null"?(y=`Agent failed: ${o}`,k="failed"):(y=oi(i),k="completed"),f&&(I(f,k==="completed"?"completed":"failed"),T(`Updated task ${f} status to ${k}`)),ai(g,r,b,y,m,k,e,f),m?(ci(r,m,y,g,s,e,f),T(`Routed findings to downstream agents: ${m}`)):T(`No downstream agents for ${r} (terminal agent)`),T(`=== AGENT FEEDBACK LOOP ===
Agent: ${r}
Category: ${b}
Decision ID: ${g}
Task ID: ${f||"none"}
Timestamp: ${e}
Status: ${k}
Downstream: ${m||"none"}

Summary: ${y}`),m?{continue:!0,systemMessage:`Feedback loop: routed to ${m}${f?` (task: ${f})`:""}`}:d()}import{writeFileSync as Ge,mkdirSync as Je}from"node:fs";var ui=new Set(["market-intelligence","product-strategist","prioritization-analyst","business-case-builder","requirements-translator","metrics-architect","backend-system-architect","code-quality-reviewer","data-pipeline-engineer","database-engineer","debug-investigator","frontend-ui-developer","llm-integrator","rapid-ui-designer","security-auditor","security-layer-auditor","system-design-reviewer","test-generator","ux-researcher","workflow-architect"]),gi={"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"code-quality-reviewer","code-quality-reviewer":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"code-quality-reviewer","database-engineer":"backend-system-architect","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer","security-auditor":"none","security-layer-auditor":"none","debug-investigator":"none","system-design-reviewer":"none"},li={"market-intelligence":"Next: product-strategist should define product vision based on market analysis","product-strategist":"Next: prioritization-analyst should rank features from strategy","prioritization-analyst":"Next: business-case-builder should create ROI justification","business-case-builder":"Next: requirements-translator should convert to technical specs","requirements-translator":"Next: metrics-architect should define success criteria","metrics-architect":"Next: backend-system-architect should design API endpoints","backend-system-architect":"Next: frontend-ui-developer should build UI components","frontend-ui-developer":"Next: test-generator should create test coverage","test-generator":"Next: code-quality-reviewer should validate implementation","code-quality-reviewer":"Next: security-auditor should perform security scan","workflow-architect":"Next: llm-integrator should configure LLM providers","llm-integrator":"Next: data-pipeline-engineer should set up embeddings","data-pipeline-engineer":"Next: code-quality-reviewer should validate data pipeline","database-engineer":"Next: backend-system-architect should integrate schema","rapid-ui-designer":"Next: frontend-ui-developer should implement designs","ux-researcher":"Next: rapid-ui-designer should create mockups"};function di(t){return gi[t]||"none"}function pi(t){return li[t]||"Pipeline complete"}function mi(t,e,n,r,s){let i=`${l()}/.claude/context/handoffs`;try{Je(i,{recursive:!0})}catch{}let o=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),a=`${i}/${t}_to_${e}_${o}.json`,u={from_agent:t,to_agent:e,timestamp:n,summary:r,suggestions:s,status:"ready_for_handoff"};try{Ge(a,JSON.stringify(u,null,2))}catch{}return a}function fi(t,e,n,r,s,i){let o=`${l()}/.claude/logs/agent-handoffs`;try{Je(o,{recursive:!0})}catch{}let a=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),u=`${o}/${t}_${a}.log`,g=`=== HANDOFF PREPARATION ===
From: ${t}
To: ${e}
Timestamp: ${n}
Handoff file: ${i}

Summary: ${r}

Next Steps: ${s}
`;try{Ge(u,g)}catch{}}function tt(t){let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown";if(!ui.has(r))return d();let s=di(r),i=t.agent_output||t.output||"",o=i.length,a;o>0?(a=i.substring(0,300),o>300&&(a+="...")):a=`Agent ${r} completed`;let u=pi(r),g=mi(r,s,e,a,u);return fi(r,s,e,a,u,g),d()}import{writeFileSync as yi,mkdirSync as ze}from"node:fs";var hi=["\\.env","auth","secret","credential","password","token","api[_-]?key","jwt","session","oauth","permission","\\.pem$","\\.key$","config.*prod"];function ki(){let t=`${l()}/.claude/logs/multi-claude`;try{ze(t,{recursive:!0})}catch{}return t}function R(t,e,n){let r=ki(),s=new Date().toISOString().substring(0,10).replace(/-/g,""),i=`${r}/verifier_${s}.log`,o=new Date().toISOString();try{h(i,`[${o}] [${t}] ${e}: ${n}
`)}catch{}}function Si(t){for(let e of hi)if(new RegExp(e,"i").test(t))return!0;return!1}function We(t){let e=new Date().toISOString(),n=l(),s=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",i=t.agent_output||t.output||"",o=[];if(s==="test-generator"&&(o.push({agent:"code-quality-reviewer",reason:"Test generation complete - quality review recommended"}),R(s,"TRIGGER","test-generator completion triggers code-quality-reviewer")),s==="frontend-ui-developer"&&/form|input|validation|submit|auth|login/i.test(i)&&(o.push({agent:"security-auditor",reason:"Frontend auth/form components - security review recommended"}),R(s,"TRIGGER","frontend auth components trigger security-auditor")),s==="backend-system-architect"&&/endpoint|route|api|auth|jwt|session/i.test(i)&&(o.push({agent:"security-auditor",reason:"Backend API endpoints - security review recommended"}),R(s,"TRIGGER","backend API endpoints trigger security-auditor")),Si(i)&&(o.some(u=>u.agent==="security-auditor")||(o.push({agent:"security-auditor",reason:"Sensitive files modified - security review required"}),R(s,"TRIGGER","sensitive file patterns detected"))),s==="database-engineer"&&(o.push({agent:"code-quality-reviewer",reason:"Database schema changes - review for consistency"}),R(s,"TRIGGER","database changes trigger code-quality-reviewer")),s==="workflow-architect"&&(o.push({agent:"security-layer-auditor",reason:"LangGraph workflow created - layer audit recommended"}),R(s,"TRIGGER","workflow-architect triggers security-layer-auditor")),o.length>0){let a=`${n}/.claude/context/verification-queue`;try{ze(a,{recursive:!0})}catch{}let u=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),g=`${a}/pending_${u}_${s}.json`,p={triggered_by:s,timestamp:e,verifications:o.map(m=>({agent:m.agent,reason:m.reason,status:"pending"}))};try{yi(g,JSON.stringify(p,null,2))}catch{}let f="Multi-Claude Verification Triggered: "+o.map(m=>`${m.agent} (${m.reason})`).join("; ");return R(s,"QUEUE",`Created verification queue: ${g}`),{continue:!0,systemMessage:f}}return R(s,"SKIP","No verification triggers matched"),d()}import{writeFileSync as _i,mkdirSync as bi}from"node:fs";function xi(){let t=`${l()}/.claude/logs/agent-validation`;try{bi(t,{recursive:!0})}catch{}return t}function Ve(t){let e=t.subagent_type||t.agent_type||"unknown",n=new Date().toISOString(),r=t.agent_output||t.output||"",s=[],i=[];r||s.push("Agent produced empty output");let o=r.length;if(o<50&&i.push(`Output seems very short (${o} chars)`),/error|failed|exception/i.test(r)&&i.push("Output contains error-related keywords"),e==="backend-system-architect"&&r.includes("{")){let y=r.match(/\{[^}]*\}/);if(y)try{JSON.parse(y[0])}catch{i.push("JSON structure may be malformed")}}let a=s.length>0?"failed":"passed",u=t.last_assistant_message?.length??null,g=`Output Validation [${a}] - Agent: ${e}, Timestamp: ${n}, Output length: ${o} chars`+(u!==null?`, Response length: ${u} chars`:"");s.length>0&&(g+=` | Errors: ${s.join("; ")}`),i.length>0&&(g+=` | Warnings: ${i.join("; ")}`);let p=xi(),f=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),m=`${p}/${e}_${f}.log`,b=`=== OUTPUT VALIDATION ===
${g}
${u!==null?`Response quality signal: last_assistant_message length = ${u}
`:""}
=== AGENT OUTPUT ===
${r}
`;try{_i(m,b)}catch{}return a==="failed"?{continue:!1,systemMessage:g,hookSpecificOutput:{hookEventName:"SubagentStop"}}:{continue:!0,suppressOutput:!0,systemMessage:g}}import{existsSync as vi,writeFileSync as $i,readFileSync as Ii}from"node:fs";var Ot=qt();function wi(){if(vi(Ot))try{let t=JSON.parse(Ii(Ot,"utf8"));t.errors=(t.errors||0)+1,$i(Ot,JSON.stringify(t,null,2))}catch{}}function Ke(t){let e=t.agent_id||"",n=t.subagent_type||"",r=t.error||"";return c("subagent-quality-gate",`Quality gate check: ${n} (${e})`),r&&r!=="null"?(c("subagent-quality-gate",`ERROR: Subagent failed - ${r}`),wi(),C(`Subagent ${n} failed: ${r}`)):d()}function Ti(t){let e=t.error||t.tool_error,n=t.exit_code;if(e&&e!=="null"&&e!==""||n!==void 0&&n!==0)return!1;let r=t.agent_output||t.output||"",s=[/\bfailed\b/i,/\berror:\s/i,/\bexception\b/i,/\bcould not\b/i,/\bunable to\b/i],i=r.slice(0,500);for(let o of s)o.test(i)&&c("task-completer",`Warning: possible error in output: ${o}`);return!0}function Xe(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return c("task-completer","No agent type found, skipping"),d();c("task-completer",`Processing SubagentStop for: ${n}`);let r=A(n);if(!r)return c("task-completer",`No orchestration task found for agent: ${n}`),dt(n),d();let s=Ti(t),i=s?"completed":"failed";c("task-completer",`Agent ${n} completed with status: ${i}`),I(r.taskId,i),E(n,i);let o=`## Orchestration: Task ${s?"Completed":"Failed"}

Agent \`${n}\` has finished with status: **${i}**

${V({taskId:r.taskId,status:s?"completed":"pending"})}
`;if(s&&r.pipelineId&&r.pipelineStep!==void 0){let a=De(r.pipelineId,r.pipelineStep);if(a!==null){let u=vt(r.pipelineId).filter(g=>g.pipelineStep===a&&g.status==="pending");u.length>0&&(o+=`
### Pipeline Progress

Pipeline \`${r.pipelineId}\` step ${r.pipelineStep} complete.
Next step (${a}) is now unblocked.

**Next agent(s) to spawn:**
${u.map(g=>`- \`${g.agent}\` (task: ${g.taskId})`).join(`
`)}

Consider spawning the next agent to continue the pipeline.`)}else o+=`
### Pipeline Complete

Pipeline \`${r.pipelineId}\` has completed all steps.`}if(!s){let a=t.error||t.tool_error||"Unknown error";o+=`
### Error Details

The agent encountered an issue:
\`\`\`
${a.slice(0,500)}
\`\`\`

Consider:
1. Retrying with more specific instructions
2. Using an alternative agent
3. Breaking down the task further`;let u=we(r.taskId);if(u.length>0){o+=`

### Orphaned Tasks (CC 2.1.20)

The following tasks were blocked by the failed task and should be deleted:
`;for(let g of u)o+=`
${Ie(g.taskId,`Blocked by failed task ${r.taskId} (agent: ${n})`)}`,I(g.taskId,"failed")}}return i==="completed"&&dt(n),c("task-completer",`Completed task ${r.taskId} with status ${i}`),D(o)}var Pt=new Map;function Di(t,e){let n=Pt.get(t)||[];n.push(e),n.length>10&&n.shift(),Pt.set(t,n)}function Ai(){let t=[];for(let[e,n]of Pt)n.some(r=>r.outcome==="failure")&&t.push(e);return t}function Ri(t){let e=t.error||t.tool_error,n=t.exit_code,r=t.agent_output||t.output||"";if(e&&e!=="null"&&e!=="")return{outcome:"failure",error:e};if(n!==void 0&&n!==0)return{outcome:"failure",error:`Exit code: ${n}`};let s=[/i cannot|i can't|i am unable/i,/outside my scope/i,/not appropriate/i,/i refuse/i];for(let o of s)if(o.test(r.slice(0,500)))return{outcome:"rejected",error:"Agent rejected the task"};let i=[/partial(?:ly)?/i,/incomplete/i,/some.*failed/i,/couldn't finish/i];for(let o of i)if(o.test(r.slice(0,500)))return{outcome:"partial"};return{outcome:"success"}}function Qe(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return d();let{outcome:r,error:s}=Ri(t);if(r==="success")return d();c("retry-handler",`Agent ${n} completed with outcome: ${r}`);let i=pt(),a=$().activeAgents.find(y=>y.agent===n),u=a?.retryCount||0,g=se(n,u+1,a?.taskId),p=ie(g,r,s||void 0);Di(n,p);let f=Ai(),m=re(n,u+1,s||"Unknown failure",f,i.maxRetries);if(c("retry-handler",`Retry decision for ${n}: shouldRetry=${m.shouldRetry}, alternative=${m.alternativeAgent||"none"}`),m.shouldRetry)E(n,"retrying");else{E(n,"failed");let y=A(n);y&&I(y.taskId,"failed")}let b=oe(m,n);return D(b)}import{existsSync as rn,mkdirSync as Ui,readFileSync as Bi,writeFileSync as qi}from"node:fs";import{existsSync as Ci,readFileSync as Ei,writeFileSync as iu,mkdirSync as ou}from"node:fs";import{execSync as Ye}from"node:child_process";import{createHash as Oi}from"node:crypto";import*as Ze from"node:os";var Pi=".claude/.user_identity.json",ji="orchestkit-user-identity-v1";var _=null;function et(t){return Oi("sha256").update(t+ji).digest("hex").slice(0,32)}function Hi(){try{return Ze.hostname()}catch{return"unknown-machine"}}function Ni(t){let e=`${t}/${Pi}`;if(!Ci(e))return null;try{let n=Ei(e,"utf8");return JSON.parse(n)}catch(n){return c("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function Mi(t){let e={};try{e.email=Ye("git config user.email",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{e.name=Ye("git config user.name",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return e}function Fi(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function Li(t){if(_)return _;let e=t||l(),n=Hi(),r=Ni(e);if(r?.user_id)return _={user_id:r.user_id,display_name:r.display_name||r.user_id,team_id:r.team_id,machine_id:n,source:"config",anonymous_id:et(r.user_id),email:r.user_id.includes("@")?r.user_id:void 0},c("user-identity",`Resolved from config: ${_.anonymous_id}`,"debug"),_;let s=Mi(e);if(s.email)return _={user_id:s.email,display_name:s.name||s.email.split("@")[0],team_id:r?.team_id,machine_id:n,source:"git",anonymous_id:et(s.email),email:s.email},c("user-identity",`Resolved from git: ${_.anonymous_id}`,"debug"),_;let i=Fi();if(i.username){let a=`${i.username}@${n}`;return _={user_id:a,display_name:i.username,team_id:r?.team_id,machine_id:n,source:"env",anonymous_id:et(a)},c("user-identity",`Resolved from env: ${_.anonymous_id}`,"debug"),_}let o=et(n+process.pid);return _={user_id:`anon-${o.slice(0,8)}`,display_name:"Anonymous",team_id:r?.team_id,machine_id:n,source:"anonymous",anonymous_id:o},c("user-identity",`Resolved as anonymous: ${_.anonymous_id}`,"debug"),_}function tn(){let t=Li();return{session_id:S(),user_id:t.user_id,anonymous_id:t.anonymous_id,team_id:t.team_id,machine_id:t.machine_id,identity_source:t.source,timestamp:new Date().toISOString()}}var Gi=/^[a-zA-Z0-9_-]{1,128}$/;function Ji(t){return Gi.test(t)}function Nt(t,e){let n=t||S(),r=e||l();if(!Ji(n))throw new Error("Invalid session ID format");return`${r}/.claude/memory/sessions/${n}`}function zi(t,e){return`${Nt(t,e)}/events.jsonl`}function sn(t,e){let n=Nt(t,e);rn(n)||Ui(n,{recursive:!0})}var B=0,en=!1,jt=!1,nn=0,Wi=5e3;function on(t,e){return`${Nt(t,e)}/counter.json`}function Vi(t,e){if(!en){en=!0;try{let n=on(t,e);if(rn(n)){let r=JSON.parse(Bi(n,"utf8"));typeof r.counter=="number"&&r.counter>0&&(B=r.counter,c("session-tracker",`Loaded event counter: ${B}`,"debug"))}}catch{}}}function Ki(t,e){if(!jt)return;let n=Date.now();if(!(n-nn<Wi))try{sn(t,e);let r=on(t,e);qi(r,JSON.stringify({counter:B,updated_at:new Date().toISOString()})),jt=!1,nn=n}catch{}}function Xi(){return Vi(),B++,jt=!0,Ki(),`evt-${Date.now()}-${B}`}function an(t,e,n={}){try{let r={event_id:Xi(),event_type:t,identity:tn(),payload:{name:e,input:Ht(n.input),output:Ht(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?cn(n.context,500):void 0,confidence:n.confidence}};sn();let s=zi();h(s,`${JSON.stringify(r)}
`),c("session-tracker",`Tracked ${t}: ${e}`,"debug")}catch(r){c("session-tracker",`Failed to track event: ${r}`,"warn")}}function cn(t,e){return t.length<=e?t:`${t.slice(0,e-3)}...`}function Ht(t){if(!t)return;let e={},n=["password","secret","token","key","credential","auth"];for(let[r,s]of Object.entries(t)){if(n.some(i=>r.toLowerCase().includes(i))){e[r]="[REDACTED]";continue}if(typeof s=="string"&&s.length>500){e[r]=cn(s,500);continue}if(typeof s=="object"&&s!==null&&!Array.isArray(s)){e[r]=Ht(s);continue}e[r]=s}return e}import{mkdirSync as Qi,statSync as Yi,renameSync as Zi}from"node:fs";import{createHash as to}from"node:crypto";function eo(){return at(it(),".claude","analytics")}function un(t){return to("sha256").update(t).digest("hex").slice(0,12)}function gn(){let t=process.env.CLAUDE_CODE_TEAM_NAME;return t?{team:t}:void 0}function no(t,e=10485760){try{if(Yi(t).size>e){let r=new Date().toISOString().slice(0,7),s=t.replace(/\.jsonl$/,`.${r}.jsonl`);Zi(t,s)}}catch{}}function ro(){return!!(process.env.VITEST||process.env.JEST_WORKER_ID)}function ln(t,e){if(!ro())try{let n=eo();Qi(n,{recursive:!0});let r=at(n,t);no(r),h(r,`${JSON.stringify(e)}
`)}catch{}}var dn=[{name:"context-publisher",fn:Y},{name:"handoff-preparer",fn:tt},{name:"feedback-loop",fn:Z},{name:"agent-memory-store",fn:X}];function so(t){try{let e=t.tool_input?.subagent_type||t.subagent_type||t.agent_type||"unknown",n=t.tool_input?.name||void 0,r=!t.error,s=t.duration_ms,i=t.agent_output||t.output||"",o=typeof i=="string"?i.length:0;an("agent_spawned",e,{success:r,duration_ms:s,output:{has_output:o>0,output_length:o,has_error:!!t.error},context:t.agent_id});let a=t.tool_input?.model||process.env.CLAUDE_MODEL||"unknown";ln("agent-usage.jsonl",{ts:new Date().toISOString(),pid:un(process.env.CLAUDE_PROJECT_DIR||""),agent:e,agent_name:n??null,model:a,duration_ms:s,success:r,output_len:o,last_msg_len:t.last_assistant_message?.length??null,...gn()})}catch{}}async function pn(t){so(t);let n=(await Promise.allSettled(dn.map(async r=>{try{let s=r.fn(t);return s instanceof Promise&&await s,{hook:r.name,status:"success"}}catch(s){let i=s instanceof Error?s.message:String(s);return c("subagent-stop-dispatcher",`${r.name} failed: ${i}`),{hook:r.name,status:"error",message:i}}}))).filter(r=>r.status==="rejected"||r.status==="fulfilled"&&r.value.status==="error");return n.length>0&&c("subagent-stop-dispatcher",`${n.length}/${dn.length} hooks had errors`),d()}var mn={"subagent-start/graph-memory-inject":pe,"subagent-start/context-gate":ye,"subagent-start/subagent-context-stager":be,"subagent-start/subagent-validator":xe,"subagent-start/task-linker":Ae,"subagent-start/model-cost-advisor":Ee,"subagent-start/issue-context-injector":Oe,"subagent-stop/agent-memory-store":X,"subagent-stop/auto-spawn-quality":He,"subagent-stop/context-publisher":Y,"subagent-stop/feedback-loop":Z,"subagent-stop/handoff-preparer":tt,"subagent-stop/multi-claude-verifier":We,"subagent-stop/output-validator":Ve,"subagent-stop/subagent-quality-gate":Ke,"subagent-stop/task-completer":Xe,"subagent-stop/retry-handler":Qe,"subagent-stop/unified-dispatcher":pn};function Wu(t){return mn[t]}function Vu(){return Object.keys(mn)}export{zo as DEFAULT_CONFIG,Jo as THRESHOLDS,na as addToPromptHistory,la as analyzeAttemptHistory,ka as applyDecay,sa as cacheClassification,rr as calculateBackoffDelay,ca as cleanupOldStates,aa as clearSessionState,ie as completeAttempt,se as createAttempt,qo as escapeRegex,Vn as estimateTokenCount,oe as formatRetryDecision,Qo as getActiveAgent,Sa as getAdjustments,_a as getAgentSuccessRate,mt as getAlternativeAgent,Kt as getCachedBranch,ba as getCalibrationStats,Ao as getEnvFile,Uo as getField,Wu as getHook,ea as getInjectedSkills,ia as getLastClassification,Vt as getLogDir,qn as getLogLevel,J as getPluginRoot,l as getProjectDir,ra as getPromptHistory,S as getSessionId,xa as hasMinimalCalibrationData,pr as hashPrompt,mn as hooks,Yo as isAgentDispatched,oo as isBashInput,co as isEditInput,uo as isReadInput,sr as isRetryableError,ta as isSkillInjected,ao as isWriteInput,Vu as listHooks,F as loadCalibrationData,pt as loadConfig,$ as loadState,c as logHook,Mo as logPermissionFeedback,re as makeRetryDecision,Bo as normalizeCommand,Ro as normalizeLineEndings,Po as outputAllowWithContext,Eo as outputBlock,ut as outputDeny,jo as outputError,Jn as outputPromptContext,Fo as outputPromptContextBudgeted,Co as outputSilentAllow,d as outputSilentSuccess,Ho as outputStderrWarning,C as outputWarning,D as outputWithContext,Oo as outputWithNotification,No as outputWithUpdatedInput,da as prepareForRetry,Lo as readHookInput,ha as recordOutcome,dt as removeAgent,dr as saveCalibrationData,oa as saveConfig,Xn as saveState,Gn as shouldLog,ir as suggestsAlternative,Xo as trackDispatchedAgent,Zo as trackInjectedSkill,E as updateAgentStatus,P as updateState};
//# sourceMappingURL=subagent.mjs.map
