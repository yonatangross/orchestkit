// OrchestKit Hooks - subagent bundle
// Generated: 2026-02-20T19:29:02.706Z

var gt=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,n)=>(typeof require<"u"?require:e)[n]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});function po(t){return typeof t.command=="string"}function mo(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function fo(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function yo(t){return typeof t.file_path=="string"&&t.content===void 0}import{existsSync as re,statSync as Gn,renameSync as Jn,mkdirSync as zn,readSync as Wn}from"node:fs";import{appendFileSync as xn,mkdirSync as vn}from"node:fs";import{dirname as In}from"node:path";var J=[],dt=!1,Kt=!1;function h(t,e){J.push({filePath:t,content:e}),$n()}function pt(){if(dt||J.length===0)return;dt=!0;let t=new Map;for(let e of J){let n=t.get(e.filePath);n?n.push(e.content):t.set(e.filePath,[e.content])}for(let[e,n]of t)try{vn(In(e),{recursive:!0}),xn(e,n.join(""))}catch{}J.length=0,dt=!1}function $n(){Kt||(Kt=!0,process.on("exit",pt),process.on("SIGTERM",()=>{pt(),process.exit(0)}),process.on("SIGINT",()=>{pt(),process.exit(0)}))}import{execSync as Vn}from"node:child_process";import Xt from"node:os";import M from"node:path";function mt(){return process.env.HOME||process.env.USERPROFILE||Xt.homedir()}function wn(){return Xt.tmpdir()}function ft(){return process.env.CLAUDE_PROJECT_DIR||"."}function Qt(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function Yt(){return process.env.CLAUDE_PLUGIN_ROOT?M.join(mt(),".claude","logs","ork"):M.join(ft(),".claude","logs")}function Zt(){return process.env.CLAUDE_METRICS_FILE||M.join(wn(),"claude-session-metrics.json")}var yt=M.join,vo=M.sep;import{execSync as Tn}from"node:child_process";import{createHash as An}from"node:crypto";import{existsSync as te,readFileSync as Dn,writeFileSync as Cn,mkdirSync as Rn}from"node:fs";import{join as ht,basename as En}from"node:path";var On=20,Pn=15,jn=/[^a-z0-9-]/g;function Hn(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=En(e);return ee(n,On)}function Nn(t){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=Tn("git branch --show-current",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),r=ee(n||"detached",Pn);return process.env.ORCHESTKIT_SESSION_BRANCH=r,r}catch{return"nobranch"}}function Mn(t){let e=t||new Date,n=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${n}${r}`}function Ln(t){let e=t||new Date,n=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0");return`${n}${r}`}function Fn(){let t=`${process.pid}-${Date.now()}-${Math.random()}`;return An("sha256").update(t).digest("hex").slice(0,4)}function ee(t,e){return t.toLowerCase().replace(jn,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,e)}function Un(t,e){let n=Hn(t),r=Nn(t),s=Mn(e),i=Ln(e),o=Fn();return`${n}-${r}-${s}-${i}-${o}`}function Bn(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=ht(e,".instance","session-id.json");if(te(n))try{let r=JSON.parse(Dn(n,"utf8"));if(r.session_id&&r.created_at){let s=Date.now()-new Date(r.created_at).getTime(),i=1440*60*1e3;if(s<i)return r.session_id}}catch{}}function qn(t,e){let n=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),r=ht(n,".instance"),s=ht(r,"session-id.json");try{te(r)||Rn(r,{recursive:!0}),Cn(s,JSON.stringify({session_id:t,created_at:new Date().toISOString()},null,2))}catch{}}function ne(t){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let e=Bn(t);if(e)return e;let n=Un(t);return qn(n,t),n}function se(){return Yt()}function g(){return ft()}function z(){return Qt()}function jo(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${z()}/.claude/.instance_env`}function S(){return ne()}function ie(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let e=Vn("git branch --show-current",{cwd:t||g(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function Kn(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Ho(t){return t.replace(/\r\n/g,`
`)}function Xn(t){let e=["debug","info","warn","error"];return e.indexOf(t)>=e.indexOf(Kn())}function d(){return{continue:!0,suppressOutput:!0}}function No(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function Mo(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function A(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function Qn(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function Lo(t,e){let n={continue:!0,suppressOutput:!0};return t&&(n.systemMessage=t),e&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:e}),n}function Fo(t,e){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?n.systemMessage=e:n.suppressOutput=!0,n}function Uo(t){return{continue:!0,systemMessage:t}}function R(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function Bo(t){process.stderr.write(`\u26A0 ${t}
`),process.exit(2)}function kt(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}function qo(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:t}}}var Yn=200*1024,Zn=100*1024;function oe(t,e){if(re(t))try{if(Gn(t).size>e){let r=`${t}.old.${Date.now()}`;Jn(t,r)}}catch{}}function ae(t){re(t)||zn(t,{recursive:!0})}function c(t,e,n="debug"){if(!Xn(n))return;let r=se(),s=`${r}/hooks.log`;try{ae(r),oe(s,Yn);let i=new Date().toISOString().replace("T"," ").slice(0,19);h(s,`[${i}] [${n.toUpperCase()}] [${t}] ${e}
`)}catch{}}function Go(t,e,n){let r=se(),s=`${r}/permission-feedback.log`;try{ae(r),oe(s,Zn);let i=new Date().toISOString(),o=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",a=n?.session_id||S();h(s,`${i} | ${t} | ${e} | tool=${o} | session=${a}
`)}catch{}}function ce(t){return t.hookSpecificOutput?.additionalContext?t.hookSpecificOutput.additionalContext:t.systemMessage&&typeof t.systemMessage=="string"?t.systemMessage:null}function W(t){if(!t)return 0;let r=(t.match(/[{};()=><]/g)||[]).length/t.length>.03?2.8:3.5;return Math.ceil(t.length/r)}function Jo(t,e,n,r,s){let i=W(t);return r?.isOverBudget(n)?(c(e,`Budget exhausted for ${n}, suppressing ${i}t`),d()):(s&&s.trackTokenUsage(e,n,i),Qn(t))}function zo(){try{let t=[],n=Buffer.allocUnsafe(256),r,s=0;for(;;)try{if(r=Wn(s,n,0,256,null),r===0)break;t.push(Buffer.from(n.subarray(0,r)))}catch{break}let i=Buffer.concat(t).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:S(),tool_input:{}}}catch{return{tool_name:"",session_id:S(),tool_input:{}}}}function Wo(t,e){let n=e.replace(/^\./,"").split("."),r=t;for(let s of n){if(r==null)return;r=r[s]}return r}function St(t,...e){return t.split(`
`).some(n=>e.every(r=>n.includes(r)))}function Vo(t,...e){return t.split(`
`).some(n=>{let r=n.toLowerCase();return e.every(s=>r.includes(s.toLowerCase()))})}function Ko(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function Xo(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var Yo={AUTO_DISPATCH:85,SKILL_INJECT:80,STRONG_RECOMMEND:70,SUGGEST:50,MINIMUM:40},Zo={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:1200,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};import{existsSync as L,readFileSync as le,writeFileSync as ge,mkdirSync as tr}from"node:fs";function _t(){return`${g()}/.claude/orchestration`}function bt(){let t=S();return`${_t()}/session-${t}.json`}function de(){return`${g()}/.claude/orchestration/config.json`}function pe(){let t=_t();if(!L(t))try{tr(t,{recursive:!0})}catch{c("orchestration-state",`Failed to create state dir: ${t}`)}}function I(){let t=bt();if(L(t))try{let e=le(t,"utf8");return JSON.parse(e)}catch(e){c("orchestration-state",`Failed to load state: ${e}`)}return{sessionId:S(),activeAgents:[],injectedSkills:[],promptHistory:[],maxHistorySize:10,updatedAt:new Date().toISOString()}}function er(t){pe();let e=bt();t.updatedAt=new Date().toISOString();try{ge(e,JSON.stringify(t,null,2))}catch(n){c("orchestration-state",`Failed to save state: ${n}`)}}function j(t){let e=I();return t(e),er(e),e}function ra(t,e,n){let r={agent:t,taskId:n,confidence:e,dispatchedAt:new Date().toISOString(),status:"pending",retryCount:0,maxRetries:3};return j(s=>{s.activeAgents=s.activeAgents.filter(i=>i.agent!==t),s.activeAgents.push(r)}),c("orchestration-state",`Tracked dispatched agent: ${t} (conf: ${e})`),r}function E(t,e,n){j(r=>{let s=r.activeAgents.find(i=>i.agent===t);s&&(s.status=e,n&&(s.taskId=n),e==="retrying"&&s.retryCount++)}),c("orchestration-state",`Updated agent status: ${t} -> ${e}`)}function xt(t){j(e=>{e.activeAgents=e.activeAgents.filter(n=>n.agent!==t)})}function sa(){return I().activeAgents.find(e=>e.status==="in_progress")}function ia(t){return I().activeAgents.some(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function oa(t){j(e=>{e.injectedSkills.includes(t)||e.injectedSkills.push(t)})}function aa(t){return I().injectedSkills.includes(t)}function ca(){return I().injectedSkills}function ua(t){j(e=>{e.promptHistory.push(t),e.promptHistory.length>e.maxHistorySize&&(e.promptHistory=e.promptHistory.slice(-e.maxHistorySize))})}function la(){return I().promptHistory}function ga(t){j(e=>{e.lastClassification=t})}function da(){return I().lastClassification}var ue={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:1200,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function vt(){let t=de();if(L(t))try{let e=le(t,"utf8");return{...ue,...JSON.parse(e)}}catch{}return ue}function pa(t){pe();let e=de(),r={...vt(),...t};try{ge(e,JSON.stringify(r,null,2))}catch(s){c("orchestration-state",`Failed to save config: ${s}`)}}function ma(){let t=bt();try{if(L(t)){let{unlinkSync:e}=gt("node:fs");e(t),c("orchestration-state","Cleared session state")}}catch{}}function fa(){let t=_t();if(L(t))try{let{readdirSync:e,statSync:n,unlinkSync:r}=gt("node:fs"),s=e(t).filter(i=>i.startsWith("session-")&&i.endsWith(".json")).map(i=>({name:i,path:`${t}/${i}`,mtime:n(`${t}/${i}`).mtime.getTime()})).sort((i,o)=>o.mtime-i.mtime);for(let i of s.slice(5))try{r(i.path),c("orchestration-state",`Cleaned up old state: ${i.name}`)}catch{}}catch{}}var nr=3,rr=1e3,sr=3e4,ir={"backend-system-architect":["database-engineer","api-designer"],"frontend-ui-developer":["rapid-ui-designer","accessibility-specialist"],"test-generator":["debug-investigator","code-quality-reviewer"],"security-auditor":["security-layer-auditor"],"workflow-architect":["llm-integrator","data-pipeline-engineer"]},or=[{test:t=>/permission denied/i.test(t)},{test:t=>/access denied/i.test(t)},{test:t=>/not found/i.test(t)&&/file|module|package/i.test(t)},{test:t=>/(?:file|module|package)\s+not\s+found/i.test(t)},{test:t=>/missing required/i.test(t)},{test:t=>/invalid (?:api|token|key)/i.test(t)},{test:t=>/authentication failed/i.test(t)},{test:t=>/quota exceeded/i.test(t)},{test:t=>/rate limit/i.test(t)}],ar=[/not my specialization/i,/outside my scope/i,/better suited for/i,/consider using/i,/specialized agent/i];function cr(t,e=rr){let n=e*2**(t-1),r=Math.random()*.1*n;return Math.min(n+r,sr)}function ur(t){for(let e of or)if(e.test(t))return!1;return!0}function lr(t){for(let e of ar)if(e.test(t))return!0;return!1}function It(t,e=[]){let n=ir[t];if(n){for(let r of n)if(!e.includes(r))return r}}function me(t,e,n,r=[],s=nr){if(c("retry-manager",`Evaluating retry for ${t}, attempt ${e}`),e>=s){let o=It(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Max retries (${s}) exceeded`+(o?`. Consider trying ${o} instead.`:"")}}if(!ur(n)){let o=It(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Non-retryable error detected: ${n.slice(0,100)}`}}if(lr(n)){let o=It(t,r);if(o)return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Error suggests using alternative agent: ${o}`}}let i=cr(e);return{shouldRetry:!0,retryCount:e,maxRetries:s,delayMs:i,reason:`Retrying (attempt ${e+1}/${s}) after ${Math.round(i/1e3)}s`}}function fe(t,e,n){return{agent:t,taskId:n,attemptNumber:e,startedAt:new Date().toISOString()}}function ye(t,e,n){let r=new Date().toISOString(),s=new Date(r).getTime()-new Date(t.startedAt).getTime();return{...t,completedAt:r,outcome:e,error:n,durationMs:s}}function ka(t){if(t.length===0)return{successRate:0,avgDuration:0,commonErrors:[]};let n=t.filter(a=>a.outcome==="success").length/t.length,r=t.filter(a=>a.durationMs!==void 0).map(a=>a.durationMs),s=r.length>0?r.reduce((a,u)=>a+u,0)/r.length:0,i=new Map;for(let a of t)if(a.error){let u=a.error.slice(0,50).toLowerCase();i.set(u,(i.get(u)||0)+1)}let o=Array.from(i.entries()).sort((a,u)=>u[1]-a[1]).slice(0,3).map(([a])=>a);return{successRate:n,avgDuration:s,commonErrors:o}}function Sa(t,e){return{...t,status:"retrying",retryCount:e.retryCount}}function he(t,e){if(t.shouldRetry)return`## Retry Scheduled

Agent \`${e}\` will retry after ${Math.round((t.delayMs||0)/1e3)} seconds.

**Attempt:** ${t.retryCount+1} of ${t.maxRetries}
**Reason:** ${t.reason}`;let n=`## Retry Not Recommended

Agent \`${e}\` has ${t.retryCount>=t.maxRetries?"exhausted retries":"encountered a non-retryable error"}.

**Reason:** ${t.reason}`;return t.alternativeAgent&&(n+=`

### Alternative Suggestion

Consider using \`${t.alternativeAgent}\` instead:

\`\`\`
Task tool with subagent_type: "${t.alternativeAgent}"
\`\`\``),n}import{existsSync as be,readFileSync as gr,writeFileSync as dr,mkdirSync as pr}from"node:fs";import{createHash as mr}from"node:crypto";var ke=500,$t=3,Se=15,_e=3,fr=.9;function xe(){return`${g()}/.claude/feedback/calibration-data.json`}function yr(){let t=`${g()}/.claude/feedback`;if(!be(t))try{pr(t,{recursive:!0})}catch{}}function F(){let t=xe();if(be(t))try{return JSON.parse(gr(t,"utf8"))}catch{c("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function hr(t){yr();let e=xe();t.updatedAt=new Date().toISOString();try{dr(e,JSON.stringify(t,null,2)),c("calibration-engine","Saved calibration data")}catch(n){c("calibration-engine",`Failed to save calibration data: ${n}`)}}function kr(t){return mr("sha256").update(t.toLowerCase().trim()).digest("hex").slice(0,16)}function Ia(t,e,n,r,s,i,o){let a=F(),u={timestamp:new Date().toISOString(),sessionId:S(),agent:e,promptHash:kr(t),matchedKeywords:n,dispatchConfidence:r,outcome:s,durationMs:i,feedback:o};a.records.push(u),a.records.length>ke&&(a.records=a.records.slice(-ke)),Sr(a,u),_r(a),hr(a),c("calibration-engine",`Recorded outcome: ${e} -> ${s} (conf: ${r})`)}function Sr(t,e){let n=e.outcome==="success",r=e.outcome==="failure"||e.outcome==="rejected";if(!n&&!r)return;let s=n?_e:-_e;for(let i of e.matchedKeywords){let o=t.adjustments.find(a=>a.keyword===i&&a.agent===e.agent);o?(o.adjustment=Math.max(-Se,Math.min(Se,o.adjustment+s)),o.sampleCount++,o.lastUpdated=new Date().toISOString()):t.adjustments.push({keyword:i,agent:e.agent,adjustment:s,sampleCount:1,lastUpdated:new Date().toISOString()})}}function $a(t){let e=Date.now(),n=1440*60*1e3;for(let r of t.adjustments){let s=e-new Date(r.lastUpdated).getTime();Math.floor(s/n)>7&&(r.adjustment=Math.round(r.adjustment*fr),Math.abs(r.adjustment)<1&&(r.adjustment=0))}t.adjustments=t.adjustments.filter(r=>r.adjustment!==0)}function _r(t){let e=t.records;if(e.length===0)return;t.stats.totalDispatches=e.length;let n=e.filter(i=>i.outcome==="success").length;t.stats.successRate=n/e.length;let r=e.reduce((i,o)=>i+o.dispatchConfidence,0)/e.length;t.stats.avgConfidence=Math.round(r);let s=new Map;for(let i of e){let o=s.get(i.agent)||{count:0,success:0};o.count++,i.outcome==="success"&&o.success++,s.set(i.agent,o)}t.stats.topAgents=Array.from(s.entries()).map(([i,o])=>({agent:i,count:o.count,successRate:o.success/o.count})).sort((i,o)=>o.count-i.count).slice(0,10)}function wa(){return F().adjustments.filter(e=>e.sampleCount>=$t)}function Ta(t){let n=F().records.filter(s=>s.agent===t);return n.length<$t?null:n.filter(s=>s.outcome==="success").length/n.length}function Aa(){return F().stats}function Da(){return F().records.length>=$t}import{existsSync as br,statSync as xr}from"node:fs";import{resolve as vr}from"node:path";var Ir={"database-engineer":"database schema SQL PostgreSQL migration pgvector","backend-system-architect":"API REST architecture backend FastAPI microservice","frontend-ui-developer":"React frontend UI component TypeScript Tailwind","security-auditor":"security OWASP vulnerability audit authentication","test-generator":"testing unit integration coverage pytest MSW","workflow-architect":"LangGraph workflow agent orchestration state","llm-integrator":"LLM API OpenAI Anthropic embeddings RAG function-calling","data-pipeline-engineer":"data pipeline embeddings vector ETL chunking","metrics-architect":"metrics OKR KPI analytics instrumentation","ux-researcher":"UX user research persona journey accessibility","code-quality-reviewer":"code quality review linting type-check patterns","infrastructure-architect":"infrastructure cloud Docker Kubernetes deployment","ci-cd-engineer":"CI CD pipeline GitHub Actions deployment automation","accessibility-specialist":"accessibility WCAG ARIA screen-reader a11y","product-strategist":"product strategy roadmap features prioritization"};function $r(t){return Ir[t]||t}var ve=100;function V(t){c("graph-memory-inject","Graph memory inject hook starting");let e=vr(g(),".claude/memory/knowledge-graph.jsonl");if(!br(e))return c("graph-memory-inject","No graph data file, skipping"),d();try{let u=xr(e).size;if(u<ve)return c("graph-memory-inject",`Graph too small (${u}B < ${ve}B), skipping`),d()}catch{return c("graph-memory-inject","Could not stat graph file, skipping"),d()}let r=(t.tool_input||{}).subagent_type||"";if(!r)return c("graph-memory-inject","No agent type detected, passing through"),d();let s=`ork:${r}`,i=$r(r);c("graph-memory-inject",`Detected agent type: ${r} (agent_id: ${s})`);let o=`[Graph Memory - Agent Context Load]

Execute this MCP call to load graph context for ${r} agent:

## Graph Memory Entities
\`\`\`
mcp__memory__search_nodes
{"query": "${r} ${i}"}
\`\`\`

## Integration Instructions
1. Execute the graph search to retrieve relevant entities and relationships
2. Review entities for patterns, decisions, and constraints
3. Check relationships between concepts
4. Apply learned patterns to current task

Agent ID: ${s} | Domain: ${i}`,a=`[Graph Memory] Agent: ${r} | ID: ${s} | Load graph context via MCP call above`;return c("graph-memory-inject",`Outputting graph memory instructions for ${r}`),{continue:!0,systemMessage:a,hookSpecificOutput:{additionalContext:o}}}import{existsSync as U,readFileSync as K,writeFileSync as wt,mkdirSync as wr}from"node:fs";import{dirname as Tr}from"node:path";var Ar=6,Dr=8,Cr=5,Rr=/^(test-generator|backend-system-architect|workflow-architect|security-auditor|llm-integrator)$/;function Er(){let t=process.cwd();return t.includes(".claude/worktrees/")||t.includes("/.git/worktrees/")}function Or(){return Er()?{maxBackground:10,maxPerResponse:12}:{maxBackground:Ar,maxPerResponse:Dr}}function Tt(){return`${g()}/.claude/logs/agent-state.json`}function $e(){return`${g()}/.claude/logs/subagent-spawns.jsonl`}function Pr(){let t=Tt(),e=Tr(t);try{wr(e,{recursive:!0})}catch{}if(!U(t)){let n={active_background:[],session_total:0,last_cleanup:null,blocked_count:0};try{wt(t,JSON.stringify(n,null,2))}catch{}}}function jr(){let t=$e();if(!U(t))return 0;try{let r=K(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),s=new Date(Date.now()-300*1e3).toISOString(),i=0;for(let o of r)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>s&&i++}catch{}return i}catch{return 0}}function Hr(){let t=$e();if(!U(t))return 0;try{let r=K(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),s=new Date(Date.now()-2*1e3).toISOString(),i=0;for(let o of r)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>s&&i++}catch{}return i}catch{return 0}}function Nr(){let t=Tt();try{if(U(t)){let e=JSON.parse(K(t,"utf8"));e.blocked_count=(e.blocked_count||0)+1,wt(t,JSON.stringify(e,null,2))}}catch{}}function Ie(){let t=Tt();try{if(U(t)){let e=JSON.parse(K(t,"utf8"));e.session_total=(e.session_total||0)+1,wt(t,JSON.stringify(e,null,2))}}catch{}}function X(t){Pr();let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"",s=e.run_in_background===!0||e.run_in_background==="true";c("context-gate",`Context gate check: ${n} (background=${s})`);let i=jr(),o=Hr();c("context-gate",`Active background: ${i}, Current response: ${o}`);let a=Or();return o>=a.maxPerResponse?(c("context-gate",`BLOCKED: Too many agents in single response (${o} >= ${a.maxPerResponse})`),kt(`Context Overflow Protection

Too many agents spawned in a single response (${o} agents).

Maximum allowed: ${a.maxPerResponse} per response

SOLUTION: Split into multiple responses or use sequential execution.
Consider using the /context-optimization skill first.

Attempted: ${n} - ${r}`)):s&&i>=a.maxBackground?(c("context-gate",`BLOCKED: Too many concurrent background agents (${i} >= ${a.maxBackground})`),Nr(),kt(`Background Agent Limit

Too many background agents running concurrently (${i} active).

Maximum allowed: ${a.maxBackground} concurrent background agents

SOLUTION:
1. Wait for existing agents to complete
2. Run this agent in foreground (remove run_in_background)
3. Use /context-optimization to free up context

Attempted: ${n} - ${r}`)):i>=Cr?(c("context-gate","WARNING: Approaching context budget limit"),Ie(),R(`Context Budget Warning

${i} background agents active (limit: ${a.maxBackground}).

Consider:
- Running remaining agents sequentially
- Using /context-optimization skill
- Waiting for current agents to complete

Proceeding with: ${n} - ${r}`)):Rr.test(n)&&i>=2?(c("context-gate",`WARNING: Expensive agent type with multiple active: ${n}`),R(`Spawning expensive agent (${n}) with ${i} others active`)):(Ie(),c("context-gate",`Context gate passed: ${n}`),d())}import{existsSync as Q,readFileSync as At,readdirSync as Mr}from"node:fs";import{homedir as Lr}from"node:os";import{join as we}from"node:path";function Fr(){return`${g()}/.claude/context/session/state.json`}function Ur(){return`${g()}/.claude/context/knowledge/decisions/active.json`}function Br(){return`${g()}/docs/issues`}function qr(){let t=Fr();if(!Q(t))return{count:0,summary:""};try{let n=JSON.parse(At(t,"utf8")).tasks_pending||[],r=n.length;if(r===0)return{count:0,summary:""};let s=n.slice(0,5).map(i=>`- ${i}`).join(`
`);return{count:r,summary:s}}catch{return{count:0,summary:""}}}function Te(t,e){let n=Ur();if(!Q(n))return"";try{return(JSON.parse(At(n,"utf8")).decisions||[]).filter(o=>o.category===e||o.category==="api"||o.category==="database").slice(0,8).map(o=>`- ${o.title} (${o.status||"unknown"})`).join(`
`)}catch{return""}}function Gr(t){let e=Br();if(!Q(e))return"";try{let r=Mr(e).find(s=>s.includes(t));if(r)return`docs/issues/${r}`}catch{}return""}function Jr(){let t=[],e=we(Lr(),".claude","CLAUDE.md"),n=Ae(e);if(n){let o=De(n,"global");t.push(...o)}let r=we(g(),"CLAUDE.md"),s=Ae(r);if(s){let o=De(s,"project");t.push(...o)}return t.length===0?"":`CRITICAL RULES (inherited from CLAUDE.md):
${[...new Set(t)].slice(0,12).map(o=>`- ${o}`).join(`
`)}

`}function Ae(t){try{return Q(t)?At(t,"utf8"):""}catch{return""}}function De(t,e){let n=[],r=t.split(`
`);for(let s of r){let i=s.trim();if(!(!i||i.startsWith("#")||i.startsWith("```"))){if(/^[-*]\s+/.test(i)){let o=i.replace(/^[-*]\s+/,"").trim();if(/\b(always|never|must|don't|do not|required|NEVER|MUST|DON'T)\b/i.test(o)){let a=o.length>80?`${o.substring(0,77)}...`:o;n.push(a)}}if(/^\*\*(DO|DON'T|DO NOT)\*\*:/.test(i)){let o=i.replace(/\*\*/g,"").trim();o.length<=80&&n.push(o)}}}return n}function Y(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.task_description||e.description||"";c("subagent-context-stager",`Staging context for ${n}`);let s="",i=Jr();i&&(s+=i,c("subagent-context-stager","Injected critical rules from CLAUDE.md"));let{count:o,summary:a}=qr();o>0&&(c("subagent-context-stager",`Found ${o} pending tasks`),s+=`ACTIVE TODOS:
${a}

`);let u=r.toLowerCase();if(/backend|api|endpoint|database|migration/.test(u)){c("subagent-context-stager","Backend task detected - staging backend decisions");let l=Te(r,"backend");l&&(s+=`RELEVANT DECISIONS:
${l}

`)}if(/frontend|react|ui|component/.test(u)){c("subagent-context-stager","Frontend task detected - staging frontend decisions");let l=Te(r,"frontend");l&&(s+=`RELEVANT DECISIONS:
${l}

`)}if(/test|testing|pytest|jest/.test(u)&&(c("subagent-context-stager","Testing task detected - staging test context"),s+=`TESTING REMINDERS:
- Use 'tee' for visible test output
- Check test patterns in backend/tests/ or frontend/src/**/__tests__/
- Ensure coverage meets threshold requirements

`),/issue|#\d+|bug|fix/.test(u)){c("subagent-context-stager","Issue-related task detected");let l=r.match(/#(\d+)/);if(l){let p=l[1],m=Gr(p);m&&(s+=`ISSUE DOCS: ${m}

`,c("subagent-context-stager",`Staged issue documentation for #${p}`))}}if(s){let l=`${s}
Task: ${r}
Subagent: ${n}`,p=s.split(`
`).filter(Boolean).length;return c("subagent-context-stager",`Staged context with ${p} lines`),{continue:!0,systemMessage:l}}return c("subagent-context-stager","No context staged for this task"),d()}import{existsSync as B,readFileSync as Dt,mkdirSync as zr,readdirSync as Wr}from"node:fs";import{join as v,dirname as Vr}from"node:path";var Kr=new Set(["general-purpose","Explore","Plan","claude-code-guide","statusline-setup","Bash"]);function Xr(){return v(g(),".claude","logs","subagent-spawns.jsonl")}function Qr(){return v(g(),"plugin.json")}function Ct(){return v(g(),"agents")}function Rt(){return v(g(),".claude","agents")}function Yr(){return v(g(),"skills")}function Zr(){let t=new Set(Kr),e=Qr();if(B(e))try{let s=JSON.parse(Dt(e,"utf8")).agents||[];for(let i of s)i.id&&t.add(i.id)}catch{}let n=[Ct(),Rt()];for(let r of n)if(B(r))try{let s=Wr(r);for(let i of s)i.endsWith(".md")&&t.add(i.replace(".md",""))}catch{}return t}function ts(t){let e=[],n=[v(Ct(),`${t}.md`),v(Rt(),`${t}.md`)],r=null;for(let s of n)if(B(s)){r=s;break}if(!r)return e;try{let i=Dt(r,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of i){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^skills:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let l=u.match(/^\s*-\s*(.+)$/);if(l){let p=l[1].trim();e.push(p)}}}}}catch{}return e}function es(t){let e=ts(t),n=[],r=Yr();for(let s of e){let i=v(r,s,"SKILL.md");B(i)||n.push(s)}return n}function ns(t){let e=[],n=[v(Ct(),`${t}.md`),v(Rt(),`${t}.md`)],r=null;for(let s of n)if(B(s)){r=s;break}if(!r)return e;try{let i=Dt(r,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of i){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^tools:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let l=u.match(/^\s*-\s*(.+)$/);l&&e.push(l[1].trim())}}}}catch{}return e}function rs(t,e){if(e.length===0)return"";let n=e.every(o=>["Read","Glob","Grep"].includes(o)),r=e.includes("Bash"),s=e.includes("Write")||e.includes("Edit"),i="low";return r&&s?i="elevated":(r||s)&&(i="moderate"),`## Agent Permission Profile (CC 2.1.20)

**Agent**: \`${t}\`
**Tools**: ${e.join(", ")}
**Risk Level**: ${i}${n?" (read-only)":""}

${r?`> This agent requests Bash access. Review commands carefully.
`:""}`}function ss(t,e,n){let r=Xr(),s=Vr(r);try{zr(s,{recursive:!0})}catch{}let i={timestamp:new Date().toISOString(),subagent_type:t,description:e,session_id:n};try{h(r,`${JSON.stringify(i)}
`)}catch{}}function Z(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"",s=t.session_id;c("subagent-validator",`Task invocation: ${n} - ${r}`),ss(n,r,s);let i=n.replace(/^[^:]+:/,""),o=Zr();!o.has(n)&&!o.has(i)&&c("subagent-validator",`WARNING: Unknown subagent type: ${n}`),c("subagent-validator",`Spawning ${n} agent: ${r}`);let a=es(i);if(a.length>0){let l=a.join(", ");c("subagent-validator",`WARNING: Agent '${i}' references missing skills: ${l}`),console.error(`Warning: Agent '${i}' references ${a.length} missing skill(s): ${l}`)}let u=ns(i);if(u.length>0){let l=rs(i,u);return c("subagent-validator",`Agent '${i}' tools: ${u.join(", ")}`),A(l)}return d()}import{existsSync as Ce,readFileSync as is,writeFileSync as os,mkdirSync as as}from"node:fs";function Re(){let t=S();return`${g()}/.claude/orchestration/task-registry-${t}.json`}function cs(){let t=`${g()}/.claude/orchestration`;if(!Ce(t))try{as(t,{recursive:!0})}catch{}}function H(){let t=Re();if(Ce(t))try{return JSON.parse(is(t,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:S(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function Et(t){cs();let e=Re();t.updatedAt=new Date().toISOString();try{os(e,JSON.stringify(t,null,2))}catch(n){c("task-integration",`Failed to save registry: ${n}`)}}function Ee(t,e){return`### Delete Orphaned Task

\`\`\`
TaskUpdate:
  taskId: "${t}"
  status: "deleted"
\`\`\`

**Reason**: ${e}`}function tt(t){let e=`### Update Task

\`\`\`
TaskUpdate:
  taskId: "${t.taskId}"`;return t.status&&(e+=`
  status: "${t.status}"`),t.addBlockedBy&&t.addBlockedBy.length>0&&(e+=`
  addBlockedBy: ${JSON.stringify(t.addBlockedBy)}`),t.addBlocks&&t.addBlocks.length>0&&(e+=`
  addBlocks: ${JSON.stringify(t.addBlocks)}`),e+="\n```",e}function $(t,e){let n=H(),r=n.tasks.find(s=>s.taskId===t);r&&(r.status=e,Et(n),c("task-integration",`Updated task ${t} status to ${e}`))}function D(t){return H().tasks.find(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function Oe(t){return H().tasks.filter(n=>n.status==="pending"&&n.blockedBy&&n.blockedBy.includes(t))}function Ot(t){return H().tasks.filter(n=>n.pipelineId===t).sort((n,r)=>(n.pipelineStep||0)-(r.pipelineStep||0))}function Pe(){return H().pipelines.find(e=>e.status==="running")}function je(t,e){let n=H(),r=n.pipelines.find(i=>i.pipelineId===t);if(!r)return null;r.completedSteps.includes(e)||(r.completedSteps.push(e),r.completedSteps.sort((i,o)=>i-o));let s=Ot(t);for(let i of s){let o=i.pipelineStep;if(o===void 0||r.completedSteps.includes(o)||i.status!=="pending")continue;if(o===0||r.completedSteps.includes(o-1))return r.currentStep=o,Et(n),o}return r.status="completed",Et(n),null}function et(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return c("task-linker","No agent type found, skipping"),d();c("task-linker",`Processing SubagentStart for: ${n}`);let r=D(n);if(!r)return c("task-linker",`No orchestration task found for agent: ${n}`),d();c("task-linker",`Found task ${r.taskId} for agent ${n}`),$(r.taskId,"in_progress"),E(n,"in_progress",r.taskId);let s=tt({taskId:r.taskId,status:"in_progress"}),i=`## Orchestration: Task Linked

Agent \`${n}\` has been linked to task **${r.taskId}**.

${s}

The task status should be updated to \`in_progress\`.`;return c("task-linker",`Linked agent ${n} to task ${r.taskId}`),A(i)}import{mkdirSync as us,existsSync as Pt,readFileSync as jt}from"node:fs";import{join as nt,dirname as ls}from"node:path";var gs=[/security|vulnerab|audit|penetration/i,/architect|design.*system|distributed/i,/migration.*schema|database.*design/i,/performance.*optim|profil|bottleneck/i,/langgraph|workflow.*orchestrat/i],ds=[/\b(?:list|count|check|verify|read|search)\b/i,/\b(?:simple|straightforward|quick)\b/i,/\b(?:format|lint|style|typo|rename)\b/i,/\b(?:status|progress|summary)\b/i],O=new Map,w=new Map;function Ht(t){if(O.has(t))return O.get(t);let e=z();if(!e)return O.set(t,"inherit"),"inherit";let n=nt(e,"agents",`${t}.md`);if(!Pt(n))return O.set(t,"inherit"),"inherit";try{let s=jt(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!s)return O.set(t,"inherit"),"inherit";let i=s[1].match(/^model:\s*(.+)$/m),o=i?i[1].trim():"inherit";return O.set(t,o),o}catch{return O.set(t,"inherit"),"inherit"}}function ps(t){if(w.has(t))return w.get(t);let e=z();if(!e)return w.set(t,null),null;let n=nt(e,"agents",`${t}.md`);if(!Pt(n))return w.set(t,null),null;try{let s=jt(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!s)return w.set(t,null),null;let i=s[1].match(/^skills:\s*\n((?:\s+-\s+.+\n)*)/m);if(!i)return w.set(t,null),null;let o=i[1].match(/^\s+-\s+(.+)$/gm)?.map(l=>l.trim().replace(/^-\s+/,""))||[];if(o.length===0)return w.set(t,null),null;let a={low:0,medium:1,high:2},u="low";for(let l of o.slice(0,5)){let p=nt(e,"skills",l,"SKILL.md");if(!Pt(p))continue;let f=jt(p,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!f)continue;let b=f[1].match(/^complexity:\s*(low|medium|high)$/m);if(b){let y=b[1];a[y]>a[u]&&(u=y)}}return w.set(t,u),u}catch{return w.set(t,null),null}}function He(t,e){let n=ps(t);if(n==="high")return"high";let r=gs.filter(o=>o.test(e)).length,s=Ht(t);return r>=2||s==="opus"?"high":ds.filter(o=>o.test(e)).length>=2?"low":n||"medium"}function Ne(t){let e=Ht(t);return e==="inherit"?process.env.CLAUDE_MODEL||"sonnet":e}function ms(t,e){let n=He(t,e),r=Ne(t);return n==="high"&&r==="haiku"?{recommended:"sonnet",current:r,reason:"High-complexity task \u2014 haiku may produce lower quality results",savingsPercent:0}:n==="low"&&r==="opus"?{recommended:"sonnet",current:r,reason:"Simple task \u2014 sonnet handles this equally well at lower cost",savingsPercent:40}:n==="medium"&&r==="opus"&&Ht(t)!=="opus"?{recommended:"sonnet",current:r,reason:"Medium-complexity task \u2014 sonnet is sufficient",savingsPercent:30}:null}function fs(t,e,n,r){let s=nt(g(),".claude","logs","model-usage.jsonl");try{us(ls(s),{recursive:!0}),h(s,`${JSON.stringify({timestamp:new Date().toISOString(),agent:t,model:e,complexity:n,recommendation:r?.recommended||null,potentialSavings:r?.savingsPercent||0})}
`)}catch{}}function rt(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"";if(!n)return d();let s=He(n,r),i=Ne(n),o=ms(n,r);return fs(n,i,s,o),o?(c("model-cost-advisor",`${n}: Recommend ${o.recommended} over ${o.current} (${o.reason})`,"info"),o.savingsPercent>=30?R(`Model cost: ${n} using ${o.current} for ${s}-complexity task. ${o.reason}. ~${o.savingsPercent}% savings with "${o.recommended}".`):d()):(c("model-cost-advisor",`${n}: ${i} appropriate for ${s} task`),d())}import{existsSync as ys,readFileSync as hs,writeFileSync as ks,statSync as Ss,mkdirSync as _s}from"node:fs";import{execFileSync as bs}from"node:child_process";import{tmpdir as xs}from"node:os";import{join as Nt}from"node:path";var Mt=Nt(xs(),"orchestkit-issue-cache"),vs=300*1e3,Is=3e3;function $s(t){let e=t.match(/^(?:issue|fix|feat|bug|hotfix|feature)\/(\d+)/)||t.match(/^(\d+)-/);return e?e[1]:null}function ws(){try{_s(Mt,{recursive:!0,mode:448})}catch{}}function Ts(t){let e=Nt(Mt,`${t}.json`);try{if(!ys(e))return null;let n=Ss(e);return Date.now()-n.mtimeMs>vs?null:JSON.parse(hs(e,"utf8"))}catch{return null}}function As(t,e){if(!/^\d+$/.test(t))return null;try{let n=bs("gh",["issue","view",t,"--json","title,body,labels"],{cwd:e,encoding:"utf8",timeout:Is,stdio:["pipe","pipe","pipe"]}).trim(),r=JSON.parse(n);try{ws();let s=Nt(Mt,`${t}.json`);ks(s,JSON.stringify(r),"utf8")}catch{}return r}catch{return null}}function Ds(t,e){let n=[];if(e?.title?n.push(`Working on GitHub Issue #${t}: ${e.title}`):n.push(`Working on GitHub Issue #${t}`),e?.labels&&e.labels.length>0){let r=e.labels.map(s=>s.name).join(", ");n.push(`Labels: ${r}`)}return n.push(`Reference #${t} in all commits. Use 'Closes #${t}' in PR description.`),n.join(`
`)}function st(t){try{let e=g(),n=ie(e);c("issue-context-injector",`Branch: ${n}`);let r=$s(n);if(!r)return c("issue-context-injector","No issue number in branch name"),d();c("issue-context-injector",`Detected issue #${r}`);let s=Ts(r)??As(r,e),i=Ds(r,s);return c("issue-context-injector",`Injecting context for issue #${r}`),{continue:!0,systemMessage:i}}catch{return c("issue-context-injector","Unexpected error, falling back to silent success","warn"),d()}}var P="subagent-start-dispatcher",Me=800,Cs=[{name:"subagent-context-stager",fn:Y},{name:"graph-memory-inject",fn:V},{name:"task-linker",fn:et},{name:"model-cost-advisor",fn:rt},{name:"issue-context-injector",fn:st}];function Le(t){try{let u=X(t);if(!u.continue)return c(P,"context-gate blocked agent spawn"),u}catch(u){let l=u instanceof Error?u.message:String(u);c(P,`context-gate failed: ${l}`,"warn")}let e=null;try{let u=Z(t);e=ce(u)}catch(u){let l=u instanceof Error?u.message:String(u);c(P,`subagent-validator failed: ${l}`,"warn")}let n=[],r=[],s=0;if(e){let u=W(e);n.push(e),s+=u}for(let u of Cs)try{let l=u.fn(t);l.systemMessage&&typeof l.systemMessage=="string"&&r.push(l.systemMessage);let p=l.hookSpecificOutput?.additionalContext;if(p){let m=W(p);if(s+m>Me){c(P,`Budget limit: skipping ${u.name} (${m}t would exceed ${Me}t cap)`);continue}n.push(p),s+=m,c(P,`${u.name}: +${m}t (total: ${s}t)`)}}catch(l){let p=l instanceof Error?l.message:String(l);c(P,`${u.name} failed: ${p}`,"warn")}let i=n.length>0,o=r.length>0;if(!i&&!o)return d();let a={continue:!0};if(o&&(a.systemMessage=r.join(`

`)),i){let u=n.join(`

---

`);c(P,`Consolidated ${n.length} hooks into ${s}t`),a.hookSpecificOutput={additionalContext:u}}return a}import{existsSync as Rs,mkdirSync as Es,unlinkSync as Os}from"node:fs";import{basename as Ps,dirname as js}from"node:path";var Hs=["decided to","chose","implemented using","selected","opted for","will use","pattern:","approach:","architecture:","recommends","best practice","anti-pattern","learned that"],Ns="decisions";function Ms(){return`${g()}/.claude/logs/agent-patterns.jsonl`}function Ls(){return`${g()}/.claude/session`}function Fe(){let t=g();return(Ps(t)||"default-project").toLowerCase().replace(/ /g,"-").replace(/[^a-z0-9-]/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-")}function Fs(t){return`${Fe()}-${t}`}function Us(t){let r=(t.length>10240?t.substring(0,10240):t).toLowerCase();return/pagination|cursor|offset/.test(r)?"pagination":/security|vulnerability|exploit|injection|xss|csrf|owasp|safety|guardrail/.test(r)?"security":/database|sql|postgres|schema/.test(r)?"database":/\bapi\b|endpoint|\brest\b|graphql/.test(r)?"api":/auth|login|jwt|oauth/.test(r)?"authentication":/\btest\b|testing|pytest|jest|vitest|coverage|\bmock\b|fixture|\bspec\b/.test(r)?"testing":/deploy|\bci\b|\bcd\b|pipeline|docker|kubernetes|helm|terraform/.test(r)?"deployment":/observability|monitoring|logging|tracing|metrics|prometheus|grafana|langfuse/.test(r)?"observability":/react|component|frontend|\bui\b/.test(r)?"frontend":/performance|optimization|cache|index/.test(r)?"performance":/llm|\brag\b|embedding|vector|semantic|\bai\b|\bml\b|langchain|langgraph|openai|anthropic/.test(r)?"ai-ml":/etl|streaming|dataflow|spark/.test(r)||St(r,"data","pipeline")||St(r,"batch","processing")?"data-pipeline":/architecture|design|structure/.test(r)?"architecture":/decided|chose|selected/.test(r)?"decision":"pattern"}function Bs(t){let e=[];if(t.length<50)return e;for(let r of Hs){let s=r.toLowerCase(),i=t.split(`
`).filter(o=>o.toLowerCase().includes(s));for(let o of i){let a=o.trim().substring(0,200);a.length>20&&e.push(a)}}return[...new Set(e)].slice(0,5)}function it(t){c("agent-memory-store","Agent memory store hook starting");let e=t.tool_input||{},n=t.subagent_type||e.subagent_type||e.type||"",r=t.tool_result,s=typeof r=="string"?r:r?.content||t.agent_output||t.output||"",i=!0;if(t.error&&(i=!1),typeof r=="object"&&r?.is_error&&(i=!1),!n)return c("agent-memory-store","No agent type in input, skipping"),d();let o=`ork:${n}`,a=`${Ls()}/current-agent-id`;try{Rs(a)&&Os(a)}catch{}c("agent-memory-store",`Processing completion for agent: ${n} (agent_id: ${o}, success: ${i})`);let u=i&&s?Bs(s):[];if(u.length===0)return c("agent-memory-store",`No patterns extracted from ${n} output`),d();let l=Ms(),p=js(l);try{Es(p,{recursive:!0})}catch{}let m=Fe(),f=new Date().toISOString(),b=Fs(Ns);for(let k of u){let G=Us(k),Vt={agent:n,agent_id:o,pattern:k,project:m,timestamp:f,scope_id:b,category:G,pending_graph_sync:!0};try{h(l,`${JSON.stringify(Vt)}
`)}catch{}c("agent-memory-store",`Extracted pattern (${G}): ${k.substring(0,50)}...`)}return c("agent-memory-store",`Extracted ${u.length} patterns from ${n} output`),{continue:!0,systemMessage:`[Pattern Extraction] ${u.length} patterns extracted from ${n}. To persist, use mcp__memory__create_entities with entities: [{"name": "${n}-pattern", "entityType": "Pattern", "observations": ["<pattern>"]}]`}}import{existsSync as qs,writeFileSync as Ue,mkdirSync as Lt,readFileSync as Gs}from"node:fs";import{dirname as Js}from"node:path";var zs=[".env","credentials","secret","auth","password","token","api.key","private.key",".pem","oauth","jwt","session","cookie","encryption","crypto"];function Ws(){let t=`${g()}/.claude/hooks/logs`;try{Lt(t,{recursive:!0})}catch{}return`${t}/auto-spawn-quality.log`}function Vs(){return`${g()}/.claude/context/spawn-queue.json`}function x(t){let e=Ws(),n=new Date().toISOString();try{h(e,`[${n}] [auto-spawn-quality] ${t}
`)}catch{}}function Ks(t){let e=t.toLowerCase();for(let n of zs)if(e.includes(n))return x(`Detected sensitive pattern: ${n}`),!0;return!1}function Xs(t,e,n,r,s,i){let o=`SPAWN-${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,14)}-${Math.floor(Math.random()*1e4).toString().padStart(4,"0")}`,a=Vs(),u=Js(a);try{Lt(u,{recursive:!0})}catch{}let l;if(qs(a))try{l=JSON.parse(Gs(a,"utf8"))}catch{l={schema_version:"1.0.0",created_at:i,queue:[]}}else l={schema_version:"1.0.0",created_at:i,queue:[]};let p={spawn_id:o,target_agent:e,trigger_agent:t,trigger_reason:n,priority:r,timestamp:i,session_id:s,status:"queued"};l.queue.push(p);try{Ue(a,JSON.stringify(l,null,2)),x(`Queued spawn request: ${o} for ${e} (reason: ${n})`)}catch{return x(`ERROR: Failed to queue spawn request for ${e}`),""}return o}function Qs(t,e,n,r,s,i){let o=`${g()}/.claude/context/handoffs`;try{Lt(o,{recursive:!0})}catch{}let a=`${o}/auto_spawn_${e}_${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,15)}.json`,u={type:"auto_spawn_suggestion",from_agent:t,to_agent:e,timestamp:i,trigger_reason:n,priority:r,session_id:s,auto_triggered:!0,status:"suggested"};try{Ue(a,JSON.stringify(u,null,2)),x(`Created spawn suggestion: ${e} (reason: ${n})`)}catch{}}function Ys(t,e,n){if(n&&n!=="null")return x(`Skipping auto-spawn - agent ${t} had errors: ${n}`),null;if(t==="test-generator")return x("Rule matched: test-generator -> code-quality-reviewer"),{target:"code-quality-reviewer",reason:"test-generator completed - validating test quality and coverage",priority:"high"};if(Ks(e)&&t!=="security-auditor"&&t!=="security-layer-auditor")return x("Rule matched: sensitive files detected -> security-auditor"),{target:"security-auditor",reason:"sensitive file changes detected - security audit required",priority:"critical"};if(t==="code-quality-reviewer")return x("Rule matched: code-quality-reviewer -> security-auditor"),{target:"security-auditor",reason:"code-quality-reviewer completed - proceeding with security scan",priority:"high"};if(t==="backend-system-architect"){let r=e.toLowerCase();if(/authentication|authorization|security|access.control|rbac|acl/.test(r))return x("Rule matched: backend-system-architect with auth -> security-layer-auditor"),{target:"security-layer-auditor",reason:"backend-system-architect designed auth/security layer - validation required",priority:"high"}}return null}function Be(t){let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",s=t.session_id,i=t.agent_output||t.output||"",o=t.error||"";if(x(`Checking auto-spawn conditions for agent: ${r} (session: ${s})`),r==="unknown"||!r)return x("Skipping unknown agent type"),d();let a=Ys(r,i,o);if(a){let u=Xs(r,a.target,a.reason,a.priority,s,e);return Qs(r,a.target,a.reason,a.priority,s,e),x(`=== AUTO-SPAWN QUALITY HOOK ===
Trigger Agent: ${r}
Target Agent: ${a.target}
Reason: ${a.reason}
Priority: ${a.priority}
Spawn ID: ${u}
Timestamp: ${e}
Session: ${s}`),{continue:!0,systemMessage:`Auto-spawn queued: ${a.target} (${a.priority} priority)`}}return x(`No auto-spawn conditions matched for ${r}`),d()}import{existsSync as Zs,writeFileSync as We,mkdirSync as ti,readFileSync as ei}from"node:fs";import{dirname as Ft}from"node:path";function qe(){return`${g()}/.claude/context/knowledge/decisions/active.json`}function ni(){return`${g()}/.claude/context/session/state.json`}function ri(){return`${g()}/.claude/logs/agent-context`}function ot(t){try{ti(t,{recursive:!0})}catch{}}function Ge(t,e){if(!Zs(t))return e;try{return JSON.parse(ei(t,"utf8"))}catch{return e}}function Je(t,e){let n=Ft(t);ot(n);try{We(t,JSON.stringify(e,null,2))}catch{}}var ze=50;function at(t){let e=t.subagent_type||t.agent_type||"unknown",n=new Date().toISOString(),r=t.agent_output||t.output||"",s=r.substring(0,200);r.length>200&&(s+="...");let i=e!=="unknown"||s.trim().length>0,o=e.replace(/-/g,"_");if(i){let k=qe(),G=Ft(k);ot(G);let N=Ge(k,{schema_version:"2.0.0",decisions:{}});(!N.decisions||typeof N.decisions!="object")&&(N.decisions={});let bn={timestamp:n,agent:e,summary:s,status:"completed"};N.decisions[o]=bn,Je(k,N)}let a=ni(),u=Ft(a);ot(u);let p=Ge(a,{schema_version:"2.0.0",session_id:"",started_at:n,last_activity:n,active_agent:null,tasks_pending:[],tasks_completed:[]});if(Array.isArray(p.tasks_completed)||(p.tasks_completed=[]),Array.isArray(p.tasks_pending)||(p.tasks_pending=[]),i){let k={agent:e,timestamp:n,summary:s};p.tasks_completed.push(k),p.tasks_completed.length>ze&&(p.tasks_completed=p.tasks_completed.slice(-ze))}p.last_activity=n,p.active_agent=null,Je(a,p);let m=ri();ot(m);let f=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),b=`${m}/${e}_${f}.log`,y=`=== CONTEXT PUBLICATION (Protocol 2.0) ===
Agent: ${e}
Timestamp: ${n}
Decisions file: ${qe()}
Session state: ${a}

=== AGENT OUTPUT ===
${r}
`;try{We(b,y)}catch{}return d()}import{existsSync as si,writeFileSync as Ke,mkdirSync as Bt,readFileSync as ii}from"node:fs";import{dirname as oi}from"node:path";function Ut(){return!!(process.env.CLAUDE_CODE_TEAM_NAME||process.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS==="1")}var Ve=[{type:"product-thinking",name:"Product Thinking Pipeline",description:"Full product discovery and specification workflow",triggers:["should we build","product decision","feature validation","market research","user research"],steps:[{agent:"market-intelligence",description:"Analyze competitive landscape and market trends",dependsOn:[],skills:["market-research"],estimatedTokens:3e3},{agent:"ux-researcher",description:"Create personas and map user journeys",dependsOn:[0],skills:["user-research"],estimatedTokens:2500},{agent:"product-strategist",description:"Validate value proposition and alignment",dependsOn:[0,1],skills:["product-strategy"],estimatedTokens:2e3},{agent:"prioritization-analyst",description:"Score and prioritize using frameworks",dependsOn:[2],skills:["prioritization"],estimatedTokens:1500},{agent:"business-case-builder",description:"Build ROI and cost-benefit analysis",dependsOn:[2,3],skills:["business-case"],estimatedTokens:2e3},{agent:"requirements-translator",description:"Transform to PRD and user stories",dependsOn:[4],skills:["requirements"],estimatedTokens:2500}],estimatedTotalTokens:13500},{type:"full-stack-feature",name:"Full-Stack Feature Pipeline",description:"End-to-end feature implementation workflow",triggers:["full-stack feature","build a feature","implement end-to-end","create full feature","add complete feature"],steps:[{agent:"backend-system-architect",description:"Design API and database schema",dependsOn:[],skills:["api-design","database-patterns"],estimatedTokens:3e3},{agent:"frontend-ui-developer",description:"Build React components and UI",dependsOn:[0],skills:["react-server-components-framework","form-state-patterns"],estimatedTokens:3500},{agent:"test-generator",description:"Create unit and integration tests",dependsOn:[0,1],skills:["testing-patterns"],estimatedTokens:2e3},{agent:"security-auditor",description:"Audit for vulnerabilities",dependsOn:[0,1],skills:["security-patterns"],estimatedTokens:1500}],estimatedTotalTokens:1e4},{type:"ai-integration",name:"AI Integration Pipeline",description:"Add AI/LLM capabilities to application",triggers:["add rag","add llm","ai integration","implement rag","add ai feature","langgraph workflow"],steps:[{agent:"workflow-architect",description:"Design LangGraph workflow and state",dependsOn:[],skills:["langgraph"],estimatedTokens:2500},{agent:"llm-integrator",description:"Connect LLM APIs with function calling",dependsOn:[0],skills:["llm-integration"],estimatedTokens:2e3},{agent:"data-pipeline-engineer",description:"Build embeddings and data pipeline",dependsOn:[0],skills:["embeddings","rag-retrieval"],estimatedTokens:2500},{agent:"test-generator",description:"Create LLM testing infrastructure",dependsOn:[1,2],skills:["testing-patterns"],estimatedTokens:1500}],estimatedTotalTokens:8500},{type:"security-audit",name:"Security Audit Pipeline",description:"Comprehensive security review workflow",triggers:["security audit","security review","vulnerability scan","security assessment"],steps:[{agent:"security-auditor",description:"Scan for OWASP Top 10 vulnerabilities",dependsOn:[],skills:["security-patterns"],estimatedTokens:2e3},{agent:"security-layer-auditor",description:"Verify defense-in-depth layers",dependsOn:[0],skills:["security-patterns"],estimatedTokens:2e3},{agent:"ai-safety-auditor",description:"Audit AI/LLM security if applicable",dependsOn:[0],skills:["mcp-security-hardening"],estimatedTokens:1500}],estimatedTotalTokens:5500},{type:"frontend-compliance",name:"Frontend 2026 Compliance Pipeline",description:"Modernize frontend to 2026 patterns",triggers:["frontend compliance","modernize frontend","update react","frontend 2026"],steps:[{agent:"frontend-ui-developer",description:"Upgrade to React 19 patterns",dependsOn:[],skills:["react-server-components-framework","zustand-patterns"],estimatedTokens:3e3},{agent:"frontend-performance-engineer",description:"Optimize Core Web Vitals",dependsOn:[0],skills:["performance"],estimatedTokens:2e3},{agent:"accessibility-specialist",description:"Ensure WCAG 2.2 compliance",dependsOn:[0],skills:["testing-patterns","accessibility"],estimatedTokens:1500}],estimatedTotalTokens:6500}];function ai(){return`${g()}/.claude/coordination/decision-log.json`}function ci(){let t=`${g()}/.claude/hooks/logs`;try{Bt(t,{recursive:!0})}catch{}return`${t}/agent-feedback.log`}function T(t){let e=ci(),n=new Date().toISOString();try{h(e,`[${n}] [feedback-loop] ${t}
`)}catch{}}function ui(t){let e=Pe();if(e){let r=Ve.find(s=>s.type===e.type);if(r){let s=r.steps.findIndex(i=>i.agent===t);if(s>=0){let i=r.steps.filter((o,a)=>o.dependsOn.includes(s)&&a>s).map(o=>o.agent);if(i.length>0)return i.join(" ")}}}return{"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"test-generator","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer"}[t]||""}function li(t){return{"market-intelligence":"product-thinking","product-strategist":"product-thinking","prioritization-analyst":"product-thinking","business-case-builder":"product-thinking","requirements-translator":"specification","metrics-architect":"specification","backend-system-architect":"architecture","database-engineer":"architecture","data-pipeline-engineer":"architecture","frontend-ui-developer":"frontend","rapid-ui-designer":"frontend","ux-researcher":"frontend","test-generator":"quality","code-quality-reviewer":"quality","security-auditor":"security","security-layer-auditor":"security","workflow-architect":"ai-integration","llm-integrator":"ai-integration","debug-investigator":"debugging"}[t]||"general"}function gi(){return process.env.CLAUDE_INSTANCE_ID||`${gt("node:os").hostname()}-${process.pid}`}function di(t){let e=t.substring(0,500);return t.length>500&&(e+="..."),e}function pi(t,e,n,r,s,i,o,a){let u=ai(),l=oi(u);try{Bt(l,{recursive:!0})}catch{}let p;if(si(u))try{p=JSON.parse(ii(u,"utf8"))}catch{p={schema_version:"2.0.0",log_created_at:o,decisions:[]}}else p={schema_version:"2.0.0",log_created_at:o,decisions:[]};let m={decision_id:t,timestamp:o,made_by:{instance_id:gi(),agent_type:e},category:n,title:`Agent ${e} completed`,description:r,impact:{scope:"agent-pipeline",downstream_agents:s.split(" ").filter(Boolean)},status:i,task_id:a};p.decisions.push(m);try{Ke(u,JSON.stringify(p,null,2)),T(`Decision ${t} logged for agent ${e}`)}catch{T("ERROR: Failed to write decision to log")}}function mi(t,e,n,r,s,i,o){if(!e)return;let a=`${g()}/.claude/context/handoffs`;try{Bt(a,{recursive:!0})}catch{}let u=e.split(" ").filter(Boolean),l=new Date().toISOString().replace(/[-:]/g,"").substring(0,15);for(let p of u){let m=`${a}/${t}_to_${p}_${l}.json`,f={from_agent:t,to_agent:p,timestamp:i,decision_id:r,summary:n,session_id:s,status:"pending",feedback_loop:!0,task_id:o};try{Ke(m,JSON.stringify(f,null,2)),T(`Created handoff context: ${t} -> ${p}`)}catch{}}}function ct(t){if(Ut())return d();let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",s=t.session_id,i=t.agent_output||t.output||"",o=t.error||"";if(T(`Processing feedback for agent: ${r} (session: ${s})`),r==="unknown"||!r)return T("Skipping unknown agent type"),d();let a=new Date().toISOString().replace(/[-:T.]/g,"").substring(0,8),u=Math.floor(Math.random()*1e4).toString().padStart(4,"0"),l=`DEC-${a}-${u}`,m=D(r)?.taskId,f=ui(r),b=li(r),y,k;return o&&o!=="null"?(y=`Agent failed: ${o}`,k="failed"):(y=di(i),k="completed"),m&&($(m,k==="completed"?"completed":"failed"),T(`Updated task ${m} status to ${k}`)),pi(l,r,b,y,f,k,e,m),f?(mi(r,f,y,l,s,e,m),T(`Routed findings to downstream agents: ${f}`)):T(`No downstream agents for ${r} (terminal agent)`),T(`=== AGENT FEEDBACK LOOP ===
Agent: ${r}
Category: ${b}
Decision ID: ${l}
Task ID: ${m||"none"}
Timestamp: ${e}
Status: ${k}
Downstream: ${f||"none"}

Summary: ${y}`),f?{continue:!0,systemMessage:`Feedback loop: routed to ${f}${m?` (task: ${m})`:""}`}:d()}import{writeFileSync as Xe,mkdirSync as Qe}from"node:fs";var fi=new Set(["market-intelligence","product-strategist","prioritization-analyst","business-case-builder","requirements-translator","metrics-architect","backend-system-architect","code-quality-reviewer","data-pipeline-engineer","database-engineer","debug-investigator","frontend-ui-developer","llm-integrator","rapid-ui-designer","security-auditor","security-layer-auditor","system-design-reviewer","test-generator","ux-researcher","workflow-architect"]),yi={"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"code-quality-reviewer","code-quality-reviewer":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"code-quality-reviewer","database-engineer":"backend-system-architect","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer","security-auditor":"none","security-layer-auditor":"none","debug-investigator":"none","system-design-reviewer":"none"},hi={"market-intelligence":"Next: product-strategist should define product vision based on market analysis","product-strategist":"Next: prioritization-analyst should rank features from strategy","prioritization-analyst":"Next: business-case-builder should create ROI justification","business-case-builder":"Next: requirements-translator should convert to technical specs","requirements-translator":"Next: metrics-architect should define success criteria","metrics-architect":"Next: backend-system-architect should design API endpoints","backend-system-architect":"Next: frontend-ui-developer should build UI components","frontend-ui-developer":"Next: test-generator should create test coverage","test-generator":"Next: code-quality-reviewer should validate implementation","code-quality-reviewer":"Next: security-auditor should perform security scan","workflow-architect":"Next: llm-integrator should configure LLM providers","llm-integrator":"Next: data-pipeline-engineer should set up embeddings","data-pipeline-engineer":"Next: code-quality-reviewer should validate data pipeline","database-engineer":"Next: backend-system-architect should integrate schema","rapid-ui-designer":"Next: frontend-ui-developer should implement designs","ux-researcher":"Next: rapid-ui-designer should create mockups"};function ki(t){return yi[t]||"none"}function Si(t){return hi[t]||"Pipeline complete"}function _i(t,e,n,r,s){let i=`${g()}/.claude/context/handoffs`;try{Qe(i,{recursive:!0})}catch{}let o=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),a=`${i}/${t}_to_${e}_${o}.json`,u={from_agent:t,to_agent:e,timestamp:n,summary:r,suggestions:s,status:"ready_for_handoff"};try{Xe(a,JSON.stringify(u,null,2))}catch{}return a}function bi(t,e,n,r,s,i){let o=`${g()}/.claude/logs/agent-handoffs`;try{Qe(o,{recursive:!0})}catch{}let a=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),u=`${o}/${t}_${a}.log`,l=`=== HANDOFF PREPARATION ===
From: ${t}
To: ${e}
Timestamp: ${n}
Handoff file: ${i}

Summary: ${r}

Next Steps: ${s}
`;try{Xe(u,l)}catch{}}function ut(t){let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown";if(!fi.has(r))return d();let s=ki(r),i=t.agent_output||t.output||"",o=i.length,a;o>0?(a=i.substring(0,300),o>300&&(a+="...")):a=`Agent ${r} completed`;let u=Si(r),l=_i(r,s,e,a,u);return bi(r,s,e,a,u,l),d()}import{writeFileSync as xi,mkdirSync as Ye}from"node:fs";var vi=[".env","auth","secret","credential","password","token","apikey","api_key","api-key","jwt","session","oauth","permission",".pem",".key"];function Ii(){let t=`${g()}/.claude/logs/multi-claude`;try{Ye(t,{recursive:!0})}catch{}return t}function C(t,e,n){let r=Ii(),s=new Date().toISOString().substring(0,10).replace(/-/g,""),i=`${r}/verifier_${s}.log`,o=new Date().toISOString();try{h(i,`[${o}] [${t}] ${e}: ${n}
`)}catch{}}function $i(t){let e=t.toLowerCase();for(let n of vi)if(e.includes(n))return!0;return!!(e.includes("config")&&e.includes("prod"))}function Ze(t){let e=new Date().toISOString(),n=g(),s=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",i=t.agent_output||t.output||"",o=[];if(s==="test-generator"&&(o.push({agent:"code-quality-reviewer",reason:"Test generation complete - quality review recommended"}),C(s,"TRIGGER","test-generator completion triggers code-quality-reviewer")),s==="frontend-ui-developer"&&/form|input|validation|submit|auth|login/i.test(i)&&(o.push({agent:"security-auditor",reason:"Frontend auth/form components - security review recommended"}),C(s,"TRIGGER","frontend auth components trigger security-auditor")),s==="backend-system-architect"&&/endpoint|route|api|auth|jwt|session/i.test(i)&&(o.push({agent:"security-auditor",reason:"Backend API endpoints - security review recommended"}),C(s,"TRIGGER","backend API endpoints trigger security-auditor")),$i(i)&&(o.some(u=>u.agent==="security-auditor")||(o.push({agent:"security-auditor",reason:"Sensitive files modified - security review required"}),C(s,"TRIGGER","sensitive file patterns detected"))),s==="database-engineer"&&(o.push({agent:"code-quality-reviewer",reason:"Database schema changes - review for consistency"}),C(s,"TRIGGER","database changes trigger code-quality-reviewer")),s==="workflow-architect"&&(o.push({agent:"security-layer-auditor",reason:"LangGraph workflow created - layer audit recommended"}),C(s,"TRIGGER","workflow-architect triggers security-layer-auditor")),o.length>0){let a=`${n}/.claude/context/verification-queue`;try{Ye(a,{recursive:!0})}catch{}let u=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),l=`${a}/pending_${u}_${s}.json`,p={triggered_by:s,timestamp:e,verifications:o.map(f=>({agent:f.agent,reason:f.reason,status:"pending"}))};try{xi(l,JSON.stringify(p,null,2))}catch{}let m="Multi-Claude Verification Triggered: "+o.map(f=>`${f.agent} (${f.reason})`).join("; ");return C(s,"QUEUE",`Created verification queue: ${l}`),{continue:!0,systemMessage:m}}return C(s,"SKIP","No verification triggers matched"),d()}import{writeFileSync as wi,mkdirSync as Ti}from"node:fs";function Ai(){let t=`${g()}/.claude/logs/agent-validation`;try{Ti(t,{recursive:!0})}catch{}return t}function tn(t){let e=t.subagent_type||t.agent_type||"unknown",n=new Date().toISOString(),r=t.agent_output||t.output||"",s=[],i=[];r||s.push("Agent produced empty output");let o=r.length;if(o<50&&i.push(`Output seems very short (${o} chars)`),/error|failed|exception/i.test(r)&&i.push("Output contains error-related keywords"),e==="backend-system-architect"&&r.includes("{")){let y=r.match(/\{[^{}]{0,1000}\}/);if(y)try{JSON.parse(y[0])}catch{i.push("JSON structure may be malformed")}}let a=s.length>0?"failed":"passed",u=t.last_assistant_message?.length??null,l=`Output Validation [${a}] - Agent: ${e}, Timestamp: ${n}, Output length: ${o} chars`+(u!==null?`, Response length: ${u} chars`:"");s.length>0&&(l+=` | Errors: ${s.join("; ")}`),i.length>0&&(l+=` | Warnings: ${i.join("; ")}`);let p=Ai(),m=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),f=`${p}/${e}_${m}.log`,b=`=== OUTPUT VALIDATION ===
${l}
${u!==null?`Response quality signal: last_assistant_message length = ${u}
`:""}
=== AGENT OUTPUT ===
${r}
`;try{wi(f,b)}catch{}return a==="failed"?{continue:!1,systemMessage:l,hookSpecificOutput:{hookEventName:"SubagentStop"}}:{continue:!0,suppressOutput:!0,systemMessage:l}}import{existsSync as Di,writeFileSync as Ci,readFileSync as Ri}from"node:fs";var qt=Zt();function Ei(){if(Di(qt))try{let t=JSON.parse(Ri(qt,"utf8"));t.errors=(t.errors||0)+1,Ci(qt,JSON.stringify(t,null,2))}catch{}}function en(t){let e=t.agent_id||"",n=t.subagent_type||"",r=t.error||"";return c("subagent-quality-gate",`Quality gate check: ${n} (${e})`),r&&r!=="null"?(c("subagent-quality-gate",`ERROR: Subagent failed - ${r}`),Ei(),R(`Subagent ${n} failed: ${r}`)):d()}function Oi(t){let e=t.error||t.tool_error,n=t.exit_code;if(e&&e!=="null"&&e!==""||n!==void 0&&n!==0)return!1;let r=t.agent_output||t.output||"",s=[/\bfailed\b/i,/\berror:\s/i,/\bexception\b/i,/\bcould not\b/i,/\bunable to\b/i],i=r.slice(0,500);for(let o of s)o.test(i)&&c("task-completer",`Warning: possible error in output: ${o}`);return!0}function nn(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return c("task-completer","No agent type found, skipping"),d();c("task-completer",`Processing SubagentStop for: ${n}`);let r=D(n);if(!r)return c("task-completer",`No orchestration task found for agent: ${n}`),xt(n),d();let s=Oi(t),i=s?"completed":"failed";c("task-completer",`Agent ${n} completed with status: ${i}`),$(r.taskId,i),E(n,i);let o=`## Orchestration: Task ${s?"Completed":"Failed"}

Agent \`${n}\` has finished with status: **${i}**

${tt({taskId:r.taskId,status:s?"completed":"pending"})}
`;if(s&&r.pipelineId&&r.pipelineStep!==void 0){let a=je(r.pipelineId,r.pipelineStep);if(a!==null){let u=Ot(r.pipelineId).filter(l=>l.pipelineStep===a&&l.status==="pending");u.length>0&&(o+=`
### Pipeline Progress

Pipeline \`${r.pipelineId}\` step ${r.pipelineStep} complete.
Next step (${a}) is now unblocked.

**Next agent(s) to spawn:**
${u.map(l=>`- \`${l.agent}\` (task: ${l.taskId})`).join(`
`)}

Consider spawning the next agent to continue the pipeline.`)}else o+=`
### Pipeline Complete

Pipeline \`${r.pipelineId}\` has completed all steps.`}if(!s){let a=t.error||t.tool_error||"Unknown error";o+=`
### Error Details

The agent encountered an issue:
\`\`\`
${a.slice(0,500)}
\`\`\`

Consider:
1. Retrying with more specific instructions
2. Using an alternative agent
3. Breaking down the task further`;let u=Oe(r.taskId);if(u.length>0){o+=`

### Orphaned Tasks (CC 2.1.20)

The following tasks were blocked by the failed task and should be deleted:
`;for(let l of u)o+=`
${Ee(l.taskId,`Blocked by failed task ${r.taskId} (agent: ${n})`)}`,$(l.taskId,"failed")}}return i==="completed"&&xt(n),c("task-completer",`Completed task ${r.taskId} with status ${i}`),A(o)}var Gt=new Map;function Pi(t,e){let n=Gt.get(t)||[];n.push(e),n.length>10&&n.shift(),Gt.set(t,n)}function ji(){let t=[];for(let[e,n]of Gt)n.some(r=>r.outcome==="failure")&&t.push(e);return t}function Hi(t){let e=t.error||t.tool_error,n=t.exit_code,r=t.agent_output||t.output||"";if(e&&e!=="null"&&e!=="")return{outcome:"failure",error:e};if(n!==void 0&&n!==0)return{outcome:"failure",error:`Exit code: ${n}`};let s=[/i cannot|i can't|i am unable/i,/outside my scope/i,/not appropriate/i,/i refuse/i];for(let o of s)if(o.test(r.slice(0,500)))return{outcome:"rejected",error:"Agent rejected the task"};let i=[/partial(?:ly)?/i,/incomplete/i,/some.*failed/i,/couldn't finish/i];for(let o of i)if(o.test(r.slice(0,500)))return{outcome:"partial"};return{outcome:"success"}}function rn(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return d();let{outcome:r,error:s}=Hi(t);if(r==="success")return d();c("retry-handler",`Agent ${n} completed with outcome: ${r}`);let i=vt(),a=I().activeAgents.find(y=>y.agent===n),u=a?.retryCount||0,l=fe(n,u+1,a?.taskId),p=ye(l,r,s||void 0);Pi(n,p);let m=ji(),f=me(n,u+1,s||"Unknown failure",m,i.maxRetries);if(c("retry-handler",`Retry decision for ${n}: shouldRetry=${f.shouldRetry}, alternative=${f.alternativeAgent||"none"}`),f.shouldRetry)E(n,"retrying");else{E(n,"failed");let y=D(n);y&&$(y.taskId,"failed")}let b=he(f,n);return A(b)}import{existsSync as ln,mkdirSync as Wi,readFileSync as Vi,writeFileSync as Ki}from"node:fs";import{existsSync as Ni,readFileSync as Mi,writeFileSync as bu,mkdirSync as xu}from"node:fs";import{execSync as sn}from"node:child_process";import{createHash as Li}from"node:crypto";import*as on from"node:os";var Fi=".claude/.user_identity.json",Ui="orchestkit-user-identity-v1";var _=null;function lt(t){return Li("sha256").update(t+Ui).digest("hex").slice(0,32)}function Bi(){try{return on.hostname()}catch{return"unknown-machine"}}function qi(t){let e=`${t}/${Fi}`;if(!Ni(e))return null;try{let n=Mi(e,"utf8");return JSON.parse(n)}catch(n){return c("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function Gi(t){let e={};try{e.email=sn("git config user.email",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{e.name=sn("git config user.name",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return e}function Ji(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function zi(t){if(_)return _;let e=t||g(),n=Bi(),r=qi(e);if(r?.user_id)return _={user_id:r.user_id,display_name:r.display_name||r.user_id,team_id:r.team_id,machine_id:n,source:"config",anonymous_id:lt(r.user_id),email:r.user_id.includes("@")?r.user_id:void 0},c("user-identity",`Resolved from config: ${_.anonymous_id}`,"debug"),_;let s=Gi(e);if(s.email)return _={user_id:s.email,display_name:s.name||s.email.split("@")[0],team_id:r?.team_id,machine_id:n,source:"git",anonymous_id:lt(s.email),email:s.email},c("user-identity",`Resolved from git: ${_.anonymous_id}`,"debug"),_;let i=Ji();if(i.username){let a=`${i.username}@${n}`;return _={user_id:a,display_name:i.username,team_id:r?.team_id,machine_id:n,source:"env",anonymous_id:lt(a)},c("user-identity",`Resolved from env: ${_.anonymous_id}`,"debug"),_}let o=lt(n+process.pid);return _={user_id:`anon-${o.slice(0,8)}`,display_name:"Anonymous",team_id:r?.team_id,machine_id:n,source:"anonymous",anonymous_id:o},c("user-identity",`Resolved as anonymous: ${_.anonymous_id}`,"debug"),_}function an(){let t=zi();return{session_id:S(),user_id:t.user_id,anonymous_id:t.anonymous_id,team_id:t.team_id,machine_id:t.machine_id,identity_source:t.source,timestamp:new Date().toISOString()}}var Xi=/^[a-zA-Z0-9_-]{1,128}$/;function Qi(t){return Xi.test(t)}function Wt(t,e){let n=t||S(),r=e||g();if(!Qi(n))throw new Error("Invalid session ID format");return`${r}/.claude/memory/sessions/${n}`}function Yi(t,e){return`${Wt(t,e)}/events.jsonl`}function gn(t,e){let n=Wt(t,e);ln(n)||Wi(n,{recursive:!0})}var q=0,cn=!1,Jt=!1,un=0,Zi=5e3;function dn(t,e){return`${Wt(t,e)}/counter.json`}function to(t,e){if(!cn){cn=!0;try{let n=dn(t,e);if(ln(n)){let r=JSON.parse(Vi(n,"utf8"));typeof r.counter=="number"&&r.counter>0&&(q=r.counter,c("session-tracker",`Loaded event counter: ${q}`,"debug"))}}catch{}}}function eo(t,e){if(!Jt)return;let n=Date.now();if(!(n-un<Zi))try{gn(t,e);let r=dn(t,e);Ki(r,JSON.stringify({counter:q,updated_at:new Date().toISOString()})),Jt=!1,un=n}catch{}}function no(){return to(),q++,Jt=!0,eo(),`evt-${Date.now()}-${q}`}function pn(t,e,n={}){try{let r={event_id:no(),event_type:t,identity:an(),payload:{name:e,input:zt(n.input),output:zt(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?mn(n.context,500):void 0,confidence:n.confidence}};gn();let s=Yi();h(s,`${JSON.stringify(r)}
`),c("session-tracker",`Tracked ${t}: ${e}`,"debug")}catch(r){c("session-tracker",`Failed to track event: ${r}`,"warn")}}function mn(t,e){return t.length<=e?t:`${t.slice(0,e-3)}...`}function zt(t){if(!t)return;let e={},n=["password","secret","token","key","credential","auth"];for(let[r,s]of Object.entries(t)){if(n.some(i=>r.toLowerCase().includes(i))){e[r]="[REDACTED]";continue}if(typeof s=="string"&&s.length>500){e[r]=mn(s,500);continue}if(typeof s=="object"&&s!==null&&!Array.isArray(s)){e[r]=zt(s);continue}e[r]=s}return e}import{mkdirSync as ro,statSync as so,renameSync as io}from"node:fs";import{createHash as oo}from"node:crypto";function ao(){return yt(mt(),".claude","analytics")}function fn(t){return oo("sha256").update(t).digest("hex").slice(0,12)}function yn(){let t=process.env.CLAUDE_CODE_TEAM_NAME;return t?{team:t}:void 0}function co(t,e=10485760){try{if(so(t).size>e){let r=new Date().toISOString().slice(0,7),s=t.replace(/\.jsonl$/,`.${r}.jsonl`);io(t,s)}}catch{}}function uo(){return!!(process.env.VITEST||process.env.JEST_WORKER_ID)}function hn(t,e){if(!uo())try{let n=ao();ro(n,{recursive:!0});let r=yt(n,t);co(r),h(r,`${JSON.stringify(e)}
`)}catch{}}var kn=[{name:"context-publisher",fn:at},{name:"handoff-preparer",fn:ut},{name:"feedback-loop",fn:ct},{name:"agent-memory-store",fn:it}];function lo(t){try{let e=t.tool_input?.subagent_type||t.subagent_type||t.agent_type||"unknown",n=t.tool_input?.name||void 0,r=!t.error,s=t.duration_ms,i=t.agent_output||t.output||"",o=typeof i=="string"?i.length:0;pn("agent_spawned",e,{success:r,duration_ms:s,output:{has_output:o>0,output_length:o,has_error:!!t.error},context:t.agent_id});let a=t.tool_input?.model||process.env.CLAUDE_MODEL||"unknown";hn("agent-usage.jsonl",{ts:new Date().toISOString(),pid:fn(process.env.CLAUDE_PROJECT_DIR||""),agent:e,agent_name:n??null,model:a,duration_ms:s,success:r,output_len:o,last_msg_len:t.last_assistant_message?.length??null,...yn()})}catch{}}async function Sn(t){lo(t);let n=(await Promise.allSettled(kn.map(async r=>{try{let s=r.fn(t);return s instanceof Promise&&await s,{hook:r.name,status:"success"}}catch(s){let i=s instanceof Error?s.message:String(s);return c("subagent-stop-dispatcher",`${r.name} failed: ${i}`),{hook:r.name,status:"error",message:i}}}))).filter(r=>r.status==="rejected"||r.status==="fulfilled"&&r.value.status==="error");return n.length>0&&c("subagent-stop-dispatcher",`${n.length}/${kn.length} hooks had errors`),d()}var _n={"subagent-start/graph-memory-inject":V,"subagent-start/context-gate":X,"subagent-start/subagent-context-stager":Y,"subagent-start/subagent-validator":Z,"subagent-start/task-linker":et,"subagent-start/model-cost-advisor":rt,"subagent-start/issue-context-injector":st,"subagent-start/unified-dispatcher":Le,"subagent-stop/agent-memory-store":it,"subagent-stop/auto-spawn-quality":Be,"subagent-stop/context-publisher":at,"subagent-stop/feedback-loop":ct,"subagent-stop/handoff-preparer":ut,"subagent-stop/multi-claude-verifier":Ze,"subagent-stop/output-validator":tn,"subagent-stop/subagent-quality-gate":en,"subagent-stop/task-completer":nn,"subagent-stop/retry-handler":rn,"subagent-stop/unified-dispatcher":Sn};function ll(t){return _n[t]}function gl(){return Object.keys(_n)}export{Zo as DEFAULT_CONFIG,Yo as THRESHOLDS,ua as addToPromptHistory,ka as analyzeAttemptHistory,$a as applyDecay,ga as cacheClassification,cr as calculateBackoffDelay,fa as cleanupOldStates,ma as clearSessionState,ye as completeAttempt,fe as createAttempt,Xo as escapeRegex,W as estimateTokenCount,ce as extractContext,he as formatRetryDecision,sa as getActiveAgent,wa as getAdjustments,Ta as getAgentSuccessRate,It as getAlternativeAgent,ie as getCachedBranch,Aa as getCalibrationStats,jo as getEnvFile,Wo as getField,ll as getHook,ca as getInjectedSkills,da as getLastClassification,se as getLogDir,Kn as getLogLevel,z as getPluginRoot,g as getProjectDir,la as getPromptHistory,S as getSessionId,Da as hasMinimalCalibrationData,kr as hashPrompt,_n as hooks,ia as isAgentDispatched,po as isBashInput,fo as isEditInput,yo as isReadInput,ur as isRetryableError,aa as isSkillInjected,mo as isWriteInput,St as lineContainsAll,Vo as lineContainsAllCI,gl as listHooks,F as loadCalibrationData,vt as loadConfig,I as loadState,c as logHook,Go as logPermissionFeedback,me as makeRetryDecision,Ko as normalizeCommand,Ho as normalizeLineEndings,Fo as outputAllowWithContext,Mo as outputBlock,kt as outputDeny,Uo as outputError,Qn as outputPromptContext,Jo as outputPromptContextBudgeted,No as outputSilentAllow,d as outputSilentSuccess,Bo as outputStderrWarning,R as outputWarning,A as outputWithContext,Lo as outputWithNotification,qo as outputWithUpdatedInput,Sa as prepareForRetry,zo as readHookInput,Ia as recordOutcome,xt as removeAgent,hr as saveCalibrationData,pa as saveConfig,er as saveState,Xn as shouldLog,lr as suggestsAlternative,ra as trackDispatchedAgent,oa as trackInjectedSkill,E as updateAgentStatus,j as updateState};
//# sourceMappingURL=subagent.mjs.map
