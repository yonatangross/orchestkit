// OrchestKit Hooks - subagent bundle
// Generated: 2026-02-09T23:48:54.066Z

var nt=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,n)=>(typeof require<"u"?require:e)[n]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});function Fs(t){return typeof t.command=="string"}function Us(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function Bs(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function qs(t){return typeof t.file_path=="string"&&t.content===void 0}import{appendFileSync as Ft,existsSync as Ut,statSync as An,renameSync as Tn,mkdirSync as Dn,readSync as Cn}from"node:fs";import{execSync as Rn}from"node:child_process";import un from"node:os";import q from"node:path";function rt(){return process.env.HOME||process.env.USERPROFILE||un.homedir()}function it(){return process.env.CLAUDE_PROJECT_DIR||"."}function Ht(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function jt(){return process.env.CLAUDE_PLUGIN_ROOT?q.join(rt(),".claude","logs","ork"):q.join(it(),".claude","logs")}var st=q.join,Ws=q.sep;import{execSync as gn}from"node:child_process";import{createHash as dn}from"node:crypto";import{existsSync as Nt,readFileSync as ln,writeFileSync as pn,mkdirSync as mn}from"node:fs";import{join as ot,basename as fn}from"node:path";var yn=20,hn=15,kn=/[^a-z0-9-]/g;function Sn(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=fn(e);return Mt(n,yn)}function bn(t){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=gn("git branch --show-current",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),r=Mt(n||"detached",hn);return process.env.ORCHESTKIT_SESSION_BRANCH=r,r}catch{return"nobranch"}}function _n(t){let e=t||new Date,n=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${n}${r}`}function vn(t){let e=t||new Date,n=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0");return`${n}${r}`}function In(){let t=`${process.pid}-${Date.now()}-${Math.random()}`;return dn("sha256").update(t).digest("hex").slice(0,4)}function Mt(t,e){return t.toLowerCase().replace(kn,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,e)}function xn(t,e){let n=Sn(t),r=bn(t),i=_n(e),s=vn(e),o=In();return`${n}-${r}-${i}-${s}-${o}`}function $n(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=ot(e,".instance","session-id.json");if(Nt(n))try{let r=JSON.parse(ln(n,"utf8"));if(r.session_id&&r.created_at){let i=Date.now()-new Date(r.created_at).getTime(),s=1440*60*1e3;if(i<s)return r.session_id}}catch{}}function wn(t,e){let n=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),r=ot(n,".instance"),i=ot(r,"session-id.json");try{Nt(r)||mn(r,{recursive:!0}),pn(i,JSON.stringify({session_id:t,created_at:new Date().toISOString()},null,2))}catch{}}function Lt(t){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let e=$n(t);if(e)return e;let n=xn(t);return wn(n,t),n}function Bt(){return jt()}function d(){return it()}function G(){return Ht()}function io(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${G()}/.claude/.instance_env`}function y(){return Lt()}function so(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let e=Rn("git branch --show-current",{cwd:t||d(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function En(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function oo(t){return t.replace(/\r\n/g,`
`)}function On(t){let e=["debug","info","warn","error"];return e.indexOf(t)>=e.indexOf(En())}function l(){return{continue:!0,suppressOutput:!0}}function ao(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function co(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function A(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function Pn(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function uo(t,e){let n={continue:!0,suppressOutput:!0};return t&&(n.systemMessage=t),e&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:e}),n}function go(t,e){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?n.systemMessage=e:n.suppressOutput=!0,n}function lo(t){return{continue:!0,systemMessage:t}}function E(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function at(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}function po(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:t}}}var Hn=200*1024,jn=100*1024;function qt(t,e){if(Ut(t))try{if(An(t).size>e){let r=`${t}.old.${Date.now()}`;Tn(t,r)}}catch{}}function Gt(t){Ut(t)||Dn(t,{recursive:!0})}function c(t,e,n="debug"){if(!On(n))return;let r=Bt(),i=`${r}/hooks.log`;try{Gt(r),qt(i,Hn);let s=new Date().toISOString().replace("T"," ").slice(0,19);Ft(i,`[${s}] [${n.toUpperCase()}] [${t}] ${e}
`)}catch{}}function mo(t,e,n){let r=Bt(),i=`${r}/permission-feedback.log`;try{Gt(r),qt(i,jn);let s=new Date().toISOString(),o=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",a=n?.session_id||y();Ft(i,`${s} | ${t} | ${e} | tool=${o} | session=${a}
`)}catch{}}function Nn(t){if(!t)return 0;let r=(t.match(/[{};()=><]/g)||[]).length/t.length>.03?2.8:3.5;return Math.ceil(t.length/r)}function fo(t,e,n,r,i){let s=Nn(t);return r&&r.isOverBudget(n)?(c(e,`Budget exhausted for ${n}, suppressing ${s}t`),l()):(i&&i.trackTokenUsage(e,n,s),Pn(t))}function yo(){try{let t=[],n=Buffer.allocUnsafe(256),r,i=0;for(;;)try{if(r=Cn(i,n,0,256,null),r===0)break;t.push(Buffer.from(n.subarray(0,r)))}catch{break}let s=Buffer.concat(t).toString("utf8").trim();return s?JSON.parse(s):{tool_name:"",session_id:y(),tool_input:{}}}catch{return{tool_name:"",session_id:y(),tool_input:{}}}}function ho(t,e){let n=e.replace(/^\./,"").split("."),r=t;for(let i of n){if(r==null)return;r=r[i]}return r}function ko(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function So(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var _o={AUTO_DISPATCH:85,SKILL_INJECT:80,STRONG_RECOMMEND:70,SUGGEST:50,MINIMUM:40},vo={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};import{existsSync as M,readFileSync as zt,writeFileSync as Wt,mkdirSync as Mn}from"node:fs";function ct(){return`${d()}/.claude/orchestration`}function ut(){let t=y();return`${ct()}/session-${t}.json`}function Kt(){return`${d()}/.claude/orchestration/config.json`}function Vt(){let t=ct();if(!M(t))try{Mn(t,{recursive:!0})}catch{c("orchestration-state",`Failed to create state dir: ${t}`)}}function I(){let t=ut();if(M(t))try{let e=zt(t,"utf8");return JSON.parse(e)}catch(e){c("orchestration-state",`Failed to load state: ${e}`)}return{sessionId:y(),activeAgents:[],injectedSkills:[],promptHistory:[],maxHistorySize:10,updatedAt:new Date().toISOString()}}function Ln(t){Vt();let e=ut();t.updatedAt=new Date().toISOString();try{Wt(e,JSON.stringify(t,null,2))}catch(n){c("orchestration-state",`Failed to save state: ${n}`)}}function j(t){let e=I();return t(e),Ln(e),e}function wo(t,e,n){let r={agent:t,taskId:n,confidence:e,dispatchedAt:new Date().toISOString(),status:"pending",retryCount:0,maxRetries:3};return j(i=>{i.activeAgents=i.activeAgents.filter(s=>s.agent!==t),i.activeAgents.push(r)}),c("orchestration-state",`Tracked dispatched agent: ${t} (conf: ${e})`),r}function O(t,e,n){j(r=>{let i=r.activeAgents.find(s=>s.agent===t);i&&(i.status=e,n&&(i.taskId=n),e==="retrying"&&i.retryCount++)}),c("orchestration-state",`Updated agent status: ${t} -> ${e}`)}function gt(t){j(e=>{e.activeAgents=e.activeAgents.filter(n=>n.agent!==t)})}function Ao(){return I().activeAgents.find(e=>e.status==="in_progress")}function To(t){return I().activeAgents.some(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function Do(t){j(e=>{e.injectedSkills.includes(t)||e.injectedSkills.push(t)})}function Co(t){return I().injectedSkills.includes(t)}function Ro(){return I().injectedSkills}function Eo(t){j(e=>{e.promptHistory.push(t),e.promptHistory.length>e.maxHistorySize&&(e.promptHistory=e.promptHistory.slice(-e.maxHistorySize))})}function Oo(){return I().promptHistory}function Po(t){j(e=>{e.lastClassification=t})}function Ho(){return I().lastClassification}var Jt={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function dt(){let t=Kt();if(M(t))try{let e=zt(t,"utf8");return{...Jt,...JSON.parse(e)}}catch{}return Jt}function jo(t){Vt();let e=Kt(),r={...dt(),...t};try{Wt(e,JSON.stringify(r,null,2))}catch(i){c("orchestration-state",`Failed to save config: ${i}`)}}function No(){let t=ut();try{if(M(t)){let{unlinkSync:e}=nt("node:fs");e(t),c("orchestration-state","Cleared session state")}}catch{}}function Mo(){let t=ct();if(M(t))try{let{readdirSync:e,statSync:n,unlinkSync:r}=nt("node:fs"),i=e(t).filter(s=>s.startsWith("session-")&&s.endsWith(".json")).map(s=>({name:s,path:`${t}/${s}`,mtime:n(`${t}/${s}`).mtime.getTime()})).sort((s,o)=>o.mtime-s.mtime);for(let s of i.slice(5))try{r(s.path),c("orchestration-state",`Cleaned up old state: ${s.name}`)}catch{}}catch{}}var Fn=3,Un=1e3,Bn=3e4,qn={"backend-system-architect":["database-engineer","api-designer"],"frontend-ui-developer":["rapid-ui-designer","accessibility-specialist"],"test-generator":["debug-investigator","code-quality-reviewer"],"security-auditor":["security-layer-auditor"],"workflow-architect":["llm-integrator","data-pipeline-engineer"]},Gn=[/permission denied/i,/access denied/i,/not found.*(?:file|module|package)/i,/(?:file|module|package)\s+not\s+found/i,/missing required/i,/invalid (?:api|token|key)/i,/authentication failed/i,/quota exceeded/i,/rate limit/i],Jn=[/not my specialization/i,/outside my scope/i,/better suited for/i,/consider using/i,/specialized agent/i];function zn(t,e=Un){let n=e*Math.pow(2,t-1),r=Math.random()*.1*n;return Math.min(n+r,Bn)}function Wn(t){for(let e of Gn)if(e.test(t))return!1;return!0}function Kn(t){for(let e of Jn)if(e.test(t))return!0;return!1}function lt(t,e=[]){let n=qn[t];if(n){for(let r of n)if(!e.includes(r))return r}}function Xt(t,e,n,r=[],i=Fn){if(c("retry-manager",`Evaluating retry for ${t}, attempt ${e}`),e>=i){let o=lt(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:i,alternativeAgent:o,reason:`Max retries (${i}) exceeded`+(o?`. Consider trying ${o} instead.`:"")}}if(!Wn(n)){let o=lt(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:i,alternativeAgent:o,reason:`Non-retryable error detected: ${n.slice(0,100)}`}}if(Kn(n)){let o=lt(t,r);if(o)return{shouldRetry:!1,retryCount:e,maxRetries:i,alternativeAgent:o,reason:`Error suggests using alternative agent: ${o}`}}let s=zn(e);return{shouldRetry:!0,retryCount:e,maxRetries:i,delayMs:s,reason:`Retrying (attempt ${e+1}/${i}) after ${Math.round(s/1e3)}s`}}function Qt(t,e,n){return{agent:t,taskId:n,attemptNumber:e,startedAt:new Date().toISOString()}}function Yt(t,e,n){let r=new Date().toISOString(),i=new Date(r).getTime()-new Date(t.startedAt).getTime();return{...t,completedAt:r,outcome:e,error:n,durationMs:i}}function Uo(t){if(t.length===0)return{successRate:0,avgDuration:0,commonErrors:[]};let n=t.filter(a=>a.outcome==="success").length/t.length,r=t.filter(a=>a.durationMs!==void 0).map(a=>a.durationMs),i=r.length>0?r.reduce((a,u)=>a+u,0)/r.length:0,s=new Map;for(let a of t)if(a.error){let u=a.error.slice(0,50).toLowerCase();s.set(u,(s.get(u)||0)+1)}let o=Array.from(s.entries()).sort((a,u)=>u[1]-a[1]).slice(0,3).map(([a])=>a);return{successRate:n,avgDuration:i,commonErrors:o}}function Bo(t,e){return{...t,status:"retrying",retryCount:e.retryCount}}function Zt(t,e){if(t.shouldRetry)return`## Retry Scheduled

Agent \`${e}\` will retry after ${Math.round((t.delayMs||0)/1e3)} seconds.

**Attempt:** ${t.retryCount+1} of ${t.maxRetries}
**Reason:** ${t.reason}`;let n=`## Retry Not Recommended

Agent \`${e}\` has ${t.retryCount>=t.maxRetries?"exhausted retries":"encountered a non-retryable error"}.

**Reason:** ${t.reason}`;return t.alternativeAgent&&(n+=`

### Alternative Suggestion

Consider using \`${t.alternativeAgent}\` instead:

\`\`\`
Task tool with subagent_type: "${t.alternativeAgent}"
\`\`\``),n}import{existsSync as re,readFileSync as Vn,writeFileSync as Xn,mkdirSync as Qn}from"node:fs";import{createHash as Yn}from"node:crypto";var te=500,pt=3,ee=15,ne=3,Zn=.9;function ie(){return`${d()}/.claude/feedback/calibration-data.json`}function tr(){let t=`${d()}/.claude/feedback`;if(!re(t))try{Qn(t,{recursive:!0})}catch{}}function L(){let t=ie();if(re(t))try{return JSON.parse(Vn(t,"utf8"))}catch{c("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function er(t){tr();let e=ie();t.updatedAt=new Date().toISOString();try{Xn(e,JSON.stringify(t,null,2)),c("calibration-engine","Saved calibration data")}catch(n){c("calibration-engine",`Failed to save calibration data: ${n}`)}}function nr(t){return Yn("sha256").update(t.toLowerCase().trim()).digest("hex").slice(0,16)}function Wo(t,e,n,r,i,s,o){let a=L(),u={timestamp:new Date().toISOString(),sessionId:y(),agent:e,promptHash:nr(t),matchedKeywords:n,dispatchConfidence:r,outcome:i,durationMs:s,feedback:o};a.records.push(u),a.records.length>te&&(a.records=a.records.slice(-te)),rr(a,u),ir(a),er(a),c("calibration-engine",`Recorded outcome: ${e} -> ${i} (conf: ${r})`)}function rr(t,e){let n=e.outcome==="success",r=e.outcome==="failure"||e.outcome==="rejected";if(!n&&!r)return;let i=n?ne:-ne;for(let s of e.matchedKeywords){let o=t.adjustments.find(a=>a.keyword===s&&a.agent===e.agent);o?(o.adjustment=Math.max(-ee,Math.min(ee,o.adjustment+i)),o.sampleCount++,o.lastUpdated=new Date().toISOString()):t.adjustments.push({keyword:s,agent:e.agent,adjustment:i,sampleCount:1,lastUpdated:new Date().toISOString()})}}function Ko(t){let e=Date.now(),n=1440*60*1e3;for(let r of t.adjustments){let i=e-new Date(r.lastUpdated).getTime();Math.floor(i/n)>7&&(r.adjustment=Math.round(r.adjustment*Zn),Math.abs(r.adjustment)<1&&(r.adjustment=0))}t.adjustments=t.adjustments.filter(r=>r.adjustment!==0)}function ir(t){let e=t.records;if(e.length===0)return;t.stats.totalDispatches=e.length;let n=e.filter(s=>s.outcome==="success").length;t.stats.successRate=n/e.length;let r=e.reduce((s,o)=>s+o.dispatchConfidence,0)/e.length;t.stats.avgConfidence=Math.round(r);let i=new Map;for(let s of e){let o=i.get(s.agent)||{count:0,success:0};o.count++,s.outcome==="success"&&o.success++,i.set(s.agent,o)}t.stats.topAgents=Array.from(i.entries()).map(([s,o])=>({agent:s,count:o.count,successRate:o.success/o.count})).sort((s,o)=>o.count-s.count).slice(0,10)}function Vo(){return L().adjustments.filter(e=>e.sampleCount>=pt)}function Xo(t){let n=L().records.filter(i=>i.agent===t);return n.length<pt?null:n.filter(i=>i.outcome==="success").length/n.length}function Qo(){return L().stats}function Yo(){return L().records.length>=pt}import{existsSync as sr,statSync as or}from"node:fs";import{resolve as ar}from"node:path";var oe={"database-engineer":"database schema SQL PostgreSQL migration pgvector","backend-system-architect":"API REST architecture backend FastAPI microservice","frontend-ui-developer":"React frontend UI component TypeScript Tailwind","security-auditor":"security OWASP vulnerability audit authentication","test-generator":"testing unit integration coverage pytest MSW","workflow-architect":"LangGraph workflow agent orchestration state","llm-integrator":"LLM API OpenAI Anthropic embeddings RAG function-calling","data-pipeline-engineer":"data pipeline embeddings vector ETL chunking","metrics-architect":"metrics OKR KPI analytics instrumentation","ux-researcher":"UX user research persona journey accessibility","code-quality-reviewer":"code quality review linting type-check patterns","infrastructure-architect":"infrastructure cloud Docker Kubernetes deployment","ci-cd-engineer":"CI CD pipeline GitHub Actions deployment automation","accessibility-specialist":"accessibility WCAG ARIA screen-reader a11y","product-strategist":"product strategy roadmap features prioritization"};function cr(t){return oe[t]||t}var se=100;function ae(t){c("graph-memory-inject","Graph memory inject hook starting");let e=ar(d(),".claude/memory/knowledge-graph.jsonl");if(!sr(e))return c("graph-memory-inject","No graph data file, skipping"),l();try{let u=or(e).size;if(u<se)return c("graph-memory-inject",`Graph too small (${u}B < ${se}B), skipping`),l()}catch{return c("graph-memory-inject","Could not stat graph file, skipping"),l()}let n=t.tool_input||{},r=n.subagent_type||n.type||"";if(!r&&n.prompt){let u=n.prompt.toLowerCase(),g=Object.keys(oe);for(let p of g)if(u.includes(p)){r=p;break}}if(!r)return c("graph-memory-inject","No agent type detected, passing through"),l();let i=`ork:${r}`,s=cr(r);c("graph-memory-inject",`Detected agent type: ${r} (agent_id: ${i})`);let o=`[Graph Memory - Agent Context Load]

Execute this MCP call to load graph context for ${r} agent:

## Graph Memory Entities
\`\`\`
mcp__memory__search_nodes
{"query": "${r} ${s}"}
\`\`\`

## Integration Instructions
1. Execute the graph search to retrieve relevant entities and relationships
2. Review entities for patterns, decisions, and constraints
3. Check relationships between concepts
4. Apply learned patterns to current task

Agent ID: ${i} | Domain: ${s}`,a=`[Graph Memory] Agent: ${r} | ID: ${i} | Load graph context via MCP call above`;return c("graph-memory-inject",`Outputting graph memory instructions for ${r}`),{continue:!0,systemMessage:a,hookSpecificOutput:{additionalContext:o}}}import{basename as ur}from"node:path";var J=5,gr="agents",dr="decisions",ue={"database-engineer":"database schema SQL PostgreSQL migration pgvector","backend-system-architect":"API REST architecture backend FastAPI microservice","frontend-ui-developer":"React frontend UI component TypeScript Tailwind","security-auditor":"security OWASP vulnerability audit authentication","test-generator":"testing unit integration coverage pytest MSW","workflow-architect":"LangGraph workflow agent orchestration state","llm-integrator":"LLM API OpenAI Anthropic embeddings RAG function-calling","data-pipeline-engineer":"data pipeline embeddings vector ETL chunking","metrics-architect":"metrics OKR KPI analytics instrumentation","ux-researcher":"UX user research persona journey accessibility","code-quality-reviewer":"code quality review linting type-check patterns","infrastructure-architect":"infrastructure cloud Docker Kubernetes deployment","ci-cd-engineer":"CI CD pipeline GitHub Actions deployment automation","accessibility-specialist":"accessibility WCAG ARIA screen-reader a11y","product-strategist":"product strategy roadmap features prioritization"},lr={"database-engineer":["backend-system-architect","security-auditor","data-pipeline-engineer"],"backend-system-architect":["database-engineer","frontend-ui-developer","security-auditor","llm-integrator"],"frontend-ui-developer":["backend-system-architect","ux-researcher","accessibility-specialist","rapid-ui-designer"],"security-auditor":["backend-system-architect","database-engineer","infrastructure-architect"],"test-generator":["backend-system-architect","frontend-ui-developer","code-quality-reviewer"],"workflow-architect":["llm-integrator","backend-system-architect","data-pipeline-engineer"],"llm-integrator":["workflow-architect","data-pipeline-engineer","backend-system-architect"],"data-pipeline-engineer":["database-engineer","llm-integrator","workflow-architect"]};function pr(t){return ue[t]||t}function mr(t){return lr[t]||[]}function fr(){let t=d();return(ur(t)||"default-project").toLowerCase().replace(/ /g,"-").replace(/[^a-z0-9-]/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-")}function ce(t){return`${fr()}-${t}`}function yr(t){return`orchestkit-global-${t}`}function ge(t){if(c("mem0-memory-inject","Mem0 memory inject hook starting"),!process.env.MEM0_API_KEY)return c("mem0-memory-inject","Mem0 not configured (no MEM0_API_KEY), skipping"),l();let e=t.tool_input||{},n=e.subagent_type||e.type||"";if(!n&&e.prompt){let S=e.prompt.toLowerCase(),C=Object.keys(ue);for(let H of C)if(S.includes(H)){n=H;break}}if(!n)return c("mem0-memory-inject","No agent type detected, passing through"),l();let r=`ork:${n}`,i=ce(gr),s=ce(dr),o=yr("best-practices"),a=pr(n),u=`${n} patterns decisions ${a}`;c("mem0-memory-inject",`Detected agent type: ${n} (agent_id: ${r})`);let g=mr(n),f=`${process.env.CLAUDE_PLUGIN_ROOT||"${CLAUDE_PLUGIN_ROOT}"}/src/skills/mem0-memory/scripts/crud/search-memories.py`,m=`[Mem0 Cloud - Agent Context Load]

Execute these CLI scripts to load mem0 context for ${n} agent:

## 1. Agent-Specific Patterns (mem0)
\`\`\`bash
python3 ${f} \\
  --query "${u}" \\
  --user-id "${i}" \\
  --limit ${J} \\
  --enable-graph
\`\`\`

## 2. Project Decisions (mem0)
\`\`\`bash
python3 ${f} \\
  --query "${a} decisions" \\
  --user-id "${s}" \\
  --limit ${J} \\
  --enable-graph
\`\`\`

## 3. Cross-Project Best Practices (mem0)
\`\`\`bash
python3 ${f} \\
  --query "${a} best practices" \\
  --user-id "${o}" \\
  --limit ${J} \\
  --enable-graph
\`\`\``;if(g.length>0){let S=g.join(", ");m+=`

## 4. Cross-Agent Knowledge (from: ${S})
\`\`\`bash
python3 ${f} \\
  --query "${a}" \\
  --user-id "${i}" \\
  --limit ${J} \\
  --enable-graph
\`\`\``}let h=g.length>0?g.join(", "):"none";m+=`

## Integration Instructions
1. Execute the above CLI scripts to retrieve mem0 context
2. Review memories for patterns, decisions, and constraints
3. Apply learned patterns to current task
4. Avoid known anti-patterns (outcome: failed)

Agent ID: ${r} | Domain: ${a} | Related: ${h}`;let k=`[Mem0 Cloud] Agent: ${n} | ID: ${r} | Load mem0 context via CLI scripts above | Related: ${h}`;return c("mem0-memory-inject",`Outputting mem0 memory instructions for ${n}`),{continue:!0,systemMessage:k,hookSpecificOutput:{additionalContext:m}}}import{existsSync as F,readFileSync as W,writeFileSync as ft,mkdirSync as hr}from"node:fs";import{dirname as kr}from"node:path";var z=4,mt=6,Sr=3,br=/^(test-generator|backend-system-architect|workflow-architect|security-auditor|llm-integrator)$/;function yt(){return`${d()}/.claude/logs/agent-state.json`}function le(){return`${d()}/.claude/logs/subagent-spawns.jsonl`}function _r(){let t=yt(),e=kr(t);try{hr(e,{recursive:!0})}catch{}if(!F(t)){let n={active_background:[],session_total:0,last_cleanup:null,blocked_count:0};try{ft(t,JSON.stringify(n,null,2))}catch{}}}function vr(){let t=le();if(!F(t))return 0;try{let r=W(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),i=new Date(Date.now()-300*1e3).toISOString(),s=0;for(let o of r)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>i&&s++}catch{}return s}catch{return 0}}function Ir(){let t=le();if(!F(t))return 0;try{let r=W(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),i=new Date(Date.now()-2*1e3).toISOString(),s=0;for(let o of r)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>i&&s++}catch{}return s}catch{return 0}}function xr(){let t=yt();try{if(F(t)){let e=JSON.parse(W(t,"utf8"));e.blocked_count=(e.blocked_count||0)+1,ft(t,JSON.stringify(e,null,2))}}catch{}}function de(){let t=yt();try{if(F(t)){let e=JSON.parse(W(t,"utf8"));e.session_total=(e.session_total||0)+1,ft(t,JSON.stringify(e,null,2))}}catch{}}function pe(t){_r();let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"",i=e.run_in_background===!0||e.run_in_background==="true";c("context-gate",`Context gate check: ${n} (background=${i})`);let s=vr(),o=Ir();return c("context-gate",`Active background: ${s}, Current response: ${o}`),o>=mt?(c("context-gate",`BLOCKED: Too many agents in single response (${o} >= ${mt})`),at(`Context Overflow Protection

Too many agents spawned in a single response (${o} agents).

Maximum allowed: ${mt} per response

SOLUTION: Split into multiple responses or use sequential execution.
Consider using the /context-compression skill first.

Attempted: ${n} - ${r}`)):i&&s>=z?(c("context-gate",`BLOCKED: Too many concurrent background agents (${s} >= ${z})`),xr(),at(`Background Agent Limit

Too many background agents running concurrently (${s} active).

Maximum allowed: ${z} concurrent background agents

SOLUTION:
1. Wait for existing agents to complete
2. Run this agent in foreground (remove run_in_background)
3. Use /context-compression to free up context

Attempted: ${n} - ${r}`)):s>=Sr?(c("context-gate","WARNING: Approaching context budget limit"),de(),E(`Context Budget Warning

${s} background agents active (limit: ${z}).

Consider:
- Running remaining agents sequentially
- Using /context-compression skill
- Waiting for current agents to complete

Proceeding with: ${n} - ${r}`)):br.test(n)&&s>=2?(c("context-gate",`WARNING: Expensive agent type with multiple active: ${n}`),E(`Spawning expensive agent (${n}) with ${s} others active`)):(de(),c("context-gate",`Context gate passed: ${n}`),l())}import{existsSync as ht,readFileSync as fe,readdirSync as $r}from"node:fs";function wr(){return`${d()}/.claude/context/session/state.json`}function Ar(){return`${d()}/.claude/context/knowledge/decisions/active.json`}function Tr(){return`${d()}/docs/issues`}function Dr(){let t=wr();if(!ht(t))return{count:0,summary:""};try{let n=JSON.parse(fe(t,"utf8")).tasks_pending||[],r=n.length;if(r===0)return{count:0,summary:""};let i=n.slice(0,3).map(s=>`- ${s}`).join(`
`);return{count:r,summary:i}}catch{return{count:0,summary:""}}}function me(t,e){let n=Ar();if(!ht(n))return"";try{return(JSON.parse(fe(n,"utf8")).decisions||[]).filter(o=>o.category===e||o.category==="api"||o.category==="database").slice(0,5).map(o=>`- ${o.title} (${o.status||"unknown"})`).join(`
`)}catch{return""}}function Cr(t){let e=Tr();if(!ht(e))return"";try{let r=$r(e).find(i=>i.includes(t));if(r)return`docs/issues/${r}`}catch{}return""}function ye(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.task_description||e.description||"";c("subagent-context-stager",`Staging context for ${n}`);let i="",{count:s,summary:o}=Dr();s>0&&(c("subagent-context-stager",`Found ${s} pending tasks`),i+=`ACTIVE TODOS:
${o}

`);let a=r.toLowerCase();if(/backend|api|endpoint|database|migration/.test(a)){c("subagent-context-stager","Backend task detected - staging backend decisions");let u=me(r,"backend");u&&(i+=`RELEVANT DECISIONS:
${u}

`)}if(/frontend|react|ui|component/.test(a)){c("subagent-context-stager","Frontend task detected - staging frontend decisions");let u=me(r,"frontend");u&&(i+=`RELEVANT DECISIONS:
${u}

`)}if(/test|testing|pytest|jest/.test(a)&&(c("subagent-context-stager","Testing task detected - staging test context"),i+=`TESTING REMINDERS:
- Use 'tee' for visible test output
- Check test patterns in backend/tests/ or frontend/src/**/__tests__/
- Ensure coverage meets threshold requirements

`),/issue|#\d+|bug|fix/.test(a)){c("subagent-context-stager","Issue-related task detected");let u=r.match(/#(\d+)/);if(u){let g=u[1],p=Cr(g);p&&(i+=`ISSUE DOCS: ${p}

`,c("subagent-context-stager",`Staged issue documentation for #${g}`))}}if(i){let u=`${i}
Task: ${r}
Subagent: ${n}`,g=i.split(`
`).filter(Boolean).length;return c("subagent-context-stager",`Staged context with ${g} lines`),{continue:!0,systemMessage:u}}return c("subagent-context-stager","No context staged for this task"),l()}import{existsSync as U,readFileSync as kt,mkdirSync as Rr,appendFileSync as Er,readdirSync as Or}from"node:fs";import{join as v,dirname as Pr}from"node:path";var Hr=new Set(["general-purpose","Explore","Plan","claude-code-guide","statusline-setup","Bash"]);function jr(){return v(d(),".claude","logs","subagent-spawns.jsonl")}function Nr(){return v(d(),"plugin.json")}function St(){return v(d(),"agents")}function bt(){return v(d(),".claude","agents")}function Mr(){return v(d(),"skills")}function Lr(){let t=new Set(Hr),e=Nr();if(U(e))try{let i=JSON.parse(kt(e,"utf8")).agents||[];for(let s of i)s.id&&t.add(s.id)}catch{}let n=[St(),bt()];for(let r of n)if(U(r))try{let i=Or(r);for(let s of i)s.endsWith(".md")&&t.add(s.replace(".md",""))}catch{}return t}function Fr(t){let e=[],n=[v(St(),`${t}.md`),v(bt(),`${t}.md`)],r=null;for(let i of n)if(U(i)){r=i;break}if(!r)return e;try{let s=kt(r,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of s){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^skills:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let g=u.match(/^\s*-\s*(.+)$/);if(g){let p=g[1].trim();e.push(p)}}}}}catch{}return e}function Ur(t){let e=Fr(t),n=[],r=Mr();for(let i of e){let s=v(r,i,"SKILL.md");U(s)||n.push(i)}return n}function Br(t){let e=[],n=[v(St(),`${t}.md`),v(bt(),`${t}.md`)],r=null;for(let i of n)if(U(i)){r=i;break}if(!r)return e;try{let s=kt(r,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of s){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^tools:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let g=u.match(/^\s*-\s*(.+)$/);g&&e.push(g[1].trim())}}}}catch{}return e}function qr(t,e){if(e.length===0)return"";let n=e.every(o=>["Read","Glob","Grep"].includes(o)),r=e.includes("Bash"),i=e.includes("Write")||e.includes("Edit"),s="low";return r&&i?s="elevated":(r||i)&&(s="moderate"),`## Agent Permission Profile (CC 2.1.20)

**Agent**: \`${t}\`
**Tools**: ${e.join(", ")}
**Risk Level**: ${s}${n?" (read-only)":""}

${r?`> This agent requests Bash access. Review commands carefully.
`:""}`}function Gr(t,e,n){let r=jr(),i=Pr(r);try{Rr(i,{recursive:!0})}catch{}let s={timestamp:new Date().toISOString(),subagent_type:t,description:e,session_id:n};try{Er(r,JSON.stringify(s)+`
`)}catch{}}function he(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"",i=t.session_id||y();c("subagent-validator",`Task invocation: ${n} - ${r}`),Gr(n,r,i);let s=n.replace(/^[^:]+:/,""),o=Lr();!o.has(n)&&!o.has(s)&&c("subagent-validator",`WARNING: Unknown subagent type: ${n}`),c("subagent-validator",`Spawning ${n} agent: ${r}`);let a=Ur(s);if(a.length>0){let g=a.join(", ");c("subagent-validator",`WARNING: Agent '${s}' references missing skills: ${g}`),console.error(`Warning: Agent '${s}' references ${a.length} missing skill(s): ${g}`)}let u=Br(s);if(u.length>0){let g=qr(s,u);return c("subagent-validator",`Agent '${s}' tools: ${u.join(", ")}`),A(g)}return l()}import{existsSync as ke,readFileSync as Jr,writeFileSync as zr,mkdirSync as Wr}from"node:fs";function Se(){let t=y();return`${d()}/.claude/orchestration/task-registry-${t}.json`}function Kr(){let t=`${d()}/.claude/orchestration`;if(!ke(t))try{Wr(t,{recursive:!0})}catch{}}function N(){let t=Se();if(ke(t))try{return JSON.parse(Jr(t,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:y(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function _t(t){Kr();let e=Se();t.updatedAt=new Date().toISOString();try{zr(e,JSON.stringify(t,null,2))}catch(n){c("task-integration",`Failed to save registry: ${n}`)}}function be(t,e){return`### Delete Orphaned Task

\`\`\`
TaskUpdate:
  taskId: "${t}"
  status: "deleted"
\`\`\`

**Reason**: ${e}`}function K(t){let e=`### Update Task

\`\`\`
TaskUpdate:
  taskId: "${t.taskId}"`;return t.status&&(e+=`
  status: "${t.status}"`),t.addBlockedBy&&t.addBlockedBy.length>0&&(e+=`
  addBlockedBy: ${JSON.stringify(t.addBlockedBy)}`),t.addBlocks&&t.addBlocks.length>0&&(e+=`
  addBlocks: ${JSON.stringify(t.addBlocks)}`),e+="\n```",e}function x(t,e){let n=N(),r=n.tasks.find(i=>i.taskId===t);r&&(r.status=e,_t(n),c("task-integration",`Updated task ${t} status to ${e}`))}function T(t){return N().tasks.find(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function _e(t){return N().tasks.filter(n=>n.status==="pending"&&n.blockedBy&&n.blockedBy.includes(t))}function vt(t){return N().tasks.filter(n=>n.pipelineId===t).sort((n,r)=>(n.pipelineStep||0)-(r.pipelineStep||0))}function ve(){return N().pipelines.find(e=>e.status==="running")}function Ie(t,e){let n=N(),r=n.pipelines.find(s=>s.pipelineId===t);if(!r)return null;r.completedSteps.includes(e)||(r.completedSteps.push(e),r.completedSteps.sort((s,o)=>s-o));let i=vt(t);for(let s of i){let o=s.pipelineStep;if(o===void 0||r.completedSteps.includes(o)||s.status!=="pending")continue;if(o===0||r.completedSteps.includes(o-1))return r.currentStep=o,_t(n),o}return r.status="completed",_t(n),null}function xe(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return c("task-linker","No agent type found, skipping"),l();c("task-linker",`Processing SubagentStart for: ${n}`);let r=T(n);if(!r)return c("task-linker",`No orchestration task found for agent: ${n}`),l();c("task-linker",`Found task ${r.taskId} for agent ${n}`),x(r.taskId,"in_progress"),O(n,"in_progress",r.taskId);let i=K({taskId:r.taskId,status:"in_progress"}),s=`## Orchestration: Task Linked

Agent \`${n}\` has been linked to task **${r.taskId}**.

${i}

The task status should be updated to \`in_progress\`.`;return c("task-linker",`Linked agent ${n} to task ${r.taskId}`),A(s)}import{appendFileSync as Vr,mkdirSync as Xr,existsSync as It,readFileSync as xt}from"node:fs";import{join as V,dirname as Qr}from"node:path";var Yr=[/security|vulnerab|audit|penetration/i,/architect|design.*system|distributed/i,/migration.*schema|database.*design/i,/performance.*optim|profil|bottleneck/i,/langgraph|workflow.*orchestrat/i],Zr=[/\b(?:list|count|check|verify|read|search)\b/i,/\b(?:simple|straightforward|quick)\b/i,/\b(?:format|lint|style|typo|rename)\b/i,/\b(?:status|progress|summary)\b/i],P=new Map,$=new Map;function $t(t){if(P.has(t))return P.get(t);let e=G();if(!e)return P.set(t,"inherit"),"inherit";let n=V(e,"agents",`${t}.md`);if(!It(n))return P.set(t,"inherit"),"inherit";try{let i=xt(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!i)return P.set(t,"inherit"),"inherit";let s=i[1].match(/^model:\s*(.+)$/m),o=s?s[1].trim():"inherit";return P.set(t,o),o}catch{return P.set(t,"inherit"),"inherit"}}function ti(t){if($.has(t))return $.get(t);let e=G();if(!e)return $.set(t,null),null;let n=V(e,"agents",`${t}.md`);if(!It(n))return $.set(t,null),null;try{let i=xt(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!i)return $.set(t,null),null;let s=i[1].match(/^skills:\s*\n((?:\s+-\s+.+\n)*)/m);if(!s)return $.set(t,null),null;let o=s[1].match(/^\s+-\s+(.+)$/gm)?.map(g=>g.trim().replace(/^-\s+/,""))||[];if(o.length===0)return $.set(t,null),null;let a={low:0,medium:1,high:2},u="low";for(let g of o.slice(0,5)){let p=V(e,"skills",g,"SKILL.md");if(!It(p))continue;let m=xt(p,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!m)continue;let h=m[1].match(/^complexity:\s*(low|medium|high)$/m);if(h){let k=h[1];a[k]>a[u]&&(u=k)}}return $.set(t,u),u}catch{return $.set(t,null),null}}function $e(t,e){let n=ti(t);if(n==="high")return"high";let r=Yr.filter(o=>o.test(e)).length,i=$t(t);return r>=2||i==="opus"?"high":Zr.filter(o=>o.test(e)).length>=2?"low":n||"medium"}function we(t){let e=$t(t);return e==="inherit"?process.env.CLAUDE_MODEL||"sonnet":e}function ei(t,e){let n=$e(t,e),r=we(t);return n==="high"&&r==="haiku"?{recommended:"sonnet",current:r,reason:"High-complexity task \u2014 haiku may produce lower quality results",savingsPercent:0}:n==="low"&&r==="opus"?{recommended:"sonnet",current:r,reason:"Simple task \u2014 sonnet handles this equally well at lower cost",savingsPercent:40}:n==="medium"&&r==="opus"&&$t(t)!=="opus"?{recommended:"sonnet",current:r,reason:"Medium-complexity task \u2014 sonnet is sufficient",savingsPercent:30}:null}function ni(t,e,n,r){let i=V(d(),".claude","logs","model-usage.jsonl");try{Xr(Qr(i),{recursive:!0}),Vr(i,JSON.stringify({timestamp:new Date().toISOString(),agent:t,model:e,complexity:n,recommendation:r?.recommended||null,potentialSavings:r?.savingsPercent||0})+`
`)}catch{}}function Ae(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"";if(!n)return l();let i=$e(n,r),s=we(n),o=ei(n,r);return ni(n,s,i,o),o?(c("model-cost-advisor",`${n}: Recommend ${o.recommended} over ${o.current} (${o.reason})`,"info"),o.savingsPercent>=30?E(`Model cost: ${n} using ${o.current} for ${i}-complexity task. ${o.reason}. ~${o.savingsPercent}% savings with "${o.recommended}".`):l()):(c("model-cost-advisor",`${n}: ${s} appropriate for ${i} task`),l())}import{existsSync as ri,mkdirSync as ii,appendFileSync as si,unlinkSync as oi}from"node:fs";import{basename as ai,dirname as ci}from"node:path";var ui=["decided to","chose","implemented using","selected","opted for","will use","pattern:","approach:","architecture:","recommends","best practice","anti-pattern","learned that"],gi="decisions";function di(){return`${d()}/.claude/logs/agent-patterns.jsonl`}function li(){return`${d()}/.claude/session`}function Te(){let t=d();return(ai(t)||"default-project").toLowerCase().replace(/ /g,"-").replace(/[^a-z0-9-]/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-")}function pi(t){return`${Te()}-${t}`}function mi(t){let r=(t.length>10240?t.substring(0,10240):t).toLowerCase();return/pagination|cursor|offset/.test(r)?"pagination":/security|vulnerability|exploit|injection|xss|csrf|owasp|safety|guardrail/.test(r)?"security":/database|sql|postgres|schema/.test(r)?"database":/\bapi\b|endpoint|\brest\b|graphql/.test(r)?"api":/auth|login|jwt|oauth/.test(r)?"authentication":/\btest\b|testing|pytest|jest|vitest|coverage|\bmock\b|fixture|\bspec\b/.test(r)?"testing":/deploy|\bci\b|\bcd\b|pipeline|docker|kubernetes|helm|terraform/.test(r)?"deployment":/observability|monitoring|logging|tracing|metrics|prometheus|grafana|langfuse/.test(r)?"observability":/react|component|frontend|\bui\b/.test(r)?"frontend":/performance|optimization|cache|index/.test(r)?"performance":/llm|\brag\b|embedding|vector|semantic|\bai\b|\bml\b|langchain|langgraph|mem0|openai|anthropic/.test(r)?"ai-ml":/etl|data.*pipeline|streaming|batch.*processing|dataflow|spark/.test(r)?"data-pipeline":/architecture|design|structure/.test(r)?"architecture":/decided|chose|selected/.test(r)?"decision":"pattern"}function fi(t){let e=[];if(t.length<50)return e;for(let r of ui){let i=new RegExp(`^.*${r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}.*$`,"gim"),s=t.match(i)||[];for(let o of s){let a=o.trim().substring(0,200);a.length>20&&e.push(a)}}return[...new Set(e)].slice(0,5)}function X(t){c("agent-memory-store","Agent memory store hook starting");let e=t.tool_input||{},n=t.subagent_type||e.subagent_type||e.type||"",r=t.tool_result,i=typeof r=="string"?r:r?.content||t.agent_output||t.output||"",s=!0;if(t.error&&(s=!1),typeof r=="object"&&r?.is_error&&(s=!1),!n)return c("agent-memory-store","No agent type in input, skipping"),l();let o=`ork:${n}`,a=`${li()}/current-agent-id`;try{ri(a)&&oi(a)}catch{}c("agent-memory-store",`Processing completion for agent: ${n} (agent_id: ${o}, success: ${s})`);let u=s&&i?fi(i):[];if(u.length===0)return c("agent-memory-store",`No patterns extracted from ${n} output`),l();let g=di(),p=ci(g);try{ii(p,{recursive:!0})}catch{}let f=Te(),m=new Date().toISOString(),h=pi(gi);for(let C of u){let H=mi(C),R={agent:n,agent_id:o,pattern:C,project:f,timestamp:m,suggested_user_id:h,category:H,enable_graph:!0,pending_sync:!0};try{si(g,JSON.stringify(R)+`
`)}catch{}c("agent-memory-store",`Extracted pattern (${H}): ${C.substring(0,50)}...`)}return c("agent-memory-store",`Extracted ${u.length} patterns from ${n} output`),{continue:!0,systemMessage:`[Pattern Extraction] ${u.length} patterns extracted from ${n}. To persist, use CLI: python3 \${CLAUDE_PLUGIN_ROOT}/src/skills/mem0-memory/scripts/crud/add-memory.py --text "..." --user-id '${h}' --metadata '{"agent_id":"${o}"}'`}}import{existsSync as yi,writeFileSync as De,mkdirSync as wt,appendFileSync as hi,readFileSync as ki}from"node:fs";import{dirname as Si}from"node:path";var bi=[".env","credentials","secret","auth","password","token","api.key","private.key",".pem","oauth","jwt","session","cookie","encryption","crypto"];function _i(){let t=`${d()}/.claude/hooks/logs`;try{wt(t,{recursive:!0})}catch{}return`${t}/auto-spawn-quality.log`}function vi(){return`${d()}/.claude/context/spawn-queue.json`}function _(t){let e=_i(),n=new Date().toISOString();try{hi(e,`[${n}] [auto-spawn-quality] ${t}
`)}catch{}}function Ii(t){let e=t.toLowerCase();for(let n of bi)if(e.includes(n))return _(`Detected sensitive pattern: ${n}`),!0;return!1}function xi(t,e,n,r,i,s){let o=`SPAWN-${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,14)}-${Math.floor(Math.random()*1e4).toString().padStart(4,"0")}`,a=vi(),u=Si(a);try{wt(u,{recursive:!0})}catch{}let g;if(yi(a))try{g=JSON.parse(ki(a,"utf8"))}catch{g={schema_version:"1.0.0",created_at:s,queue:[]}}else g={schema_version:"1.0.0",created_at:s,queue:[]};let p={spawn_id:o,target_agent:e,trigger_agent:t,trigger_reason:n,priority:r,timestamp:s,session_id:i,status:"queued"};g.queue.push(p);try{De(a,JSON.stringify(g,null,2)),_(`Queued spawn request: ${o} for ${e} (reason: ${n})`)}catch{return _(`ERROR: Failed to queue spawn request for ${e}`),""}return o}function $i(t,e,n,r,i,s){let o=`${d()}/.claude/context/handoffs`;try{wt(o,{recursive:!0})}catch{}let a=`${o}/auto_spawn_${e}_${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,15)}.json`,u={type:"auto_spawn_suggestion",from_agent:t,to_agent:e,timestamp:s,trigger_reason:n,priority:r,session_id:i,auto_triggered:!0,status:"suggested"};try{De(a,JSON.stringify(u,null,2)),_(`Created spawn suggestion: ${e} (reason: ${n})`)}catch{}}function wi(t,e,n){if(n&&n!=="null")return _(`Skipping auto-spawn - agent ${t} had errors: ${n}`),null;if(t==="test-generator")return _("Rule matched: test-generator -> code-quality-reviewer"),{target:"code-quality-reviewer",reason:"test-generator completed - validating test quality and coverage",priority:"high"};if(Ii(e)&&t!=="security-auditor"&&t!=="security-layer-auditor")return _("Rule matched: sensitive files detected -> security-auditor"),{target:"security-auditor",reason:"sensitive file changes detected - security audit required",priority:"critical"};if(t==="code-quality-reviewer")return _("Rule matched: code-quality-reviewer -> security-auditor"),{target:"security-auditor",reason:"code-quality-reviewer completed - proceeding with security scan",priority:"high"};if(t==="backend-system-architect"){let r=e.toLowerCase();if(/authentication|authorization|security|access.control|rbac|acl/.test(r))return _("Rule matched: backend-system-architect with auth -> security-layer-auditor"),{target:"security-layer-auditor",reason:"backend-system-architect designed auth/security layer - validation required",priority:"high"}}return null}function Ce(t){let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",i=t.session_id||y(),s=t.agent_output||t.output||"",o=t.error||"";if(_(`Checking auto-spawn conditions for agent: ${r} (session: ${i})`),r==="unknown"||!r)return _("Skipping unknown agent type"),l();let a=wi(r,s,o);if(a){let u=xi(r,a.target,a.reason,a.priority,i,e);return $i(r,a.target,a.reason,a.priority,i,e),_(`=== AUTO-SPAWN QUALITY HOOK ===
Trigger Agent: ${r}
Target Agent: ${a.target}
Reason: ${a.reason}
Priority: ${a.priority}
Spawn ID: ${u}
Timestamp: ${e}
Session: ${i}`),{continue:!0,systemMessage:`Auto-spawn queued: ${a.target} (${a.priority} priority)`}}return _(`No auto-spawn conditions matched for ${r}`),l()}import{existsSync as Ai,writeFileSync as He,mkdirSync as Ti,readFileSync as Di}from"node:fs";import{dirname as At}from"node:path";function Re(){return`${d()}/.claude/context/knowledge/decisions/active.json`}function Ci(){return`${d()}/.claude/context/session/state.json`}function Ri(){return`${d()}/.claude/logs/agent-context`}function Q(t){try{Ti(t,{recursive:!0})}catch{}}function Ee(t,e){if(!Ai(t))return e;try{return JSON.parse(Di(t,"utf8"))}catch{return e}}function Oe(t,e){let n=At(t);Q(n);try{He(t,JSON.stringify(e,null,2))}catch{}}var Pe=50;function Y(t){let e=t.subagent_type||t.agent_type||"unknown",n=new Date().toISOString(),r=t.agent_output||t.output||"",i=r.substring(0,200);r.length>200&&(i+="...");let s=e!=="unknown"||i.trim().length>0,o=e.replace(/-/g,"_");if(s){let S=Re(),C=At(S);Q(C);let R=Ee(S,{schema_version:"2.0.0",decisions:{}});(!R.decisions||typeof R.decisions!="object")&&(R.decisions={});let cn={timestamp:n,agent:e,summary:i,status:"completed"};R.decisions[o]=cn,Oe(S,R)}let a=Ci(),u=At(a);Q(u);let p=Ee(a,{schema_version:"2.0.0",session_id:"",started_at:n,last_activity:n,active_agent:null,tasks_pending:[],tasks_completed:[]});if(Array.isArray(p.tasks_completed)||(p.tasks_completed=[]),Array.isArray(p.tasks_pending)||(p.tasks_pending=[]),s){let S={agent:e,timestamp:n,summary:i};p.tasks_completed.push(S),p.tasks_completed.length>Pe&&(p.tasks_completed=p.tasks_completed.slice(-Pe))}p.last_activity=n,p.active_agent=null,Oe(a,p);let f=Ri();Q(f);let m=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),h=`${f}/${e}_${m}.log`,k=`=== CONTEXT PUBLICATION (Protocol 2.0) ===
Agent: ${e}
Timestamp: ${n}
Decisions file: ${Re()}
Session state: ${a}

=== AGENT OUTPUT ===
${r}
`;try{He(h,k)}catch{}return l()}import{existsSync as Ei,writeFileSync as Ne,mkdirSync as Dt,readFileSync as Oi,appendFileSync as Pi}from"node:fs";import{dirname as Hi}from"node:path";function Tt(){return!!(process.env.CLAUDE_CODE_TEAM_NAME||process.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS==="1")}var je=[{type:"product-thinking",name:"Product Thinking Pipeline",description:"Full product discovery and specification workflow",triggers:["should we build","product decision","feature validation","market research","user research"],steps:[{agent:"market-intelligence",description:"Analyze competitive landscape and market trends",dependsOn:[],skills:["market-research"],estimatedTokens:3e3},{agent:"ux-researcher",description:"Create personas and map user journeys",dependsOn:[0],skills:["user-research"],estimatedTokens:2500},{agent:"product-strategist",description:"Validate value proposition and alignment",dependsOn:[0,1],skills:["product-strategy"],estimatedTokens:2e3},{agent:"prioritization-analyst",description:"Score and prioritize using frameworks",dependsOn:[2],skills:["prioritization"],estimatedTokens:1500},{agent:"business-case-builder",description:"Build ROI and cost-benefit analysis",dependsOn:[2,3],skills:["business-case"],estimatedTokens:2e3},{agent:"requirements-translator",description:"Transform to PRD and user stories",dependsOn:[4],skills:["requirements"],estimatedTokens:2500}],estimatedTotalTokens:13500},{type:"full-stack-feature",name:"Full-Stack Feature Pipeline",description:"End-to-end feature implementation workflow",triggers:["full-stack feature","build a feature","implement end-to-end","create full feature","add complete feature"],steps:[{agent:"backend-system-architect",description:"Design API and database schema",dependsOn:[],skills:["api-design-framework","database-schema-designer"],estimatedTokens:3e3},{agent:"frontend-ui-developer",description:"Build React components and UI",dependsOn:[0],skills:["react-server-components-framework","form-state-patterns"],estimatedTokens:3500},{agent:"test-generator",description:"Create unit and integration tests",dependsOn:[0,1],skills:["integration-testing","msw-mocking"],estimatedTokens:2e3},{agent:"security-auditor",description:"Audit for vulnerabilities",dependsOn:[0,1],skills:["owasp-top-10","auth-patterns"],estimatedTokens:1500}],estimatedTotalTokens:1e4},{type:"ai-integration",name:"AI Integration Pipeline",description:"Add AI/LLM capabilities to application",triggers:["add rag","add llm","ai integration","implement rag","add ai feature","langgraph workflow"],steps:[{agent:"workflow-architect",description:"Design LangGraph workflow and state",dependsOn:[],skills:["langgraph-state","langgraph-routing"],estimatedTokens:2500},{agent:"llm-integrator",description:"Connect LLM APIs with function calling",dependsOn:[0],skills:["function-calling","llm-streaming"],estimatedTokens:2e3},{agent:"data-pipeline-engineer",description:"Build embeddings and data pipeline",dependsOn:[0],skills:["embeddings","rag-retrieval"],estimatedTokens:2500},{agent:"test-generator",description:"Create LLM testing infrastructure",dependsOn:[1,2],skills:["llm-testing","property-based-testing"],estimatedTokens:1500}],estimatedTotalTokens:8500},{type:"security-audit",name:"Security Audit Pipeline",description:"Comprehensive security review workflow",triggers:["security audit","security review","vulnerability scan","security assessment"],steps:[{agent:"security-auditor",description:"Scan for OWASP Top 10 vulnerabilities",dependsOn:[],skills:["owasp-top-10","input-validation"],estimatedTokens:2e3},{agent:"security-layer-auditor",description:"Verify defense-in-depth layers",dependsOn:[0],skills:["defense-in-depth"],estimatedTokens:2e3},{agent:"ai-safety-auditor",description:"Audit AI/LLM security if applicable",dependsOn:[0],skills:["mcp-security-hardening"],estimatedTokens:1500}],estimatedTotalTokens:5500},{type:"frontend-compliance",name:"Frontend 2026 Compliance Pipeline",description:"Modernize frontend to 2026 patterns",triggers:["frontend compliance","modernize frontend","update react","frontend 2026"],steps:[{agent:"frontend-ui-developer",description:"Upgrade to React 19 patterns",dependsOn:[],skills:["react-server-components-framework","zustand-patterns"],estimatedTokens:3e3},{agent:"performance-engineer",description:"Optimize Core Web Vitals",dependsOn:[0],skills:["core-web-vitals","lazy-loading-patterns"],estimatedTokens:2e3},{agent:"accessibility-specialist",description:"Ensure WCAG 2.2 compliance",dependsOn:[0],skills:["a11y-testing","focus-management"],estimatedTokens:1500}],estimatedTotalTokens:6500}];function ji(){return`${d()}/.claude/coordination/decision-log.json`}function Ni(){let t=`${d()}/.claude/hooks/logs`;try{Dt(t,{recursive:!0})}catch{}return`${t}/agent-feedback.log`}function w(t){let e=Ni(),n=new Date().toISOString();try{Pi(e,`[${n}] [feedback-loop] ${t}
`)}catch{}}function Mi(t){let e=ve();if(e){let r=je.find(i=>i.type===e.type);if(r){let i=r.steps.findIndex(s=>s.agent===t);if(i>=0){let s=r.steps.filter((o,a)=>o.dependsOn.includes(i)&&a>i).map(o=>o.agent);if(s.length>0)return s.join(" ")}}}return{"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"test-generator","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer"}[t]||""}function Li(t){return{"market-intelligence":"product-thinking","product-strategist":"product-thinking","prioritization-analyst":"product-thinking","business-case-builder":"product-thinking","requirements-translator":"specification","metrics-architect":"specification","backend-system-architect":"architecture","database-engineer":"architecture","data-pipeline-engineer":"architecture","frontend-ui-developer":"frontend","rapid-ui-designer":"frontend","ux-researcher":"frontend","test-generator":"quality","code-quality-reviewer":"quality","security-auditor":"security","security-layer-auditor":"security","workflow-architect":"ai-integration","llm-integrator":"ai-integration","debug-investigator":"debugging"}[t]||"general"}function Fi(){return process.env.CLAUDE_INSTANCE_ID||`${nt("os").hostname()}-${process.pid}`}function Ui(t){let e=t.substring(0,500);return t.length>500&&(e+="..."),e}function Bi(t,e,n,r,i,s,o,a){let u=ji(),g=Hi(u);try{Dt(g,{recursive:!0})}catch{}let p;if(Ei(u))try{p=JSON.parse(Oi(u,"utf8"))}catch{p={schema_version:"2.0.0",log_created_at:o,decisions:[]}}else p={schema_version:"2.0.0",log_created_at:o,decisions:[]};let f={decision_id:t,timestamp:o,made_by:{instance_id:Fi(),agent_type:e},category:n,title:`Agent ${e} completed`,description:r,impact:{scope:"agent-pipeline",downstream_agents:i.split(" ").filter(Boolean)},status:s,task_id:a};p.decisions.push(f);try{Ne(u,JSON.stringify(p,null,2)),w(`Decision ${t} logged for agent ${e}`)}catch{w("ERROR: Failed to write decision to log")}}function qi(t,e,n,r,i,s,o){if(!e)return;let a=`${d()}/.claude/context/handoffs`;try{Dt(a,{recursive:!0})}catch{}let u=e.split(" ").filter(Boolean),g=new Date().toISOString().replace(/[-:]/g,"").substring(0,15);for(let p of u){let f=`${a}/${t}_to_${p}_${g}.json`,m={from_agent:t,to_agent:p,timestamp:s,decision_id:r,summary:n,session_id:i,status:"pending",feedback_loop:!0,task_id:o};try{Ne(f,JSON.stringify(m,null,2)),w(`Created handoff context: ${t} -> ${p}`)}catch{}}}function Z(t){if(Tt())return l();let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",i=t.session_id||y(),s=t.agent_output||t.output||"",o=t.error||"";if(w(`Processing feedback for agent: ${r} (session: ${i})`),r==="unknown"||!r)return w("Skipping unknown agent type"),l();let a=new Date().toISOString().replace(/[-:T.]/g,"").substring(0,8),u=Math.floor(Math.random()*1e4).toString().padStart(4,"0"),g=`DEC-${a}-${u}`,f=T(r)?.taskId,m=Mi(r),h=Li(r),k,S;return o&&o!=="null"?(k=`Agent failed: ${o}`,S="failed"):(k=Ui(s),S="completed"),f&&(x(f,S==="completed"?"completed":"failed"),w(`Updated task ${f} status to ${S}`)),Bi(g,r,h,k,m,S,e,f),m?(qi(r,m,k,g,i,e,f),w(`Routed findings to downstream agents: ${m}`)):w(`No downstream agents for ${r} (terminal agent)`),w(`=== AGENT FEEDBACK LOOP ===
Agent: ${r}
Category: ${h}
Decision ID: ${g}
Task ID: ${f||"none"}
Timestamp: ${e}
Status: ${S}
Downstream: ${m||"none"}

Summary: ${k}`),m?{continue:!0,systemMessage:`Feedback loop: routed to ${m}${f?` (task: ${f})`:""}`}:l()}import{writeFileSync as Me,mkdirSync as Le}from"node:fs";var Gi=new Set(["market-intelligence","product-strategist","prioritization-analyst","business-case-builder","requirements-translator","metrics-architect","backend-system-architect","code-quality-reviewer","data-pipeline-engineer","database-engineer","debug-investigator","frontend-ui-developer","llm-integrator","rapid-ui-designer","security-auditor","security-layer-auditor","system-design-reviewer","test-generator","ux-researcher","workflow-architect"]),Ji={"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"code-quality-reviewer","code-quality-reviewer":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"code-quality-reviewer","database-engineer":"backend-system-architect","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer","security-auditor":"none","security-layer-auditor":"none","debug-investigator":"none","system-design-reviewer":"none"},zi={"market-intelligence":"Next: product-strategist should define product vision based on market analysis","product-strategist":"Next: prioritization-analyst should rank features from strategy","prioritization-analyst":"Next: business-case-builder should create ROI justification","business-case-builder":"Next: requirements-translator should convert to technical specs","requirements-translator":"Next: metrics-architect should define success criteria","metrics-architect":"Next: backend-system-architect should design API endpoints","backend-system-architect":"Next: frontend-ui-developer should build UI components","frontend-ui-developer":"Next: test-generator should create test coverage","test-generator":"Next: code-quality-reviewer should validate implementation","code-quality-reviewer":"Next: security-auditor should perform security scan","workflow-architect":"Next: llm-integrator should configure LLM providers","llm-integrator":"Next: data-pipeline-engineer should set up embeddings","data-pipeline-engineer":"Next: code-quality-reviewer should validate data pipeline","database-engineer":"Next: backend-system-architect should integrate schema","rapid-ui-designer":"Next: frontend-ui-developer should implement designs","ux-researcher":"Next: rapid-ui-designer should create mockups"};function Wi(t){return Ji[t]||"none"}function Ki(t){return zi[t]||"Pipeline complete"}function Vi(t,e,n,r,i){let s=`${d()}/.claude/context/handoffs`;try{Le(s,{recursive:!0})}catch{}let o=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),a=`${s}/${t}_to_${e}_${o}.json`,u={from_agent:t,to_agent:e,timestamp:n,summary:r,suggestions:i,status:"ready_for_handoff"};try{Me(a,JSON.stringify(u,null,2))}catch{}return a}function Xi(t,e,n,r,i,s){let o=`${d()}/.claude/logs/agent-handoffs`;try{Le(o,{recursive:!0})}catch{}let a=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),u=`${o}/${t}_${a}.log`,g=`=== HANDOFF PREPARATION ===
From: ${t}
To: ${e}
Timestamp: ${n}
Handoff file: ${s}

Summary: ${r}

Next Steps: ${i}
`;try{Me(u,g)}catch{}}function tt(t){let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown";if(!Gi.has(r))return l();let i=Wi(r),s=t.agent_output||t.output||"",o=s.length,a;o>0?(a=s.substring(0,300),o>300&&(a+="...")):a=`Agent ${r} completed`;let u=Ki(r),g=Vi(r,i,e,a,u);return Xi(r,i,e,a,u,g),l()}import{writeFileSync as Qi,mkdirSync as Fe,appendFileSync as Yi}from"node:fs";var Zi=["\\.env","auth","secret","credential","password","token","api[_-]?key","jwt","session","oauth","permission","\\.pem$","\\.key$","config.*prod"];function ts(){let t=`${d()}/.claude/logs/multi-claude`;try{Fe(t,{recursive:!0})}catch{}return t}function D(t,e,n){let r=ts(),i=new Date().toISOString().substring(0,10).replace(/-/g,""),s=`${r}/verifier_${i}.log`,o=new Date().toISOString();try{Yi(s,`[${o}] [${t}] ${e}: ${n}
`)}catch{}}function es(t){for(let e of Zi)if(new RegExp(e,"i").test(t))return!0;return!1}function Ue(t){let e=new Date().toISOString(),n=d(),i=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",s=t.agent_output||t.output||"",o=[];if(i==="test-generator"&&(o.push({agent:"code-quality-reviewer",reason:"Test generation complete - quality review recommended"}),D(i,"TRIGGER","test-generator completion triggers code-quality-reviewer")),i==="frontend-ui-developer"&&/form|input|validation|submit|auth|login/i.test(s)&&(o.push({agent:"security-auditor",reason:"Frontend auth/form components - security review recommended"}),D(i,"TRIGGER","frontend auth components trigger security-auditor")),i==="backend-system-architect"&&/endpoint|route|api|auth|jwt|session/i.test(s)&&(o.push({agent:"security-auditor",reason:"Backend API endpoints - security review recommended"}),D(i,"TRIGGER","backend API endpoints trigger security-auditor")),es(s)&&(o.some(u=>u.agent==="security-auditor")||(o.push({agent:"security-auditor",reason:"Sensitive files modified - security review required"}),D(i,"TRIGGER","sensitive file patterns detected"))),i==="database-engineer"&&(o.push({agent:"code-quality-reviewer",reason:"Database schema changes - review for consistency"}),D(i,"TRIGGER","database changes trigger code-quality-reviewer")),i==="workflow-architect"&&(o.push({agent:"security-layer-auditor",reason:"LangGraph workflow created - layer audit recommended"}),D(i,"TRIGGER","workflow-architect triggers security-layer-auditor")),o.length>0){let a=`${n}/.claude/context/verification-queue`;try{Fe(a,{recursive:!0})}catch{}let u=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),g=`${a}/pending_${u}_${i}.json`,p={triggered_by:i,timestamp:e,verifications:o.map(m=>({agent:m.agent,reason:m.reason,status:"pending"}))};try{Qi(g,JSON.stringify(p,null,2))}catch{}let f="Multi-Claude Verification Triggered: "+o.map(m=>`${m.agent} (${m.reason})`).join("; ");return D(i,"QUEUE",`Created verification queue: ${g}`),{continue:!0,systemMessage:f}}return D(i,"SKIP","No verification triggers matched"),l()}import{writeFileSync as ns,mkdirSync as rs}from"node:fs";function is(){let t=`${d()}/.claude/logs/agent-validation`;try{rs(t,{recursive:!0})}catch{}return t}function Be(t){let e=t.subagent_type||t.agent_type||"unknown",n=new Date().toISOString(),r=t.agent_output||t.output||"",i=[],s=[];r||i.push("Agent produced empty output");let o=r.length;if(o<50&&s.push(`Output seems very short (${o} chars)`),/error|failed|exception/i.test(r)&&s.push("Output contains error-related keywords"),e==="backend-system-architect"&&r.includes("{")){let h=r.match(/\{[^}]*\}/);if(h)try{JSON.parse(h[0])}catch{s.push("JSON structure may be malformed")}}let a=i.length>0?"failed":"passed",u=`Output Validation [${a}] - Agent: ${e}, Timestamp: ${n}, Output length: ${o} chars`;i.length>0&&(u+=" | Errors: "+i.join("; ")),s.length>0&&(u+=" | Warnings: "+s.join("; "));let g=is(),p=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),f=`${g}/${e}_${p}.log`,m=`=== OUTPUT VALIDATION ===
${u}

=== AGENT OUTPUT ===
${r}
`;try{ns(f,m)}catch{}return a==="failed"?{continue:!1,systemMessage:u,hookSpecificOutput:{hookEventName:"SubagentStop"}}:{continue:!0,suppressOutput:!0,systemMessage:u}}import{existsSync as ss,writeFileSync as os,readFileSync as as}from"node:fs";var Ct="/tmp/claude-session-metrics.json";function cs(){if(ss(Ct))try{let t=JSON.parse(as(Ct,"utf8"));t.errors=(t.errors||0)+1,os(Ct,JSON.stringify(t,null,2))}catch{}}function qe(t){let e=t.agent_id||"",n=t.subagent_type||"",r=t.error||"";return c("subagent-quality-gate",`Quality gate check: ${n} (${e})`),r&&r!=="null"?(c("subagent-quality-gate",`ERROR: Subagent failed - ${r}`),cs(),E(`Subagent ${n} failed: ${r}`)):l()}function us(t){let e=t.error||t.tool_error,n=t.exit_code;if(e&&e!=="null"&&e!==""||n!==void 0&&n!==0)return!1;let r=t.agent_output||t.output||"",i=[/\bfailed\b/i,/\berror:\s/i,/\bexception\b/i,/\bcould not\b/i,/\bunable to\b/i],s=r.slice(0,500);for(let o of i)o.test(s)&&c("task-completer",`Warning: possible error in output: ${o}`);return!0}function Ge(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return c("task-completer","No agent type found, skipping"),l();c("task-completer",`Processing SubagentStop for: ${n}`);let r=T(n);if(!r)return c("task-completer",`No orchestration task found for agent: ${n}`),gt(n),l();let i=us(t),s=i?"completed":"failed";c("task-completer",`Agent ${n} completed with status: ${s}`),x(r.taskId,s),O(n,s);let o=`## Orchestration: Task ${i?"Completed":"Failed"}

Agent \`${n}\` has finished with status: **${s}**

${K({taskId:r.taskId,status:i?"completed":"pending"})}
`;if(i&&r.pipelineId&&r.pipelineStep!==void 0){let a=Ie(r.pipelineId,r.pipelineStep);if(a!==null){let u=vt(r.pipelineId).filter(g=>g.pipelineStep===a&&g.status==="pending");u.length>0&&(o+=`
### Pipeline Progress

Pipeline \`${r.pipelineId}\` step ${r.pipelineStep} complete.
Next step (${a}) is now unblocked.

**Next agent(s) to spawn:**
${u.map(g=>`- \`${g.agent}\` (task: ${g.taskId})`).join(`
`)}

Consider spawning the next agent to continue the pipeline.`)}else o+=`
### Pipeline Complete

Pipeline \`${r.pipelineId}\` has completed all steps.`}if(!i){let a=t.error||t.tool_error||"Unknown error";o+=`
### Error Details

The agent encountered an issue:
\`\`\`
${a.slice(0,500)}
\`\`\`

Consider:
1. Retrying with more specific instructions
2. Using an alternative agent
3. Breaking down the task further`;let u=_e(r.taskId);if(u.length>0){o+=`

### Orphaned Tasks (CC 2.1.20)

The following tasks were blocked by the failed task and should be deleted:
`;for(let g of u)o+=`
${be(g.taskId,`Blocked by failed task ${r.taskId} (agent: ${n})`)}`,x(g.taskId,"failed")}}return s==="completed"&&gt(n),c("task-completer",`Completed task ${r.taskId} with status ${s}`),A(o)}var Rt=new Map;function gs(t,e){let n=Rt.get(t)||[];n.push(e),n.length>10&&n.shift(),Rt.set(t,n)}function ds(){let t=[];for(let[e,n]of Rt)n.some(r=>r.outcome==="failure")&&t.push(e);return t}function ls(t){let e=t.error||t.tool_error,n=t.exit_code,r=t.agent_output||t.output||"";if(e&&e!=="null"&&e!=="")return{outcome:"failure",error:e};if(n!==void 0&&n!==0)return{outcome:"failure",error:`Exit code: ${n}`};let i=[/i cannot|i can't|i am unable/i,/outside my scope/i,/not appropriate/i,/i refuse/i];for(let o of i)if(o.test(r.slice(0,500)))return{outcome:"rejected",error:"Agent rejected the task"};let s=[/partial(?:ly)?/i,/incomplete/i,/some.*failed/i,/couldn't finish/i];for(let o of s)if(o.test(r.slice(0,500)))return{outcome:"partial"};return{outcome:"success"}}function Je(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return l();let{outcome:r,error:i}=ls(t);if(r==="success")return l();c("retry-handler",`Agent ${n} completed with outcome: ${r}`);let s=dt(),a=I().activeAgents.find(k=>k.agent===n),u=a?.retryCount||0,g=Qt(n,u+1,a?.taskId),p=Yt(g,r,i||void 0);gs(n,p);let f=ds(),m=Xt(n,u+1,i||"Unknown failure",f,s.maxRetries);if(c("retry-handler",`Retry decision for ${n}: shouldRetry=${m.shouldRetry}, alternative=${m.alternativeAgent||"none"}`),m.shouldRetry)O(n,"retrying");else{O(n,"failed");let k=T(n);k&&x(k.taskId,"failed")}let h=Zt(m,n);return A(h)}import{existsSync as Qe,appendFileSync as Is,mkdirSync as xs,readFileSync as $s,writeFileSync as ws}from"node:fs";import{existsSync as ps,readFileSync as ms,writeFileSync as Dc,mkdirSync as Cc}from"node:fs";import{execSync as ze}from"node:child_process";import{createHash as fs}from"node:crypto";import*as We from"node:os";var ys=".claude/.user_identity.json",hs="orchestkit-user-identity-v1";var b=null;function et(t){return fs("sha256").update(t+hs).digest("hex").slice(0,32)}function ks(){try{return We.hostname()}catch{return"unknown-machine"}}function Ss(t){let e=`${t}/${ys}`;if(!ps(e))return null;try{let n=ms(e,"utf8");return JSON.parse(n)}catch(n){return c("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function bs(t){let e={};try{e.email=ze("git config user.email",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{e.name=ze("git config user.name",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return e}function _s(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function vs(t){if(b)return b;let e=t||d(),n=ks(),r=Ss(e);if(r?.user_id)return b={user_id:r.user_id,display_name:r.display_name||r.user_id,team_id:r.team_id,machine_id:n,source:"config",anonymous_id:et(r.user_id),email:r.user_id.includes("@")?r.user_id:void 0},c("user-identity",`Resolved from config: ${b.anonymous_id}`,"debug"),b;let i=bs(e);if(i.email)return b={user_id:i.email,display_name:i.name||i.email.split("@")[0],team_id:r?.team_id,machine_id:n,source:"git",anonymous_id:et(i.email),email:i.email},c("user-identity",`Resolved from git: ${b.anonymous_id}`,"debug"),b;let s=_s();if(s.username){let a=`${s.username}@${n}`;return b={user_id:a,display_name:s.username,team_id:r?.team_id,machine_id:n,source:"env",anonymous_id:et(a)},c("user-identity",`Resolved from env: ${b.anonymous_id}`,"debug"),b}let o=et(n+process.pid);return b={user_id:`anon-${o.slice(0,8)}`,display_name:"Anonymous",team_id:r?.team_id,machine_id:n,source:"anonymous",anonymous_id:o},c("user-identity",`Resolved as anonymous: ${b.anonymous_id}`,"debug"),b}function Ke(){let t=vs();return{session_id:y(),user_id:t.user_id,anonymous_id:t.anonymous_id,team_id:t.team_id,machine_id:t.machine_id,identity_source:t.source,timestamp:new Date().toISOString()}}var As=/^[a-zA-Z0-9_-]{1,128}$/;function Ts(t){return As.test(t)}function Pt(t,e){let n=t||y(),r=e||d();if(!Ts(n))throw new Error("Invalid session ID format");return`${r}/.claude/memory/sessions/${n}`}function Ds(t,e){return`${Pt(t,e)}/events.jsonl`}function Ye(t,e){let n=Pt(t,e);Qe(n)||xs(n,{recursive:!0})}var B=0,Ve=!1,Et=!1,Xe=0,Cs=5e3;function Ze(t,e){return`${Pt(t,e)}/counter.json`}function Rs(t,e){if(!Ve){Ve=!0;try{let n=Ze(t,e);if(Qe(n)){let r=JSON.parse($s(n,"utf8"));typeof r.counter=="number"&&r.counter>0&&(B=r.counter,c("session-tracker",`Loaded event counter: ${B}`,"debug"))}}catch{}}}function Es(t,e){if(!Et)return;let n=Date.now();if(!(n-Xe<Cs))try{Ye(t,e);let r=Ze(t,e);ws(r,JSON.stringify({counter:B,updated_at:new Date().toISOString()})),Et=!1,Xe=n}catch{}}function Os(){return Rs(),B++,Et=!0,Es(),`evt-${Date.now()}-${B}`}function tn(t,e,n={}){try{let r={event_id:Os(),event_type:t,identity:Ke(),payload:{name:e,input:Ot(n.input),output:Ot(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?en(n.context,500):void 0,confidence:n.confidence}};Ye();let i=Ds();Is(i,JSON.stringify(r)+`
`),c("session-tracker",`Tracked ${t}: ${e}`,"debug")}catch(r){c("session-tracker",`Failed to track event: ${r}`,"warn")}}function en(t,e){return t.length<=e?t:t.slice(0,e-3)+"..."}function Ot(t){if(!t)return;let e={},n=["password","secret","token","key","credential","auth"];for(let[r,i]of Object.entries(t)){if(n.some(s=>r.toLowerCase().includes(s))){e[r]="[REDACTED]";continue}if(typeof i=="string"&&i.length>500){e[r]=en(i,500);continue}if(typeof i=="object"&&i!==null&&!Array.isArray(i)){e[r]=Ot(i);continue}e[r]=i}return e}import{appendFileSync as Ps,mkdirSync as Hs}from"node:fs";import{createHash as js}from"node:crypto";function Ns(){return st(rt(),".claude","analytics")}function nn(t){return js("sha256").update(t).digest("hex").slice(0,12)}function rn(t,e){try{let n=Ns();Hs(n,{recursive:!0}),Ps(st(n,t),JSON.stringify(e)+`
`)}catch{}}var sn=[{name:"context-publisher",fn:Y},{name:"handoff-preparer",fn:tt},{name:"feedback-loop",fn:Z},{name:"agent-memory-store",fn:X}];function Ms(t){try{let e=t.subagent_type||t.agent_type||"unknown",n=!t.error,r=t.duration_ms,i=t.agent_output||t.output||"",s=typeof i=="string"?i.length:0;tn("agent_spawned",e,{success:n,duration_ms:r,output:{has_output:s>0,output_length:s,has_error:!!t.error},context:t.agent_id}),rn("agent-usage.jsonl",{ts:new Date().toISOString(),pid:nn(process.env.CLAUDE_PROJECT_DIR||""),agent:e,duration_ms:r,success:n,output_len:s})}catch{}}async function on(t){Ms(t);let n=(await Promise.allSettled(sn.map(async r=>{try{let i=r.fn(t);return i instanceof Promise&&await i,{hook:r.name,status:"success"}}catch(i){let s=i instanceof Error?i.message:String(i);return c("subagent-stop-dispatcher",`${r.name} failed: ${s}`),{hook:r.name,status:"error",message:s}}}))).filter(r=>r.status==="rejected"||r.status==="fulfilled"&&r.value.status==="error");return n.length>0&&c("subagent-stop-dispatcher",`${n.length}/${sn.length} hooks had errors`),l()}var an={"subagent-start/graph-memory-inject":ae,"subagent-start/mem0-memory-inject":ge,"subagent-start/context-gate":pe,"subagent-start/subagent-context-stager":ye,"subagent-start/subagent-validator":he,"subagent-start/task-linker":xe,"subagent-start/model-cost-advisor":Ae,"subagent-stop/agent-memory-store":X,"subagent-stop/auto-spawn-quality":Ce,"subagent-stop/context-publisher":Y,"subagent-stop/feedback-loop":Z,"subagent-stop/handoff-preparer":tt,"subagent-stop/multi-claude-verifier":Ue,"subagent-stop/output-validator":Be,"subagent-stop/subagent-quality-gate":qe,"subagent-stop/task-completer":Ge,"subagent-stop/retry-handler":Je,"subagent-stop/unified-dispatcher":on};function fu(t){return an[t]}function yu(){return Object.keys(an)}export{vo as DEFAULT_CONFIG,_o as THRESHOLDS,Eo as addToPromptHistory,Uo as analyzeAttemptHistory,Ko as applyDecay,Po as cacheClassification,zn as calculateBackoffDelay,Mo as cleanupOldStates,No as clearSessionState,Yt as completeAttempt,Qt as createAttempt,So as escapeRegex,Nn as estimateTokenCount,Zt as formatRetryDecision,Ao as getActiveAgent,Vo as getAdjustments,Xo as getAgentSuccessRate,lt as getAlternativeAgent,so as getCachedBranch,Qo as getCalibrationStats,io as getEnvFile,ho as getField,fu as getHook,Ro as getInjectedSkills,Ho as getLastClassification,Bt as getLogDir,En as getLogLevel,G as getPluginRoot,d as getProjectDir,Oo as getPromptHistory,y as getSessionId,Yo as hasMinimalCalibrationData,nr as hashPrompt,an as hooks,To as isAgentDispatched,Fs as isBashInput,Bs as isEditInput,qs as isReadInput,Wn as isRetryableError,Co as isSkillInjected,Us as isWriteInput,yu as listHooks,L as loadCalibrationData,dt as loadConfig,I as loadState,c as logHook,mo as logPermissionFeedback,Xt as makeRetryDecision,ko as normalizeCommand,oo as normalizeLineEndings,go as outputAllowWithContext,co as outputBlock,at as outputDeny,lo as outputError,Pn as outputPromptContext,fo as outputPromptContextBudgeted,ao as outputSilentAllow,l as outputSilentSuccess,E as outputWarning,A as outputWithContext,uo as outputWithNotification,po as outputWithUpdatedInput,Bo as prepareForRetry,yo as readHookInput,Wo as recordOutcome,gt as removeAgent,er as saveCalibrationData,jo as saveConfig,Ln as saveState,On as shouldLog,Kn as suggestsAlternative,wo as trackDispatchedAgent,Do as trackInjectedSkill,O as updateAgentStatus,j as updateState};
//# sourceMappingURL=subagent.mjs.map
