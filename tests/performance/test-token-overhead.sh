#!/usr/bin/env bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-02-27

# ============================================================================
# Token Overhead Test (TDD)
# ============================================================================
# Enforces strict token budgets for everything that loads into Claude's context
# on EVERY session or EVERY message. These are HARD failures, not warnings.
#
# Overhead vectors tested:
# 1. CLAUDE.md — loaded into system prompt every session
# 2. MEMORY.md — loaded into system prompt every session (first 200 lines)
# 3. Agent descriptions — ALL 38 listed in Task tool system prompt
# 4. User-invocable skill count — each adds description to system prompt
# 5. Hook dispatcher budget — per-turn context injection cap
# 6. Total session overhead — combined budget for all vectors
#
# Usage: ./test-token-overhead.sh [--verbose]
# Exit codes: 0 = all pass, 1 = failures found
# ============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="${CLAUDE_PROJECT_DIR:-$(cd "$SCRIPT_DIR/../.." && pwd)}"
AGENTS_DIR="$PROJECT_ROOT/src/agents"
SKILLS_DIR="$PROJECT_ROOT/src/skills"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

PASS_COUNT=0
FAIL_COUNT=0

pass() { echo -e "  ${GREEN}✓${NC} $1"; PASS_COUNT=$((PASS_COUNT + 1)); }
fail() { echo -e "  ${RED}✗${NC} $1"; FAIL_COUNT=$((FAIL_COUNT + 1)); }
info() { echo -e "  ${BLUE}ℹ${NC} $1"; }

# Token estimation: ~4 chars per token for English text
estimate_tokens() {
    local bytes="$1"
    echo $(( (bytes + 3) / 4 ))
}

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "  Token Overhead Tests (TDD — Hard Failures)"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# ============================================================================
# Budget Limits (these are the targets — tests FAIL if exceeded)
# ============================================================================
CLAUDE_MD_MAX_BYTES=4800       # ~1,200 tokens — project instructions
MEMORY_MD_MAX_BYTES=5000       # ~1,250 tokens — auto-memory (trim the bloat)
AGENT_DESC_TOTAL_MAX_BYTES=6000  # ~1,500 tokens — all 38 agent descriptions combined
AGENT_DESC_SINGLE_MAX_BYTES=250  # ~62 tokens — no single agent description > 250 bytes
MAX_USER_INVOCABLE_SKILLS=20   # Each adds ~50-100 tokens to system prompt
HOOK_BUDGET_MAX_TOKENS=800     # Per-turn dispatcher cap
TOTAL_SESSION_MAX_TOKENS=5000  # Combined session overhead budget

echo "  Budgets:"
echo "  ├─ CLAUDE.md:           < ${CLAUDE_MD_MAX_BYTES} bytes (~$(estimate_tokens $CLAUDE_MD_MAX_BYTES)t)"
echo "  ├─ MEMORY.md:           < ${MEMORY_MD_MAX_BYTES} bytes (~$(estimate_tokens $MEMORY_MD_MAX_BYTES)t)"
echo "  ├─ Agent descs (total): < ${AGENT_DESC_TOTAL_MAX_BYTES} bytes (~$(estimate_tokens $AGENT_DESC_TOTAL_MAX_BYTES)t)"
echo "  ├─ Agent desc (each):   < ${AGENT_DESC_SINGLE_MAX_BYTES} bytes (~$(estimate_tokens $AGENT_DESC_SINGLE_MAX_BYTES)t)"
echo "  ├─ User-invocable:      ≤ ${MAX_USER_INVOCABLE_SKILLS} skills"
echo "  ├─ Hook budget/turn:    ≤ ${HOOK_BUDGET_MAX_TOKENS} tokens"
echo "  └─ Total session:       < ${TOTAL_SESSION_MAX_TOKENS} tokens"
echo ""

# ============================================================================
# Test 1: CLAUDE.md Size
# ============================================================================
echo "▶ Test 1: CLAUDE.md Size"
echo "────────────────────────────────────────"

claude_md="$PROJECT_ROOT/CLAUDE.md"
if [[ -f "$claude_md" ]]; then
    claude_md_bytes=$(wc -c < "$claude_md" | tr -d ' ')
    claude_md_tokens=$(estimate_tokens "$claude_md_bytes")
    if [[ "$claude_md_bytes" -le "$CLAUDE_MD_MAX_BYTES" ]]; then
        pass "CLAUDE.md: ${claude_md_bytes} bytes (~${claude_md_tokens}t) ≤ ${CLAUDE_MD_MAX_BYTES}"
    else
        fail "CLAUDE.md: ${claude_md_bytes} bytes (~${claude_md_tokens}t) exceeds ${CLAUDE_MD_MAX_BYTES} limit"
    fi
else
    fail "CLAUDE.md not found"
fi
echo ""

# ============================================================================
# Test 2: MEMORY.md Size
# ============================================================================
echo "▶ Test 2: MEMORY.md Size"
echo "────────────────────────────────────────"

# Find MEMORY.md in the project's auto-memory directory
memory_md=""
for candidate in \
    "$HOME/.claude/projects/-Users-$(whoami)-coding-orchestkit/memory/MEMORY.md" \
    "$PROJECT_ROOT/.claude/memory/MEMORY.md"; do
    if [[ -f "$candidate" ]]; then
        memory_md="$candidate"
        break
    fi
done

if [[ -n "$memory_md" ]]; then
    # CC only loads first 200 lines — measure that
    memory_md_bytes=$(head -200 "$memory_md" | wc -c | tr -d ' ')
    memory_md_tokens=$(estimate_tokens "$memory_md_bytes")
    if [[ "$memory_md_bytes" -le "$MEMORY_MD_MAX_BYTES" ]]; then
        pass "MEMORY.md (first 200 lines): ${memory_md_bytes} bytes (~${memory_md_tokens}t) ≤ ${MEMORY_MD_MAX_BYTES}"
    else
        fail "MEMORY.md (first 200 lines): ${memory_md_bytes} bytes (~${memory_md_tokens}t) exceeds ${MEMORY_MD_MAX_BYTES} limit"
        info "Trim stale debug notes, old pitfalls, and resolved issues"
    fi
else
    info "MEMORY.md not found (ok for CI — only exists locally)"
    pass "MEMORY.md: skipped (not found)"
fi
echo ""

# ============================================================================
# Test 3: Agent Description Total Size
# ============================================================================
echo "▶ Test 3: Agent Description Overhead"
echo "────────────────────────────────────────"

agent_desc_total=0
agent_desc_violations=0
agent_count=0

for agent_file in "$AGENTS_DIR"/*.md; do
    [[ ! -f "$agent_file" ]] && continue
    agent_name=$(basename "$agent_file" .md)
    ((agent_count++)) || true

    # Extract description from YAML frontmatter
    desc=$(awk '/^---/{c++;next}c==1' "$agent_file" | grep '^description:' | sed 's/^description: //' | sed 's/^"//' | sed 's/"$//')
    desc_bytes=${#desc}
    agent_desc_total=$((agent_desc_total + desc_bytes))

    if [[ "$desc_bytes" -gt "$AGENT_DESC_SINGLE_MAX_BYTES" ]]; then
        fail "Agent '${agent_name}': description ${desc_bytes} bytes > ${AGENT_DESC_SINGLE_MAX_BYTES} limit"
        ((agent_desc_violations++)) || true
    fi
done

agent_desc_tokens=$(estimate_tokens "$agent_desc_total")

if [[ "$agent_desc_total" -le "$AGENT_DESC_TOTAL_MAX_BYTES" ]]; then
    pass "Agent descriptions total: ${agent_desc_total} bytes (~${agent_desc_tokens}t) across ${agent_count} agents ≤ ${AGENT_DESC_TOTAL_MAX_BYTES}"
else
    fail "Agent descriptions total: ${agent_desc_total} bytes (~${agent_desc_tokens}t) exceeds ${AGENT_DESC_TOTAL_MAX_BYTES} limit"
    info "Shorten verbose agent descriptions — CC lists ALL of them in Task tool prompt"
fi

if [[ "$agent_desc_violations" -eq 0 ]]; then
    pass "All individual agent descriptions ≤ ${AGENT_DESC_SINGLE_MAX_BYTES} bytes"
fi
echo ""

# ============================================================================
# Test 4: User-Invocable Skill Count
# ============================================================================
echo "▶ Test 4: User-Invocable Skill Count"
echo "────────────────────────────────────────"

invocable_count=$(grep -rl 'user-invocable: true' "$SKILLS_DIR"/*/SKILL.md 2>/dev/null | wc -l | tr -d ' ')

if [[ "$invocable_count" -le "$MAX_USER_INVOCABLE_SKILLS" ]]; then
    pass "User-invocable skills: ${invocable_count} ≤ ${MAX_USER_INVOCABLE_SKILLS}"
else
    fail "User-invocable skills: ${invocable_count} exceeds ${MAX_USER_INVOCABLE_SKILLS} limit"
    info "Each user-invocable skill adds its description to the system prompt"
fi
echo ""

# ============================================================================
# Test 5: Hook Dispatcher Budget Constant
# ============================================================================
echo "▶ Test 5: Hook Dispatcher Budget Cap"
echo "────────────────────────────────────────"

dispatcher_file="$PROJECT_ROOT/src/hooks/src/prompt/unified-dispatcher.ts"
if [[ -f "$dispatcher_file" ]]; then
    # Extract MAX_OUTPUT_TOKENS constant value
    budget_value=$(grep 'MAX_OUTPUT_TOKENS' "$dispatcher_file" | grep -o '[0-9]\+' | head -1)
    if [[ -n "$budget_value" ]] && [[ "$budget_value" -le "$HOOK_BUDGET_MAX_TOKENS" ]]; then
        pass "Hook dispatcher budget: ${budget_value} tokens ≤ ${HOOK_BUDGET_MAX_TOKENS}"
    elif [[ -n "$budget_value" ]]; then
        fail "Hook dispatcher budget: ${budget_value} tokens exceeds ${HOOK_BUDGET_MAX_TOKENS} limit"
    else
        fail "Could not find MAX_OUTPUT_TOKENS in dispatcher"
    fi
else
    fail "Dispatcher not found at ${dispatcher_file}"
fi
echo ""

# ============================================================================
# Test 6: Total Session Overhead Budget
# ============================================================================
echo "▶ Test 6: Total Session Overhead"
echo "────────────────────────────────────────"

# Sum all per-session vectors
claude_md_t=$(estimate_tokens "${claude_md_bytes:-0}")
memory_md_t=$(estimate_tokens "${memory_md_bytes:-0}")
agent_desc_t=$(estimate_tokens "${agent_desc_total:-0}")

# Estimate user-invocable skill descriptions (~80 tokens avg per skill)
invocable_t=$((invocable_count * 80))

total_session_t=$((claude_md_t + memory_md_t + agent_desc_t + invocable_t))

echo "  Breakdown:"
echo "  ├─ CLAUDE.md:           ~${claude_md_t}t"
echo "  ├─ MEMORY.md:           ~${memory_md_t}t"
echo "  ├─ Agent descriptions:  ~${agent_desc_t}t"
echo "  ├─ Invocable skills:    ~${invocable_t}t (${invocable_count} × ~80t)"
echo "  └─ Total:               ~${total_session_t}t"
echo ""

if [[ "$total_session_t" -le "$TOTAL_SESSION_MAX_TOKENS" ]]; then
    pass "Total session overhead: ~${total_session_t} tokens ≤ ${TOTAL_SESSION_MAX_TOKENS}"
else
    fail "Total session overhead: ~${total_session_t} tokens exceeds ${TOTAL_SESSION_MAX_TOKENS} budget"
    overage=$((total_session_t - TOTAL_SESSION_MAX_TOKENS))
    info "Over budget by ~${overage} tokens — trim agent descriptions and MEMORY.md"
fi
echo ""

# ============================================================================
# Summary
# ============================================================================
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "  Results: ${PASS_COUNT} passed, ${FAIL_COUNT} failed"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

if [[ "$FAIL_COUNT" -gt 0 ]]; then
    echo -e "  ${RED}FAILED${NC}: Token overhead exceeds budget"
    echo ""
    echo "  Fix priority:"
    echo "  1. Trim agent descriptions (biggest per-session waste)"
    echo "  2. Trim MEMORY.md (remove resolved issues, old debug notes)"
    echo "  3. Review CLAUDE.md for stale sections"
    exit 1
else
    echo -e "  ${GREEN}ALL TESTS PASSED${NC}: Token overhead within budget"
    exit 0
fi
