#!/bin/bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-02-07

# Unit tests for CDN video pipeline
# Validates that generate-playground-data.js merges cdn-urls.json correctly
# and that the generated playground-data.ts contains CDN fields.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/../.." && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

TESTS_PASSED=0
TESTS_FAILED=0

log_pass() {
    echo -e "${GREEN}✓${NC} $1"
    ((TESTS_PASSED++)) || true
}

log_fail() {
    echo -e "${RED}✗${NC} $1"
    ((TESTS_FAILED++)) || true
}

log_section() {
    echo ""
    echo "═══════════════════════════════════════════════════════════════"
    echo "  $1"
    echo "═══════════════════════════════════════════════════════════════"
}

# After v6.0.3, playground-data.ts is a barrel re-exporting from generated/ split modules.
# Check split files first; fall back to monolith barrel for backward compat.
GENERATED_DIR="${PROJECT_ROOT}/docs/site/lib/generated"
if [[ -f "${GENERATED_DIR}/compositions-data.ts" ]]; then
    TS_FILE="${GENERATED_DIR}/compositions-data.ts"
    TYPES_FILE="${GENERATED_DIR}/types.ts"
else
    TS_FILE="${PROJECT_ROOT}/docs/site/lib/playground-data.ts"
    TYPES_FILE="$TS_FILE"
fi
CDN_FILE="${PROJECT_ROOT}/orchestkit-demos/out/cdn-urls.json"

# ── cdn-urls.json source ─────────────────────────────────────

log_section "CDN URLs Source File"

# cdn-urls.json lives in an external repo (orchestkit-demos/) and is NOT committed here.
# These tests only run when the file is present (local dev with demos repo cloned).
if [[ ! -f "$CDN_FILE" ]]; then
    echo -e "${YELLOW}SKIP${NC} cdn-urls.json not found at $CDN_FILE (external repo, optional)"
    echo "  CDN-specific tests skipped — only code-structure tests will run"
else

test_cdn_file_valid_json() {
    if node -e "JSON.parse(require('fs').readFileSync('$CDN_FILE','utf-8'))" 2>/dev/null; then
        log_pass "cdn-urls.json is valid JSON"
    else
        log_fail "cdn-urls.json is not valid JSON"
    fi
}

test_cdn_urls_are_sanity() {
    local bad_urls=""
    if bad_urls=$(node -e "
      const data = JSON.parse(require('fs').readFileSync('$CDN_FILE','utf-8'));
      const bad = [];
      for (const [id, entry] of Object.entries(data)) {
        if (entry.thumbnailCdn && !entry.thumbnailCdn.startsWith('https://cdn.sanity.io/')) bad.push(id + '.thumbnailCdn');
        if (entry.videoCdn && !entry.videoCdn.startsWith('https://cdn.sanity.io/')) bad.push(id + '.videoCdn');
      }
      if (bad.length) { console.log(bad.join(',')); process.exit(1); }
    " 2>/dev/null); then
        log_pass "All CDN URLs point to cdn.sanity.io"
    else
        log_fail "Non-Sanity CDN URLs found: $bad_urls"
    fi
}

test_cdn_video_urls_are_mp4() {
    local bad_videos=""
    if bad_videos=$(node -e "
      const data = JSON.parse(require('fs').readFileSync('$CDN_FILE','utf-8'));
      const bad = [];
      for (const [id, entry] of Object.entries(data)) {
        if (entry.videoCdn && !entry.videoCdn.endsWith('.mp4')) bad.push(id);
      }
      if (bad.length) { console.log(bad.join(',')); process.exit(1); }
    " 2>/dev/null); then
        log_pass "All video CDN URLs are .mp4 files"
    else
        log_fail "Non-mp4 video URLs: $bad_videos"
    fi
}

test_cdn_file_valid_json
test_cdn_urls_are_sanity
test_cdn_video_urls_are_mp4

fi  # end cdn-urls.json guard

# ── Generated playground-data.ts ─────────────────────────────

log_section "Generated playground-data.ts — CDN Fields"

test_ts_interface_has_cdn_fields() {
    if grep -q "thumbnailCdn?" "$TYPES_FILE" && grep -q "videoCdn?" "$TYPES_FILE"; then
        log_pass "Composition interface has thumbnailCdn? and videoCdn? fields"
    else
        log_fail "Composition interface missing CDN fields"
    fi
}

test_ts_has_thumbnail_cdn_values() {
    local count
    count=$(grep -c '"thumbnailCdn":' "$TS_FILE" || true)
    if [[ $count -gt 0 ]]; then
        log_pass "playground-data.ts has $count compositions with thumbnailCdn"
    else
        log_fail "playground-data.ts has no thumbnailCdn values — generator may not be merging cdn-urls.json"
    fi
}

test_ts_has_video_cdn_values() {
    local count
    count=$(grep -c '"videoCdn":' "$TS_FILE" || true)
    if [[ $count -gt 0 ]]; then
        log_pass "playground-data.ts has $count compositions with videoCdn"
    else
        log_fail "playground-data.ts has no videoCdn values — no videos will play in the demo gallery"
    fi
}

test_ts_video_implies_thumbnail() {
    # Every composition with videoCdn should also have thumbnailCdn (for poster)
    # Pipe file via stdin to avoid MSYS path issues on Windows (node can't read /d/a/... paths)
    local failures=""
    if failures=$(node -e "
      const content = require('fs').readFileSync(0, 'utf-8');
      const match = content.match(/export const COMPOSITIONS.*?= (\[[\s\S]*?\]);/);
      if (!match) { console.log('PARSE_ERROR'); process.exit(1); }
      const comps = eval(match[1]);
      const bad = comps.filter(c => c.videoCdn && !c.thumbnailCdn).map(c => c.id);
      if (bad.length) { console.log(bad.join(',')); process.exit(1); }
    " < "$TS_FILE" 2>/dev/null); then
        log_pass "Every composition with videoCdn also has thumbnailCdn"
    else
        log_fail "Compositions with video but no thumbnail poster: $failures"
    fi
}

test_ts_interface_has_cdn_fields
test_ts_has_thumbnail_cdn_values
test_ts_has_video_cdn_values
test_ts_video_implies_thumbnail

# ── CSP headers ──────────────────────────────────────────────

log_section "CSP Headers — media-src"

test_csp_has_media_src() {
    local config_file="${PROJECT_ROOT}/docs/site/next.config.mjs"
    if grep -q "media-src.*cdn.sanity.io" "$config_file"; then
        log_pass "next.config.mjs CSP includes media-src for cdn.sanity.io"
    else
        log_fail "next.config.mjs missing media-src for cdn.sanity.io — videos will be blocked by CSP"
    fi
}

test_csp_has_media_src

# ── Component wiring ────────────────────────────────────────

log_section "Component Wiring — Video Player"

test_demo_gallery_has_video_element() {
    local gallery="${PROJECT_ROOT}/docs/site/components/demo-gallery.tsx"
    if grep -q "<video" "$gallery"; then
        log_pass "demo-gallery.tsx contains <video> element"
    else
        log_fail "demo-gallery.tsx has no <video> element — modal won't play videos"
    fi
}

test_demo_gallery_uses_cdn_thumbnail() {
    local gallery="${PROJECT_ROOT}/docs/site/components/demo-gallery.tsx"
    if grep -q "thumbnailCdn" "$gallery"; then
        log_pass "demo-gallery.tsx references thumbnailCdn"
    else
        log_fail "demo-gallery.tsx does not use thumbnailCdn — cards will always use local thumbnails"
    fi
}

test_demo_gallery_uses_video_cdn() {
    local gallery="${PROJECT_ROOT}/docs/site/components/demo-gallery.tsx"
    if grep -q "videoCdn" "$gallery"; then
        log_pass "demo-gallery.tsx references videoCdn"
    else
        log_fail "demo-gallery.tsx does not use videoCdn — modal won't check for videos"
    fi
}

test_homepage_uses_cdn_thumbnail() {
    local homepage="${PROJECT_ROOT}/docs/site/app/(home)/page.tsx"
    if grep -q "thumbnailCdn" "$homepage"; then
        log_pass "homepage uses thumbnailCdn for demo showcase"
    else
        log_fail "homepage does not use thumbnailCdn — showcase always uses local thumbnails"
    fi
}

test_demo_gallery_has_video_element
test_demo_gallery_uses_cdn_thumbnail
test_demo_gallery_uses_video_cdn
test_homepage_uses_cdn_thumbnail

test_demo_gallery_has_production_state() {
    local gallery="${PROJECT_ROOT}/docs/site/components/demo-gallery.tsx"
    if grep -q "In production" "$gallery"; then
        log_pass "demo-gallery.tsx shows 'In production' state for missing videos"
    else
        log_fail "demo-gallery.tsx has no production state indicator — users see no feedback for missing videos"
    fi
}

test_demo_gallery_has_production_state

# ── Summary ──────────────────────────────────────────────────

echo ""
echo "═══════════════════════════════════════════════════════════════"
echo -e "  Results: ${GREEN}${TESTS_PASSED} passed${NC}, ${RED}${TESTS_FAILED} failed${NC}"
echo "═══════════════════════════════════════════════════════════════"

if [[ $TESTS_FAILED -gt 0 ]]; then
    exit 1
fi
