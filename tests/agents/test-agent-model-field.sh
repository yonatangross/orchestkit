#!/usr/bin/env bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-02-19

# Test: Validates CC 2.1.47 agent model field for team spawn compatibility
# All agents must have a valid model field for Task tool team_name spawning

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
AGENTS_DIR="$REPO_ROOT/src/agents"

# Valid short-form and full model ID values
VALID_MODELS=(
  "opus"
  "sonnet"
  "haiku"
  "inherit"
  "claude-opus-4-6"
  "claude-sonnet-4-6"
  "claude-haiku-4-5"
  "claude-haiku-4-5-20251001"
)

FAILED=0
PASS_COUNT=0
FAIL_COUNT=0

echo "=== Agent Model Field Test (CC 2.1.47 Team Spawn Compatibility) ==="
echo ""

for agent_file in "$AGENTS_DIR"/*.md; do
  agent_name=$(basename "$agent_file" .md)

  # Check model field exists
  if ! grep -q "^model:" "$agent_file"; then
    echo "FAIL: $agent_name — missing 'model:' field"
    FAILED=1
    FAIL_COUNT=$((FAIL_COUNT + 1))
    continue
  fi

  # Extract model value
  model=$(grep "^model:" "$agent_file" | awk '{print $2}' | tr -d '[:space:]"'"'" || echo "")

  # Check model value is non-empty
  if [[ -z "$model" ]]; then
    echo "FAIL: $agent_name — 'model:' field is empty"
    FAILED=1
    FAIL_COUNT=$((FAIL_COUNT + 1))
    continue
  fi

  # Validate model value is in allowed list
  valid=0
  for valid_model in "${VALID_MODELS[@]}"; do
    if [[ "$model" == "$valid_model" ]]; then
      valid=1
      break
    fi
  done

  if [[ $valid -eq 0 ]]; then
    echo "FAIL: $agent_name — invalid model value: '$model' (must be opus|sonnet|haiku|inherit or full claude-* ID)"
    FAILED=1
    FAIL_COUNT=$((FAIL_COUNT + 1))
  else
    echo "PASS: $agent_name — model: $model"
    PASS_COUNT=$((PASS_COUNT + 1))
  fi
done

echo ""
echo "Results: $PASS_COUNT passed, $FAIL_COUNT failed"
echo ""

if [[ $FAILED -eq 1 ]]; then
  echo "FAIL: Agent model field test FAILED — fix missing/invalid model fields above"
  exit 1
else
  echo "PASS: All agents have valid model fields for CC 2.1.47 team spawns"
  exit 0
fi
