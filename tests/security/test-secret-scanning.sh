#!/bin/bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-02-27

# Security Tests: Content-Based Secret Scanning
# Tests for secret detection in Write/Edit content
#
# Test Count: 10
# Priority: HIGH
# Reference: OWASP ASI02/ASI03 — Prevent secret leakage via file writes

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Source test helpers
source "$SCRIPT_DIR/../fixtures/test-helpers.sh"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

TESTS_PASSED=0
TESTS_FAILED=0

log_pass() { echo -e "  ${GREEN}✓${NC} $1"; TESTS_PASSED=$((TESTS_PASSED + 1)); }
log_fail() { echo -e "  ${RED}✗${NC} $1"; TESTS_FAILED=$((TESTS_FAILED + 1)); }
log_section() { echo -e "\n${YELLOW}$1${NC}"; }

# Helper to run the content-secret-scanner hook via the TypeScript runner
run_scanner_write() {
  local file_path="$1"
  local content="$2"
  local input
  input=$(jq -n --arg fp "$file_path" --arg c "$content" \
    '{"tool_name":"Write","tool_input":{"file_path":$fp,"content":$c}}')
  echo "$input" | node "$PROJECT_ROOT/src/hooks/bin/run-hook.mjs" pretool/write-edit/content-secret-scanner 2>/dev/null || true
}

run_scanner_edit() {
  local file_path="$1"
  local new_string="$2"
  local input
  input=$(jq -n --arg fp "$file_path" --arg ns "$new_string" \
    '{"tool_name":"Edit","tool_input":{"file_path":$fp,"old_string":"placeholder","new_string":$ns}}')
  echo "$input" | node "$PROJECT_ROOT/src/hooks/bin/run-hook.mjs" pretool/write-edit/content-secret-scanner 2>/dev/null || true
}

is_blocked() {
  local result="$1"
  [[ "$result" == *'"continue": false'* ]] || [[ "$result" == *'"continue":false'* ]]
}

# ============================================================================
# SECRET SCANNING SECURITY TESTS
# ============================================================================

echo "╔══════════════════════════════════════════════════════════════════╗"
echo "║    Content-Based Secret Scanning Tests (OWASP ASI02/ASI03)       ║"
echo "╚══════════════════════════════════════════════════════════════════╝"

log_section "Test 1: Block OpenAI API key in source file"
result=$(run_scanner_write "/app/src/config.ts" 'const key = "sk-abcdefghijklmnopqrstuvwxyz1234567890";')
if is_blocked "$result"; then
  log_pass "OpenAI API key blocked"
else
  log_fail "OpenAI API key NOT blocked"
fi

log_section "Test 2: Block AWS access key"
result=$(run_scanner_write "/app/src/aws.ts" 'AWS_KEY=AKIAIOSFODNN7EXAMPLE')
if is_blocked "$result"; then
  log_pass "AWS access key blocked"
else
  log_fail "AWS access key NOT blocked"
fi

log_section "Test 3: Block GitHub PAT"
result=$(run_scanner_write "/app/deploy.sh" 'TOKEN=ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx1234')
if is_blocked "$result"; then
  log_pass "GitHub PAT blocked"
else
  log_fail "GitHub PAT NOT blocked"
fi

log_section "Test 4: Block private key block"
result=$(run_scanner_write "/app/key.pem" '-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEA...')
if is_blocked "$result"; then
  log_pass "Private key block blocked"
else
  log_fail "Private key block NOT blocked"
fi

log_section "Test 5: Block JWT token"
result=$(run_scanner_write "/app/src/auth.ts" 'const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIn0.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c";')
if is_blocked "$result"; then
  log_pass "JWT token blocked"
else
  log_fail "JWT token NOT blocked"
fi

log_section "Test 6: Block contextual secret assignment"
result=$(run_scanner_write "/app/src/config.ts" 'api_key="super_secret_key_value_1234567890"')
if is_blocked "$result"; then
  log_pass "Contextual secret assignment blocked"
else
  log_fail "Contextual secret assignment NOT blocked"
fi

log_section "Test 7: Allow normal code (no secrets)"
result=$(run_scanner_write "/app/src/utils.ts" 'export function add(a: number, b: number): number { return a + b; }')
if is_blocked "$result"; then
  log_fail "Normal code incorrectly blocked"
else
  log_pass "Normal code allowed"
fi

log_section "Test 8: Allow test fixtures (excluded path)"
result=$(run_scanner_write "/app/__tests__/fixtures/mock-key.ts" 'const key = "sk-abcdefghijklmnopqrstuvwxyz1234567890";')
if is_blocked "$result"; then
  log_fail "Test fixture incorrectly blocked"
else
  log_pass "Test fixture allowed (excluded path)"
fi

log_section "Test 9: Allow markdown docs (excluded extension)"
result=$(run_scanner_write "/app/docs/auth.md" 'Use your API key: sk-abcdefghijklmnopqrstuvwxyz1234567890')
if is_blocked "$result"; then
  log_fail "Markdown doc incorrectly blocked"
else
  log_pass "Markdown doc allowed (excluded extension)"
fi

log_section "Test 10: Block secret in Edit (new_string)"
result=$(run_scanner_edit "/app/src/config.ts" 'const stripe = "pk_live_AAAAABBBBBCCCCCDDDDDEEEEE";')
if is_blocked "$result"; then
  log_pass "Secret in Edit new_string blocked"
else
  log_fail "Secret in Edit new_string NOT blocked"
fi

# ============================================================================
# SUMMARY
# ============================================================================

echo ""
echo "=========================================="
echo "  Results: $TESTS_PASSED passed, $TESTS_FAILED failed"
echo "=========================================="

if [[ $TESTS_FAILED -gt 0 ]]; then
  echo -e "${RED}FAIL: Some tests failed${NC}"
  exit 1
else
  echo -e "${GREEN}SUCCESS: All tests passed${NC}"
  exit 0
fi
