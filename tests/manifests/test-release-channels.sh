#!/usr/bin/env bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-02-26

# ============================================================================
# Release Channels Feature Validation
# ============================================================================
# Validates the v7.0.0 release channels feature:
#
# 1. marketplace.json exists and is valid JSON
# 2. Each plugin entry in marketplace.json has a valid semver version
# 3. All plugin entries share the SAME version (unified architecture)
# 4. Version format matches semver (X.Y.Z or X.Y.Z-channel.N)
# 5. The setup skill (src/skills/setup/SKILL.md) mentions release channels
# 6. CI workflow file exists for release channels (prerelease.yml or channel-sync.yml)
#
# Related: feat/v7-unified-plugin, commit 75055b48
# Usage: ./test-release-channels.sh [--verbose]
# Exit codes: 0 = all checks passed, 1 = one or more checks failed
# ============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="${CLAUDE_PROJECT_DIR:-$(cd "$SCRIPT_DIR/../.." && pwd)}"
MARKETPLACE_JSON="$PROJECT_ROOT/.claude-plugin/marketplace.json"
SETUP_SKILL="$PROJECT_ROOT/src/skills/setup/SKILL.md"
WORKFLOWS_DIR="$PROJECT_ROOT/.github/workflows"

VERBOSE="${1:-}"

# ── Colors ──────────────────────────────────────────────────────────────────
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' NC=''
fi

TOTAL_CHECKS=0
PASSED_CHECKS=0
FAILED_CHECKS=0
SKIPPED_CHECKS=0

log_pass()  { echo -e "  ${GREEN}[PASS]${NC} $1"; PASSED_CHECKS=$((PASSED_CHECKS + 1)); TOTAL_CHECKS=$((TOTAL_CHECKS + 1)); }
log_fail()  { echo -e "  ${RED}[FAIL]${NC} $1"; FAILED_CHECKS=$((FAILED_CHECKS + 1)); TOTAL_CHECKS=$((TOTAL_CHECKS + 1)); }
log_skip()  { echo -e "  ${YELLOW}[SKIP]${NC} $1"; SKIPPED_CHECKS=$((SKIPPED_CHECKS + 1)); TOTAL_CHECKS=$((TOTAL_CHECKS + 1)); }
log_info()  { [[ "$VERBOSE" == "--verbose" ]] && echo -e "  ${BLUE}[INFO]${NC} $1" || true; }

echo ""
echo "══════════════════════════════════════════════════════════════════════"
echo "  Manifest Integrity: Release Channels Feature (v7.0.0)"
echo "  Validates marketplace.json versioning and release channel config."
echo "══════════════════════════════════════════════════════════════════════"
echo ""

# ============================================================================
# CHECK 1: marketplace.json exists
# ============================================================================
echo "───────────────────────────────────────────────────────────────"
echo "  Check 1: marketplace.json exists"
echo "───────────────────────────────────────────────────────────────"

if [[ ! -f "$MARKETPLACE_JSON" ]]; then
    log_fail "marketplace.json not found: $MARKETPLACE_JSON"
    echo ""
    echo -e "${RED}FATAL${NC} — marketplace.json is missing. Cannot continue."
    exit 1
fi
log_pass "marketplace.json exists at $MARKETPLACE_JSON"

# ============================================================================
# CHECK 2: marketplace.json is valid JSON
# ============================================================================
echo ""
echo "───────────────────────────────────────────────────────────────"
echo "  Check 2: marketplace.json is valid JSON"
echo "───────────────────────────────────────────────────────────────"

if ! jq empty "$MARKETPLACE_JSON" 2>/dev/null; then
    log_fail "marketplace.json is not valid JSON"
    echo ""
    echo -e "${RED}FATAL${NC} — marketplace.json is malformed. Cannot continue."
    exit 1
fi
log_pass "marketplace.json is valid JSON"

PLUGIN_COUNT=$(jq '.plugins | length' "$MARKETPLACE_JSON")
log_info "marketplace.json has $PLUGIN_COUNT plugin entries"

if [[ "$PLUGIN_COUNT" -eq 0 ]]; then
    log_fail "marketplace.json has no plugin entries — expected at least 1"
    exit 1
fi

# ============================================================================
# CHECK 3: Each plugin entry has a valid semver version
# ============================================================================
echo ""
echo "───────────────────────────────────────────────────────────────"
echo "  Check 3: Every plugin entry has a semver version"
echo "───────────────────────────────────────────────────────────────"

# Semver pattern: X.Y.Z or X.Y.Z-label.N (e.g. 7.0.0, 7.0.0-beta.1, 7.0.0-alpha.3)
SEMVER_REGEX='^[0-9]+\.[0-9]+\.[0-9]+(-[a-z]+\.[0-9]+)?$'

all_versions_valid=true
while IFS= read -r entry; do
    plugin_name=$(echo "$entry" | jq -r '.name')
    plugin_version=$(echo "$entry" | jq -r '.version // empty')

    if [[ -z "$plugin_version" ]]; then
        log_fail "Plugin '$plugin_name' is missing 'version' field"
        all_versions_valid=false
        continue
    fi

    if echo "$plugin_version" | grep -qE "$SEMVER_REGEX"; then
        log_pass "Plugin '$plugin_name' version '$plugin_version' is valid semver"
    else
        log_fail "Plugin '$plugin_name' version '$plugin_version' does not match semver (X.Y.Z or X.Y.Z-channel.N)"
        all_versions_valid=false
    fi
done < <(jq -c '.plugins[]' "$MARKETPLACE_JSON")

# ============================================================================
# CHECK 4: All plugin entries have the SAME version (unified architecture)
# ============================================================================
echo ""
echo "───────────────────────────────────────────────────────────────"
echo "  Check 4: All plugins share the same version (unified)"
echo "───────────────────────────────────────────────────────────────"

unique_versions=$(jq -r '.plugins[].version' "$MARKETPLACE_JSON" | sort -u)
unique_count=$(echo "$unique_versions" | wc -l | tr -d ' ')

if [[ "$unique_count" -eq 1 ]]; then
    unified_version=$(echo "$unique_versions" | tr -d '[:space:]')
    log_pass "All $PLUGIN_COUNT plugins share version '$unified_version'"
else
    log_fail "Plugins have different versions (unified architecture requires one version):"
    jq -r '.plugins[] | "    \(.name): \(.version)"' "$MARKETPLACE_JSON" | while IFS= read -r line; do
        echo -e "  ${RED}$line${NC}"
    done
fi

# ============================================================================
# CHECK 5: Top-level marketplace.json version matches plugin versions
# ============================================================================
echo ""
echo "───────────────────────────────────────────────────────────────"
echo "  Check 5: Top-level version matches plugin versions"
echo "───────────────────────────────────────────────────────────────"

top_level_version=$(jq -r '.version // empty' "$MARKETPLACE_JSON")

if [[ -z "$top_level_version" ]]; then
    log_skip "marketplace.json has no top-level 'version' field (optional)"
else
    # Validate top-level version format
    if echo "$top_level_version" | grep -qE "$SEMVER_REGEX"; then
        log_pass "Top-level version '$top_level_version' is valid semver"
    else
        log_fail "Top-level version '$top_level_version' does not match semver"
    fi

    # Check it matches the unified plugin version (if all plugins agree)
    if [[ "$unique_count" -eq 1 ]]; then
        unified_version=$(echo "$unique_versions" | tr -d '[:space:]')
        if [[ "$top_level_version" == "$unified_version" ]]; then
            log_pass "Top-level version '$top_level_version' matches all plugin versions"
        else
            log_fail "Top-level version '$top_level_version' does not match plugin version '$unified_version'"
        fi
    fi
fi

# ============================================================================
# CHECK 6: Setup skill mentions release channels
# ============================================================================
echo ""
echo "───────────────────────────────────────────────────────────────"
echo "  Check 6: Setup skill mentions release channels (alpha/beta/stable)"
echo "───────────────────────────────────────────────────────────────"

if [[ ! -f "$SETUP_SKILL" ]]; then
    log_skip "src/skills/setup/SKILL.md not found — release channels feature may not be merged yet"
else
    skill_content=$(cat "$SETUP_SKILL")

    # Check for each required channel keyword
    channels_found=0
    for channel in "alpha" "beta" "stable"; do
        if echo "$skill_content" | grep -qi "$channel"; then
            log_info "Setup skill mentions '$channel'"
            channels_found=$((channels_found + 1))
        else
            log_fail "Setup skill does not mention '$channel' channel"
        fi
    done

    # Check for --channel flag
    if echo "$skill_content" | grep -q "\-\-channel"; then
        log_pass "Setup skill documents --channel flag"
    else
        log_fail "Setup skill is missing --channel flag documentation"
    fi

    # Check for channel detection section
    if echo "$skill_content" | grep -qi "channel.*detect\|detect.*channel\|Channel Detection\|release channel"; then
        log_pass "Setup skill has release channel detection section"
    else
        log_fail "Setup skill is missing channel detection content"
    fi

    if [[ "$channels_found" -eq 3 ]]; then
        log_pass "Setup skill mentions all 3 channels (alpha, beta, stable)"
    fi
fi

# ============================================================================
# CHECK 7: CI workflow for release channels exists
# ============================================================================
echo ""
echo "───────────────────────────────────────────────────────────────"
echo "  Check 7: CI workflow file exists for release channels"
echo "───────────────────────────────────────────────────────────────"

# Accept any of the known release channel workflow names
CHANNEL_WORKFLOWS=("prerelease.yml" "channel-sync.yml" "release-channels.yml")
found_workflow=""

for wf in "${CHANNEL_WORKFLOWS[@]}"; do
    if [[ -f "$WORKFLOWS_DIR/$wf" ]]; then
        found_workflow="$wf"
        break
    fi
done

if [[ -n "$found_workflow" ]]; then
    log_pass "Release channel CI workflow found: .github/workflows/$found_workflow"

    # Validate it's non-empty YAML (basic sanity check)
    wf_path="$WORKFLOWS_DIR/$found_workflow"
    wf_line_count=$(wc -l < "$wf_path")
    log_info "$found_workflow has $wf_line_count lines"

    if [[ "$wf_line_count" -lt 5 ]]; then
        log_fail "$found_workflow appears to be empty or malformed (< 5 lines)"
    else
        log_pass "$found_workflow is non-empty ($wf_line_count lines)"
    fi

    # Check for channel-related keywords inside the workflow
    if grep -qiE "alpha|beta|stable|prerelease|channel" "$wf_path" 2>/dev/null; then
        log_pass "$found_workflow contains channel-related keywords"
    else
        log_fail "$found_workflow does not reference alpha/beta/stable/channel"
    fi
else
    log_skip "No release channel CI workflow found in .github/workflows/ — expected one of: ${CHANNEL_WORKFLOWS[*]}"
fi

# ============================================================================
# Summary
# ============================================================================
echo ""
echo "══════════════════════════════════════════════════════════════════════"
echo "  RELEASE CHANNELS SUMMARY"
echo "══════════════════════════════════════════════════════════════════════"
echo -e "  Total checks:    ${BLUE}$TOTAL_CHECKS${NC}"
echo -e "  Passed:          ${GREEN}$PASSED_CHECKS${NC}"
echo -e "  Skipped:         ${YELLOW}$SKIPPED_CHECKS${NC}"
echo -e "  Failed:          ${RED}$FAILED_CHECKS${NC}"
echo ""

if [[ "$FAILED_CHECKS" -gt 0 ]]; then
    echo -e "${RED}FAILED${NC} — $FAILED_CHECKS release channel check(s) failed."
    echo "  Fix the issues above and re-run to validate the release channels feature."
    exit 1
else
    if [[ "$SKIPPED_CHECKS" -gt 0 ]]; then
        echo -e "${YELLOW}PASSED with skips${NC} — $SKIPPED_CHECKS check(s) skipped (feature not yet merged)."
    else
        echo -e "${GREEN}PASSED${NC} — Release channels feature is correctly configured."
    fi
    exit 0
fi
