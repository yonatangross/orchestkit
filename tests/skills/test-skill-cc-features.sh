#!/usr/bin/env bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-03-01

# ============================================================================
# Skill CC Feature Validation Test
# ============================================================================
# Validates CC feature usage in skills: AUQ markdown previews, multiSelect,
# EnterPlanMode integration, and argument-hint + $ARGUMENTS consistency.
# ============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="${CLAUDE_PROJECT_DIR:-$(cd "$SCRIPT_DIR/../.." && pwd)}"
SKILLS_DIR="$PROJECT_ROOT/src/skills"

TOTAL_PASSED=0
TOTAL_FAILED=0
TOTAL_WARNINGS=0

# Colors
if [[ -t 1 ]]; then
    RED='\033[0;31m' GREEN='\033[0;32m' YELLOW='\033[1;33m'
    BLUE='\033[0;34m' CYAN='\033[0;36m' NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' CYAN='' NC=''
fi

pass() { echo -e "  ${GREEN}PASS${NC} $1"; TOTAL_PASSED=$((TOTAL_PASSED + 1)); }
fail() { echo -e "  ${RED}FAIL${NC} $1"; TOTAL_FAILED=$((TOTAL_FAILED + 1)); }
warn() { echo -e "  ${YELLOW}WARN${NC} $1"; TOTAL_WARNINGS=$((TOTAL_WARNINGS + 1)); }

echo -e "${BLUE}Skill CC Feature Validation${NC}"
echo "========================================"

# --- Test 1: AUQ markdown previews have matching option count ---
echo -e "\n${CYAN}Test 1: AUQ Markdown Preview Consistency${NC}"

auq_skills_with_markdown=0
auq_skills_without=0

for skill_dir in "$SKILLS_DIR"/*/; do
    skill_name="$(basename "$skill_dir")"
    skill_file="$skill_dir/SKILL.md"
    [[ -f "$skill_file" ]] || continue

    # Check if skill has AUQ options blocks
    has_options=$(grep -c '"options"' "$skill_file" 2>/dev/null || true)
    has_markdown=$(grep -c '"markdown"' "$skill_file" 2>/dev/null || true)

    if [[ "$has_options" -gt 0 && "$has_markdown" -gt 0 ]]; then
        auq_skills_with_markdown=$((auq_skills_with_markdown + 1))
    elif [[ "$has_options" -gt 0 && "$has_markdown" -eq 0 ]]; then
        # Check rules/ subdirectory too
        _rules_matches=$(grep -rl '"markdown"' "$skill_dir/rules/" 2>/dev/null || true)
        rules_markdown=0
        if [[ -n "$_rules_matches" ]]; then
            rules_markdown=$(echo "$_rules_matches" | wc -l | tr -d ' ')
        fi
        if [[ "$rules_markdown" -gt 0 ]]; then
            auq_skills_with_markdown=$((auq_skills_with_markdown + 1))
        else
            # Only warn for user-invocable skills
            is_invocable=$(grep -c 'user-invocable: true' "$skill_file" || true)
            if [[ "$is_invocable" -gt 0 ]]; then
                warn "$skill_name: has AUQ options but no markdown previews"
            fi
            auq_skills_without=$((auq_skills_without + 1))
        fi
    fi
done

if [[ "$auq_skills_with_markdown" -ge 10 ]]; then
    pass "AUQ markdown previews: $auq_skills_with_markdown skills have previews"
else
    fail "AUQ markdown previews: only $auq_skills_with_markdown skills (expected >=10)"
fi

# --- Test 2: multiSelect usage validation ---
echo -e "\n${CYAN}Test 2: multiSelect Validation${NC}"

multi_true=0
multi_false=0

for skill_file in "$SKILLS_DIR"/*/SKILL.md; do
    [[ -f "$skill_file" ]] || continue
    mt=$(grep -c '"multiSelect".*true' "$skill_file" 2>/dev/null || true)
    mf=$(grep -c '"multiSelect".*false' "$skill_file" 2>/dev/null || true)
    multi_true=$((multi_true + mt))
    multi_false=$((multi_false + mf))
done

total_multi=$((multi_true + multi_false))
if [[ "$total_multi" -gt 0 ]]; then
    pass "multiSelect usage: $multi_true true, $multi_false false ($total_multi total AUQ blocks)"
else
    fail "No multiSelect fields found in any skill"
fi

if [[ "$multi_true" -ge 2 ]]; then
    pass "multiSelect: true used in $multi_true AUQ blocks (combinable options)"
else
    warn "multiSelect: true only in $multi_true blocks (consider more combinable options)"
fi

# --- Test 3: EnterPlanMode integration ---
echo -e "\n${CYAN}Test 3: EnterPlanMode Integration${NC}"

planmode_skills=0
for skill_dir in "$SKILLS_DIR"/*/; do
    skill_name="$(basename "$skill_dir")"
    # Search SKILL.md and rules/
    _matches=$(grep -rl "EnterPlanMode\|Plan first" "$skill_dir" 2>/dev/null || true)
    found=0
    if [[ -n "$_matches" ]]; then
        found=$(echo "$_matches" | wc -l | tr -d ' ')
    fi
    if [[ "$found" -gt 0 ]]; then
        planmode_skills=$((planmode_skills + 1))
    fi
done

if [[ "$planmode_skills" -ge 3 ]]; then
    pass "EnterPlanMode: integrated in $planmode_skills skills"
else
    fail "EnterPlanMode: only in $planmode_skills skills (expected >=3)"
fi

# --- Test 4: argument-hint on user-invocable skills ---
echo -e "\n${CYAN}Test 4: argument-hint Coverage${NC}"

invocable_count=0
hint_count=0
missing_hints=""

for skill_file in "$SKILLS_DIR"/*/SKILL.md; do
    [[ -f "$skill_file" ]] || continue
    skill_name="$(basename "$(dirname "$skill_file")")"

    is_invocable=$(grep -c 'user-invocable: true' "$skill_file" || true)
    if [[ "$is_invocable" -gt 0 ]]; then
        invocable_count=$((invocable_count + 1))
        has_hint=$(grep -c 'argument-hint:' "$skill_file" || true)
        if [[ "$has_hint" -gt 0 ]]; then
            hint_count=$((hint_count + 1))
        else
            missing_hints="$missing_hints $skill_name"
        fi
    fi
done

if [[ "$hint_count" -eq "$invocable_count" ]]; then
    pass "argument-hint: all $invocable_count user-invocable skills have hints"
else
    fail "argument-hint: $hint_count/$invocable_count have hints. Missing:$missing_hints"
fi

# --- Test 5: disable-model-invocation balance ---
echo -e "\n${CYAN}Test 5: Skill Listing Balance${NC}"

listed=0
hidden=0
for skill_file in "$SKILLS_DIR"/*/SKILL.md; do
    [[ -f "$skill_file" ]] || continue
    disabled=$(grep -c 'disable-model-invocation: true' "$skill_file" || true)
    if [[ "$disabled" -gt 0 ]]; then
        hidden=$((hidden + 1))
    else
        listed=$((listed + 1))
    fi
done

total=$((listed + hidden))
pass "Skill listing: $listed listed, $hidden hidden ($total total)"

if [[ "$listed" -le 20 ]]; then
    pass "Listed skills within budget ($listed <= 20)"
else
    warn "Listed skills may exceed context budget ($listed > 20)"
fi

# --- Summary ---
echo ""
echo "========================================"
echo -e "  Total: $((TOTAL_PASSED + TOTAL_FAILED))  |  Passed: ${GREEN}${TOTAL_PASSED}${NC}  |  Failed: ${RED}${TOTAL_FAILED}${NC}  |  Warnings: ${YELLOW}${TOTAL_WARNINGS}${NC}"
echo "========================================"

if [[ "$TOTAL_FAILED" -gt 0 ]]; then
    exit 1
fi
