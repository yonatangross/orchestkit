#!/usr/bin/env bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-02-14

# ============================================================================
# Rule File Validation Tests
# ============================================================================
# Validates all skill rule files (rules/*.md) for structure compliance.
#
# Tests:
# 1. Every rule file has YAML frontmatter with required fields:
#    title, impact, impactDescription, tags
# 2. Impact is one of: CRITICAL, HIGH, MEDIUM, LOW
# 3. WARN if no Incorrect/Correct code block pairs
# 4. _sections.md exists when rules/ has rule files
# 5. Summary report: total rules, pass, fail, warnings
#
# Excludes: _template.md, _sections.md
#
# Usage: ./test-rule-validation.sh [--verbose]
# Exit codes: 0 = all pass, 1 = failures found
# ============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="${CLAUDE_PROJECT_DIR:-$(cd "$SCRIPT_DIR/../../.." && pwd)}"
SKILLS_DIR="$PROJECT_ROOT/src/skills"

VERBOSE="${1:-}"

# Counters
PASS_COUNT=0
FAIL_COUNT=0
WARN_COUNT=0
TOTAL_RULES=0
TOTAL_SKILLS_WITH_RULES=0

# Colors (only if stdout is a terminal)
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    CYAN='\033[0;36m'
    NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' CYAN='' NC=''
fi

# Test output functions
pass() {
    echo -e "  ${GREEN}PASS${NC} $1"
    PASS_COUNT=$((PASS_COUNT + 1))
}

fail() {
    echo -e "  ${RED}FAIL${NC} $1"
    FAIL_COUNT=$((FAIL_COUNT + 1))
}

warn() {
    echo -e "  ${YELLOW}WARN${NC} $1"
    WARN_COUNT=$((WARN_COUNT + 1))
}

info() {
    if [[ "$VERBOSE" == "--verbose" ]]; then
        echo -e "  ${BLUE}INFO${NC} $1"
    fi
}

# ============================================================================
# YAML Frontmatter Parsing
# ============================================================================
extract_frontmatter() {
    local file="$1"
    sed -n '/^---$/,/^---$/p' "$file" 2>/dev/null | sed '1d;$d'
}

get_frontmatter_field() {
    local frontmatter="$1"
    local field="$2"
    local matched
    matched=$(echo "$frontmatter" | grep -E "^${field}:" 2>/dev/null || true)
    if [[ -n "$matched" ]]; then
        echo "$matched" | sed "s/^${field}:[[:space:]]*//" | sed 's/^["'"'"']//' | sed 's/["'"'"']$//'
    fi
}

# ============================================================================
# Header
# ============================================================================
echo "============================================================================"
echo "  Rule File Validation Tests"
echo "============================================================================"
echo ""
echo "Skills directory: $SKILLS_DIR"
echo ""

# ============================================================================
# Collect all rule files
# ============================================================================
declare -a ALL_RULE_FILES=()
declare -a SKILLS_WITH_RULES=()

for skill_dir in "$SKILLS_DIR"/*/; do
    if [[ ! -d "$skill_dir" ]]; then
        continue
    fi

    rules_dir="$skill_dir/rules"
    if [[ ! -d "$rules_dir" ]]; then
        continue
    fi

    skill_name=$(basename "$skill_dir")
    has_rules=false

    for rule_file in "$rules_dir"/*.md; do
        if [[ ! -f "$rule_file" ]]; then
            continue
        fi

        rule_basename=$(basename "$rule_file")

        # Skip template and sections files
        if [[ "$rule_basename" == "_template.md" || "$rule_basename" == "_sections.md" ]]; then
            continue
        fi

        ALL_RULE_FILES+=("$rule_file")
        TOTAL_RULES=$((TOTAL_RULES + 1))
        has_rules=true
    done

    if [[ "$has_rules" == "true" ]]; then
        SKILLS_WITH_RULES+=("$skill_name")
        TOTAL_SKILLS_WITH_RULES=$((TOTAL_SKILLS_WITH_RULES + 1))
    fi
done

echo "Found $TOTAL_RULES rule files across $TOTAL_SKILLS_WITH_RULES skills"
echo ""

# ============================================================================
# Test 1: Required frontmatter fields (title, impact, impactDescription, tags)
# ============================================================================
echo -e "${CYAN}Test 1: Required Frontmatter Fields${NC}"
echo "────────────────────────────────────────────────────────────────────────────"

missing_frontmatter_count=0
missing_title_count=0
missing_impact_count=0
missing_impact_desc_count=0
missing_tags_count=0

for rule_file in "${ALL_RULE_FILES[@]}"; do
    skill_name=$(basename "$(dirname "$(dirname "$rule_file")")")
    rule_name=$(basename "$rule_file")
    display="$skill_name/rules/$rule_name"

    # Check frontmatter exists
    first_line=$(sed -n '1p' "$rule_file" 2>/dev/null || echo "")
    if [[ "$first_line" != "---" ]]; then
        fail "$display: Missing YAML frontmatter"
        missing_frontmatter_count=$((missing_frontmatter_count + 1))
        continue
    fi

    frontmatter=$(extract_frontmatter "$rule_file")

    if [[ -z "$frontmatter" ]]; then
        fail "$display: Empty or malformed frontmatter"
        missing_frontmatter_count=$((missing_frontmatter_count + 1))
        continue
    fi

    has_error=false

    # Check title
    title=$(get_frontmatter_field "$frontmatter" "title")
    if [[ -z "$title" ]]; then
        fail "$display: Missing 'title' field"
        missing_title_count=$((missing_title_count + 1))
        has_error=true
    fi

    # Check impact
    impact=$(get_frontmatter_field "$frontmatter" "impact")
    if [[ -z "$impact" ]]; then
        fail "$display: Missing 'impact' field"
        missing_impact_count=$((missing_impact_count + 1))
        has_error=true
    fi

    # Check impactDescription
    impact_desc=$(get_frontmatter_field "$frontmatter" "impactDescription")
    if [[ -z "$impact_desc" ]]; then
        fail "$display: Missing 'impactDescription' field"
        missing_impact_desc_count=$((missing_impact_desc_count + 1))
        has_error=true
    fi

    # Check tags
    tags=$(get_frontmatter_field "$frontmatter" "tags")
    if [[ -z "$tags" ]]; then
        fail "$display: Missing 'tags' field"
        missing_tags_count=$((missing_tags_count + 1))
        has_error=true
    fi

    if [[ "$has_error" == "false" ]]; then
        info "$display: All required fields present"
    fi
done

total_missing=$((missing_frontmatter_count + missing_title_count + missing_impact_count + missing_impact_desc_count + missing_tags_count))
if [[ $total_missing -eq 0 ]]; then
    pass "All $TOTAL_RULES rule files have required frontmatter fields"
else
    echo ""
    echo "  Breakdown:"
    if [[ $missing_frontmatter_count -gt 0 ]]; then echo "    Missing frontmatter: $missing_frontmatter_count"; fi
    if [[ $missing_title_count -gt 0 ]]; then echo "    Missing title: $missing_title_count"; fi
    if [[ $missing_impact_count -gt 0 ]]; then echo "    Missing impact: $missing_impact_count"; fi
    if [[ $missing_impact_desc_count -gt 0 ]]; then echo "    Missing impactDescription: $missing_impact_desc_count"; fi
    if [[ $missing_tags_count -gt 0 ]]; then echo "    Missing tags: $missing_tags_count"; fi
fi
echo ""

# ============================================================================
# Test 2: Impact values are valid (CRITICAL, HIGH, MEDIUM, LOW)
# ============================================================================
echo -e "${CYAN}Test 2: Impact Value Validation${NC}"
echo "────────────────────────────────────────────────────────────────────────────"

invalid_impact_count=0

for rule_file in "${ALL_RULE_FILES[@]}"; do
    skill_name=$(basename "$(dirname "$(dirname "$rule_file")")")
    rule_name=$(basename "$rule_file")
    display="$skill_name/rules/$rule_name"

    first_line=$(sed -n '1p' "$rule_file" 2>/dev/null || echo "")
    if [[ "$first_line" != "---" ]]; then
        continue  # Already reported in Test 1
    fi

    frontmatter=$(extract_frontmatter "$rule_file")
    impact=$(get_frontmatter_field "$frontmatter" "impact")

    if [[ -z "$impact" ]]; then
        continue  # Already reported in Test 1
    fi

    case "$impact" in
        CRITICAL|HIGH|MEDIUM|LOW)
            info "$display: Valid impact ($impact)"
            ;;
        *)
            fail "$display: Invalid impact '$impact' (expected: CRITICAL, HIGH, MEDIUM, LOW)"
            invalid_impact_count=$((invalid_impact_count + 1))
            ;;
    esac
done

if [[ $invalid_impact_count -eq 0 ]]; then
    pass "All rule files have valid impact values"
fi
echo ""

# ============================================================================
# Test 3: WARN if no Incorrect/Correct code block pairs
# ============================================================================
echo -e "${CYAN}Test 3: Code Example Pairs (Incorrect/Correct)${NC}"
echo "────────────────────────────────────────────────────────────────────────────"

rules_with_examples=0
rules_without_examples=0

for rule_file in "${ALL_RULE_FILES[@]}"; do
    skill_name=$(basename "$(dirname "$(dirname "$rule_file")")")
    rule_name=$(basename "$rule_file")
    display="$skill_name/rules/$rule_name"

    content=$(cat "$rule_file" 2>/dev/null || echo "")

    has_incorrect=false
    has_correct=false

    if [[ "$content" == *"**Incorrect"* || "$content" == *"### Incorrect"* || "$content" == *"## Incorrect"* ]]; then
        has_incorrect=true
    fi

    if [[ "$content" == *"**Correct"* || "$content" == *"### Correct"* || "$content" == *"## Correct"* ]]; then
        has_correct=true
    fi

    if [[ "$has_incorrect" == "true" && "$has_correct" == "true" ]]; then
        rules_with_examples=$((rules_with_examples + 1))
        info "$display: Has Incorrect/Correct examples"
    else
        rules_without_examples=$((rules_without_examples + 1))
        warn "$display: Missing Incorrect/Correct code example pair"
    fi
done

echo ""
echo "  Rules with example pairs:    $rules_with_examples / $TOTAL_RULES"
echo "  Rules without example pairs: $rules_without_examples / $TOTAL_RULES"
echo ""

# ============================================================================
# Test 4: _sections.md exists when rules/ has rule files
# ============================================================================
echo -e "${CYAN}Test 4: _sections.md Presence${NC}"
echo "────────────────────────────────────────────────────────────────────────────"

missing_sections_count=0

for skill_name in "${SKILLS_WITH_RULES[@]}"; do
    rules_dir="$SKILLS_DIR/$skill_name/rules"
    sections_file="$rules_dir/_sections.md"

    if [[ -f "$sections_file" ]]; then
        info "$skill_name: _sections.md exists"
    else
        fail "$skill_name: rules/ has rule files but missing _sections.md"
        missing_sections_count=$((missing_sections_count + 1))
    fi
done

if [[ $missing_sections_count -eq 0 ]]; then
    pass "All $TOTAL_SKILLS_WITH_RULES skills with rules have _sections.md"
fi
echo ""

# ============================================================================
# Summary
# ============================================================================
echo "============================================================================"
echo "  Rule Validation Summary"
echo "============================================================================"
echo ""
echo -e "  Total rules:     $TOTAL_RULES"
echo -e "  Skills checked:  $TOTAL_SKILLS_WITH_RULES"
echo -e "  ${GREEN}Passed:          $PASS_COUNT${NC}"
echo -e "  ${RED}Failed:          $FAIL_COUNT${NC}"
echo -e "  ${YELLOW}Warnings:        $WARN_COUNT${NC}"
echo ""
echo "============================================================================"

# Exit with appropriate code
if [[ $FAIL_COUNT -gt 0 ]]; then
    echo -e "${RED}FAILED: $FAIL_COUNT test(s) failed${NC}"
    exit 1
else
    echo -e "${GREEN}SUCCESS: All critical tests passed${NC}"
    if [[ $WARN_COUNT -gt 0 ]]; then
        echo -e "${YELLOW}Note: $WARN_COUNT warning(s) should be reviewed${NC}"
    fi
    exit 0
fi
