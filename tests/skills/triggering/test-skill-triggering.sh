#!/usr/bin/env bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-02-14

# test-skill-triggering.sh - Keyword overlap scoring for skill triggering
# Validates that SKILL.md description/tags contain keywords from should_trigger queries
# and warns if should_not_trigger keywords overlap with the skill's description.
#
# Extends the pattern from test-skill-discovery.sh.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)"
TRIGGER_FILE="$SCRIPT_DIR/trigger-cases.yaml"

PASSED=0
FAILED=0
WARNINGS=0
CHECKED=0

echo "=========================================="
echo "Testing Skill Triggering (Keyword Overlap)"
echo "=========================================="
echo

if [[ ! -f "$TRIGGER_FILE" ]]; then
    echo "FAIL: trigger-cases.yaml not found at $TRIGGER_FILE"
    exit 1
fi

# Extract skill names from YAML (lines matching "^  <name>:" under "skills:")
skill_names=()
in_skills=0
while IFS= read -r line; do
    if [[ "$line" == "skills:" ]]; then
        in_skills=1
        continue
    fi
    if [[ $in_skills -eq 1 ]]; then
        # Match lines like "  commit:" (exactly 2 spaces, word chars, colon)
        if [[ "$line" =~ ^[[:space:]]{2}([a-zA-Z0-9_-]+):$ ]]; then
            skill_names+=("${BASH_REMATCH[1]}")
        fi
    fi
done < "$TRIGGER_FILE"

if [[ ${#skill_names[@]} -eq 0 ]]; then
    echo "FAIL: No skills found in trigger-cases.yaml"
    exit 1
fi

echo "Found ${#skill_names[@]} skills in trigger-cases.yaml"
echo

# For each skill, extract description and tags from SKILL.md, then check overlap
for skill_name in "${skill_names[@]}"; do
    CHECKED=$((CHECKED + 1))

    skill_file="$PROJECT_ROOT/src/skills/$skill_name/SKILL.md"
    if [[ ! -f "$skill_file" ]]; then
        echo "FAIL: $skill_name - SKILL.md not found at $skill_file"
        FAILED=$((FAILED + 1))
        continue
    fi

    # Extract description from frontmatter
    description=$(awk '
        /^---$/ { in_fm = !in_fm; next }
        in_fm && /^description:/ {
            sub(/^description: */, "")
            gsub(/^["'"'"']|["'"'"']$/, "")
            print
            exit
        }
    ' "$skill_file")

    # Extract tags from frontmatter
    tags=$(awk '
        /^---$/ { in_fm = !in_fm; next }
        in_fm && /^tags:/ {
            sub(/^tags: */, "")
            gsub(/[\[\]]/, "")
            print
            exit
        }
    ' "$skill_file")

    desc_lower=$(echo "$description $tags" | tr '[:upper:]' '[:lower:]')

    # Extract should_trigger queries for this skill from YAML
    # Parse the YAML: find skill section, then should_trigger entries
    in_skill=0
    in_should_trigger=0
    in_should_not_trigger=0
    should_trigger_queries=()
    should_not_trigger_queries=()

    while IFS= read -r line; do
        # Detect our skill section
        if [[ "$line" =~ ^[[:space:]]{2}${skill_name}:$ ]]; then
            in_skill=1
            in_should_trigger=0
            in_should_not_trigger=0
            continue
        fi
        # Detect next skill section (exit current)
        if [[ $in_skill -eq 1 ]] && [[ "$line" =~ ^[[:space:]]{2}[a-zA-Z0-9_-]+:$ ]] && ! [[ "$line" =~ should_ ]]; then
            break
        fi
        if [[ $in_skill -eq 1 ]]; then
            if [[ "$line" =~ ^[[:space:]]+should_trigger: ]]; then
                in_should_trigger=1
                in_should_not_trigger=0
                continue
            fi
            if [[ "$line" =~ ^[[:space:]]+should_not_trigger: ]]; then
                in_should_trigger=0
                in_should_not_trigger=1
                continue
            fi
            # Collect list items (lines starting with "      - ")
            if [[ "$line" =~ ^[[:space:]]+-[[:space:]]+\"(.+)\"$ ]]; then
                query="${BASH_REMATCH[1]}"
                if [[ $in_should_trigger -eq 1 ]]; then
                    should_trigger_queries+=("$query")
                elif [[ $in_should_not_trigger -eq 1 ]]; then
                    should_not_trigger_queries+=("$query")
                fi
            fi
        fi
    done < "$TRIGGER_FILE"

    # Check should_trigger: at least one keyword from each query should appear in description/tags
    trigger_matches=0
    trigger_total=${#should_trigger_queries[@]}

    for query in "${should_trigger_queries[@]}"; do
        query_lower=$(echo "$query" | tr '[:upper:]' '[:lower:]')
        # Extract meaningful words (4+ chars) from the query
        words=()
        for word in $query_lower; do
            # Skip short words and stop words
            if [[ ${#word} -ge 4 ]] && \
               [[ "$word" != "this" ]] && \
               [[ "$word" != "with" ]] && \
               [[ "$word" != "that" ]] && \
               [[ "$word" != "from" ]] && \
               [[ "$word" != "have" ]] && \
               [[ "$word" != "should" ]] && \
               [[ "$word" != "these" ]] && \
               [[ "$word" != "those" ]] && \
               [[ "$word" != "what" ]] && \
               [[ "$word" != "does" ]] && \
               [[ "$word" != "show" ]] && \
               [[ "$word" != "help" ]] && \
               [[ "$word" != "lets" ]]; then
                words+=("$word")
            fi
        done

        # Check if any keyword from this query appears in description/tags
        found=0
        for word in "${words[@]}"; do
            if [[ "$desc_lower" == *"$word"* ]]; then
                found=1
                break
            fi
        done

        if [[ $found -eq 1 ]]; then
            trigger_matches=$((trigger_matches + 1))
        fi
    done

    # Score: percentage of should_trigger queries with keyword match
    if [[ $trigger_total -gt 0 ]]; then
        score=$((trigger_matches * 100 / trigger_total))
    else
        score=0
    fi

    # Check should_not_trigger: warn if keywords overlap with description
    overlap_warnings=0
    for query in "${should_not_trigger_queries[@]}"; do
        query_lower=$(echo "$query" | tr '[:upper:]' '[:lower:]')
        # Extract meaningful words (5+ chars) from the query - stricter for negative cases
        words=()
        for word in $query_lower; do
            if [[ ${#word} -ge 5 ]] && \
               [[ "$word" != "these" ]] && \
               [[ "$word" != "those" ]] && \
               [[ "$word" != "should" ]]; then
                words+=("$word")
            fi
        done

        # Count how many unique keywords from this negative query match description
        match_count=0
        for word in "${words[@]}"; do
            if [[ "$desc_lower" == *"$word"* ]]; then
                match_count=$((match_count + 1))
            fi
        done

        # Warn if more than half the keywords match (strong overlap signal)
        total_words=${#words[@]}
        if [[ $total_words -gt 0 ]] && [[ $match_count -gt 0 ]]; then
            threshold=$(( (total_words + 1) / 2 ))
            if [[ $match_count -ge $threshold ]]; then
                overlap_warnings=$((overlap_warnings + 1))
            fi
        fi
    done

    # Report results
    if [[ $score -lt 40 ]]; then
        echo "FAIL: $skill_name - Trigger keyword score: ${score}% (${trigger_matches}/${trigger_total} queries matched)"
        echo "      Description keywords may not cover expected trigger phrases"
        FAILED=$((FAILED + 1))
    elif [[ $score -lt 70 ]]; then
        echo "WARN: $skill_name - Trigger keyword score: ${score}% (${trigger_matches}/${trigger_total} queries matched)"
        WARNINGS=$((WARNINGS + 1))
    else
        echo "PASS: $skill_name - Trigger keyword score: ${score}% (${trigger_matches}/${trigger_total})"
        PASSED=$((PASSED + 1))
    fi

    if [[ $overlap_warnings -gt 0 ]]; then
        echo "      WARN: ${overlap_warnings} should_not_trigger queries have keyword overlap with description"
        WARNINGS=$((WARNINGS + 1))
    fi
done

echo
echo "=========================================="
echo "Summary"
echo "=========================================="
echo "Checked:  $CHECKED skills"
echo "Passed:   $PASSED"
echo "Failed:   $FAILED"
echo "Warnings: $WARNINGS"

if [[ $FAILED -gt 0 ]]; then
    echo
    echo "ACTION REQUIRED: Update skill descriptions to include trigger keywords."
    exit 1
fi

echo
echo "Triggering keyword overlap checks complete."
exit 0
