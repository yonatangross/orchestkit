#!/usr/bin/env bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-02-26

# =============================================================================
# Test: Plugin Alias Identity (v7 Unified Architecture)
# =============================================================================
# Verifies that orkl and ork-creative are exact aliases of ork — same content,
# same skill count, same agent count, same hooks, same settings.json, same
# version. The ONLY permitted difference is name and description in plugin.json.
#
# This test encodes the v7 contract: one plugin, three install names.
# =============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="${CLAUDE_PROJECT_DIR:-$(cd "$SCRIPT_DIR/../.." && pwd)}"

# Colors (disabled when not a TTY)
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' NC=''
fi

PASSED=0
FAILED=0
FAILED_CHECKS=()

pass() {
    local msg="$1"
    PASSED=$((PASSED + 1))
    echo -e "  ${GREEN}PASS${NC}: $msg"
}

fail() {
    local msg="$1"
    FAILED=$((FAILED + 1))
    FAILED_CHECKS+=("$msg")
    echo -e "  ${RED}FAIL${NC}: $msg"
}

warn() {
    local msg="$1"
    echo -e "  ${YELLOW}WARN${NC}: $msg"
}

ORK="$PROJECT_ROOT/plugins/ork"
ORKL="$PROJECT_ROOT/plugins/orkl"
ORC="$PROJECT_ROOT/plugins/ork-creative"

echo "=========================================="
echo "Plugin Alias Identity (v7 Unified)"
echo "=========================================="
echo ""

# =============================================================================
# Test 1: All three plugin directories exist
# =============================================================================
echo -e "${BLUE}1. Plugin directories exist${NC}"
echo "──────────────────────────────────────────"

for dir_label in "plugins/ork:$ORK" "plugins/orkl:$ORKL" "plugins/ork-creative:$ORC"; do
    label="${dir_label%%:*}"
    dir="${dir_label##*:}"
    if [[ -d "$dir" ]]; then
        pass "$label exists"
    else
        fail "$label is MISSING — run 'npm run build'"
    fi
done
echo ""

# Bail early if any plugin dir is absent — remaining tests would all error.
if [[ "$FAILED" -gt 0 ]]; then
    echo -e "${RED}FAILED${NC}: Plugin directories missing — cannot continue."
    exit 1
fi

# =============================================================================
# Test 2: Skill count is identical across all three plugins
# =============================================================================
echo -e "${BLUE}2. Skill count identical across all three plugins${NC}"
echo "──────────────────────────────────────────"

ork_skills=$(ls -d "$ORK/skills"/*/  2>/dev/null | wc -l | tr -d ' ')
orkl_skills=$(ls -d "$ORKL/skills"/*/ 2>/dev/null | wc -l | tr -d ' ')
orc_skills=$(ls -d "$ORC/skills"/*/ 2>/dev/null | wc -l | tr -d ' ')

echo "  ork:          $ork_skills skills"
echo "  orkl:         $orkl_skills skills"
echo "  ork-creative: $orc_skills skills"

if [[ "$ork_skills" -eq "$orkl_skills" && "$ork_skills" -eq "$orc_skills" ]]; then
    pass "All three have $ork_skills skills"
else
    fail "Skill counts differ — ork=$ork_skills, orkl=$orkl_skills, ork-creative=$orc_skills (expected identical)"
fi
echo ""

# =============================================================================
# Test 3: Agent count is identical across all three plugins
# =============================================================================
echo -e "${BLUE}3. Agent count identical across all three plugins${NC}"
echo "──────────────────────────────────────────"

ork_agents=$(ls "$ORK/agents/"*.md  2>/dev/null | wc -l | tr -d ' ')
orkl_agents=$(ls "$ORKL/agents/"*.md 2>/dev/null | wc -l | tr -d ' ')
orc_agents=$(ls "$ORC/agents/"*.md 2>/dev/null | wc -l | tr -d ' ')

echo "  ork:          $ork_agents agents"
echo "  orkl:         $orkl_agents agents"
echo "  ork-creative: $orc_agents agents"

if [[ "$ork_agents" -eq "$orkl_agents" && "$ork_agents" -eq "$orc_agents" ]]; then
    pass "All three have $ork_agents agents"
else
    fail "Agent counts differ — ork=$ork_agents, orkl=$orkl_agents, ork-creative=$orc_agents (expected identical)"
fi
echo ""

# =============================================================================
# Test 4: Hooks dist files are identical across all three plugins
# =============================================================================
echo -e "${BLUE}4. Hooks dist files identical across all three plugins${NC}"
echo "──────────────────────────────────────────"

HOOKS_DIST_CANDIDATES=(
    "hooks/dist"
    "dist"
)

# Locate the hooks dist directory (path can vary between builds)
ork_hooks_dist=""
for candidate in "${HOOKS_DIST_CANDIDATES[@]}"; do
    if [[ -d "$ORK/$candidate" ]]; then
        ork_hooks_dist="$ORK/$candidate"
        break
    fi
done

# hooks.json is always present and encodes the full hook definition list
ork_hooks_json="$ORK/hooks/hooks.json"
orkl_hooks_json="$ORKL/hooks/hooks.json"
orc_hooks_json="$ORC/hooks/hooks.json"

# Compare hooks.json content (primary check — always present)
if [[ -f "$ork_hooks_json" && -f "$orkl_hooks_json" && -f "$orc_hooks_json" ]]; then
    if diff -q "$ork_hooks_json" "$orkl_hooks_json" >/dev/null 2>&1 && \
       diff -q "$ork_hooks_json" "$orc_hooks_json" >/dev/null 2>&1; then
        pass "hooks/hooks.json is identical across all three plugins"
    else
        fail "hooks/hooks.json differs between plugins (orkl or ork-creative diverged from ork)"
        if ! diff -q "$ork_hooks_json" "$orkl_hooks_json" >/dev/null 2>&1; then
            echo "       ork vs orkl diff:"
            diff "$ork_hooks_json" "$orkl_hooks_json" | head -10 | sed 's/^/         /'
        fi
        if ! diff -q "$ork_hooks_json" "$orc_hooks_json" >/dev/null 2>&1; then
            echo "       ork vs ork-creative diff:"
            diff "$ork_hooks_json" "$orc_hooks_json" | head -10 | sed 's/^/         /'
        fi
    fi
else
    warn "hooks/hooks.json not found in one or more plugins — skipping hooks.json check"
fi

# Compare compiled dist/ if it exists
if [[ -n "$ork_hooks_dist" ]]; then
    orkl_hooks_dist="${ork_hooks_dist/$ORK/$ORKL}"
    orc_hooks_dist="${ork_hooks_dist/$ORK/$ORC}"

    if [[ -d "$orkl_hooks_dist" && -d "$orc_hooks_dist" ]]; then
        diff_orkl=$(diff -rq "$ork_hooks_dist" "$orkl_hooks_dist" 2>&1 || true)
        diff_orc=$(diff -rq "$ork_hooks_dist" "$orc_hooks_dist" 2>&1 || true)

        if [[ -z "$diff_orkl" && -z "$diff_orc" ]]; then
            pass "hooks dist/ is byte-for-byte identical across all three plugins"
        else
            fail "hooks dist/ differs between plugins"
            [[ -n "$diff_orkl" ]] && echo "       ork vs orkl:" && echo "$diff_orkl" | head -5 | sed 's/^/         /'
            [[ -n "$diff_orc"  ]] && echo "       ork vs ork-creative:" && echo "$diff_orc" | head -5 | sed 's/^/         /'
        fi
    else
        warn "hooks dist/ not compiled yet — skipping dist check (run 'cd src/hooks && npm run build')"
    fi
else
    warn "No hooks dist/ directory found in ork — skipping dist diff (hooks not compiled)"
fi
echo ""

# =============================================================================
# Test 5: settings.json is identical across all three plugins
# =============================================================================
echo -e "${BLUE}5. settings.json identical across all three plugins${NC}"
echo "──────────────────────────────────────────"

ork_settings="$ORK/settings.json"
orkl_settings="$ORKL/settings.json"
orc_settings="$ORC/settings.json"

if [[ ! -f "$ork_settings" ]]; then
    fail "ork/settings.json is MISSING"
elif [[ ! -f "$orkl_settings" ]]; then
    fail "orkl/settings.json is MISSING"
elif [[ ! -f "$orc_settings" ]]; then
    fail "ork-creative/settings.json is MISSING"
else
    if diff -q "$ork_settings" "$orkl_settings" >/dev/null 2>&1 && \
       diff -q "$ork_settings" "$orc_settings" >/dev/null 2>&1; then
        pass "settings.json is identical across all three plugins"
    else
        fail "settings.json differs between plugins"
        if ! diff -q "$ork_settings" "$orkl_settings" >/dev/null 2>&1; then
            echo "       ork vs orkl:"
            diff "$ork_settings" "$orkl_settings" | head -10 | sed 's/^/         /'
        fi
        if ! diff -q "$ork_settings" "$orc_settings" >/dev/null 2>&1; then
            echo "       ork vs ork-creative:"
            diff "$ork_settings" "$orc_settings" | head -10 | sed 's/^/         /'
        fi
    fi
fi
echo ""

# =============================================================================
# Test 6: plugin.json version is identical across all three plugins
# =============================================================================
echo -e "${BLUE}6. plugin.json version identical across all three plugins${NC}"
echo "──────────────────────────────────────────"

ork_pj="$ORK/.claude-plugin/plugin.json"
orkl_pj="$ORKL/.claude-plugin/plugin.json"
orc_pj="$ORC/.claude-plugin/plugin.json"

for pj_label in "ork:$ork_pj" "orkl:$orkl_pj" "ork-creative:$orc_pj"; do
    label="${pj_label%%:*}"
    pj="${pj_label##*:}"
    if [[ ! -f "$pj" ]]; then
        fail "$label/.claude-plugin/plugin.json is MISSING"
    fi
done

if [[ -f "$ork_pj" && -f "$orkl_pj" && -f "$orc_pj" ]]; then
    ork_ver=$(jq -r '.version // empty' "$ork_pj")
    orkl_ver=$(jq -r '.version // empty' "$orkl_pj")
    orc_ver=$(jq -r '.version // empty' "$orc_pj")

    echo "  ork:          $ork_ver"
    echo "  orkl:         $orkl_ver"
    echo "  ork-creative: $orc_ver"

    if [[ "$ork_ver" == "$orkl_ver" && "$ork_ver" == "$orc_ver" && -n "$ork_ver" ]]; then
        pass "All three at version $ork_ver"
    else
        fail "Versions differ — ork=$ork_ver, orkl=$orkl_ver, ork-creative=$orc_ver (expected identical)"
    fi
fi
echo ""

# =============================================================================
# Test 7: The ONLY permitted differences in plugin.json are name and description
# =============================================================================
echo -e "${BLUE}7. plugin.json: only name/description differ (all other fields identical)${NC}"
echo "──────────────────────────────────────────"

if [[ -f "$ork_pj" && -f "$orkl_pj" && -f "$orc_pj" ]]; then
    # Strip name and description, then compare the remainder
    strip_identity() {
        jq 'del(.name, .description)' "$1"
    }

    ork_stripped=$(strip_identity "$ork_pj")
    orkl_stripped=$(strip_identity "$orkl_pj")
    orc_stripped=$(strip_identity "$orc_pj")

    if [[ "$ork_stripped" == "$orkl_stripped" && "$ork_stripped" == "$orc_stripped" ]]; then
        pass "plugin.json fields outside name/description are identical across all three"
    else
        fail "plugin.json has unexpected differences beyond name/description"
        if [[ "$ork_stripped" != "$orkl_stripped" ]]; then
            echo "       ork vs orkl (name+description stripped):"
            diff <(echo "$ork_stripped") <(echo "$orkl_stripped") | head -15 | sed 's/^/         /'
        fi
        if [[ "$ork_stripped" != "$orc_stripped" ]]; then
            echo "       ork vs ork-creative (name+description stripped):"
            diff <(echo "$ork_stripped") <(echo "$orc_stripped") | head -15 | sed 's/^/         /'
        fi
    fi

    # Confirm name fields ARE different (aliases must have distinct names)
    ork_name=$(jq -r '.name' "$ork_pj")
    orkl_name=$(jq -r '.name' "$orkl_pj")
    orc_name=$(jq -r '.name' "$orc_pj")

    if [[ "$ork_name" != "$orkl_name" && "$ork_name" != "$orc_name" && "$orkl_name" != "$orc_name" ]]; then
        pass "Each plugin.json has a distinct name (ork, orkl, ork-creative)"
    else
        fail "plugin.json names are not all distinct — ork='$ork_name', orkl='$orkl_name', ork-creative='$orc_name'"
    fi
fi
echo ""

# =============================================================================
# Summary
# =============================================================================
echo "=========================================="
echo "Summary"
echo "=========================================="
echo -e "Passed: ${GREEN}$PASSED${NC}"
echo -e "Failed: ${RED}$FAILED${NC}"

if [[ "$FAILED" -gt 0 ]]; then
    echo ""
    echo -e "${YELLOW}Failures:${NC}"
    for check in "${FAILED_CHECKS[@]}"; do
        echo -e "  ${RED}*${NC} $check"
    done
    echo ""
    echo -e "${RED}FAILED${NC}: $FAILED check(s) — orkl and ork-creative are not exact aliases of ork"
    echo "  Run 'npm run build' to regenerate plugins/ from src/"
    echo "  In v7, all three plugins must contain identical content (same skills, agents, hooks, settings)"
    exit 1
else
    echo ""
    echo -e "${GREEN}PASSED${NC}: orkl and ork-creative are exact aliases of ork (v7 unified architecture)"
    exit 0
fi
