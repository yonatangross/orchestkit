#!/usr/bin/env bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-02-25

# =============================================================================
# Test: Build Drift Detection
# =============================================================================
# Detects when src/ content doesn't match plugins/ after a build.
# Catches: edited src/ without running `npm run build`.
#
# Checks: skill content, agent content, rules/references, hook dist files.
# =============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

CHECKED=0
DRIFTED=0
DRIFTED_FILES=()

check_file() {
    local src="$1" dest="$2"
    CHECKED=$((CHECKED + 1))
    if [[ ! -f "$dest" ]]; then
        DRIFTED=$((DRIFTED + 1))
        DRIFTED_FILES+=("MISSING: ${src#$PROJECT_ROOT/} -> ${dest#$PROJECT_ROOT/}")
    elif ! diff -q "$src" "$dest" >/dev/null 2>&1; then
        DRIFTED=$((DRIFTED + 1))
        DRIFTED_FILES+=("CHANGED: ${src#$PROJECT_ROOT/} != ${dest#$PROJECT_ROOT/}")
    fi
}

echo "=========================================="
echo "Build Drift Detection"
echo "=========================================="
echo ""

PLUGIN_DIR="$PROJECT_ROOT/plugins/ork"

# --- A. Skill content drift (SKILL.md) ---------------------------------------
echo "A. Checking skill content drift..."
for src_skill in "$PROJECT_ROOT"/src/skills/*/SKILL.md; do
    [[ -f "$src_skill" ]] || continue
    skill_name=$(basename "$(dirname "$src_skill")")
    check_file "$src_skill" "$PLUGIN_DIR/skills/$skill_name/SKILL.md"
done
echo "   Skills checked."

# --- B. Agent content drift ---------------------------------------------------
# NOTE: Build script appends a "Skill Index" section to agents in plugins/.
# So we compare only the original content (up to the appended section).
echo "B. Checking agent content drift..."
for src_agent in "$PROJECT_ROOT"/src/agents/*.md; do
    [[ -f "$src_agent" ]] || continue
    agent_name=$(basename "$src_agent")
    dest_agent="$PLUGIN_DIR/agents/$agent_name"
    CHECKED=$((CHECKED + 1))
    if [[ ! -f "$dest_agent" ]]; then
        DRIFTED=$((DRIFTED + 1))
        DRIFTED_FILES+=("MISSING: src/agents/$agent_name -> plugins/ork/agents/$agent_name")
    else
        # Extract only the original content length from dest (build appends after it)
        src_lines=$(wc -l < "$src_agent")
        if ! head -n "$src_lines" "$dest_agent" | diff -q - "$src_agent" >/dev/null 2>&1; then
            DRIFTED=$((DRIFTED + 1))
            DRIFTED_FILES+=("CHANGED: src/agents/$agent_name != plugins/ork/agents/$agent_name")
        fi
    fi
done
echo "   Agents checked."

# --- C. Rules and references drift --------------------------------------------
echo "C. Checking rules/references drift..."
for src_skill_dir in "$PROJECT_ROOT"/src/skills/*/; do
    [[ -d "$src_skill_dir" ]] || continue
    skill_name=$(basename "$src_skill_dir")
    dest_skill_dir="$PLUGIN_DIR/skills/$skill_name"

    for subdir in rules references; do
        if [[ -d "$src_skill_dir/$subdir" ]]; then
            for src_file in "$src_skill_dir/$subdir"/*.md; do
                [[ -f "$src_file" ]] || continue
                rel_path="${src_file#$src_skill_dir}"
                check_file "$src_file" "$dest_skill_dir/$rel_path"
            done
        fi
    done
done
echo "   Rules/references checked."

# --- D. Hook dist drift -------------------------------------------------------
echo "D. Checking hook dist drift..."
for src_hook in "$PROJECT_ROOT"/src/hooks/dist/*.mjs; do
    [[ -f "$src_hook" ]] || continue
    hook_name=$(basename "$src_hook")
    check_file "$src_hook" "$PLUGIN_DIR/hooks/dist/$hook_name"
done
echo "   Hook dist checked."

# --- Summary ------------------------------------------------------------------
echo ""
echo "=========================================="
echo "Build Drift Summary"
echo "=========================================="
echo -e "Files checked: ${GREEN}$CHECKED${NC}"
echo -e "Files drifted: ${RED}$DRIFTED${NC}"

if [[ "$DRIFTED" -gt 0 ]]; then
    echo ""
    echo -e "${YELLOW}Drifted files:${NC}"
    for entry in "${DRIFTED_FILES[@]}"; do
        echo -e "  ${RED}*${NC} $entry"
    done
    echo ""
    echo -e "${RED}FAILED${NC}: $DRIFTED file(s) drifted â€” run 'npm run build' and stage plugins/"
    exit 1
else
    echo ""
    echo -e "${GREEN}PASSED${NC}: No build drift detected"
    exit 0
fi
