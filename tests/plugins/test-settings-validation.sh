#!/usr/bin/env bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-03-01

# ============================================================================
# settings.json Validation Test
# ============================================================================
# Validates plugin settings.json structure: keybindings, statusLine,
# spinnerVerbs, spinnerTipsOverride, and permissions.
# ============================================================================

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="${CLAUDE_PROJECT_DIR:-$(cd "$SCRIPT_DIR/../.." && pwd)}"

TOTAL_PASSED=0
TOTAL_FAILED=0

# Colors
if [[ -t 1 ]]; then
    RED='\033[0;31m' GREEN='\033[0;32m' YELLOW='\033[1;33m'
    BLUE='\033[0;34m' CYAN='\033[0;36m' NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' CYAN='' NC=''
fi

pass() { echo -e "  ${GREEN}PASS${NC} $1"; TOTAL_PASSED=$((TOTAL_PASSED + 1)); }
fail() { echo -e "  ${RED}FAIL${NC} $1"; TOTAL_FAILED=$((TOTAL_FAILED + 1)); }

echo -e "${BLUE}Settings.json Validation${NC}"
echo "========================================"

# Find all settings.json files in plugins/
for settings_file in "$PROJECT_ROOT"/plugins/*/settings.json; do
    [[ -f "$settings_file" ]] || continue
    plugin_name="$(basename "$(dirname "$settings_file")")"
    echo -e "\n${CYAN}Plugin: $plugin_name${NC}"

    # --- Test 1: Valid JSON ---
    if jq empty "$settings_file" 2>/dev/null; then
        pass "Valid JSON"
    else
        fail "Invalid JSON syntax"
        continue
    fi

    # --- Test 2: Keybindings structure ---
    kb_count=$(jq '.keybindings | length' "$settings_file" 2>/dev/null || echo "0")
    if [[ "$kb_count" -gt 0 ]]; then
        # Each keybinding must have "key" and "skill"
        invalid_kb=$(jq '[.keybindings[] | select(.key == null or .skill == null)] | length' "$settings_file")
        if [[ "$invalid_kb" -eq 0 ]]; then
            pass "Keybindings: $kb_count entries, all have key+skill"
        else
            fail "Keybindings: $invalid_kb entries missing key or skill"
        fi

        # Validate keybinding skills exist as actual skills
        skills_dir="$PROJECT_ROOT/plugins/$plugin_name/skills"
        if [[ -d "$skills_dir" ]]; then
            kb_skills=$(jq -r '.keybindings[].skill' "$settings_file")
            missing_skills=""
            while IFS= read -r skill; do
                if [[ ! -d "$skills_dir/$skill" ]]; then
                    missing_skills="$missing_skills $skill"
                fi
            done <<< "$kb_skills"
            if [[ -z "$missing_skills" ]]; then
                pass "Keybinding skills: all reference existing skills"
            else
                fail "Keybinding skills not found:$missing_skills"
            fi
        fi

        # Validate key format (must contain ctrl/alt/shift + letter)
        bad_keys=$(jq -r '.keybindings[].key' "$settings_file" | grep -cv 'ctrl\|alt\|shift' || true)
        if [[ "$bad_keys" -eq 0 ]]; then
            pass "Keybinding keys: all use modifier keys"
        else
            fail "Keybinding keys: $bad_keys entries without modifier keys"
        fi
    else
        pass "Keybindings: not configured (optional)"
    fi

    # --- Test 3: StatusLine structure ---
    has_statusline=$(jq 'has("statusLine")' "$settings_file")
    if [[ "$has_statusline" == "true" ]]; then
        sl_type=$(jq -r '.statusLine.type // empty' "$settings_file")
        sl_cmd=$(jq -r '.statusLine.command // empty' "$settings_file")
        if [[ "$sl_type" == "command" && -n "$sl_cmd" ]]; then
            pass "StatusLine: type=command with command defined"
        else
            fail "StatusLine: missing type or command field"
        fi
    else
        pass "StatusLine: not configured (optional)"
    fi

    # --- Test 4: SpinnerVerbs structure ---
    has_spinner=$(jq 'has("spinnerVerbs")' "$settings_file")
    if [[ "$has_spinner" == "true" ]]; then
        sv_mode=$(jq -r '.spinnerVerbs.mode // empty' "$settings_file")
        sv_count=$(jq '.spinnerVerbs.verbs | length' "$settings_file" 2>/dev/null || echo "0")
        if [[ "$sv_mode" =~ ^(append|replace)$ && "$sv_count" -gt 0 ]]; then
            pass "SpinnerVerbs: mode=$sv_mode, $sv_count verbs"
        else
            fail "SpinnerVerbs: invalid mode or empty verbs array"
        fi
    else
        pass "SpinnerVerbs: not configured (optional)"
    fi

    # --- Test 5: SpinnerTipsOverride structure ---
    has_tips=$(jq 'has("spinnerTipsOverride")' "$settings_file")
    if [[ "$has_tips" == "true" ]]; then
        tips_count=$(jq '.spinnerTipsOverride.tips | length' "$settings_file" 2>/dev/null || echo "0")
        has_exclude=$(jq '.spinnerTipsOverride | has("excludeDefault")' "$settings_file")
        if [[ "$tips_count" -gt 0 && "$has_exclude" == "true" ]]; then
            pass "SpinnerTips: $tips_count tips, excludeDefault defined"
        else
            fail "SpinnerTips: missing tips or excludeDefault field"
        fi
    else
        pass "SpinnerTips: not configured (optional)"
    fi

    # --- Test 6: Permissions structure ---
    has_perms=$(jq 'has("permissions")' "$settings_file")
    if [[ "$has_perms" == "true" ]]; then
        allow_count=$(jq '.permissions.allow | length' "$settings_file" 2>/dev/null || echo "0")
        deny_count=$(jq '.permissions.deny | length' "$settings_file" 2>/dev/null || echo "0")
        pass "Permissions: $allow_count allow, $deny_count deny rules"
    else
        pass "Permissions: not configured (optional)"
    fi
done

# --- Summary ---
echo ""
echo "========================================"
echo -e "  Total: $((TOTAL_PASSED + TOTAL_FAILED))  |  Passed: ${GREEN}${TOTAL_PASSED}${NC}  |  Failed: ${RED}${TOTAL_FAILED}${NC}"
echo "========================================"

if [[ "$TOTAL_FAILED" -gt 0 ]]; then
    exit 1
fi
