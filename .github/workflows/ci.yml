name: Tests & Security

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:
  schedule:
    # Nightly at 2 AM UTC
    - cron: '0 2 * * *'

# Cancel in-progress runs on new commits to same branch
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  CLAUDE_PROJECT_DIR: ${{ github.workspace }}

jobs:
  # ============================================================================
  # STAGE 0: Build + Artifacts (< 1m)
  # Single build, shared via artifacts to avoid rebuilding
  # ============================================================================
  build-plugins:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'true'
          run-ci-setup: 'false'

      - name: Validate no symlinks
        run: |
          if find plugins/ -type l | grep -q .; then
            echo "ERROR: Found symlinks in plugins/"
            exit 1
          fi

      - name: Validate passive indexes
        run: bash tests/indexes/test-index-generation.sh

      - name: Check for uncommitted build changes
        run: |
          if ! git diff --quiet plugins/; then
            echo "::error::Build drift detected! Run 'npm run build' and commit the changes."
            git diff --stat plugins/
            exit 1
          fi

      - name: Upload built plugins
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5
        with:
          name: built-plugins
          path: plugins/
          retention-days: 1

  # ============================================================================
  # STAGE 1: Fast Checks (< 30s)
  # ============================================================================
  lint:
    name: Static Analysis
    needs: build-plugins
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'
          ci-setup-flags: '--with-shellcheck'

      - name: Run lint checks
        run: bash tests/ci/lint.sh

      - name: Biome lint
        run: cd src/hooks && npx biome check src/

  # ============================================================================
  # STAGE 1b: Dependency Security Audit (BLOCKING)
  # ============================================================================
  security-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6
        with:
          node-version: '22'

      - name: Audit root dependencies
        run: npm audit --audit-level=critical

      - name: Audit hooks dependencies
        working-directory: src/hooks
        run: npm audit --audit-level=critical

  # ============================================================================
  # STAGE 1c: Secret Scanning
  # ============================================================================
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@dcedce43c6f43de0b836d1fe38946645c9c638dc  # v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # STAGE 2: Unit Tests (< 5m)
  # Node versions: 20 (LTS), 22 (Current LTS)
  # Uses dynamic test discovery
  # ============================================================================
  unit-tests:
    name: Unit Tests (node ${{ matrix.node-version }})
    needs: lint
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        node-version: ['20', '22']
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          node-version: ${{ matrix.node-version }}
          build-plugins: 'false'

      - name: Run unit tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/unit --verbose

  # ============================================================================
  # STAGE 2b: TypeScript Hook Tests (vitest)
  # Node version matrix
  # ============================================================================
  hook-typescript-tests:
    name: TypeScript Tests (node ${{ matrix.node-version }})
    needs: lint
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        node-version: ['20', '22']
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          node-version: ${{ matrix.node-version }}
          build-plugins: 'false'
          run-ci-setup: 'false'
          install-hooks-deps: 'true'

      - name: Run vitest
        shell: bash
        working-directory: src/hooks
        run: npx vitest run --reporter=verbose

  # ============================================================================
  # STAGE 3: Security Tests (< 3m)
  # ZERO TOLERANCE: Any failure blocks merge
  # ============================================================================
  security-tests:
    name: Security Tests
    needs: [build-plugins]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run security tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/security --verbose

  # ============================================================================
  # STAGE 4: Integration Tests (< 5m)
  # Uses dynamic test discovery
  # ============================================================================
  integration-tests:
    name: Integration Tests
    needs: [unit-tests, security-tests]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run integration tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/integration --verbose

      - name: Run e2e tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/e2e --verbose

  # ============================================================================
  # STAGE 5: Performance Tests (< 2m)
  # Uses dynamic test discovery
  # ============================================================================
  performance-tests:
    name: Performance Tests
    needs: [build-plugins]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run performance tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/performance --verbose

  # ============================================================================
  # STAGE 6: Compliance Tests
  # Uses dynamic test discovery
  # ============================================================================
  compliance-tests:
    name: Compliance Tests
    needs: [build-plugins]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run compliance tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/compliance --verbose

  # ============================================================================
  # STAGE 7: Agent & Skill Validation
  # Uses dynamic test discovery
  # ============================================================================
  agent-skill-tests:
    name: Agents & Skills
    needs: [build-plugins]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run agent tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/agents --verbose

      - name: Run skill tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/skills --verbose

      - name: Run subagent definition tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/subagents --verbose

  # ============================================================================
  # STAGE 7b: Manifest, Schema & Hook Compliance
  # Tests not previously covered in CI
  # ============================================================================
  manifest-schema-tests:
    name: Manifests & Schemas
    needs: [build-plugins]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'
          run-ci-setup: 'false'

      - name: Run manifest tests
        run: bash scripts/ci/run-tests.sh tests/manifests --verbose

      - name: Run schema tests
        run: bash scripts/ci/run-tests.sh tests/schemas --verbose

      - name: Run hook compliance tests
        run: bash scripts/ci/run-tests.sh tests/hooks --verbose

      - name: Run index tests
        run: bash scripts/ci/run-tests.sh tests/indexes --verbose

  # ============================================================================
  # STAGE 7c: Static Analysis Pipeline (eval:static)
  # ============================================================================
  eval-static:
    name: Static Analysis Pipeline
    needs: [build-plugins]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run eval:static
        run: npm run eval:static

      - name: Upload results
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5
        with:
          name: static-analysis-results
          path: tests/evaluations/results/static-analysis.json
          retention-days: 30
        if: always()

  # ============================================================================
  # STAGE 8: System Tests
  # Uses dynamic test discovery
  # ============================================================================
  system-tests:
    name: System Tests
    needs: [build-plugins]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run config tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/config --verbose

      - name: Run feedback tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/feedback --verbose

      - name: Run evaluation tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/evaluations --verbose


  # ============================================================================
  # STAGE 9: Coverage Report
  # ============================================================================
  coverage-report:
    name: Hook Coverage
    needs: [unit-tests, security-tests]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Generate hook coverage report
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          export COVERAGE_THRESHOLD=75
          bash tests/coverage/hook-coverage-report.sh | tee coverage-report.txt

      - name: Upload coverage report
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5
        with:
          name: hook-coverage-report
          path: coverage-report.txt
          retention-days: 30


  # ============================================================================
  # Final Summary
  # ============================================================================
  summary:
    name: CI Summary
    needs: [lint, security-audit, secret-scanning, unit-tests, hook-typescript-tests, security-tests, integration-tests, performance-tests, compliance-tests, agent-skill-tests, manifest-schema-tests, eval-static, system-tests, coverage-report]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    steps:
      - name: Check all jobs
        run: |
          echo "=== CI Summary ==="
          echo "Lint: ${{ needs.lint.result }}"
          echo "Security Audit: ${{ needs.security-audit.result }}"
          echo "Secret Scanning: ${{ needs.secret-scanning.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Hook TS Tests: ${{ needs.hook-typescript-tests.result }}"
          echo "Security Tests: ${{ needs.security-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Performance Tests: ${{ needs.performance-tests.result }}"
          echo "Compliance Tests: ${{ needs.compliance-tests.result }}"
          echo "Agent & Skill Tests: ${{ needs.agent-skill-tests.result }}"
          echo "Manifests & Schemas: ${{ needs.manifest-schema-tests.result }}"
          echo "Static Analysis Pipeline: ${{ needs.eval-static.result }}"
          echo "System Tests: ${{ needs.system-tests.result }}"
          echo "Coverage Report: ${{ needs.coverage-report.result }}"

          # Fail only on explicit failures (skipped jobs are OK - they use path filters)
          FAILED=0
          for result in \
            "${{ needs.lint.result }}" \
            "${{ needs.security-audit.result }}" \
            "${{ needs.secret-scanning.result }}" \
            "${{ needs.unit-tests.result }}" \
            "${{ needs.hook-typescript-tests.result }}" \
            "${{ needs.security-tests.result }}" \
            "${{ needs.integration-tests.result }}" \
            "${{ needs.performance-tests.result }}" \
            "${{ needs.compliance-tests.result }}" \
            "${{ needs.agent-skill-tests.result }}" \
            "${{ needs.manifest-schema-tests.result }}" \
            "${{ needs.eval-static.result }}" \
            "${{ needs.system-tests.result }}"; do
            if [[ "$result" == "failure" || "$result" == "cancelled" ]]; then
              FAILED=1
            fi
          done

          if [[ "$FAILED" == "1" ]]; then
            echo "::error::One or more CI stages failed"
            exit 1
          fi

          echo "::notice::All CI stages passed!"
