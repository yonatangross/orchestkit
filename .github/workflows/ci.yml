name: Tests & Security

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:
  schedule:
    # Nightly at 2 AM UTC
    - cron: '0 2 * * *'

# Cancel in-progress runs on new commits to same branch
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  CLAUDE_PROJECT_DIR: ${{ github.workspace }}

jobs:
  # ============================================================================
  # STAGE 0: Build + Artifacts (< 1m)
  # Single build, shared via artifacts to avoid rebuilding
  # ============================================================================
  build-plugins:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'true'
          run-ci-setup: 'false'

      - name: Validate no symlinks
        run: |
          if find plugins/ -type l | grep -q .; then
            echo "ERROR: Found symlinks in plugins/"
            exit 1
          fi

      - name: Validate passive indexes
        run: bash tests/indexes/test-index-generation.sh

      - name: Upload built plugins
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5
        with:
          name: built-plugins
          path: plugins/
          retention-days: 1

  # ============================================================================
  # STAGE 1: Fast Checks (< 30s)
  # ============================================================================
  lint:
    name: Static Analysis
    needs: build-plugins
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'
          ci-setup-flags: '--with-shellcheck'

      - name: Run lint checks
        run: bash tests/ci/lint.sh

  # ============================================================================
  # STAGE 1b: Dependency Security Audit (BLOCKING)
  # ============================================================================
  security-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6
        with:
          node-version: '22'

      - name: Audit root dependencies
        run: npm audit --audit-level=critical

      - name: Audit hooks dependencies
        working-directory: src/hooks
        run: npm audit --audit-level=critical

  # ============================================================================
  # STAGE 1c: Secret Scanning
  # ============================================================================
  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6
        with:
          fetch-depth: 0

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@dcedce43c6f43de0b836d1fe38946645c9c638dc  # v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # STAGE 2: Unit Tests (< 5m)
  # Cross-platform: ubuntu + macos + windows
  # Node versions: 20 (LTS), 22 (Current LTS)
  # Uses dynamic test discovery
  # ============================================================================
  unit-tests:
    name: Unit Tests (${{ matrix.os }}, node ${{ matrix.node-version }})
    needs: lint
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: ['20', '22']
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          node-version: ${{ matrix.node-version }}
          build-plugins: 'false'

      - name: Run unit tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/unit --verbose

  # ============================================================================
  # STAGE 2b: TypeScript Hook Tests (vitest)
  # Cross-platform with Node version matrix
  # ============================================================================
  hook-typescript-tests:
    name: TypeScript Tests (${{ matrix.os }}, node ${{ matrix.node-version }})
    needs: lint
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: ['20', '22']
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          node-version: ${{ matrix.node-version }}
          build-plugins: 'false'
          run-ci-setup: 'false'
          install-hooks-deps: 'true'

      - name: Run vitest
        shell: bash
        working-directory: src/hooks
        run: npx vitest run --reporter=verbose

  # ============================================================================
  # STAGE 3: Security Tests (< 3m)
  # ZERO TOLERANCE: Any failure blocks merge
  # Cross-platform: ubuntu + macos + windows
  # Uses dynamic test discovery
  # ============================================================================
  security-tests:
    name: Security Tests (${{ matrix.os }})
    needs: [build-plugins]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run security tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/security --verbose

  # ============================================================================
  # STAGE 4: Integration Tests (< 5m)
  # Cross-platform: ubuntu + macos + windows
  # Uses dynamic test discovery
  # ============================================================================
  integration-tests:
    name: Integration Tests (${{ matrix.os }})
    needs: [unit-tests, security-tests]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run integration tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/integration --verbose

      - name: Run e2e tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/e2e --verbose

  # ============================================================================
  # STAGE 5: Performance Tests (< 2m)
  # Cross-platform: ubuntu + macos + windows
  # Uses dynamic test discovery
  # ============================================================================
  performance-tests:
    name: Performance Tests (${{ matrix.os }})
    needs: [build-plugins]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run performance tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/performance --verbose

  # ============================================================================
  # STAGE 6: Compliance Tests
  # Cross-platform: ubuntu + macos + windows
  # Uses dynamic test discovery
  # ============================================================================
  compliance-tests:
    name: Compliance Tests (${{ matrix.os }})
    needs: [build-plugins]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run compliance tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/compliance --verbose

  # ============================================================================
  # STAGE 6b: Mem0 Integration Tests
  # Cross-platform: ubuntu + macos + windows
  # Uses dynamic test discovery
  # ============================================================================
  mem0-tests:
    name: Mem0 Integration (${{ matrix.os }})
    needs: [build-plugins]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6
        with:
          python-version: '3.12'

      - name: Install mem0ai
        shell: bash
        run: pip install -r src/skills/mem0-memory/scripts/requirements.txt

      - name: Run mem0 tests
        shell: bash
        env:
          MEM0_API_KEY: ${{ secrets.MEM0_API_KEY }}
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/mem0 --verbose

  # ============================================================================
  # STAGE 7: Agent & Skill Validation
  # Cross-platform: ubuntu + macos + windows
  # Uses dynamic test discovery
  # ============================================================================
  agent-skill-tests:
    name: Agents & Skills (${{ matrix.os }})
    needs: [build-plugins]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run agent tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/agents --verbose

      - name: Run skill tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/skills --verbose

      - name: Run subagent definition tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/subagents --verbose

  # ============================================================================
  # STAGE 8: System Tests
  # Cross-platform: ubuntu + macos + windows
  # Uses dynamic test discovery
  # ============================================================================
  system-tests:
    name: System Tests (${{ matrix.os }})
    needs: [build-plugins]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Run config tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/config --verbose

      - name: Run feedback tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/feedback --verbose

      - name: Run evaluation tests
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          bash scripts/ci/run-tests.sh tests/evaluations --verbose


  # ============================================================================
  # STAGE 9: Coverage Report
  # ============================================================================
  coverage-report:
    name: Hook Coverage
    needs: [unit-tests, security-tests]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Download built plugins
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0  # v5
        with:
          name: built-plugins
          path: plugins/

      - name: Setup environment
        uses: ./.github/actions/setup
        with:
          build-plugins: 'false'

      - name: Generate hook coverage report
        shell: bash
        run: |
          export CLAUDE_PROJECT_DIR="${{ github.workspace }}"
          # Set realistic threshold - current coverage is ~25%
          # TODO: Gradually increase as more tests are added
          export COVERAGE_THRESHOLD=20
          bash tests/coverage/hook-coverage-report.sh | tee coverage-report.txt

      - name: Upload coverage report
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5
        with:
          name: hook-coverage-report
          path: coverage-report.txt
          retention-days: 30


  # ============================================================================
  # Final Summary
  # ============================================================================
  summary:
    name: CI Summary
    needs: [lint, security-audit, secret-scanning, unit-tests, hook-typescript-tests, security-tests, integration-tests, performance-tests, compliance-tests, mem0-tests, agent-skill-tests, system-tests, coverage-report]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    steps:
      - name: Check all jobs
        run: |
          echo "=== CI Summary ==="
          echo "Lint: ${{ needs.lint.result }}"
          echo "Security Audit: ${{ needs.security-audit.result }}"
          echo "Secret Scanning: ${{ needs.secret-scanning.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Hook TS Tests: ${{ needs.hook-typescript-tests.result }}"
          echo "Security Tests: ${{ needs.security-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Performance Tests: ${{ needs.performance-tests.result }}"
          echo "Compliance Tests: ${{ needs.compliance-tests.result }}"
          echo "Mem0 Tests: ${{ needs.mem0-tests.result }}"
          echo "Agent & Skill Tests: ${{ needs.agent-skill-tests.result }}"
          echo "System Tests: ${{ needs.system-tests.result }}"
          echo "Coverage Report: ${{ needs.coverage-report.result }}"

          # Fail only on explicit failures (skipped jobs are OK - they use path filters)
          FAILED=0
          for result in \
            "${{ needs.lint.result }}" \
            "${{ needs.security-audit.result }}" \
            "${{ needs.secret-scanning.result }}" \
            "${{ needs.unit-tests.result }}" \
            "${{ needs.hook-typescript-tests.result }}" \
            "${{ needs.security-tests.result }}" \
            "${{ needs.integration-tests.result }}" \
            "${{ needs.performance-tests.result }}" \
            "${{ needs.compliance-tests.result }}" \
            "${{ needs.mem0-tests.result }}" \
            "${{ needs.agent-skill-tests.result }}" \
            "${{ needs.system-tests.result }}"; do
            if [[ "$result" == "failure" || "$result" == "cancelled" ]]; then
              FAILED=1
            fi
          done

          if [[ "$FAILED" == "1" ]]; then
            echo "::error::One or more CI stages failed"
            exit 1
          fi

          echo "::notice::All CI stages passed!"
