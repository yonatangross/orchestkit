name: "Visualize: Memory"

on:
  schedule:
    # Weekly on Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'src/skills/**'
      - 'src/agents/**'
      - '.github/workflows/mem0-visualization.yml'

env:
  CLAUDE_PROJECT_DIR: ${{ github.workspace }}

jobs:
  update-and-visualize:
    name: Update Mem0 Visualization
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install --user mem0ai plotly networkx matplotlib kaleido pyyaml

      - name: Check Mem0 API key
        id: check_key
        run: |
          if [ -z "${{ secrets.MEM0_API_KEY }}" ]; then
            echo "skip_mem0=true" >> $GITHUB_OUTPUT
          else
            echo "skip_mem0=false" >> $GITHUB_OUTPUT
          fi

      - name: Update memories metadata
        if: steps.check_key.outputs.skip_mem0 == 'false'
        timeout-minutes: 5
        continue-on-error: true
        run: |
          python3 src/skills/mem0-memory/scripts/validation/update-memories-metadata.py --limit 100 2>&1 | head -50 || echo "Metadata update skipped due to error"
        env:
          MEM0_API_KEY: ${{ secrets.MEM0_API_KEY }}

      - name: Generate visualization
        if: steps.check_key.outputs.skip_mem0 == 'false'
        timeout-minutes: 10
        continue-on-error: true
        run: |
          mkdir -p outputs
          python3 src/skills/mem0-memory/scripts/visualization/visualize-mem0-graph.py \
            --format json \
            --limit 500 \
            --cache \
            --output outputs/mem0-graph.json 2>&1 | head -100 || echo "JSON visualization skipped due to error"
        env:
          MEM0_API_KEY: ${{ secrets.MEM0_API_KEY }}

      - name: Generate Plotly visualization
        if: steps.check_key.outputs.skip_mem0 == 'false'
        timeout-minutes: 10
        continue-on-error: true
        run: |
          mkdir -p outputs
          python3 src/skills/mem0-memory/scripts/visualization/visualize-mem0-graph.py \
            --format plotly \
            --limit 500 \
            --cache \
            --output outputs/mem0-graph.html 2>&1 | head -100 || echo "Plotly visualization skipped due to error"
        env:
          MEM0_API_KEY: ${{ secrets.MEM0_API_KEY }}

      - name: Generate Mermaid diagram
        if: steps.check_key.outputs.skip_mem0 == 'false'
        timeout-minutes: 5
        continue-on-error: true
        run: |
          mkdir -p outputs
          python3 src/skills/mem0-memory/scripts/visualization/visualize-mem0-graph.py \
            --format mermaid \
            --limit 500 \
            --cache \
            --output outputs/mem0-graph.mmd 2>&1 | head -50 || echo "Mermaid diagram skipped due to error"
        env:
          MEM0_API_KEY: ${{ secrets.MEM0_API_KEY }}

      - name: Create summary report
        run: |
          mkdir -p outputs
          {
            echo "Mem0 Visualization - CI Run Summary"
            echo "===================================="
            echo "Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "Workflow: ${{ github.workflow }}"
            echo "Run ID: ${{ github.run_id }}"
            echo ""
            echo "Generated Files:"
            ls -lh outputs/mem0-graph.* 2>/dev/null | awk '{print "  -", $9, "(" $5 ")"}' || echo "  (No files generated)"
            echo ""
            if [ -f outputs/mem0-graph.json ]; then
              echo "Graph Statistics:"
              python3 src/skills/mem0-memory/scripts/visualization/generate-graph-stats.py || echo "  (Could not parse statistics)"
            fi
          } > outputs/mem0-ci-summary.txt
          cat outputs/mem0-ci-summary.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5
        if: always()
        with:
          name: mem0-visualization-${{ github.run_id }}
          path: |
            outputs/mem0-graph.*
            outputs/mem0-ci-summary.txt
          retention-days: 30

      - name: Comment on PR (if PR)
        if: github.event_name == 'pull_request' && steps.check_key.outputs.skip_mem0 == 'false'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8
        with:
          script: |
            const fs = require('fs');
            let summary = 'Mem0 visualization updated.';
            try {
              const summaryText = fs.readFileSync('outputs/mem0-ci-summary.txt', 'utf8');
              summary = summaryText;
            } catch (e) {
              console.log('Could not read summary file');
            }
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Mem0 Visualization Update\n\n\`\`\`\n${summary}\n\`\`\`\n\n[View artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });
