# Generated by OrchestKit Claude Plugin
# Created: 2026-02-26

name: Channel Sync

on:
  workflow_dispatch:
    inputs:
      direction:
        description: 'Sync direction'
        required: true
        type: choice
        options:
          - beta-to-main
          - alpha-to-main
          - main-to-beta
          - main-to-alpha
      create-pr:
        description: 'Create PR instead of direct push'
        required: false
        type: boolean
        default: true

permissions: read-all

env:
  CLAUDE_PROJECT_DIR: ${{ github.workspace }}

jobs:
  sync:
    name: Sync Channels
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      pr_url: ${{ steps.create-pr.outputs.pr_url }}
      branch_name: ${{ steps.prepare-sync.outputs.branch_name }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine sync branches
        id: branches
        run: |
          DIRECTION="${{ github.event.inputs.direction }}"

          case "$DIRECTION" in
            beta-to-main)
              echo "source=beta" >> "$GITHUB_OUTPUT"
              echo "target=main" >> "$GITHUB_OUTPUT"
              echo "description=Promote beta channel to main (stable)" >> "$GITHUB_OUTPUT"
              ;;
            alpha-to-main)
              echo "source=alpha" >> "$GITHUB_OUTPUT"
              echo "target=main" >> "$GITHUB_OUTPUT"
              echo "description=Promote alpha channel to main (stable)" >> "$GITHUB_OUTPUT"
              ;;
            main-to-beta)
              echo "source=main" >> "$GITHUB_OUTPUT"
              echo "target=beta" >> "$GITHUB_OUTPUT"
              echo "description=Sync main to beta channel" >> "$GITHUB_OUTPUT"
              ;;
            main-to-alpha)
              echo "source=main" >> "$GITHUB_OUTPUT"
              echo "target=alpha" >> "$GITHUB_OUTPUT"
              echo "description=Sync main to alpha channel" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "::error::Invalid direction: $DIRECTION"
              exit 1
              ;;
          esac

      - name: Prepare sync
        id: prepare-sync
        run: |
          SOURCE="${{ steps.branches.outputs.source }}"
          TARGET="${{ steps.branches.outputs.target }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="sync/${SOURCE}-to-${TARGET}-${TIMESTAMP}"

          echo "branch_name=$BRANCH_NAME" >> "$GITHUB_OUTPUT"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch all branches
          git fetch origin

          # Create sync branch from target
          git checkout origin/$TARGET -b "$BRANCH_NAME"

          # Merge source into sync branch
          git merge origin/$SOURCE --no-edit --allow-unrelated-histories || {
            echo "::error::Merge conflict detected between $SOURCE and $TARGET"
            git merge --abort
            exit 1
          }

      - name: Create pull request
        if: github.event.inputs.create-pr == 'true'
        id: create-pr
        run: |
          SOURCE="${{ steps.branches.outputs.source }}"
          TARGET="${{ steps.branches.outputs.target }}"
          BRANCH_NAME="${{ steps.prepare-sync.outputs.branch_name }}"
          DESCRIPTION="${{ steps.branches.outputs.description }}"

          # Push sync branch
          git push origin "$BRANCH_NAME"

          # Create PR with body from heredoc
          cat > /tmp/pr_body.txt << 'EOFBODY'
          # Channel Sync

          {{ DESCRIPTION }}

          **From:** `{{ SOURCE }}`
          **To:** `{{ TARGET }}`

          This PR syncs changes from the **{{ SOURCE }}** channel to **{{ TARGET }}**.

          ## Notes

          - All CI checks must pass before merge
          - Review changelog for any breaking changes
          - Update version if promoting to main

          ---
          *Created by: GitHub Actions*
          EOFBODY

          # Replace placeholders
          sed -i "s|{{ DESCRIPTION }}|$DESCRIPTION|g" /tmp/pr_body.txt
          sed -i "s|{{ SOURCE }}|$SOURCE|g" /tmp/pr_body.txt
          sed -i "s|{{ TARGET }}|$TARGET|g" /tmp/pr_body.txt

          PR_URL=$(gh pr create \
            --base "$TARGET" \
            --head "$BRANCH_NAME" \
            --title "sync: $SOURCE → $TARGET" \
            --body-file /tmp/pr_body.txt \
            --json url --jq '.url')

          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"

      - name: Direct push
        if: github.event.inputs.create-pr == 'false'
        run: |
          SOURCE="${{ steps.branches.outputs.source }}"
          TARGET="${{ steps.branches.outputs.target }}"
          BRANCH_NAME="${{ steps.prepare-sync.outputs.branch_name }}"

          # Push sync branch and force-push to target
          git push origin "$BRANCH_NAME"
          git push origin "$BRANCH_NAME:$TARGET" --force-with-lease

          echo "::notice::Synced $SOURCE → $TARGET"

      - name: Report results
        run: |
          SOURCE="${{ steps.branches.outputs.source }}"
          TARGET="${{ steps.branches.outputs.target }}"
          BRANCH_NAME="${{ steps.prepare-sync.outputs.branch_name }}"

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Channel Sync Complete

          - **Direction:** $SOURCE → $TARGET
          - **Sync Branch:** \`$BRANCH_NAME\`

          EOF

          if [ "${{ github.event.inputs.create-pr }}" == "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          - **PR:** ${{ steps.create-pr.outputs.pr_url }}
          - **Action:** Awaiting review and merge

          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF
          - **Action:** Direct push to \`$TARGET\` (force-with-lease)

          EOF
          fi

  # ============================================================================
  # Notify on completion
  # ============================================================================
  notify:
    name: Notify
    if: always()
    needs: sync
    runs-on: ubuntu-latest
    steps:
      - name: Success
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## Sync Status: ✅ Complete

          Channel sync completed successfully. Review PR or check target branch status.
          EOF

      - name: Failure
        if: failure()
        run: |
          echo "::error::Channel sync failed. Check logs above for details."
          exit 1
