# Generated by OrchestKit Claude Plugin
# Created: 2026-02-19

# Release â€” Create GitHub Release on tag push
#
# Triggers when a version tag (v*) is pushed.
# Extracts changelog notes and creates a GitHub Release.
#
# Manual workflow: push a tag via bin/create-release.sh
# Automated workflow: release-please creates tags on merge to main

name: Release (Tag)

on:
  push:
    tags:
      - 'v*'

permissions: {}

jobs:
  create-release:
    permissions:
      contents: write
      id-token: write
      attestations: write
    name: GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Extract changelog notes
        id: changelog
        env:
          VERSION: ${{ steps.version.outputs.version }}
          TAG: ${{ steps.version.outputs.tag }}
        run: |
          CHANGELOG_FILE="CHANGELOG.md"

          # Extract section between ## [version] and next ## [
          BODY=$(awk -v ver="$VERSION" '
            /^## \[/ {
              if (found) exit
              if ($0 ~ "\\[" ver "\\]") { found=1; next }
            }
            found && /^---$/ { next }
            found { print }
          ' "$CHANGELOG_FILE")

          # Trim leading/trailing whitespace
          BODY=$(echo "$BODY" | sed -e '/./,$!d' -e :a -e '/^\n*$/{$d;N;ba;}')

          if [ -z "$BODY" ]; then
            echo "::warning::No changelog entry found for $VERSION, using fallback"
            BODY="Release $TAG"
          fi

          # Write to file for multiline support
          echo "$BODY" > /tmp/release-notes.md

      - name: Check if release exists
        id: check
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          if gh release view "$TAG" &>/dev/null; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        if: steps.check.outputs.exists == 'false'
        run: |
          gh release create "${{ steps.version.outputs.tag }}" \
            --title "${{ steps.version.outputs.tag }}" \
            --notes-file /tmp/release-notes.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js for SBOM generation
        if: steps.check.outputs.exists == 'false'
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6
        with:
          node-version: '20'

      - name: Install production dependencies
        if: steps.check.outputs.exists == 'false'
        run: npm ci --ignore-scripts --production

      - name: Generate SBOM (CycloneDX)
        if: steps.check.outputs.exists == 'false'
        uses: CycloneDX/gh-node-module-generatebom@27e13c2bf0fae78d66387b35ca9749d8cc853060  # v1
        with:
          output: bom.json

      - name: Upload SBOM to release
        if: steps.check.outputs.exists == 'false'
        run: |
          gh release upload "${{ steps.version.outputs.tag }}" bom.json#sbom-cyclonedx.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Attest build provenance
        if: steps.check.outputs.exists == 'false'
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f  # v3.2.0
        with:
          subject-path: bom.json
