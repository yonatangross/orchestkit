name: Quality Report

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  generate-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run build
        id: build
        run: |
          if npm run build 2>&1 | tee build.log; then
            echo "status=success" >> "$GITHUB_OUTPUT"
          else
            echo "status=failure" >> "$GITHUB_OUTPUT"
          fi

      - name: Run tests with coverage
        id: tests
        run: |
          # Run hook tests with coverage (vitest + @vitest/coverage-v8 4.0.18)
          cd src/hooks
          npm ci
          npm run test:coverage 2>&1 | tee ../../test.log || true

          # Copy coverage to root for report generator
          if [ -f coverage/coverage-summary.json ]; then
            cp coverage/coverage-summary.json ../../coverage-summary.json
          fi
          cd ../..

          # Run shell-based tests
          npm test 2>&1 | tee -a test.log || true

          # Extract test counts from vitest output which has two "passed" lines:
          #   Test Files  194 passed (194)    <- file count (1st match)
          #        Tests  6529 passed (6529)  <- individual test count (2nd match)
          # Use sed -n '2p' to get individual tests, '1p' for file count
          vitest_passed="$(grep -oP '\d+(?=\s+passed)' test.log | sed -n '2p')" || true
          vitest_file_count="$(grep -oP '\d+(?=\s+passed)' test.log | sed -n '1p')" || true
          vitest_failed="$(grep -oP '\d+(?=\s+failed)' test.log | sed -n '2p')" || true
          vitest_skipped="$(grep -oP '\d+(?=\s+skipped)' test.log | sed -n '2p')" || true

          # Shell test format: "Total: N passed, M failed"
          shell_passed="$(grep -oP 'Total:\s+\K\d+(?=\s+passed)' test.log | tail -1)" || true
          shell_failed="$(grep -oP 'Total:\s+\d+\s+passed,\s+\K\d+(?=\s+failed)' test.log | tail -1)" || true

          passed=$(( ${vitest_passed:-0} + ${shell_passed:-0} ))
          failed=$(( ${vitest_failed:-0} + ${shell_failed:-0} ))
          skipped="${vitest_skipped:-0}"

          echo "passed=${passed}" >> "$GITHUB_OUTPUT"
          echo "failed=${failed}" >> "$GITHUB_OUTPUT"
          echo "skipped=${skipped}" >> "$GITHUB_OUTPUT"
          echo "file_count=${vitest_file_count:-0}" >> "$GITHUB_OUTPUT"

          # Extract coverage from summary
          if [ -f coverage-summary.json ]; then
            lines="$(jq -r '.total.lines.pct // 0' coverage-summary.json)"
            functions="$(jq -r '.total.functions.pct // 0' coverage-summary.json)"
            branches="$(jq -r '.total.branches.pct // 0' coverage-summary.json)"
            statements="$(jq -r '.total.statements.pct // 0' coverage-summary.json)"
            echo "coverage_lines=${lines:-0}" >> "$GITHUB_OUTPUT"
            echo "coverage_functions=${functions:-0}" >> "$GITHUB_OUTPUT"
            echo "coverage_branches=${branches:-0}" >> "$GITHUB_OUTPUT"
            echo "coverage_statements=${statements:-0}" >> "$GITHUB_OUTPUT"
          else
            echo "coverage_lines=0" >> "$GITHUB_OUTPUT"
            echo "coverage_functions=0" >> "$GITHUB_OUTPUT"
            echo "coverage_branches=0" >> "$GITHUB_OUTPUT"
            echo "coverage_statements=0" >> "$GITHUB_OUTPUT"
          fi

      - name: Run linting
        id: lint
        run: |
          # TypeScript type-check (no standalone lint script)
          cd src/hooks && npx tsc --noEmit 2>&1 | tee ../../lint.log || true
          cd ../..
          errors="$(grep -c ' error ' lint.log)" || true
          warnings="$(grep -c ' warning ' lint.log)" || true
          echo "errors=${errors:-0}" >> "$GITHUB_OUTPUT"
          echo "warnings=${warnings:-0}" >> "$GITHUB_OUTPUT"

      - name: Run security scan
        id: security
        run: |
          npm audit --json > audit.json 2>/dev/null || true
          critical="$(jq -r '.metadata.vulnerabilities.critical // 0' audit.json)" || true
          high="$(jq -r '.metadata.vulnerabilities.high // 0' audit.json)" || true
          medium="$(jq -r '.metadata.vulnerabilities.moderate // 0' audit.json)" || true
          low="$(jq -r '.metadata.vulnerabilities.low // 0' audit.json)" || true
          echo "critical=${critical:-0}" >> "$GITHUB_OUTPUT"
          echo "high=${high:-0}" >> "$GITHUB_OUTPUT"
          echo "medium=${medium:-0}" >> "$GITHUB_OUTPUT"
          echo "low=${low:-0}" >> "$GITHUB_OUTPUT"

      - name: Generate CI Report
        id: report
        continue-on-error: true
        env:
          CI_BUILD_STATUS: ${{ steps.build.outputs.status }}
          CI_COMMIT_SHA: ${{ github.sha }}
          CI_BRANCH: ${{ github.ref_name }}
          CI_PR_NUMBER: ${{ github.event.pull_request.number }}
          CI_TEST_RESULTS: '{"passed": ${{ steps.tests.outputs.passed || 0 }}, "failed": ${{ steps.tests.outputs.failed || 0 }}, "skipped": ${{ steps.tests.outputs.skipped || 0 }}, "total": 0, "fileCount": ${{ steps.tests.outputs.file_count || 0 }}, "failures": []}'
          CI_LINT_RESULTS: '{"errors": ${{ steps.lint.outputs.errors || 0 }}, "warnings": ${{ steps.lint.outputs.warnings || 0 }}, "files": 0, "issues": []}'
          CI_SECURITY_RESULTS: '{"critical": ${{ steps.security.outputs.critical || 0 }}, "high": ${{ steps.security.outputs.high || 0 }}, "medium": ${{ steps.security.outputs.medium || 0 }}, "low": ${{ steps.security.outputs.low || 0 }}, "vulnerabilities": []}'
          CI_COVERAGE: '{"lines": ${{ steps.tests.outputs.coverage_lines || 0 }}, "functions": ${{ steps.tests.outputs.coverage_functions || 0 }}, "branches": ${{ steps.tests.outputs.coverage_branches || 0 }}, "statements": ${{ steps.tests.outputs.coverage_statements || 0 }}}'
        run: |
          npx tsx scripts/generate-ci-report.ts --output ci-report.html

      - name: Upload CI Report
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5
        with:
          name: ci-report
          path: |
            ci-report.html
            ci-report.json
            ci-report.md
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('ci-report.json', 'utf8'));

            const statusEmoji = report.overallStatus === 'success' ? 'âœ…' :
                               report.overallStatus === 'warning' ? 'âš ï¸' : 'âŒ';

            const grade = report.score >= 90 ? 'A' :
                         report.score >= 80 ? 'B' :
                         report.score >= 70 ? 'C' :
                         report.score >= 60 ? 'D' : 'F';

            const coverageEmoji = report.coverage.current >= 80 ? 'âœ…' : report.coverage.current >= 60 ? 'âš ï¸' : 'âŒ';
            const coverageDetail = report.coverage.lines > 0
              ? `\n\n<details>\n<summary>ðŸ“Š Coverage Details</summary>\n\n| Metric | Coverage |\n|--------|----------|\n| Lines | ${report.coverage.lines?.toFixed(1) || 0}% |\n| Functions | ${report.coverage.functions?.toFixed(1) || 0}% |\n| Branches | ${report.coverage.branches?.toFixed(1) || 0}% |\n| Statements | ${report.coverage.statements?.toFixed(1) || 0}% |\n\n</details>`
              : '';

            const body = `## ${statusEmoji} CI Assessment Report

            **Score:** ${report.score}/100 (Grade ${grade})
            **Status:** ${report.overallStatus.toUpperCase()}

            | Check | Result |
            |-------|--------|
            | Build | ${report.build.status === 'success' ? 'âœ… Passed' : 'âŒ Failed'} |
            | Tests | ${report.tests.failed > 0 ? 'âŒ' : 'âœ…'} ${report.tests.passed}/${report.tests.total} passed${report.tests.fileCount ? ` across ${report.tests.fileCount} files` : ''}${report.tests.skipped > 0 ? ` (${report.tests.skipped} skipped)` : ''} |
            | Lint | ${report.lint.errors > 0 ? 'âŒ' : report.lint.warnings > 0 ? 'âš ï¸' : 'âœ…'} ${report.lint.errors} errors, ${report.lint.warnings} warnings |
            | Security | ${report.security.critical > 0 ? 'âŒ' : report.security.high > 0 ? 'âš ï¸' : 'âœ…'} ${report.security.critical} critical, ${report.security.high} high |
            | Coverage | ${coverageEmoji} ${report.coverage.current.toFixed(1)}% (hooks only) |
            ${coverageDetail}

            ðŸ“Š [View full report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ---
            *Generated by OrchestKit CI Report â€¢ vitest + @vitest/coverage-v8*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('CI Assessment Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Job Summary
        run: |
          if [ -f ci-report.md ]; then
            cat ci-report.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## CI Report generation failed" >> "$GITHUB_STEP_SUMMARY"
          fi
