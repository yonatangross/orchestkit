# Generated by OrchestKit Claude Plugin
# Created: 2026-02-06

# Release Video — Auto-generate demo videos for GitHub Releases
#
# Triggered when:
# 1. A GitHub Release is published (via release-please or manual)
# 2. Manual workflow_dispatch with a version number
#
# Pipeline:
#   parse-changelog → render-videos → upload-to-release
#
# Artifacts: 16:9 MP4, 1:1 MP4, GIF preview
# All uploaded as release assets.

name: Release Video

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to render (e.g., 6.0.2)'
        required: true
        type: string

concurrency:
  group: release-video-${{ github.event.release.tag_name || github.event.inputs.version }}
  cancel-in-progress: true

permissions: {}

env:
  NODE_VERSION: '22'

jobs:
  # ============================================================================
  # Job 1: Parse CHANGELOG → JSON props
  # ============================================================================
  parse-changelog:
    name: Parse Changelog
    permissions:
      contents: read
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      version: ${{ steps.parse.outputs.version }}
      landscape-props: ${{ steps.parse.outputs.landscape_props }}
      square-props: ${{ steps.parse.outputs.square_props }}
      highlight-count: ${{ steps.parse.outputs.highlight_count }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"
          elif [ -n "${{ github.event.release.tag_name }}" ]; then
            # Strip leading 'v' from tag (v6.0.2 → 6.0.2)
            TAG="${{ github.event.release.tag_name }}"
            echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"
          else
            echo "ERROR: No version specified"
            exit 1
          fi

      - name: Parse CHANGELOG
        id: parse
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          # Generate landscape props
          LANDSCAPE=$(node scripts/changelog-to-props.mjs "$VERSION" --landscape)
          echo "landscape_props<<LANDSCAPE_EOF" >> "$GITHUB_OUTPUT"
          echo "$LANDSCAPE" >> "$GITHUB_OUTPUT"
          echo "LANDSCAPE_EOF" >> "$GITHUB_OUTPUT"

          # Generate square props
          SQUARE=$(node scripts/changelog-to-props.mjs "$VERSION" --square)
          echo "square_props<<SQUARE_EOF" >> "$GITHUB_OUTPUT"
          echo "$SQUARE" >> "$GITHUB_OUTPUT"
          echo "SQUARE_EOF" >> "$GITHUB_OUTPUT"

          # Highlight count for summary
          COUNT=$(echo "$LANDSCAPE" | node -e "
            const d = require('fs').readFileSync('/dev/stdin','utf8');
            console.log(JSON.parse(d).highlights.length);
          ")
          echo "highlight_count=$COUNT" >> "$GITHUB_OUTPUT"

          echo "### Parsed CHANGELOG v${VERSION}" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Highlights**: ${COUNT}" >> "$GITHUB_STEP_SUMMARY"
          echo '```json' >> "$GITHUB_STEP_SUMMARY"
          echo "$LANDSCAPE" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

  # ============================================================================
  # Job 2: Render videos with Remotion + ffmpeg
  # ============================================================================
  render-videos:
    name: Render Videos
    permissions:
      contents: read
    needs: parse-changelog
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Cache orchestkit-demos node_modules
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306  # v5
        with:
          path: orchestkit-demos/node_modules
          key: demos-${{ runner.os }}-${{ hashFiles('orchestkit-demos/package-lock.json') }}
          restore-keys: demos-${{ runner.os }}-

      - name: Install demo dependencies
        working-directory: orchestkit-demos
        run: npm ci

      - name: Render landscape (16:9)
        working-directory: orchestkit-demos
        env:
          PROPS: ${{ needs.parse-changelog.outputs.landscape-props }}
        run: |
          VERSION="${{ needs.parse-changelog.outputs.version }}"
          mkdir -p ../out

          # Write props to temp file (avoids shell escaping issues)
          echo "$PROPS" > /tmp/landscape-props.json

          # Try version-specific composition first, fallback to template
          SAFE_VERSION=$(echo "$VERSION" | tr -d '.')
          COMP_ID="Production/Landscape-16x9/ReleaseNotes/RN-v${SAFE_VERSION}"

          npx remotion render "$COMP_ID" \
            --props="/tmp/landscape-props.json" \
            --output="../out/landscape-raw.mp4" \
            --codec=h264 \
            --image-format=jpeg \
            --jpeg-quality=90 \
          || npx remotion render "Templates/TPL-ReleaseNotes" \
            --props="/tmp/landscape-props.json" \
            --output="../out/landscape-raw.mp4" \
            --codec=h264 \
            --image-format=jpeg \
            --jpeg-quality=90

      - name: Render square (1:1)
        working-directory: orchestkit-demos
        env:
          PROPS: ${{ needs.parse-changelog.outputs.square-props }}
        run: |
          VERSION="${{ needs.parse-changelog.outputs.version }}"

          echo "$PROPS" > /tmp/square-props.json

          SAFE_VERSION=$(echo "$VERSION" | tr -d '.')
          COMP_ID="Production/Square-1x1/ReleaseNotes/SQ-RN-v${SAFE_VERSION}"

          npx remotion render "$COMP_ID" \
            --props="/tmp/square-props.json" \
            --output="../out/square-raw.mp4" \
            --codec=h264 \
            --image-format=jpeg \
            --jpeg-quality=90 \
          || npx remotion render "Templates/TPL-ReleaseNotes" \
            --props="/tmp/square-props.json" \
            --output="../out/square-raw.mp4" \
            --width=1080 --height=1080 \
            --codec=h264 \
            --image-format=jpeg \
            --jpeg-quality=90

      - name: Compress with ffmpeg
        run: |
          VERSION="${{ needs.parse-changelog.outputs.version }}"

          # Landscape H.264
          ffmpeg -y -i out/landscape-raw.mp4 \
            -c:v libx264 -preset slow -crf 22 \
            -pix_fmt yuv420p -movflags +faststart \
            "out/release-${VERSION}-landscape.mp4"

          # Square H.264
          ffmpeg -y -i out/square-raw.mp4 \
            -c:v libx264 -preset slow -crf 22 \
            -pix_fmt yuv420p -movflags +faststart \
            "out/release-${VERSION}-square.mp4"

          # GIF preview from landscape
          ffmpeg -y -i out/landscape-raw.mp4 \
            -vf "fps=10,scale=480:-1:flags=lanczos,split[s0][s1];[s0]palettegen=max_colors=64[p];[s1][p]paletteuse=dither=bayer:bayer_scale=3" \
            "out/release-${VERSION}-preview.gif"

          # Clean up raw files
          rm -f out/landscape-raw.mp4 out/square-raw.mp4

          # Summary
          echo "### Render Results" >> "$GITHUB_STEP_SUMMARY"
          for f in out/release-${VERSION}-*; do
            SIZE=$(du -h "$f" | cut -f1)
            echo "- **$(basename "$f")**: ${SIZE}" >> "$GITHUB_STEP_SUMMARY"
          done

      - name: Upload video artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: release-videos
          path: |
            out/release-*.mp4
            out/release-*.gif
          retention-days: 30

  # ============================================================================
  # Job 3: Upload to GitHub Release
  # ============================================================================
  upload-to-release:
    name: Upload to Release
    needs: [parse-changelog, render-videos]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Only upload when triggered by an actual release (not manual dispatch)
    if: github.event_name == 'release'
    permissions:
      contents: write
    steps:
      - name: Download video artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7.0.0
        with:
          name: release-videos
          path: out/

      - name: Upload assets to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          VERSION="${{ needs.parse-changelog.outputs.version }}"

          for file in out/release-${VERSION}-*; do
            echo "Uploading $(basename "$file")..."
            gh release upload "$RELEASE_TAG" "$file" \
              --repo "${{ github.repository }}" \
              --clobber
          done

          echo "### Release Assets Uploaded" >> "$GITHUB_STEP_SUMMARY"
          echo "Tag: \`${RELEASE_TAG}\`" >> "$GITHUB_STEP_SUMMARY"
          for f in out/release-${VERSION}-*; do
            echo "- $(basename "$f")" >> "$GITHUB_STEP_SUMMARY"
          done
