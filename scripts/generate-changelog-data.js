#!/usr/bin/env node
/**
 * Parses CHANGELOG.md (Keep a Changelog format) into a typed TypeScript data file.
 * Output: docs/site/lib/generated/changelog-data.ts
 */

const fs = require("fs");
const path = require("path");

const ROOT = path.resolve(__dirname, "..");
const INPUT = path.join(ROOT, "CHANGELOG.md");
const OUTPUT = path.join(ROOT, "docs/site/lib/generated/changelog-data.ts");

const raw = fs.readFileSync(INPUT, "utf-8");
const lines = raw.split("\n");

// Parse link references at the bottom: [VERSION]: url
const linkRefs = {};
for (const line of lines) {
  const m = line.match(/^\[([^\]]+)\]:\s*(.+)$/);
  if (m) linkRefs[m[1]] = m[2].trim();
}

const SECTION_TYPES = new Set([
  "added",
  "fixed",
  "changed",
  "removed",
  "deprecated",
  "security",
]);

const entries = [];
let current = null;
let currentSection = null;

for (const line of lines) {
  // Version header: ## [6.0.16] - 2026-02-16
  const versionMatch = line.match(
    /^## \[([^\]]+)\]\s*-\s*(\d{4}-\d{2}-\d{2})/
  );
  if (versionMatch) {
    if (current) entries.push(current);
    const version = versionMatch[1];
    current = {
      version,
      date: versionMatch[2],
      compareUrl: linkRefs[version] || "",
      sections: [],
    };
    currentSection = null;
    continue;
  }

  // Section header: ### Added, ### Fixed, etc.
  const sectionMatch = line.match(/^### (\w+)/);
  if (sectionMatch && current) {
    const type = sectionMatch[1].toLowerCase();
    if (SECTION_TYPES.has(type)) {
      currentSection = { type, items: [] };
      current.sections.push(currentSection);
    } else {
      currentSection = null;
    }
    continue;
  }

  // Bullet item
  if (line.match(/^- /) && currentSection) {
    currentSection.items.push(line.slice(2));
  } else if (line.match(/^\s+- /) && currentSection && currentSection.items.length > 0) {
    // Sub-bullet — append to last item
    currentSection.items[currentSection.items.length - 1] += "\n" + line;
  }
}

if (current) entries.push(current);

// Filter out Unreleased if it has no sections
const filtered = entries.filter(
  (e) => e.version !== "Unreleased" || e.sections.length > 0
);

// Generate TypeScript output
const ts = `// AUTO-GENERATED by scripts/generate-changelog-data.js
// DO NOT EDIT MANUALLY — your changes will be overwritten.

export type SectionType = "added" | "fixed" | "changed" | "removed" | "deprecated" | "security";

export interface ChangelogSection {
  type: SectionType;
  items: string[];
}

export interface ChangelogEntry {
  version: string;
  date: string;
  compareUrl: string;
  sections: ChangelogSection[];
}

export const CHANGELOG_ENTRIES: ChangelogEntry[] = ${JSON.stringify(filtered, null, 2)};
`;

fs.mkdirSync(path.dirname(OUTPUT), { recursive: true });
fs.writeFileSync(OUTPUT, ts, "utf-8");

console.log(
  `  Generated changelog-data.ts (${filtered.length} versions)`
);
