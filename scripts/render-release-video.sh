#!/usr/bin/env bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-02-06

# render-release-video.sh
#
# Renders ReleaseNotes compositions via Remotion CLI and compresses with ffmpeg.
#
# Usage:
#   ./scripts/render-release-video.sh <version> [output-dir]
#
# Example:
#   ./scripts/render-release-video.sh 6.0.2 out/
#
# Requires:
#   - Node.js 22+
#   - ffmpeg
#   - orchestkit-demos/ with npm dependencies installed

set -euo pipefail

VERSION="${1:?Usage: render-release-video.sh <version> [output-dir]}"
OUTPUT_DIR="${2:-out}"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
DEMOS_DIR="$REPO_ROOT/orchestkit-demos"

# Ensure output directory exists
mkdir -p "$OUTPUT_DIR"

echo "==> Parsing CHANGELOG for v${VERSION}..."

# Generate props JSON
LANDSCAPE_PROPS=$(node "$SCRIPT_DIR/changelog-to-props.mjs" "$VERSION" --landscape)
SQUARE_PROPS=$(node "$SCRIPT_DIR/changelog-to-props.mjs" "$VERSION" --square)

if [ -z "$LANDSCAPE_PROPS" ] || [ -z "$SQUARE_PROPS" ]; then
  echo "ERROR: Failed to parse CHANGELOG for version $VERSION"
  exit 1
fi

echo "==> Parsed $(echo "$LANDSCAPE_PROPS" | node -e "const d=require('fs').readFileSync('/dev/stdin','utf8'); console.log(JSON.parse(d).highlights.length)") highlights"

# Sanitize version for composition IDs (no dots allowed in Remotion)
SAFE_VERSION=$(echo "$VERSION" | tr -d '.')

# ---------- Render 16:9 landscape ----------

echo "==> Rendering 16:9 landscape (1920x1080)..."
LANDSCAPE_RAW="$OUTPUT_DIR/release-${VERSION}-landscape-raw.mp4"
LANDSCAPE_FINAL="$OUTPUT_DIR/release-${VERSION}-landscape.mp4"

cd "$DEMOS_DIR"
npx remotion render \
  "Production/Landscape-16x9/ReleaseNotes/RN-v${SAFE_VERSION}" \
  --props="$LANDSCAPE_PROPS" \
  --output="$LANDSCAPE_RAW" \
  --codec=h264 \
  --image-format=jpeg \
  --jpeg-quality=90 \
  2>&1 || {
    # If specific version composition doesn't exist, use the template
    echo "==> Version-specific composition not found, using template..."
    npx remotion render \
      "Templates/TPL-ReleaseNotes" \
      --props="$LANDSCAPE_PROPS" \
      --output="$LANDSCAPE_RAW" \
      --codec=h264 \
      --image-format=jpeg \
      --jpeg-quality=90
  }
cd "$REPO_ROOT"

# Compress with ffmpeg
echo "==> Compressing landscape with ffmpeg..."
ffmpeg -y -i "$LANDSCAPE_RAW" \
  -c:v libx264 -preset slow -crf 22 \
  -pix_fmt yuv420p \
  -movflags +faststart \
  "$LANDSCAPE_FINAL" 2>/dev/null

rm -f "$LANDSCAPE_RAW"
echo "==> Landscape: $LANDSCAPE_FINAL ($(du -h "$LANDSCAPE_FINAL" | cut -f1))"

# ---------- Render 1:1 square ----------

echo "==> Rendering 1:1 square (1080x1080)..."
SQUARE_RAW="$OUTPUT_DIR/release-${VERSION}-square-raw.mp4"
SQUARE_FINAL="$OUTPUT_DIR/release-${VERSION}-square.mp4"

cd "$DEMOS_DIR"
npx remotion render \
  "Production/Square-1x1/ReleaseNotes/SQ-RN-v${SAFE_VERSION}" \
  --props="$SQUARE_PROPS" \
  --output="$SQUARE_RAW" \
  --codec=h264 \
  --image-format=jpeg \
  --jpeg-quality=90 \
  2>&1 || {
    echo "==> Version-specific square composition not found, using template..."
    npx remotion render \
      "Templates/TPL-ReleaseNotes" \
      --props="$SQUARE_PROPS" \
      --output="$SQUARE_RAW" \
      --width=1080 --height=1080 \
      --codec=h264 \
      --image-format=jpeg \
      --jpeg-quality=90
  }
cd "$REPO_ROOT"

# Compress
echo "==> Compressing square with ffmpeg..."
ffmpeg -y -i "$SQUARE_RAW" \
  -c:v libx264 -preset slow -crf 22 \
  -pix_fmt yuv420p \
  -movflags +faststart \
  "$SQUARE_FINAL" 2>/dev/null

rm -f "$SQUARE_RAW"
echo "==> Square: $SQUARE_FINAL ($(du -h "$SQUARE_FINAL" | cut -f1))"

# ---------- Generate GIF preview ----------

echo "==> Generating GIF preview..."
GIF_FINAL="$OUTPUT_DIR/release-${VERSION}-preview.gif"

ffmpeg -y -i "$LANDSCAPE_FINAL" \
  -vf "fps=10,scale=480:-1:flags=lanczos,split[s0][s1];[s0]palettegen=max_colors=64[p];[s1][p]paletteuse=dither=bayer:bayer_scale=3" \
  "$GIF_FINAL" 2>/dev/null

echo "==> GIF: $GIF_FINAL ($(du -h "$GIF_FINAL" | cut -f1))"

# ---------- Summary ----------

echo ""
echo "=== Release Video Artifacts ==="
echo "  Landscape : $LANDSCAPE_FINAL"
echo "  Square    : $SQUARE_FINAL"
echo "  GIF       : $GIF_FINAL"
echo ""
echo "Done."
