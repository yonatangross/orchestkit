<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OrchestKit Marketplace Explorer</title>
<link rel="stylesheet" href="nav.css">
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --surface2: #1c2128;
    --border: #30363d;
    --text: #e6edf3;
    --text-muted: #8b949e;
    --accent: #8b5cf6;
    --accent2: #22c55e;
    --accent3: #06b6d4;
    --accent4: #f59e0b;
    --accent5: #f97316;
    --accent6: #ec4899;
    --accent7: #ef4444;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Header */
  .header {
    background: linear-gradient(135deg, #1a1040 0%, #0d1117 50%, #0a1628 100%);
    border-bottom: 1px solid var(--border);
    padding: 24px 32px;
    position: sticky;
    top: 48px;
    z-index: 100;
  }
  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }
  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .logo-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--accent), var(--accent3));
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
    color: white;
  }
  .logo h1 {
    font-size: 22px;
    font-weight: 700;
    background: linear-gradient(135deg, var(--accent), var(--accent3));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .logo .version {
    font-size: 12px;
    color: var(--text-muted);
    background: var(--surface2);
    padding: 2px 8px;
    border-radius: 4px;
    margin-left: 8px;
  }

  /* Stats bar */
  .stats-bar {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
  }
  .stat {
    display: flex;
    align-items: baseline;
    gap: 6px;
  }
  .stat-value {
    font-size: 28px;
    font-weight: 800;
    font-variant-numeric: tabular-nums;
  }
  .stat-label {
    font-size: 13px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Search + Filters */
  .controls {
    padding: 16px 32px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
  }
  .search-box {
    flex: 1;
    min-width: 250px;
    position: relative;
  }
  .search-box input {
    width: 100%;
    padding: 10px 14px 10px 38px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
  }
  .search-box input:focus { border-color: var(--accent); }
  .search-box::before {
    content: '\1F50D';
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
    opacity: 0.5;
  }
  #categoryFilters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .filter-btn {
    padding: 8px 16px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-muted);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .filter-btn:hover { border-color: var(--accent); color: var(--text); }
  .filter-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }
  .view-toggle {
    display: flex;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }
  .view-btn {
    padding: 8px 14px;
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .view-btn.active { background: var(--accent); color: white; }
  .view-btn:hover:not(.active) { color: var(--text); }

  /* Main content */
  .main { padding: 24px 32px; }

  /* GRID VIEW */
  .grid-view {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 16px;
  }
  .plugin-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  .plugin-card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(139, 92, 246, 0.15);
  }
  .plugin-card.expanded {
    grid-column: 1 / -1;
  }
  .card-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  .card-name {
    font-size: 16px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .card-category {
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .card-desc {
    font-size: 13px;
    color: var(--text-muted);
    line-height: 1.5;
    margin-bottom: 14px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .card-metrics {
    display: flex;
    gap: 16px;
  }
  .card-metric {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 13px;
  }
  .card-metric .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }
  .card-metric .count {
    font-weight: 700;
    font-variant-numeric: tabular-nums;
  }
  .card-metric .label {
    color: var(--text-muted);
  }

  /* Card expanded content */
  .card-details {
    display: none;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
  }
  .plugin-card.expanded .card-details { display: block; }
  .plugin-card.expanded .card-desc {
    -webkit-line-clamp: unset;
    overflow: visible;
  }
  .detail-section {
    margin-bottom: 14px;
  }
  .detail-section h4 {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    margin-bottom: 8px;
  }
  .tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .tag {
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 6px;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'SF Mono', 'Fira Code', monospace;
    transition: all 0.15s;
    cursor: default;
  }
  .tag:hover {
    border-color: var(--accent);
    background: rgba(139, 92, 246, 0.1);
  }
  .tag.agent-tag {
    border-color: rgba(34, 197, 94, 0.3);
    background: rgba(34, 197, 94, 0.08);
  }
  .tag.agent-tag:hover {
    border-color: var(--accent2);
    background: rgba(34, 197, 94, 0.15);
  }
  .tag.command-tag {
    border-color: rgba(6, 182, 212, 0.3);
    background: rgba(6, 182, 212, 0.08);
  }

  /* TREEMAP VIEW */
  .treemap-view { display: none; }
  .treemap-container {
    width: 100%;
    aspect-ratio: 16/9;
    max-height: 70vh;
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border);
  }
  .treemap-cell {
    position: absolute;
    border: 1px solid rgba(255,255,255,0.08);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    overflow: hidden;
    padding: 4px;
  }
  .treemap-cell:hover {
    z-index: 10;
    filter: brightness(1.3);
    border-color: white;
  }
  .treemap-cell .cell-name {
    font-size: 11px;
    font-weight: 700;
    text-align: center;
    color: white;
    text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    line-height: 1.2;
  }
  .treemap-cell .cell-count {
    font-size: 18px;
    font-weight: 800;
    color: white;
    text-shadow: 0 1px 3px rgba(0,0,0,0.8);
  }

  /* GRAPH VIEW */
  .graph-view { display: none; }
  .graph-container {
    width: 100%;
    height: 75vh;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border);
    background: var(--bg);
    position: relative;
  }
  .graph-canvas {
    width: 100%;
    height: 100%;
  }

  /* AGENTS VIEW */
  .agents-view { display: none; }
  .agents-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 12px;
  }
  .agent-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    transition: all 0.2s;
  }
  .agent-card:hover {
    border-color: var(--accent2);
    transform: translateY(-1px);
  }
  .agent-name {
    font-size: 15px;
    font-weight: 700;
    color: var(--accent2);
    margin-bottom: 6px;
    font-family: 'SF Mono', 'Fira Code', monospace;
  }
  .agent-desc {
    font-size: 12px;
    color: var(--text-muted);
    line-height: 1.5;
    margin-bottom: 10px;
  }
  .agent-plugins {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }
  .agent-plugin-tag {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    background: rgba(139, 92, 246, 0.15);
    color: var(--accent);
    font-family: 'SF Mono', 'Fira Code', monospace;
  }

  /* Category colors */
  .cat-development { background: rgba(139, 92, 246, 0.15); color: var(--accent); border: 1px solid rgba(139, 92, 246, 0.3); }
  .cat-ai { background: rgba(6, 182, 212, 0.15); color: var(--accent3); border: 1px solid rgba(6, 182, 212, 0.3); }
  .cat-backend { background: rgba(245, 158, 11, 0.15); color: var(--accent4); border: 1px solid rgba(245, 158, 11, 0.3); }
  .cat-frontend { background: rgba(236, 72, 153, 0.15); color: var(--accent6); border: 1px solid rgba(236, 72, 153, 0.3); }
  .cat-testing { background: rgba(34, 197, 94, 0.15); color: var(--accent2); border: 1px solid rgba(34, 197, 94, 0.3); }
  .cat-security { background: rgba(239, 68, 68, 0.15); color: var(--accent7); border: 1px solid rgba(239, 68, 68, 0.3); }
  .cat-devops { background: rgba(249, 115, 22, 0.15); color: var(--accent5); border: 1px solid rgba(249, 115, 22, 0.3); }
  .cat-product { background: rgba(168, 85, 247, 0.15); color: #a855f7; border: 1px solid rgba(168, 85, 247, 0.3); }
  .cat-accessibility { background: rgba(20, 184, 166, 0.15); color: #14b8a6; border: 1px solid rgba(20, 184, 166, 0.3); }
  .cat-data { background: rgba(99, 102, 241, 0.15); color: #6366f1; border: 1px solid rgba(99, 102, 241, 0.3); }

  /* Tooltip */
  .tooltip {
    position: fixed;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 13px;
    max-width: 300px;
    pointer-events: none;
    z-index: 1000;
    display: none;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  }
  .tooltip-name {
    font-weight: 700;
    margin-bottom: 4px;
  }
  .tooltip-desc {
    color: var(--text-muted);
    font-size: 12px;
    line-height: 1.4;
  }

  /* Inline Detail Expansion */
  .tag-detail {
    display: none;
    margin-top: 10px;
    padding: 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    animation: slideDown 0.2s ease;
  }
  .tag-detail.visible { display: block; }
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .tag-detail-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .tag-detail-title {
    font-size: 14px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .tag-detail-type {
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 4px;
    text-transform: uppercase;
    font-weight: 600;
  }
  .tag-detail-type.skill { background: rgba(6, 182, 212, 0.15); color: var(--accent3); }
  .tag-detail-type.agent { background: rgba(34, 197, 94, 0.15); color: var(--accent2); }
  .tag-detail-type.command { background: rgba(139, 92, 246, 0.15); color: var(--accent); }
  .tag-detail-close {
    width: 20px;
    height: 20px;
    border-radius: 4px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-muted);
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .tag-detail-close:hover { border-color: var(--accent7); color: var(--accent7); }
  .tag-detail-desc {
    font-size: 12px;
    color: var(--text-muted);
    line-height: 1.5;
    margin-bottom: 10px;
  }
  .tag-detail-row {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    margin-bottom: 6px;
    font-size: 11px;
  }
  .tag-detail-label {
    color: var(--text-muted);
    min-width: 60px;
    flex-shrink: 0;
  }
  .tag-detail-value {
    color: var(--text);
    font-family: 'SF Mono', 'Fira Code', monospace;
  }
  .tag-detail-plugins {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }
  .tag-detail-plugin {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.2);
    color: var(--accent);
    font-family: 'SF Mono', 'Fira Code', monospace;
  }
  .tag-detail-doc-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin-top: 10px;
    padding: 6px 12px;
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 6px;
    color: var(--accent);
    font-size: 12px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;
  }
  .tag-detail-doc-link:hover {
    background: rgba(139, 92, 246, 0.2);
    border-color: var(--accent);
  }

  /* Legend */
  .legend {
    display: flex;
    gap: 16px;
    padding: 12px 0;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--text-muted);
  }
  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 3px;
  }

  /* Prompt output */
  .prompt-section {
    margin-top: 24px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
  }
  .prompt-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .prompt-header h3 {
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
  }
  .copy-btn {
    padding: 6px 14px;
    background: var(--accent);
    border: none;
    border-radius: 6px;
    color: white;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  .copy-btn:hover { filter: brightness(1.15); }
  .copy-btn.copied {
    background: var(--accent2);
  }
  .prompt-output {
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 13px;
    line-height: 1.6;
    color: var(--text);
    white-space: pre-wrap;
    word-break: break-word;
  }

  @media (max-width: 768px) {
    .header, .controls, .main { padding-left: 16px; padding-right: 16px; }
    .stats-bar { gap: 16px; }
    .stat-value { font-size: 22px; }
    .grid-view { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<nav class="ork-breadcrumbs" id="breadcrumbs" aria-label="Breadcrumb"></nav>

<div class="header">
  <div class="header-top">
    <div class="logo">
      <div class="logo-icon">ork</div>
      <h1>OrchestKit Marketplace<span class="version">v5.5.0</span></h1>
    </div>
  </div>
  <div class="stats-bar" id="statsBar"></div>
</div>

<div class="controls">
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Search plugins, skills, agents...">
  </div>
  <div id="categoryFilters"></div>
  <div class="view-toggle">
    <button class="view-btn active" data-view="grid">Grid</button>
    <button class="view-btn" data-view="treemap">Treemap</button>
    <button class="view-btn" data-view="agents">Agents</button>
  </div>
</div>

<div class="main">
  <div class="legend" id="legend"></div>
  <div class="grid-view" id="gridView"></div>
  <div class="treemap-view" id="treemapView">
    <div class="treemap-container" id="treemapContainer"></div>
  </div>
  <div class="agents-view" id="agentsView">
    <div class="agents-grid" id="agentsGrid"></div>
  </div>
  <div class="graph-view" id="graphView">
    <div class="graph-container">
      <canvas class="graph-canvas" id="graphCanvas"></canvas>
    </div>
  </div>
  <div class="prompt-section">
    <div class="prompt-header">
      <h3>Install Command</h3>
      <button class="copy-btn" id="copyBtn" onclick="copyPrompt()">Copy</button>
    </div>
    <div class="prompt-output" id="promptOutput"></div>
  </div>
</div>

<div class="tooltip" id="tooltip">
  <div class="tooltip-name" id="tooltipName"></div>
  <div class="tooltip-desc" id="tooltipDesc"></div>
</div>

<script src="data.js"></script>
<script src="nav.js"></script>
<script>
// Compatibility shim: map shared data to local variable names
var PLUGINS = ORCHESTKIT_DATA.plugins.map(function(p) {
  return { name: p.name, desc: p.description, category: p.category, version: p.version,
    skills: p.skills, agents: p.agents, hooks: p.hooks, commands: p.commands,
    skillCount: p.skillCount, commandCount: p.commandCount };
});
var AGENTS = ORCHESTKIT_DATA.agents.map(function(a) {
  return { name: a.name, desc: a.description, plugins: a.plugins };
});
var CAT_COLORS = {};
Object.keys(ORCHESTKIT_DATA.categories).forEach(function(k) {
  CAT_COLORS[k] = { bg: ORCHESTKIT_DATA.categories[k].color, label: ORCHESTKIT_DATA.categories[k].label };
});

// Initialize from URL parameters
var urlParams = window.orkUrl ? window.orkUrl.getParams() : {};

// State
var state = {
  search: urlParams.search || '',
  category: urlParams.category || 'all',
  view: urlParams.view || 'grid',
  expandedCard: null,
  selectedPlugins: new Set(),
};

// Sync state to URL
function syncToUrl() {
  if (!window.orkUrl) return;
  var params = {};
  if (state.search) params.search = state.search;
  if (state.category !== 'all') params.category = state.category;
  if (state.view !== 'grid') params.view = state.view;
  window.orkUrl.setParams(params);
}

// Update breadcrumbs
function updateBreadcrumbs() {
  if (!window.orkBreadcrumbs) return;
  window.orkBreadcrumbs.render('breadcrumbs', 'marketplace-explorer.html', null);
}

// Computed
function getFilteredPlugins() {
  return PLUGINS.filter(function(p) {
    if (state.category !== 'all' && p.category !== state.category) return false;
    if (state.search) {
      var q = state.search.toLowerCase();
      return p.name.toLowerCase().indexOf(q) !== -1 ||
             p.desc.toLowerCase().indexOf(q) !== -1 ||
             p.skills.some(function(s) { return s.toLowerCase().indexOf(q) !== -1; }) ||
             p.agents.some(function(a) { return a.toLowerCase().indexOf(q) !== -1; });
    }
    return true;
  });
}

function getTotals() {
  // Use pre-calculated totals from data.js (avoids double-counting shared components)
  return ORCHESTKIT_DATA.totals;
}

// Render stats
function renderStats() {
  var t = getTotals();
  document.getElementById('statsBar').innerHTML =
    '<div class="stat"><span class="stat-value" style="color:var(--accent)">' + t.plugins + '</span><span class="stat-label">Plugins</span></div>' +
    '<div class="stat"><span class="stat-value" style="color:var(--accent3)">' + t.skills + '</span><span class="stat-label">Skills</span></div>' +
    '<div class="stat"><span class="stat-value" style="color:var(--accent2)">' + t.agents + '</span><span class="stat-label">Agents</span></div>' +
    '<div class="stat"><span class="stat-value" style="color:var(--accent4)">' + t.hooks + '</span><span class="stat-label">Hooks</span></div>' +
    '<div class="stat"><span class="stat-value" style="color:var(--accent5)">' + t.commands + '</span><span class="stat-label">Commands</span></div>';
}

// Render filters
function renderFilters() {
  var catMap = {};
  PLUGINS.forEach(function(p) { catMap[p.category] = true; });
  var cats = Object.keys(catMap);
  var el = document.getElementById('categoryFilters');
  el.innerHTML = '<button class="filter-btn ' + (state.category === 'all' ? 'active' : '') + '" onclick="setCategory(\'all\')">All</button>' +
    cats.map(function(c) {
      var catInfo = CAT_COLORS[c];
      var label = catInfo ? catInfo.label : c;
      return '<button class="filter-btn ' + (state.category === c ? 'active' : '') + '" onclick="setCategory(\'' + c + '\')">' + label + '</button>';
    }).join('');
}

// Render legend
function renderLegend() {
  var el = document.getElementById('legend');
  var keys = Object.keys(CAT_COLORS);
  el.innerHTML = keys.map(function(k) {
    var v = CAT_COLORS[k];
    return '<div class="legend-item"><div class="legend-dot" style="background:' + v.bg + '"></div>' + v.label + '</div>';
  }).join('');
}

// Grid view
function renderGrid() {
  var plugins = getFilteredPlugins();
  var el = document.getElementById('gridView');
  el.innerHTML = plugins.map(function(p) {
    var catColor = CAT_COLORS[p.category] || { bg: '#666', label: p.category };
    var expanded = state.expandedCard === p.name;
    var skillCount = p.skillCount || p.skills.length;
    var cmdCount = p.commandCount || p.commands.length;
    var hooksHtml = p.hooks ? '<div class="card-metric"><div class="dot" style="background:var(--accent4)"></div><span class="count">' + p.hooks + '</span><span class="label">hooks</span></div>' : '';
    var cmdsHtml = cmdCount ? '<div class="card-metric"><div class="dot" style="background:var(--accent5)"></div><span class="count">' + cmdCount + '</span><span class="label">cmds</span></div>' : '';
    var skillsSection = p.skills.length ? '<div class="detail-section"><h4>Skills (' + skillCount + ' total, showing ' + p.skills.length + ')</h4><div class="tag-list">' + p.skills.map(function(s) { return '<span class="tag" onclick="event.stopPropagation();showDetail(\'skill\',\'' + s + '\',this)" style="cursor:pointer">' + s + '</span>'; }).join('') + '</div><div class="tag-detail" id="detail-skill-' + p.name + '"></div></div>' : '';
    var agentsSection = p.agents.length ? '<div class="detail-section"><h4>Agents (' + p.agents.length + ')</h4><div class="tag-list">' + p.agents.map(function(a) { return '<span class="tag agent-tag" onclick="event.stopPropagation();showDetail(\'agent\',\'' + a + '\',this)" style="cursor:pointer">' + a + '</span>'; }).join('') + '</div><div class="tag-detail" id="detail-agent-' + p.name + '"></div></div>' : '';
    var commandsSection = p.commands.length ? '<div class="detail-section"><h4>Commands (' + cmdCount + ')</h4><div class="tag-list">' + p.commands.map(function(c) { return '<span class="tag command-tag" onclick="event.stopPropagation();showDetail(\'command\',\'' + c + '\',this)" style="cursor:pointer">/ork:' + c + '</span>'; }).join('') + '</div><div class="tag-detail" id="detail-command-' + p.name + '"></div></div>' : '';
    return '<div class="plugin-card ' + (expanded ? 'expanded' : '') + '" onclick="toggleCard(\'' + p.name + '\')">' +
        '<div class="card-header">' +
          '<div class="card-name">' + p.name + '</div>' +
          '<span class="card-category cat-' + p.category + '">' + catColor.label + '</span>' +
        '</div>' +
        '<div class="card-desc">' + p.desc + '</div>' +
        '<div class="card-metrics">' +
          '<div class="card-metric"><div class="dot" style="background:var(--accent3)"></div><span class="count">' + skillCount + '</span><span class="label">skills</span></div>' +
          '<div class="card-metric"><div class="dot" style="background:var(--accent2)"></div><span class="count">' + p.agents.length + '</span><span class="label">agents</span></div>' +
          hooksHtml + cmdsHtml +
        '</div>' +
        '<div class="card-details">' +
          skillsSection + agentsSection + commandsSection +
        '</div>' +
      '</div>';
  }).join('');
}

// Treemap view
function renderTreemap() {
  var plugins = getFilteredPlugins();
  var container = document.getElementById('treemapContainer');
  var W = container.clientWidth;
  var H = container.clientHeight;
  if (!W || !H) return;

  // Sort by total component count
  var sorted = plugins.slice().map(function(p) {
    var skillCount = p.skillCount || p.skills.length;
    return {
      name: p.name, desc: p.desc, category: p.category, version: p.version,
      skills: p.skills, agents: p.agents, hooks: p.hooks, commands: p.commands,
      skillCount: skillCount,
      total: skillCount + p.agents.length + (p.hooks ? 10 : 0)
    };
  }).sort(function(a, b) { return b.total - a.total; });

  var totalArea = sorted.reduce(function(s, p) { return s + p.total; }, 0);

  // Simple squarified treemap
  var cells = [];
  var x = 0, y = 0, w = W, h = H;
  var remaining = sorted.slice();

  function layoutRow(row, rowTotal, isVertical, rx, ry, rw, rh) {
    var offset = 0;
    var dimMain = isVertical ? rh : rw;
    var dimCross = isVertical ? rw : rh;
    var crossSize = (rowTotal / totalArea) * (isVertical ? W : H);

    row.forEach(function(item) {
      var frac = item.total / rowTotal;
      var mainSize = frac * dimMain;
      cells.push({
        x: isVertical ? rx : rx + offset,
        y: isVertical ? ry + offset : ry,
        w: isVertical ? crossSize : mainSize,
        h: isVertical ? mainSize : crossSize,
        plugin: item,
      });
      offset += mainSize;
    });

    return crossSize;
  }

  // Simple strip layout
  var cx = 0, cy = 0, cw = W, ch = H;
  var isVertical = cw >= ch;

  while (remaining.length > 0) {
    var row = [remaining.shift()];
    var rowTotal = row[0].total;

    while (remaining.length > 0) {
      var candidate = remaining[0];
      var newTotal = rowTotal + candidate.total;
      // Check aspect ratio improvement
      var dimMain = isVertical ? ch : cw;
      var dimCross = isVertical ? cw : ch;
      var crossCurrent = (rowTotal / totalArea) * (isVertical ? W : H);
      var crossNew = (newTotal / totalArea) * (isVertical ? W : H);

      var worstCurrent = Math.max.apply(null, row.map(function(r) {
        var mainSize = (r.total / rowTotal) * dimMain;
        return Math.max(mainSize / crossCurrent, crossCurrent / mainSize);
      }));
      var rowWithCandidate = row.concat([candidate]);
      var worstNew = Math.max.apply(null, rowWithCandidate.map(function(r) {
        var mainSize = (r.total / newTotal) * dimMain;
        return Math.max(mainSize / crossNew, crossNew / mainSize);
      }));

      if (worstNew <= worstCurrent) {
        row.push(remaining.shift());
        rowTotal = newTotal;
      } else break;
    }

    var crossSize = layoutRow(row, rowTotal, isVertical, cx, cy, cw, ch);
    if (isVertical) { cx += crossSize; cw -= crossSize; }
    else { cy += crossSize; ch -= crossSize; }
    isVertical = cw >= ch;
  }

  container.innerHTML = cells.map(function(c) {
    var cat = CAT_COLORS[c.plugin.category] || { bg: '#666' };
    var showLabel = c.w > 60 && c.h > 40;
    var showCount = c.w > 40 && c.h > 30;
    var countHtml = showCount ? '<span class="cell-count">' + (c.plugin.skillCount + c.plugin.agents.length) + '</span>' : '';
    var labelHtml = showLabel ? '<span class="cell-name">' + c.plugin.name.replace('ork-', '') + '</span>' : '';
    return '<div class="treemap-cell" style="left:' + c.x + 'px;top:' + c.y + 'px;width:' + c.w + 'px;height:' + c.h + 'px;background:' + cat.bg + '88;"' +
      ' onmouseenter="showTooltip(event,\'' + c.plugin.name + '\',\'' + c.plugin.skillCount + ' skills, ' + c.plugin.agents.length + ' agents\')"' +
      ' onmouseleave="hideTooltip()"' +
      ' onclick="setSearch(\'' + c.plugin.name + '\');setView(\'grid\')">' +
      countHtml + labelHtml +
    '</div>';
  }).join('');
}

// Agents view
function renderAgents() {
  var q = state.search.toLowerCase();
  var filtered = AGENTS.filter(function(a) {
    if (state.category !== 'all') {
      return a.plugins.some(function(p) {
        var plugin = PLUGINS.filter(function(pl) { return pl.name === p; })[0];
        return plugin && plugin.category === state.category;
      });
    }
    if (q) {
      return a.name.indexOf(q) !== -1 || a.desc.toLowerCase().indexOf(q) !== -1 || a.plugins.some(function(p) { return p.indexOf(q) !== -1; });
    }
    return true;
  });

  document.getElementById('agentsGrid').innerHTML = filtered.map(function(a) {
    var pluginTags = a.plugins.map(function(p) { return '<span class="agent-plugin-tag">' + p + '</span>'; }).join('');
    return '<div class="agent-card">' +
      '<div class="agent-name">' + a.name + '</div>' +
      '<div class="agent-desc">' + a.desc + '</div>' +
      '<div class="agent-plugins">' + pluginTags + '</div>' +
    '</div>';
  }).join('');
}

// Graph view - force-directed
function renderGraph() {
  var canvas = document.getElementById('graphCanvas');
  var ctx = canvas.getContext('2d');
  var rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * 2;
  canvas.height = rect.height * 2;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  ctx.scale(2, 2);

  var W = rect.width;
  var H = rect.height;
  var centerX = W / 2;
  var centerY = H / 2;

  // Build nodes
  var nodes = [];
  var edges = [];

  // Plugin nodes
  var filteredPlugins = getFilteredPlugins();
  filteredPlugins.forEach(function(p, i) {
    var angle = (i / filteredPlugins.length) * Math.PI * 2 - Math.PI / 2;
    var radius = Math.min(W, H) * 0.35;
    var catInfo = CAT_COLORS[p.category];
    nodes.push({
      id: p.name,
      type: 'plugin',
      x: centerX + Math.cos(angle) * radius,
      y: centerY + Math.sin(angle) * radius,
      vx: 0, vy: 0,
      size: 6 + Math.sqrt(p.skills.length + p.agents.length) * 2.5,
      color: catInfo ? catInfo.bg : '#666',
      label: p.name.replace('ork-', ''),
      data: p,
    });
  });

  // Shared agent edges
  var agentPluginMap = {};
  filteredPlugins.forEach(function(p) {
    p.agents.forEach(function(a) {
      if (!agentPluginMap[a]) agentPluginMap[a] = [];
      agentPluginMap[a].push(p.name);
    });
  });

  var agentKeys = Object.keys(agentPluginMap);
  agentKeys.forEach(function(agent) {
    var pluginNames = agentPluginMap[agent];
    if (pluginNames.length > 1) {
      for (var i = 0; i < pluginNames.length; i++) {
        for (var j = i + 1; j < pluginNames.length; j++) {
          edges.push({ from: pluginNames[i], to: pluginNames[j], agent: agent });
        }
      }
    }
  });

  // Simple force simulation
  function simulate() {
    for (var iter = 0; iter < 100; iter++) {
      // Repulsion
      for (var i = 0; i < nodes.length; i++) {
        for (var j = i + 1; j < nodes.length; j++) {
          var dx = nodes[j].x - nodes[i].x;
          var dy = nodes[j].y - nodes[i].y;
          var dist = Math.max(Math.sqrt(dx * dx + dy * dy), 1);
          var force = 2000 / (dist * dist);
          var fx = (dx / dist) * force;
          var fy = (dy / dist) * force;
          nodes[i].vx -= fx;
          nodes[i].vy -= fy;
          nodes[j].vx += fx;
          nodes[j].vy += fy;
        }
      }

      // Attraction (edges)
      edges.forEach(function(e) {
        var a = nodes.filter(function(n) { return n.id === e.from; })[0];
        var b = nodes.filter(function(n) { return n.id === e.to; })[0];
        if (!a || !b) return;
        var dx = b.x - a.x;
        var dy = b.y - a.y;
        var dist = Math.sqrt(dx * dx + dy * dy);
        var force = (dist - 120) * 0.01;
        var fx = (dx / dist) * force;
        var fy = (dy / dist) * force;
        a.vx += fx;
        a.vy += fy;
        b.vx -= fx;
        b.vy -= fy;
      });

      // Center gravity
      nodes.forEach(function(n) {
        n.vx += (centerX - n.x) * 0.003;
        n.vy += (centerY - n.y) * 0.003;
        n.x += n.vx * 0.3;
        n.y += n.vy * 0.3;
        n.vx *= 0.8;
        n.vy *= 0.8;
        // Bounds
        n.x = Math.max(50, Math.min(W - 50, n.x));
        n.y = Math.max(50, Math.min(H - 50, n.y));
      });
    }
  }

  simulate();

  // Draw
  ctx.clearRect(0, 0, W, H);

  // Edges
  edges.forEach(function(e) {
    var a = nodes.filter(function(n) { return n.id === e.from; })[0];
    var b = nodes.filter(function(n) { return n.id === e.to; })[0];
    if (!a || !b) return;
    ctx.beginPath();
    ctx.moveTo(a.x, a.y);
    ctx.lineTo(b.x, b.y);
    ctx.strokeStyle = 'rgba(139, 92, 246, 0.25)';
    ctx.lineWidth = 1.5;
    ctx.stroke();
    // Agent label on edge
    var mx = (a.x + b.x) / 2;
    var my = (a.y + b.y) / 2;
    ctx.fillStyle = 'rgba(34, 197, 94, 0.6)';
    ctx.font = '9px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText(e.agent, mx, my - 4);
  });

  // Nodes
  nodes.forEach(function(n) {
    // Glow
    var gradient = ctx.createRadialGradient(n.x, n.y, 0, n.x, n.y, n.size * 2);
    gradient.addColorStop(0, n.color + '40');
    gradient.addColorStop(1, 'transparent');
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(n.x, n.y, n.size * 2, 0, Math.PI * 2);
    ctx.fill();

    // Circle
    ctx.beginPath();
    ctx.arc(n.x, n.y, n.size, 0, Math.PI * 2);
    ctx.fillStyle = n.color;
    ctx.fill();
    ctx.strokeStyle = n.color + '80';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Label
    ctx.fillStyle = '#e6edf3';
    ctx.font = 'bold 11px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText(n.label, n.x, n.y + n.size + 14);

    // Count
    ctx.fillStyle = 'white';
    ctx.font = 'bold 9px system-ui';
    ctx.fillText(n.data.skills.length, n.x, n.y + 3);
  });
}

// Tooltip
function showTooltip(e, name, desc) {
  var tt = document.getElementById('tooltip');
  document.getElementById('tooltipName').textContent = name;
  document.getElementById('tooltipDesc').textContent = desc;
  tt.style.display = 'block';
  tt.style.left = (e.clientX + 12) + 'px';
  tt.style.top = (e.clientY + 12) + 'px';
}
function hideTooltip() {
  document.getElementById('tooltip').style.display = 'none';
}

// Inline detail expansion for skills/agents/commands
var currentDetailEl = null;

function showDetail(type, name, clickedTag) {
  // Find the detail container (sibling of the tag-list)
  var tagList = clickedTag.parentElement;
  var detailEl = tagList.nextElementSibling;

  // If clicking same item, toggle off
  if (currentDetailEl === detailEl && detailEl.classList.contains('visible')) {
    detailEl.classList.remove('visible');
    currentDetailEl = null;
    return;
  }

  // Close any other open detail
  if (currentDetailEl && currentDetailEl !== detailEl) {
    currentDetailEl.classList.remove('visible');
  }

  var content = '';
  var docUrl = '';

  if (type === 'skill') {
    var containingPlugins = PLUGINS.filter(function(p) {
      return p.skills.indexOf(name) !== -1;
    }).map(function(p) { return p.name; });
    docUrl = 'https://github.com/yonatangross/orchestkit/blob/main/src/skills/' + name + '/SKILL.md';

    content = '<div class="tag-detail-header">' +
      '<div class="tag-detail-title"><span class="tag-detail-type skill">Skill</span>' + name + '</div>' +
      '<button class="tag-detail-close" onclick="event.stopPropagation();closeDetail()">&times;</button>' +
    '</div>' +
    '<div class="tag-detail-desc">Patterns and guidance for ' + name.replace(/-/g, ' ') + '.</div>' +
    '<div class="tag-detail-row"><span class="tag-detail-label">Plugins:</span><div class="tag-detail-plugins">' +
      containingPlugins.map(function(p) { return '<span class="tag-detail-plugin">' + p + '</span>'; }).join('') +
    '</div></div>' +
    '<div class="tag-detail-row"><span class="tag-detail-label">Usage:</span><span class="tag-detail-value">Auto-injected when relevant</span></div>' +
    '<a class="tag-detail-doc-link" href="' + docUrl + '" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">View Documentation &rarr;</a>';

  } else if (type === 'agent') {
    var agent = AGENTS.filter(function(a) { return a.name === name; })[0];
    var desc = agent ? agent.desc : 'Specialized agent for ' + name.replace(/-/g, ' ') + ' tasks.';
    var plugins = agent ? agent.plugins : [];
    docUrl = 'https://github.com/yonatangross/orchestkit/blob/main/src/agents/' + name + '.md';

    content = '<div class="tag-detail-header">' +
      '<div class="tag-detail-title"><span class="tag-detail-type agent">Agent</span>' + name + '</div>' +
      '<button class="tag-detail-close" onclick="event.stopPropagation();closeDetail()">&times;</button>' +
    '</div>' +
    '<div class="tag-detail-desc">' + desc + '</div>' +
    (plugins.length ? '<div class="tag-detail-row"><span class="tag-detail-label">Plugins:</span><div class="tag-detail-plugins">' +
      plugins.map(function(p) { return '<span class="tag-detail-plugin">' + p + '</span>'; }).join('') +
    '</div></div>' : '') +
    '<div class="tag-detail-row"><span class="tag-detail-label">Invoke:</span><span class="tag-detail-value">Task(subagent_type="' + name + '")</span></div>' +
    '<a class="tag-detail-doc-link" href="' + docUrl + '" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">View Documentation &rarr;</a>';

  } else if (type === 'command') {
    var containingPlugins = PLUGINS.filter(function(p) {
      return p.commands.indexOf(name) !== -1;
    }).map(function(p) { return p.name; });
    docUrl = 'https://github.com/yonatangross/orchestkit/blob/main/src/skills/' + name + '/SKILL.md';

    content = '<div class="tag-detail-header">' +
      '<div class="tag-detail-title"><span class="tag-detail-type command">Command</span>/ork:' + name + '</div>' +
      '<button class="tag-detail-close" onclick="event.stopPropagation();closeDetail()">&times;</button>' +
    '</div>' +
    '<div class="tag-detail-desc">User-invocable skill triggered directly.</div>' +
    '<div class="tag-detail-row"><span class="tag-detail-label">Plugins:</span><div class="tag-detail-plugins">' +
      containingPlugins.map(function(p) { return '<span class="tag-detail-plugin">' + p + '</span>'; }).join('') +
    '</div></div>' +
    '<div class="tag-detail-row"><span class="tag-detail-label">Invoke:</span><span class="tag-detail-value">/ork:' + name + '</span></div>' +
    '<a class="tag-detail-doc-link" href="' + docUrl + '" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">View Documentation &rarr;</a>';
  }

  detailEl.innerHTML = content;
  detailEl.classList.add('visible');
  currentDetailEl = detailEl;
}

function closeDetail() {
  if (currentDetailEl) {
    currentDetailEl.classList.remove('visible');
    currentDetailEl = null;
  }
}

// Close detail on Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeDetail();
});

// Prompt output
function updatePrompt() {
  var el = document.getElementById('promptOutput');
  if (state.category !== 'all') {
    var plugins = PLUGINS.filter(function(p) { return p.category === state.category; });
    var names = plugins.map(function(p) { return p.name; });
    var catInfo = CAT_COLORS[state.category];
    var catLabel = catInfo ? catInfo.label : state.category;
    el.textContent = '# Install ' + catLabel + ' plugins:\n' + names.map(function(n) { return 'claude plugin install ' + n; }).join('\n');
  } else if (state.search) {
    var filtered = getFilteredPlugins();
    if (filtered.length === 1) {
      var p = filtered[0];
      var skillCount = p.skillCount || p.skills.length;
      el.textContent = 'claude plugin install ' + p.name + '\n\n# ' + p.name + ' includes:\n# ' + skillCount + ' skills, ' + p.agents.length + ' agents, ' + p.hooks + ' hooks';
    } else {
      el.textContent = '# ' + filtered.length + ' plugins match "' + state.search + '":\n' + filtered.map(function(p) { var sc = p.skillCount || p.skills.length; return 'claude plugin install ' + p.name + '  # ' + sc + ' skills, ' + p.agents.length + ' agents'; }).join('\n');
    }
  } else {
    var otherPlugins = PLUGINS.filter(function(p) { return p.name !== 'ork'; });
    el.textContent = '# Install the complete OrchestKit toolkit:\nclaude plugin install ork\n\n# Or install domain-specific plugins:\n' + otherPlugins.map(function(p) { var sc = p.skillCount || p.skills.length; return '# claude plugin install ' + p.name + '  (' + sc + ' skills, ' + p.agents.length + ' agents)'; }).join('\n');
  }
}

function copyPrompt() {
  var text = document.getElementById('promptOutput').textContent;
  navigator.clipboard.writeText(text).then(function() {
    var btn = document.getElementById('copyBtn');
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(function() {
      btn.textContent = 'Copy';
      btn.classList.remove('copied');
    }, 1500);
  });
}

// Actions
function setCategory(cat) {
  state.category = cat;
  renderAll();
  syncToUrl();
}
function setSearch(q) {
  state.search = q;
  document.getElementById('searchInput').value = q;
  renderAll();
  syncToUrl();
}
function setView(v) {
  state.view = v;
  document.querySelectorAll('.view-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.view === v); });
  document.getElementById('gridView').style.display = v === 'grid' ? 'grid' : 'none';
  document.getElementById('treemapView').style.display = v === 'treemap' ? 'block' : 'none';
  document.getElementById('agentsView').style.display = v === 'agents' ? 'block' : 'none';
  document.getElementById('graphView').style.display = v === 'graph' ? 'block' : 'none';
  if (v === 'treemap') setTimeout(renderTreemap, 50);
  if (v === 'graph') setTimeout(renderGraph, 50);
  if (v === 'agents') renderAgents();
  syncToUrl();
}
function toggleCard(name) {
  state.expandedCard = state.expandedCard === name ? null : name;
  renderGrid();
}

function renderAll() {
  renderStats();
  renderFilters();
  renderLegend();
  renderGrid();
  updatePrompt();
  if (state.view === 'treemap') setTimeout(renderTreemap, 50);
  if (state.view === 'graph') setTimeout(renderGraph, 50);
  if (state.view === 'agents') renderAgents();
}

// Events
document.getElementById('searchInput').addEventListener('input', function(e) {
  state.search = e.target.value;
  renderAll();
  syncToUrl();
});
var viewBtns = document.querySelectorAll('.view-btn');
for (var i = 0; i < viewBtns.length; i++) {
  (function(b) {
    b.addEventListener('click', function() { setView(b.dataset.view); });
  })(viewBtns[i]);
}
window.addEventListener('resize', function() {
  if (state.view === 'treemap') renderTreemap();
  if (state.view === 'graph') renderGraph();
});

// Init
if (state.search) {
  document.getElementById('searchInput').value = state.search;
}
updateBreadcrumbs();
renderAll();
setView(state.view);
</script>
</body>
</html>
