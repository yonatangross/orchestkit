#!/usr/bin/env bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-02-12

# analyze-impact.sh â€” Detailed impact analysis from git diff
# Usage: bash analyze-impact.sh [base_branch]
set -euo pipefail

BASE="${1:-main}"

echo "=== IMPACT ANALYSIS ==="
echo "Comparing: HEAD vs $BASE"
echo ""

# Files by action with line counts
echo "=== FILES BY ACTION ==="

echo ""
echo "--- ADDED ---"
git diff --diff-filter=A --numstat "${BASE}...HEAD" 2>/dev/null | while read -r added removed file; do
  echo "  [A] $file  +$added"
done
ADDED_COUNT=$(git diff --diff-filter=A --name-only "${BASE}...HEAD" 2>/dev/null | wc -l | tr -d ' ')
echo "  Total: $ADDED_COUNT files"

echo ""
echo "--- MODIFIED ---"
git diff --diff-filter=M --numstat "${BASE}...HEAD" 2>/dev/null | while read -r added removed file; do
  echo "  [M] $file  +$added -$removed"
done
MOD_COUNT=$(git diff --diff-filter=M --name-only "${BASE}...HEAD" 2>/dev/null | wc -l | tr -d ' ')
echo "  Total: $MOD_COUNT files"

echo ""
echo "--- DELETED ---"
git diff --diff-filter=D --numstat "${BASE}...HEAD" 2>/dev/null | while read -r added removed file; do
  echo "  [D] $file  -$removed"
done
DEL_COUNT=$(git diff --diff-filter=D --name-only "${BASE}...HEAD" 2>/dev/null | wc -l | tr -d ' ')
echo "  Total: $DEL_COUNT files"

echo ""
echo "--- RENAMED ---"
git diff --diff-filter=R --name-only "${BASE}...HEAD" 2>/dev/null | while read -r file; do
  echo "  [R] $file"
done

# Test files affected
echo ""
echo "=== TEST IMPACT ==="
TEST_FILES=$(git diff --name-only "${BASE}...HEAD" 2>/dev/null | grep -iE '(test|spec|__tests__)' || true)
if [ -n "$TEST_FILES" ]; then
  echo "$TEST_FILES" | while read -r f; do
    ACTION=$(git diff --diff-filter=AMDR --name-only "${BASE}...HEAD" 2>/dev/null | grep -F "$f" | head -1)
    if git diff --diff-filter=A --name-only "${BASE}...HEAD" 2>/dev/null | grep -qF "$f"; then
      echo "  [A] $f"
    elif git diff --diff-filter=D --name-only "${BASE}...HEAD" 2>/dev/null | grep -qF "$f"; then
      echo "  [D] $f"
    else
      echo "  [M] $f"
    fi
  done
  echo "  Total test files affected: $(echo "$TEST_FILES" | wc -l | tr -d ' ')"
else
  echo "  No test files affected"
fi

# Impact by directory
echo ""
echo "=== IMPACT BY DIRECTORY ==="
git diff --numstat "${BASE}...HEAD" 2>/dev/null | awk -F/ '{
  dir = $1
  for (i=2; i<NF; i++) dir = dir "/" $i
  added[dir] += $1
  removed[dir] += $2
  count[dir]++
} END {
  for (d in count) {
    printf "  %-40s %3d files  +%-5d -%d\n", d, count[d], added[d], removed[d]
  }
}' | sort -t'+' -k2 -nr

# Dependency changes (package.json, requirements.txt, etc)
echo ""
echo "=== DEPENDENCY CHANGES ==="
DEP_FILES=$(git diff --name-only "${BASE}...HEAD" 2>/dev/null | grep -iE '(package\.json|requirements\.txt|Pipfile|go\.mod|Cargo\.toml|pyproject\.toml)' || true)
if [ -n "$DEP_FILES" ]; then
  echo "$DEP_FILES" | while read -r f; do
    echo "  Changed: $f"
  done
else
  echo "  No dependency files changed"
fi

# Summary
echo ""
echo "=== SUMMARY ==="
TOTAL=$((ADDED_COUNT + MOD_COUNT + DEL_COUNT))
LINES_ADDED=$(git diff --numstat "${BASE}...HEAD" 2>/dev/null | awk '{s+=$1} END {print s+0}')
LINES_REMOVED=$(git diff --numstat "${BASE}...HEAD" 2>/dev/null | awk '{s+=$2} END {print s+0}')
echo "  Files: $TOTAL ($ADDED_COUNT added, $MOD_COUNT modified, $DEL_COUNT deleted)"
echo "  Lines: +$LINES_ADDED -$LINES_REMOVED (net: $((LINES_ADDED - LINES_REMOVED)))"
echo "  Tests: $(echo "$TEST_FILES" | grep -c . 2>/dev/null || echo 0) test files affected"
