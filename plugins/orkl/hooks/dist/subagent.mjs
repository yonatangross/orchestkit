// OrchestKit Hooks - subagent bundle
// Generated: 2026-02-20T06:38:36.014Z

var et=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,n)=>(typeof require<"u"?require:e)[n]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});function eo(t){return typeof t.command=="string"}function no(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function ro(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function so(t){return typeof t.file_path=="string"&&t.content===void 0}import{existsSync as zt,statSync as jn,renameSync as Hn,mkdirSync as Nn,readSync as Mn}from"node:fs";import{appendFileSync as pn,mkdirSync as mn}from"node:fs";import{dirname as fn}from"node:path";var G=[],nt=!1,Mt=!1;function h(t,e){G.push({filePath:t,content:e}),yn()}function rt(){if(nt||G.length===0)return;nt=!0;let t=new Map;for(let e of G){let n=t.get(e.filePath);n?n.push(e.content):t.set(e.filePath,[e.content])}for(let[e,n]of t)try{mn(fn(e),{recursive:!0}),pn(e,n.join(""))}catch{}G.length=0,nt=!1}function yn(){Mt||(Mt=!0,process.on("exit",rt),process.on("SIGTERM",()=>{rt(),process.exit(0)}),process.on("SIGINT",()=>{rt(),process.exit(0)}))}import{execSync as Fn}from"node:child_process";import Ft from"node:os";import N from"node:path";function st(){return process.env.HOME||process.env.USERPROFILE||Ft.homedir()}function hn(){return Ft.tmpdir()}function it(){return process.env.CLAUDE_PROJECT_DIR||"."}function Lt(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function Ut(){return process.env.CLAUDE_PLUGIN_ROOT?N.join(st(),".claude","logs","ork"):N.join(it(),".claude","logs")}function Bt(){return process.env.CLAUDE_METRICS_FILE||N.join(hn(),"claude-session-metrics.json")}var ot=N.join,lo=N.sep;import{execSync as kn}from"node:child_process";import{createHash as Sn}from"node:crypto";import{existsSync as qt,readFileSync as _n,writeFileSync as bn,mkdirSync as xn}from"node:fs";import{join as at,basename as vn}from"node:path";var $n=20,In=15,wn=/[^a-z0-9-]/g;function Tn(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=vn(e);return Gt(n,$n)}function An(t){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=kn("git branch --show-current",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),r=Gt(n||"detached",In);return process.env.ORCHESTKIT_SESSION_BRANCH=r,r}catch{return"nobranch"}}function Dn(t){let e=t||new Date,n=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${n}${r}`}function Cn(t){let e=t||new Date,n=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0");return`${n}${r}`}function Rn(){let t=`${process.pid}-${Date.now()}-${Math.random()}`;return Sn("sha256").update(t).digest("hex").slice(0,4)}function Gt(t,e){return t.toLowerCase().replace(wn,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,e)}function En(t,e){let n=Tn(t),r=An(t),s=Dn(e),i=Cn(e),o=Rn();return`${n}-${r}-${s}-${i}-${o}`}function On(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=at(e,".instance","session-id.json");if(qt(n))try{let r=JSON.parse(_n(n,"utf8"));if(r.session_id&&r.created_at){let s=Date.now()-new Date(r.created_at).getTime(),i=1440*60*1e3;if(s<i)return r.session_id}}catch{}}function Pn(t,e){let n=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),r=at(n,".instance"),s=at(r,"session-id.json");try{qt(r)||xn(r,{recursive:!0}),bn(s,JSON.stringify({session_id:t,created_at:new Date().toISOString()},null,2))}catch{}}function Jt(t){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let e=On(t);if(e)return e;let n=En(t);return Pn(n,t),n}function Wt(){return Ut()}function l(){return it()}function J(){return Lt()}function $o(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${J()}/.claude/.instance_env`}function S(){return Jt()}function Vt(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let e=Fn("git branch --show-current",{cwd:t||l(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function Ln(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Io(t){return t.replace(/\r\n/g,`
`)}function Un(t){let e=["debug","info","warn","error"];return e.indexOf(t)>=e.indexOf(Ln())}function d(){return{continue:!0,suppressOutput:!0}}function wo(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function To(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function A(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function Bn(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function Ao(t,e){let n={continue:!0,suppressOutput:!0};return t&&(n.systemMessage=t),e&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:e}),n}function Do(t,e){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?n.systemMessage=e:n.suppressOutput=!0,n}function Co(t){return{continue:!0,systemMessage:t}}function R(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function Ro(t){process.stderr.write(`\u26A0 ${t}
`),process.exit(2)}function ct(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}function Eo(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:t}}}var qn=200*1024,Gn=100*1024;function Kt(t,e){if(zt(t))try{if(jn(t).size>e){let r=`${t}.old.${Date.now()}`;Hn(t,r)}}catch{}}function Xt(t){zt(t)||Nn(t,{recursive:!0})}function c(t,e,n="debug"){if(!Un(n))return;let r=Wt(),s=`${r}/hooks.log`;try{Xt(r),Kt(s,qn);let i=new Date().toISOString().replace("T"," ").slice(0,19);h(s,`[${i}] [${n.toUpperCase()}] [${t}] ${e}
`)}catch{}}function Oo(t,e,n){let r=Wt(),s=`${r}/permission-feedback.log`;try{Xt(r),Kt(s,Gn);let i=new Date().toISOString(),o=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",a=n?.session_id||S();h(s,`${i} | ${t} | ${e} | tool=${o} | session=${a}
`)}catch{}}function Jn(t){if(!t)return 0;let r=(t.match(/[{};()=><]/g)||[]).length/t.length>.03?2.8:3.5;return Math.ceil(t.length/r)}function Po(t,e,n,r,s){let i=Jn(t);return r?.isOverBudget(n)?(c(e,`Budget exhausted for ${n}, suppressing ${i}t`),d()):(s&&s.trackTokenUsage(e,n,i),Bn(t))}function jo(){try{let t=[],n=Buffer.allocUnsafe(256),r,s=0;for(;;)try{if(r=Mn(s,n,0,256,null),r===0)break;t.push(Buffer.from(n.subarray(0,r)))}catch{break}let i=Buffer.concat(t).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:S(),tool_input:{}}}catch{return{tool_name:"",session_id:S(),tool_input:{}}}}function Ho(t,e){let n=e.replace(/^\./,"").split("."),r=t;for(let s of n){if(r==null)return;r=r[s]}return r}function No(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function Mo(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var Lo={AUTO_DISPATCH:85,SKILL_INJECT:80,STRONG_RECOMMEND:70,SUGGEST:50,MINIMUM:40},Uo={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:1200,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};import{existsSync as M,readFileSync as Yt,writeFileSync as Zt,mkdirSync as zn}from"node:fs";function ut(){return`${l()}/.claude/orchestration`}function gt(){let t=S();return`${ut()}/session-${t}.json`}function te(){return`${l()}/.claude/orchestration/config.json`}function ee(){let t=ut();if(!M(t))try{zn(t,{recursive:!0})}catch{c("orchestration-state",`Failed to create state dir: ${t}`)}}function $(){let t=gt();if(M(t))try{let e=Yt(t,"utf8");return JSON.parse(e)}catch(e){c("orchestration-state",`Failed to load state: ${e}`)}return{sessionId:S(),activeAgents:[],injectedSkills:[],promptHistory:[],maxHistorySize:10,updatedAt:new Date().toISOString()}}function Wn(t){ee();let e=gt();t.updatedAt=new Date().toISOString();try{Zt(e,JSON.stringify(t,null,2))}catch(n){c("orchestration-state",`Failed to save state: ${n}`)}}function P(t){let e=$();return t(e),Wn(e),e}function Jo(t,e,n){let r={agent:t,taskId:n,confidence:e,dispatchedAt:new Date().toISOString(),status:"pending",retryCount:0,maxRetries:3};return P(s=>{s.activeAgents=s.activeAgents.filter(i=>i.agent!==t),s.activeAgents.push(r)}),c("orchestration-state",`Tracked dispatched agent: ${t} (conf: ${e})`),r}function E(t,e,n){P(r=>{let s=r.activeAgents.find(i=>i.agent===t);s&&(s.status=e,n&&(s.taskId=n),e==="retrying"&&s.retryCount++)}),c("orchestration-state",`Updated agent status: ${t} -> ${e}`)}function lt(t){P(e=>{e.activeAgents=e.activeAgents.filter(n=>n.agent!==t)})}function zo(){return $().activeAgents.find(e=>e.status==="in_progress")}function Wo(t){return $().activeAgents.some(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function Vo(t){P(e=>{e.injectedSkills.includes(t)||e.injectedSkills.push(t)})}function Ko(t){return $().injectedSkills.includes(t)}function Xo(){return $().injectedSkills}function Qo(t){P(e=>{e.promptHistory.push(t),e.promptHistory.length>e.maxHistorySize&&(e.promptHistory=e.promptHistory.slice(-e.maxHistorySize))})}function Yo(){return $().promptHistory}function Zo(t){P(e=>{e.lastClassification=t})}function ta(){return $().lastClassification}var Qt={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:1200,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function dt(){let t=te();if(M(t))try{let e=Yt(t,"utf8");return{...Qt,...JSON.parse(e)}}catch{}return Qt}function ea(t){ee();let e=te(),r={...dt(),...t};try{Zt(e,JSON.stringify(r,null,2))}catch(s){c("orchestration-state",`Failed to save config: ${s}`)}}function na(){let t=gt();try{if(M(t)){let{unlinkSync:e}=et("node:fs");e(t),c("orchestration-state","Cleared session state")}}catch{}}function ra(){let t=ut();if(M(t))try{let{readdirSync:e,statSync:n,unlinkSync:r}=et("node:fs"),s=e(t).filter(i=>i.startsWith("session-")&&i.endsWith(".json")).map(i=>({name:i,path:`${t}/${i}`,mtime:n(`${t}/${i}`).mtime.getTime()})).sort((i,o)=>o.mtime-i.mtime);for(let i of s.slice(5))try{r(i.path),c("orchestration-state",`Cleaned up old state: ${i.name}`)}catch{}}catch{}}var Vn=3,Kn=1e3,Xn=3e4,Qn={"backend-system-architect":["database-engineer","api-designer"],"frontend-ui-developer":["rapid-ui-designer","accessibility-specialist"],"test-generator":["debug-investigator","code-quality-reviewer"],"security-auditor":["security-layer-auditor"],"workflow-architect":["llm-integrator","data-pipeline-engineer"]},Yn=[/permission denied/i,/access denied/i,/not found.*(?:file|module|package)/i,/(?:file|module|package)\s+not\s+found/i,/missing required/i,/invalid (?:api|token|key)/i,/authentication failed/i,/quota exceeded/i,/rate limit/i],Zn=[/not my specialization/i,/outside my scope/i,/better suited for/i,/consider using/i,/specialized agent/i];function tr(t,e=Kn){let n=e*2**(t-1),r=Math.random()*.1*n;return Math.min(n+r,Xn)}function er(t){for(let e of Yn)if(e.test(t))return!1;return!0}function nr(t){for(let e of Zn)if(e.test(t))return!0;return!1}function pt(t,e=[]){let n=Qn[t];if(n){for(let r of n)if(!e.includes(r))return r}}function ne(t,e,n,r=[],s=Vn){if(c("retry-manager",`Evaluating retry for ${t}, attempt ${e}`),e>=s){let o=pt(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Max retries (${s}) exceeded`+(o?`. Consider trying ${o} instead.`:"")}}if(!er(n)){let o=pt(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Non-retryable error detected: ${n.slice(0,100)}`}}if(nr(n)){let o=pt(t,r);if(o)return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Error suggests using alternative agent: ${o}`}}let i=tr(e);return{shouldRetry:!0,retryCount:e,maxRetries:s,delayMs:i,reason:`Retrying (attempt ${e+1}/${s}) after ${Math.round(i/1e3)}s`}}function re(t,e,n){return{agent:t,taskId:n,attemptNumber:e,startedAt:new Date().toISOString()}}function se(t,e,n){let r=new Date().toISOString(),s=new Date(r).getTime()-new Date(t.startedAt).getTime();return{...t,completedAt:r,outcome:e,error:n,durationMs:s}}function oa(t){if(t.length===0)return{successRate:0,avgDuration:0,commonErrors:[]};let n=t.filter(a=>a.outcome==="success").length/t.length,r=t.filter(a=>a.durationMs!==void 0).map(a=>a.durationMs),s=r.length>0?r.reduce((a,u)=>a+u,0)/r.length:0,i=new Map;for(let a of t)if(a.error){let u=a.error.slice(0,50).toLowerCase();i.set(u,(i.get(u)||0)+1)}let o=Array.from(i.entries()).sort((a,u)=>u[1]-a[1]).slice(0,3).map(([a])=>a);return{successRate:n,avgDuration:s,commonErrors:o}}function aa(t,e){return{...t,status:"retrying",retryCount:e.retryCount}}function ie(t,e){if(t.shouldRetry)return`## Retry Scheduled

Agent \`${e}\` will retry after ${Math.round((t.delayMs||0)/1e3)} seconds.

**Attempt:** ${t.retryCount+1} of ${t.maxRetries}
**Reason:** ${t.reason}`;let n=`## Retry Not Recommended

Agent \`${e}\` has ${t.retryCount>=t.maxRetries?"exhausted retries":"encountered a non-retryable error"}.

**Reason:** ${t.reason}`;return t.alternativeAgent&&(n+=`

### Alternative Suggestion

Consider using \`${t.alternativeAgent}\` instead:

\`\`\`
Task tool with subagent_type: "${t.alternativeAgent}"
\`\`\``),n}import{existsSync as ue,readFileSync as rr,writeFileSync as sr,mkdirSync as ir}from"node:fs";import{createHash as or}from"node:crypto";var oe=500,mt=3,ae=15,ce=3,ar=.9;function ge(){return`${l()}/.claude/feedback/calibration-data.json`}function cr(){let t=`${l()}/.claude/feedback`;if(!ue(t))try{ir(t,{recursive:!0})}catch{}}function F(){let t=ge();if(ue(t))try{return JSON.parse(rr(t,"utf8"))}catch{c("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function ur(t){cr();let e=ge();t.updatedAt=new Date().toISOString();try{sr(e,JSON.stringify(t,null,2)),c("calibration-engine","Saved calibration data")}catch(n){c("calibration-engine",`Failed to save calibration data: ${n}`)}}function gr(t){return or("sha256").update(t.toLowerCase().trim()).digest("hex").slice(0,16)}function da(t,e,n,r,s,i,o){let a=F(),u={timestamp:new Date().toISOString(),sessionId:S(),agent:e,promptHash:gr(t),matchedKeywords:n,dispatchConfidence:r,outcome:s,durationMs:i,feedback:o};a.records.push(u),a.records.length>oe&&(a.records=a.records.slice(-oe)),lr(a,u),dr(a),ur(a),c("calibration-engine",`Recorded outcome: ${e} -> ${s} (conf: ${r})`)}function lr(t,e){let n=e.outcome==="success",r=e.outcome==="failure"||e.outcome==="rejected";if(!n&&!r)return;let s=n?ce:-ce;for(let i of e.matchedKeywords){let o=t.adjustments.find(a=>a.keyword===i&&a.agent===e.agent);o?(o.adjustment=Math.max(-ae,Math.min(ae,o.adjustment+s)),o.sampleCount++,o.lastUpdated=new Date().toISOString()):t.adjustments.push({keyword:i,agent:e.agent,adjustment:s,sampleCount:1,lastUpdated:new Date().toISOString()})}}function pa(t){let e=Date.now(),n=1440*60*1e3;for(let r of t.adjustments){let s=e-new Date(r.lastUpdated).getTime();Math.floor(s/n)>7&&(r.adjustment=Math.round(r.adjustment*ar),Math.abs(r.adjustment)<1&&(r.adjustment=0))}t.adjustments=t.adjustments.filter(r=>r.adjustment!==0)}function dr(t){let e=t.records;if(e.length===0)return;t.stats.totalDispatches=e.length;let n=e.filter(i=>i.outcome==="success").length;t.stats.successRate=n/e.length;let r=e.reduce((i,o)=>i+o.dispatchConfidence,0)/e.length;t.stats.avgConfidence=Math.round(r);let s=new Map;for(let i of e){let o=s.get(i.agent)||{count:0,success:0};o.count++,i.outcome==="success"&&o.success++,s.set(i.agent,o)}t.stats.topAgents=Array.from(s.entries()).map(([i,o])=>({agent:i,count:o.count,successRate:o.success/o.count})).sort((i,o)=>o.count-i.count).slice(0,10)}function ma(){return F().adjustments.filter(e=>e.sampleCount>=mt)}function fa(t){let n=F().records.filter(s=>s.agent===t);return n.length<mt?null:n.filter(s=>s.outcome==="success").length/n.length}function ya(){return F().stats}function ha(){return F().records.length>=mt}import{existsSync as pr,statSync as mr}from"node:fs";import{resolve as fr}from"node:path";var yr={"database-engineer":"database schema SQL PostgreSQL migration pgvector","backend-system-architect":"API REST architecture backend FastAPI microservice","frontend-ui-developer":"React frontend UI component TypeScript Tailwind","security-auditor":"security OWASP vulnerability audit authentication","test-generator":"testing unit integration coverage pytest MSW","workflow-architect":"LangGraph workflow agent orchestration state","llm-integrator":"LLM API OpenAI Anthropic embeddings RAG function-calling","data-pipeline-engineer":"data pipeline embeddings vector ETL chunking","metrics-architect":"metrics OKR KPI analytics instrumentation","ux-researcher":"UX user research persona journey accessibility","code-quality-reviewer":"code quality review linting type-check patterns","infrastructure-architect":"infrastructure cloud Docker Kubernetes deployment","ci-cd-engineer":"CI CD pipeline GitHub Actions deployment automation","accessibility-specialist":"accessibility WCAG ARIA screen-reader a11y","product-strategist":"product strategy roadmap features prioritization"};function hr(t){return yr[t]||t}var le=100;function de(t){c("graph-memory-inject","Graph memory inject hook starting");let e=fr(l(),".claude/memory/knowledge-graph.jsonl");if(!pr(e))return c("graph-memory-inject","No graph data file, skipping"),d();try{let u=mr(e).size;if(u<le)return c("graph-memory-inject",`Graph too small (${u}B < ${le}B), skipping`),d()}catch{return c("graph-memory-inject","Could not stat graph file, skipping"),d()}let r=(t.tool_input||{}).subagent_type||"";if(!r)return c("graph-memory-inject","No agent type detected, passing through"),d();let s=`ork:${r}`,i=hr(r);c("graph-memory-inject",`Detected agent type: ${r} (agent_id: ${s})`);let o=`[Graph Memory - Agent Context Load]

Execute this MCP call to load graph context for ${r} agent:

## Graph Memory Entities
\`\`\`
mcp__memory__search_nodes
{"query": "${r} ${i}"}
\`\`\`

## Integration Instructions
1. Execute the graph search to retrieve relevant entities and relationships
2. Review entities for patterns, decisions, and constraints
3. Check relationships between concepts
4. Apply learned patterns to current task

Agent ID: ${s} | Domain: ${i}`,a=`[Graph Memory] Agent: ${r} | ID: ${s} | Load graph context via MCP call above`;return c("graph-memory-inject",`Outputting graph memory instructions for ${r}`),{continue:!0,systemMessage:a,hookSpecificOutput:{additionalContext:o}}}import{existsSync as L,readFileSync as z,writeFileSync as ft,mkdirSync as kr}from"node:fs";import{dirname as Sr}from"node:path";var _r=6,br=8,xr=5,vr=/^(test-generator|backend-system-architect|workflow-architect|security-auditor|llm-integrator)$/;function $r(){let t=process.cwd();return t.includes(".claude/worktrees/")||t.includes("/.git/worktrees/")}function Ir(){return $r()?{maxBackground:10,maxPerResponse:12}:{maxBackground:_r,maxPerResponse:br}}function yt(){return`${l()}/.claude/logs/agent-state.json`}function me(){return`${l()}/.claude/logs/subagent-spawns.jsonl`}function wr(){let t=yt(),e=Sr(t);try{kr(e,{recursive:!0})}catch{}if(!L(t)){let n={active_background:[],session_total:0,last_cleanup:null,blocked_count:0};try{ft(t,JSON.stringify(n,null,2))}catch{}}}function Tr(){let t=me();if(!L(t))return 0;try{let r=z(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),s=new Date(Date.now()-300*1e3).toISOString(),i=0;for(let o of r)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>s&&i++}catch{}return i}catch{return 0}}function Ar(){let t=me();if(!L(t))return 0;try{let r=z(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),s=new Date(Date.now()-2*1e3).toISOString(),i=0;for(let o of r)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>s&&i++}catch{}return i}catch{return 0}}function Dr(){let t=yt();try{if(L(t)){let e=JSON.parse(z(t,"utf8"));e.blocked_count=(e.blocked_count||0)+1,ft(t,JSON.stringify(e,null,2))}}catch{}}function pe(){let t=yt();try{if(L(t)){let e=JSON.parse(z(t,"utf8"));e.session_total=(e.session_total||0)+1,ft(t,JSON.stringify(e,null,2))}}catch{}}function fe(t){wr();let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"",s=e.run_in_background===!0||e.run_in_background==="true";c("context-gate",`Context gate check: ${n} (background=${s})`);let i=Tr(),o=Ar();c("context-gate",`Active background: ${i}, Current response: ${o}`);let a=Ir();return o>=a.maxPerResponse?(c("context-gate",`BLOCKED: Too many agents in single response (${o} >= ${a.maxPerResponse})`),ct(`Context Overflow Protection

Too many agents spawned in a single response (${o} agents).

Maximum allowed: ${a.maxPerResponse} per response

SOLUTION: Split into multiple responses or use sequential execution.
Consider using the /context-optimization skill first.

Attempted: ${n} - ${r}`)):s&&i>=a.maxBackground?(c("context-gate",`BLOCKED: Too many concurrent background agents (${i} >= ${a.maxBackground})`),Dr(),ct(`Background Agent Limit

Too many background agents running concurrently (${i} active).

Maximum allowed: ${a.maxBackground} concurrent background agents

SOLUTION:
1. Wait for existing agents to complete
2. Run this agent in foreground (remove run_in_background)
3. Use /context-optimization to free up context

Attempted: ${n} - ${r}`)):i>=xr?(c("context-gate","WARNING: Approaching context budget limit"),pe(),R(`Context Budget Warning

${i} background agents active (limit: ${a.maxBackground}).

Consider:
- Running remaining agents sequentially
- Using /context-optimization skill
- Waiting for current agents to complete

Proceeding with: ${n} - ${r}`)):vr.test(n)&&i>=2?(c("context-gate",`WARNING: Expensive agent type with multiple active: ${n}`),R(`Spawning expensive agent (${n}) with ${i} others active`)):(pe(),c("context-gate",`Context gate passed: ${n}`),d())}import{existsSync as ht,readFileSync as he,readdirSync as Cr}from"node:fs";function Rr(){return`${l()}/.claude/context/session/state.json`}function Er(){return`${l()}/.claude/context/knowledge/decisions/active.json`}function Or(){return`${l()}/docs/issues`}function Pr(){let t=Rr();if(!ht(t))return{count:0,summary:""};try{let n=JSON.parse(he(t,"utf8")).tasks_pending||[],r=n.length;if(r===0)return{count:0,summary:""};let s=n.slice(0,5).map(i=>`- ${i}`).join(`
`);return{count:r,summary:s}}catch{return{count:0,summary:""}}}function ye(t,e){let n=Er();if(!ht(n))return"";try{return(JSON.parse(he(n,"utf8")).decisions||[]).filter(o=>o.category===e||o.category==="api"||o.category==="database").slice(0,8).map(o=>`- ${o.title} (${o.status||"unknown"})`).join(`
`)}catch{return""}}function jr(t){let e=Or();if(!ht(e))return"";try{let r=Cr(e).find(s=>s.includes(t));if(r)return`docs/issues/${r}`}catch{}return""}function ke(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.task_description||e.description||"";c("subagent-context-stager",`Staging context for ${n}`);let s="",{count:i,summary:o}=Pr();i>0&&(c("subagent-context-stager",`Found ${i} pending tasks`),s+=`ACTIVE TODOS:
${o}

`);let a=r.toLowerCase();if(/backend|api|endpoint|database|migration/.test(a)){c("subagent-context-stager","Backend task detected - staging backend decisions");let u=ye(r,"backend");u&&(s+=`RELEVANT DECISIONS:
${u}

`)}if(/frontend|react|ui|component/.test(a)){c("subagent-context-stager","Frontend task detected - staging frontend decisions");let u=ye(r,"frontend");u&&(s+=`RELEVANT DECISIONS:
${u}

`)}if(/test|testing|pytest|jest/.test(a)&&(c("subagent-context-stager","Testing task detected - staging test context"),s+=`TESTING REMINDERS:
- Use 'tee' for visible test output
- Check test patterns in backend/tests/ or frontend/src/**/__tests__/
- Ensure coverage meets threshold requirements

`),/issue|#\d+|bug|fix/.test(a)){c("subagent-context-stager","Issue-related task detected");let u=r.match(/#(\d+)/);if(u){let g=u[1],p=jr(g);p&&(s+=`ISSUE DOCS: ${p}

`,c("subagent-context-stager",`Staged issue documentation for #${g}`))}}if(s){let u=`${s}
Task: ${r}
Subagent: ${n}`,g=s.split(`
`).filter(Boolean).length;return c("subagent-context-stager",`Staged context with ${g} lines`),{continue:!0,systemMessage:u}}return c("subagent-context-stager","No context staged for this task"),d()}import{existsSync as U,readFileSync as kt,mkdirSync as Hr,readdirSync as Nr}from"node:fs";import{join as v,dirname as Mr}from"node:path";var Fr=new Set(["general-purpose","Explore","Plan","claude-code-guide","statusline-setup","Bash"]);function Lr(){return v(l(),".claude","logs","subagent-spawns.jsonl")}function Ur(){return v(l(),"plugin.json")}function St(){return v(l(),"agents")}function _t(){return v(l(),".claude","agents")}function Br(){return v(l(),"skills")}function qr(){let t=new Set(Fr),e=Ur();if(U(e))try{let s=JSON.parse(kt(e,"utf8")).agents||[];for(let i of s)i.id&&t.add(i.id)}catch{}let n=[St(),_t()];for(let r of n)if(U(r))try{let s=Nr(r);for(let i of s)i.endsWith(".md")&&t.add(i.replace(".md",""))}catch{}return t}function Gr(t){let e=[],n=[v(St(),`${t}.md`),v(_t(),`${t}.md`)],r=null;for(let s of n)if(U(s)){r=s;break}if(!r)return e;try{let i=kt(r,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of i){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^skills:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let g=u.match(/^\s*-\s*(.+)$/);if(g){let p=g[1].trim();e.push(p)}}}}}catch{}return e}function Jr(t){let e=Gr(t),n=[],r=Br();for(let s of e){let i=v(r,s,"SKILL.md");U(i)||n.push(s)}return n}function zr(t){let e=[],n=[v(St(),`${t}.md`),v(_t(),`${t}.md`)],r=null;for(let s of n)if(U(s)){r=s;break}if(!r)return e;try{let i=kt(r,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of i){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^tools:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let g=u.match(/^\s*-\s*(.+)$/);g&&e.push(g[1].trim())}}}}catch{}return e}function Wr(t,e){if(e.length===0)return"";let n=e.every(o=>["Read","Glob","Grep"].includes(o)),r=e.includes("Bash"),s=e.includes("Write")||e.includes("Edit"),i="low";return r&&s?i="elevated":(r||s)&&(i="moderate"),`## Agent Permission Profile (CC 2.1.20)

**Agent**: \`${t}\`
**Tools**: ${e.join(", ")}
**Risk Level**: ${i}${n?" (read-only)":""}

${r?`> This agent requests Bash access. Review commands carefully.
`:""}`}function Vr(t,e,n){let r=Lr(),s=Mr(r);try{Hr(s,{recursive:!0})}catch{}let i={timestamp:new Date().toISOString(),subagent_type:t,description:e,session_id:n};try{h(r,`${JSON.stringify(i)}
`)}catch{}}function Se(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"",s=t.session_id;c("subagent-validator",`Task invocation: ${n} - ${r}`),Vr(n,r,s);let i=n.replace(/^[^:]+:/,""),o=qr();!o.has(n)&&!o.has(i)&&c("subagent-validator",`WARNING: Unknown subagent type: ${n}`),c("subagent-validator",`Spawning ${n} agent: ${r}`);let a=Jr(i);if(a.length>0){let g=a.join(", ");c("subagent-validator",`WARNING: Agent '${i}' references missing skills: ${g}`),console.error(`Warning: Agent '${i}' references ${a.length} missing skill(s): ${g}`)}let u=zr(i);if(u.length>0){let g=Wr(i,u);return c("subagent-validator",`Agent '${i}' tools: ${u.join(", ")}`),A(g)}return d()}import{existsSync as _e,readFileSync as Kr,writeFileSync as Xr,mkdirSync as Qr}from"node:fs";function be(){let t=S();return`${l()}/.claude/orchestration/task-registry-${t}.json`}function Yr(){let t=`${l()}/.claude/orchestration`;if(!_e(t))try{Qr(t,{recursive:!0})}catch{}}function j(){let t=be();if(_e(t))try{return JSON.parse(Kr(t,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:S(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function bt(t){Yr();let e=be();t.updatedAt=new Date().toISOString();try{Xr(e,JSON.stringify(t,null,2))}catch(n){c("task-integration",`Failed to save registry: ${n}`)}}function xe(t,e){return`### Delete Orphaned Task

\`\`\`
TaskUpdate:
  taskId: "${t}"
  status: "deleted"
\`\`\`

**Reason**: ${e}`}function W(t){let e=`### Update Task

\`\`\`
TaskUpdate:
  taskId: "${t.taskId}"`;return t.status&&(e+=`
  status: "${t.status}"`),t.addBlockedBy&&t.addBlockedBy.length>0&&(e+=`
  addBlockedBy: ${JSON.stringify(t.addBlockedBy)}`),t.addBlocks&&t.addBlocks.length>0&&(e+=`
  addBlocks: ${JSON.stringify(t.addBlocks)}`),e+="\n```",e}function I(t,e){let n=j(),r=n.tasks.find(s=>s.taskId===t);r&&(r.status=e,bt(n),c("task-integration",`Updated task ${t} status to ${e}`))}function D(t){return j().tasks.find(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function ve(t){return j().tasks.filter(n=>n.status==="pending"&&n.blockedBy&&n.blockedBy.includes(t))}function xt(t){return j().tasks.filter(n=>n.pipelineId===t).sort((n,r)=>(n.pipelineStep||0)-(r.pipelineStep||0))}function $e(){return j().pipelines.find(e=>e.status==="running")}function Ie(t,e){let n=j(),r=n.pipelines.find(i=>i.pipelineId===t);if(!r)return null;r.completedSteps.includes(e)||(r.completedSteps.push(e),r.completedSteps.sort((i,o)=>i-o));let s=xt(t);for(let i of s){let o=i.pipelineStep;if(o===void 0||r.completedSteps.includes(o)||i.status!=="pending")continue;if(o===0||r.completedSteps.includes(o-1))return r.currentStep=o,bt(n),o}return r.status="completed",bt(n),null}function we(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return c("task-linker","No agent type found, skipping"),d();c("task-linker",`Processing SubagentStart for: ${n}`);let r=D(n);if(!r)return c("task-linker",`No orchestration task found for agent: ${n}`),d();c("task-linker",`Found task ${r.taskId} for agent ${n}`),I(r.taskId,"in_progress"),E(n,"in_progress",r.taskId);let s=W({taskId:r.taskId,status:"in_progress"}),i=`## Orchestration: Task Linked

Agent \`${n}\` has been linked to task **${r.taskId}**.

${s}

The task status should be updated to \`in_progress\`.`;return c("task-linker",`Linked agent ${n} to task ${r.taskId}`),A(i)}import{mkdirSync as Zr,existsSync as vt,readFileSync as $t}from"node:fs";import{join as V,dirname as ts}from"node:path";var es=[/security|vulnerab|audit|penetration/i,/architect|design.*system|distributed/i,/migration.*schema|database.*design/i,/performance.*optim|profil|bottleneck/i,/langgraph|workflow.*orchestrat/i],ns=[/\b(?:list|count|check|verify|read|search)\b/i,/\b(?:simple|straightforward|quick)\b/i,/\b(?:format|lint|style|typo|rename)\b/i,/\b(?:status|progress|summary)\b/i],O=new Map,w=new Map;function It(t){if(O.has(t))return O.get(t);let e=J();if(!e)return O.set(t,"inherit"),"inherit";let n=V(e,"agents",`${t}.md`);if(!vt(n))return O.set(t,"inherit"),"inherit";try{let s=$t(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!s)return O.set(t,"inherit"),"inherit";let i=s[1].match(/^model:\s*(.+)$/m),o=i?i[1].trim():"inherit";return O.set(t,o),o}catch{return O.set(t,"inherit"),"inherit"}}function rs(t){if(w.has(t))return w.get(t);let e=J();if(!e)return w.set(t,null),null;let n=V(e,"agents",`${t}.md`);if(!vt(n))return w.set(t,null),null;try{let s=$t(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!s)return w.set(t,null),null;let i=s[1].match(/^skills:\s*\n((?:\s+-\s+.+\n)*)/m);if(!i)return w.set(t,null),null;let o=i[1].match(/^\s+-\s+(.+)$/gm)?.map(g=>g.trim().replace(/^-\s+/,""))||[];if(o.length===0)return w.set(t,null),null;let a={low:0,medium:1,high:2},u="low";for(let g of o.slice(0,5)){let p=V(e,"skills",g,"SKILL.md");if(!vt(p))continue;let m=$t(p,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!m)continue;let b=m[1].match(/^complexity:\s*(low|medium|high)$/m);if(b){let y=b[1];a[y]>a[u]&&(u=y)}}return w.set(t,u),u}catch{return w.set(t,null),null}}function Te(t,e){let n=rs(t);if(n==="high")return"high";let r=es.filter(o=>o.test(e)).length,s=It(t);return r>=2||s==="opus"?"high":ns.filter(o=>o.test(e)).length>=2?"low":n||"medium"}function Ae(t){let e=It(t);return e==="inherit"?process.env.CLAUDE_MODEL||"sonnet":e}function ss(t,e){let n=Te(t,e),r=Ae(t);return n==="high"&&r==="haiku"?{recommended:"sonnet",current:r,reason:"High-complexity task \u2014 haiku may produce lower quality results",savingsPercent:0}:n==="low"&&r==="opus"?{recommended:"sonnet",current:r,reason:"Simple task \u2014 sonnet handles this equally well at lower cost",savingsPercent:40}:n==="medium"&&r==="opus"&&It(t)!=="opus"?{recommended:"sonnet",current:r,reason:"Medium-complexity task \u2014 sonnet is sufficient",savingsPercent:30}:null}function is(t,e,n,r){let s=V(l(),".claude","logs","model-usage.jsonl");try{Zr(ts(s),{recursive:!0}),h(s,`${JSON.stringify({timestamp:new Date().toISOString(),agent:t,model:e,complexity:n,recommendation:r?.recommended||null,potentialSavings:r?.savingsPercent||0})}
`)}catch{}}function De(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"";if(!n)return d();let s=Te(n,r),i=Ae(n),o=ss(n,r);return is(n,i,s,o),o?(c("model-cost-advisor",`${n}: Recommend ${o.recommended} over ${o.current} (${o.reason})`,"info"),o.savingsPercent>=30?R(`Model cost: ${n} using ${o.current} for ${s}-complexity task. ${o.reason}. ~${o.savingsPercent}% savings with "${o.recommended}".`):d()):(c("model-cost-advisor",`${n}: ${i} appropriate for ${s} task`),d())}import{existsSync as os,readFileSync as as,writeFileSync as cs,statSync as us,mkdirSync as gs}from"node:fs";import{execFileSync as ls}from"node:child_process";import{tmpdir as ds}from"node:os";import{join as wt}from"node:path";var Tt=wt(ds(),"orchestkit-issue-cache"),ps=300*1e3,ms=3e3;function fs(t){let e=t.match(/^(?:issue|fix|feat|bug|hotfix|feature)\/(\d+)/)||t.match(/^(\d+)-/);return e?e[1]:null}function ys(){try{gs(Tt,{recursive:!0,mode:448})}catch{}}function hs(t){let e=wt(Tt,`${t}.json`);try{if(!os(e))return null;let n=us(e);return Date.now()-n.mtimeMs>ps?null:JSON.parse(as(e,"utf8"))}catch{return null}}function ks(t,e){if(!/^\d+$/.test(t))return null;try{let n=ls("gh",["issue","view",t,"--json","title,body,labels"],{cwd:e,encoding:"utf8",timeout:ms,stdio:["pipe","pipe","pipe"]}).trim(),r=JSON.parse(n);try{ys();let s=wt(Tt,`${t}.json`);cs(s,JSON.stringify(r),"utf8")}catch{}return r}catch{return null}}function Ss(t,e){let n=[];if(e?.title?n.push(`Working on GitHub Issue #${t}: ${e.title}`):n.push(`Working on GitHub Issue #${t}`),e?.labels&&e.labels.length>0){let r=e.labels.map(s=>s.name).join(", ");n.push(`Labels: ${r}`)}return n.push(`Reference #${t} in all commits. Use 'Closes #${t}' in PR description.`),n.join(`
`)}function Ce(t){try{let e=l(),n=Vt(e);c("issue-context-injector",`Branch: ${n}`);let r=fs(n);if(!r)return c("issue-context-injector","No issue number in branch name"),d();c("issue-context-injector",`Detected issue #${r}`);let s=hs(r)??ks(r,e),i=Ss(r,s);return c("issue-context-injector",`Injecting context for issue #${r}`),{continue:!0,systemMessage:i}}catch{return c("issue-context-injector","Unexpected error, falling back to silent success","warn"),d()}}import{existsSync as _s,mkdirSync as bs,unlinkSync as xs}from"node:fs";import{basename as vs,dirname as $s}from"node:path";var Is=["decided to","chose","implemented using","selected","opted for","will use","pattern:","approach:","architecture:","recommends","best practice","anti-pattern","learned that"],ws="decisions";function Ts(){return`${l()}/.claude/logs/agent-patterns.jsonl`}function As(){return`${l()}/.claude/session`}function Re(){let t=l();return(vs(t)||"default-project").toLowerCase().replace(/ /g,"-").replace(/[^a-z0-9-]/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-")}function Ds(t){return`${Re()}-${t}`}function Cs(t){let r=(t.length>10240?t.substring(0,10240):t).toLowerCase();return/pagination|cursor|offset/.test(r)?"pagination":/security|vulnerability|exploit|injection|xss|csrf|owasp|safety|guardrail/.test(r)?"security":/database|sql|postgres|schema/.test(r)?"database":/\bapi\b|endpoint|\brest\b|graphql/.test(r)?"api":/auth|login|jwt|oauth/.test(r)?"authentication":/\btest\b|testing|pytest|jest|vitest|coverage|\bmock\b|fixture|\bspec\b/.test(r)?"testing":/deploy|\bci\b|\bcd\b|pipeline|docker|kubernetes|helm|terraform/.test(r)?"deployment":/observability|monitoring|logging|tracing|metrics|prometheus|grafana|langfuse/.test(r)?"observability":/react|component|frontend|\bui\b/.test(r)?"frontend":/performance|optimization|cache|index/.test(r)?"performance":/llm|\brag\b|embedding|vector|semantic|\bai\b|\bml\b|langchain|langgraph|openai|anthropic/.test(r)?"ai-ml":/etl|data.*pipeline|streaming|batch.*processing|dataflow|spark/.test(r)?"data-pipeline":/architecture|design|structure/.test(r)?"architecture":/decided|chose|selected/.test(r)?"decision":"pattern"}function Rs(t){let e=[];if(t.length<50)return e;for(let r of Is){let s=new RegExp(`^.*${r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}.*$`,"gim"),i=t.match(s)||[];for(let o of i){let a=o.trim().substring(0,200);a.length>20&&e.push(a)}}return[...new Set(e)].slice(0,5)}function K(t){c("agent-memory-store","Agent memory store hook starting");let e=t.tool_input||{},n=t.subagent_type||e.subagent_type||e.type||"",r=t.tool_result,s=typeof r=="string"?r:r?.content||t.agent_output||t.output||"",i=!0;if(t.error&&(i=!1),typeof r=="object"&&r?.is_error&&(i=!1),!n)return c("agent-memory-store","No agent type in input, skipping"),d();let o=`ork:${n}`,a=`${As()}/current-agent-id`;try{_s(a)&&xs(a)}catch{}c("agent-memory-store",`Processing completion for agent: ${n} (agent_id: ${o}, success: ${i})`);let u=i&&s?Rs(s):[];if(u.length===0)return c("agent-memory-store",`No patterns extracted from ${n} output`),d();let g=Ts(),p=$s(g);try{bs(p,{recursive:!0})}catch{}let f=Re(),m=new Date().toISOString(),b=Ds(ws);for(let k of u){let q=Cs(k),Nt={agent:n,agent_id:o,pattern:k,project:f,timestamp:m,scope_id:b,category:q,pending_graph_sync:!0};try{h(g,`${JSON.stringify(Nt)}
`)}catch{}c("agent-memory-store",`Extracted pattern (${q}): ${k.substring(0,50)}...`)}return c("agent-memory-store",`Extracted ${u.length} patterns from ${n} output`),{continue:!0,systemMessage:`[Pattern Extraction] ${u.length} patterns extracted from ${n}. To persist, use mcp__memory__create_entities with entities: [{"name": "${n}-pattern", "entityType": "Pattern", "observations": ["<pattern>"]}]`}}import{existsSync as Es,writeFileSync as Ee,mkdirSync as At,readFileSync as Os}from"node:fs";import{dirname as Ps}from"node:path";var js=[".env","credentials","secret","auth","password","token","api.key","private.key",".pem","oauth","jwt","session","cookie","encryption","crypto"];function Hs(){let t=`${l()}/.claude/hooks/logs`;try{At(t,{recursive:!0})}catch{}return`${t}/auto-spawn-quality.log`}function Ns(){return`${l()}/.claude/context/spawn-queue.json`}function x(t){let e=Hs(),n=new Date().toISOString();try{h(e,`[${n}] [auto-spawn-quality] ${t}
`)}catch{}}function Ms(t){let e=t.toLowerCase();for(let n of js)if(e.includes(n))return x(`Detected sensitive pattern: ${n}`),!0;return!1}function Fs(t,e,n,r,s,i){let o=`SPAWN-${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,14)}-${Math.floor(Math.random()*1e4).toString().padStart(4,"0")}`,a=Ns(),u=Ps(a);try{At(u,{recursive:!0})}catch{}let g;if(Es(a))try{g=JSON.parse(Os(a,"utf8"))}catch{g={schema_version:"1.0.0",created_at:i,queue:[]}}else g={schema_version:"1.0.0",created_at:i,queue:[]};let p={spawn_id:o,target_agent:e,trigger_agent:t,trigger_reason:n,priority:r,timestamp:i,session_id:s,status:"queued"};g.queue.push(p);try{Ee(a,JSON.stringify(g,null,2)),x(`Queued spawn request: ${o} for ${e} (reason: ${n})`)}catch{return x(`ERROR: Failed to queue spawn request for ${e}`),""}return o}function Ls(t,e,n,r,s,i){let o=`${l()}/.claude/context/handoffs`;try{At(o,{recursive:!0})}catch{}let a=`${o}/auto_spawn_${e}_${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,15)}.json`,u={type:"auto_spawn_suggestion",from_agent:t,to_agent:e,timestamp:i,trigger_reason:n,priority:r,session_id:s,auto_triggered:!0,status:"suggested"};try{Ee(a,JSON.stringify(u,null,2)),x(`Created spawn suggestion: ${e} (reason: ${n})`)}catch{}}function Us(t,e,n){if(n&&n!=="null")return x(`Skipping auto-spawn - agent ${t} had errors: ${n}`),null;if(t==="test-generator")return x("Rule matched: test-generator -> code-quality-reviewer"),{target:"code-quality-reviewer",reason:"test-generator completed - validating test quality and coverage",priority:"high"};if(Ms(e)&&t!=="security-auditor"&&t!=="security-layer-auditor")return x("Rule matched: sensitive files detected -> security-auditor"),{target:"security-auditor",reason:"sensitive file changes detected - security audit required",priority:"critical"};if(t==="code-quality-reviewer")return x("Rule matched: code-quality-reviewer -> security-auditor"),{target:"security-auditor",reason:"code-quality-reviewer completed - proceeding with security scan",priority:"high"};if(t==="backend-system-architect"){let r=e.toLowerCase();if(/authentication|authorization|security|access.control|rbac|acl/.test(r))return x("Rule matched: backend-system-architect with auth -> security-layer-auditor"),{target:"security-layer-auditor",reason:"backend-system-architect designed auth/security layer - validation required",priority:"high"}}return null}function Oe(t){let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",s=t.session_id,i=t.agent_output||t.output||"",o=t.error||"";if(x(`Checking auto-spawn conditions for agent: ${r} (session: ${s})`),r==="unknown"||!r)return x("Skipping unknown agent type"),d();let a=Us(r,i,o);if(a){let u=Fs(r,a.target,a.reason,a.priority,s,e);return Ls(r,a.target,a.reason,a.priority,s,e),x(`=== AUTO-SPAWN QUALITY HOOK ===
Trigger Agent: ${r}
Target Agent: ${a.target}
Reason: ${a.reason}
Priority: ${a.priority}
Spawn ID: ${u}
Timestamp: ${e}
Session: ${s}`),{continue:!0,systemMessage:`Auto-spawn queued: ${a.target} (${a.priority} priority)`}}return x(`No auto-spawn conditions matched for ${r}`),d()}import{existsSync as Bs,writeFileSync as Me,mkdirSync as qs,readFileSync as Gs}from"node:fs";import{dirname as Dt}from"node:path";function Pe(){return`${l()}/.claude/context/knowledge/decisions/active.json`}function Js(){return`${l()}/.claude/context/session/state.json`}function zs(){return`${l()}/.claude/logs/agent-context`}function X(t){try{qs(t,{recursive:!0})}catch{}}function je(t,e){if(!Bs(t))return e;try{return JSON.parse(Gs(t,"utf8"))}catch{return e}}function He(t,e){let n=Dt(t);X(n);try{Me(t,JSON.stringify(e,null,2))}catch{}}var Ne=50;function Q(t){let e=t.subagent_type||t.agent_type||"unknown",n=new Date().toISOString(),r=t.agent_output||t.output||"",s=r.substring(0,200);r.length>200&&(s+="...");let i=e!=="unknown"||s.trim().length>0,o=e.replace(/-/g,"_");if(i){let k=Pe(),q=Dt(k);X(q);let H=je(k,{schema_version:"2.0.0",decisions:{}});(!H.decisions||typeof H.decisions!="object")&&(H.decisions={});let dn={timestamp:n,agent:e,summary:s,status:"completed"};H.decisions[o]=dn,He(k,H)}let a=Js(),u=Dt(a);X(u);let p=je(a,{schema_version:"2.0.0",session_id:"",started_at:n,last_activity:n,active_agent:null,tasks_pending:[],tasks_completed:[]});if(Array.isArray(p.tasks_completed)||(p.tasks_completed=[]),Array.isArray(p.tasks_pending)||(p.tasks_pending=[]),i){let k={agent:e,timestamp:n,summary:s};p.tasks_completed.push(k),p.tasks_completed.length>Ne&&(p.tasks_completed=p.tasks_completed.slice(-Ne))}p.last_activity=n,p.active_agent=null,He(a,p);let f=zs();X(f);let m=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),b=`${f}/${e}_${m}.log`,y=`=== CONTEXT PUBLICATION (Protocol 2.0) ===
Agent: ${e}
Timestamp: ${n}
Decisions file: ${Pe()}
Session state: ${a}

=== AGENT OUTPUT ===
${r}
`;try{Me(b,y)}catch{}return d()}import{existsSync as Ws,writeFileSync as Le,mkdirSync as Rt,readFileSync as Vs}from"node:fs";import{dirname as Ks}from"node:path";function Ct(){return!!(process.env.CLAUDE_CODE_TEAM_NAME||process.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS==="1")}var Fe=[{type:"product-thinking",name:"Product Thinking Pipeline",description:"Full product discovery and specification workflow",triggers:["should we build","product decision","feature validation","market research","user research"],steps:[{agent:"market-intelligence",description:"Analyze competitive landscape and market trends",dependsOn:[],skills:["market-research"],estimatedTokens:3e3},{agent:"ux-researcher",description:"Create personas and map user journeys",dependsOn:[0],skills:["user-research"],estimatedTokens:2500},{agent:"product-strategist",description:"Validate value proposition and alignment",dependsOn:[0,1],skills:["product-strategy"],estimatedTokens:2e3},{agent:"prioritization-analyst",description:"Score and prioritize using frameworks",dependsOn:[2],skills:["prioritization"],estimatedTokens:1500},{agent:"business-case-builder",description:"Build ROI and cost-benefit analysis",dependsOn:[2,3],skills:["business-case"],estimatedTokens:2e3},{agent:"requirements-translator",description:"Transform to PRD and user stories",dependsOn:[4],skills:["requirements"],estimatedTokens:2500}],estimatedTotalTokens:13500},{type:"full-stack-feature",name:"Full-Stack Feature Pipeline",description:"End-to-end feature implementation workflow",triggers:["full-stack feature","build a feature","implement end-to-end","create full feature","add complete feature"],steps:[{agent:"backend-system-architect",description:"Design API and database schema",dependsOn:[],skills:["api-design","database-patterns"],estimatedTokens:3e3},{agent:"frontend-ui-developer",description:"Build React components and UI",dependsOn:[0],skills:["react-server-components-framework","form-state-patterns"],estimatedTokens:3500},{agent:"test-generator",description:"Create unit and integration tests",dependsOn:[0,1],skills:["testing-patterns"],estimatedTokens:2e3},{agent:"security-auditor",description:"Audit for vulnerabilities",dependsOn:[0,1],skills:["security-patterns"],estimatedTokens:1500}],estimatedTotalTokens:1e4},{type:"ai-integration",name:"AI Integration Pipeline",description:"Add AI/LLM capabilities to application",triggers:["add rag","add llm","ai integration","implement rag","add ai feature","langgraph workflow"],steps:[{agent:"workflow-architect",description:"Design LangGraph workflow and state",dependsOn:[],skills:["langgraph"],estimatedTokens:2500},{agent:"llm-integrator",description:"Connect LLM APIs with function calling",dependsOn:[0],skills:["llm-integration"],estimatedTokens:2e3},{agent:"data-pipeline-engineer",description:"Build embeddings and data pipeline",dependsOn:[0],skills:["embeddings","rag-retrieval"],estimatedTokens:2500},{agent:"test-generator",description:"Create LLM testing infrastructure",dependsOn:[1,2],skills:["testing-patterns"],estimatedTokens:1500}],estimatedTotalTokens:8500},{type:"security-audit",name:"Security Audit Pipeline",description:"Comprehensive security review workflow",triggers:["security audit","security review","vulnerability scan","security assessment"],steps:[{agent:"security-auditor",description:"Scan for OWASP Top 10 vulnerabilities",dependsOn:[],skills:["security-patterns"],estimatedTokens:2e3},{agent:"security-layer-auditor",description:"Verify defense-in-depth layers",dependsOn:[0],skills:["security-patterns"],estimatedTokens:2e3},{agent:"ai-safety-auditor",description:"Audit AI/LLM security if applicable",dependsOn:[0],skills:["mcp-security-hardening"],estimatedTokens:1500}],estimatedTotalTokens:5500},{type:"frontend-compliance",name:"Frontend 2026 Compliance Pipeline",description:"Modernize frontend to 2026 patterns",triggers:["frontend compliance","modernize frontend","update react","frontend 2026"],steps:[{agent:"frontend-ui-developer",description:"Upgrade to React 19 patterns",dependsOn:[],skills:["react-server-components-framework","zustand-patterns"],estimatedTokens:3e3},{agent:"frontend-performance-engineer",description:"Optimize Core Web Vitals",dependsOn:[0],skills:["performance"],estimatedTokens:2e3},{agent:"accessibility-specialist",description:"Ensure WCAG 2.2 compliance",dependsOn:[0],skills:["testing-patterns","accessibility"],estimatedTokens:1500}],estimatedTotalTokens:6500}];function Xs(){return`${l()}/.claude/coordination/decision-log.json`}function Qs(){let t=`${l()}/.claude/hooks/logs`;try{Rt(t,{recursive:!0})}catch{}return`${t}/agent-feedback.log`}function T(t){let e=Qs(),n=new Date().toISOString();try{h(e,`[${n}] [feedback-loop] ${t}
`)}catch{}}function Ys(t){let e=$e();if(e){let r=Fe.find(s=>s.type===e.type);if(r){let s=r.steps.findIndex(i=>i.agent===t);if(s>=0){let i=r.steps.filter((o,a)=>o.dependsOn.includes(s)&&a>s).map(o=>o.agent);if(i.length>0)return i.join(" ")}}}return{"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"test-generator","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer"}[t]||""}function Zs(t){return{"market-intelligence":"product-thinking","product-strategist":"product-thinking","prioritization-analyst":"product-thinking","business-case-builder":"product-thinking","requirements-translator":"specification","metrics-architect":"specification","backend-system-architect":"architecture","database-engineer":"architecture","data-pipeline-engineer":"architecture","frontend-ui-developer":"frontend","rapid-ui-designer":"frontend","ux-researcher":"frontend","test-generator":"quality","code-quality-reviewer":"quality","security-auditor":"security","security-layer-auditor":"security","workflow-architect":"ai-integration","llm-integrator":"ai-integration","debug-investigator":"debugging"}[t]||"general"}function ti(){return process.env.CLAUDE_INSTANCE_ID||`${et("node:os").hostname()}-${process.pid}`}function ei(t){let e=t.substring(0,500);return t.length>500&&(e+="..."),e}function ni(t,e,n,r,s,i,o,a){let u=Xs(),g=Ks(u);try{Rt(g,{recursive:!0})}catch{}let p;if(Ws(u))try{p=JSON.parse(Vs(u,"utf8"))}catch{p={schema_version:"2.0.0",log_created_at:o,decisions:[]}}else p={schema_version:"2.0.0",log_created_at:o,decisions:[]};let f={decision_id:t,timestamp:o,made_by:{instance_id:ti(),agent_type:e},category:n,title:`Agent ${e} completed`,description:r,impact:{scope:"agent-pipeline",downstream_agents:s.split(" ").filter(Boolean)},status:i,task_id:a};p.decisions.push(f);try{Le(u,JSON.stringify(p,null,2)),T(`Decision ${t} logged for agent ${e}`)}catch{T("ERROR: Failed to write decision to log")}}function ri(t,e,n,r,s,i,o){if(!e)return;let a=`${l()}/.claude/context/handoffs`;try{Rt(a,{recursive:!0})}catch{}let u=e.split(" ").filter(Boolean),g=new Date().toISOString().replace(/[-:]/g,"").substring(0,15);for(let p of u){let f=`${a}/${t}_to_${p}_${g}.json`,m={from_agent:t,to_agent:p,timestamp:i,decision_id:r,summary:n,session_id:s,status:"pending",feedback_loop:!0,task_id:o};try{Le(f,JSON.stringify(m,null,2)),T(`Created handoff context: ${t} -> ${p}`)}catch{}}}function Y(t){if(Ct())return d();let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",s=t.session_id,i=t.agent_output||t.output||"",o=t.error||"";if(T(`Processing feedback for agent: ${r} (session: ${s})`),r==="unknown"||!r)return T("Skipping unknown agent type"),d();let a=new Date().toISOString().replace(/[-:T.]/g,"").substring(0,8),u=Math.floor(Math.random()*1e4).toString().padStart(4,"0"),g=`DEC-${a}-${u}`,f=D(r)?.taskId,m=Ys(r),b=Zs(r),y,k;return o&&o!=="null"?(y=`Agent failed: ${o}`,k="failed"):(y=ei(i),k="completed"),f&&(I(f,k==="completed"?"completed":"failed"),T(`Updated task ${f} status to ${k}`)),ni(g,r,b,y,m,k,e,f),m?(ri(r,m,y,g,s,e,f),T(`Routed findings to downstream agents: ${m}`)):T(`No downstream agents for ${r} (terminal agent)`),T(`=== AGENT FEEDBACK LOOP ===
Agent: ${r}
Category: ${b}
Decision ID: ${g}
Task ID: ${f||"none"}
Timestamp: ${e}
Status: ${k}
Downstream: ${m||"none"}

Summary: ${y}`),m?{continue:!0,systemMessage:`Feedback loop: routed to ${m}${f?` (task: ${f})`:""}`}:d()}import{writeFileSync as Ue,mkdirSync as Be}from"node:fs";var si=new Set(["market-intelligence","product-strategist","prioritization-analyst","business-case-builder","requirements-translator","metrics-architect","backend-system-architect","code-quality-reviewer","data-pipeline-engineer","database-engineer","debug-investigator","frontend-ui-developer","llm-integrator","rapid-ui-designer","security-auditor","security-layer-auditor","system-design-reviewer","test-generator","ux-researcher","workflow-architect"]),ii={"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"code-quality-reviewer","code-quality-reviewer":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"code-quality-reviewer","database-engineer":"backend-system-architect","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer","security-auditor":"none","security-layer-auditor":"none","debug-investigator":"none","system-design-reviewer":"none"},oi={"market-intelligence":"Next: product-strategist should define product vision based on market analysis","product-strategist":"Next: prioritization-analyst should rank features from strategy","prioritization-analyst":"Next: business-case-builder should create ROI justification","business-case-builder":"Next: requirements-translator should convert to technical specs","requirements-translator":"Next: metrics-architect should define success criteria","metrics-architect":"Next: backend-system-architect should design API endpoints","backend-system-architect":"Next: frontend-ui-developer should build UI components","frontend-ui-developer":"Next: test-generator should create test coverage","test-generator":"Next: code-quality-reviewer should validate implementation","code-quality-reviewer":"Next: security-auditor should perform security scan","workflow-architect":"Next: llm-integrator should configure LLM providers","llm-integrator":"Next: data-pipeline-engineer should set up embeddings","data-pipeline-engineer":"Next: code-quality-reviewer should validate data pipeline","database-engineer":"Next: backend-system-architect should integrate schema","rapid-ui-designer":"Next: frontend-ui-developer should implement designs","ux-researcher":"Next: rapid-ui-designer should create mockups"};function ai(t){return ii[t]||"none"}function ci(t){return oi[t]||"Pipeline complete"}function ui(t,e,n,r,s){let i=`${l()}/.claude/context/handoffs`;try{Be(i,{recursive:!0})}catch{}let o=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),a=`${i}/${t}_to_${e}_${o}.json`,u={from_agent:t,to_agent:e,timestamp:n,summary:r,suggestions:s,status:"ready_for_handoff"};try{Ue(a,JSON.stringify(u,null,2))}catch{}return a}function gi(t,e,n,r,s,i){let o=`${l()}/.claude/logs/agent-handoffs`;try{Be(o,{recursive:!0})}catch{}let a=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),u=`${o}/${t}_${a}.log`,g=`=== HANDOFF PREPARATION ===
From: ${t}
To: ${e}
Timestamp: ${n}
Handoff file: ${i}

Summary: ${r}

Next Steps: ${s}
`;try{Ue(u,g)}catch{}}function Z(t){let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown";if(!si.has(r))return d();let s=ai(r),i=t.agent_output||t.output||"",o=i.length,a;o>0?(a=i.substring(0,300),o>300&&(a+="...")):a=`Agent ${r} completed`;let u=ci(r),g=ui(r,s,e,a,u);return gi(r,s,e,a,u,g),d()}import{writeFileSync as li,mkdirSync as qe}from"node:fs";var di=["\\.env","auth","secret","credential","password","token","api[_-]?key","jwt","session","oauth","permission","\\.pem$","\\.key$","config.*prod"];function pi(){let t=`${l()}/.claude/logs/multi-claude`;try{qe(t,{recursive:!0})}catch{}return t}function C(t,e,n){let r=pi(),s=new Date().toISOString().substring(0,10).replace(/-/g,""),i=`${r}/verifier_${s}.log`,o=new Date().toISOString();try{h(i,`[${o}] [${t}] ${e}: ${n}
`)}catch{}}function mi(t){for(let e of di)if(new RegExp(e,"i").test(t))return!0;return!1}function Ge(t){let e=new Date().toISOString(),n=l(),s=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",i=t.agent_output||t.output||"",o=[];if(s==="test-generator"&&(o.push({agent:"code-quality-reviewer",reason:"Test generation complete - quality review recommended"}),C(s,"TRIGGER","test-generator completion triggers code-quality-reviewer")),s==="frontend-ui-developer"&&/form|input|validation|submit|auth|login/i.test(i)&&(o.push({agent:"security-auditor",reason:"Frontend auth/form components - security review recommended"}),C(s,"TRIGGER","frontend auth components trigger security-auditor")),s==="backend-system-architect"&&/endpoint|route|api|auth|jwt|session/i.test(i)&&(o.push({agent:"security-auditor",reason:"Backend API endpoints - security review recommended"}),C(s,"TRIGGER","backend API endpoints trigger security-auditor")),mi(i)&&(o.some(u=>u.agent==="security-auditor")||(o.push({agent:"security-auditor",reason:"Sensitive files modified - security review required"}),C(s,"TRIGGER","sensitive file patterns detected"))),s==="database-engineer"&&(o.push({agent:"code-quality-reviewer",reason:"Database schema changes - review for consistency"}),C(s,"TRIGGER","database changes trigger code-quality-reviewer")),s==="workflow-architect"&&(o.push({agent:"security-layer-auditor",reason:"LangGraph workflow created - layer audit recommended"}),C(s,"TRIGGER","workflow-architect triggers security-layer-auditor")),o.length>0){let a=`${n}/.claude/context/verification-queue`;try{qe(a,{recursive:!0})}catch{}let u=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),g=`${a}/pending_${u}_${s}.json`,p={triggered_by:s,timestamp:e,verifications:o.map(m=>({agent:m.agent,reason:m.reason,status:"pending"}))};try{li(g,JSON.stringify(p,null,2))}catch{}let f="Multi-Claude Verification Triggered: "+o.map(m=>`${m.agent} (${m.reason})`).join("; ");return C(s,"QUEUE",`Created verification queue: ${g}`),{continue:!0,systemMessage:f}}return C(s,"SKIP","No verification triggers matched"),d()}import{writeFileSync as fi,mkdirSync as yi}from"node:fs";function hi(){let t=`${l()}/.claude/logs/agent-validation`;try{yi(t,{recursive:!0})}catch{}return t}function Je(t){let e=t.subagent_type||t.agent_type||"unknown",n=new Date().toISOString(),r=t.agent_output||t.output||"",s=[],i=[];r||s.push("Agent produced empty output");let o=r.length;if(o<50&&i.push(`Output seems very short (${o} chars)`),/error|failed|exception/i.test(r)&&i.push("Output contains error-related keywords"),e==="backend-system-architect"&&r.includes("{")){let y=r.match(/\{[^}]*\}/);if(y)try{JSON.parse(y[0])}catch{i.push("JSON structure may be malformed")}}let a=s.length>0?"failed":"passed",u=t.last_assistant_message?.length??null,g=`Output Validation [${a}] - Agent: ${e}, Timestamp: ${n}, Output length: ${o} chars`+(u!==null?`, Response length: ${u} chars`:"");s.length>0&&(g+=` | Errors: ${s.join("; ")}`),i.length>0&&(g+=` | Warnings: ${i.join("; ")}`);let p=hi(),f=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),m=`${p}/${e}_${f}.log`,b=`=== OUTPUT VALIDATION ===
${g}
${u!==null?`Response quality signal: last_assistant_message length = ${u}
`:""}
=== AGENT OUTPUT ===
${r}
`;try{fi(m,b)}catch{}return a==="failed"?{continue:!1,systemMessage:g,hookSpecificOutput:{hookEventName:"SubagentStop"}}:{continue:!0,suppressOutput:!0,systemMessage:g}}import{existsSync as ki,writeFileSync as Si,readFileSync as _i}from"node:fs";var Et=Bt();function bi(){if(ki(Et))try{let t=JSON.parse(_i(Et,"utf8"));t.errors=(t.errors||0)+1,Si(Et,JSON.stringify(t,null,2))}catch{}}function ze(t){let e=t.agent_id||"",n=t.subagent_type||"",r=t.error||"";return c("subagent-quality-gate",`Quality gate check: ${n} (${e})`),r&&r!=="null"?(c("subagent-quality-gate",`ERROR: Subagent failed - ${r}`),bi(),R(`Subagent ${n} failed: ${r}`)):d()}function xi(t){let e=t.error||t.tool_error,n=t.exit_code;if(e&&e!=="null"&&e!==""||n!==void 0&&n!==0)return!1;let r=t.agent_output||t.output||"",s=[/\bfailed\b/i,/\berror:\s/i,/\bexception\b/i,/\bcould not\b/i,/\bunable to\b/i],i=r.slice(0,500);for(let o of s)o.test(i)&&c("task-completer",`Warning: possible error in output: ${o}`);return!0}function We(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return c("task-completer","No agent type found, skipping"),d();c("task-completer",`Processing SubagentStop for: ${n}`);let r=D(n);if(!r)return c("task-completer",`No orchestration task found for agent: ${n}`),lt(n),d();let s=xi(t),i=s?"completed":"failed";c("task-completer",`Agent ${n} completed with status: ${i}`),I(r.taskId,i),E(n,i);let o=`## Orchestration: Task ${s?"Completed":"Failed"}

Agent \`${n}\` has finished with status: **${i}**

${W({taskId:r.taskId,status:s?"completed":"pending"})}
`;if(s&&r.pipelineId&&r.pipelineStep!==void 0){let a=Ie(r.pipelineId,r.pipelineStep);if(a!==null){let u=xt(r.pipelineId).filter(g=>g.pipelineStep===a&&g.status==="pending");u.length>0&&(o+=`
### Pipeline Progress

Pipeline \`${r.pipelineId}\` step ${r.pipelineStep} complete.
Next step (${a}) is now unblocked.

**Next agent(s) to spawn:**
${u.map(g=>`- \`${g.agent}\` (task: ${g.taskId})`).join(`
`)}

Consider spawning the next agent to continue the pipeline.`)}else o+=`
### Pipeline Complete

Pipeline \`${r.pipelineId}\` has completed all steps.`}if(!s){let a=t.error||t.tool_error||"Unknown error";o+=`
### Error Details

The agent encountered an issue:
\`\`\`
${a.slice(0,500)}
\`\`\`

Consider:
1. Retrying with more specific instructions
2. Using an alternative agent
3. Breaking down the task further`;let u=ve(r.taskId);if(u.length>0){o+=`

### Orphaned Tasks (CC 2.1.20)

The following tasks were blocked by the failed task and should be deleted:
`;for(let g of u)o+=`
${xe(g.taskId,`Blocked by failed task ${r.taskId} (agent: ${n})`)}`,I(g.taskId,"failed")}}return i==="completed"&&lt(n),c("task-completer",`Completed task ${r.taskId} with status ${i}`),A(o)}var Ot=new Map;function vi(t,e){let n=Ot.get(t)||[];n.push(e),n.length>10&&n.shift(),Ot.set(t,n)}function $i(){let t=[];for(let[e,n]of Ot)n.some(r=>r.outcome==="failure")&&t.push(e);return t}function Ii(t){let e=t.error||t.tool_error,n=t.exit_code,r=t.agent_output||t.output||"";if(e&&e!=="null"&&e!=="")return{outcome:"failure",error:e};if(n!==void 0&&n!==0)return{outcome:"failure",error:`Exit code: ${n}`};let s=[/i cannot|i can't|i am unable/i,/outside my scope/i,/not appropriate/i,/i refuse/i];for(let o of s)if(o.test(r.slice(0,500)))return{outcome:"rejected",error:"Agent rejected the task"};let i=[/partial(?:ly)?/i,/incomplete/i,/some.*failed/i,/couldn't finish/i];for(let o of i)if(o.test(r.slice(0,500)))return{outcome:"partial"};return{outcome:"success"}}function Ve(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return d();let{outcome:r,error:s}=Ii(t);if(r==="success")return d();c("retry-handler",`Agent ${n} completed with outcome: ${r}`);let i=dt(),a=$().activeAgents.find(y=>y.agent===n),u=a?.retryCount||0,g=re(n,u+1,a?.taskId),p=se(g,r,s||void 0);vi(n,p);let f=$i(),m=ne(n,u+1,s||"Unknown failure",f,i.maxRetries);if(c("retry-handler",`Retry decision for ${n}: shouldRetry=${m.shouldRetry}, alternative=${m.alternativeAgent||"none"}`),m.shouldRetry)E(n,"retrying");else{E(n,"failed");let y=D(n);y&&I(y.taskId,"failed")}let b=ie(m,n);return A(b)}import{existsSync as tn,mkdirSync as Hi,readFileSync as Ni,writeFileSync as Mi}from"node:fs";import{existsSync as wi,readFileSync as Ti,writeFileSync as Yc,mkdirSync as Zc}from"node:fs";import{execSync as Ke}from"node:child_process";import{createHash as Ai}from"node:crypto";import*as Xe from"node:os";var Di=".claude/.user_identity.json",Ci="orchestkit-user-identity-v1";var _=null;function tt(t){return Ai("sha256").update(t+Ci).digest("hex").slice(0,32)}function Ri(){try{return Xe.hostname()}catch{return"unknown-machine"}}function Ei(t){let e=`${t}/${Di}`;if(!wi(e))return null;try{let n=Ti(e,"utf8");return JSON.parse(n)}catch(n){return c("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function Oi(t){let e={};try{e.email=Ke("git config user.email",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{e.name=Ke("git config user.name",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return e}function Pi(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function ji(t){if(_)return _;let e=t||l(),n=Ri(),r=Ei(e);if(r?.user_id)return _={user_id:r.user_id,display_name:r.display_name||r.user_id,team_id:r.team_id,machine_id:n,source:"config",anonymous_id:tt(r.user_id),email:r.user_id.includes("@")?r.user_id:void 0},c("user-identity",`Resolved from config: ${_.anonymous_id}`,"debug"),_;let s=Oi(e);if(s.email)return _={user_id:s.email,display_name:s.name||s.email.split("@")[0],team_id:r?.team_id,machine_id:n,source:"git",anonymous_id:tt(s.email),email:s.email},c("user-identity",`Resolved from git: ${_.anonymous_id}`,"debug"),_;let i=Pi();if(i.username){let a=`${i.username}@${n}`;return _={user_id:a,display_name:i.username,team_id:r?.team_id,machine_id:n,source:"env",anonymous_id:tt(a)},c("user-identity",`Resolved from env: ${_.anonymous_id}`,"debug"),_}let o=tt(n+process.pid);return _={user_id:`anon-${o.slice(0,8)}`,display_name:"Anonymous",team_id:r?.team_id,machine_id:n,source:"anonymous",anonymous_id:o},c("user-identity",`Resolved as anonymous: ${_.anonymous_id}`,"debug"),_}function Qe(){let t=ji();return{session_id:S(),user_id:t.user_id,anonymous_id:t.anonymous_id,team_id:t.team_id,machine_id:t.machine_id,identity_source:t.source,timestamp:new Date().toISOString()}}var Fi=/^[a-zA-Z0-9_-]{1,128}$/;function Li(t){return Fi.test(t)}function Ht(t,e){let n=t||S(),r=e||l();if(!Li(n))throw new Error("Invalid session ID format");return`${r}/.claude/memory/sessions/${n}`}function Ui(t,e){return`${Ht(t,e)}/events.jsonl`}function en(t,e){let n=Ht(t,e);tn(n)||Hi(n,{recursive:!0})}var B=0,Ye=!1,Pt=!1,Ze=0,Bi=5e3;function nn(t,e){return`${Ht(t,e)}/counter.json`}function qi(t,e){if(!Ye){Ye=!0;try{let n=nn(t,e);if(tn(n)){let r=JSON.parse(Ni(n,"utf8"));typeof r.counter=="number"&&r.counter>0&&(B=r.counter,c("session-tracker",`Loaded event counter: ${B}`,"debug"))}}catch{}}}function Gi(t,e){if(!Pt)return;let n=Date.now();if(!(n-Ze<Bi))try{en(t,e);let r=nn(t,e);Mi(r,JSON.stringify({counter:B,updated_at:new Date().toISOString()})),Pt=!1,Ze=n}catch{}}function Ji(){return qi(),B++,Pt=!0,Gi(),`evt-${Date.now()}-${B}`}function rn(t,e,n={}){try{let r={event_id:Ji(),event_type:t,identity:Qe(),payload:{name:e,input:jt(n.input),output:jt(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?sn(n.context,500):void 0,confidence:n.confidence}};en();let s=Ui();h(s,`${JSON.stringify(r)}
`),c("session-tracker",`Tracked ${t}: ${e}`,"debug")}catch(r){c("session-tracker",`Failed to track event: ${r}`,"warn")}}function sn(t,e){return t.length<=e?t:`${t.slice(0,e-3)}...`}function jt(t){if(!t)return;let e={},n=["password","secret","token","key","credential","auth"];for(let[r,s]of Object.entries(t)){if(n.some(i=>r.toLowerCase().includes(i))){e[r]="[REDACTED]";continue}if(typeof s=="string"&&s.length>500){e[r]=sn(s,500);continue}if(typeof s=="object"&&s!==null&&!Array.isArray(s)){e[r]=jt(s);continue}e[r]=s}return e}import{mkdirSync as zi,statSync as Wi,renameSync as Vi}from"node:fs";import{createHash as Ki}from"node:crypto";function Xi(){return ot(st(),".claude","analytics")}function on(t){return Ki("sha256").update(t).digest("hex").slice(0,12)}function an(){let t=process.env.CLAUDE_CODE_TEAM_NAME;return t?{team:t}:void 0}function Qi(t,e=10485760){try{if(Wi(t).size>e){let r=new Date().toISOString().slice(0,7),s=t.replace(/\.jsonl$/,`.${r}.jsonl`);Vi(t,s)}}catch{}}function Yi(){return!!(process.env.VITEST||process.env.JEST_WORKER_ID)}function cn(t,e){if(!Yi())try{let n=Xi();zi(n,{recursive:!0});let r=ot(n,t);Qi(r),h(r,`${JSON.stringify(e)}
`)}catch{}}var un=[{name:"context-publisher",fn:Q},{name:"handoff-preparer",fn:Z},{name:"feedback-loop",fn:Y},{name:"agent-memory-store",fn:K}];function Zi(t){try{let e=t.tool_input?.subagent_type||t.subagent_type||t.agent_type||"unknown",n=t.tool_input?.name||void 0,r=!t.error,s=t.duration_ms,i=t.agent_output||t.output||"",o=typeof i=="string"?i.length:0;rn("agent_spawned",e,{success:r,duration_ms:s,output:{has_output:o>0,output_length:o,has_error:!!t.error},context:t.agent_id});let a=t.tool_input?.model||process.env.CLAUDE_MODEL||"unknown";cn("agent-usage.jsonl",{ts:new Date().toISOString(),pid:on(process.env.CLAUDE_PROJECT_DIR||""),agent:e,agent_name:n??null,model:a,duration_ms:s,success:r,output_len:o,last_msg_len:t.last_assistant_message?.length??null,...an()})}catch{}}async function gn(t){Zi(t);let n=(await Promise.allSettled(un.map(async r=>{try{let s=r.fn(t);return s instanceof Promise&&await s,{hook:r.name,status:"success"}}catch(s){let i=s instanceof Error?s.message:String(s);return c("subagent-stop-dispatcher",`${r.name} failed: ${i}`),{hook:r.name,status:"error",message:i}}}))).filter(r=>r.status==="rejected"||r.status==="fulfilled"&&r.value.status==="error");return n.length>0&&c("subagent-stop-dispatcher",`${n.length}/${un.length} hooks had errors`),d()}var ln={"subagent-start/graph-memory-inject":de,"subagent-start/context-gate":fe,"subagent-start/subagent-context-stager":ke,"subagent-start/subagent-validator":Se,"subagent-start/task-linker":we,"subagent-start/model-cost-advisor":De,"subagent-start/issue-context-injector":Ce,"subagent-stop/agent-memory-store":K,"subagent-stop/auto-spawn-quality":Oe,"subagent-stop/context-publisher":Q,"subagent-stop/feedback-loop":Y,"subagent-stop/handoff-preparer":Z,"subagent-stop/multi-claude-verifier":Ge,"subagent-stop/output-validator":Je,"subagent-stop/subagent-quality-gate":ze,"subagent-stop/task-completer":We,"subagent-stop/retry-handler":Ve,"subagent-stop/unified-dispatcher":gn};function Lu(t){return ln[t]}function Uu(){return Object.keys(ln)}export{Uo as DEFAULT_CONFIG,Lo as THRESHOLDS,Qo as addToPromptHistory,oa as analyzeAttemptHistory,pa as applyDecay,Zo as cacheClassification,tr as calculateBackoffDelay,ra as cleanupOldStates,na as clearSessionState,se as completeAttempt,re as createAttempt,Mo as escapeRegex,Jn as estimateTokenCount,ie as formatRetryDecision,zo as getActiveAgent,ma as getAdjustments,fa as getAgentSuccessRate,pt as getAlternativeAgent,Vt as getCachedBranch,ya as getCalibrationStats,$o as getEnvFile,Ho as getField,Lu as getHook,Xo as getInjectedSkills,ta as getLastClassification,Wt as getLogDir,Ln as getLogLevel,J as getPluginRoot,l as getProjectDir,Yo as getPromptHistory,S as getSessionId,ha as hasMinimalCalibrationData,gr as hashPrompt,ln as hooks,Wo as isAgentDispatched,eo as isBashInput,ro as isEditInput,so as isReadInput,er as isRetryableError,Ko as isSkillInjected,no as isWriteInput,Uu as listHooks,F as loadCalibrationData,dt as loadConfig,$ as loadState,c as logHook,Oo as logPermissionFeedback,ne as makeRetryDecision,No as normalizeCommand,Io as normalizeLineEndings,Do as outputAllowWithContext,To as outputBlock,ct as outputDeny,Co as outputError,Bn as outputPromptContext,Po as outputPromptContextBudgeted,wo as outputSilentAllow,d as outputSilentSuccess,Ro as outputStderrWarning,R as outputWarning,A as outputWithContext,Ao as outputWithNotification,Eo as outputWithUpdatedInput,aa as prepareForRetry,jo as readHookInput,da as recordOutcome,lt as removeAgent,ur as saveCalibrationData,ea as saveConfig,Wn as saveState,Un as shouldLog,nr as suggestsAlternative,Jo as trackDispatchedAgent,Vo as trackInjectedSkill,E as updateAgentStatus,P as updateState};
//# sourceMappingURL=subagent.mjs.map
