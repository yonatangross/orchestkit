// OrchestKit Hooks - subagent bundle
// Generated: 2026-02-13T21:20:01.576Z

var tt=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,n)=>(typeof require<"u"?require:e)[n]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});function Oi(t){return typeof t.command=="string"}function Ei(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function Pi(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function Hi(t){return typeof t.file_path=="string"&&t.content===void 0}import{appendFileSync as Ft,existsSync as Lt,statSync as In,renameSync as $n,mkdirSync as wn,readSync as Tn}from"node:fs";import{execSync as An}from"node:child_process";import on from"node:os";import B from"node:path";function et(){return process.env.HOME||process.env.USERPROFILE||on.homedir()}function nt(){return process.env.CLAUDE_PROJECT_DIR||"."}function Pt(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function Ht(){return process.env.CLAUDE_PLUGIN_ROOT?B.join(et(),".claude","logs","ork"):B.join(nt(),".claude","logs")}var rt=B.join,Fi=B.sep;import{execSync as an}from"node:child_process";import{createHash as cn}from"node:crypto";import{existsSync as Nt,readFileSync as un,writeFileSync as gn,mkdirSync as dn}from"node:fs";import{join as st,basename as ln}from"node:path";var pn=20,mn=15,fn=/[^a-z0-9-]/g;function yn(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=ln(e);return jt(n,pn)}function hn(t){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=an("git branch --show-current",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),r=jt(n||"detached",mn);return process.env.ORCHESTKIT_SESSION_BRANCH=r,r}catch{return"nobranch"}}function kn(t){let e=t||new Date,n=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${n}${r}`}function Sn(t){let e=t||new Date,n=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0");return`${n}${r}`}function _n(){let t=`${process.pid}-${Date.now()}-${Math.random()}`;return cn("sha256").update(t).digest("hex").slice(0,4)}function jt(t,e){return t.toLowerCase().replace(fn,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,e)}function bn(t,e){let n=yn(t),r=hn(t),s=kn(e),i=Sn(e),o=_n();return`${n}-${r}-${s}-${i}-${o}`}function vn(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=st(e,".instance","session-id.json");if(Nt(n))try{let r=JSON.parse(un(n,"utf8"));if(r.session_id&&r.created_at){let s=Date.now()-new Date(r.created_at).getTime(),i=1440*60*1e3;if(s<i)return r.session_id}}catch{}}function xn(t,e){let n=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),r=st(n,".instance"),s=st(r,"session-id.json");try{Nt(r)||dn(r,{recursive:!0}),gn(s,JSON.stringify({session_id:t,created_at:new Date().toISOString()},null,2))}catch{}}function Mt(t){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let e=vn(t);if(e)return e;let n=bn(t);return xn(n,t),n}function Ut(){return Ht()}function d(){return nt()}function q(){return Pt()}function Xi(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${q()}/.claude/.instance_env`}function y(){return Mt()}function Qi(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let e=An("git branch --show-current",{cwd:t||d(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function Dn(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Yi(t){return t.replace(/\r\n/g,`
`)}function Cn(t){let e=["debug","info","warn","error"];return e.indexOf(t)>=e.indexOf(Dn())}function l(){return{continue:!0,suppressOutput:!0}}function Zi(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function to(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function T(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function Rn(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function eo(t,e){let n={continue:!0,suppressOutput:!0};return t&&(n.systemMessage=t),e&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:e}),n}function no(t,e){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?n.systemMessage=e:n.suppressOutput=!0,n}function ro(t){return{continue:!0,systemMessage:t}}function C(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function so(t){process.stderr.write(`\u26A0 ${t}
`),process.exit(2)}function it(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}function io(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:t}}}var On=200*1024,En=100*1024;function Bt(t,e){if(Lt(t))try{if(In(t).size>e){let r=`${t}.old.${Date.now()}`;$n(t,r)}}catch{}}function qt(t){Lt(t)||wn(t,{recursive:!0})}function c(t,e,n="debug"){if(!Cn(n))return;let r=Ut(),s=`${r}/hooks.log`;try{qt(r),Bt(s,On);let i=new Date().toISOString().replace("T"," ").slice(0,19);Ft(s,`[${i}] [${n.toUpperCase()}] [${t}] ${e}
`)}catch{}}function oo(t,e,n){let r=Ut(),s=`${r}/permission-feedback.log`;try{qt(r),Bt(s,En);let i=new Date().toISOString(),o=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",a=n?.session_id||y();Ft(s,`${i} | ${t} | ${e} | tool=${o} | session=${a}
`)}catch{}}function Pn(t){if(!t)return 0;let r=(t.match(/[{};()=><]/g)||[]).length/t.length>.03?2.8:3.5;return Math.ceil(t.length/r)}function ao(t,e,n,r,s){let i=Pn(t);return r&&r.isOverBudget(n)?(c(e,`Budget exhausted for ${n}, suppressing ${i}t`),l()):(s&&s.trackTokenUsage(e,n,i),Rn(t))}function co(){try{let t=[],n=Buffer.allocUnsafe(256),r,s=0;for(;;)try{if(r=Tn(s,n,0,256,null),r===0)break;t.push(Buffer.from(n.subarray(0,r)))}catch{break}let i=Buffer.concat(t).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:y(),tool_input:{}}}catch{return{tool_name:"",session_id:y(),tool_input:{}}}}function uo(t,e){let n=e.replace(/^\./,"").split("."),r=t;for(let s of n){if(r==null)return;r=r[s]}return r}function go(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function lo(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var mo={AUTO_DISPATCH:85,SKILL_INJECT:80,STRONG_RECOMMEND:70,SUGGEST:50,MINIMUM:40},fo={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};import{existsSync as N,readFileSync as Jt,writeFileSync as zt,mkdirSync as Hn}from"node:fs";function ot(){return`${d()}/.claude/orchestration`}function at(){let t=y();return`${ot()}/session-${t}.json`}function Wt(){return`${d()}/.claude/orchestration/config.json`}function Vt(){let t=ot();if(!N(t))try{Hn(t,{recursive:!0})}catch{c("orchestration-state",`Failed to create state dir: ${t}`)}}function x(){let t=at();if(N(t))try{let e=Jt(t,"utf8");return JSON.parse(e)}catch(e){c("orchestration-state",`Failed to load state: ${e}`)}return{sessionId:y(),activeAgents:[],injectedSkills:[],promptHistory:[],maxHistorySize:10,updatedAt:new Date().toISOString()}}function Nn(t){Vt();let e=at();t.updatedAt=new Date().toISOString();try{zt(e,JSON.stringify(t,null,2))}catch(n){c("orchestration-state",`Failed to save state: ${n}`)}}function E(t){let e=x();return t(e),Nn(e),e}function So(t,e,n){let r={agent:t,taskId:n,confidence:e,dispatchedAt:new Date().toISOString(),status:"pending",retryCount:0,maxRetries:3};return E(s=>{s.activeAgents=s.activeAgents.filter(i=>i.agent!==t),s.activeAgents.push(r)}),c("orchestration-state",`Tracked dispatched agent: ${t} (conf: ${e})`),r}function R(t,e,n){E(r=>{let s=r.activeAgents.find(i=>i.agent===t);s&&(s.status=e,n&&(s.taskId=n),e==="retrying"&&s.retryCount++)}),c("orchestration-state",`Updated agent status: ${t} -> ${e}`)}function ct(t){E(e=>{e.activeAgents=e.activeAgents.filter(n=>n.agent!==t)})}function _o(){return x().activeAgents.find(e=>e.status==="in_progress")}function bo(t){return x().activeAgents.some(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function vo(t){E(e=>{e.injectedSkills.includes(t)||e.injectedSkills.push(t)})}function xo(t){return x().injectedSkills.includes(t)}function Io(){return x().injectedSkills}function $o(t){E(e=>{e.promptHistory.push(t),e.promptHistory.length>e.maxHistorySize&&(e.promptHistory=e.promptHistory.slice(-e.maxHistorySize))})}function wo(){return x().promptHistory}function To(t){E(e=>{e.lastClassification=t})}function Ao(){return x().lastClassification}var Gt={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function ut(){let t=Wt();if(N(t))try{let e=Jt(t,"utf8");return{...Gt,...JSON.parse(e)}}catch{}return Gt}function Do(t){Vt();let e=Wt(),r={...ut(),...t};try{zt(e,JSON.stringify(r,null,2))}catch(s){c("orchestration-state",`Failed to save config: ${s}`)}}function Co(){let t=at();try{if(N(t)){let{unlinkSync:e}=tt("node:fs");e(t),c("orchestration-state","Cleared session state")}}catch{}}function Ro(){let t=ot();if(N(t))try{let{readdirSync:e,statSync:n,unlinkSync:r}=tt("node:fs"),s=e(t).filter(i=>i.startsWith("session-")&&i.endsWith(".json")).map(i=>({name:i,path:`${t}/${i}`,mtime:n(`${t}/${i}`).mtime.getTime()})).sort((i,o)=>o.mtime-i.mtime);for(let i of s.slice(5))try{r(i.path),c("orchestration-state",`Cleaned up old state: ${i.name}`)}catch{}}catch{}}var jn=3,Mn=1e3,Fn=3e4,Ln={"backend-system-architect":["database-engineer","api-designer"],"frontend-ui-developer":["rapid-ui-designer","accessibility-specialist"],"test-generator":["debug-investigator","code-quality-reviewer"],"security-auditor":["security-layer-auditor"],"workflow-architect":["llm-integrator","data-pipeline-engineer"]},Un=[/permission denied/i,/access denied/i,/not found.*(?:file|module|package)/i,/(?:file|module|package)\s+not\s+found/i,/missing required/i,/invalid (?:api|token|key)/i,/authentication failed/i,/quota exceeded/i,/rate limit/i],Bn=[/not my specialization/i,/outside my scope/i,/better suited for/i,/consider using/i,/specialized agent/i];function qn(t,e=Mn){let n=e*Math.pow(2,t-1),r=Math.random()*.1*n;return Math.min(n+r,Fn)}function Gn(t){for(let e of Un)if(e.test(t))return!1;return!0}function Jn(t){for(let e of Bn)if(e.test(t))return!0;return!1}function gt(t,e=[]){let n=Ln[t];if(n){for(let r of n)if(!e.includes(r))return r}}function Kt(t,e,n,r=[],s=jn){if(c("retry-manager",`Evaluating retry for ${t}, attempt ${e}`),e>=s){let o=gt(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Max retries (${s}) exceeded`+(o?`. Consider trying ${o} instead.`:"")}}if(!Gn(n)){let o=gt(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Non-retryable error detected: ${n.slice(0,100)}`}}if(Jn(n)){let o=gt(t,r);if(o)return{shouldRetry:!1,retryCount:e,maxRetries:s,alternativeAgent:o,reason:`Error suggests using alternative agent: ${o}`}}let i=qn(e);return{shouldRetry:!0,retryCount:e,maxRetries:s,delayMs:i,reason:`Retrying (attempt ${e+1}/${s}) after ${Math.round(i/1e3)}s`}}function Xt(t,e,n){return{agent:t,taskId:n,attemptNumber:e,startedAt:new Date().toISOString()}}function Qt(t,e,n){let r=new Date().toISOString(),s=new Date(r).getTime()-new Date(t.startedAt).getTime();return{...t,completedAt:r,outcome:e,error:n,durationMs:s}}function Po(t){if(t.length===0)return{successRate:0,avgDuration:0,commonErrors:[]};let n=t.filter(a=>a.outcome==="success").length/t.length,r=t.filter(a=>a.durationMs!==void 0).map(a=>a.durationMs),s=r.length>0?r.reduce((a,u)=>a+u,0)/r.length:0,i=new Map;for(let a of t)if(a.error){let u=a.error.slice(0,50).toLowerCase();i.set(u,(i.get(u)||0)+1)}let o=Array.from(i.entries()).sort((a,u)=>u[1]-a[1]).slice(0,3).map(([a])=>a);return{successRate:n,avgDuration:s,commonErrors:o}}function Ho(t,e){return{...t,status:"retrying",retryCount:e.retryCount}}function Yt(t,e){if(t.shouldRetry)return`## Retry Scheduled

Agent \`${e}\` will retry after ${Math.round((t.delayMs||0)/1e3)} seconds.

**Attempt:** ${t.retryCount+1} of ${t.maxRetries}
**Reason:** ${t.reason}`;let n=`## Retry Not Recommended

Agent \`${e}\` has ${t.retryCount>=t.maxRetries?"exhausted retries":"encountered a non-retryable error"}.

**Reason:** ${t.reason}`;return t.alternativeAgent&&(n+=`

### Alternative Suggestion

Consider using \`${t.alternativeAgent}\` instead:

\`\`\`
Task tool with subagent_type: "${t.alternativeAgent}"
\`\`\``),n}import{existsSync as ne,readFileSync as zn,writeFileSync as Wn,mkdirSync as Vn}from"node:fs";import{createHash as Kn}from"node:crypto";var Zt=500,dt=3,te=15,ee=3,Xn=.9;function re(){return`${d()}/.claude/feedback/calibration-data.json`}function Qn(){let t=`${d()}/.claude/feedback`;if(!ne(t))try{Vn(t,{recursive:!0})}catch{}}function j(){let t=re();if(ne(t))try{return JSON.parse(zn(t,"utf8"))}catch{c("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function Yn(t){Qn();let e=re();t.updatedAt=new Date().toISOString();try{Wn(e,JSON.stringify(t,null,2)),c("calibration-engine","Saved calibration data")}catch(n){c("calibration-engine",`Failed to save calibration data: ${n}`)}}function Zn(t){return Kn("sha256").update(t.toLowerCase().trim()).digest("hex").slice(0,16)}function Lo(t,e,n,r,s,i,o){let a=j(),u={timestamp:new Date().toISOString(),sessionId:y(),agent:e,promptHash:Zn(t),matchedKeywords:n,dispatchConfidence:r,outcome:s,durationMs:i,feedback:o};a.records.push(u),a.records.length>Zt&&(a.records=a.records.slice(-Zt)),tr(a,u),er(a),Yn(a),c("calibration-engine",`Recorded outcome: ${e} -> ${s} (conf: ${r})`)}function tr(t,e){let n=e.outcome==="success",r=e.outcome==="failure"||e.outcome==="rejected";if(!n&&!r)return;let s=n?ee:-ee;for(let i of e.matchedKeywords){let o=t.adjustments.find(a=>a.keyword===i&&a.agent===e.agent);o?(o.adjustment=Math.max(-te,Math.min(te,o.adjustment+s)),o.sampleCount++,o.lastUpdated=new Date().toISOString()):t.adjustments.push({keyword:i,agent:e.agent,adjustment:s,sampleCount:1,lastUpdated:new Date().toISOString()})}}function Uo(t){let e=Date.now(),n=1440*60*1e3;for(let r of t.adjustments){let s=e-new Date(r.lastUpdated).getTime();Math.floor(s/n)>7&&(r.adjustment=Math.round(r.adjustment*Xn),Math.abs(r.adjustment)<1&&(r.adjustment=0))}t.adjustments=t.adjustments.filter(r=>r.adjustment!==0)}function er(t){let e=t.records;if(e.length===0)return;t.stats.totalDispatches=e.length;let n=e.filter(i=>i.outcome==="success").length;t.stats.successRate=n/e.length;let r=e.reduce((i,o)=>i+o.dispatchConfidence,0)/e.length;t.stats.avgConfidence=Math.round(r);let s=new Map;for(let i of e){let o=s.get(i.agent)||{count:0,success:0};o.count++,i.outcome==="success"&&o.success++,s.set(i.agent,o)}t.stats.topAgents=Array.from(s.entries()).map(([i,o])=>({agent:i,count:o.count,successRate:o.success/o.count})).sort((i,o)=>o.count-i.count).slice(0,10)}function Bo(){return j().adjustments.filter(e=>e.sampleCount>=dt)}function qo(t){let n=j().records.filter(s=>s.agent===t);return n.length<dt?null:n.filter(s=>s.outcome==="success").length/n.length}function Go(){return j().stats}function Jo(){return j().records.length>=dt}import{existsSync as nr,statSync as rr}from"node:fs";import{resolve as sr}from"node:path";var ie={"database-engineer":"database schema SQL PostgreSQL migration pgvector","backend-system-architect":"API REST architecture backend FastAPI microservice","frontend-ui-developer":"React frontend UI component TypeScript Tailwind","security-auditor":"security OWASP vulnerability audit authentication","test-generator":"testing unit integration coverage pytest MSW","workflow-architect":"LangGraph workflow agent orchestration state","llm-integrator":"LLM API OpenAI Anthropic embeddings RAG function-calling","data-pipeline-engineer":"data pipeline embeddings vector ETL chunking","metrics-architect":"metrics OKR KPI analytics instrumentation","ux-researcher":"UX user research persona journey accessibility","code-quality-reviewer":"code quality review linting type-check patterns","infrastructure-architect":"infrastructure cloud Docker Kubernetes deployment","ci-cd-engineer":"CI CD pipeline GitHub Actions deployment automation","accessibility-specialist":"accessibility WCAG ARIA screen-reader a11y","product-strategist":"product strategy roadmap features prioritization"};function ir(t){return ie[t]||t}var se=100;function oe(t){c("graph-memory-inject","Graph memory inject hook starting");let e=sr(d(),".claude/memory/knowledge-graph.jsonl");if(!nr(e))return c("graph-memory-inject","No graph data file, skipping"),l();try{let u=rr(e).size;if(u<se)return c("graph-memory-inject",`Graph too small (${u}B < ${se}B), skipping`),l()}catch{return c("graph-memory-inject","Could not stat graph file, skipping"),l()}let n=t.tool_input||{},r=n.subagent_type||n.type||"";if(!r&&n.prompt){let u=n.prompt.toLowerCase(),g=Object.keys(ie);for(let p of g)if(u.includes(p)){r=p;break}}if(!r)return c("graph-memory-inject","No agent type detected, passing through"),l();let s=`ork:${r}`,i=ir(r);c("graph-memory-inject",`Detected agent type: ${r} (agent_id: ${s})`);let o=`[Graph Memory - Agent Context Load]

Execute this MCP call to load graph context for ${r} agent:

## Graph Memory Entities
\`\`\`
mcp__memory__search_nodes
{"query": "${r} ${i}"}
\`\`\`

## Integration Instructions
1. Execute the graph search to retrieve relevant entities and relationships
2. Review entities for patterns, decisions, and constraints
3. Check relationships between concepts
4. Apply learned patterns to current task

Agent ID: ${s} | Domain: ${i}`,a=`[Graph Memory] Agent: ${r} | ID: ${s} | Load graph context via MCP call above`;return c("graph-memory-inject",`Outputting graph memory instructions for ${r}`),{continue:!0,systemMessage:a,hookSpecificOutput:{additionalContext:o}}}import{existsSync as M,readFileSync as J,writeFileSync as pt,mkdirSync as or}from"node:fs";import{dirname as ar}from"node:path";var G=4,lt=6,cr=3,ur=/^(test-generator|backend-system-architect|workflow-architect|security-auditor|llm-integrator)$/;function mt(){return`${d()}/.claude/logs/agent-state.json`}function ce(){return`${d()}/.claude/logs/subagent-spawns.jsonl`}function gr(){let t=mt(),e=ar(t);try{or(e,{recursive:!0})}catch{}if(!M(t)){let n={active_background:[],session_total:0,last_cleanup:null,blocked_count:0};try{pt(t,JSON.stringify(n,null,2))}catch{}}}function dr(){let t=ce();if(!M(t))return 0;try{let r=J(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),s=new Date(Date.now()-300*1e3).toISOString(),i=0;for(let o of r)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>s&&i++}catch{}return i}catch{return 0}}function lr(){let t=ce();if(!M(t))return 0;try{let r=J(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),s=new Date(Date.now()-2*1e3).toISOString(),i=0;for(let o of r)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>s&&i++}catch{}return i}catch{return 0}}function pr(){let t=mt();try{if(M(t)){let e=JSON.parse(J(t,"utf8"));e.blocked_count=(e.blocked_count||0)+1,pt(t,JSON.stringify(e,null,2))}}catch{}}function ae(){let t=mt();try{if(M(t)){let e=JSON.parse(J(t,"utf8"));e.session_total=(e.session_total||0)+1,pt(t,JSON.stringify(e,null,2))}}catch{}}function ue(t){gr();let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"",s=e.run_in_background===!0||e.run_in_background==="true";c("context-gate",`Context gate check: ${n} (background=${s})`);let i=dr(),o=lr();return c("context-gate",`Active background: ${i}, Current response: ${o}`),o>=lt?(c("context-gate",`BLOCKED: Too many agents in single response (${o} >= ${lt})`),it(`Context Overflow Protection

Too many agents spawned in a single response (${o} agents).

Maximum allowed: ${lt} per response

SOLUTION: Split into multiple responses or use sequential execution.
Consider using the /context-optimization skill first.

Attempted: ${n} - ${r}`)):s&&i>=G?(c("context-gate",`BLOCKED: Too many concurrent background agents (${i} >= ${G})`),pr(),it(`Background Agent Limit

Too many background agents running concurrently (${i} active).

Maximum allowed: ${G} concurrent background agents

SOLUTION:
1. Wait for existing agents to complete
2. Run this agent in foreground (remove run_in_background)
3. Use /context-optimization to free up context

Attempted: ${n} - ${r}`)):i>=cr?(c("context-gate","WARNING: Approaching context budget limit"),ae(),C(`Context Budget Warning

${i} background agents active (limit: ${G}).

Consider:
- Running remaining agents sequentially
- Using /context-optimization skill
- Waiting for current agents to complete

Proceeding with: ${n} - ${r}`)):ur.test(n)&&i>=2?(c("context-gate",`WARNING: Expensive agent type with multiple active: ${n}`),C(`Spawning expensive agent (${n}) with ${i} others active`)):(ae(),c("context-gate",`Context gate passed: ${n}`),l())}import{existsSync as ft,readFileSync as de,readdirSync as mr}from"node:fs";function fr(){return`${d()}/.claude/context/session/state.json`}function yr(){return`${d()}/.claude/context/knowledge/decisions/active.json`}function hr(){return`${d()}/docs/issues`}function kr(){let t=fr();if(!ft(t))return{count:0,summary:""};try{let n=JSON.parse(de(t,"utf8")).tasks_pending||[],r=n.length;if(r===0)return{count:0,summary:""};let s=n.slice(0,3).map(i=>`- ${i}`).join(`
`);return{count:r,summary:s}}catch{return{count:0,summary:""}}}function ge(t,e){let n=yr();if(!ft(n))return"";try{return(JSON.parse(de(n,"utf8")).decisions||[]).filter(o=>o.category===e||o.category==="api"||o.category==="database").slice(0,5).map(o=>`- ${o.title} (${o.status||"unknown"})`).join(`
`)}catch{return""}}function Sr(t){let e=hr();if(!ft(e))return"";try{let r=mr(e).find(s=>s.includes(t));if(r)return`docs/issues/${r}`}catch{}return""}function le(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.task_description||e.description||"";c("subagent-context-stager",`Staging context for ${n}`);let s="",{count:i,summary:o}=kr();i>0&&(c("subagent-context-stager",`Found ${i} pending tasks`),s+=`ACTIVE TODOS:
${o}

`);let a=r.toLowerCase();if(/backend|api|endpoint|database|migration/.test(a)){c("subagent-context-stager","Backend task detected - staging backend decisions");let u=ge(r,"backend");u&&(s+=`RELEVANT DECISIONS:
${u}

`)}if(/frontend|react|ui|component/.test(a)){c("subagent-context-stager","Frontend task detected - staging frontend decisions");let u=ge(r,"frontend");u&&(s+=`RELEVANT DECISIONS:
${u}

`)}if(/test|testing|pytest|jest/.test(a)&&(c("subagent-context-stager","Testing task detected - staging test context"),s+=`TESTING REMINDERS:
- Use 'tee' for visible test output
- Check test patterns in backend/tests/ or frontend/src/**/__tests__/
- Ensure coverage meets threshold requirements

`),/issue|#\d+|bug|fix/.test(a)){c("subagent-context-stager","Issue-related task detected");let u=r.match(/#(\d+)/);if(u){let g=u[1],p=Sr(g);p&&(s+=`ISSUE DOCS: ${p}

`,c("subagent-context-stager",`Staged issue documentation for #${g}`))}}if(s){let u=`${s}
Task: ${r}
Subagent: ${n}`,g=s.split(`
`).filter(Boolean).length;return c("subagent-context-stager",`Staged context with ${g} lines`),{continue:!0,systemMessage:u}}return c("subagent-context-stager","No context staged for this task"),l()}import{existsSync as F,readFileSync as yt,mkdirSync as _r,appendFileSync as br,readdirSync as vr}from"node:fs";import{join as v,dirname as xr}from"node:path";var Ir=new Set(["general-purpose","Explore","Plan","claude-code-guide","statusline-setup","Bash"]);function $r(){return v(d(),".claude","logs","subagent-spawns.jsonl")}function wr(){return v(d(),"plugin.json")}function ht(){return v(d(),"agents")}function kt(){return v(d(),".claude","agents")}function Tr(){return v(d(),"skills")}function Ar(){let t=new Set(Ir),e=wr();if(F(e))try{let s=JSON.parse(yt(e,"utf8")).agents||[];for(let i of s)i.id&&t.add(i.id)}catch{}let n=[ht(),kt()];for(let r of n)if(F(r))try{let s=vr(r);for(let i of s)i.endsWith(".md")&&t.add(i.replace(".md",""))}catch{}return t}function Dr(t){let e=[],n=[v(ht(),`${t}.md`),v(kt(),`${t}.md`)],r=null;for(let s of n)if(F(s)){r=s;break}if(!r)return e;try{let i=yt(r,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of i){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^skills:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let g=u.match(/^\s*-\s*(.+)$/);if(g){let p=g[1].trim();e.push(p)}}}}}catch{}return e}function Cr(t){let e=Dr(t),n=[],r=Tr();for(let s of e){let i=v(r,s,"SKILL.md");F(i)||n.push(s)}return n}function Rr(t){let e=[],n=[v(ht(),`${t}.md`),v(kt(),`${t}.md`)],r=null;for(let s of n)if(F(s)){r=s;break}if(!r)return e;try{let i=yt(r,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of i){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^tools:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let g=u.match(/^\s*-\s*(.+)$/);g&&e.push(g[1].trim())}}}}catch{}return e}function Or(t,e){if(e.length===0)return"";let n=e.every(o=>["Read","Glob","Grep"].includes(o)),r=e.includes("Bash"),s=e.includes("Write")||e.includes("Edit"),i="low";return r&&s?i="elevated":(r||s)&&(i="moderate"),`## Agent Permission Profile (CC 2.1.20)

**Agent**: \`${t}\`
**Tools**: ${e.join(", ")}
**Risk Level**: ${i}${n?" (read-only)":""}

${r?`> This agent requests Bash access. Review commands carefully.
`:""}`}function Er(t,e,n){let r=$r(),s=xr(r);try{_r(s,{recursive:!0})}catch{}let i={timestamp:new Date().toISOString(),subagent_type:t,description:e,session_id:n};try{br(r,JSON.stringify(i)+`
`)}catch{}}function pe(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"",s=t.session_id||y();c("subagent-validator",`Task invocation: ${n} - ${r}`),Er(n,r,s);let i=n.replace(/^[^:]+:/,""),o=Ar();!o.has(n)&&!o.has(i)&&c("subagent-validator",`WARNING: Unknown subagent type: ${n}`),c("subagent-validator",`Spawning ${n} agent: ${r}`);let a=Cr(i);if(a.length>0){let g=a.join(", ");c("subagent-validator",`WARNING: Agent '${i}' references missing skills: ${g}`),console.error(`Warning: Agent '${i}' references ${a.length} missing skill(s): ${g}`)}let u=Rr(i);if(u.length>0){let g=Or(i,u);return c("subagent-validator",`Agent '${i}' tools: ${u.join(", ")}`),T(g)}return l()}import{existsSync as me,readFileSync as Pr,writeFileSync as Hr,mkdirSync as Nr}from"node:fs";function fe(){let t=y();return`${d()}/.claude/orchestration/task-registry-${t}.json`}function jr(){let t=`${d()}/.claude/orchestration`;if(!me(t))try{Nr(t,{recursive:!0})}catch{}}function P(){let t=fe();if(me(t))try{return JSON.parse(Pr(t,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:y(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function St(t){jr();let e=fe();t.updatedAt=new Date().toISOString();try{Hr(e,JSON.stringify(t,null,2))}catch(n){c("task-integration",`Failed to save registry: ${n}`)}}function ye(t,e){return`### Delete Orphaned Task

\`\`\`
TaskUpdate:
  taskId: "${t}"
  status: "deleted"
\`\`\`

**Reason**: ${e}`}function z(t){let e=`### Update Task

\`\`\`
TaskUpdate:
  taskId: "${t.taskId}"`;return t.status&&(e+=`
  status: "${t.status}"`),t.addBlockedBy&&t.addBlockedBy.length>0&&(e+=`
  addBlockedBy: ${JSON.stringify(t.addBlockedBy)}`),t.addBlocks&&t.addBlocks.length>0&&(e+=`
  addBlocks: ${JSON.stringify(t.addBlocks)}`),e+="\n```",e}function I(t,e){let n=P(),r=n.tasks.find(s=>s.taskId===t);r&&(r.status=e,St(n),c("task-integration",`Updated task ${t} status to ${e}`))}function A(t){return P().tasks.find(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function he(t){return P().tasks.filter(n=>n.status==="pending"&&n.blockedBy&&n.blockedBy.includes(t))}function _t(t){return P().tasks.filter(n=>n.pipelineId===t).sort((n,r)=>(n.pipelineStep||0)-(r.pipelineStep||0))}function ke(){return P().pipelines.find(e=>e.status==="running")}function Se(t,e){let n=P(),r=n.pipelines.find(i=>i.pipelineId===t);if(!r)return null;r.completedSteps.includes(e)||(r.completedSteps.push(e),r.completedSteps.sort((i,o)=>i-o));let s=_t(t);for(let i of s){let o=i.pipelineStep;if(o===void 0||r.completedSteps.includes(o)||i.status!=="pending")continue;if(o===0||r.completedSteps.includes(o-1))return r.currentStep=o,St(n),o}return r.status="completed",St(n),null}function _e(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return c("task-linker","No agent type found, skipping"),l();c("task-linker",`Processing SubagentStart for: ${n}`);let r=A(n);if(!r)return c("task-linker",`No orchestration task found for agent: ${n}`),l();c("task-linker",`Found task ${r.taskId} for agent ${n}`),I(r.taskId,"in_progress"),R(n,"in_progress",r.taskId);let s=z({taskId:r.taskId,status:"in_progress"}),i=`## Orchestration: Task Linked

Agent \`${n}\` has been linked to task **${r.taskId}**.

${s}

The task status should be updated to \`in_progress\`.`;return c("task-linker",`Linked agent ${n} to task ${r.taskId}`),T(i)}import{appendFileSync as Mr,mkdirSync as Fr,existsSync as bt,readFileSync as vt}from"node:fs";import{join as W,dirname as Lr}from"node:path";var Ur=[/security|vulnerab|audit|penetration/i,/architect|design.*system|distributed/i,/migration.*schema|database.*design/i,/performance.*optim|profil|bottleneck/i,/langgraph|workflow.*orchestrat/i],Br=[/\b(?:list|count|check|verify|read|search)\b/i,/\b(?:simple|straightforward|quick)\b/i,/\b(?:format|lint|style|typo|rename)\b/i,/\b(?:status|progress|summary)\b/i],O=new Map,$=new Map;function xt(t){if(O.has(t))return O.get(t);let e=q();if(!e)return O.set(t,"inherit"),"inherit";let n=W(e,"agents",`${t}.md`);if(!bt(n))return O.set(t,"inherit"),"inherit";try{let s=vt(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!s)return O.set(t,"inherit"),"inherit";let i=s[1].match(/^model:\s*(.+)$/m),o=i?i[1].trim():"inherit";return O.set(t,o),o}catch{return O.set(t,"inherit"),"inherit"}}function qr(t){if($.has(t))return $.get(t);let e=q();if(!e)return $.set(t,null),null;let n=W(e,"agents",`${t}.md`);if(!bt(n))return $.set(t,null),null;try{let s=vt(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!s)return $.set(t,null),null;let i=s[1].match(/^skills:\s*\n((?:\s+-\s+.+\n)*)/m);if(!i)return $.set(t,null),null;let o=i[1].match(/^\s+-\s+(.+)$/gm)?.map(g=>g.trim().replace(/^-\s+/,""))||[];if(o.length===0)return $.set(t,null),null;let a={low:0,medium:1,high:2},u="low";for(let g of o.slice(0,5)){let p=W(e,"skills",g,"SKILL.md");if(!bt(p))continue;let m=vt(p,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!m)continue;let S=m[1].match(/^complexity:\s*(low|medium|high)$/m);if(S){let h=S[1];a[h]>a[u]&&(u=h)}}return $.set(t,u),u}catch{return $.set(t,null),null}}function be(t,e){let n=qr(t);if(n==="high")return"high";let r=Ur.filter(o=>o.test(e)).length,s=xt(t);return r>=2||s==="opus"?"high":Br.filter(o=>o.test(e)).length>=2?"low":n||"medium"}function ve(t){let e=xt(t);return e==="inherit"?process.env.CLAUDE_MODEL||"sonnet":e}function Gr(t,e){let n=be(t,e),r=ve(t);return n==="high"&&r==="haiku"?{recommended:"sonnet",current:r,reason:"High-complexity task \u2014 haiku may produce lower quality results",savingsPercent:0}:n==="low"&&r==="opus"?{recommended:"sonnet",current:r,reason:"Simple task \u2014 sonnet handles this equally well at lower cost",savingsPercent:40}:n==="medium"&&r==="opus"&&xt(t)!=="opus"?{recommended:"sonnet",current:r,reason:"Medium-complexity task \u2014 sonnet is sufficient",savingsPercent:30}:null}function Jr(t,e,n,r){let s=W(d(),".claude","logs","model-usage.jsonl");try{Fr(Lr(s),{recursive:!0}),Mr(s,JSON.stringify({timestamp:new Date().toISOString(),agent:t,model:e,complexity:n,recommendation:r?.recommended||null,potentialSavings:r?.savingsPercent||0})+`
`)}catch{}}function xe(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"";if(!n)return l();let s=be(n,r),i=ve(n),o=Gr(n,r);return Jr(n,i,s,o),o?(c("model-cost-advisor",`${n}: Recommend ${o.recommended} over ${o.current} (${o.reason})`,"info"),o.savingsPercent>=30?C(`Model cost: ${n} using ${o.current} for ${s}-complexity task. ${o.reason}. ~${o.savingsPercent}% savings with "${o.recommended}".`):l()):(c("model-cost-advisor",`${n}: ${i} appropriate for ${s} task`),l())}import{existsSync as zr,mkdirSync as Wr,appendFileSync as Vr,unlinkSync as Kr}from"node:fs";import{basename as Xr,dirname as Qr}from"node:path";var Yr=["decided to","chose","implemented using","selected","opted for","will use","pattern:","approach:","architecture:","recommends","best practice","anti-pattern","learned that"],Zr="decisions";function ts(){return`${d()}/.claude/logs/agent-patterns.jsonl`}function es(){return`${d()}/.claude/session`}function Ie(){let t=d();return(Xr(t)||"default-project").toLowerCase().replace(/ /g,"-").replace(/[^a-z0-9-]/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-")}function ns(t){return`${Ie()}-${t}`}function rs(t){let r=(t.length>10240?t.substring(0,10240):t).toLowerCase();return/pagination|cursor|offset/.test(r)?"pagination":/security|vulnerability|exploit|injection|xss|csrf|owasp|safety|guardrail/.test(r)?"security":/database|sql|postgres|schema/.test(r)?"database":/\bapi\b|endpoint|\brest\b|graphql/.test(r)?"api":/auth|login|jwt|oauth/.test(r)?"authentication":/\btest\b|testing|pytest|jest|vitest|coverage|\bmock\b|fixture|\bspec\b/.test(r)?"testing":/deploy|\bci\b|\bcd\b|pipeline|docker|kubernetes|helm|terraform/.test(r)?"deployment":/observability|monitoring|logging|tracing|metrics|prometheus|grafana|langfuse/.test(r)?"observability":/react|component|frontend|\bui\b/.test(r)?"frontend":/performance|optimization|cache|index/.test(r)?"performance":/llm|\brag\b|embedding|vector|semantic|\bai\b|\bml\b|langchain|langgraph|openai|anthropic/.test(r)?"ai-ml":/etl|data.*pipeline|streaming|batch.*processing|dataflow|spark/.test(r)?"data-pipeline":/architecture|design|structure/.test(r)?"architecture":/decided|chose|selected/.test(r)?"decision":"pattern"}function ss(t){let e=[];if(t.length<50)return e;for(let r of Yr){let s=new RegExp(`^.*${r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}.*$`,"gim"),i=t.match(s)||[];for(let o of i){let a=o.trim().substring(0,200);a.length>20&&e.push(a)}}return[...new Set(e)].slice(0,5)}function V(t){c("agent-memory-store","Agent memory store hook starting");let e=t.tool_input||{},n=t.subagent_type||e.subagent_type||e.type||"",r=t.tool_result,s=typeof r=="string"?r:r?.content||t.agent_output||t.output||"",i=!0;if(t.error&&(i=!1),typeof r=="object"&&r?.is_error&&(i=!1),!n)return c("agent-memory-store","No agent type in input, skipping"),l();let o=`ork:${n}`,a=`${es()}/current-agent-id`;try{zr(a)&&Kr(a)}catch{}c("agent-memory-store",`Processing completion for agent: ${n} (agent_id: ${o}, success: ${i})`);let u=i&&s?ss(s):[];if(u.length===0)return c("agent-memory-store",`No patterns extracted from ${n} output`),l();let g=ts(),p=Qr(g);try{Wr(p,{recursive:!0})}catch{}let f=Ie(),m=new Date().toISOString(),S=ns(Zr);for(let k of u){let U=rs(k),Et={agent:n,agent_id:o,pattern:k,project:f,timestamp:m,scope_id:S,category:U,pending_graph_sync:!0};try{Vr(g,JSON.stringify(Et)+`
`)}catch{}c("agent-memory-store",`Extracted pattern (${U}): ${k.substring(0,50)}...`)}return c("agent-memory-store",`Extracted ${u.length} patterns from ${n} output`),{continue:!0,systemMessage:`[Pattern Extraction] ${u.length} patterns extracted from ${n}. To persist, use mcp__memory__create_entities with entities: [{"name": "${n}-pattern", "entityType": "Pattern", "observations": ["<pattern>"]}]`}}import{existsSync as is,writeFileSync as $e,mkdirSync as It,appendFileSync as os,readFileSync as as}from"node:fs";import{dirname as cs}from"node:path";var us=[".env","credentials","secret","auth","password","token","api.key","private.key",".pem","oauth","jwt","session","cookie","encryption","crypto"];function gs(){let t=`${d()}/.claude/hooks/logs`;try{It(t,{recursive:!0})}catch{}return`${t}/auto-spawn-quality.log`}function ds(){return`${d()}/.claude/context/spawn-queue.json`}function b(t){let e=gs(),n=new Date().toISOString();try{os(e,`[${n}] [auto-spawn-quality] ${t}
`)}catch{}}function ls(t){let e=t.toLowerCase();for(let n of us)if(e.includes(n))return b(`Detected sensitive pattern: ${n}`),!0;return!1}function ps(t,e,n,r,s,i){let o=`SPAWN-${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,14)}-${Math.floor(Math.random()*1e4).toString().padStart(4,"0")}`,a=ds(),u=cs(a);try{It(u,{recursive:!0})}catch{}let g;if(is(a))try{g=JSON.parse(as(a,"utf8"))}catch{g={schema_version:"1.0.0",created_at:i,queue:[]}}else g={schema_version:"1.0.0",created_at:i,queue:[]};let p={spawn_id:o,target_agent:e,trigger_agent:t,trigger_reason:n,priority:r,timestamp:i,session_id:s,status:"queued"};g.queue.push(p);try{$e(a,JSON.stringify(g,null,2)),b(`Queued spawn request: ${o} for ${e} (reason: ${n})`)}catch{return b(`ERROR: Failed to queue spawn request for ${e}`),""}return o}function ms(t,e,n,r,s,i){let o=`${d()}/.claude/context/handoffs`;try{It(o,{recursive:!0})}catch{}let a=`${o}/auto_spawn_${e}_${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,15)}.json`,u={type:"auto_spawn_suggestion",from_agent:t,to_agent:e,timestamp:i,trigger_reason:n,priority:r,session_id:s,auto_triggered:!0,status:"suggested"};try{$e(a,JSON.stringify(u,null,2)),b(`Created spawn suggestion: ${e} (reason: ${n})`)}catch{}}function fs(t,e,n){if(n&&n!=="null")return b(`Skipping auto-spawn - agent ${t} had errors: ${n}`),null;if(t==="test-generator")return b("Rule matched: test-generator -> code-quality-reviewer"),{target:"code-quality-reviewer",reason:"test-generator completed - validating test quality and coverage",priority:"high"};if(ls(e)&&t!=="security-auditor"&&t!=="security-layer-auditor")return b("Rule matched: sensitive files detected -> security-auditor"),{target:"security-auditor",reason:"sensitive file changes detected - security audit required",priority:"critical"};if(t==="code-quality-reviewer")return b("Rule matched: code-quality-reviewer -> security-auditor"),{target:"security-auditor",reason:"code-quality-reviewer completed - proceeding with security scan",priority:"high"};if(t==="backend-system-architect"){let r=e.toLowerCase();if(/authentication|authorization|security|access.control|rbac|acl/.test(r))return b("Rule matched: backend-system-architect with auth -> security-layer-auditor"),{target:"security-layer-auditor",reason:"backend-system-architect designed auth/security layer - validation required",priority:"high"}}return null}function we(t){let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",s=t.session_id||y(),i=t.agent_output||t.output||"",o=t.error||"";if(b(`Checking auto-spawn conditions for agent: ${r} (session: ${s})`),r==="unknown"||!r)return b("Skipping unknown agent type"),l();let a=fs(r,i,o);if(a){let u=ps(r,a.target,a.reason,a.priority,s,e);return ms(r,a.target,a.reason,a.priority,s,e),b(`=== AUTO-SPAWN QUALITY HOOK ===
Trigger Agent: ${r}
Target Agent: ${a.target}
Reason: ${a.reason}
Priority: ${a.priority}
Spawn ID: ${u}
Timestamp: ${e}
Session: ${s}`),{continue:!0,systemMessage:`Auto-spawn queued: ${a.target} (${a.priority} priority)`}}return b(`No auto-spawn conditions matched for ${r}`),l()}import{existsSync as ys,writeFileSync as Re,mkdirSync as hs,readFileSync as ks}from"node:fs";import{dirname as $t}from"node:path";function Te(){return`${d()}/.claude/context/knowledge/decisions/active.json`}function Ss(){return`${d()}/.claude/context/session/state.json`}function _s(){return`${d()}/.claude/logs/agent-context`}function K(t){try{hs(t,{recursive:!0})}catch{}}function Ae(t,e){if(!ys(t))return e;try{return JSON.parse(ks(t,"utf8"))}catch{return e}}function De(t,e){let n=$t(t);K(n);try{Re(t,JSON.stringify(e,null,2))}catch{}}var Ce=50;function X(t){let e=t.subagent_type||t.agent_type||"unknown",n=new Date().toISOString(),r=t.agent_output||t.output||"",s=r.substring(0,200);r.length>200&&(s+="...");let i=e!=="unknown"||s.trim().length>0,o=e.replace(/-/g,"_");if(i){let k=Te(),U=$t(k);K(U);let H=Ae(k,{schema_version:"2.0.0",decisions:{}});(!H.decisions||typeof H.decisions!="object")&&(H.decisions={});let sn={timestamp:n,agent:e,summary:s,status:"completed"};H.decisions[o]=sn,De(k,H)}let a=Ss(),u=$t(a);K(u);let p=Ae(a,{schema_version:"2.0.0",session_id:"",started_at:n,last_activity:n,active_agent:null,tasks_pending:[],tasks_completed:[]});if(Array.isArray(p.tasks_completed)||(p.tasks_completed=[]),Array.isArray(p.tasks_pending)||(p.tasks_pending=[]),i){let k={agent:e,timestamp:n,summary:s};p.tasks_completed.push(k),p.tasks_completed.length>Ce&&(p.tasks_completed=p.tasks_completed.slice(-Ce))}p.last_activity=n,p.active_agent=null,De(a,p);let f=_s();K(f);let m=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),S=`${f}/${e}_${m}.log`,h=`=== CONTEXT PUBLICATION (Protocol 2.0) ===
Agent: ${e}
Timestamp: ${n}
Decisions file: ${Te()}
Session state: ${a}

=== AGENT OUTPUT ===
${r}
`;try{Re(S,h)}catch{}return l()}import{existsSync as bs,writeFileSync as Ee,mkdirSync as Tt,readFileSync as vs,appendFileSync as xs}from"node:fs";import{dirname as Is}from"node:path";function wt(){return!!(process.env.CLAUDE_CODE_TEAM_NAME||process.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS==="1")}var Oe=[{type:"product-thinking",name:"Product Thinking Pipeline",description:"Full product discovery and specification workflow",triggers:["should we build","product decision","feature validation","market research","user research"],steps:[{agent:"market-intelligence",description:"Analyze competitive landscape and market trends",dependsOn:[],skills:["market-research"],estimatedTokens:3e3},{agent:"ux-researcher",description:"Create personas and map user journeys",dependsOn:[0],skills:["user-research"],estimatedTokens:2500},{agent:"product-strategist",description:"Validate value proposition and alignment",dependsOn:[0,1],skills:["product-strategy"],estimatedTokens:2e3},{agent:"prioritization-analyst",description:"Score and prioritize using frameworks",dependsOn:[2],skills:["prioritization"],estimatedTokens:1500},{agent:"business-case-builder",description:"Build ROI and cost-benefit analysis",dependsOn:[2,3],skills:["business-case"],estimatedTokens:2e3},{agent:"requirements-translator",description:"Transform to PRD and user stories",dependsOn:[4],skills:["requirements"],estimatedTokens:2500}],estimatedTotalTokens:13500},{type:"full-stack-feature",name:"Full-Stack Feature Pipeline",description:"End-to-end feature implementation workflow",triggers:["full-stack feature","build a feature","implement end-to-end","create full feature","add complete feature"],steps:[{agent:"backend-system-architect",description:"Design API and database schema",dependsOn:[],skills:["api-design","database-patterns"],estimatedTokens:3e3},{agent:"frontend-ui-developer",description:"Build React components and UI",dependsOn:[0],skills:["react-server-components-framework","form-state-patterns"],estimatedTokens:3500},{agent:"test-generator",description:"Create unit and integration tests",dependsOn:[0,1],skills:["testing-patterns"],estimatedTokens:2e3},{agent:"security-auditor",description:"Audit for vulnerabilities",dependsOn:[0,1],skills:["security-patterns"],estimatedTokens:1500}],estimatedTotalTokens:1e4},{type:"ai-integration",name:"AI Integration Pipeline",description:"Add AI/LLM capabilities to application",triggers:["add rag","add llm","ai integration","implement rag","add ai feature","langgraph workflow"],steps:[{agent:"workflow-architect",description:"Design LangGraph workflow and state",dependsOn:[],skills:["langgraph"],estimatedTokens:2500},{agent:"llm-integrator",description:"Connect LLM APIs with function calling",dependsOn:[0],skills:["llm-integration"],estimatedTokens:2e3},{agent:"data-pipeline-engineer",description:"Build embeddings and data pipeline",dependsOn:[0],skills:["embeddings","rag-retrieval"],estimatedTokens:2500},{agent:"test-generator",description:"Create LLM testing infrastructure",dependsOn:[1,2],skills:["testing-patterns"],estimatedTokens:1500}],estimatedTotalTokens:8500},{type:"security-audit",name:"Security Audit Pipeline",description:"Comprehensive security review workflow",triggers:["security audit","security review","vulnerability scan","security assessment"],steps:[{agent:"security-auditor",description:"Scan for OWASP Top 10 vulnerabilities",dependsOn:[],skills:["security-patterns"],estimatedTokens:2e3},{agent:"security-layer-auditor",description:"Verify defense-in-depth layers",dependsOn:[0],skills:["security-patterns"],estimatedTokens:2e3},{agent:"ai-safety-auditor",description:"Audit AI/LLM security if applicable",dependsOn:[0],skills:["mcp-security-hardening"],estimatedTokens:1500}],estimatedTotalTokens:5500},{type:"frontend-compliance",name:"Frontend 2026 Compliance Pipeline",description:"Modernize frontend to 2026 patterns",triggers:["frontend compliance","modernize frontend","update react","frontend 2026"],steps:[{agent:"frontend-ui-developer",description:"Upgrade to React 19 patterns",dependsOn:[],skills:["react-server-components-framework","zustand-patterns"],estimatedTokens:3e3},{agent:"frontend-performance-engineer",description:"Optimize Core Web Vitals",dependsOn:[0],skills:["performance"],estimatedTokens:2e3},{agent:"accessibility-specialist",description:"Ensure WCAG 2.2 compliance",dependsOn:[0],skills:["testing-patterns","accessibility"],estimatedTokens:1500}],estimatedTotalTokens:6500}];function $s(){return`${d()}/.claude/coordination/decision-log.json`}function ws(){let t=`${d()}/.claude/hooks/logs`;try{Tt(t,{recursive:!0})}catch{}return`${t}/agent-feedback.log`}function w(t){let e=ws(),n=new Date().toISOString();try{xs(e,`[${n}] [feedback-loop] ${t}
`)}catch{}}function Ts(t){let e=ke();if(e){let r=Oe.find(s=>s.type===e.type);if(r){let s=r.steps.findIndex(i=>i.agent===t);if(s>=0){let i=r.steps.filter((o,a)=>o.dependsOn.includes(s)&&a>s).map(o=>o.agent);if(i.length>0)return i.join(" ")}}}return{"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"test-generator","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer"}[t]||""}function As(t){return{"market-intelligence":"product-thinking","product-strategist":"product-thinking","prioritization-analyst":"product-thinking","business-case-builder":"product-thinking","requirements-translator":"specification","metrics-architect":"specification","backend-system-architect":"architecture","database-engineer":"architecture","data-pipeline-engineer":"architecture","frontend-ui-developer":"frontend","rapid-ui-designer":"frontend","ux-researcher":"frontend","test-generator":"quality","code-quality-reviewer":"quality","security-auditor":"security","security-layer-auditor":"security","workflow-architect":"ai-integration","llm-integrator":"ai-integration","debug-investigator":"debugging"}[t]||"general"}function Ds(){return process.env.CLAUDE_INSTANCE_ID||`${tt("os").hostname()}-${process.pid}`}function Cs(t){let e=t.substring(0,500);return t.length>500&&(e+="..."),e}function Rs(t,e,n,r,s,i,o,a){let u=$s(),g=Is(u);try{Tt(g,{recursive:!0})}catch{}let p;if(bs(u))try{p=JSON.parse(vs(u,"utf8"))}catch{p={schema_version:"2.0.0",log_created_at:o,decisions:[]}}else p={schema_version:"2.0.0",log_created_at:o,decisions:[]};let f={decision_id:t,timestamp:o,made_by:{instance_id:Ds(),agent_type:e},category:n,title:`Agent ${e} completed`,description:r,impact:{scope:"agent-pipeline",downstream_agents:s.split(" ").filter(Boolean)},status:i,task_id:a};p.decisions.push(f);try{Ee(u,JSON.stringify(p,null,2)),w(`Decision ${t} logged for agent ${e}`)}catch{w("ERROR: Failed to write decision to log")}}function Os(t,e,n,r,s,i,o){if(!e)return;let a=`${d()}/.claude/context/handoffs`;try{Tt(a,{recursive:!0})}catch{}let u=e.split(" ").filter(Boolean),g=new Date().toISOString().replace(/[-:]/g,"").substring(0,15);for(let p of u){let f=`${a}/${t}_to_${p}_${g}.json`,m={from_agent:t,to_agent:p,timestamp:i,decision_id:r,summary:n,session_id:s,status:"pending",feedback_loop:!0,task_id:o};try{Ee(f,JSON.stringify(m,null,2)),w(`Created handoff context: ${t} -> ${p}`)}catch{}}}function Q(t){if(wt())return l();let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",s=t.session_id||y(),i=t.agent_output||t.output||"",o=t.error||"";if(w(`Processing feedback for agent: ${r} (session: ${s})`),r==="unknown"||!r)return w("Skipping unknown agent type"),l();let a=new Date().toISOString().replace(/[-:T.]/g,"").substring(0,8),u=Math.floor(Math.random()*1e4).toString().padStart(4,"0"),g=`DEC-${a}-${u}`,f=A(r)?.taskId,m=Ts(r),S=As(r),h,k;return o&&o!=="null"?(h=`Agent failed: ${o}`,k="failed"):(h=Cs(i),k="completed"),f&&(I(f,k==="completed"?"completed":"failed"),w(`Updated task ${f} status to ${k}`)),Rs(g,r,S,h,m,k,e,f),m?(Os(r,m,h,g,s,e,f),w(`Routed findings to downstream agents: ${m}`)):w(`No downstream agents for ${r} (terminal agent)`),w(`=== AGENT FEEDBACK LOOP ===
Agent: ${r}
Category: ${S}
Decision ID: ${g}
Task ID: ${f||"none"}
Timestamp: ${e}
Status: ${k}
Downstream: ${m||"none"}

Summary: ${h}`),m?{continue:!0,systemMessage:`Feedback loop: routed to ${m}${f?` (task: ${f})`:""}`}:l()}import{writeFileSync as Pe,mkdirSync as He}from"node:fs";var Es=new Set(["market-intelligence","product-strategist","prioritization-analyst","business-case-builder","requirements-translator","metrics-architect","backend-system-architect","code-quality-reviewer","data-pipeline-engineer","database-engineer","debug-investigator","frontend-ui-developer","llm-integrator","rapid-ui-designer","security-auditor","security-layer-auditor","system-design-reviewer","test-generator","ux-researcher","workflow-architect"]),Ps={"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"code-quality-reviewer","code-quality-reviewer":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"code-quality-reviewer","database-engineer":"backend-system-architect","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer","security-auditor":"none","security-layer-auditor":"none","debug-investigator":"none","system-design-reviewer":"none"},Hs={"market-intelligence":"Next: product-strategist should define product vision based on market analysis","product-strategist":"Next: prioritization-analyst should rank features from strategy","prioritization-analyst":"Next: business-case-builder should create ROI justification","business-case-builder":"Next: requirements-translator should convert to technical specs","requirements-translator":"Next: metrics-architect should define success criteria","metrics-architect":"Next: backend-system-architect should design API endpoints","backend-system-architect":"Next: frontend-ui-developer should build UI components","frontend-ui-developer":"Next: test-generator should create test coverage","test-generator":"Next: code-quality-reviewer should validate implementation","code-quality-reviewer":"Next: security-auditor should perform security scan","workflow-architect":"Next: llm-integrator should configure LLM providers","llm-integrator":"Next: data-pipeline-engineer should set up embeddings","data-pipeline-engineer":"Next: code-quality-reviewer should validate data pipeline","database-engineer":"Next: backend-system-architect should integrate schema","rapid-ui-designer":"Next: frontend-ui-developer should implement designs","ux-researcher":"Next: rapid-ui-designer should create mockups"};function Ns(t){return Ps[t]||"none"}function js(t){return Hs[t]||"Pipeline complete"}function Ms(t,e,n,r,s){let i=`${d()}/.claude/context/handoffs`;try{He(i,{recursive:!0})}catch{}let o=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),a=`${i}/${t}_to_${e}_${o}.json`,u={from_agent:t,to_agent:e,timestamp:n,summary:r,suggestions:s,status:"ready_for_handoff"};try{Pe(a,JSON.stringify(u,null,2))}catch{}return a}function Fs(t,e,n,r,s,i){let o=`${d()}/.claude/logs/agent-handoffs`;try{He(o,{recursive:!0})}catch{}let a=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),u=`${o}/${t}_${a}.log`,g=`=== HANDOFF PREPARATION ===
From: ${t}
To: ${e}
Timestamp: ${n}
Handoff file: ${i}

Summary: ${r}

Next Steps: ${s}
`;try{Pe(u,g)}catch{}}function Y(t){let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown";if(!Es.has(r))return l();let s=Ns(r),i=t.agent_output||t.output||"",o=i.length,a;o>0?(a=i.substring(0,300),o>300&&(a+="...")):a=`Agent ${r} completed`;let u=js(r),g=Ms(r,s,e,a,u);return Fs(r,s,e,a,u,g),l()}import{writeFileSync as Ls,mkdirSync as Ne,appendFileSync as Us}from"node:fs";var Bs=["\\.env","auth","secret","credential","password","token","api[_-]?key","jwt","session","oauth","permission","\\.pem$","\\.key$","config.*prod"];function qs(){let t=`${d()}/.claude/logs/multi-claude`;try{Ne(t,{recursive:!0})}catch{}return t}function D(t,e,n){let r=qs(),s=new Date().toISOString().substring(0,10).replace(/-/g,""),i=`${r}/verifier_${s}.log`,o=new Date().toISOString();try{Us(i,`[${o}] [${t}] ${e}: ${n}
`)}catch{}}function Gs(t){for(let e of Bs)if(new RegExp(e,"i").test(t))return!0;return!1}function je(t){let e=new Date().toISOString(),n=d(),s=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",i=t.agent_output||t.output||"",o=[];if(s==="test-generator"&&(o.push({agent:"code-quality-reviewer",reason:"Test generation complete - quality review recommended"}),D(s,"TRIGGER","test-generator completion triggers code-quality-reviewer")),s==="frontend-ui-developer"&&/form|input|validation|submit|auth|login/i.test(i)&&(o.push({agent:"security-auditor",reason:"Frontend auth/form components - security review recommended"}),D(s,"TRIGGER","frontend auth components trigger security-auditor")),s==="backend-system-architect"&&/endpoint|route|api|auth|jwt|session/i.test(i)&&(o.push({agent:"security-auditor",reason:"Backend API endpoints - security review recommended"}),D(s,"TRIGGER","backend API endpoints trigger security-auditor")),Gs(i)&&(o.some(u=>u.agent==="security-auditor")||(o.push({agent:"security-auditor",reason:"Sensitive files modified - security review required"}),D(s,"TRIGGER","sensitive file patterns detected"))),s==="database-engineer"&&(o.push({agent:"code-quality-reviewer",reason:"Database schema changes - review for consistency"}),D(s,"TRIGGER","database changes trigger code-quality-reviewer")),s==="workflow-architect"&&(o.push({agent:"security-layer-auditor",reason:"LangGraph workflow created - layer audit recommended"}),D(s,"TRIGGER","workflow-architect triggers security-layer-auditor")),o.length>0){let a=`${n}/.claude/context/verification-queue`;try{Ne(a,{recursive:!0})}catch{}let u=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),g=`${a}/pending_${u}_${s}.json`,p={triggered_by:s,timestamp:e,verifications:o.map(m=>({agent:m.agent,reason:m.reason,status:"pending"}))};try{Ls(g,JSON.stringify(p,null,2))}catch{}let f="Multi-Claude Verification Triggered: "+o.map(m=>`${m.agent} (${m.reason})`).join("; ");return D(s,"QUEUE",`Created verification queue: ${g}`),{continue:!0,systemMessage:f}}return D(s,"SKIP","No verification triggers matched"),l()}import{writeFileSync as Js,mkdirSync as zs}from"node:fs";function Ws(){let t=`${d()}/.claude/logs/agent-validation`;try{zs(t,{recursive:!0})}catch{}return t}function Me(t){let e=t.subagent_type||t.agent_type||"unknown",n=new Date().toISOString(),r=t.agent_output||t.output||"",s=[],i=[];r||s.push("Agent produced empty output");let o=r.length;if(o<50&&i.push(`Output seems very short (${o} chars)`),/error|failed|exception/i.test(r)&&i.push("Output contains error-related keywords"),e==="backend-system-architect"&&r.includes("{")){let S=r.match(/\{[^}]*\}/);if(S)try{JSON.parse(S[0])}catch{i.push("JSON structure may be malformed")}}let a=s.length>0?"failed":"passed",u=`Output Validation [${a}] - Agent: ${e}, Timestamp: ${n}, Output length: ${o} chars`;s.length>0&&(u+=" | Errors: "+s.join("; ")),i.length>0&&(u+=" | Warnings: "+i.join("; "));let g=Ws(),p=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),f=`${g}/${e}_${p}.log`,m=`=== OUTPUT VALIDATION ===
${u}

=== AGENT OUTPUT ===
${r}
`;try{Js(f,m)}catch{}return a==="failed"?{continue:!1,systemMessage:u,hookSpecificOutput:{hookEventName:"SubagentStop"}}:{continue:!0,suppressOutput:!0,systemMessage:u}}import{existsSync as Vs,writeFileSync as Ks,readFileSync as Xs}from"node:fs";var At="/tmp/claude-session-metrics.json";function Qs(){if(Vs(At))try{let t=JSON.parse(Xs(At,"utf8"));t.errors=(t.errors||0)+1,Ks(At,JSON.stringify(t,null,2))}catch{}}function Fe(t){let e=t.agent_id||"",n=t.subagent_type||"",r=t.error||"";return c("subagent-quality-gate",`Quality gate check: ${n} (${e})`),r&&r!=="null"?(c("subagent-quality-gate",`ERROR: Subagent failed - ${r}`),Qs(),C(`Subagent ${n} failed: ${r}`)):l()}function Ys(t){let e=t.error||t.tool_error,n=t.exit_code;if(e&&e!=="null"&&e!==""||n!==void 0&&n!==0)return!1;let r=t.agent_output||t.output||"",s=[/\bfailed\b/i,/\berror:\s/i,/\bexception\b/i,/\bcould not\b/i,/\bunable to\b/i],i=r.slice(0,500);for(let o of s)o.test(i)&&c("task-completer",`Warning: possible error in output: ${o}`);return!0}function Le(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return c("task-completer","No agent type found, skipping"),l();c("task-completer",`Processing SubagentStop for: ${n}`);let r=A(n);if(!r)return c("task-completer",`No orchestration task found for agent: ${n}`),ct(n),l();let s=Ys(t),i=s?"completed":"failed";c("task-completer",`Agent ${n} completed with status: ${i}`),I(r.taskId,i),R(n,i);let o=`## Orchestration: Task ${s?"Completed":"Failed"}

Agent \`${n}\` has finished with status: **${i}**

${z({taskId:r.taskId,status:s?"completed":"pending"})}
`;if(s&&r.pipelineId&&r.pipelineStep!==void 0){let a=Se(r.pipelineId,r.pipelineStep);if(a!==null){let u=_t(r.pipelineId).filter(g=>g.pipelineStep===a&&g.status==="pending");u.length>0&&(o+=`
### Pipeline Progress

Pipeline \`${r.pipelineId}\` step ${r.pipelineStep} complete.
Next step (${a}) is now unblocked.

**Next agent(s) to spawn:**
${u.map(g=>`- \`${g.agent}\` (task: ${g.taskId})`).join(`
`)}

Consider spawning the next agent to continue the pipeline.`)}else o+=`
### Pipeline Complete

Pipeline \`${r.pipelineId}\` has completed all steps.`}if(!s){let a=t.error||t.tool_error||"Unknown error";o+=`
### Error Details

The agent encountered an issue:
\`\`\`
${a.slice(0,500)}
\`\`\`

Consider:
1. Retrying with more specific instructions
2. Using an alternative agent
3. Breaking down the task further`;let u=he(r.taskId);if(u.length>0){o+=`

### Orphaned Tasks (CC 2.1.20)

The following tasks were blocked by the failed task and should be deleted:
`;for(let g of u)o+=`
${ye(g.taskId,`Blocked by failed task ${r.taskId} (agent: ${n})`)}`,I(g.taskId,"failed")}}return i==="completed"&&ct(n),c("task-completer",`Completed task ${r.taskId} with status ${i}`),T(o)}var Dt=new Map;function Zs(t,e){let n=Dt.get(t)||[];n.push(e),n.length>10&&n.shift(),Dt.set(t,n)}function ti(){let t=[];for(let[e,n]of Dt)n.some(r=>r.outcome==="failure")&&t.push(e);return t}function ei(t){let e=t.error||t.tool_error,n=t.exit_code,r=t.agent_output||t.output||"";if(e&&e!=="null"&&e!=="")return{outcome:"failure",error:e};if(n!==void 0&&n!==0)return{outcome:"failure",error:`Exit code: ${n}`};let s=[/i cannot|i can't|i am unable/i,/outside my scope/i,/not appropriate/i,/i refuse/i];for(let o of s)if(o.test(r.slice(0,500)))return{outcome:"rejected",error:"Agent rejected the task"};let i=[/partial(?:ly)?/i,/incomplete/i,/some.*failed/i,/couldn't finish/i];for(let o of i)if(o.test(r.slice(0,500)))return{outcome:"partial"};return{outcome:"success"}}function Ue(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return l();let{outcome:r,error:s}=ei(t);if(r==="success")return l();c("retry-handler",`Agent ${n} completed with outcome: ${r}`);let i=ut(),a=x().activeAgents.find(h=>h.agent===n),u=a?.retryCount||0,g=Xt(n,u+1,a?.taskId),p=Qt(g,r,s||void 0);Zs(n,p);let f=ti(),m=Kt(n,u+1,s||"Unknown failure",f,i.maxRetries);if(c("retry-handler",`Retry decision for ${n}: shouldRetry=${m.shouldRetry}, alternative=${m.alternativeAgent||"none"}`),m.shouldRetry)R(n,"retrying");else{R(n,"failed");let h=A(n);h&&I(h.taskId,"failed")}let S=Yt(m,n);return T(S)}import{existsSync as We,appendFileSync as li,mkdirSync as pi,readFileSync as mi,writeFileSync as fi}from"node:fs";import{existsSync as ni,readFileSync as ri,writeFileSync as Sc,mkdirSync as _c}from"node:fs";import{execSync as Be}from"node:child_process";import{createHash as si}from"node:crypto";import*as qe from"node:os";var ii=".claude/.user_identity.json",oi="orchestkit-user-identity-v1";var _=null;function Z(t){return si("sha256").update(t+oi).digest("hex").slice(0,32)}function ai(){try{return qe.hostname()}catch{return"unknown-machine"}}function ci(t){let e=`${t}/${ii}`;if(!ni(e))return null;try{let n=ri(e,"utf8");return JSON.parse(n)}catch(n){return c("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function ui(t){let e={};try{e.email=Be("git config user.email",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{e.name=Be("git config user.name",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return e}function gi(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function di(t){if(_)return _;let e=t||d(),n=ai(),r=ci(e);if(r?.user_id)return _={user_id:r.user_id,display_name:r.display_name||r.user_id,team_id:r.team_id,machine_id:n,source:"config",anonymous_id:Z(r.user_id),email:r.user_id.includes("@")?r.user_id:void 0},c("user-identity",`Resolved from config: ${_.anonymous_id}`,"debug"),_;let s=ui(e);if(s.email)return _={user_id:s.email,display_name:s.name||s.email.split("@")[0],team_id:r?.team_id,machine_id:n,source:"git",anonymous_id:Z(s.email),email:s.email},c("user-identity",`Resolved from git: ${_.anonymous_id}`,"debug"),_;let i=gi();if(i.username){let a=`${i.username}@${n}`;return _={user_id:a,display_name:i.username,team_id:r?.team_id,machine_id:n,source:"env",anonymous_id:Z(a)},c("user-identity",`Resolved from env: ${_.anonymous_id}`,"debug"),_}let o=Z(n+process.pid);return _={user_id:`anon-${o.slice(0,8)}`,display_name:"Anonymous",team_id:r?.team_id,machine_id:n,source:"anonymous",anonymous_id:o},c("user-identity",`Resolved as anonymous: ${_.anonymous_id}`,"debug"),_}function Ge(){let t=di();return{session_id:y(),user_id:t.user_id,anonymous_id:t.anonymous_id,team_id:t.team_id,machine_id:t.machine_id,identity_source:t.source,timestamp:new Date().toISOString()}}var yi=/^[a-zA-Z0-9_-]{1,128}$/;function hi(t){return yi.test(t)}function Ot(t,e){let n=t||y(),r=e||d();if(!hi(n))throw new Error("Invalid session ID format");return`${r}/.claude/memory/sessions/${n}`}function ki(t,e){return`${Ot(t,e)}/events.jsonl`}function Ve(t,e){let n=Ot(t,e);We(n)||pi(n,{recursive:!0})}var L=0,Je=!1,Ct=!1,ze=0,Si=5e3;function Ke(t,e){return`${Ot(t,e)}/counter.json`}function _i(t,e){if(!Je){Je=!0;try{let n=Ke(t,e);if(We(n)){let r=JSON.parse(mi(n,"utf8"));typeof r.counter=="number"&&r.counter>0&&(L=r.counter,c("session-tracker",`Loaded event counter: ${L}`,"debug"))}}catch{}}}function bi(t,e){if(!Ct)return;let n=Date.now();if(!(n-ze<Si))try{Ve(t,e);let r=Ke(t,e);fi(r,JSON.stringify({counter:L,updated_at:new Date().toISOString()})),Ct=!1,ze=n}catch{}}function vi(){return _i(),L++,Ct=!0,bi(),`evt-${Date.now()}-${L}`}function Xe(t,e,n={}){try{let r={event_id:vi(),event_type:t,identity:Ge(),payload:{name:e,input:Rt(n.input),output:Rt(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?Qe(n.context,500):void 0,confidence:n.confidence}};Ve();let s=ki();li(s,JSON.stringify(r)+`
`),c("session-tracker",`Tracked ${t}: ${e}`,"debug")}catch(r){c("session-tracker",`Failed to track event: ${r}`,"warn")}}function Qe(t,e){return t.length<=e?t:t.slice(0,e-3)+"..."}function Rt(t){if(!t)return;let e={},n=["password","secret","token","key","credential","auth"];for(let[r,s]of Object.entries(t)){if(n.some(i=>r.toLowerCase().includes(i))){e[r]="[REDACTED]";continue}if(typeof s=="string"&&s.length>500){e[r]=Qe(s,500);continue}if(typeof s=="object"&&s!==null&&!Array.isArray(s)){e[r]=Rt(s);continue}e[r]=s}return e}import{appendFileSync as xi,mkdirSync as Ii,statSync as $i,renameSync as wi}from"node:fs";import{createHash as Ti}from"node:crypto";function Ai(){return rt(et(),".claude","analytics")}function Ye(t){return Ti("sha256").update(t).digest("hex").slice(0,12)}function Ze(){let t=process.env.CLAUDE_CODE_TEAM_NAME;return t?{team:t}:void 0}function Di(t,e=10485760){try{if($i(t).size>e){let r=new Date().toISOString().slice(0,7),s=t.replace(/\.jsonl$/,`.${r}.jsonl`);wi(t,s)}}catch{}}function tn(t,e){try{let n=Ai();Ii(n,{recursive:!0});let r=rt(n,t);Di(r),xi(r,JSON.stringify(e)+`
`)}catch{}}var en=[{name:"context-publisher",fn:X},{name:"handoff-preparer",fn:Y},{name:"feedback-loop",fn:Q},{name:"agent-memory-store",fn:V}];function Ci(t){try{let e=t.subagent_type||t.agent_type||"unknown",n=!t.error,r=t.duration_ms,s=t.agent_output||t.output||"",i=typeof s=="string"?s.length:0;Xe("agent_spawned",e,{success:n,duration_ms:r,output:{has_output:i>0,output_length:i,has_error:!!t.error},context:t.agent_id}),tn("agent-usage.jsonl",{ts:new Date().toISOString(),pid:Ye(process.env.CLAUDE_PROJECT_DIR||""),agent:e,duration_ms:r,success:n,output_len:i,...Ze()})}catch{}}async function nn(t){Ci(t);let n=(await Promise.allSettled(en.map(async r=>{try{let s=r.fn(t);return s instanceof Promise&&await s,{hook:r.name,status:"success"}}catch(s){let i=s instanceof Error?s.message:String(s);return c("subagent-stop-dispatcher",`${r.name} failed: ${i}`),{hook:r.name,status:"error",message:i}}}))).filter(r=>r.status==="rejected"||r.status==="fulfilled"&&r.value.status==="error");return n.length>0&&c("subagent-stop-dispatcher",`${n.length}/${en.length} hooks had errors`),l()}var rn={"subagent-start/graph-memory-inject":oe,"subagent-start/context-gate":ue,"subagent-start/subagent-context-stager":le,"subagent-start/subagent-validator":pe,"subagent-start/task-linker":_e,"subagent-start/model-cost-advisor":xe,"subagent-stop/agent-memory-store":V,"subagent-stop/auto-spawn-quality":we,"subagent-stop/context-publisher":X,"subagent-stop/feedback-loop":Q,"subagent-stop/handoff-preparer":Y,"subagent-stop/multi-claude-verifier":je,"subagent-stop/output-validator":Me,"subagent-stop/subagent-quality-gate":Fe,"subagent-stop/task-completer":Le,"subagent-stop/retry-handler":Ue,"subagent-stop/unified-dispatcher":nn};function su(t){return rn[t]}function iu(){return Object.keys(rn)}export{fo as DEFAULT_CONFIG,mo as THRESHOLDS,$o as addToPromptHistory,Po as analyzeAttemptHistory,Uo as applyDecay,To as cacheClassification,qn as calculateBackoffDelay,Ro as cleanupOldStates,Co as clearSessionState,Qt as completeAttempt,Xt as createAttempt,lo as escapeRegex,Pn as estimateTokenCount,Yt as formatRetryDecision,_o as getActiveAgent,Bo as getAdjustments,qo as getAgentSuccessRate,gt as getAlternativeAgent,Qi as getCachedBranch,Go as getCalibrationStats,Xi as getEnvFile,uo as getField,su as getHook,Io as getInjectedSkills,Ao as getLastClassification,Ut as getLogDir,Dn as getLogLevel,q as getPluginRoot,d as getProjectDir,wo as getPromptHistory,y as getSessionId,Jo as hasMinimalCalibrationData,Zn as hashPrompt,rn as hooks,bo as isAgentDispatched,Oi as isBashInput,Pi as isEditInput,Hi as isReadInput,Gn as isRetryableError,xo as isSkillInjected,Ei as isWriteInput,iu as listHooks,j as loadCalibrationData,ut as loadConfig,x as loadState,c as logHook,oo as logPermissionFeedback,Kt as makeRetryDecision,go as normalizeCommand,Yi as normalizeLineEndings,no as outputAllowWithContext,to as outputBlock,it as outputDeny,ro as outputError,Rn as outputPromptContext,ao as outputPromptContextBudgeted,Zi as outputSilentAllow,l as outputSilentSuccess,so as outputStderrWarning,C as outputWarning,T as outputWithContext,eo as outputWithNotification,io as outputWithUpdatedInput,Ho as prepareForRetry,co as readHookInput,Lo as recordOutcome,ct as removeAgent,Yn as saveCalibrationData,Do as saveConfig,Nn as saveState,Cn as shouldLog,Jn as suggestsAlternative,So as trackDispatchedAgent,vo as trackInjectedSkill,R as updateAgentStatus,E as updateState};
//# sourceMappingURL=subagent.mjs.map
