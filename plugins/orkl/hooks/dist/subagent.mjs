// OrchestKit Hooks - subagent bundle
// Generated: 2026-02-06T08:09:05.525Z

var Y=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,n)=>(typeof require<"u"?require:e)[n]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});function Cs(t){return typeof t.command=="string"}function Rs(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function Os(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function Es(t){return typeof t.file_path=="string"&&t.content===void 0}import{appendFileSync as Et,existsSync as Pt,statSync as Sn,renameSync as bn,mkdirSync as _n,readSync as $n}from"node:fs";import{execSync as vn}from"node:child_process";import Ze from"node:os";import F from"node:path";function tn(){return process.env.HOME||process.env.USERPROFILE||Ze.homedir()}function Z(){return process.env.CLAUDE_PROJECT_DIR||"."}function Tt(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function Dt(){return process.env.CLAUDE_PLUGIN_ROOT?F.join(tn(),".claude","logs","ork"):F.join(Z(),".claude","logs")}var js=F.join,Ls=F.sep;import{execSync as en}from"node:child_process";import{createHash as nn}from"node:crypto";import{existsSync as Ct,readFileSync as rn,writeFileSync as sn,mkdirSync as on}from"node:fs";import{join as tt,basename as an}from"node:path";var cn=20,un=15,dn=/[^a-z0-9-]/g;function gn(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=an(e);return Rt(n,cn)}function ln(t){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=en("git branch --show-current",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),r=Rt(n||"detached",un);return process.env.ORCHESTKIT_SESSION_BRANCH=r,r}catch{return"nobranch"}}function pn(t){let e=t||new Date,n=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${n}${r}`}function mn(t){let e=t||new Date,n=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0");return`${n}${r}`}function fn(){let t=`${process.pid}-${Date.now()}-${Math.random()}`;return nn("sha256").update(t).digest("hex").slice(0,4)}function Rt(t,e){return t.toLowerCase().replace(dn,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,e)}function yn(t,e){let n=gn(t),r=ln(t),i=pn(e),s=mn(e),o=fn();return`${n}-${r}-${i}-${s}-${o}`}function hn(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=tt(e,".instance","session-id.json");if(Ct(n))try{let r=JSON.parse(rn(n,"utf8"));if(r.session_id&&r.created_at){let i=Date.now()-new Date(r.created_at).getTime(),s=1440*60*1e3;if(i<s)return r.session_id}}catch{}}function kn(t,e){let n=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),r=tt(n,".instance"),i=tt(r,"session-id.json");try{Ct(r)||on(r,{recursive:!0}),sn(i,JSON.stringify({session_id:t,created_at:new Date().toISOString()},null,2))}catch{}}function Ot(t){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let e=hn(t);if(e)return e;let n=yn(t);return kn(n,t),n}function Ht(){return Dt()}function g(){return Z()}function et(){return Tt()}function Ks(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${et()}/.claude/.instance_env`}function h(){return Ot()}function Qs(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let e=vn("git branch --show-current",{cwd:t||g(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function In(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Xs(t){return t.replace(/\r\n/g,`
`)}function xn(t){let e=["debug","info","warn","error"];return e.indexOf(t)>=e.indexOf(In())}function l(){return{continue:!0,suppressOutput:!0}}function Ys(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function Zs(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function A(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function wn(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function to(t,e){let n={continue:!0,suppressOutput:!0};return t&&(n.systemMessage=t),e&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:e}),n}function eo(t,e){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?n.systemMessage=e:n.suppressOutput=!0,n}function no(t){return{continue:!0,systemMessage:t}}function R(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function nt(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}function ro(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:t}}}var An=200*1024,Tn=100*1024;function Nt(t,e){if(Pt(t))try{if(Sn(t).size>e){let r=`${t}.old.${Date.now()}`;bn(t,r)}}catch{}}function jt(t){Pt(t)||_n(t,{recursive:!0})}function c(t,e,n="debug"){if(!xn(n))return;let r=Ht(),i=`${r}/hooks.log`;try{jt(r),Nt(i,An);let s=new Date().toISOString().replace("T"," ").slice(0,19);Et(i,`[${s}] [${n.toUpperCase()}] [${t}] ${e}
`)}catch{}}function io(t,e,n){let r=Ht(),i=`${r}/permission-feedback.log`;try{jt(r),Nt(i,Tn);let s=new Date().toISOString(),o=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",a=n?.session_id||h();Et(i,`${s} | ${t} | ${e} | tool=${o} | session=${a}
`)}catch{}}function Dn(t){if(!t)return 0;let r=(t.match(/[{};()=><]/g)||[]).length/t.length>.03?2.8:3.5;return Math.ceil(t.length/r)}function so(t,e,n,r,i){let s=Dn(t);return r&&r.isOverBudget(n)?(c(e,`Budget exhausted for ${n}, suppressing ${s}t`),l()):(i&&i.trackTokenUsage(e,n,s),wn(t))}function oo(){try{let t=[],n=Buffer.allocUnsafe(256),r,i=0;for(;;)try{if(r=$n(i,n,0,256,null),r===0)break;t.push(Buffer.from(n.subarray(0,r)))}catch{break}let s=Buffer.concat(t).toString("utf8").trim();return s?JSON.parse(s):{tool_name:"",session_id:h(),tool_input:{}}}catch{return{tool_name:"",session_id:h(),tool_input:{}}}}function ao(t,e){let n=e.replace(/^\./,"").split("."),r=t;for(let i of n){if(r==null)return;r=r[i]}return r}function co(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function uo(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var lo={AUTO_DISPATCH:85,SKILL_INJECT:80,STRONG_RECOMMEND:70,SUGGEST:50,MINIMUM:40},po={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};import{existsSync as H,readFileSync as Mt,writeFileSync as Ft,mkdirSync as Cn}from"node:fs";function rt(){return`${g()}/.claude/orchestration`}function it(){let t=h();return`${rt()}/session-${t}.json`}function Ut(){return`${g()}/.claude/orchestration/config.json`}function Bt(){let t=rt();if(!H(t))try{Cn(t,{recursive:!0})}catch{c("orchestration-state",`Failed to create state dir: ${t}`)}}function v(){let t=it();if(H(t))try{let e=Mt(t,"utf8");return JSON.parse(e)}catch(e){c("orchestration-state",`Failed to load state: ${e}`)}return{sessionId:h(),activeAgents:[],injectedSkills:[],promptHistory:[],maxHistorySize:10,updatedAt:new Date().toISOString()}}function Rn(t){Bt();let e=it();t.updatedAt=new Date().toISOString();try{Ft(e,JSON.stringify(t,null,2))}catch(n){c("orchestration-state",`Failed to save state: ${n}`)}}function E(t){let e=v();return t(e),Rn(e),e}function ho(t,e,n){let r={agent:t,taskId:n,confidence:e,dispatchedAt:new Date().toISOString(),status:"pending",retryCount:0,maxRetries:3};return E(i=>{i.activeAgents=i.activeAgents.filter(s=>s.agent!==t),i.activeAgents.push(r)}),c("orchestration-state",`Tracked dispatched agent: ${t} (conf: ${e})`),r}function O(t,e,n){E(r=>{let i=r.activeAgents.find(s=>s.agent===t);i&&(i.status=e,n&&(i.taskId=n),e==="retrying"&&i.retryCount++)}),c("orchestration-state",`Updated agent status: ${t} -> ${e}`)}function st(t){E(e=>{e.activeAgents=e.activeAgents.filter(n=>n.agent!==t)})}function ko(){return v().activeAgents.find(e=>e.status==="in_progress")}function So(t){return v().activeAgents.some(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function bo(t){E(e=>{e.injectedSkills.includes(t)||e.injectedSkills.push(t)})}function _o(t){return v().injectedSkills.includes(t)}function $o(){return v().injectedSkills}function vo(t){E(e=>{e.promptHistory.push(t),e.promptHistory.length>e.maxHistorySize&&(e.promptHistory=e.promptHistory.slice(-e.maxHistorySize))})}function Io(){return v().promptHistory}function xo(t){E(e=>{e.lastClassification=t})}function wo(){return v().lastClassification}var Lt={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function ot(){let t=Ut();if(H(t))try{let e=Mt(t,"utf8");return{...Lt,...JSON.parse(e)}}catch{}return Lt}function Ao(t){Bt();let e=Ut(),r={...ot(),...t};try{Ft(e,JSON.stringify(r,null,2))}catch(i){c("orchestration-state",`Failed to save config: ${i}`)}}function To(){let t=it();try{if(H(t)){let{unlinkSync:e}=Y("node:fs");e(t),c("orchestration-state","Cleared session state")}}catch{}}function Do(){let t=rt();if(H(t))try{let{readdirSync:e,statSync:n,unlinkSync:r}=Y("node:fs"),i=e(t).filter(s=>s.startsWith("session-")&&s.endsWith(".json")).map(s=>({name:s,path:`${t}/${s}`,mtime:n(`${t}/${s}`).mtime.getTime()})).sort((s,o)=>o.mtime-s.mtime);for(let s of i.slice(5))try{r(s.path),c("orchestration-state",`Cleaned up old state: ${s.name}`)}catch{}}catch{}}var On=3,En=1e3,Pn=3e4,Hn={"backend-system-architect":["database-engineer","api-designer"],"frontend-ui-developer":["rapid-ui-designer","accessibility-specialist"],"test-generator":["debug-investigator","code-quality-reviewer"],"security-auditor":["security-layer-auditor"],"workflow-architect":["llm-integrator","data-pipeline-engineer"]},Nn=[/permission denied/i,/access denied/i,/not found.*(?:file|module|package)/i,/(?:file|module|package)\s+not\s+found/i,/missing required/i,/invalid (?:api|token|key)/i,/authentication failed/i,/quota exceeded/i,/rate limit/i],jn=[/not my specialization/i,/outside my scope/i,/better suited for/i,/consider using/i,/specialized agent/i];function Ln(t,e=En){let n=e*Math.pow(2,t-1),r=Math.random()*.1*n;return Math.min(n+r,Pn)}function Mn(t){for(let e of Nn)if(e.test(t))return!1;return!0}function Fn(t){for(let e of jn)if(e.test(t))return!0;return!1}function at(t,e=[]){let n=Hn[t];if(n){for(let r of n)if(!e.includes(r))return r}}function qt(t,e,n,r=[],i=On){if(c("retry-manager",`Evaluating retry for ${t}, attempt ${e}`),e>=i){let o=at(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:i,alternativeAgent:o,reason:`Max retries (${i}) exceeded`+(o?`. Consider trying ${o} instead.`:"")}}if(!Mn(n)){let o=at(t,r);return{shouldRetry:!1,retryCount:e,maxRetries:i,alternativeAgent:o,reason:`Non-retryable error detected: ${n.slice(0,100)}`}}if(Fn(n)){let o=at(t,r);if(o)return{shouldRetry:!1,retryCount:e,maxRetries:i,alternativeAgent:o,reason:`Error suggests using alternative agent: ${o}`}}let s=Ln(e);return{shouldRetry:!0,retryCount:e,maxRetries:i,delayMs:s,reason:`Retrying (attempt ${e+1}/${i}) after ${Math.round(s/1e3)}s`}}function Gt(t,e,n){return{agent:t,taskId:n,attemptNumber:e,startedAt:new Date().toISOString()}}function Jt(t,e,n){let r=new Date().toISOString(),i=new Date(r).getTime()-new Date(t.startedAt).getTime();return{...t,completedAt:r,outcome:e,error:n,durationMs:i}}function Oo(t){if(t.length===0)return{successRate:0,avgDuration:0,commonErrors:[]};let n=t.filter(a=>a.outcome==="success").length/t.length,r=t.filter(a=>a.durationMs!==void 0).map(a=>a.durationMs),i=r.length>0?r.reduce((a,u)=>a+u,0)/r.length:0,s=new Map;for(let a of t)if(a.error){let u=a.error.slice(0,50).toLowerCase();s.set(u,(s.get(u)||0)+1)}let o=Array.from(s.entries()).sort((a,u)=>u[1]-a[1]).slice(0,3).map(([a])=>a);return{successRate:n,avgDuration:i,commonErrors:o}}function Eo(t,e){return{...t,status:"retrying",retryCount:e.retryCount}}function zt(t,e){if(t.shouldRetry)return`## Retry Scheduled

Agent \`${e}\` will retry after ${Math.round((t.delayMs||0)/1e3)} seconds.

**Attempt:** ${t.retryCount+1} of ${t.maxRetries}
**Reason:** ${t.reason}`;let n=`## Retry Not Recommended

Agent \`${e}\` has ${t.retryCount>=t.maxRetries?"exhausted retries":"encountered a non-retryable error"}.

**Reason:** ${t.reason}`;return t.alternativeAgent&&(n+=`

### Alternative Suggestion

Consider using \`${t.alternativeAgent}\` instead:

\`\`\`
Task tool with subagent_type: "${t.alternativeAgent}"
\`\`\``),n}import{existsSync as Qt,readFileSync as Un,writeFileSync as Bn,mkdirSync as qn}from"node:fs";import{createHash as Gn}from"node:crypto";var Wt=500,ct=3,Vt=15,Kt=3,Jn=.9;function Xt(){return`${g()}/.claude/feedback/calibration-data.json`}function zn(){let t=`${g()}/.claude/feedback`;if(!Qt(t))try{qn(t,{recursive:!0})}catch{}}function N(){let t=Xt();if(Qt(t))try{return JSON.parse(Un(t,"utf8"))}catch{c("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function Wn(t){zn();let e=Xt();t.updatedAt=new Date().toISOString();try{Bn(e,JSON.stringify(t,null,2)),c("calibration-engine","Saved calibration data")}catch(n){c("calibration-engine",`Failed to save calibration data: ${n}`)}}function Vn(t){return Gn("sha256").update(t.toLowerCase().trim()).digest("hex").slice(0,16)}function Lo(t,e,n,r,i,s,o){let a=N(),u={timestamp:new Date().toISOString(),sessionId:h(),agent:e,promptHash:Vn(t),matchedKeywords:n,dispatchConfidence:r,outcome:i,durationMs:s,feedback:o};a.records.push(u),a.records.length>Wt&&(a.records=a.records.slice(-Wt)),Kn(a,u),Qn(a),Wn(a),c("calibration-engine",`Recorded outcome: ${e} -> ${i} (conf: ${r})`)}function Kn(t,e){let n=e.outcome==="success",r=e.outcome==="failure"||e.outcome==="rejected";if(!n&&!r)return;let i=n?Kt:-Kt;for(let s of e.matchedKeywords){let o=t.adjustments.find(a=>a.keyword===s&&a.agent===e.agent);o?(o.adjustment=Math.max(-Vt,Math.min(Vt,o.adjustment+i)),o.sampleCount++,o.lastUpdated=new Date().toISOString()):t.adjustments.push({keyword:s,agent:e.agent,adjustment:i,sampleCount:1,lastUpdated:new Date().toISOString()})}}function Mo(t){let e=Date.now(),n=1440*60*1e3;for(let r of t.adjustments){let i=e-new Date(r.lastUpdated).getTime();Math.floor(i/n)>7&&(r.adjustment=Math.round(r.adjustment*Jn),Math.abs(r.adjustment)<1&&(r.adjustment=0))}t.adjustments=t.adjustments.filter(r=>r.adjustment!==0)}function Qn(t){let e=t.records;if(e.length===0)return;t.stats.totalDispatches=e.length;let n=e.filter(s=>s.outcome==="success").length;t.stats.successRate=n/e.length;let r=e.reduce((s,o)=>s+o.dispatchConfidence,0)/e.length;t.stats.avgConfidence=Math.round(r);let i=new Map;for(let s of e){let o=i.get(s.agent)||{count:0,success:0};o.count++,s.outcome==="success"&&o.success++,i.set(s.agent,o)}t.stats.topAgents=Array.from(i.entries()).map(([s,o])=>({agent:s,count:o.count,successRate:o.success/o.count})).sort((s,o)=>o.count-s.count).slice(0,10)}function Fo(){return N().adjustments.filter(e=>e.sampleCount>=ct)}function Uo(t){let n=N().records.filter(i=>i.agent===t);return n.length<ct?null:n.filter(i=>i.outcome==="success").length/n.length}function Bo(){return N().stats}function qo(){return N().records.length>=ct}import{existsSync as Xn,statSync as Yn}from"node:fs";import{resolve as Zn}from"node:path";var Zt={"database-engineer":"database schema SQL PostgreSQL migration pgvector","backend-system-architect":"API REST architecture backend FastAPI microservice","frontend-ui-developer":"React frontend UI component TypeScript Tailwind","security-auditor":"security OWASP vulnerability audit authentication","test-generator":"testing unit integration coverage pytest MSW","workflow-architect":"LangGraph workflow agent orchestration state","llm-integrator":"LLM API OpenAI Anthropic embeddings RAG function-calling","data-pipeline-engineer":"data pipeline embeddings vector ETL chunking","metrics-architect":"metrics OKR KPI analytics instrumentation","ux-researcher":"UX user research persona journey accessibility","code-quality-reviewer":"code quality review linting type-check patterns","infrastructure-architect":"infrastructure cloud Docker Kubernetes deployment","ci-cd-engineer":"CI CD pipeline GitHub Actions deployment automation","accessibility-specialist":"accessibility WCAG ARIA screen-reader a11y","product-strategist":"product strategy roadmap features prioritization"};function tr(t){return Zt[t]||t}var Yt=100;function te(t){c("graph-memory-inject","Graph memory inject hook starting");let e=Zn(g(),".claude/memory/knowledge-graph.jsonl");if(!Xn(e))return c("graph-memory-inject","No graph data file, skipping"),l();try{let u=Yn(e).size;if(u<Yt)return c("graph-memory-inject",`Graph too small (${u}B < ${Yt}B), skipping`),l()}catch{return c("graph-memory-inject","Could not stat graph file, skipping"),l()}let n=t.tool_input||{},r=n.subagent_type||n.type||"";if(!r&&n.prompt){let u=n.prompt.toLowerCase(),d=Object.keys(Zt);for(let p of d)if(u.includes(p)){r=p;break}}if(!r)return c("graph-memory-inject","No agent type detected, passing through"),l();let i=`ork:${r}`,s=tr(r);c("graph-memory-inject",`Detected agent type: ${r} (agent_id: ${i})`);let o=`[Graph Memory - Agent Context Load]

Execute this MCP call to load graph context for ${r} agent:

## Graph Memory Entities
\`\`\`
mcp__memory__search_nodes
{"query": "${r} ${s}"}
\`\`\`

## Integration Instructions
1. Execute the graph search to retrieve relevant entities and relationships
2. Review entities for patterns, decisions, and constraints
3. Check relationships between concepts
4. Apply learned patterns to current task

Agent ID: ${i} | Domain: ${s}`,a=`[Graph Memory] Agent: ${r} | ID: ${i} | Load graph context via MCP call above`;return c("graph-memory-inject",`Outputting graph memory instructions for ${r}`),{continue:!0,systemMessage:a,hookSpecificOutput:{additionalContext:o}}}import{basename as er}from"node:path";var U=5,nr="agents",rr="decisions",ne={"database-engineer":"database schema SQL PostgreSQL migration pgvector","backend-system-architect":"API REST architecture backend FastAPI microservice","frontend-ui-developer":"React frontend UI component TypeScript Tailwind","security-auditor":"security OWASP vulnerability audit authentication","test-generator":"testing unit integration coverage pytest MSW","workflow-architect":"LangGraph workflow agent orchestration state","llm-integrator":"LLM API OpenAI Anthropic embeddings RAG function-calling","data-pipeline-engineer":"data pipeline embeddings vector ETL chunking","metrics-architect":"metrics OKR KPI analytics instrumentation","ux-researcher":"UX user research persona journey accessibility","code-quality-reviewer":"code quality review linting type-check patterns","infrastructure-architect":"infrastructure cloud Docker Kubernetes deployment","ci-cd-engineer":"CI CD pipeline GitHub Actions deployment automation","accessibility-specialist":"accessibility WCAG ARIA screen-reader a11y","product-strategist":"product strategy roadmap features prioritization"},ir={"database-engineer":["backend-system-architect","security-auditor","data-pipeline-engineer"],"backend-system-architect":["database-engineer","frontend-ui-developer","security-auditor","llm-integrator"],"frontend-ui-developer":["backend-system-architect","ux-researcher","accessibility-specialist","rapid-ui-designer"],"security-auditor":["backend-system-architect","database-engineer","infrastructure-architect"],"test-generator":["backend-system-architect","frontend-ui-developer","code-quality-reviewer"],"workflow-architect":["llm-integrator","backend-system-architect","data-pipeline-engineer"],"llm-integrator":["workflow-architect","data-pipeline-engineer","backend-system-architect"],"data-pipeline-engineer":["database-engineer","llm-integrator","workflow-architect"]};function sr(t){return ne[t]||t}function or(t){return ir[t]||[]}function ar(){let t=g();return(er(t)||"default-project").toLowerCase().replace(/ /g,"-").replace(/[^a-z0-9-]/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-")}function ee(t){return`${ar()}-${t}`}function cr(t){return`orchestkit-global-${t}`}function re(t){if(c("mem0-memory-inject","Mem0 memory inject hook starting"),!process.env.MEM0_API_KEY)return c("mem0-memory-inject","Mem0 not configured (no MEM0_API_KEY), skipping"),l();let e=t.tool_input||{},n=e.subagent_type||e.type||"";if(!n&&e.prompt){let S=e.prompt.toLowerCase(),w=Object.keys(ne);for(let C of w)if(S.includes(C)){n=C;break}}if(!n)return c("mem0-memory-inject","No agent type detected, passing through"),l();let r=`ork:${n}`,i=ee(nr),s=ee(rr),o=cr("best-practices"),a=sr(n),u=`${n} patterns decisions ${a}`;c("mem0-memory-inject",`Detected agent type: ${n} (agent_id: ${r})`);let d=or(n),m=`${process.env.CLAUDE_PLUGIN_ROOT||"${CLAUDE_PLUGIN_ROOT}"}/src/skills/mem0-memory/scripts/crud/search-memories.py`,f=`[Mem0 Cloud - Agent Context Load]

Execute these CLI scripts to load mem0 context for ${n} agent:

## 1. Agent-Specific Patterns (mem0)
\`\`\`bash
python3 ${m} \\
  --query "${u}" \\
  --user-id "${i}" \\
  --limit ${U} \\
  --enable-graph
\`\`\`

## 2. Project Decisions (mem0)
\`\`\`bash
python3 ${m} \\
  --query "${a} decisions" \\
  --user-id "${s}" \\
  --limit ${U} \\
  --enable-graph
\`\`\`

## 3. Cross-Project Best Practices (mem0)
\`\`\`bash
python3 ${m} \\
  --query "${a} best practices" \\
  --user-id "${o}" \\
  --limit ${U} \\
  --enable-graph
\`\`\``;if(d.length>0){let S=d.join(", ");f+=`

## 4. Cross-Agent Knowledge (from: ${S})
\`\`\`bash
python3 ${m} \\
  --query "${a}" \\
  --user-id "${i}" \\
  --limit ${U} \\
  --enable-graph
\`\`\``}let k=d.length>0?d.join(", "):"none";f+=`

## Integration Instructions
1. Execute the above CLI scripts to retrieve mem0 context
2. Review memories for patterns, decisions, and constraints
3. Apply learned patterns to current task
4. Avoid known anti-patterns (outcome: failed)

Agent ID: ${r} | Domain: ${a} | Related: ${k}`;let y=`[Mem0 Cloud] Agent: ${n} | ID: ${r} | Load mem0 context via CLI scripts above | Related: ${k}`;return c("mem0-memory-inject",`Outputting mem0 memory instructions for ${n}`),{continue:!0,systemMessage:y,hookSpecificOutput:{additionalContext:f}}}import{existsSync as j,readFileSync as q,writeFileSync as dt,mkdirSync as ur}from"node:fs";import{dirname as dr}from"node:path";var B=4,ut=6,gr=3,lr=/^(test-generator|backend-system-architect|workflow-architect|security-auditor|llm-integrator)$/;function gt(){return`${g()}/.claude/logs/agent-state.json`}function se(){return`${g()}/.claude/logs/subagent-spawns.jsonl`}function pr(){let t=gt(),e=dr(t);try{ur(e,{recursive:!0})}catch{}if(!j(t)){let n={active_background:[],session_total:0,last_cleanup:null,blocked_count:0};try{dt(t,JSON.stringify(n,null,2))}catch{}}}function mr(){let t=se();if(!j(t))return 0;try{let r=q(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),i=new Date(Date.now()-300*1e3).toISOString(),s=0;for(let o of r)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>i&&s++}catch{}return s}catch{return 0}}function fr(){let t=se();if(!j(t))return 0;try{let r=q(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),i=new Date(Date.now()-2*1e3).toISOString(),s=0;for(let o of r)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>i&&s++}catch{}return s}catch{return 0}}function yr(){let t=gt();try{if(j(t)){let e=JSON.parse(q(t,"utf8"));e.blocked_count=(e.blocked_count||0)+1,dt(t,JSON.stringify(e,null,2))}}catch{}}function ie(){let t=gt();try{if(j(t)){let e=JSON.parse(q(t,"utf8"));e.session_total=(e.session_total||0)+1,dt(t,JSON.stringify(e,null,2))}}catch{}}function oe(t){pr();let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"",i=e.run_in_background===!0||e.run_in_background==="true";c("context-gate",`Context gate check: ${n} (background=${i})`);let s=mr(),o=fr();return c("context-gate",`Active background: ${s}, Current response: ${o}`),o>=ut?(c("context-gate",`BLOCKED: Too many agents in single response (${o} >= ${ut})`),nt(`Context Overflow Protection

Too many agents spawned in a single response (${o} agents).

Maximum allowed: ${ut} per response

SOLUTION: Split into multiple responses or use sequential execution.
Consider using the /context-compression skill first.

Attempted: ${n} - ${r}`)):i&&s>=B?(c("context-gate",`BLOCKED: Too many concurrent background agents (${s} >= ${B})`),yr(),nt(`Background Agent Limit

Too many background agents running concurrently (${s} active).

Maximum allowed: ${B} concurrent background agents

SOLUTION:
1. Wait for existing agents to complete
2. Run this agent in foreground (remove run_in_background)
3. Use /context-compression to free up context

Attempted: ${n} - ${r}`)):s>=gr?(c("context-gate","WARNING: Approaching context budget limit"),ie(),R(`Context Budget Warning

${s} background agents active (limit: ${B}).

Consider:
- Running remaining agents sequentially
- Using /context-compression skill
- Waiting for current agents to complete

Proceeding with: ${n} - ${r}`)):lr.test(n)&&s>=2?(c("context-gate",`WARNING: Expensive agent type with multiple active: ${n}`),R(`Spawning expensive agent (${n}) with ${s} others active`)):(ie(),c("context-gate",`Context gate passed: ${n}`),l())}import{existsSync as lt,readFileSync as ce,readdirSync as hr}from"node:fs";function kr(){return`${g()}/.claude/context/session/state.json`}function Sr(){return`${g()}/.claude/context/knowledge/decisions/active.json`}function br(){return`${g()}/docs/issues`}function _r(){let t=kr();if(!lt(t))return{count:0,summary:""};try{let n=JSON.parse(ce(t,"utf8")).tasks_pending||[],r=n.length;if(r===0)return{count:0,summary:""};let i=n.slice(0,3).map(s=>`- ${s}`).join(`
`);return{count:r,summary:i}}catch{return{count:0,summary:""}}}function ae(t,e){let n=Sr();if(!lt(n))return"";try{return(JSON.parse(ce(n,"utf8")).decisions||[]).filter(o=>o.category===e||o.category==="api"||o.category==="database").slice(0,5).map(o=>`- ${o.title} (${o.status||"unknown"})`).join(`
`)}catch{return""}}function $r(t){let e=br();if(!lt(e))return"";try{let r=hr(e).find(i=>i.includes(t));if(r)return`docs/issues/${r}`}catch{}return""}function ue(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.task_description||e.description||"";c("subagent-context-stager",`Staging context for ${n}`);let i="",{count:s,summary:o}=_r();s>0&&(c("subagent-context-stager",`Found ${s} pending tasks`),i+=`ACTIVE TODOS:
${o}

`);let a=r.toLowerCase();if(/backend|api|endpoint|database|migration/.test(a)){c("subagent-context-stager","Backend task detected - staging backend decisions");let u=ae(r,"backend");u&&(i+=`RELEVANT DECISIONS:
${u}

`)}if(/frontend|react|ui|component/.test(a)){c("subagent-context-stager","Frontend task detected - staging frontend decisions");let u=ae(r,"frontend");u&&(i+=`RELEVANT DECISIONS:
${u}

`)}if(/test|testing|pytest|jest/.test(a)&&(c("subagent-context-stager","Testing task detected - staging test context"),i+=`TESTING REMINDERS:
- Use 'tee' for visible test output
- Check test patterns in backend/tests/ or frontend/src/**/__tests__/
- Ensure coverage meets threshold requirements

`),/issue|#\d+|bug|fix/.test(a)){c("subagent-context-stager","Issue-related task detected");let u=r.match(/#(\d+)/);if(u){let d=u[1],p=$r(d);p&&(i+=`ISSUE DOCS: ${p}

`,c("subagent-context-stager",`Staged issue documentation for #${d}`))}}if(i){let u=`${i}
Task: ${r}
Subagent: ${n}`,d=i.split(`
`).filter(Boolean).length;return c("subagent-context-stager",`Staged context with ${d} lines`),{continue:!0,systemMessage:u}}return c("subagent-context-stager","No context staged for this task"),l()}import{existsSync as L,readFileSync as pt,mkdirSync as vr,appendFileSync as Ir,readdirSync as xr}from"node:fs";import{join as $,dirname as wr}from"node:path";var Ar=new Set(["general-purpose","Explore","Plan","claude-code-guide","statusline-setup","Bash"]);function Tr(){return $(g(),".claude","logs","subagent-spawns.jsonl")}function Dr(){return $(g(),"plugin.json")}function mt(){return $(g(),"agents")}function ft(){return $(g(),".claude","agents")}function Cr(){return $(g(),"skills")}function Rr(){let t=new Set(Ar),e=Dr();if(L(e))try{let i=JSON.parse(pt(e,"utf8")).agents||[];for(let s of i)s.id&&t.add(s.id)}catch{}let n=[mt(),ft()];for(let r of n)if(L(r))try{let i=xr(r);for(let s of i)s.endsWith(".md")&&t.add(s.replace(".md",""))}catch{}return t}function Or(t){let e=[],n=[$(mt(),`${t}.md`),$(ft(),`${t}.md`)],r=null;for(let i of n)if(L(i)){r=i;break}if(!r)return e;try{let s=pt(r,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of s){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^skills:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let d=u.match(/^\s*-\s*(.+)$/);if(d){let p=d[1].trim();e.push(p)}}}}}catch{}return e}function Er(t){let e=Or(t),n=[],r=Cr();for(let i of e){let s=$(r,i,"SKILL.md");L(s)||n.push(i)}return n}function Pr(t){let e=[],n=[$(mt(),`${t}.md`),$(ft(),`${t}.md`)],r=null;for(let i of n)if(L(i)){r=i;break}if(!r)return e;try{let s=pt(r,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of s){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^tools:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let d=u.match(/^\s*-\s*(.+)$/);d&&e.push(d[1].trim())}}}}catch{}return e}function Hr(t,e){if(e.length===0)return"";let n=e.every(o=>["Read","Glob","Grep"].includes(o)),r=e.includes("Bash"),i=e.includes("Write")||e.includes("Edit"),s="low";return r&&i?s="elevated":(r||i)&&(s="moderate"),`## Agent Permission Profile (CC 2.1.20)

**Agent**: \`${t}\`
**Tools**: ${e.join(", ")}
**Risk Level**: ${s}${n?" (read-only)":""}

${r?`> This agent requests Bash access. Review commands carefully.
`:""}`}function Nr(t,e,n){let r=Tr(),i=wr(r);try{vr(i,{recursive:!0})}catch{}let s={timestamp:new Date().toISOString(),subagent_type:t,description:e,session_id:n};try{Ir(r,JSON.stringify(s)+`
`)}catch{}}function de(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"",i=t.session_id||h();c("subagent-validator",`Task invocation: ${n} - ${r}`),Nr(n,r,i);let s=n.replace(/^[^:]+:/,""),o=Rr();!o.has(n)&&!o.has(s)&&c("subagent-validator",`WARNING: Unknown subagent type: ${n}`),c("subagent-validator",`Spawning ${n} agent: ${r}`);let a=Er(s);if(a.length>0){let d=a.join(", ");c("subagent-validator",`WARNING: Agent '${s}' references missing skills: ${d}`),console.error(`Warning: Agent '${s}' references ${a.length} missing skill(s): ${d}`)}let u=Pr(s);if(u.length>0){let d=Hr(s,u);return c("subagent-validator",`Agent '${s}' tools: ${u.join(", ")}`),A(d)}return l()}import{existsSync as ge,readFileSync as jr,writeFileSync as Lr,mkdirSync as Mr}from"node:fs";function le(){let t=h();return`${g()}/.claude/orchestration/task-registry-${t}.json`}function Fr(){let t=`${g()}/.claude/orchestration`;if(!ge(t))try{Mr(t,{recursive:!0})}catch{}}function P(){let t=le();if(ge(t))try{return JSON.parse(jr(t,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:h(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function yt(t){Fr();let e=le();t.updatedAt=new Date().toISOString();try{Lr(e,JSON.stringify(t,null,2))}catch(n){c("task-integration",`Failed to save registry: ${n}`)}}function pe(t,e){return`### Delete Orphaned Task

\`\`\`
TaskUpdate:
  taskId: "${t}"
  status: "deleted"
\`\`\`

**Reason**: ${e}`}function G(t){let e=`### Update Task

\`\`\`
TaskUpdate:
  taskId: "${t.taskId}"`;return t.status&&(e+=`
  status: "${t.status}"`),t.addBlockedBy&&t.addBlockedBy.length>0&&(e+=`
  addBlockedBy: ${JSON.stringify(t.addBlockedBy)}`),t.addBlocks&&t.addBlocks.length>0&&(e+=`
  addBlocks: ${JSON.stringify(t.addBlocks)}`),e+="\n```",e}function I(t,e){let n=P(),r=n.tasks.find(i=>i.taskId===t);r&&(r.status=e,yt(n),c("task-integration",`Updated task ${t} status to ${e}`))}function T(t){return P().tasks.find(n=>n.agent===t&&(n.status==="pending"||n.status==="in_progress"))}function me(t){return P().tasks.filter(n=>n.status==="pending"&&n.blockedBy&&n.blockedBy.includes(t))}function ht(t){return P().tasks.filter(n=>n.pipelineId===t).sort((n,r)=>(n.pipelineStep||0)-(r.pipelineStep||0))}function fe(){return P().pipelines.find(e=>e.status==="running")}function ye(t,e){let n=P(),r=n.pipelines.find(s=>s.pipelineId===t);if(!r)return null;r.completedSteps.includes(e)||(r.completedSteps.push(e),r.completedSteps.sort((s,o)=>s-o));let i=ht(t);for(let s of i){let o=s.pipelineStep;if(o===void 0||r.completedSteps.includes(o)||s.status!=="pending")continue;if(o===0||r.completedSteps.includes(o-1))return r.currentStep=o,yt(n),o}return r.status="completed",yt(n),null}function he(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return c("task-linker","No agent type found, skipping"),l();c("task-linker",`Processing SubagentStart for: ${n}`);let r=T(n);if(!r)return c("task-linker",`No orchestration task found for agent: ${n}`),l();c("task-linker",`Found task ${r.taskId} for agent ${n}`),I(r.taskId,"in_progress"),O(n,"in_progress",r.taskId);let i=G({taskId:r.taskId,status:"in_progress"}),s=`## Orchestration: Task Linked

Agent \`${n}\` has been linked to task **${r.taskId}**.

${i}

The task status should be updated to \`in_progress\`.`;return c("task-linker",`Linked agent ${n} to task ${r.taskId}`),A(s)}import{appendFileSync as Ur,mkdirSync as Br,existsSync as ke,readFileSync as Se}from"node:fs";import{join as kt,dirname as qr}from"node:path";var St=new Set(["backend-system-architect","infrastructure-architect","workflow-architect","event-driven-architect","python-performance-engineer","ai-safety-auditor"]),Gr=new Set(["demo-producer"]),Jr=[/security|vulnerab|audit|penetration/i,/architect|design.*system|distributed/i,/migration.*schema|database.*design/i,/performance.*optim|profil|bottleneck/i,/langgraph|workflow.*orchestrat/i],zr=[/list|count|check|verify|read|search/i,/simple|straightforward|quick/i,/format|lint|style|typo|rename/i,/status|progress|summary/i];function Wr(t){let e=et();if(!e)return null;let n=kt(e,"agents",`${t}.md`);if(!ke(n))return null;try{let i=Se(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!i)return null;let s=i[1].match(/^skills:\s*\n((?:\s+-\s+.+\n)*)/m);if(!s)return null;let o=s[1].match(/^\s+-\s+(.+)$/gm)?.map(p=>p.trim().replace(/^-\s+/,""))||[];if(o.length===0)return null;let a={low:0,medium:1,high:2},u="low",d=o.slice(0,5);for(let p of d){let m=kt(e,"skills",p,"SKILL.md");if(!ke(m))continue;let k=Se(m,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!k)continue;let y=k[1].match(/^complexity:\s*(low|medium|high)$/m);if(y){let S=y[1];a[S]>a[u]&&(u=S)}}return u}catch{return null}}function be(t,e){let n=Wr(t);return n==="high"||Jr.filter(s=>s.test(e)).length>=2||St.has(t)?"high":zr.filter(s=>s.test(e)).length>=2?"low":n||"medium"}function _e(t){return St.has(t)?"opus":Gr.has(t)?"sonnet":process.env.CLAUDE_MODEL||"sonnet"}function Vr(t,e){let n=be(t,e),r=_e(t);return n==="high"&&r==="haiku"?{recommended:"sonnet",current:r,reason:"High-complexity task detected \u2014 haiku may produce lower quality results",savingsPercent:0}:n==="low"&&r==="opus"?{recommended:"sonnet",current:r,reason:"Simple task detected \u2014 sonnet handles this equally well at lower cost",savingsPercent:40}:n==="medium"&&r==="opus"&&!St.has(t)?{recommended:"sonnet",current:r,reason:"Medium-complexity task \u2014 sonnet is sufficient, Opus adds cost without benefit",savingsPercent:30}:null}function Kr(t,e,n,r){let i=kt(g(),".claude","logs","model-usage.jsonl");try{Br(qr(i),{recursive:!0});let s={timestamp:new Date().toISOString(),agent:t,model:e,complexity:n,recommendation:r?.recommended||null,potentialSavings:r?.savingsPercent||0};Ur(i,JSON.stringify(s)+`
`)}catch{}}function $e(t){let e=t.tool_input||{},n=e.subagent_type||"",r=e.description||"";if(!n)return l();let i=be(n,r),s=_e(n),o=Vr(n,r);return Kr(n,s,i,o),o?(c("model-cost-advisor",`${n}: Recommend ${o.recommended} instead of ${o.current} (${o.reason})`,"info"),o.savingsPercent>=30?R(`Model cost optimization: ${n} using ${o.current} for ${i}-complexity task. ${o.reason}. Potential savings: ~${o.savingsPercent}%. Consider using model: "${o.recommended}" for this agent.`):l()):(c("model-cost-advisor",`${n}: ${s} is appropriate for ${i} task`),l())}import{existsSync as Qr,mkdirSync as Xr,appendFileSync as Yr,unlinkSync as Zr}from"node:fs";import{basename as ti,dirname as ei}from"node:path";var ni=["decided to","chose","implemented using","selected","opted for","will use","pattern:","approach:","architecture:","recommends","best practice","anti-pattern","learned that"],ri="decisions";function ii(){return`${g()}/.claude/logs/agent-patterns.jsonl`}function si(){return`${g()}/.claude/session`}function ve(){let t=g();return(ti(t)||"default-project").toLowerCase().replace(/ /g,"-").replace(/[^a-z0-9-]/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-")}function oi(t){return`${ve()}-${t}`}function ai(t){let r=(t.length>10240?t.substring(0,10240):t).toLowerCase();return/pagination|cursor|offset/.test(r)?"pagination":/security|vulnerability|exploit|injection|xss|csrf|owasp|safety|guardrail/.test(r)?"security":/database|sql|postgres|schema/.test(r)?"database":/\bapi\b|endpoint|\brest\b|graphql/.test(r)?"api":/auth|login|jwt|oauth/.test(r)?"authentication":/\btest\b|testing|pytest|jest|vitest|coverage|\bmock\b|fixture|\bspec\b/.test(r)?"testing":/deploy|\bci\b|\bcd\b|pipeline|docker|kubernetes|helm|terraform/.test(r)?"deployment":/observability|monitoring|logging|tracing|metrics|prometheus|grafana|langfuse/.test(r)?"observability":/react|component|frontend|\bui\b/.test(r)?"frontend":/performance|optimization|cache|index/.test(r)?"performance":/llm|\brag\b|embedding|vector|semantic|\bai\b|\bml\b|langchain|langgraph|mem0|openai|anthropic/.test(r)?"ai-ml":/etl|data.*pipeline|streaming|batch.*processing|dataflow|spark/.test(r)?"data-pipeline":/architecture|design|structure/.test(r)?"architecture":/decided|chose|selected/.test(r)?"decision":"pattern"}function ci(t){let e=[];if(t.length<50)return e;for(let r of ni){let i=new RegExp(`^.*${r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}.*$`,"gim"),s=t.match(i)||[];for(let o of s){let a=o.trim().substring(0,200);a.length>20&&e.push(a)}}return[...new Set(e)].slice(0,5)}function J(t){c("agent-memory-store","Agent memory store hook starting");let e=t.tool_input||{},n=t.subagent_type||e.subagent_type||e.type||"",r=t.tool_result,i=typeof r=="string"?r:r?.content||t.agent_output||t.output||"",s=!0;if(t.error&&(s=!1),typeof r=="object"&&r?.is_error&&(s=!1),!n)return c("agent-memory-store","No agent type in input, skipping"),l();let o=`ork:${n}`,a=`${si()}/current-agent-id`;try{Qr(a)&&Zr(a)}catch{}c("agent-memory-store",`Processing completion for agent: ${n} (agent_id: ${o}, success: ${s})`);let u=s&&i?ci(i):[];if(u.length===0)return c("agent-memory-store",`No patterns extracted from ${n} output`),l();let d=ii(),p=ei(d);try{Xr(p,{recursive:!0})}catch{}let m=ve(),f=new Date().toISOString(),k=oi(ri);for(let w of u){let C=ai(w),X={agent:n,agent_id:o,pattern:w,project:m,timestamp:f,suggested_user_id:k,category:C,enable_graph:!0,pending_sync:!0};try{Yr(d,JSON.stringify(X)+`
`)}catch{}c("agent-memory-store",`Extracted pattern (${C}): ${w.substring(0,50)}...`)}return c("agent-memory-store",`Extracted ${u.length} patterns from ${n} output`),{continue:!0,systemMessage:`[Pattern Extraction] ${u.length} patterns extracted from ${n}. To persist, use CLI: python3 \${CLAUDE_PLUGIN_ROOT}/src/skills/mem0-memory/scripts/crud/add-memory.py --text "..." --user-id '${k}' --metadata '{"agent_id":"${o}"}'`}}import{existsSync as ui,writeFileSync as Ie,mkdirSync as bt,appendFileSync as di,readFileSync as gi}from"node:fs";import{dirname as li}from"node:path";var pi=[".env","credentials","secret","auth","password","token","api.key","private.key",".pem","oauth","jwt","session","cookie","encryption","crypto"];function mi(){let t=`${g()}/.claude/hooks/logs`;try{bt(t,{recursive:!0})}catch{}return`${t}/auto-spawn-quality.log`}function fi(){return`${g()}/.claude/context/spawn-queue.json`}function _(t){let e=mi(),n=new Date().toISOString();try{di(e,`[${n}] [auto-spawn-quality] ${t}
`)}catch{}}function yi(t){let e=t.toLowerCase();for(let n of pi)if(e.includes(n))return _(`Detected sensitive pattern: ${n}`),!0;return!1}function hi(t,e,n,r,i,s){let o=`SPAWN-${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,14)}-${Math.floor(Math.random()*1e4).toString().padStart(4,"0")}`,a=fi(),u=li(a);try{bt(u,{recursive:!0})}catch{}let d;if(ui(a))try{d=JSON.parse(gi(a,"utf8"))}catch{d={schema_version:"1.0.0",created_at:s,queue:[]}}else d={schema_version:"1.0.0",created_at:s,queue:[]};let p={spawn_id:o,target_agent:e,trigger_agent:t,trigger_reason:n,priority:r,timestamp:s,session_id:i,status:"queued"};d.queue.push(p);try{Ie(a,JSON.stringify(d,null,2)),_(`Queued spawn request: ${o} for ${e} (reason: ${n})`)}catch{return _(`ERROR: Failed to queue spawn request for ${e}`),""}return o}function ki(t,e,n,r,i,s){let o=`${g()}/.claude/context/handoffs`;try{bt(o,{recursive:!0})}catch{}let a=`${o}/auto_spawn_${e}_${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,15)}.json`,u={type:"auto_spawn_suggestion",from_agent:t,to_agent:e,timestamp:s,trigger_reason:n,priority:r,session_id:i,auto_triggered:!0,status:"suggested"};try{Ie(a,JSON.stringify(u,null,2)),_(`Created spawn suggestion: ${e} (reason: ${n})`)}catch{}}function Si(t,e,n){if(n&&n!=="null")return _(`Skipping auto-spawn - agent ${t} had errors: ${n}`),null;if(t==="test-generator")return _("Rule matched: test-generator -> code-quality-reviewer"),{target:"code-quality-reviewer",reason:"test-generator completed - validating test quality and coverage",priority:"high"};if(yi(e)&&t!=="security-auditor"&&t!=="security-layer-auditor")return _("Rule matched: sensitive files detected -> security-auditor"),{target:"security-auditor",reason:"sensitive file changes detected - security audit required",priority:"critical"};if(t==="code-quality-reviewer")return _("Rule matched: code-quality-reviewer -> security-auditor"),{target:"security-auditor",reason:"code-quality-reviewer completed - proceeding with security scan",priority:"high"};if(t==="backend-system-architect"){let r=e.toLowerCase();if(/authentication|authorization|security|access.control|rbac|acl/.test(r))return _("Rule matched: backend-system-architect with auth -> security-layer-auditor"),{target:"security-layer-auditor",reason:"backend-system-architect designed auth/security layer - validation required",priority:"high"}}return null}function xe(t){let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",i=t.session_id||h(),s=t.agent_output||t.output||"",o=t.error||"";if(_(`Checking auto-spawn conditions for agent: ${r} (session: ${i})`),r==="unknown"||!r)return _("Skipping unknown agent type"),l();let a=Si(r,s,o);if(a){let u=hi(r,a.target,a.reason,a.priority,i,e);return ki(r,a.target,a.reason,a.priority,i,e),_(`=== AUTO-SPAWN QUALITY HOOK ===
Trigger Agent: ${r}
Target Agent: ${a.target}
Reason: ${a.reason}
Priority: ${a.priority}
Spawn ID: ${u}
Timestamp: ${e}
Session: ${i}`),{continue:!0,systemMessage:`Auto-spawn queued: ${a.target} (${a.priority} priority)`}}return _(`No auto-spawn conditions matched for ${r}`),l()}import{existsSync as bi,writeFileSync as Te,mkdirSync as _i,readFileSync as $i}from"node:fs";import{dirname as _t}from"node:path";function vi(){return`${g()}/.claude/context/knowledge/decisions/active.json`}function Ii(){return`${g()}/.claude/context/session/state.json`}function xi(){return`${g()}/.claude/logs/agent-context`}function z(t){try{_i(t,{recursive:!0})}catch{}}function we(t,e){if(!bi(t))return e;try{return JSON.parse($i(t,"utf8"))}catch{return e}}function Ae(t,e){let n=_t(t);z(n);try{Te(t,JSON.stringify(e,null,2))}catch{}}function W(t){let e=process.env.CLAUDE_AGENT_NAME||"unknown",n=new Date().toISOString(),r=t.agent_output||t.output||"",i=r.substring(0,200);r.length>200&&(i+="...");let s=e.replace(/-/g,"_"),o=vi(),a=_t(o);z(a);let d=we(o,{schema_version:"2.0.0",decisions:{}});(!d.decisions||typeof d.decisions!="object")&&(d.decisions={});let p={timestamp:n,agent:e,summary:i,status:"completed"};d.decisions[s]=p,Ae(o,d);let m=Ii(),f=_t(m);z(f);let y=we(m,{schema_version:"2.0.0",session_id:"",started_at:n,last_activity:n,active_agent:null,tasks_pending:[],tasks_completed:[]});Array.isArray(y.tasks_completed)||(y.tasks_completed=[]),Array.isArray(y.tasks_pending)||(y.tasks_pending=[]);let S={agent:e,timestamp:n,summary:i};y.tasks_completed.push(S),y.last_activity=n,y.active_agent=null,Ae(m,y);let w=xi();z(w);let C=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),X=`${w}/${e}_${C}.log`,Ye=`=== CONTEXT PUBLICATION (Protocol 2.0) ===
Agent: ${e}
Timestamp: ${n}
Decisions file: ${o}
Session state: ${m}

=== AGENT OUTPUT ===
${r}
`;try{Te(X,Ye)}catch{}return l()}import{existsSync as wi,writeFileSync as Ce,mkdirSync as $t,readFileSync as Ai,appendFileSync as Ti}from"node:fs";import{dirname as Di}from"node:path";var De=[{type:"product-thinking",name:"Product Thinking Pipeline",description:"Full product discovery and specification workflow",triggers:["should we build","product decision","feature validation","market research","user research"],steps:[{agent:"market-intelligence",description:"Analyze competitive landscape and market trends",dependsOn:[],skills:["market-research"],estimatedTokens:3e3},{agent:"ux-researcher",description:"Create personas and map user journeys",dependsOn:[0],skills:["user-research"],estimatedTokens:2500},{agent:"product-strategist",description:"Validate value proposition and alignment",dependsOn:[0,1],skills:["product-strategy"],estimatedTokens:2e3},{agent:"prioritization-analyst",description:"Score and prioritize using frameworks",dependsOn:[2],skills:["prioritization"],estimatedTokens:1500},{agent:"business-case-builder",description:"Build ROI and cost-benefit analysis",dependsOn:[2,3],skills:["business-case"],estimatedTokens:2e3},{agent:"requirements-translator",description:"Transform to PRD and user stories",dependsOn:[4],skills:["requirements"],estimatedTokens:2500}],estimatedTotalTokens:13500},{type:"full-stack-feature",name:"Full-Stack Feature Pipeline",description:"End-to-end feature implementation workflow",triggers:["full-stack feature","build a feature","implement end-to-end","create full feature","add complete feature"],steps:[{agent:"backend-system-architect",description:"Design API and database schema",dependsOn:[],skills:["api-design-framework","database-schema-designer"],estimatedTokens:3e3},{agent:"frontend-ui-developer",description:"Build React components and UI",dependsOn:[0],skills:["react-server-components-framework","form-state-patterns"],estimatedTokens:3500},{agent:"test-generator",description:"Create unit and integration tests",dependsOn:[0,1],skills:["integration-testing","msw-mocking"],estimatedTokens:2e3},{agent:"security-auditor",description:"Audit for vulnerabilities",dependsOn:[0,1],skills:["owasp-top-10","auth-patterns"],estimatedTokens:1500}],estimatedTotalTokens:1e4},{type:"ai-integration",name:"AI Integration Pipeline",description:"Add AI/LLM capabilities to application",triggers:["add rag","add llm","ai integration","implement rag","add ai feature","langgraph workflow"],steps:[{agent:"workflow-architect",description:"Design LangGraph workflow and state",dependsOn:[],skills:["langgraph-state","langgraph-routing"],estimatedTokens:2500},{agent:"llm-integrator",description:"Connect LLM APIs with function calling",dependsOn:[0],skills:["function-calling","llm-streaming"],estimatedTokens:2e3},{agent:"data-pipeline-engineer",description:"Build embeddings and data pipeline",dependsOn:[0],skills:["embeddings","rag-retrieval"],estimatedTokens:2500},{agent:"test-generator",description:"Create LLM testing infrastructure",dependsOn:[1,2],skills:["llm-testing","property-based-testing"],estimatedTokens:1500}],estimatedTotalTokens:8500},{type:"security-audit",name:"Security Audit Pipeline",description:"Comprehensive security review workflow",triggers:["security audit","security review","vulnerability scan","security assessment"],steps:[{agent:"security-auditor",description:"Scan for OWASP Top 10 vulnerabilities",dependsOn:[],skills:["owasp-top-10","input-validation"],estimatedTokens:2e3},{agent:"security-layer-auditor",description:"Verify defense-in-depth layers",dependsOn:[0],skills:["defense-in-depth"],estimatedTokens:2e3},{agent:"ai-safety-auditor",description:"Audit AI/LLM security if applicable",dependsOn:[0],skills:["mcp-security-hardening"],estimatedTokens:1500}],estimatedTotalTokens:5500},{type:"frontend-compliance",name:"Frontend 2026 Compliance Pipeline",description:"Modernize frontend to 2026 patterns",triggers:["frontend compliance","modernize frontend","update react","frontend 2026"],steps:[{agent:"frontend-ui-developer",description:"Upgrade to React 19 patterns",dependsOn:[],skills:["react-server-components-framework","zustand-patterns"],estimatedTokens:3e3},{agent:"performance-engineer",description:"Optimize Core Web Vitals",dependsOn:[0],skills:["core-web-vitals","lazy-loading-patterns"],estimatedTokens:2e3},{agent:"accessibility-specialist",description:"Ensure WCAG 2.2 compliance",dependsOn:[0],skills:["a11y-testing","focus-management"],estimatedTokens:1500}],estimatedTotalTokens:6500}];function Ci(){return`${g()}/.claude/coordination/decision-log.json`}function Ri(){let t=`${g()}/.claude/hooks/logs`;try{$t(t,{recursive:!0})}catch{}return`${t}/agent-feedback.log`}function x(t){let e=Ri(),n=new Date().toISOString();try{Ti(e,`[${n}] [feedback-loop] ${t}
`)}catch{}}function Oi(t){let e=fe();if(e){let r=De.find(i=>i.type===e.type);if(r){let i=r.steps.findIndex(s=>s.agent===t);if(i>=0){let s=r.steps.filter((o,a)=>o.dependsOn.includes(i)&&a>i).map(o=>o.agent);if(s.length>0)return s.join(" ")}}}return{"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"test-generator","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer"}[t]||""}function Ei(t){return{"market-intelligence":"product-thinking","product-strategist":"product-thinking","prioritization-analyst":"product-thinking","business-case-builder":"product-thinking","requirements-translator":"specification","metrics-architect":"specification","backend-system-architect":"architecture","database-engineer":"architecture","data-pipeline-engineer":"architecture","frontend-ui-developer":"frontend","rapid-ui-designer":"frontend","ux-researcher":"frontend","test-generator":"quality","code-quality-reviewer":"quality","security-auditor":"security","security-layer-auditor":"security","workflow-architect":"ai-integration","llm-integrator":"ai-integration","debug-investigator":"debugging"}[t]||"general"}function Pi(){return process.env.CLAUDE_INSTANCE_ID||`${Y("os").hostname()}-${process.pid}`}function Hi(t){let e=t.substring(0,500);return t.length>500&&(e+="..."),e}function Ni(t,e,n,r,i,s,o,a){let u=Ci(),d=Di(u);try{$t(d,{recursive:!0})}catch{}let p;if(wi(u))try{p=JSON.parse(Ai(u,"utf8"))}catch{p={schema_version:"2.0.0",log_created_at:o,decisions:[]}}else p={schema_version:"2.0.0",log_created_at:o,decisions:[]};let m={decision_id:t,timestamp:o,made_by:{instance_id:Pi(),agent_type:e},category:n,title:`Agent ${e} completed`,description:r,impact:{scope:"agent-pipeline",downstream_agents:i.split(" ").filter(Boolean)},status:s,task_id:a};p.decisions.push(m);try{Ce(u,JSON.stringify(p,null,2)),x(`Decision ${t} logged for agent ${e}`)}catch{x("ERROR: Failed to write decision to log")}}function ji(t,e,n,r,i,s,o){if(!e)return;let a=`${g()}/.claude/context/handoffs`;try{$t(a,{recursive:!0})}catch{}let u=e.split(" ").filter(Boolean),d=new Date().toISOString().replace(/[-:]/g,"").substring(0,15);for(let p of u){let m=`${a}/${t}_to_${p}_${d}.json`,f={from_agent:t,to_agent:p,timestamp:s,decision_id:r,summary:n,session_id:i,status:"pending",feedback_loop:!0,task_id:o};try{Ce(m,JSON.stringify(f,null,2)),x(`Created handoff context: ${t} -> ${p}`)}catch{}}}function V(t){let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",i=t.session_id||h(),s=t.agent_output||t.output||"",o=t.error||"";if(x(`Processing feedback for agent: ${r} (session: ${i})`),r==="unknown"||!r)return x("Skipping unknown agent type"),l();let a=new Date().toISOString().replace(/[-:T.]/g,"").substring(0,8),u=Math.floor(Math.random()*1e4).toString().padStart(4,"0"),d=`DEC-${a}-${u}`,m=T(r)?.taskId,f=Oi(r),k=Ei(r),y,S;return o&&o!=="null"?(y=`Agent failed: ${o}`,S="failed"):(y=Hi(s),S="completed"),m&&(I(m,S==="completed"?"completed":"failed"),x(`Updated task ${m} status to ${S}`)),Ni(d,r,k,y,f,S,e,m),f?(ji(r,f,y,d,i,e,m),x(`Routed findings to downstream agents: ${f}`)):x(`No downstream agents for ${r} (terminal agent)`),x(`=== AGENT FEEDBACK LOOP ===
Agent: ${r}
Category: ${k}
Decision ID: ${d}
Task ID: ${m||"none"}
Timestamp: ${e}
Status: ${S}
Downstream: ${f||"none"}

Summary: ${y}`),f?{continue:!0,systemMessage:`Feedback loop: routed to ${f}${m?` (task: ${m})`:""}`}:l()}import{writeFileSync as Re,mkdirSync as Oe}from"node:fs";var Li=new Set(["market-intelligence","product-strategist","prioritization-analyst","business-case-builder","requirements-translator","metrics-architect","backend-system-architect","code-quality-reviewer","data-pipeline-engineer","database-engineer","debug-investigator","frontend-ui-developer","llm-integrator","rapid-ui-designer","security-auditor","security-layer-auditor","system-design-reviewer","test-generator","ux-researcher","workflow-architect"]),Mi={"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"code-quality-reviewer","code-quality-reviewer":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"code-quality-reviewer","database-engineer":"backend-system-architect","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer","security-auditor":"none","security-layer-auditor":"none","debug-investigator":"none","system-design-reviewer":"none"},Fi={"market-intelligence":"Next: product-strategist should define product vision based on market analysis","product-strategist":"Next: prioritization-analyst should rank features from strategy","prioritization-analyst":"Next: business-case-builder should create ROI justification","business-case-builder":"Next: requirements-translator should convert to technical specs","requirements-translator":"Next: metrics-architect should define success criteria","metrics-architect":"Next: backend-system-architect should design API endpoints","backend-system-architect":"Next: frontend-ui-developer should build UI components","frontend-ui-developer":"Next: test-generator should create test coverage","test-generator":"Next: code-quality-reviewer should validate implementation","code-quality-reviewer":"Next: security-auditor should perform security scan","workflow-architect":"Next: llm-integrator should configure LLM providers","llm-integrator":"Next: data-pipeline-engineer should set up embeddings","data-pipeline-engineer":"Next: code-quality-reviewer should validate data pipeline","database-engineer":"Next: backend-system-architect should integrate schema","rapid-ui-designer":"Next: frontend-ui-developer should implement designs","ux-researcher":"Next: rapid-ui-designer should create mockups"};function Ui(t){return Mi[t]||"none"}function Bi(t){return Fi[t]||"Pipeline complete"}function qi(t,e,n,r,i){let s=`${g()}/.claude/context/handoffs`;try{Oe(s,{recursive:!0})}catch{}let o=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),a=`${s}/${t}_to_${e}_${o}.json`,u={from_agent:t,to_agent:e,timestamp:n,summary:r,suggestions:i,status:"ready_for_handoff"};try{Re(a,JSON.stringify(u,null,2))}catch{}return a}function Gi(t,e,n,r,i,s){let o=`${g()}/.claude/logs/agent-handoffs`;try{Oe(o,{recursive:!0})}catch{}let a=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),u=`${o}/${t}_${a}.log`,d=`=== HANDOFF PREPARATION ===
From: ${t}
To: ${e}
Timestamp: ${n}
Handoff file: ${s}

Summary: ${r}

Next Steps: ${i}
`;try{Re(u,d)}catch{}}function K(t){let e=new Date().toISOString(),r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown";if(!Li.has(r))return l();let i=Ui(r),s=t.agent_output||t.output||"",o=s.length,a;o>0?(a=s.substring(0,300),o>300&&(a+="...")):a=`Agent ${r} completed`;let u=Bi(r),d=qi(r,i,e,a,u);return Gi(r,i,e,a,u,d),l()}import{writeFileSync as Ji,mkdirSync as Ee,appendFileSync as zi}from"node:fs";var Wi=["\\.env","auth","secret","credential","password","token","api[_-]?key","jwt","session","oauth","permission","\\.pem$","\\.key$","config.*prod"];function Vi(){let t=`${g()}/.claude/logs/multi-claude`;try{Ee(t,{recursive:!0})}catch{}return t}function D(t,e,n){let r=Vi(),i=new Date().toISOString().substring(0,10).replace(/-/g,""),s=`${r}/verifier_${i}.log`,o=new Date().toISOString();try{zi(s,`[${o}] [${t}] ${e}: ${n}
`)}catch{}}function Ki(t){for(let e of Wi)if(new RegExp(e,"i").test(t))return!0;return!1}function Pe(t){let e=new Date().toISOString(),n=g(),i=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",s=t.agent_output||t.output||"",o=[];if(i==="test-generator"&&(o.push({agent:"code-quality-reviewer",reason:"Test generation complete - quality review recommended"}),D(i,"TRIGGER","test-generator completion triggers code-quality-reviewer")),i==="frontend-ui-developer"&&/form|input|validation|submit|auth|login/i.test(s)&&(o.push({agent:"security-auditor",reason:"Frontend auth/form components - security review recommended"}),D(i,"TRIGGER","frontend auth components trigger security-auditor")),i==="backend-system-architect"&&/endpoint|route|api|auth|jwt|session/i.test(s)&&(o.push({agent:"security-auditor",reason:"Backend API endpoints - security review recommended"}),D(i,"TRIGGER","backend API endpoints trigger security-auditor")),Ki(s)&&(o.some(u=>u.agent==="security-auditor")||(o.push({agent:"security-auditor",reason:"Sensitive files modified - security review required"}),D(i,"TRIGGER","sensitive file patterns detected"))),i==="database-engineer"&&(o.push({agent:"code-quality-reviewer",reason:"Database schema changes - review for consistency"}),D(i,"TRIGGER","database changes trigger code-quality-reviewer")),i==="workflow-architect"&&(o.push({agent:"security-layer-auditor",reason:"LangGraph workflow created - layer audit recommended"}),D(i,"TRIGGER","workflow-architect triggers security-layer-auditor")),o.length>0){let a=`${n}/.claude/context/verification-queue`;try{Ee(a,{recursive:!0})}catch{}let u=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),d=`${a}/pending_${u}_${i}.json`,p={triggered_by:i,timestamp:e,verifications:o.map(f=>({agent:f.agent,reason:f.reason,status:"pending"}))};try{Ji(d,JSON.stringify(p,null,2))}catch{}let m="Multi-Claude Verification Triggered: "+o.map(f=>`${f.agent} (${f.reason})`).join("; ");return D(i,"QUEUE",`Created verification queue: ${d}`),{continue:!0,systemMessage:m}}return D(i,"SKIP","No verification triggers matched"),l()}import{writeFileSync as Qi,mkdirSync as Xi}from"node:fs";function Yi(){let t=`${g()}/.claude/logs/agent-validation`;try{Xi(t,{recursive:!0})}catch{}return t}function He(t){let e=process.env.CLAUDE_AGENT_NAME||"unknown",n=new Date().toISOString(),r=t.agent_output||t.output||"",i=[],s=[];r||i.push("Agent produced empty output");let o=r.length;if(o<50&&s.push(`Output seems very short (${o} chars)`),/error|failed|exception/i.test(r)&&s.push("Output contains error-related keywords"),e==="backend-system-architect"&&r.includes("{")){let k=r.match(/\{[^}]*\}/);if(k)try{JSON.parse(k[0])}catch{s.push("JSON structure may be malformed")}}let a=i.length>0?"failed":"passed",u=`Output Validation [${a}] - Agent: ${e}, Timestamp: ${n}, Output length: ${o} chars`;i.length>0&&(u+=" | Errors: "+i.join("; ")),s.length>0&&(u+=" | Warnings: "+s.join("; "));let d=Yi(),p=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),m=`${d}/${e}_${p}.log`,f=`=== OUTPUT VALIDATION ===
${u}

=== AGENT OUTPUT ===
${r}
`;try{Qi(m,f)}catch{}return a==="failed"?{continue:!1,systemMessage:u,hookSpecificOutput:{hookEventName:"SubagentStop"}}:{continue:!0,suppressOutput:!0,systemMessage:u}}import{existsSync as Zi,writeFileSync as ts,readFileSync as es}from"node:fs";var vt="/tmp/claude-session-metrics.json";function ns(){if(Zi(vt))try{let t=JSON.parse(es(vt,"utf8"));t.errors=(t.errors||0)+1,ts(vt,JSON.stringify(t,null,2))}catch{}}function Ne(t){let e=t.agent_id||"",n=t.subagent_type||"",r=t.error||"";return c("subagent-quality-gate",`Quality gate check: ${n} (${e})`),r&&r!=="null"?(c("subagent-quality-gate",`ERROR: Subagent failed - ${r}`),ns(),R(`Subagent ${n} failed: ${r}`)):l()}function rs(t){let e=t.error||t.tool_error,n=t.exit_code;if(e&&e!=="null"&&e!==""||n!==void 0&&n!==0)return!1;let r=t.agent_output||t.output||"",i=[/\bfailed\b/i,/\berror:\s/i,/\bexception\b/i,/\bcould not\b/i,/\bunable to\b/i],s=r.slice(0,500);for(let o of i)o.test(s)&&c("task-completer",`Warning: possible error in output: ${o}`);return!0}function je(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return c("task-completer","No agent type found, skipping"),l();c("task-completer",`Processing SubagentStop for: ${n}`);let r=T(n);if(!r)return c("task-completer",`No orchestration task found for agent: ${n}`),st(n),l();let i=rs(t),s=i?"completed":"failed";c("task-completer",`Agent ${n} completed with status: ${s}`),I(r.taskId,s),O(n,s);let o=`## Orchestration: Task ${i?"Completed":"Failed"}

Agent \`${n}\` has finished with status: **${s}**

${G({taskId:r.taskId,status:i?"completed":"pending"})}
`;if(i&&r.pipelineId&&r.pipelineStep!==void 0){let a=ye(r.pipelineId,r.pipelineStep);if(a!==null){let u=ht(r.pipelineId).filter(d=>d.pipelineStep===a&&d.status==="pending");u.length>0&&(o+=`
### Pipeline Progress

Pipeline \`${r.pipelineId}\` step ${r.pipelineStep} complete.
Next step (${a}) is now unblocked.

**Next agent(s) to spawn:**
${u.map(d=>`- \`${d.agent}\` (task: ${d.taskId})`).join(`
`)}

Consider spawning the next agent to continue the pipeline.`)}else o+=`
### Pipeline Complete

Pipeline \`${r.pipelineId}\` has completed all steps.`}if(!i){let a=t.error||t.tool_error||"Unknown error";o+=`
### Error Details

The agent encountered an issue:
\`\`\`
${a.slice(0,500)}
\`\`\`

Consider:
1. Retrying with more specific instructions
2. Using an alternative agent
3. Breaking down the task further`;let u=me(r.taskId);if(u.length>0){o+=`

### Orphaned Tasks (CC 2.1.20)

The following tasks were blocked by the failed task and should be deleted:
`;for(let d of u)o+=`
${pe(d.taskId,`Blocked by failed task ${r.taskId} (agent: ${n})`)}`,I(d.taskId,"failed")}}return s==="completed"&&st(n),c("task-completer",`Completed task ${r.taskId} with status ${s}`),A(o)}var It=new Map;function is(t,e){let n=It.get(t)||[];n.push(e),n.length>10&&n.shift(),It.set(t,n)}function ss(){let t=[];for(let[e,n]of It)n.some(r=>r.outcome==="failure")&&t.push(e);return t}function os(t){let e=t.error||t.tool_error,n=t.exit_code,r=t.agent_output||t.output||"";if(e&&e!=="null"&&e!=="")return{outcome:"failure",error:e};if(n!==void 0&&n!==0)return{outcome:"failure",error:`Exit code: ${n}`};let i=[/i cannot|i can't|i am unable/i,/outside my scope/i,/not appropriate/i,/i refuse/i];for(let o of i)if(o.test(r.slice(0,500)))return{outcome:"rejected",error:"Agent rejected the task"};let s=[/partial(?:ly)?/i,/incomplete/i,/some.*failed/i,/couldn't finish/i];for(let o of s)if(o.test(r.slice(0,500)))return{outcome:"partial"};return{outcome:"success"}}function Le(t){let n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!n)return l();let{outcome:r,error:i}=os(t);if(r==="success")return l();c("retry-handler",`Agent ${n} completed with outcome: ${r}`);let s=ot(),a=v().activeAgents.find(y=>y.agent===n),u=a?.retryCount||0,d=Gt(n,u+1,a?.taskId),p=Jt(d,r,i||void 0);is(n,p);let m=ss(),f=qt(n,u+1,i||"Unknown failure",m,s.maxRetries);if(c("retry-handler",`Retry decision for ${n}: shouldRetry=${f.shouldRetry}, alternative=${f.alternativeAgent||"none"}`),f.shouldRetry)O(n,"retrying");else{O(n,"failed");let y=T(n);y&&I(y.taskId,"failed")}let k=zt(f,n);return A(k)}import{existsSync as Ge,appendFileSync as hs,mkdirSync as ks,readFileSync as Ss,writeFileSync as bs}from"node:fs";import{existsSync as as,readFileSync as cs,writeFileSync as hc,mkdirSync as kc}from"node:fs";import{execSync as Me}from"node:child_process";import{createHash as us}from"node:crypto";import*as Fe from"node:os";var ds=".claude/.user_identity.json",gs="orchestkit-user-identity-v1";var b=null;function Q(t){return us("sha256").update(t+gs).digest("hex").slice(0,32)}function ls(){try{return Fe.hostname()}catch{return"unknown-machine"}}function ps(t){let e=`${t}/${ds}`;if(!as(e))return null;try{let n=cs(e,"utf8");return JSON.parse(n)}catch(n){return c("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function ms(t){let e={};try{e.email=Me("git config user.email",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{e.name=Me("git config user.name",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return e}function fs(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function ys(t){if(b)return b;let e=t||g(),n=ls(),r=ps(e);if(r?.user_id)return b={user_id:r.user_id,display_name:r.display_name||r.user_id,team_id:r.team_id,machine_id:n,source:"config",anonymous_id:Q(r.user_id),email:r.user_id.includes("@")?r.user_id:void 0},c("user-identity",`Resolved from config: ${b.anonymous_id}`,"debug"),b;let i=ms(e);if(i.email)return b={user_id:i.email,display_name:i.name||i.email.split("@")[0],team_id:r?.team_id,machine_id:n,source:"git",anonymous_id:Q(i.email),email:i.email},c("user-identity",`Resolved from git: ${b.anonymous_id}`,"debug"),b;let s=fs();if(s.username){let a=`${s.username}@${n}`;return b={user_id:a,display_name:s.username,team_id:r?.team_id,machine_id:n,source:"env",anonymous_id:Q(a)},c("user-identity",`Resolved from env: ${b.anonymous_id}`,"debug"),b}let o=Q(n+process.pid);return b={user_id:`anon-${o.slice(0,8)}`,display_name:"Anonymous",team_id:r?.team_id,machine_id:n,source:"anonymous",anonymous_id:o},c("user-identity",`Resolved as anonymous: ${b.anonymous_id}`,"debug"),b}function Ue(){let t=ys();return{session_id:h(),user_id:t.user_id,anonymous_id:t.anonymous_id,team_id:t.team_id,machine_id:t.machine_id,identity_source:t.source,timestamp:new Date().toISOString()}}var _s=/^[a-zA-Z0-9_-]{1,128}$/;function $s(t){return _s.test(t)}function At(t,e){let n=t||h(),r=e||g();if(!$s(n))throw new Error("Invalid session ID format");return`${r}/.claude/memory/sessions/${n}`}function vs(t,e){return`${At(t,e)}/events.jsonl`}function Je(t,e){let n=At(t,e);Ge(n)||ks(n,{recursive:!0})}var M=0,Be=!1,xt=!1,qe=0,Is=5e3;function ze(t,e){return`${At(t,e)}/counter.json`}function xs(t,e){if(!Be){Be=!0;try{let n=ze(t,e);if(Ge(n)){let r=JSON.parse(Ss(n,"utf8"));typeof r.counter=="number"&&r.counter>0&&(M=r.counter,c("session-tracker",`Loaded event counter: ${M}`,"debug"))}}catch{}}}function ws(t,e){if(!xt)return;let n=Date.now();if(!(n-qe<Is))try{Je(t,e);let r=ze(t,e);bs(r,JSON.stringify({counter:M,updated_at:new Date().toISOString()})),xt=!1,qe=n}catch{}}function As(){return xs(),M++,xt=!0,ws(),`evt-${Date.now()}-${M}`}function We(t,e,n={}){try{let r={event_id:As(),event_type:t,identity:Ue(),payload:{name:e,input:wt(n.input),output:wt(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?Ve(n.context,500):void 0,confidence:n.confidence}};Je();let i=vs();hs(i,JSON.stringify(r)+`
`),c("session-tracker",`Tracked ${t}: ${e}`,"debug")}catch(r){c("session-tracker",`Failed to track event: ${r}`,"warn")}}function Ve(t,e){return t.length<=e?t:t.slice(0,e-3)+"..."}function wt(t){if(!t)return;let e={},n=["password","secret","token","key","credential","auth"];for(let[r,i]of Object.entries(t)){if(n.some(s=>r.toLowerCase().includes(s))){e[r]="[REDACTED]";continue}if(typeof i=="string"&&i.length>500){e[r]=Ve(i,500);continue}if(typeof i=="object"&&i!==null&&!Array.isArray(i)){e[r]=wt(i);continue}e[r]=i}return e}var Ke=[{name:"context-publisher",fn:W},{name:"handoff-preparer",fn:K},{name:"feedback-loop",fn:V},{name:"agent-memory-store",fn:J}];function Ts(t){try{let e=t.subagent_type||t.agent_type||"unknown",n=!t.error,r=t.duration_ms,i=t.agent_output||t.output||"",s=typeof i=="string"?i.length:0;We("agent_spawned",e,{success:n,duration_ms:r,output:{has_output:s>0,output_length:s,has_error:!!t.error},context:t.agent_id})}catch{}}async function Qe(t){Ts(t);let n=(await Promise.allSettled(Ke.map(async r=>{try{let i=r.fn(t);return i instanceof Promise&&await i,{hook:r.name,status:"success"}}catch(i){let s=i instanceof Error?i.message:String(i);return c("subagent-stop-dispatcher",`${r.name} failed: ${s}`),{hook:r.name,status:"error",message:s}}}))).filter(r=>r.status==="rejected"||r.status==="fulfilled"&&r.value.status==="error");return n.length>0&&c("subagent-stop-dispatcher",`${n.length}/${Ke.length} hooks had errors`),l()}var Xe={"subagent-start/graph-memory-inject":te,"subagent-start/mem0-memory-inject":re,"subagent-start/context-gate":oe,"subagent-start/subagent-context-stager":ue,"subagent-start/subagent-validator":de,"subagent-start/task-linker":he,"subagent-start/model-cost-advisor":$e,"subagent-stop/agent-memory-store":J,"subagent-stop/auto-spawn-quality":xe,"subagent-stop/context-publisher":W,"subagent-stop/feedback-loop":V,"subagent-stop/handoff-preparer":K,"subagent-stop/multi-claude-verifier":Pe,"subagent-stop/output-validator":He,"subagent-stop/subagent-quality-gate":Ne,"subagent-stop/task-completer":je,"subagent-stop/retry-handler":Le,"subagent-stop/unified-dispatcher":Qe};function Yc(t){return Xe[t]}function Zc(){return Object.keys(Xe)}export{po as DEFAULT_CONFIG,lo as THRESHOLDS,vo as addToPromptHistory,Oo as analyzeAttemptHistory,Mo as applyDecay,xo as cacheClassification,Ln as calculateBackoffDelay,Do as cleanupOldStates,To as clearSessionState,Jt as completeAttempt,Gt as createAttempt,uo as escapeRegex,Dn as estimateTokenCount,zt as formatRetryDecision,ko as getActiveAgent,Fo as getAdjustments,Uo as getAgentSuccessRate,at as getAlternativeAgent,Qs as getCachedBranch,Bo as getCalibrationStats,Ks as getEnvFile,ao as getField,Yc as getHook,$o as getInjectedSkills,wo as getLastClassification,Ht as getLogDir,In as getLogLevel,et as getPluginRoot,g as getProjectDir,Io as getPromptHistory,h as getSessionId,qo as hasMinimalCalibrationData,Vn as hashPrompt,Xe as hooks,So as isAgentDispatched,Cs as isBashInput,Os as isEditInput,Es as isReadInput,Mn as isRetryableError,_o as isSkillInjected,Rs as isWriteInput,Zc as listHooks,N as loadCalibrationData,ot as loadConfig,v as loadState,c as logHook,io as logPermissionFeedback,qt as makeRetryDecision,co as normalizeCommand,Xs as normalizeLineEndings,eo as outputAllowWithContext,Zs as outputBlock,nt as outputDeny,no as outputError,wn as outputPromptContext,so as outputPromptContextBudgeted,Ys as outputSilentAllow,l as outputSilentSuccess,R as outputWarning,A as outputWithContext,to as outputWithNotification,ro as outputWithUpdatedInput,Eo as prepareForRetry,oo as readHookInput,Lo as recordOutcome,st as removeAgent,Wn as saveCalibrationData,Ao as saveConfig,Rn as saveState,xn as shouldLog,Fn as suggestsAlternative,ho as trackDispatchedAgent,bo as trackInjectedSkill,O as updateAgentStatus,E as updateState};
//# sourceMappingURL=subagent.mjs.map
