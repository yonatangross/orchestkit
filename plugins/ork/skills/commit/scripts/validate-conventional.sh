#!/bin/bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-02-14

# Validate Conventional Commit Message
# Checks commit messages against the Conventional Commits specification.
#
# Usage: ./validate-conventional.sh [OPTIONS]
#   echo "feat: add login" | ./validate-conventional.sh
#   ./validate-conventional.sh --message "feat: add login"
#
# Options:
#   --message MSG   Commit message to validate (alternative to stdin)
#   --help          Show this help message
#
# Exit codes:
#   0 = valid conventional commit
#   1 = invalid commit message
#   2 = usage error (no input provided)

set -euo pipefail

# =============================================================================
# CONFIGURATION
# =============================================================================

# Conventional commit types
VALID_TYPES="feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"

# Maximum subject line length
MAX_SUBJECT_LENGTH=72

MESSAGE=""

# =============================================================================
# ARGUMENT PARSING
# =============================================================================

while [[ $# -gt 0 ]]; do
    case "$1" in
        --message)
            if [[ -z "${2:-}" ]]; then
                echo "Error: --message requires a value" >&2
                exit 2
            fi
            MESSAGE="$2"
            shift 2
            ;;
        --help|-h)
            echo "Validate Conventional Commit Message"
            echo ""
            echo "Usage:"
            echo "  echo \"feat: add login\" | $0"
            echo "  $0 --message \"feat: add login\""
            echo ""
            echo "Options:"
            echo "  --message MSG   Commit message to validate"
            echo "  --help          Show this help message"
            echo ""
            echo "Valid types: ${VALID_TYPES//|/, }"
            echo ""
            echo "Exit codes:"
            echo "  0 = valid conventional commit"
            echo "  1 = invalid commit message"
            echo "  2 = usage error"
            exit 0
            ;;
        *)
            echo "Error: Unknown option '$1'. Use --help for usage." >&2
            exit 2
            ;;
    esac
done

# Read from stdin if no --message provided
if [[ -z "$MESSAGE" ]]; then
    if [[ -t 0 ]]; then
        echo "Error: No message provided. Use --message or pipe via stdin." >&2
        echo "Run '$0 --help' for usage." >&2
        exit 2
    fi
    MESSAGE=$(cat)
fi

if [[ -z "$MESSAGE" ]]; then
    echo "Error: Empty commit message" >&2
    exit 1
fi

# =============================================================================
# VALIDATION
# =============================================================================

ERRORS=()
SUBJECT_LINE=$(echo "$MESSAGE" | head -1)

# 1. Check type prefix
if ! echo "$SUBJECT_LINE" | grep -qE "^(${VALID_TYPES})(\(.+\))?!?:"; then
    ERRORS+=("Missing or invalid type prefix. Valid types: ${VALID_TYPES//|/, }")
fi

# 2. Check colon+space separator
if echo "$SUBJECT_LINE" | grep -qE "^(${VALID_TYPES})" && ! echo "$SUBJECT_LINE" | grep -qE "^(${VALID_TYPES})(\(.+\))?!?: .+"; then
    ERRORS+=("Must have a space after the colon (e.g., 'feat: description')")
fi

# 3. Check subject length
subject_text=$(echo "$SUBJECT_LINE" | sed -E "s/^(${VALID_TYPES})(\([^)]*\))?!?: //")
if [[ ${#SUBJECT_LINE} -gt $MAX_SUBJECT_LENGTH ]]; then
    ERRORS+=("Subject line too long (${#SUBJECT_LINE} > ${MAX_SUBJECT_LENGTH} chars)")
fi

# 4. Check for trailing period
if [[ "$SUBJECT_LINE" =~ \.$ ]]; then
    ERRORS+=("Subject line should not end with a period")
fi

# 5. Check for uppercase after colon (first letter of description)
if echo "$subject_text" | grep -qE "^[A-Z]"; then
    ERRORS+=("Description should start with lowercase letter")
fi

# 6. Check scope format (if present)
if echo "$SUBJECT_LINE" | grep -qE "^(${VALID_TYPES})\("; then
    scope=$(echo "$SUBJECT_LINE" | sed -E "s/^(${VALID_TYPES})\(([^)]*)\).*/\2/")
    if [[ -z "$scope" ]]; then
        ERRORS+=("Empty scope in parentheses")
    fi
fi

# 7. Check body format (blank line between subject and body)
line_count=$(echo "$MESSAGE" | wc -l | tr -d ' ')
if [[ "$line_count" -gt 1 ]]; then
    second_line=$(echo "$MESSAGE" | sed -n '2p')
    if [[ -n "$second_line" ]]; then
        ERRORS+=("Must have a blank line between subject and body")
    fi
fi

# =============================================================================
# OUTPUT
# =============================================================================

if [[ ${#ERRORS[@]} -eq 0 ]]; then
    echo "Valid conventional commit"
    exit 0
else
    echo "Invalid commit message:"
    for err in "${ERRORS[@]}"; do
        echo "  - $err"
    done
    exit 1
fi
