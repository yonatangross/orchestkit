#!/usr/bin/env bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-02-19

# pre-push-confirm.sh — Show what will be pushed and prompt for confirmation
#
# Usage: ./scripts/pre-push-confirm.sh
#
# Options:
#   --help    Show this help message
#   --dry-run Show summary without prompting

set -euo pipefail

if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
  echo "pre-push-confirm.sh — Summarize and confirm before git push --follow-tags"
  echo ""
  echo "Usage: ./scripts/pre-push-confirm.sh [--dry-run]"
  echo ""
  echo "Options:"
  echo "  --dry-run   Print summary without prompting"
  echo "  --help      Show this message"
  exit 0
fi

DRY_RUN=false
if [[ "${1:-}" == "--dry-run" ]]; then
  DRY_RUN=true
fi

# Gather info
BRANCH=$(git branch --show-current)
REMOTE="origin"
REMOTE_URL=$(git remote get-url "$REMOTE" 2>/dev/null || echo "(no remote)")

# Commits not yet pushed
UNPUSHED=$(git log "${REMOTE}/${BRANCH}"..HEAD --oneline 2>/dev/null || git log HEAD --oneline -5)

# Tags not yet pushed
UNPUSHED_TAGS=$(git tag --list | while read -r tag; do
  if ! git ls-remote --tags "$REMOTE" "$tag" 2>/dev/null | grep -q "$tag"; then
    echo "  $tag"
  fi
done)

echo "============================="
echo " Pre-Push Summary"
echo "============================="
echo "Branch : $BRANCH"
echo "Remote : $REMOTE ($REMOTE_URL)"
echo ""
echo "Commits to push:"
echo "$UNPUSHED" | sed 's/^/  /'
echo ""
echo "Tags to push:"
if [[ -z "$UNPUSHED_TAGS" ]]; then
  echo "  (none)"
else
  echo "$UNPUSHED_TAGS"
fi
echo "============================="

if [[ "$DRY_RUN" == "true" ]]; then
  echo "(dry-run — no push executed)"
  exit 0
fi

echo ""
read -r -p "Push commits and tags to $REMOTE/$BRANCH? [y/N] " CONFIRM
if [[ "$CONFIRM" =~ ^[Yy]$ ]]; then
  git push --follow-tags
  echo "[DONE] Pushed to $REMOTE/$BRANCH"
else
  echo "[CANCELLED] Push aborted."
  exit 1
fi
