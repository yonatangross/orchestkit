#!/bin/bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-02-14

# Scan Vulnerabilities
# Runs dependency and code vulnerability scanners with unified output.
#
# Usage: ./scan-vulnerabilities.sh [OPTIONS]
#
# Options:
#   --fix     Auto-apply safe patches where possible
#   --help    Show this help message
#
# Supported scanners (auto-detected):
#   - npm audit       (Node.js projects)
#   - pip-audit       (Python projects with pip)
#   - bandit          (Python static analysis)
#
# Exit codes:
#   0 = no vulnerabilities found
#   1 = vulnerabilities found
#   2 = usage error or no supported scanner found

set -euo pipefail

# =============================================================================
# CONFIGURATION
# =============================================================================

AUTO_FIX=""
VULN_FOUND=0

# =============================================================================
# ARGUMENT PARSING
# =============================================================================

while [[ $# -gt 0 ]]; do
    case "$1" in
        --fix)
            AUTO_FIX="true"
            shift
            ;;
        --help|-h)
            echo "Scan Vulnerabilities"
            echo ""
            echo "Usage: $0 [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --fix     Auto-apply safe patches where possible"
            echo "  --help    Show this help message"
            echo ""
            echo "Supported scanners (auto-detected):"
            echo "  - npm audit       Node.js dependency vulnerabilities"
            echo "  - pip-audit       Python dependency vulnerabilities"
            echo "  - bandit          Python static code analysis"
            echo ""
            echo "Exit codes:"
            echo "  0 = no vulnerabilities found"
            echo "  1 = vulnerabilities found"
            echo "  2 = usage error"
            exit 0
            ;;
        *)
            echo "Error: Unknown option '$1'. Use --help for usage." >&2
            exit 2
            ;;
    esac
done

# =============================================================================
# HELPERS
# =============================================================================

print_header() {
    echo ""
    echo "============================================================================"
    echo "  $1"
    echo "============================================================================"
}

print_separator() {
    printf "%-12s %-30s %s\n" "Severity" "Package" "Advisory"
    echo "----------------------------------------------------------------------------"
}

# =============================================================================
# SCANNER: npm audit
# =============================================================================

run_npm_audit() {
    if [[ ! -f "package-lock.json" && ! -f "yarn.lock" && ! -f "pnpm-lock.yaml" ]]; then
        return
    fi

    if ! command -v npm >/dev/null 2>&1; then
        echo "Warning: npm not found, skipping npm audit" >&2
        return
    fi

    print_header "npm audit"

    if [[ -n "$AUTO_FIX" ]]; then
        echo "Running npm audit fix..."
        npm audit fix 2>/dev/null || true
        echo ""
    fi

    local audit_output
    audit_output=$(npm audit --json 2>/dev/null || true)

    if [[ -z "$audit_output" ]]; then
        echo "  No vulnerabilities found"
        return
    fi

    local vuln_count
    vuln_count=$(echo "$audit_output" | python3 -c "
import json, sys
try:
    data = json.load(sys.stdin)
    vulns = data.get('vulnerabilities', {})
    count = 0
    for name, info in vulns.items():
        severity = info.get('severity', 'unknown').upper()
        via = info.get('via', [])
        advisory = ''
        for v in via:
            if isinstance(v, dict):
                advisory = v.get('title', v.get('url', ''))
                break
            elif isinstance(v, str):
                advisory = v
                break
        print(f'{severity:<12} {name:<30} {advisory}')
        count += 1
    if count == 0:
        print('  No vulnerabilities found')
    sys.exit(0)
except Exception as e:
    print(f'  Could not parse audit output: {e}', file=sys.stderr)
    sys.exit(0)
" 2>/dev/null) || true

    if [[ -n "$vuln_count" ]]; then
        print_separator
        echo "$vuln_count"
        if [[ "$vuln_count" != *"No vulnerabilities"* ]]; then
            VULN_FOUND=1
        fi
    else
        echo "  No vulnerabilities found"
    fi
}

# =============================================================================
# SCANNER: pip-audit
# =============================================================================

run_pip_audit() {
    if [[ ! -f "requirements.txt" && ! -f "pyproject.toml" && ! -f "setup.py" && ! -f "Pipfile" ]]; then
        return
    fi

    if ! command -v pip-audit >/dev/null 2>&1; then
        echo ""
        echo "Note: pip-audit not installed. Install with: pip install pip-audit" >&2
        return
    fi

    print_header "pip-audit"

    local -a pip_args=()
    [[ -n "$AUTO_FIX" ]] && pip_args+=(--fix)

    local audit_output
    audit_output=$(pip-audit "${pip_args[@]}" 2>/dev/null || true)

    if [[ -z "$audit_output" || "$audit_output" == *"No known vulnerabilities"* ]]; then
        echo "  No vulnerabilities found"
        return
    fi

    print_separator
    while IFS= read -r line; do
        if [[ -n "$line" && "$line" != "Name"* && "$line" != "---"* ]]; then
            echo "  $line"
            VULN_FOUND=1
        fi
    done <<< "$audit_output"
}

# =============================================================================
# SCANNER: bandit (Python static analysis)
# =============================================================================

run_bandit() {
    # Only run if there are Python files
    local py_count
    py_count=$(find . -maxdepth 3 -name "*.py" -not -path "*/node_modules/*" -not -path "*/.venv/*" 2>/dev/null | wc -l | tr -d ' ')

    if [[ "$py_count" -eq 0 ]]; then
        return
    fi

    if ! command -v bandit >/dev/null 2>&1; then
        echo ""
        echo "Note: bandit not installed. Install with: pip install bandit" >&2
        return
    fi

    print_header "bandit (static analysis)"

    local bandit_output
    bandit_output=$(bandit -r . -f json --exclude .venv,node_modules,__pycache__ 2>/dev/null || true)

    if [[ -z "$bandit_output" ]]; then
        echo "  No issues found"
        return
    fi

    local issue_count
    issue_count=$(echo "$bandit_output" | python3 -c "
import json, sys
try:
    data = json.load(sys.stdin)
    results = data.get('results', [])
    if not results:
        print('  No issues found')
        sys.exit(0)
    for r in results:
        severity = r.get('issue_severity', 'UNKNOWN').upper()
        filename = r.get('filename', '?')
        text = r.get('issue_text', '')
        print(f'{severity:<12} {filename:<30} {text}')
except Exception:
    print('  Could not parse bandit output')
" 2>/dev/null) || true

    if [[ -n "$issue_count" ]]; then
        print_separator
        echo "$issue_count"
        if [[ "$issue_count" != *"No issues"* ]]; then
            VULN_FOUND=1
        fi
    fi
}

# =============================================================================
# MAIN
# =============================================================================

echo "============================================================================"
echo "  Vulnerability Scanner"
echo "============================================================================"
echo ""
echo "Scanning: $(pwd)"

SCANNER_FOUND=0

# Run applicable scanners
if [[ -f "package-lock.json" || -f "yarn.lock" || -f "pnpm-lock.yaml" || -f "package.json" ]]; then
    SCANNER_FOUND=1
    run_npm_audit
fi

if [[ -f "requirements.txt" || -f "pyproject.toml" || -f "setup.py" || -f "Pipfile" ]]; then
    SCANNER_FOUND=1
    run_pip_audit
    run_bandit
fi

if [[ $SCANNER_FOUND -eq 0 ]]; then
    echo ""
    echo "Error: No supported project type detected." >&2
    echo "Supported: package.json (npm), requirements.txt/pyproject.toml (pip)" >&2
    exit 2
fi

echo ""
echo "============================================================================"
if [[ $VULN_FOUND -eq 1 ]]; then
    echo "  Vulnerabilities found - review above"
    echo "============================================================================"
    exit 1
else
    echo "  No vulnerabilities found"
    echo "============================================================================"
    exit 0
fi
