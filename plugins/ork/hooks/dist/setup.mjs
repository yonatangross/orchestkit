// OrchestKit Hooks - setup bundle
// Generated: 2026-02-18T09:18:41.286Z

function sn(t){return typeof t.command=="string"}function cn(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function an(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function un(t){return typeof t.file_path=="string"&&t.content===void 0}import{existsSync as dt,statSync as oe,renameSync as re,mkdirSync as se,readSync as ie}from"node:fs";import{appendFileSync as At,mkdirSync as Mt}from"node:fs";import{dirname as Lt}from"node:path";var w=[],W=!1,it=!1;function K(t,e){w.push({filePath:t,content:e}),Ft()}function V(){if(W||w.length===0)return;W=!0;let t=new Map;for(let e of w){let n=t.get(e.filePath);n?n.push(e.content):t.set(e.filePath,[e.content])}for(let[e,n]of t)try{Mt(Lt(e),{recursive:!0}),At(e,n.join(""))}catch{}w.length=0,W=!1}function Ft(){it||(it=!0,process.on("exit",V),process.on("SIGTERM",()=>{V(),process.exit(0)}),process.on("SIGINT",()=>{V(),process.exit(0)}))}import{execSync as ce}from"node:child_process";import ct from"node:os";import H from"node:path";function J(){return process.env.HOME||process.env.USERPROFILE||ct.homedir()}function at(){return ct.tmpdir()}function q(){return process.env.CLAUDE_PROJECT_DIR||"."}function ut(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function pt(){return process.env.CLAUDE_PLUGIN_ROOT?H.join(J(),".claude","logs","ork"):H.join(q(),".claude","logs")}var hn=H.join,kn=H.sep;import{execSync as jt}from"node:child_process";import{createHash as Ut}from"node:crypto";import{existsSync as lt,readFileSync as Wt,writeFileSync as Vt,mkdirSync as Kt}from"node:fs";import{join as B,basename as Jt}from"node:path";var qt=20,Bt=15,zt=/[^a-z0-9-]/g;function Gt(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=Jt(e);return ft(n,qt)}function Xt(t){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=jt("git branch --show-current",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),o=ft(n||"detached",Bt);return process.env.ORCHESTKIT_SESSION_BRANCH=o,o}catch{return"nobranch"}}function Zt(t){let e=t||new Date,n=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${n}${o}`}function Yt(t){let e=t||new Date,n=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0");return`${n}${o}`}function Qt(){let t=`${process.pid}-${Date.now()}-${Math.random()}`;return Ut("sha256").update(t).digest("hex").slice(0,4)}function ft(t,e){return t.toLowerCase().replace(zt,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,e)}function te(t,e){let n=Gt(t),o=Xt(t),r=Zt(e),i=Yt(e),c=Qt();return`${n}-${o}-${r}-${i}-${c}`}function ee(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=B(e,".instance","session-id.json");if(lt(n))try{let o=JSON.parse(Wt(n,"utf8"));if(o.session_id&&o.created_at){let r=Date.now()-new Date(o.created_at).getTime(),i=1440*60*1e3;if(r<i)return o.session_id}}catch{}}function ne(t,e){let n=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),o=B(n,".instance"),r=B(o,"session-id.json");try{lt(o)||Kt(o,{recursive:!0}),Vt(r,JSON.stringify({session_id:t,created_at:new Date().toISOString()},null,2))}catch{}}function gt(t){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let e=ee(t);if(e)return e;let n=te(t);return ne(n,t),n}function mt(){return pt()}function C(){return q()}function y(){return ut()}function In(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${y()}/.claude/.instance_env`}function z(){return gt()}function On(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let e=ce("git branch --show-current",{cwd:t||C(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function ae(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Tn(t){return t.replace(/\r\n/g,`
`)}function ue(t){let e=["debug","info","warn","error"];return e.indexOf(t)>=e.indexOf(ae())}function g(){return{continue:!0,suppressOutput:!0}}function wn(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function Hn(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function m(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function pe(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function Pn(t,e){let n={continue:!0,suppressOutput:!0};return t&&(n.systemMessage=t),e&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:e}),n}function Nn(t,e){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?n.systemMessage=e:n.suppressOutput=!0,n}function An(t){return{continue:!0,systemMessage:t}}function Mn(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function Ln(t){process.stderr.write(`\u26A0 ${t}
`),process.exit(2)}function Fn(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}function jn(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:t}}}var le=200*1024,fe=100*1024;function ht(t,e){if(dt(t))try{if(oe(t).size>e){let o=`${t}.old.${Date.now()}`;re(t,o)}}catch{}}function kt(t){dt(t)||se(t,{recursive:!0})}function s(t,e,n="debug"){if(!ue(n))return;let o=mt(),r=`${o}/hooks.log`;try{kt(o),ht(r,le);let i=new Date().toISOString().replace("T"," ").slice(0,19);K(r,`[${i}] [${n.toUpperCase()}] [${t}] ${e}
`)}catch{}}function Un(t,e,n){let o=mt(),r=`${o}/permission-feedback.log`;try{kt(o),ht(r,fe);let i=new Date().toISOString(),c=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",a=n?.session_id||z();K(r,`${i} | ${t} | ${e} | tool=${c} | session=${a}
`)}catch{}}function ge(t){if(!t)return 0;let o=(t.match(/[{};()=><]/g)||[]).length/t.length>.03?2.8:3.5;return Math.ceil(t.length/o)}function Wn(t,e,n,o,r){let i=ge(t);return o&&o.isOverBudget(n)?(s(e,`Budget exhausted for ${n}, suppressing ${i}t`),g()):(r&&r.trackTokenUsage(e,n,i),pe(t))}function Vn(){try{let t=[],n=Buffer.allocUnsafe(256),o,r=0;for(;;)try{if(o=ie(r,n,0,256,null),o===0)break;t.push(Buffer.from(n.subarray(0,o)))}catch{break}let i=Buffer.concat(t).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:z(),tool_input:{}}}catch{return{tool_name:"",session_id:z(),tool_input:{}}}}function Kn(t,e){let n=e.replace(/^\./,"").split("."),o=t;for(let r of n){if(o==null)return;o=o[r]}return o}function Jn(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function qn(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}import{existsSync as _,readFileSync as X,writeFileSync as de,mkdirSync as me}from"node:fs";var he=[{package:"lodash",pattern:"<4.17.21",severity:"high",cve:"CVE-2021-23337",description:"Prototype pollution"},{package:"minimist",pattern:"<1.2.6",severity:"critical",cve:"CVE-2021-44906",description:"Prototype pollution"},{package:"node-fetch",pattern:"<2.6.7",severity:"high",cve:"CVE-2022-0235",description:"Information exposure"},{package:"axios",pattern:"<0.21.2",severity:"high",cve:"CVE-2021-3749",description:"ReDoS vulnerability"},{package:"jsonwebtoken",pattern:"<9.0.0",severity:"critical",cve:"CVE-2022-23529",description:"Insecure token verification"},{package:"express",pattern:"<4.17.3",severity:"medium",cve:"CVE-2022-24999",description:"Open redirect"},{package:"tar",pattern:"<6.1.11",severity:"critical",cve:"CVE-2021-37701",description:"Arbitrary file overwrite"},{package:"path-parse",pattern:"<1.0.7",severity:"medium",cve:"CVE-2021-23343",description:"ReDoS vulnerability"},{package:"django",pattern:"<3.2.14",severity:"high",cve:"CVE-2022-34265",description:"SQL injection"},{package:"flask",pattern:"<2.0.2",severity:"medium",cve:"CVE-2021-28091",description:"Path traversal"},{package:"requests",pattern:"<2.28.0",severity:"medium",cve:"CVE-2023-32681",description:"Information disclosure"},{package:"urllib3",pattern:"<1.26.5",severity:"high",cve:"CVE-2021-33503",description:"ReDoS vulnerability"},{package:"pillow",pattern:"<9.0.0",severity:"high",cve:"CVE-2022-22817",description:"Buffer overflow"},{package:"pyyaml",pattern:"<5.4",severity:"critical",cve:"CVE-2020-14343",description:"Arbitrary code execution"},{package:"jinja2",pattern:"<3.0.3",severity:"medium",cve:"CVE-2020-28493",description:"XSS vulnerability"},{package:"sqlalchemy",pattern:"<1.4.46",severity:"medium",cve:"CVE-2023-30533",description:"SQL injection"}],ke=24;function ye(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Se(t,e){let n=t.split(".").map(r=>parseInt(r,10)||0),o=e.split(".").map(r=>parseInt(r,10)||0);for(let r=0;r<Math.max(n.length,o.length);r++){let i=n[r]||0,c=o[r]||0;if(i<c)return!0;if(i>c)return!1}return!1}function ve(t,e){let n=e.charAt(0),o=e.substring(1);return n==="<"?Se(t,o):n==="="?t===o:!1}function $e(t){return t.replace(/^[^~>=<]/,"").replace(/,.*$/,"").trim()}function yt(t,e){let n=$e(e),o=t.toLowerCase();for(let r of he)if(o===r.package&&ve(n,r.pattern))return r;return null}function Ee(t){if(!_(t))return null;try{let e=JSON.parse(X(t,"utf-8"));if((Date.now()-e.timestamp)/(1e3*60*60)<ke)return e.warnings}catch{}return null}function G(t,e){try{me(t.replace(/\/[^/]+$/,""),{recursive:!0});let n={warnings:e,timestamp:Date.now()};de(t,JSON.stringify(n,null,2))}catch{}}function Ce(t){let e=0,n=0,o="";if(!_(t))return{criticalCount:e,highCount:n,warnings:o};try{let r=JSON.parse(X(t,"utf-8")),i={...r.dependencies,...r.devDependencies};for(let[c,a]of Object.entries(i)){let u=yt(c,a);u&&(u.severity==="critical"&&e++,u.severity==="high"&&n++,o+=`
- ${c}@${a}: ${u.description} (${u.cve}, ${u.severity}) - upgrade to ${u.pattern}`)}}catch{}return{criticalCount:e,highCount:n,warnings:o}}function _e(t){let e=0,n=0,o="";if(!_(t))return{criticalCount:e,highCount:n,warnings:o};try{let i=X(t,"utf-8").split(`
`);for(let c of i){let a=c.trim();if(!a||a.startsWith("#"))continue;let u=a.match(/^([a-zA-Z0-9_-]+)(?:==|>=|~=|!=|<|>)\s*([0-9.]+)/);if(!u)continue;let[,l,f]=u,p=yt(l,f);p&&(p.severity==="critical"&&e++,p.severity==="high"&&n++,o+=`
- ${l}==${f}: ${p.description} (${p.cve}, ${p.severity}) - upgrade to ${p.pattern}`)}}catch{}return{criticalCount:e,highCount:n,warnings:o}}function St(t){if(ye())return s("dependency-version-check","Skipping dependency check (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),g();s("dependency-version-check","Starting dependency version check");let e=t.project_dir||C(),n=`${e}/.claude/feedback/dependency-check-cache.json`,o=_(`${e}/package.json`),r=_(`${e}/requirements.txt`),i=_(`${e}/pyproject.toml`),c=_(`${e}/go.mod`);if(!o&&!r&&!i&&!c)return s("dependency-version-check","No package files found, skipping check"),G(n,"none"),g();let a=Ee(n);if(a!==null)return s("dependency-version-check","Using cached dependency warnings"),a!=="none"?m(`DEPENDENCY SECURITY CHECK (cached): ${a}`):g();let u=0,l=0,f="";if(o){let p=Ce(`${e}/package.json`);u+=p.criticalCount,l+=p.highCount,p.warnings&&(f+=`

Node.js (package.json):${p.warnings}`)}if(r){let p=_e(`${e}/requirements.txt`);u+=p.criticalCount,l+=p.highCount,p.warnings&&(f+=`

Python (requirements.txt):${p.warnings}`)}if(f){let p=`Found ${u} critical and ${l} high severity vulnerabilities`,d=`DEPENDENCY SECURITY CHECK: ${p}${f}

Run 'npm audit' or 'pip-audit' for full details.`;if(G(n,d),s("dependency-version-check",p),u>0||l>0)return m(d)}else G(n,"none"),s("dependency-version-check","No known vulnerabilities found");return g()}var P=[{name:"dependency-version-check",fn:St}];async function vt(t){s("setup-dispatcher",`Running ${P.length} Setup hooks in parallel`);let e=await Promise.allSettled(P.map(async o=>{try{let r=o.fn(t);return r instanceof Promise&&await r,{hook:o.name,status:"success"}}catch(r){let i=r instanceof Error?r.message:String(r);return s("setup-dispatcher",`${o.name} failed: ${i}`),{hook:o.name,status:"error",message:i}}})),n=[];for(let o of e)o.status==="rejected"?n.push("unknown"):o.value.status==="error"&&n.push(o.value.hook);return n.length>0?s("setup-dispatcher",`${n.length}/${P.length} hooks failed: ${n.join(", ")}`):s("setup-dispatcher",`All ${P.length} Setup hooks completed successfully`),g()}import{existsSync as $t,mkdirSync as De,writeFileSync as Et,readdirSync as Y,chmodSync as xe}from"node:fs";import{execSync as v}from"node:child_process";var Z="4.25.0";function Re(){s("first-run-setup","Phase 1: Detecting environment");let t={os:process.platform};try{let n=v("python3 --version",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}).match(/(\d+\.\d+)/);n&&(t.python=n[1],s("first-run-setup",`Python: ${n[1]}`))}catch{}try{let n=v("node --version",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}).match(/(\d+\.\d+)/);n&&(t.nodejs=n[1],s("first-run-setup",`Node.js: ${n[1]}`))}catch{}try{v("which git",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),t.git=!0,s("first-run-setup","Git: available")}catch{}try{v("which docker",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),t.docker=!0,s("first-run-setup","Docker: available")}catch{}try{v("which sqlite3",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),t.sqlite3=!0,s("first-run-setup","SQLite3: available (multi-instance coordination enabled)")}catch{}return t}function be(){s("first-run-setup","Phase 2: Validating dependencies");let t=[],e=[];try{v("which jq",{encoding:"utf8",stdio:["pipe","pipe","pipe"]})}catch{t.push("jq (required for JSON processing)")}try{v("which sqlite3",{encoding:"utf8",stdio:["pipe","pipe","pipe"]})}catch{e.push("sqlite3 not found - multi-instance coordination disabled")}try{v('python3 -c "import anthropic"',{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),s("first-run-setup","Anthropic SDK: available (Memory Fabric Agent enabled)")}catch{e.push("anthropic SDK not found - Memory Fabric Agent will use fallback mode"),e.push("  Install with: pip install 'orchestkit[memory]'")}if(t.length>0){s("first-run-setup","ERROR: Missing required dependencies:");for(let n of t)s("first-run-setup",`  - ${n}`)}for(let n of e)s("first-run-setup",`WARN: ${n}`);return{valid:t.length===0,missing:t,warnings:e}}function Ie(t){let e={complete:{preset:"complete",description:"Full AI-assisted development toolkit",features:{skills:!0,agents:!0,hooks:!0,mcp:!0,coordination:!0,statusline:!0},hook_groups:{safety:!0,quality:!0,productivity:!0,observability:!0}},standard:{preset:"standard",description:"Skills and hooks without agent orchestration",features:{skills:!0,agents:!1,hooks:!0,mcp:!0,coordination:!0,statusline:!0},hook_groups:{safety:!0,quality:!0,productivity:!0,observability:!0}},lite:{preset:"lite",description:"Essential skills for constrained environments",features:{skills:!0,agents:!1,hooks:!0,mcp:!1,coordination:!1,statusline:!1},hook_groups:{safety:!0,quality:!0,productivity:!1,observability:!1}},"hooks-only":{preset:"hooks-only",description:"Safety hooks only for pure automation",features:{skills:!1,agents:!1,hooks:!0,mcp:!1,coordination:!1,statusline:!1},hook_groups:{safety:!0,quality:!1,productivity:!1,observability:!1}}};return e[t]||e.complete}function Oe(t,e,n){s("first-run-setup",`Phase 4: Applying configuration (preset: ${t})`);let o=Ie(t),r=[`${n}/.claude/defaults`,`${n}/.claude/context/session`,`${n}/.claude/context/knowledge`,`${n}/.claude/logs`];for(let c of r)try{De(c,{recursive:!0})}catch{}let i=`${n}/.claude/defaults/config.json`;$t(i)||(Et(i,JSON.stringify(o,null,2)),s("first-run-setup",`Created config file: ${i}`));try{let c=`${n}/hooks`;if($t(c)){let a=u=>{try{let l=Y(u,{withFileTypes:!0});for(let f of l){let p=`${u}/${f.name}`;if(f.isDirectory())a(p);else if(f.name.endsWith(".sh"))try{xe(p,493)}catch{}}}catch{}};a(c),s("first-run-setup","Made hooks executable")}}catch{}return o}function Te(t,e,n){s("first-run-setup","Phase 5: Creating marker file");let o=new Date().toISOString(),r=0,i=0,c=0;try{let l=(f,p)=>{let d=0,E=S=>{try{let R=Y(S,{withFileTypes:!0});for(let h of R){let O=`${S}/${h.name}`;h.isDirectory()?E(O):p.test(h.name)&&d++}}catch{}};return E(f),d};r=l(`${n}/hooks`,/\.sh$/),i=l(`${n}/skills`,/SKILL\.md$/),c=l(`${n}/agents`,/\.md$/)}catch{}let a={version:Z,setup_date:o,preset:t,components:{hooks:{count:r,valid:!0},skills:{count:i,valid:!0},agents:{count:c,valid:!0}},last_health_check:o,last_maintenance:o,environment:e,user_preferences:{onboarding_completed:!0,mcp_configured:!1,statusline_configured:!1}},u=`${n}/.setup-complete`;Et(u,JSON.stringify(a,null,2)),s("first-run-setup",`Marker file created: ${u}`)}function Ct(t){let e=y(),n=process.argv.includes("--silent")?"silent":"interactive";s("first-run-setup",`First-run setup starting (mode: ${n})`);let o=Re(),{valid:r,missing:i}=be();if(!r){s("first-run-setup","ERROR: Dependency validation failed");let p=`OrchestKit setup failed: Missing required dependencies. Install ${i.join(", ")}.`;return m(p)}let c="complete";n==="interactive"?s("first-run-setup","Interactive mode - using complete preset (wizard via Claude conversation)"):s("first-run-setup","Silent mode - using complete preset"),Oe(c,o,e),Te(c,o,e);let a=0,u=0,l=0;try{let p=(d,E)=>{let S=0,R=h=>{try{let O=Y(h,{withFileTypes:!0});for(let U of O){let Nt=`${h}/${U.name}`;U.isDirectory()?R(Nt):E.test(U.name)&&S++}}catch{}};return R(d),S};a=p(`${e}/hooks`,/\.sh$/),u=p(`${e}/skills`,/SKILL\.md$/),l=p(`${e}/agents`,/\.md$/)}catch{}s("first-run-setup",`Setup complete: ${u} skills, ${l} agents, ${a} hooks`);let f=n==="interactive"?`OrchestKit v${Z} setup complete! Loaded ${u} skills, ${l} agents, and ${a} hooks. Use /ork:configure to customize settings.`:`OrchestKit v${Z} initialized (silent mode).`;return m(f)}import{existsSync as Q,readdirSync as _t}from"node:fs";var we=["pnpm-workspace.yaml","lerna.json","nx.json","turbo.json","rush.json"];function He(t){let e=0;try{let n=_t(t,{withFileTypes:!0});for(let o of n){if(!o.isDirectory()||o.name.startsWith(".")||o.name==="node_modules")continue;let r=`${t}/${o.name}`;Q(`${r}/package.json`)&&e++;try{let i=_t(r,{withFileTypes:!0});for(let c of i)!c.isDirectory()||c.name.startsWith(".")||c.name==="node_modules"||Q(`${r}/${c.name}/package.json`)&&e++}catch{}}}catch{}return e}function Dt(t){if(s("monorepo-detector","Checking for monorepo structure"),process.env.CLAUDE_CODE_ADDITIONAL_DIRECTORIES_CLAUDE_MD==="1")return s("monorepo-detector","CLAUDE_CODE_ADDITIONAL_DIRECTORIES_CLAUDE_MD already set, skipping"),g();let e=t.project_dir||C(),n=[];for(let c of we)Q(`${e}/${c}`)&&n.push(c);let o=He(e);if(!(n.length>0||o>=3))return s("monorepo-detector","No monorepo detected"),g();let i=n.length>0?`Detected: ${n.join(", ")}`:`Found ${o} nested packages`;return s("monorepo-detector",`Monorepo detected: ${i}`),m(`**Monorepo Detected** (${i})

CC 2.1.20 supports multi-directory context with \`--add-dir\`. Each service can have its own CLAUDE.md for targeted instructions.

Set \`CLAUDE_CODE_ADDITIONAL_DIRECTORIES_CLAUDE_MD=1\` to auto-load CLAUDE.md from added directories.`)}import{existsSync as $,readFileSync as et,readdirSync as Pe,writeFileSync as Ne}from"node:fs";import{spawn as tt}from"node:child_process";var T="4.25.0";function xt(t,e){if(!$(t))return null;try{let n=JSON.parse(et(t,"utf-8")),o=e.split("."),r=n;for(let i of o){if(r==null)return null;r=r[i]}return r}catch{return null}}function Ae(t){let e=0,n=`${t}/.claude/defaults/config.json`;if($(n))try{JSON.parse(et(n,"utf-8"))}catch{s("setup-check","WARN: config.json is invalid JSON"),e++}let o=0;if($(`${t}/hooks`))try{let c=(a,u=0)=>{if(u>3)return 0;let l=0;try{let f=Pe(a,{withFileTypes:!0});for(let p of f.slice(0,100)){let d=`${a}/${p.name}`;p.isDirectory()&&!p.name.startsWith(".")?l+=c(d,u+1):p.name.endsWith(".sh")&&l++}}catch{}return l};o=c(`${t}/hooks`)}catch{}o<10&&s("setup-check",`WARN: Only ${o} hooks found (expected 50+)`);let r=`${t}/.setup-complete`,i=xt(r,"version");return i&&i!==T?(s("setup-check",`INFO: Version mismatch - marker: ${i}, current: ${T}`),2):e}function Me(t){let e=xt(t,"last_maintenance");if(!e)return!0;try{let n=new Date(e).getTime();return(Date.now()-n)/(1e3*60*60)>=24}catch{return!0}}function Le(t,e,n){if($(t))try{let o=JSON.parse(et(t,"utf-8"));o[e]=n,Ne(t,JSON.stringify(o,null,2))}catch{}}function Rt(t){if(process.env.ORCHESTKIT_SKIP_SETUP==="1"||process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1")return g();let e=y(),n=`${e}/.setup-complete`,o=`${e}/hooks/setup`;s("setup-check",`Setup check starting (v${T})`);let r=process.argv;if(r.includes("--init")||r.includes("init"))return s("setup-check","Explicit --init: Running full setup"),{continue:!0,systemMessage:"Running first-run setup..."};if(r.includes("--init-only")||r.includes("init-only"))return s("setup-check","CI/CD mode (--init-only): Running silent setup"),{continue:!0,systemMessage:"Running silent setup..."};if(r.includes("--maintenance")||r.includes("maintenance"))return s("setup-check","Explicit --maintenance: Running maintenance tasks"),{continue:!0,systemMessage:"Running maintenance tasks..."};if(!$(n))return s("setup-check","No marker file found - first run detected"),(t.hook_event||process.env.HOOK_EVENT)==="Setup"?{continue:!0,systemMessage:"First run detected. Running setup..."}:m("OrchestKit setup not complete. Run 'claude --init' to configure the plugin.");switch(s("setup-check","Marker file exists - running quick validation"),Ae(e)){case 0:if(Me(n)){s("setup-check","Maintenance due - queueing background tasks");let u=`${o}/setup-maintenance.sh`;$(u)&&tt(u,["--background"],{detached:!0,stdio:"ignore"}).unref()}return s("setup-check","Setup check passed (fast path)"),g();case 1:s("setup-check","Validation failed - triggering self-healing repair");let c=`${o}/setup-repair.sh`;return $(c)&&tt(c,[],{detached:!0,stdio:"ignore"}).unref(),m("OrchestKit setup validation failed. Repair running in background.");case 2:s("setup-check","Version mismatch - running migration");let a=`${o}/setup-maintenance.sh`;return $(a)&&tt(a,["--migrate"],{detached:!0,stdio:"ignore"}).unref(),Le(n,"version",T),m(`OrchestKit upgraded to v${T}.`);default:return g()}}import{existsSync as D,mkdirSync as Fe,readFileSync as nt,writeFileSync as je,renameSync as bt,readdirSync as b,unlinkSync as ot,statSync as I,chmodSync as Ue}from"node:fs";import{execSync as M}from"node:child_process";function N(){return!!(process.env.CLAUDE_CODE_TEAM_NAME||process.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS==="1")}var A="4.25.0",k=[];function It(t,e){if(!D(t))return null;try{return JSON.parse(nt(t,"utf-8"))[e.replace(/^\./,"")]}catch{return null}}function rt(t,e,n){if(D(t))try{let o=JSON.parse(nt(t,"utf-8"));o[e.replace(/^\./,"")]=n,je(t,JSON.stringify(o,null,2))}catch{}}function We(t){if(!t)return 999;try{let e=new Date(t).getTime();return(Date.now()-e)/(1e3*60*60)}catch{return 999}}function Ve(t){s("setup-maintenance","Task: Log rotation");let e=[`${t}/.claude/logs`,`${J()}/.claude/logs/ork`],n=0;for(let o of e)if(D(o))try{let r=b(o);for(let c of r){if(!c.endsWith(".log"))continue;let a=`${o}/${c}`;try{if(I(a).size>204800){let l=`${a}.old.${Date.now()}`;bt(a,l),n++;try{M(`gzip "${l}"`,{stdio:["pipe","pipe","pipe"]})}catch{}}}catch{}}let i=r.filter(c=>c.includes(".log.old.")).sort().reverse();for(let c of i.slice(5))try{ot(`${o}/${c}`)}catch{}}catch{}n>0&&k.push(`Rotated ${n} log files`)}function Ke(t){s("setup-maintenance","Task: Stale lock cleanup");let e=`${t}/.claude/coordination/.claude.db`,n=0;if(D(e)&&!N())try{M(`sqlite3 "${e}" "DELETE FROM file_locks WHERE datetime(acquired_at) < datetime('now', '-24 hours');"`,{timeout:5e3,stdio:["pipe","pipe","pipe"]});let o=M(`sqlite3 "${e}" "SELECT COUNT(*) FROM file_locks;"`,{encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();s("setup-maintenance",`Coordination locks remaining: ${o}`),n=1}catch{}try{let o=(r,i=0)=>{if(!(i>3))try{let c=b(r,{withFileTypes:!0});for(let a of c){let u=`${r}/${a.name}`;if(a.isDirectory()&&!a.name.startsWith("."))o(u,i+1);else if(a.name.endsWith(".lock"))try{let l=I(u);(Date.now()-l.mtimeMs)/(1e3*60*60)>24&&(ot(u),n++)}catch{}}}catch{}};o(t)}catch{}n>0&&k.push("Cleaned stale locks")}function Je(t){s("setup-maintenance","Task: Session cleanup");let e=`${t}/.claude/context/sessions`,n=`${t}/.claude/context/archive`;if(!D(e))return;let o=0;try{Fe(n,{recursive:!0});let i=b(e,{withFileTypes:!0});for(let c of i){if(!c.isDirectory())continue;let a=`${e}/${c.name}`;try{let u=I(a);(Date.now()-u.mtimeMs)/(1e3*60*60*24)>7&&(bt(a,`${n}/${c.name}`),o++)}catch{}}}catch{}let r=at();try{let i=b(r);for(let c of i){if(!c.startsWith("claude-session-"))continue;let a=`${r}/${c}`;try{let u=I(a);(Date.now()-u.mtimeMs)/(1e3*60*60*24)>7&&u.isDirectory()&&M(`rm -rf "${a}"`,{stdio:["pipe","pipe","pipe"]})}catch{}}}catch{}o>0&&k.push(`Archived ${o} old sessions`)}function qe(t){s("setup-maintenance","Task: Memory Fabric cleanup");let e=0,n=`${t}/.claude/logs`;if(D(n))try{let o=b(n);for(let r of o){if(!r.startsWith(".pending-sync-"))continue;let i=`${n}/${r}`;try{let c=I(i);(Date.now()-c.mtimeMs)/(1e3*60*60*24)>7&&(ot(i),e++)}catch{}}}catch{}e>0&&k.push(`Cleaned ${e} Memory Fabric files`)}function Be(t,e){s("setup-maintenance","Task: Full health validation");let n=0,o=0,r=(c,a=0)=>{if(!(a>4))try{let u=b(c,{withFileTypes:!0});for(let l of u){let f=`${c}/${l.name}`;if(l.isDirectory()&&!l.name.startsWith("."))r(f,a+1);else if(l.name.endsWith(".sh"))try{I(f).mode&73||(Ue(f,493),o++)}catch{}}}catch{}};r(`${t}/hooks`),o>0&&(s("setup-maintenance",`WARN: ${o} hooks were not executable`),n++);let i=`${t}/.claude/defaults/config.json`;if(D(i))try{JSON.parse(nt(i,"utf-8"))}catch{s("setup-maintenance","WARN: config.json is invalid"),n++}rt(e,"last_health_check",new Date().toISOString()),n===0?k.push("Health validation passed"):k.push(`Health validation found ${n} issues (auto-fixed)`)}function ze(t){s("setup-maintenance","Task: Version migration");let e=It(t,"version");!e||e===A||(s("setup-maintenance",`Migrating from ${e} to ${A}`),rt(t,"version",A),k.push(`Migrated from ${e} to ${A}`))}function Ot(t){let e=y(),n=t.project_dir||C(),o=`${e}/.setup-complete`,r=process.argv,i="auto";r.includes("--force")?i="force":r.includes("--migrate")?i="migrate":r.includes("--background")&&(i="background"),s("setup-maintenance",`Maintenance starting (mode: ${i})`);let c=new Date().toISOString(),a=It(o,"last_maintenance"),u=We(a),l=!1,f=!1;switch(i){case"force":l=!0,f=!0;break;case"migrate":ze(o);break;case"background":case"auto":u>=24&&(l=!0),u>=168&&(f=!0);break}if(l&&(s("setup-maintenance","Running daily maintenance tasks"),Ve(e),Ke(e),Je(e),qe(n)),f&&(s("setup-maintenance","Running weekly maintenance tasks"),Be(e,o)),rt(o,"last_maintenance",c),k.length>0){s("setup-maintenance",`Maintenance complete: ${k.length} tasks`);let p=`Completed: ${k.join(", ")}`;return i==="background"?g():m(`Maintenance: ${p}`)}return s("setup-maintenance","No maintenance tasks needed"),g()}import{existsSync as st,mkdirSync as Tt,readFileSync as Ge,writeFileSync as wt,renameSync as Xe,readdirSync as F,statSync as Ze,chmodSync as Ye}from"node:fs";var Qe="4.25.0",x=[],L=[],j=!1;function tn(t){let e=`${t}/.claude/defaults/config.json`,n=`${t}/.claude/defaults`;try{Tt(n,{recursive:!0})}catch{}if(st(e))try{JSON.parse(Ge(e,"utf-8"));return}catch{let r=`${e}.corrupt.${Date.now()}`;try{Xe(e,r),s("setup-repair",`Backed up corrupt config to ${r}`),j=!0}catch{}}wt(e,JSON.stringify({preset:"complete",description:"Full AI-assisted development toolkit (restored by repair)",features:{skills:!0,agents:!0,hooks:!0,mcp:!0,coordination:!0,statusline:!0},hook_groups:{safety:!0,quality:!0,productivity:!0,observability:!0}},null,2)),x.push("config.json restored"),s("setup-repair","Restored default config.json")}function en(t){let e=0,n=(o,r=0)=>{if(!(r>5))try{let i=F(o,{withFileTypes:!0});for(let c of i){let a=`${o}/${c.name}`;if(c.isDirectory()&&!c.name.startsWith("."))n(a,r+1);else if(c.name.endsWith(".sh"))try{Ze(a).mode&73||(Ye(a,493),e++)}catch{}}}catch{}};n(`${t}/hooks`),e>0&&(x.push(`${e} hook permissions fixed`),s("setup-repair",`Fixed permissions on ${e} hooks`))}function nn(t){let e=0,n=[`${t}/.claude/defaults`,`${t}/.claude/context/session`,`${t}/.claude/context/knowledge`,`${t}/.claude/logs`,...N()?[]:[`${t}/.claude/coordination`]];for(let o of n)if(!st(o))try{Tt(o,{recursive:!0}),e++}catch{}e>0&&(x.push(`${e} directories created`),s("setup-repair",`Created ${e} missing directories`))}function on(t){let e=new Date().toISOString(),n=0,o=0,r=0,i=(u,l,f=5)=>{let p=0,d=(E,S)=>{if(!(S>f))try{let R=F(E,{withFileTypes:!0});for(let h of R){let O=`${E}/${h.name}`;h.isDirectory()&&!h.name.startsWith(".")?d(O,S+1):l.test(h.name)&&p++}}catch{}};return d(u,0),p};try{n=i(`${t}/hooks`,/\.sh$/),o=i(`${t}/skills`,/SKILL\.md$/),r=i(`${t}/agents`,/\.md$/)}catch{}let c={version:Qe,setup_date:e,preset:"complete",repaired_at:e,components:{hooks:{count:n,valid:!0},skills:{count:o,valid:!0},agents:{count:r,valid:!0}},last_health_check:e,last_maintenance:e,environment:{os:process.platform},user_preferences:{onboarding_completed:!0,mcp_configured:!1,statusline_configured:!1}},a=`${t}/.setup-complete`;wt(a,JSON.stringify(c,null,2)),x.push("marker file regenerated"),s("setup-repair","Regenerated marker file")}function rn(t){let e=0,n=0;try{n=(i=>{let c=0,a=(u,l)=>{if(!(l>4))try{let f=F(u,{withFileTypes:!0});for(let p of f){let d=`${u}/${p.name}`;p.isDirectory()&&!p.name.startsWith(".")?a(d,l+1):p.name.endsWith(".sh")&&c++}}catch{}};return a(i,0),c})(`${t}/hooks`)}catch{}n<20&&(s("setup-repair",`CRITICAL: Only ${n} hooks found (expected 50+)`),e++);let o=0;try{o=(i=>{let c=0,a=(u,l)=>{if(!(l>2))try{let f=F(u,{withFileTypes:!0});for(let p of f){let d=`${u}/${p.name}`;p.isDirectory()&&!p.name.startsWith(".")?a(d,l+1):p.name==="SKILL.md"&&c++}}catch{}};return a(i,0),c})(`${t}/skills`)}catch{}return o<50&&(s("setup-repair",`CRITICAL: Only ${o} skills found (expected 100+)`),e++),st(`${t}/hooks/_lib/common.sh`)||(s("setup-repair","CRITICAL: hooks/_lib/common.sh missing"),e++),e>=2?(L.push("Multiple critical components missing - reinstall recommended"),j=!0,!1):!0}function Ht(t){let e=y();s("setup-repair","Setup repair starting"),nn(e),tn(e),en(e),rn(e)||s("setup-repair","WARN: Critical components missing, repair incomplete"),on(e);let n="";return x.length>0&&(n=`Repairs: ${x.join(", ")}`),L.length>0&&(n=`${n?n+". ":""}Issues: ${L.join(", ")}`,j=!0),s("setup-repair",`Repair complete: ${x.length} repairs made, ${L.length} issues`),j&&n?m(`OrchestKit auto-repair: ${n}`):g()}var Pt={"setup/unified-dispatcher":vt,"setup/first-run-setup":Ct,"setup/monorepo-detector":Dt,"setup/setup-check":Rt,"setup/setup-maintenance":Ot,"setup/setup-repair":Ht};function wo(t){return Pt[t]}function Ho(){return Object.keys(Pt)}export{qn as escapeRegex,ge as estimateTokenCount,On as getCachedBranch,In as getEnvFile,Kn as getField,wo as getHook,mt as getLogDir,ae as getLogLevel,y as getPluginRoot,C as getProjectDir,z as getSessionId,Pt as hooks,sn as isBashInput,an as isEditInput,un as isReadInput,cn as isWriteInput,Ho as listHooks,s as logHook,Un as logPermissionFeedback,Jn as normalizeCommand,Tn as normalizeLineEndings,Nn as outputAllowWithContext,Hn as outputBlock,Fn as outputDeny,An as outputError,pe as outputPromptContext,Wn as outputPromptContextBudgeted,wn as outputSilentAllow,g as outputSilentSuccess,Ln as outputStderrWarning,Mn as outputWarning,m as outputWithContext,Pn as outputWithNotification,jn as outputWithUpdatedInput,Vn as readHookInput,ue as shouldLog};
//# sourceMappingURL=setup.mjs.map
