#!/bin/bash
# Generated by OrchestKit Claude Plugin
# Created: 2026-02-14

# Scaffold Test File
# Generates a test file from templates for pytest, vitest, or jest.
#
# Usage: ./scaffold-test.sh [OPTIONS]
#
# Options:
#   --framework FRAMEWORK  Test framework: auto, pytest, vitest, jest (default: auto)
#   --type TYPE            Test type: unit, integration, e2e (default: unit)
#   --file FILE            Source file to generate test for
#   --help                 Show this help message
#
# Exit codes:
#   0 = test generated successfully (written to stdout)
#   1 = generation failed
#   2 = usage error

set -euo pipefail

# =============================================================================
# CONFIGURATION
# =============================================================================

FRAMEWORK="auto"
TEST_TYPE="unit"
SOURCE_FILE=""

# =============================================================================
# ARGUMENT PARSING
# =============================================================================

while [[ $# -gt 0 ]]; do
    case "$1" in
        --framework)
            if [[ -z "${2:-}" ]]; then
                echo "Error: --framework requires a value (auto/pytest/vitest/jest)" >&2
                exit 2
            fi
            FRAMEWORK="$2"
            shift 2
            ;;
        --type)
            if [[ -z "${2:-}" ]]; then
                echo "Error: --type requires a value (unit/integration/e2e)" >&2
                exit 2
            fi
            TEST_TYPE="$2"
            shift 2
            ;;
        --file)
            if [[ -z "${2:-}" ]]; then
                echo "Error: --file requires a path" >&2
                exit 2
            fi
            SOURCE_FILE="$2"
            shift 2
            ;;
        --help|-h)
            echo "Scaffold Test File"
            echo ""
            echo "Usage: $0 [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --framework FRAMEWORK  auto, pytest, vitest, jest (default: auto)"
            echo "  --type TYPE            unit, integration, e2e (default: unit)"
            echo "  --file FILE            Source file to generate test for"
            echo "  --help                 Show this help message"
            echo ""
            echo "Examples:"
            echo "  $0 --file src/auth.py                    # Auto-detect pytest"
            echo "  $0 --file src/utils.ts --framework vitest"
            echo "  $0 --framework jest --type integration"
            echo ""
            echo "Output is written to stdout."
            exit 0
            ;;
        *)
            echo "Error: Unknown option '$1'. Use --help for usage." >&2
            exit 2
            ;;
    esac
done

# Validate test type
case "$TEST_TYPE" in
    unit|integration|e2e) ;;
    *)
        echo "Error: Invalid test type '$TEST_TYPE'. Use unit, integration, or e2e." >&2
        exit 2
        ;;
esac

# =============================================================================
# AUTO-DETECTION
# =============================================================================

detect_framework() {
    # Detect from source file extension first
    if [[ -n "$SOURCE_FILE" ]]; then
        case "$SOURCE_FILE" in
            *.py) echo "pytest"; return ;;
            *.ts|*.tsx)
                # Check for vitest vs jest
                if [[ -f "vitest.config.ts" || -f "vitest.config.js" || -f "vitest.config.mts" ]]; then
                    echo "vitest"; return
                fi
                echo "jest"; return
                ;;
            *.js|*.jsx)
                if [[ -f "vitest.config.ts" || -f "vitest.config.js" || -f "vitest.config.mts" ]]; then
                    echo "vitest"; return
                fi
                echo "jest"; return
                ;;
        esac
    fi

    # Detect from project files
    if [[ -f "pyproject.toml" || -f "setup.py" || -f "pytest.ini" || -f "setup.cfg" ]]; then
        echo "pytest"; return
    fi

    if [[ -f "vitest.config.ts" || -f "vitest.config.js" || -f "vitest.config.mts" ]]; then
        echo "vitest"; return
    fi

    if [[ -f "jest.config.ts" || -f "jest.config.js" || -f "jest.config.mjs" ]]; then
        echo "jest"; return
    fi

    if [[ -f "package.json" ]]; then
        echo "jest"; return
    fi

    echo ""
}

if [[ "$FRAMEWORK" == "auto" ]]; then
    FRAMEWORK=$(detect_framework)
    if [[ -z "$FRAMEWORK" ]]; then
        echo "Error: Could not auto-detect test framework." >&2
        echo "Use --framework to specify: pytest, vitest, or jest" >&2
        exit 1
    fi
fi

# Validate framework
case "$FRAMEWORK" in
    pytest|vitest|jest) ;;
    *)
        echo "Error: Invalid framework '$FRAMEWORK'. Use pytest, vitest, or jest." >&2
        exit 2
        ;;
esac

# =============================================================================
# DERIVE NAMES
# =============================================================================

MODULE_NAME="module"
if [[ -n "$SOURCE_FILE" ]]; then
    MODULE_NAME=$(basename "$SOURCE_FILE" | sed 's/\.[^.]*$//')
fi

# Capitalize first letter (portable, works in bash 3+)
capitalize() {
    local str="$1"
    local first
    first=$(echo "${str:0:1}" | tr '[:lower:]' '[:upper:]')
    echo "${first}${str:1}"
}

MODULE_CAPITALIZED=$(capitalize "$MODULE_NAME")
TYPE_CAPITALIZED=$(capitalize "$TEST_TYPE")

# =============================================================================
# GENERATE TEMPLATES
# =============================================================================

generate_pytest() {
    local module="$1"
    local type="$2"
    local module_cap="$MODULE_CAPITALIZED"
    local type_cap="$TYPE_CAPITALIZED"

    cat << PYTEST_EOF
"""Tests for ${module}."""

import pytest
PYTEST_EOF

    if [[ "$type" == "integration" || "$type" == "e2e" ]]; then
        cat << 'PYTEST_EOF'
from unittest.mock import AsyncMock, patch
PYTEST_EOF
    fi

    cat << PYTEST_EOF


class Test${module_cap}:
    """${type_cap} tests for ${module}."""

PYTEST_EOF

    if [[ "$type" == "unit" ]]; then
        cat << PYTEST_EOF
    def test_should_do_expected_behavior(self):
        """Test that ${module} behaves correctly under normal conditions."""
        # Arrange
        # TODO: Set up test data

        # Act
        # TODO: Call the function under test

        # Assert
        # TODO: Verify expected outcome
        assert True

    def test_should_handle_edge_case(self):
        """Test edge case handling."""
        # Arrange

        # Act

        # Assert
        assert True

    def test_should_raise_on_invalid_input(self):
        """Test that invalid input raises appropriate error."""
        with pytest.raises(ValueError):
            pass  # TODO: Call with invalid input
PYTEST_EOF
    elif [[ "$type" == "integration" ]]; then
        cat << PYTEST_EOF
    @pytest.fixture
    def setup_dependencies(self):
        """Set up integration test dependencies."""
        # TODO: Initialize database, external services, etc.
        yield
        # TODO: Cleanup

    def test_integration_workflow(self, setup_dependencies):
        """Test end-to-end workflow with real dependencies."""
        # Arrange

        # Act

        # Assert
        assert True
PYTEST_EOF
    else
        cat << PYTEST_EOF
    @pytest.fixture(scope="class")
    def setup_e2e(self):
        """Set up e2e test environment."""
        # TODO: Start servers, seed data
        yield
        # TODO: Tear down

    def test_e2e_user_flow(self, setup_e2e):
        """Test complete user flow end-to-end."""
        # TODO: Implement e2e test
        assert True
PYTEST_EOF
    fi
}

generate_vitest() {
    local module="$1"
    local type="$2"

    cat << VITEST_EOF
import { describe, it, expect, beforeEach } from 'vitest';
VITEST_EOF

    if [[ "$type" == "integration" || "$type" == "e2e" ]]; then
        cat << 'VITEST_EOF'
import { vi } from 'vitest';
VITEST_EOF
    fi

    cat << VITEST_EOF

describe('${module}', () => {
VITEST_EOF

    if [[ "$type" == "unit" ]]; then
        cat << VITEST_EOF
  describe('core functionality', () => {
    it('should do expected behavior', () => {
      // Arrange
      // TODO: Set up test data

      // Act
      // TODO: Call the function under test

      // Assert
      expect(true).toBe(true);
    });

    it('should handle edge case', () => {
      // Arrange

      // Act

      // Assert
      expect(true).toBe(true);
    });

    it('should throw on invalid input', () => {
      expect(() => {
        // TODO: Call with invalid input
      }).toThrow();
    });
  });
VITEST_EOF
    elif [[ "$type" == "integration" ]]; then
        cat << VITEST_EOF
  beforeEach(() => {
    // TODO: Set up integration dependencies
  });

  it('should complete integration workflow', async () => {
    // Arrange

    // Act

    // Assert
    expect(true).toBe(true);
  });
VITEST_EOF
    else
        cat << VITEST_EOF
  beforeEach(async () => {
    // TODO: Set up e2e environment
  });

  it('should complete user flow end-to-end', async () => {
    // TODO: Implement e2e test
    expect(true).toBe(true);
  });
VITEST_EOF
    fi

    echo "});"
}

generate_jest() {
    local module="$1"
    local type="$2"

    cat << JEST_EOF
describe('${module}', () => {
JEST_EOF

    if [[ "$type" == "unit" ]]; then
        cat << JEST_EOF
  describe('core functionality', () => {
    it('should do expected behavior', () => {
      // Arrange
      // TODO: Set up test data

      // Act
      // TODO: Call the function under test

      // Assert
      expect(true).toBe(true);
    });

    it('should handle edge case', () => {
      // Arrange

      // Act

      // Assert
      expect(true).toBe(true);
    });

    it('should throw on invalid input', () => {
      expect(() => {
        // TODO: Call with invalid input
      }).toThrow();
    });
  });
JEST_EOF
    elif [[ "$type" == "integration" ]]; then
        cat << JEST_EOF
  beforeEach(() => {
    // TODO: Set up integration dependencies
  });

  afterEach(() => {
    // TODO: Clean up
  });

  it('should complete integration workflow', async () => {
    // Arrange

    // Act

    // Assert
    expect(true).toBe(true);
  });
JEST_EOF
    else
        cat << JEST_EOF
  beforeAll(async () => {
    // TODO: Set up e2e environment
  });

  afterAll(async () => {
    // TODO: Tear down e2e environment
  });

  it('should complete user flow end-to-end', async () => {
    // TODO: Implement e2e test
    expect(true).toBe(true);
  });
JEST_EOF
    fi

    echo "});"
}

# =============================================================================
# OUTPUT
# =============================================================================

case "$FRAMEWORK" in
    pytest)      generate_pytest "$MODULE_NAME" "$TEST_TYPE" ;;
    vitest)      generate_vitest "$MODULE_NAME" "$TEST_TYPE" ;;
    jest)        generate_jest "$MODULE_NAME" "$TEST_TYPE" ;;
esac
