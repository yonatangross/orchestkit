// OrchestKit Hooks - setup bundle
// Generated: 2026-02-09T23:17:39.503Z

function vn(e){return typeof e.command=="string"}function $n(e){return typeof e.file_path=="string"&&typeof e.content=="string"}function bn(e){return typeof e.file_path=="string"&&typeof e.old_string=="string"&&typeof e.new_string=="string"}function _n(e){return typeof e.file_path=="string"&&e.content===void 0}import{appendFileSync as pe,existsSync as le,statSync as nt,renameSync as ot,mkdirSync as rt,readSync as st}from"node:fs";import{execSync as it}from"node:child_process";import oe from"node:os";import T from"node:path";function P(){return process.env.HOME||process.env.USERPROFILE||oe.homedir()}function re(){return oe.tmpdir()}function V(){return process.env.CLAUDE_PROJECT_DIR||"."}function se(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function ie(){return process.env.CLAUDE_PLUGIN_ROOT?T.join(P(),".claude","logs","ork"):T.join(V(),".claude","logs")}var Rn=T.join,In=T.sep;import{execSync as je}from"node:child_process";import{createHash as Le}from"node:crypto";import{existsSync as ce,readFileSync as Ue,writeFileSync as We,mkdirSync as Ke}from"node:fs";import{join as J,basename as Ve}from"node:path";var Je=20,Be=15,qe=/[^a-z0-9-]/g;function ze(e){let t=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=Ve(t);return ae(n,Je)}function Ge(e){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let t=e||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=je("git branch --show-current",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),o=ae(n||"detached",Be);return process.env.ORCHESTKIT_SESSION_BRANCH=o,o}catch{return"nobranch"}}function Ye(e){let t=e||new Date,n=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${n}${o}`}function Xe(e){let t=e||new Date,n=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0");return`${n}${o}`}function Ze(){let e=`${process.pid}-${Date.now()}-${Math.random()}`;return Le("sha256").update(e).digest("hex").slice(0,4)}function ae(e,t){return e.toLowerCase().replace(qe,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,t)}function Qe(e,t){let n=ze(e),o=Ge(e),r=Ye(t),i=Xe(t),c=Ze();return`${n}-${o}-${r}-${i}-${c}`}function et(e){let t=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=J(t,".instance","session-id.json");if(ce(n))try{let o=JSON.parse(Ue(n,"utf8"));if(o.session_id&&o.created_at){let r=Date.now()-new Date(o.created_at).getTime(),i=1440*60*1e3;if(r<i)return o.session_id}}catch{}}function tt(e,t){let n=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),o=J(n,".instance"),r=J(o,"session-id.json");try{ce(o)||Ke(o,{recursive:!0}),We(r,JSON.stringify({session_id:e,created_at:new Date().toISOString()},null,2))}catch{}}function ue(e){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let t=et(e);if(t)return t;let n=Qe(e);return tt(n,e),n}function me(){return ie()}function k(){return V()}function S(){return se()}function jn(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${S()}/.claude/.instance_env`}function B(){return ue()}function Ln(e){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let t=it("git branch --show-current",{cwd:e||k(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=t,t}catch{return"unknown"}}function ct(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Un(e){return e.replace(/\r\n/g,`
`)}function at(e){let t=["debug","info","warn","error"];return t.indexOf(e)>=t.indexOf(ct())}function m(){return{continue:!0,suppressOutput:!0}}function Wn(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function Kn(e){return{continue:!1,stopReason:e,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:e}}}function h(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:e}}}function ut(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:e}}}function Vn(e,t){let n={continue:!0,suppressOutput:!0};return e&&(n.systemMessage=e),t&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:t}),n}function Jn(e,t){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:e,permissionDecision:"allow"}};return t?n.systemMessage=t:n.suppressOutput=!0,n}function Bn(e){return{continue:!0,systemMessage:e}}function qn(e){return{continue:!0,systemMessage:`\u26A0 ${e}`}}function zn(e){return{continue:!1,stopReason:e,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:e}}}function Gn(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:e}}}var pt=200*1024,lt=100*1024;function fe(e,t){if(le(e))try{if(nt(e).size>t){let o=`${e}.old.${Date.now()}`;ot(e,o)}}catch{}}function de(e){le(e)||rt(e,{recursive:!0})}function s(e,t,n="debug"){if(!at(n))return;let o=me(),r=`${o}/hooks.log`;try{de(o),fe(r,pt);let i=new Date().toISOString().replace("T"," ").slice(0,19);pe(r,`[${i}] [${n.toUpperCase()}] [${e}] ${t}
`)}catch{}}function Yn(e,t,n){let o=me(),r=`${o}/permission-feedback.log`;try{de(o),fe(r,lt);let i=new Date().toISOString(),c=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",a=n?.session_id||B();pe(r,`${i} | ${e} | ${t} | tool=${c} | session=${a}
`)}catch{}}function mt(e){if(!e)return 0;let o=(e.match(/[{};()=><]/g)||[]).length/e.length>.03?2.8:3.5;return Math.ceil(e.length/o)}function Xn(e,t,n,o,r){let i=mt(e);return o&&o.isOverBudget(n)?(s(t,`Budget exhausted for ${n}, suppressing ${i}t`),m()):(r&&r.trackTokenUsage(t,n,i),ut(e))}function Zn(){try{let e=[],n=Buffer.allocUnsafe(256),o,r=0;for(;;)try{if(o=st(r,n,0,256,null),o===0)break;e.push(Buffer.from(n.subarray(0,o)))}catch{break}let i=Buffer.concat(e).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:B(),tool_input:{}}}catch{return{tool_name:"",session_id:B(),tool_input:{}}}}function Qn(e,t){let n=t.replace(/^\./,"").split("."),o=e;for(let r of n){if(o==null)return;o=o[r]}return o}function eo(e){return e.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function to(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}import{existsSync as D,readFileSync as z,writeFileSync as ft,mkdirSync as dt}from"node:fs";var gt=[{package:"lodash",pattern:"<4.17.21",severity:"high",cve:"CVE-2021-23337",description:"Prototype pollution"},{package:"minimist",pattern:"<1.2.6",severity:"critical",cve:"CVE-2021-44906",description:"Prototype pollution"},{package:"node-fetch",pattern:"<2.6.7",severity:"high",cve:"CVE-2022-0235",description:"Information exposure"},{package:"axios",pattern:"<0.21.2",severity:"high",cve:"CVE-2021-3749",description:"ReDoS vulnerability"},{package:"jsonwebtoken",pattern:"<9.0.0",severity:"critical",cve:"CVE-2022-23529",description:"Insecure token verification"},{package:"express",pattern:"<4.17.3",severity:"medium",cve:"CVE-2022-24999",description:"Open redirect"},{package:"tar",pattern:"<6.1.11",severity:"critical",cve:"CVE-2021-37701",description:"Arbitrary file overwrite"},{package:"path-parse",pattern:"<1.0.7",severity:"medium",cve:"CVE-2021-23343",description:"ReDoS vulnerability"},{package:"django",pattern:"<3.2.14",severity:"high",cve:"CVE-2022-34265",description:"SQL injection"},{package:"flask",pattern:"<2.0.2",severity:"medium",cve:"CVE-2021-28091",description:"Path traversal"},{package:"requests",pattern:"<2.28.0",severity:"medium",cve:"CVE-2023-32681",description:"Information disclosure"},{package:"urllib3",pattern:"<1.26.5",severity:"high",cve:"CVE-2021-33503",description:"ReDoS vulnerability"},{package:"pillow",pattern:"<9.0.0",severity:"high",cve:"CVE-2022-22817",description:"Buffer overflow"},{package:"pyyaml",pattern:"<5.4",severity:"critical",cve:"CVE-2020-14343",description:"Arbitrary code execution"},{package:"jinja2",pattern:"<3.0.3",severity:"medium",cve:"CVE-2020-28493",description:"XSS vulnerability"},{package:"sqlalchemy",pattern:"<1.4.46",severity:"medium",cve:"CVE-2023-30533",description:"SQL injection"}],ht=24;function kt(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function yt(e,t){let n=e.split(".").map(r=>parseInt(r,10)||0),o=t.split(".").map(r=>parseInt(r,10)||0);for(let r=0;r<Math.max(n.length,o.length);r++){let i=n[r]||0,c=o[r]||0;if(i<c)return!0;if(i>c)return!1}return!1}function St(e,t){let n=t.charAt(0),o=t.substring(1);return n==="<"?yt(e,o):n==="="?e===o:!1}function vt(e){return e.replace(/^[^~>=<]/,"").replace(/,.*$/,"").trim()}function ge(e,t){let n=vt(t),o=e.toLowerCase();for(let r of gt)if(o===r.package&&St(n,r.pattern))return r;return null}function $t(e){if(!D(e))return null;try{let t=JSON.parse(z(e,"utf-8"));if((Date.now()-t.timestamp)/(1e3*60*60)<ht)return t.warnings}catch{}return null}function q(e,t){try{dt(e.replace(/\/[^/]+$/,""),{recursive:!0});let n={warnings:t,timestamp:Date.now()};ft(e,JSON.stringify(n,null,2))}catch{}}function bt(e){let t=0,n=0,o="";if(!D(e))return{criticalCount:t,highCount:n,warnings:o};try{let r=JSON.parse(z(e,"utf-8")),i={...r.dependencies,...r.devDependencies};for(let[c,a]of Object.entries(i)){let u=ge(c,a);u&&(u.severity==="critical"&&t++,u.severity==="high"&&n++,o+=`
- ${c}@${a}: ${u.description} (${u.cve}, ${u.severity}) - upgrade to ${u.pattern}`)}}catch{}return{criticalCount:t,highCount:n,warnings:o}}function _t(e){let t=0,n=0,o="";if(!D(e))return{criticalCount:t,highCount:n,warnings:o};try{let i=z(e,"utf-8").split(`
`);for(let c of i){let a=c.trim();if(!a||a.startsWith("#"))continue;let u=a.match(/^([a-zA-Z0-9_-]+)(?:==|>=|~=|!=|<|>)\s*([0-9.]+)/);if(!u)continue;let[,p,f]=u,l=ge(p,f);l&&(l.severity==="critical"&&t++,l.severity==="high"&&n++,o+=`
- ${p}==${f}: ${l.description} (${l.cve}, ${l.severity}) - upgrade to ${l.pattern}`)}}catch{}return{criticalCount:t,highCount:n,warnings:o}}function he(e){if(kt())return s("dependency-version-check","Skipping dependency check (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),m();s("dependency-version-check","Starting dependency version check");let t=e.project_dir||k(),n=`${t}/.claude/feedback/dependency-check-cache.json`,o=D(`${t}/package.json`),r=D(`${t}/requirements.txt`),i=D(`${t}/pyproject.toml`),c=D(`${t}/go.mod`);if(!o&&!r&&!i&&!c)return s("dependency-version-check","No package files found, skipping check"),q(n,"none"),m();let a=$t(n);if(a!==null)return s("dependency-version-check","Using cached dependency warnings"),a!=="none"?h(`DEPENDENCY SECURITY CHECK (cached): ${a}`):m();let u=0,p=0,f="";if(o){let l=bt(`${t}/package.json`);u+=l.criticalCount,p+=l.highCount,l.warnings&&(f+=`

Node.js (package.json):${l.warnings}`)}if(r){let l=_t(`${t}/requirements.txt`);u+=l.criticalCount,p+=l.highCount,l.warnings&&(f+=`

Python (requirements.txt):${l.warnings}`)}if(f){let l=`Found ${u} critical and ${p} high severity vulnerabilities`,d=`DEPENDENCY SECURITY CHECK: ${l}${f}

Run 'npm audit' or 'pip-audit' for full details.`;if(q(n,d),s("dependency-version-check",l),u>0||p>0)return h(d)}else q(n,"none"),s("dependency-version-check","No known vulnerabilities found");return m()}import{writeFileSync as Et,mkdirSync as Ct}from"node:fs";function Dt(){return!!process.env.MEM0_API_KEY}function Rt(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function ke(e){if(Rt())return s("mem0-webhook-setup","Skipping mem0 webhook setup (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),m();if(s("mem0-webhook-setup","Mem0 webhook setup starting"),!Dt())return s("mem0-webhook-setup","Mem0 not available, skipping webhook setup"),m();let t=e.project_dir||k(),n=`${t}/.claude/mem0-webhooks.json`,o="orchestkit-auto-sync",r=["memory.created","memory.updated","memory.deleted"],i=process.env.MEM0_WEBHOOK_URL||"https://example.com/webhook/mem0";s("mem0-webhook-setup","Checking for existing webhooks"),process.env.MEM0_WEBHOOK_URL||s("mem0-webhook-setup","Webhook URL not configured (set MEM0_WEBHOOK_URL), skipping creation");try{Ct(`${t}/.claude`,{recursive:!0}),Et(n,JSON.stringify({webhook_name:o,events:r,url:i},null,2)),s("mem0-webhook-setup","Webhook config saved")}catch(c){s("mem0-webhook-setup",`Failed to save webhook config: ${c}`)}return s("mem0-webhook-setup","Webhook setup complete"),m()}var M=[{name:"dependency-version-check",fn:he},{name:"mem0-webhook-setup",fn:ke}];async function ye(e){s("setup-dispatcher",`Running ${M.length} Setup hooks in parallel`);let t=await Promise.allSettled(M.map(async o=>{try{let r=o.fn(e);return r instanceof Promise&&await r,{hook:o.name,status:"success"}}catch(r){let i=r instanceof Error?r.message:String(r);return s("setup-dispatcher",`${o.name} failed: ${i}`),{hook:o.name,status:"error",message:i}}})),n=[];for(let o of t)o.status==="rejected"?n.push("unknown"):o.value.status==="error"&&n.push(o.value.hook);return n.length>0?s("setup-dispatcher",`${n.length}/${M.length} hooks failed: ${n.join(", ")}`):s("setup-dispatcher",`All ${M.length} Setup hooks completed successfully`),m()}import{existsSync as Se,mkdirSync as It,writeFileSync as ve,readdirSync as Y,chmodSync as Ot}from"node:fs";import{execSync as _}from"node:child_process";var G="4.25.0";function wt(){s("first-run-setup","Phase 1: Detecting environment");let e={os:process.platform};try{let n=_("python3 --version",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}).match(/(\d+\.\d+)/);n&&(e.python=n[1],s("first-run-setup",`Python: ${n[1]}`))}catch{}try{let n=_("node --version",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}).match(/(\d+\.\d+)/);n&&(e.nodejs=n[1],s("first-run-setup",`Node.js: ${n[1]}`))}catch{}try{_("which git",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),e.git=!0,s("first-run-setup","Git: available")}catch{}try{_("which docker",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),e.docker=!0,s("first-run-setup","Docker: available")}catch{}try{_("which sqlite3",{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),e.sqlite3=!0,s("first-run-setup","SQLite3: available (multi-instance coordination enabled)")}catch{}return e}function xt(){s("first-run-setup","Phase 2: Validating dependencies");let e=[],t=[];try{_("which jq",{encoding:"utf8",stdio:["pipe","pipe","pipe"]})}catch{e.push("jq (required for JSON processing)")}try{_("which sqlite3",{encoding:"utf8",stdio:["pipe","pipe","pipe"]})}catch{t.push("sqlite3 not found - multi-instance coordination disabled")}try{_('python3 -c "import anthropic"',{encoding:"utf8",stdio:["pipe","pipe","pipe"]}),s("first-run-setup","Anthropic SDK: available (Memory Fabric Agent enabled)")}catch{t.push("anthropic SDK not found - Memory Fabric Agent will use fallback mode"),t.push("  Install with: pip install 'orchestkit[memory]'")}if(e.length>0){s("first-run-setup","ERROR: Missing required dependencies:");for(let n of e)s("first-run-setup",`  - ${n}`)}for(let n of t)s("first-run-setup",`WARN: ${n}`);return{valid:e.length===0,missing:e,warnings:t}}function Ht(e){let t={complete:{preset:"complete",description:"Full AI-assisted development toolkit",features:{skills:!0,agents:!0,hooks:!0,mcp:!0,coordination:!0,statusline:!0},hook_groups:{safety:!0,quality:!0,productivity:!0,observability:!0}},standard:{preset:"standard",description:"Skills and hooks without agent orchestration",features:{skills:!0,agents:!1,hooks:!0,mcp:!0,coordination:!0,statusline:!0},hook_groups:{safety:!0,quality:!0,productivity:!0,observability:!0}},lite:{preset:"lite",description:"Essential skills for constrained environments",features:{skills:!0,agents:!1,hooks:!0,mcp:!1,coordination:!1,statusline:!1},hook_groups:{safety:!0,quality:!0,productivity:!1,observability:!1}},"hooks-only":{preset:"hooks-only",description:"Safety hooks only for pure automation",features:{skills:!1,agents:!1,hooks:!0,mcp:!1,coordination:!1,statusline:!1},hook_groups:{safety:!0,quality:!1,productivity:!1,observability:!1}}};return t[e]||t.complete}function Tt(e,t,n){s("first-run-setup",`Phase 4: Applying configuration (preset: ${e})`);let o=Ht(e),r=[`${n}/.claude/defaults`,`${n}/.claude/context/session`,`${n}/.claude/context/knowledge`,`${n}/.claude/logs`];for(let c of r)try{It(c,{recursive:!0})}catch{}let i=`${n}/.claude/defaults/config.json`;Se(i)||(ve(i,JSON.stringify(o,null,2)),s("first-run-setup",`Created config file: ${i}`));try{let c=`${n}/hooks`;if(Se(c)){let a=u=>{try{let p=Y(u,{withFileTypes:!0});for(let f of p){let l=`${u}/${f.name}`;if(f.isDirectory())a(l);else if(f.name.endsWith(".sh"))try{Ot(l,493)}catch{}}}catch{}};a(c),s("first-run-setup","Made hooks executable")}}catch{}return o}function Pt(e,t,n){s("first-run-setup","Phase 5: Creating marker file");let o=new Date().toISOString(),r=0,i=0,c=0;try{let p=(f,l)=>{let d=0,g=$=>{try{let b=Y($,{withFileTypes:!0});for(let y of b){let x=`${$}/${y.name}`;y.isDirectory()?g(x):l.test(y.name)&&d++}}catch{}};return g(f),d};r=p(`${n}/hooks`,/\.sh$/),i=p(`${n}/skills`,/SKILL\.md$/),c=p(`${n}/agents`,/\.md$/)}catch{}let a={version:G,setup_date:o,preset:e,components:{hooks:{count:r,valid:!0},skills:{count:i,valid:!0},agents:{count:c,valid:!0}},last_health_check:o,last_maintenance:o,environment:t,user_preferences:{onboarding_completed:!0,mcp_configured:!1,statusline_configured:!1}},u=`${n}/.setup-complete`;ve(u,JSON.stringify(a,null,2)),s("first-run-setup",`Marker file created: ${u}`)}function $e(e){let t=S(),n=process.argv.includes("--silent")?"silent":"interactive";s("first-run-setup",`First-run setup starting (mode: ${n})`);let o=wt(),{valid:r,missing:i}=xt();if(!r){s("first-run-setup","ERROR: Dependency validation failed");let l=`OrchestKit setup failed: Missing required dependencies. Install ${i.join(", ")}.`;return h(l)}let c="complete";n==="interactive"?s("first-run-setup","Interactive mode - using complete preset (wizard via Claude conversation)"):s("first-run-setup","Silent mode - using complete preset"),Tt(c,o,t),Pt(c,o,t);let a=0,u=0,p=0;try{let l=(d,g)=>{let $=0,b=y=>{try{let x=Y(y,{withFileTypes:!0});for(let K of x){let Fe=`${y}/${K.name}`;K.isDirectory()?b(Fe):g.test(K.name)&&$++}}catch{}};return b(d),$};a=l(`${t}/hooks`,/\.sh$/),u=l(`${t}/skills`,/SKILL\.md$/),p=l(`${t}/agents`,/\.md$/)}catch{}s("first-run-setup",`Setup complete: ${u} skills, ${p} agents, ${a} hooks`);let f=n==="interactive"?`OrchestKit v${G} setup complete! Loaded ${u} skills, ${p} agents, and ${a} hooks. Use /ork:configure to customize settings.`:`OrchestKit v${G} initialized (silent mode).`;return h(f)}import{existsSync as Mt,mkdirSync as At,writeFileSync as Nt}from"node:fs";import{execSync as Ft}from"node:child_process";function jt(){return!!process.env.MEM0_API_KEY}function be(e){if(s("mem0-analytics","Mem0 analytics dashboard starting"),!jt())return s("mem0-analytics","Mem0 not available, skipping analytics dashboard"),m();let t=e.project_dir||k(),n=S(),o=`${t}/.claude/logs/mem0-analytics.jsonl`,r=`${t}/.claude/logs/mem0-dashboard.json`,i=`${n}/skills/mem0-memory/scripts/memory-summary.py`,c="{}";if(Mt(i))try{c=Ft(`python3 "${i}"`,{encoding:"utf8",timeout:3e4,stdio:["pipe","pipe","pipe"]})}catch{s("mem0-analytics","Failed to run summary script")}else return s("mem0-analytics","Summary script not found, skipping dashboard"),m();let a;try{a=JSON.parse(c)}catch{a={}}let p={timestamp:new Date().toISOString(),summary:a,trends:{memory_growth:"tracked",search_frequency:"tracked",graph_utilization:"tracked"}};try{At(`${t}/.claude/logs`,{recursive:!0}),Nt(r,JSON.stringify(p,null,2)),s("mem0-analytics","Mem0 analytics dashboard generated")}catch(f){s("mem0-analytics",`Failed to save dashboard: ${f}`)}return m()}import{mkdirSync as Lt,writeFileSync as Ut}from"node:fs";function Wt(){return!!process.env.MEM0_API_KEY}function _e(e){if(s("mem0-backup","Mem0 backup setup starting"),!Wt())return s("mem0-backup","Mem0 not available, skipping backup setup"),m();let t=e.project_dir||k(),n=`${t}/.claude/mem0-backup-config.json`,o=process.env.MEM0_BACKUP_SCHEDULE||"weekly",r=parseInt(process.env.MEM0_BACKUP_RETENTION||"30",10);try{Lt(`${t}/.claude`,{recursive:!0});let i={schedule:o,retention_days:r,enabled:!0,max_backups:parseInt(process.env.MEM0_MAX_BACKUPS||"5",10),rotation_strategy:"count",backup_naming:"timestamp"};Ut(n,JSON.stringify(i,null,2)),s("mem0-backup",`Mem0 backup configured: schedule=${o}, retention=${r} days`)}catch(i){s("mem0-backup",`Failed to create backup config: ${i}`)}return m()}import{existsSync as Ee,mkdirSync as Kt,appendFileSync as O}from"node:fs";import{execSync as Ce}from"node:child_process";function Vt(){return!!process.env.MEM0_API_KEY}function Jt(e){let t=new Date;return t.setDate(t.getDate()-e),t.toISOString().split("T")[0]}function De(e){if(s("mem0-cleanup","Mem0 cleanup starting"),!Vt())return s("mem0-cleanup","Mem0 not available, skipping cleanup"),m();let t=e.project_dir||k(),o=`${S()}/skills/mem0-memory/scripts`,r=`${o}/batch/batch-delete.py`,i=`${o}/crud/get-memories.py`;if(!Ee(r))return s("mem0-cleanup",`Batch delete script not found at ${r}, skipping cleanup`),m();if(!Ee(i))return s("mem0-cleanup",`Get memories script not found at ${i}, skipping cleanup`),m();let c=parseInt(process.env.MEM0_CLEANUP_AGE_DAYS||"90",10),a=Jt(c),u=`${t}/.claude/logs/mem0-cleanup.log`;try{Kt(`${t}/.claude/logs`,{recursive:!0})}catch{}s("mem0-cleanup",`Querying memories older than ${a} (${c} days)`);let p=new Date().toISOString();try{O(u,`[${p}] Cleanup started - threshold: ${a}
`)}catch{}let f;try{let g=Ce(`python3 "${i}"`,{encoding:"utf8",timeout:6e4,stdio:["pipe","pipe","pipe"]});f=JSON.parse(g)}catch{s("mem0-cleanup","Failed to get memories");try{O(u,`[${p}] Failed to get memories
`)}catch{}return m()}let d=(f.memories||[]).filter(g=>{let b=(g.created_at?.split("T")[0]||"")<a,y=g.metadata?.protected===!0;return b&&!y}).map(g=>g.id).slice(0,100);if(d.length===0){s("mem0-cleanup",`No stale memories found older than ${a}`);try{O(u,`[${p}] No stale memories found
`)}catch{}return m()}s("mem0-cleanup",`Found ${d.length} stale memories to delete`);try{O(u,`[${p}] Found ${d.length} stale memories
`)}catch{}try{let g=JSON.stringify(d);Ce(`python3 "${r}" --memory-ids '${g}'`,{encoding:"utf8",timeout:12e4,stdio:["pipe","pipe","pipe"]}),s("mem0-cleanup",`Successfully deleted ${d.length} stale memories`);try{O(u,`[${p}] Deleted ${d.length} memories successfully
`)}catch{}}catch(g){s("mem0-cleanup",`Batch delete failed: ${g}`);try{O(u,`[${p}] Delete failed: ${g}
`)}catch{}}return s("mem0-cleanup",`Mem0 cleanup complete (age threshold: ${c} days)`),m()}import{existsSync as X,readdirSync as Re}from"node:fs";var Bt=["pnpm-workspace.yaml","lerna.json","nx.json","turbo.json","rush.json"];function qt(e){let t=0;try{let n=Re(e,{withFileTypes:!0});for(let o of n){if(!o.isDirectory()||o.name.startsWith(".")||o.name==="node_modules")continue;let r=`${e}/${o.name}`;X(`${r}/package.json`)&&t++;try{let i=Re(r,{withFileTypes:!0});for(let c of i)!c.isDirectory()||c.name.startsWith(".")||c.name==="node_modules"||X(`${r}/${c.name}/package.json`)&&t++}catch{}}}catch{}return t}function Ie(e){if(s("monorepo-detector","Checking for monorepo structure"),process.env.CLAUDE_CODE_ADDITIONAL_DIRECTORIES_CLAUDE_MD==="1")return s("monorepo-detector","CLAUDE_CODE_ADDITIONAL_DIRECTORIES_CLAUDE_MD already set, skipping"),m();let t=e.project_dir||k(),n=[];for(let c of Bt)X(`${t}/${c}`)&&n.push(c);let o=qt(t);if(!(n.length>0||o>=3))return s("monorepo-detector","No monorepo detected"),m();let i=n.length>0?`Detected: ${n.join(", ")}`:`Found ${o} nested packages`;return s("monorepo-detector",`Monorepo detected: ${i}`),h(`**Monorepo Detected** (${i})

CC 2.1.20 supports multi-directory context with \`--add-dir\`. Each service can have its own CLAUDE.md for targeted instructions.

Set \`CLAUDE_CODE_ADDITIONAL_DIRECTORIES_CLAUDE_MD=1\` to auto-load CLAUDE.md from added directories.`)}import{existsSync as E,readFileSync as Q,readdirSync as zt,writeFileSync as Gt}from"node:fs";import{spawn as Z}from"node:child_process";var H="4.25.0";function Oe(e,t){if(!E(e))return null;try{let n=JSON.parse(Q(e,"utf-8")),o=t.split("."),r=n;for(let i of o){if(r==null)return null;r=r[i]}return r}catch{return null}}function Yt(e){let t=0,n=`${e}/.claude/defaults/config.json`;if(E(n))try{JSON.parse(Q(n,"utf-8"))}catch{s("setup-check","WARN: config.json is invalid JSON"),t++}let o=0;if(E(`${e}/hooks`))try{let c=(a,u=0)=>{if(u>3)return 0;let p=0;try{let f=zt(a,{withFileTypes:!0});for(let l of f.slice(0,100)){let d=`${a}/${l.name}`;l.isDirectory()&&!l.name.startsWith(".")?p+=c(d,u+1):l.name.endsWith(".sh")&&p++}}catch{}return p};o=c(`${e}/hooks`)}catch{}o<10&&s("setup-check",`WARN: Only ${o} hooks found (expected 50+)`);let r=`${e}/.setup-complete`,i=Oe(r,"version");return i&&i!==H?(s("setup-check",`INFO: Version mismatch - marker: ${i}, current: ${H}`),2):t}function Xt(e){let t=Oe(e,"last_maintenance");if(!t)return!0;try{let n=new Date(t).getTime();return(Date.now()-n)/(1e3*60*60)>=24}catch{return!0}}function Zt(e,t,n){if(E(e))try{let o=JSON.parse(Q(e,"utf-8"));o[t]=n,Gt(e,JSON.stringify(o,null,2))}catch{}}function we(e){if(process.env.ORCHESTKIT_SKIP_SETUP==="1"||process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1")return m();let t=S(),n=`${t}/.setup-complete`,o=`${t}/hooks/setup`;s("setup-check",`Setup check starting (v${H})`);let r=process.argv;if(r.includes("--init")||r.includes("init"))return s("setup-check","Explicit --init: Running full setup"),{continue:!0,systemMessage:"Running first-run setup..."};if(r.includes("--init-only")||r.includes("init-only"))return s("setup-check","CI/CD mode (--init-only): Running silent setup"),{continue:!0,systemMessage:"Running silent setup..."};if(r.includes("--maintenance")||r.includes("maintenance"))return s("setup-check","Explicit --maintenance: Running maintenance tasks"),{continue:!0,systemMessage:"Running maintenance tasks..."};if(!E(n))return s("setup-check","No marker file found - first run detected"),(e.hook_event||process.env.HOOK_EVENT)==="Setup"?{continue:!0,systemMessage:"First run detected. Running setup..."}:h("OrchestKit setup not complete. Run 'claude --init' to configure the plugin.");switch(s("setup-check","Marker file exists - running quick validation"),Yt(t)){case 0:if(Xt(n)){s("setup-check","Maintenance due - queueing background tasks");let u=`${o}/setup-maintenance.sh`;E(u)&&Z(u,["--background"],{detached:!0,stdio:"ignore"}).unref()}return s("setup-check","Setup check passed (fast path)"),m();case 1:s("setup-check","Validation failed - triggering self-healing repair");let c=`${o}/setup-repair.sh`;return E(c)&&Z(c,[],{detached:!0,stdio:"ignore"}).unref(),h("OrchestKit setup validation failed. Repair running in background.");case 2:s("setup-check","Version mismatch - running migration");let a=`${o}/setup-maintenance.sh`;return E(a)&&Z(a,["--migrate"],{detached:!0,stdio:"ignore"}).unref(),Zt(n,"version",H),h(`OrchestKit upgraded to v${H}.`);default:return m()}}import{existsSync as C,mkdirSync as Qt,readFileSync as ee,writeFileSync as en,renameSync as xe,readdirSync as w,unlinkSync as F,statSync as R,chmodSync as tn}from"node:fs";import{execSync as j}from"node:child_process";function A(){return!!(process.env.CLAUDE_CODE_TEAM_NAME||process.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS==="1")}var N="4.25.0",v=[];function He(e,t){if(!C(e))return null;try{return JSON.parse(ee(e,"utf-8"))[t.replace(/^\./,"")]}catch{return null}}function te(e,t,n){if(C(e))try{let o=JSON.parse(ee(e,"utf-8"));o[t.replace(/^\./,"")]=n,en(e,JSON.stringify(o,null,2))}catch{}}function nn(e){if(!e)return 999;try{let t=new Date(e).getTime();return(Date.now()-t)/(1e3*60*60)}catch{return 999}}function on(e){s("setup-maintenance","Task: Log rotation");let t=[`${e}/.claude/logs`,`${P()}/.claude/logs/ork`],n=0;for(let o of t)if(C(o))try{let r=w(o);for(let c of r){if(!c.endsWith(".log"))continue;let a=`${o}/${c}`;try{if(R(a).size>204800){let p=`${a}.old.${Date.now()}`;xe(a,p),n++;try{j(`gzip "${p}"`,{stdio:["pipe","pipe","pipe"]})}catch{}}}catch{}}let i=r.filter(c=>c.includes(".log.old.")).sort().reverse();for(let c of i.slice(5))try{F(`${o}/${c}`)}catch{}}catch{}n>0&&v.push(`Rotated ${n} log files`)}function rn(e){s("setup-maintenance","Task: Stale lock cleanup");let t=`${e}/.claude/coordination/.claude.db`,n=0;if(C(t)&&!A())try{j(`sqlite3 "${t}" "DELETE FROM file_locks WHERE datetime(acquired_at) < datetime('now', '-24 hours');"`,{timeout:5e3,stdio:["pipe","pipe","pipe"]});let o=j(`sqlite3 "${t}" "SELECT COUNT(*) FROM file_locks;"`,{encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();s("setup-maintenance",`Coordination locks remaining: ${o}`),n=1}catch{}try{let o=(r,i=0)=>{if(!(i>3))try{let c=w(r,{withFileTypes:!0});for(let a of c){let u=`${r}/${a.name}`;if(a.isDirectory()&&!a.name.startsWith("."))o(u,i+1);else if(a.name.endsWith(".lock"))try{let p=R(u);(Date.now()-p.mtimeMs)/(1e3*60*60)>24&&(F(u),n++)}catch{}}}catch{}};o(e)}catch{}n>0&&v.push("Cleaned stale locks")}function sn(e){s("setup-maintenance","Task: Session cleanup");let t=`${e}/.claude/context/sessions`,n=`${e}/.claude/context/archive`;if(!C(t))return;let o=0;try{Qt(n,{recursive:!0});let i=w(t,{withFileTypes:!0});for(let c of i){if(!c.isDirectory())continue;let a=`${t}/${c.name}`;try{let u=R(a);(Date.now()-u.mtimeMs)/(1e3*60*60*24)>7&&(xe(a,`${n}/${c.name}`),o++)}catch{}}}catch{}let r=re();try{let i=w(r);for(let c of i){if(!c.startsWith("claude-session-"))continue;let a=`${r}/${c}`;try{let u=R(a);(Date.now()-u.mtimeMs)/(1e3*60*60*24)>7&&u.isDirectory()&&j(`rm -rf "${a}"`,{stdio:["pipe","pipe","pipe"]})}catch{}}}catch{}o>0&&v.push(`Archived ${o} old sessions`)}function cn(e){s("setup-maintenance","Task: Memory Fabric cleanup");let t=0,n=`${e}/.claude/logs`;if(C(n))try{let r=w(n);for(let i of r){if(!i.startsWith(".mem0-pending-sync-"))continue;let c=`${n}/${i}`;try{let a=R(c);(Date.now()-a.mtimeMs)/(1e3*60*60*24)>7&&(F(c),t++)}catch{}}}catch{}let o=`${P()}/.claude/.mem0-pending-sync.json`;if(C(o))try{let r=R(o);(Date.now()-r.mtimeMs)/(1e3*60*60)>24&&(F(o),t++)}catch{}t>0&&v.push(`Cleaned ${t} Memory Fabric files`)}function an(e,t){s("setup-maintenance","Task: Full health validation");let n=0,o=0,r=(c,a=0)=>{if(!(a>4))try{let u=w(c,{withFileTypes:!0});for(let p of u){let f=`${c}/${p.name}`;if(p.isDirectory()&&!p.name.startsWith("."))r(f,a+1);else if(p.name.endsWith(".sh"))try{R(f).mode&73||(tn(f,493),o++)}catch{}}}catch{}};r(`${e}/hooks`),o>0&&(s("setup-maintenance",`WARN: ${o} hooks were not executable`),n++);let i=`${e}/.claude/defaults/config.json`;if(C(i))try{JSON.parse(ee(i,"utf-8"))}catch{s("setup-maintenance","WARN: config.json is invalid"),n++}te(t,"last_health_check",new Date().toISOString()),n===0?v.push("Health validation passed"):v.push(`Health validation found ${n} issues (auto-fixed)`)}function un(e){s("setup-maintenance","Task: Version migration");let t=He(e,"version");!t||t===N||(s("setup-maintenance",`Migrating from ${t} to ${N}`),te(e,"version",N),v.push(`Migrated from ${t} to ${N}`))}function Te(e){let t=S(),n=e.project_dir||k(),o=`${t}/.setup-complete`,r=process.argv,i="auto";r.includes("--force")?i="force":r.includes("--migrate")?i="migrate":r.includes("--background")&&(i="background"),s("setup-maintenance",`Maintenance starting (mode: ${i})`);let c=new Date().toISOString(),a=He(o,"last_maintenance"),u=nn(a),p=!1,f=!1;switch(i){case"force":p=!0,f=!0;break;case"migrate":un(o);break;case"background":case"auto":u>=24&&(p=!0),u>=168&&(f=!0);break}if(p&&(s("setup-maintenance","Running daily maintenance tasks"),on(t),rn(t),sn(t),cn(n)),f&&(s("setup-maintenance","Running weekly maintenance tasks"),an(t,o)),te(o,"last_maintenance",c),v.length>0){s("setup-maintenance",`Maintenance complete: ${v.length} tasks`);let l=`Completed: ${v.join(", ")}`;return i==="background"?m():h(`Maintenance: ${l}`)}return s("setup-maintenance","No maintenance tasks needed"),m()}import{existsSync as ne,mkdirSync as Pe,readFileSync as pn,writeFileSync as Me,renameSync as ln,readdirSync as U,statSync as mn,chmodSync as fn}from"node:fs";var dn="4.25.0",I=[],L=[],W=!1;function gn(e){let t=`${e}/.claude/defaults/config.json`,n=`${e}/.claude/defaults`;try{Pe(n,{recursive:!0})}catch{}if(ne(t))try{JSON.parse(pn(t,"utf-8"));return}catch{let r=`${t}.corrupt.${Date.now()}`;try{ln(t,r),s("setup-repair",`Backed up corrupt config to ${r}`),W=!0}catch{}}Me(t,JSON.stringify({preset:"complete",description:"Full AI-assisted development toolkit (restored by repair)",features:{skills:!0,agents:!0,hooks:!0,mcp:!0,coordination:!0,statusline:!0},hook_groups:{safety:!0,quality:!0,productivity:!0,observability:!0}},null,2)),I.push("config.json restored"),s("setup-repair","Restored default config.json")}function hn(e){let t=0,n=(o,r=0)=>{if(!(r>5))try{let i=U(o,{withFileTypes:!0});for(let c of i){let a=`${o}/${c.name}`;if(c.isDirectory()&&!c.name.startsWith("."))n(a,r+1);else if(c.name.endsWith(".sh"))try{mn(a).mode&73||(fn(a,493),t++)}catch{}}}catch{}};n(`${e}/hooks`),t>0&&(I.push(`${t} hook permissions fixed`),s("setup-repair",`Fixed permissions on ${t} hooks`))}function kn(e){let t=0,n=[`${e}/.claude/defaults`,`${e}/.claude/context/session`,`${e}/.claude/context/knowledge`,`${e}/.claude/logs`,...A()?[]:[`${e}/.claude/coordination`]];for(let o of n)if(!ne(o))try{Pe(o,{recursive:!0}),t++}catch{}t>0&&(I.push(`${t} directories created`),s("setup-repair",`Created ${t} missing directories`))}function yn(e){let t=new Date().toISOString(),n=0,o=0,r=0,i=(u,p,f=5)=>{let l=0,d=(g,$)=>{if(!($>f))try{let b=U(g,{withFileTypes:!0});for(let y of b){let x=`${g}/${y.name}`;y.isDirectory()&&!y.name.startsWith(".")?d(x,$+1):p.test(y.name)&&l++}}catch{}};return d(u,0),l};try{n=i(`${e}/hooks`,/\.sh$/),o=i(`${e}/skills`,/SKILL\.md$/),r=i(`${e}/agents`,/\.md$/)}catch{}let c={version:dn,setup_date:t,preset:"complete",repaired_at:t,components:{hooks:{count:n,valid:!0},skills:{count:o,valid:!0},agents:{count:r,valid:!0}},last_health_check:t,last_maintenance:t,environment:{os:process.platform},user_preferences:{onboarding_completed:!0,mcp_configured:!1,statusline_configured:!1}},a=`${e}/.setup-complete`;Me(a,JSON.stringify(c,null,2)),I.push("marker file regenerated"),s("setup-repair","Regenerated marker file")}function Sn(e){let t=0,n=0;try{n=(i=>{let c=0,a=(u,p)=>{if(!(p>4))try{let f=U(u,{withFileTypes:!0});for(let l of f){let d=`${u}/${l.name}`;l.isDirectory()&&!l.name.startsWith(".")?a(d,p+1):l.name.endsWith(".sh")&&c++}}catch{}};return a(i,0),c})(`${e}/hooks`)}catch{}n<20&&(s("setup-repair",`CRITICAL: Only ${n} hooks found (expected 50+)`),t++);let o=0;try{o=(i=>{let c=0,a=(u,p)=>{if(!(p>2))try{let f=U(u,{withFileTypes:!0});for(let l of f){let d=`${u}/${l.name}`;l.isDirectory()&&!l.name.startsWith(".")?a(d,p+1):l.name==="SKILL.md"&&c++}}catch{}};return a(i,0),c})(`${e}/skills`)}catch{}return o<50&&(s("setup-repair",`CRITICAL: Only ${o} skills found (expected 100+)`),t++),ne(`${e}/hooks/_lib/common.sh`)||(s("setup-repair","CRITICAL: hooks/_lib/common.sh missing"),t++),t>=2?(L.push("Multiple critical components missing - reinstall recommended"),W=!0,!1):!0}function Ae(e){let t=S();s("setup-repair","Setup repair starting"),kn(t),gn(t),hn(t),Sn(t)||s("setup-repair","WARN: Critical components missing, repair incomplete"),yn(t);let n="";return I.length>0&&(n=`Repairs: ${I.join(", ")}`),L.length>0&&(n=`${n?n+". ":""}Issues: ${L.join(", ")}`,W=!0),s("setup-repair",`Repair complete: ${I.length} repairs made, ${L.length} issues`),W&&n?h(`OrchestKit auto-repair: ${n}`):m()}var Ne={"setup/unified-dispatcher":ye,"setup/first-run-setup":$e,"setup/mem0-analytics-dashboard":be,"setup/mem0-backup-setup":_e,"setup/mem0-cleanup":De,"setup/monorepo-detector":Ie,"setup/setup-check":we,"setup/setup-maintenance":Te,"setup/setup-repair":Ae};function ur(e){return Ne[e]}function pr(){return Object.keys(Ne)}export{to as escapeRegex,mt as estimateTokenCount,Ln as getCachedBranch,jn as getEnvFile,Qn as getField,ur as getHook,me as getLogDir,ct as getLogLevel,S as getPluginRoot,k as getProjectDir,B as getSessionId,Ne as hooks,vn as isBashInput,bn as isEditInput,_n as isReadInput,$n as isWriteInput,pr as listHooks,s as logHook,Yn as logPermissionFeedback,eo as normalizeCommand,Un as normalizeLineEndings,Jn as outputAllowWithContext,Kn as outputBlock,zn as outputDeny,Bn as outputError,ut as outputPromptContext,Xn as outputPromptContextBudgeted,Wn as outputSilentAllow,m as outputSilentSuccess,qn as outputWarning,h as outputWithContext,Vn as outputWithNotification,Gn as outputWithUpdatedInput,Zn as readHookInput,at as shouldLog};
//# sourceMappingURL=setup.mjs.map
