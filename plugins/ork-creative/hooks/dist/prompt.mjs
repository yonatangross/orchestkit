// OrchestKit Hooks - prompt bundle
// Generated: 2026-02-14T07:56:32.822Z

var ve=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});function ps(e){return typeof e.command=="string"}function gs(e){return typeof e.file_path=="string"&&typeof e.content=="string"}function fs(e){return typeof e.file_path=="string"&&typeof e.old_string=="string"&&typeof e.new_string=="string"}function ms(e){return typeof e.file_path=="string"&&e.content===void 0}import{appendFileSync as Pe,existsSync as De,statSync as hn,renameSync as yn,mkdirSync as bn,readSync as kn}from"node:fs";import{execSync as _n}from"node:child_process";import Yt from"node:os";import L from"node:path";function D(){return process.env.HOME||process.env.USERPROFILE||Yt.homedir()}function re(){return process.env.CLAUDE_PROJECT_DIR||"."}function Ie(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function Re(){return process.env.CLAUDE_PLUGIN_ROOT?L.join(D(),".claude","logs","ork"):L.join(re(),".claude","logs")}var ks=L.join,_s=L.sep;import{execSync as Qt}from"node:child_process";import{createHash as Zt}from"node:crypto";import{existsSync as Ee,readFileSync as en,writeFileSync as tn,mkdirSync as nn}from"node:fs";import{join as oe,basename as rn}from"node:path";var on=20,sn=15,an=/[^a-z0-9-]/g;function cn(e){let t=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=rn(t);return Ce(n,on)}function un(e){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let t=e||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=Qt("git branch --show-current",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),r=Ce(n||"detached",sn);return process.env.ORCHESTKIT_SESSION_BRANCH=r,r}catch{return"nobranch"}}function ln(e){let t=e||new Date,n=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");return`${n}${r}`}function dn(e){let t=e||new Date,n=String(t.getHours()).padStart(2,"0"),r=String(t.getMinutes()).padStart(2,"0");return`${n}${r}`}function pn(){let e=`${process.pid}-${Date.now()}-${Math.random()}`;return Zt("sha256").update(e).digest("hex").slice(0,4)}function Ce(e,t){return e.toLowerCase().replace(an,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,t)}function gn(e,t){let n=cn(e),r=un(e),o=ln(t),i=dn(t),s=pn();return`${n}-${r}-${o}-${i}-${s}`}function fn(e){let t=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=oe(t,".instance","session-id.json");if(Ee(n))try{let r=JSON.parse(en(n,"utf8"));if(r.session_id&&r.created_at){let o=Date.now()-new Date(r.created_at).getTime(),i=1440*60*1e3;if(o<i)return r.session_id}}catch{}}function mn(e,t){let n=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),r=oe(n,".instance"),o=oe(r,"session-id.json");try{Ee(r)||nn(r,{recursive:!0}),tn(o,JSON.stringify({session_id:e,created_at:new Date().toISOString()},null,2))}catch{}}function Ae(e){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let t=fn(e);if(t)return t;let n=gn(e);return mn(n,e),n}function $e(){return Re()}function g(){return re()}function ie(){return Ie()}function Ps(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${ie()}/.claude/.instance_env`}function y(){return Ae()}function Ds(e){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let t=_n("git branch --show-current",{cwd:e||g(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=t,t}catch{return"unknown"}}function Sn(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function $s(e){return e.replace(/\r\n/g,`
`)}function wn(e){let t=["debug","info","warn","error"];return t.indexOf(e)>=t.indexOf(Sn())}function l(){return{continue:!0,suppressOutput:!0}}function Os(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function js(e){return{continue:!1,stopReason:e,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:e}}}function Ms(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:e}}}function b(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:e}}}function Ns(e,t){let n={continue:!0,suppressOutput:!0};return e&&(n.systemMessage=e),t&&(n.hookSpecificOutput={hookEventName:"UserPromptSubmit",additionalContext:t}),n}function Hs(e,t){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:e,permissionDecision:"allow"}};return t?n.systemMessage=t:n.suppressOutput=!0,n}function Ls(e){return{continue:!0,systemMessage:e}}function Fs(e){return{continue:!0,systemMessage:`\u26A0 ${e}`}}function Us(e){process.stderr.write(`\u26A0 ${e}
`),process.exit(2)}function Gs(e){return{continue:!1,stopReason:e,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:e}}}function Bs(e){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:e}}}var xn=200*1024,Tn=100*1024;function Oe(e,t){if(De(e))try{if(hn(e).size>t){let r=`${e}.old.${Date.now()}`;yn(e,r)}}catch{}}function je(e){De(e)||bn(e,{recursive:!0})}function c(e,t,n="debug"){if(!wn(n))return;let r=$e(),o=`${r}/hooks.log`;try{je(r),Oe(o,xn);let i=new Date().toISOString().replace("T"," ").slice(0,19);Pe(o,`[${i}] [${n.toUpperCase()}] [${e}] ${t}
`)}catch{}}function zs(e,t,n){let r=$e(),o=`${r}/permission-feedback.log`;try{je(r),Oe(o,Tn);let i=new Date().toISOString(),s=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",a=n?.session_id||y();Pe(o,`${i} | ${e} | ${t} | tool=${s} | session=${a}
`)}catch{}}function se(e){if(!e)return 0;let r=(e.match(/[{};()=><]/g)||[]).length/e.length>.03?2.8:3.5;return Math.ceil(e.length/r)}function qs(e,t,n,r,o){let i=se(e);return r&&r.isOverBudget(n)?(c(t,`Budget exhausted for ${n}, suppressing ${i}t`),l()):(o&&o.trackTokenUsage(t,n,i),b(e))}function Ws(){try{let e=[],n=Buffer.allocUnsafe(256),r,o=0;for(;;)try{if(r=kn(o,n,0,256,null),r===0)break;e.push(Buffer.from(n.subarray(0,r)))}catch{break}let i=Buffer.concat(e).toString("utf8").trim();return i?JSON.parse(i):{tool_name:"",session_id:y(),tool_input:{}}}catch{return{tool_name:"",session_id:y(),tool_input:{}}}}function Js(e,t){let n=t.replace(/^\./,"").split("."),r=e;for(let o of n){if(r==null)return;r=r[o]}return r}function Ks(e){return e.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function Xs(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var $={AUTO_DISPATCH:85,SKILL_INJECT:80,STRONG_RECOMMEND:70,SUGGEST:50,MINIMUM:40},Ys={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};import{existsSync as vn,readFileSync as Me,readdirSync as Ne}from"node:fs";import{join as B}from"node:path";var F={keyword:30,phrase:25,context:20,cooccurrence:15,negation:10},In=[/\b(not|don't|doesn't|won't|can't|shouldn't|avoid|without|except|unlike|instead of)\s+/i,/\b(no|never|neither|nor)\s+/i],Rn=["continue","also","additionally","and","then","next","follow up","after that"],U=null,ae=null;function En(e){if(U&&ae===e)return U;let t=new Map;try{let n=Ne(e).filter(r=>r.endsWith(".md"));for(let r of n){let o=r.replace(".md",""),i=B(e,r);try{let a=Me(i,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!a)continue;let u=a[1],p=u.match(/^description:\s*(.+)$/m);if(!p)continue;let d=p[1].trim(),f=d.match(/Activates for\s+(.+?)\.?$/i),m=f?d.slice(0,d.indexOf("Activates for")).trim():d,h=[],T=[];if(f){let w=f[1].split(/,\s*/).map(k=>k.trim().toLowerCase());for(let k of w)k.includes(" ")||k.includes("-")?T.push(k):k.length>1&&h.push(k)}let v=u.match(/^skills:\s*\n((?:\s+-\s+.+\n?)+)/m),I;v&&(I=v[1].split(`
`).map(S=>S.replace(/^\s*-\s*/,"").trim()).filter(Boolean)),(h.length>0||T.length>0)&&t.set(o,{keywords:h,phrases:T,description:m||d.split(".")[0],skills:I})}catch{}}}catch{c("intent-classifier","Could not read agents directory")}return U=t,ae=e,t}var G=null,ce=null;function Cn(e){if(G&&ce===e)return G;let t=new Map;try{let n=Ne(e,{withFileTypes:!0}).filter(r=>r.isDirectory()).map(r=>r.name);for(let r of n){let o=B(e,r,"SKILL.md");if(vn(o))try{let s=Me(o,"utf8").match(/^---\n([\s\S]*?)\n---/);if(!s)continue;let a=s[1],u=a.match(/^description:\s*(.+)$/m),p=u?u[1].trim():"",d=a.match(/^tags:\s*\[([^\]]+)\]/m),f=[];d&&(f=d[1].split(",").map(h=>h.trim().toLowerCase().replace(/["']/g,"")).filter(h=>h.length>1));let m=p.toLowerCase().split(/\s+/).filter(h=>h.length>4).slice(0,5);f=[...new Set([...f,...m])],(f.length>0||p)&&t.set(r,{keywords:f,description:p})}catch{}}}catch{c("intent-classifier","Could not read skills directory")}return G=t,ce=e,t}function An(e,t){let n=0,r=[],o=[];for(let s of t)if(new RegExp(`\\b${s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"i").test(e)){let u=s.length>5?25:20;n+=u,r.push(s),o.push({type:"keyword",source:"keyword-match",weight:u,matched:s})}let i=t.length*25;return{score:i>0?Math.min(n/i*100,100):0,matched:r,signals:o}}function Pn(e,t){let n=0,r=[],o=[];for(let s of t)if(e.includes(s)){let a=s.split(/\s+/).length*15;n+=a,r.push(s),o.push({type:"phrase",source:"phrase-match",weight:a,matched:s})}let i=t.length*45;return{score:i>0?Math.min(n/i*100,100):0,matched:r,signals:o}}function Dn(e,t,n){if(n.length===0)return{score:0,signals:[]};let r=[],o=0;for(let s of Rn)if(e.includes(s)){o+=15,r.push({type:"context",source:"continuation-keyword",weight:15,matched:s});break}let i=n.slice(-3).join(" ").toLowerCase();for(let s of t.slice(0,5))i.includes(s)&&(o+=20,r.push({type:"context",source:"history-keyword",weight:20,matched:s}));return{score:Math.min(o,100),signals:r}}function $n(e){let t=[],n=0;for(let r of In)if(r.test(e)){n=25,t.push({type:"negation",source:"negation-detected",weight:-25,matched:e.match(r)?.[0]||"negation"});break}return{penalty:n,signals:t}}function On(e,t,n){if(n.length===0)return{adjustment:0,signals:[]};let r=0,o=[];for(let i of n)i.agent===e&&t.includes(i.keyword)&&(r+=i.adjustment,o.push({type:i.adjustment>0?"boost":"penalty",source:"calibration",weight:i.adjustment,matched:`${i.keyword}:${e}`}));return{adjustment:r,signals:o}}function jn(e,t,n,r,o){let i=[],s=[],a=An(e,n.keywords);i.push(...a.signals),s.push(...a.matched);let u=Pn(e,n.phrases);i.push(...u.signals),s.push(...u.matched);let p=Dn(e,n.keywords,r);i.push(...p.signals);let d=$n(e);i.push(...d.signals);let f=On(t,s,o);i.push(...f.signals);let m=a.score*(F.keyword/100)+u.score*(F.phrase/100)+p.score*(F.context/100);return m-=d.penalty*(F.negation/100),m+=Math.max(-15,Math.min(15,f.adjustment)),m=Math.max(0,Math.min(100,m)),m<$.MINIMUM?null:{agent:t,confidence:Math.round(m),description:n.description,matchedKeywords:s,signals:i}}function Mn(e,t,n){let r=[],o=[],i=0;for(let s of n.keywords)if(new RegExp(`\\b${s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"i").test(e)){let u=s.length>5?25:20;i+=u,o.push(s),r.push({type:"keyword",source:"skill-keyword",weight:u,matched:s})}return i=Math.min(i,100),i<$.MINIMUM?null:{skill:t,confidence:Math.round(i),description:n.description,matchedKeywords:o,signals:r}}function ra(e,t=[],n=[]){let r=ie(),o=B(r,"agents"),i=B(r,"skills"),s=e.toLowerCase(),a=[],u=[],p=[],d=En(o);for(let[S,w]of d){let k=jn(s,S,w,t,n);k&&(u.push(k),a.push(...k.signals))}let f=Cn(i);for(let[S,w]of f){let k=Mn(s,S,w);k&&(p.push(k),a.push(...k.signals))}u.sort((S,w)=>w.confidence-S.confidence),p.sort((S,w)=>w.confidence-S.confidence);let m=u[0],h=m?Nn(m.agent,m.matchedKeywords):"general",T=Math.max(m?.confidence||0,p[0]?.confidence||0),v=m!==void 0&&m.confidence>=$.AUTO_DISPATCH,I=p.length>0&&p[0].confidence>=$.SKILL_INJECT;return{agents:u.slice(0,3),skills:p.slice(0,5),intent:h,confidence:T,signals:a,shouldAutoDispatch:v,shouldInjectSkills:I}}function Nn(e,t){let n={"api-design":["api","endpoint","rest","graphql","route"],database:["database","schema","migration","sql","query"],authentication:["auth","login","jwt","oauth","session"],frontend:["react","component","ui","form","state"],testing:["test","coverage","mock","fixture","e2e"],devops:["deploy","ci","cd","release","monitor"],"ai-integration":["llm","rag","embedding","langgraph","agent"],security:["security","owasp","xss","injection","csrf"]};for(let[r,o]of Object.entries(n))for(let i of t)if(o.includes(i))return r;return e.includes("backend")||e.includes("api")?"api-design":e.includes("frontend")||e.includes("ui")?"frontend":e.includes("test")?"testing":e.includes("security")?"security":"general"}function oa(e){return!(e.length<10||/what agents|list agents|available agents|what skills/i.test(e)||/^(yes|no|ok|thanks|done|continue|stop)$/i.test(e.trim()))}function ia(){U=null,ae=null,G=null,ce=null}import{existsSync as O,readFileSync as Le,writeFileSync as Fe,mkdirSync as Hn}from"node:fs";function ue(){return`${g()}/.claude/orchestration`}function le(){let e=y();return`${ue()}/session-${e}.json`}function Ue(){return`${g()}/.claude/orchestration/config.json`}function Ge(){let e=ue();if(!O(e))try{Hn(e,{recursive:!0})}catch{c("orchestration-state",`Failed to create state dir: ${e}`)}}function R(){let e=le();if(O(e))try{let t=Le(e,"utf8");return JSON.parse(t)}catch(t){c("orchestration-state",`Failed to load state: ${t}`)}return{sessionId:y(),activeAgents:[],injectedSkills:[],promptHistory:[],maxHistorySize:10,updatedAt:new Date().toISOString()}}function Ln(e){Ge();let t=le();e.updatedAt=new Date().toISOString();try{Fe(t,JSON.stringify(e,null,2))}catch(n){c("orchestration-state",`Failed to save state: ${n}`)}}function A(e){let t=R();return e(t),Ln(t),t}function ua(e,t,n){let r={agent:e,taskId:n,confidence:t,dispatchedAt:new Date().toISOString(),status:"pending",retryCount:0,maxRetries:3};return A(o=>{o.activeAgents=o.activeAgents.filter(i=>i.agent!==e),o.activeAgents.push(r)}),c("orchestration-state",`Tracked dispatched agent: ${e} (conf: ${t})`),r}function la(e,t,n){A(r=>{let o=r.activeAgents.find(i=>i.agent===e);o&&(o.status=t,n&&(o.taskId=n),t==="retrying"&&o.retryCount++)}),c("orchestration-state",`Updated agent status: ${e} -> ${t}`)}function da(e){A(t=>{t.activeAgents=t.activeAgents.filter(n=>n.agent!==e)})}function pa(){return R().activeAgents.find(t=>t.status==="in_progress")}function ga(e){return R().activeAgents.some(n=>n.agent===e&&(n.status==="pending"||n.status==="in_progress"))}function fa(e){A(t=>{t.injectedSkills.includes(e)||t.injectedSkills.push(e)})}function ma(e){return R().injectedSkills.includes(e)}function ha(){return R().injectedSkills}function ya(e){A(t=>{t.promptHistory.push(e),t.promptHistory.length>t.maxHistorySize&&(t.promptHistory=t.promptHistory.slice(-t.maxHistorySize))})}function ba(){return R().promptHistory}function ka(e){A(t=>{t.lastClassification=e})}function _a(){return R().lastClassification}var He={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function de(){let e=Ue();if(O(e))try{let t=Le(e,"utf8");return{...He,...JSON.parse(t)}}catch{}return He}function Sa(e){Ge();let t=Ue(),r={...de(),...e};try{Fe(t,JSON.stringify(r,null,2))}catch(o){c("orchestration-state",`Failed to save config: ${o}`)}}function wa(){let e=le();try{if(O(e)){let{unlinkSync:t}=ve("node:fs");t(e),c("orchestration-state","Cleared session state")}}catch{}}function xa(){let e=ue();if(O(e))try{let{readdirSync:t,statSync:n,unlinkSync:r}=ve("node:fs"),o=t(e).filter(i=>i.startsWith("session-")&&i.endsWith(".json")).map(i=>({name:i,path:`${e}/${i}`,mtime:n(`${e}/${i}`).mtime.getTime()})).sort((i,s)=>s.mtime-i.mtime);for(let i of o.slice(5))try{r(i.path),c("orchestration-state",`Cleaned up old state: ${i.name}`)}catch{}}catch{}}import{existsSync as Be,readFileSync as Fn,writeFileSync as Un,mkdirSync as Gn}from"node:fs";function ze(){let e=y();return`${g()}/.claude/orchestration/task-registry-${e}.json`}function Bn(){let e=`${g()}/.claude/orchestration`;if(!Be(e))try{Gn(e,{recursive:!0})}catch{}}function x(){let e=ze();if(Be(e))try{return JSON.parse(Fn(e,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:y(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function E(e){Bn();let t=ze();e.updatedAt=new Date().toISOString();try{Un(t,JSON.stringify(e,null,2))}catch(n){c("task-integration",`Failed to save registry: ${n}`)}}function zn(e,t){let r={"backend-system-architect":"Designing","frontend-ui-developer":"Building","test-generator":"Writing tests for","security-auditor":"Auditing","workflow-architect":"Architecting","database-engineer":"Implementing database for","llm-integrator":"Integrating LLM for","code-quality-reviewer":"Reviewing","ux-researcher":"Researching UX for","product-strategist":"Strategizing","debug-investigator":"Investigating","frontend-performance-engineer":"Optimizing","accessibility-specialist":"Auditing accessibility for","infrastructure-architect":"Designing infrastructure for","data-pipeline-engineer":"Building pipeline for"}[e]||"Working on",o=t.slice(0,40).toLowerCase();return`${r} ${o}`}function Ra(e,t,n,r){let o=e.split("-").map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "),i={source:"orchestration",dispatchedAgent:e,dispatchConfidence:n,...r};return{subject:`${o}: ${t.slice(0,50)}`,description:`Agent dispatched automatically at ${n}% confidence.

${t}`,activeForm:zn(e,t),metadata:i}}function Ea(e,t,n,r){let o={taskId:e,status:t};return n&&n.length>0&&(o.addBlockedBy=n),r&&r.length>0&&(o.addBlocks=r),o}function Ca(e){return`### Create Task for Tracking

\`\`\`
TaskCreate:
  subject: "${e.subject}"
  description: "${e.description}"
  activeForm: "${e.activeForm}"
  metadata:
    source: "${e.metadata.source}"
    dispatchedAgent: "${e.metadata.dispatchedAgent||""}"
    dispatchConfidence: ${e.metadata.dispatchConfidence||0}
\`\`\``}function Aa(e,t){return{taskId:e,status:"deleted"}}function Pa(e,t){return`### Delete Orphaned Task

\`\`\`
TaskUpdate:
  taskId: "${e}"
  status: "deleted"
\`\`\`

**Reason**: ${t}`}function Da(e){let t=`### Update Task

\`\`\`
TaskUpdate:
  taskId: "${e.taskId}"`;return e.status&&(t+=`
  status: "${e.status}"`),e.addBlockedBy&&e.addBlockedBy.length>0&&(t+=`
  addBlockedBy: ${JSON.stringify(e.addBlockedBy)}`),e.addBlocks&&e.addBlocks.length>0&&(t+=`
  addBlocks: ${JSON.stringify(e.addBlocks)}`),t+="\n```",t}function qe(e,t,n,r,o,i,s){let a=x();if(a.tasks.find(p=>p.taskId===e)){c("task-integration",`Task ${e} already registered`);return}a.tasks.push({taskId:e,agent:t,confidence:n,createdAt:new Date().toISOString(),status:"pending",pipelineId:r,pipelineStep:o,blockedBy:i,blocks:s}),E(a),c("task-integration",`Registered task ${e} for agent ${t}`)}function $a(e,t){let n=x(),r=n.tasks.find(o=>o.taskId===e);r&&(r.status=t,E(n),c("task-integration",`Updated task ${e} status to ${t}`))}function Oa(e){return x().tasks.find(n=>n.agent===e&&(n.status==="pending"||n.status==="in_progress"))}function ja(e){return x().tasks.find(n=>n.taskId===e)}function Ma(e){return x().tasks.filter(n=>n.status==="pending"&&n.blockedBy&&n.blockedBy.includes(e))}function Na(){let e=x(),t=new Set(e.tasks.filter(n=>n.status==="failed").map(n=>n.taskId));return t.size===0?[]:e.tasks.filter(n=>n.status!=="pending"||!n.blockedBy||n.blockedBy.length===0?!1:n.blockedBy.every(r=>t.has(r)))}function qn(e){return x().tasks.filter(n=>n.pipelineId===e).sort((n,r)=>(n.pipelineStep||0)-(r.pipelineStep||0))}function We(e){let t=x();if(t.pipelines.find(r=>r.pipelineId===e.pipelineId)){c("task-integration",`Pipeline ${e.pipelineId} already registered`);return}t.pipelines.push(e),E(t),c("task-integration",`Registered pipeline ${e.pipelineId} (${e.type})`)}function Ha(e,t){let n=x(),r=n.pipelines.find(o=>o.pipelineId===e);r&&(Object.assign(r,t),E(n),c("task-integration",`Updated pipeline ${e}`))}function Je(){return x().pipelines.find(t=>t.status==="running")}function La(e,t){let n=x(),r=n.pipelines.find(i=>i.pipelineId===e);if(!r)return null;r.completedSteps.includes(t)||(r.completedSteps.push(t),r.completedSteps.sort((i,s)=>i-s));let o=qn(e);for(let i of o){let s=i.pipelineStep;if(s===void 0||r.completedSteps.includes(s)||i.status!=="pending")continue;if(s===0||r.completedSteps.includes(s-1))return r.currentStep=s,E(n),s}return r.status="completed",E(n),null}function Fa(e=1440*60*1e3){let t=x(),n=Date.now()-e;t.tasks=t.tasks.filter(r=>r.status==="pending"||r.status==="in_progress"?!0:new Date(r.createdAt).getTime()>n),t.pipelines=t.pipelines.filter(r=>r.status==="running"?!0:new Date(r.startedAt).getTime()>n),E(t)}var Wn=3,Jn=1e3,Kn=3e4,Xn={"backend-system-architect":["database-engineer","api-designer"],"frontend-ui-developer":["rapid-ui-designer","accessibility-specialist"],"test-generator":["debug-investigator","code-quality-reviewer"],"security-auditor":["security-layer-auditor"],"workflow-architect":["llm-integrator","data-pipeline-engineer"]},Vn=[/permission denied/i,/access denied/i,/not found.*(?:file|module|package)/i,/(?:file|module|package)\s+not\s+found/i,/missing required/i,/invalid (?:api|token|key)/i,/authentication failed/i,/quota exceeded/i,/rate limit/i],Yn=[/not my specialization/i,/outside my scope/i,/better suited for/i,/consider using/i,/specialized agent/i];function Qn(e,t=Jn){let n=t*Math.pow(2,e-1),r=Math.random()*.1*n;return Math.min(n+r,Kn)}function Zn(e){for(let t of Vn)if(t.test(e))return!1;return!0}function er(e){for(let t of Yn)if(t.test(e))return!0;return!1}function pe(e,t=[]){let n=Xn[e];if(n){for(let r of n)if(!t.includes(r))return r}}function Ba(e,t,n,r=[],o=Wn){if(c("retry-manager",`Evaluating retry for ${e}, attempt ${t}`),t>=o){let s=pe(e,r);return{shouldRetry:!1,retryCount:t,maxRetries:o,alternativeAgent:s,reason:`Max retries (${o}) exceeded`+(s?`. Consider trying ${s} instead.`:"")}}if(!Zn(n)){let s=pe(e,r);return{shouldRetry:!1,retryCount:t,maxRetries:o,alternativeAgent:s,reason:`Non-retryable error detected: ${n.slice(0,100)}`}}if(er(n)){let s=pe(e,r);if(s)return{shouldRetry:!1,retryCount:t,maxRetries:o,alternativeAgent:s,reason:`Error suggests using alternative agent: ${s}`}}let i=Qn(t);return{shouldRetry:!0,retryCount:t,maxRetries:o,delayMs:i,reason:`Retrying (attempt ${t+1}/${o}) after ${Math.round(i/1e3)}s`}}function za(e,t,n){return{agent:e,taskId:n,attemptNumber:t,startedAt:new Date().toISOString()}}function qa(e,t,n){let r=new Date().toISOString(),o=new Date(r).getTime()-new Date(e.startedAt).getTime();return{...e,completedAt:r,outcome:t,error:n,durationMs:o}}function Wa(e){if(e.length===0)return{successRate:0,avgDuration:0,commonErrors:[]};let n=e.filter(a=>a.outcome==="success").length/e.length,r=e.filter(a=>a.durationMs!==void 0).map(a=>a.durationMs),o=r.length>0?r.reduce((a,u)=>a+u,0)/r.length:0,i=new Map;for(let a of e)if(a.error){let u=a.error.slice(0,50).toLowerCase();i.set(u,(i.get(u)||0)+1)}let s=Array.from(i.entries()).sort((a,u)=>u[1]-a[1]).slice(0,3).map(([a])=>a);return{successRate:n,avgDuration:o,commonErrors:s}}function Ja(e,t){return{...e,status:"retrying",retryCount:t.retryCount}}function Ka(e,t){if(e.shouldRetry)return`## Retry Scheduled

Agent \`${t}\` will retry after ${Math.round((e.delayMs||0)/1e3)} seconds.

**Attempt:** ${e.retryCount+1} of ${e.maxRetries}
**Reason:** ${e.reason}`;let n=`## Retry Not Recommended

Agent \`${t}\` has ${e.retryCount>=e.maxRetries?"exhausted retries":"encountered a non-retryable error"}.

**Reason:** ${e.reason}`;return e.alternativeAgent&&(n+=`

### Alternative Suggestion

Consider using \`${e.alternativeAgent}\` instead:

\`\`\`
Task tool with subagent_type: "${e.alternativeAgent}"
\`\`\``),n}import{existsSync as Ye,readFileSync as tr,writeFileSync as nr,mkdirSync as rr}from"node:fs";import{createHash as or}from"node:crypto";var Ke=500,ge=3,Xe=15,Ve=3,ir=.9;function Qe(){return`${g()}/.claude/feedback/calibration-data.json`}function sr(){let e=`${g()}/.claude/feedback`;if(!Ye(e))try{rr(e,{recursive:!0})}catch{}}function j(){let e=Qe();if(Ye(e))try{return JSON.parse(tr(e,"utf8"))}catch{c("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function ar(e){sr();let t=Qe();e.updatedAt=new Date().toISOString();try{nr(t,JSON.stringify(e,null,2)),c("calibration-engine","Saved calibration data")}catch(n){c("calibration-engine",`Failed to save calibration data: ${n}`)}}function cr(e){return or("sha256").update(e.toLowerCase().trim()).digest("hex").slice(0,16)}function Za(e,t,n,r,o,i,s){let a=j(),u={timestamp:new Date().toISOString(),sessionId:y(),agent:t,promptHash:cr(e),matchedKeywords:n,dispatchConfidence:r,outcome:o,durationMs:i,feedback:s};a.records.push(u),a.records.length>Ke&&(a.records=a.records.slice(-Ke)),ur(a,u),lr(a),ar(a),c("calibration-engine",`Recorded outcome: ${t} -> ${o} (conf: ${r})`)}function ur(e,t){let n=t.outcome==="success",r=t.outcome==="failure"||t.outcome==="rejected";if(!n&&!r)return;let o=n?Ve:-Ve;for(let i of t.matchedKeywords){let s=e.adjustments.find(a=>a.keyword===i&&a.agent===t.agent);s?(s.adjustment=Math.max(-Xe,Math.min(Xe,s.adjustment+o)),s.sampleCount++,s.lastUpdated=new Date().toISOString()):e.adjustments.push({keyword:i,agent:t.agent,adjustment:o,sampleCount:1,lastUpdated:new Date().toISOString()})}}function ec(e){let t=Date.now(),n=1440*60*1e3;for(let r of e.adjustments){let o=t-new Date(r.lastUpdated).getTime();Math.floor(o/n)>7&&(r.adjustment=Math.round(r.adjustment*ir),Math.abs(r.adjustment)<1&&(r.adjustment=0))}e.adjustments=e.adjustments.filter(r=>r.adjustment!==0)}function lr(e){let t=e.records;if(t.length===0)return;e.stats.totalDispatches=t.length;let n=t.filter(i=>i.outcome==="success").length;e.stats.successRate=n/t.length;let r=t.reduce((i,s)=>i+s.dispatchConfidence,0)/t.length;e.stats.avgConfidence=Math.round(r);let o=new Map;for(let i of t){let s=o.get(i.agent)||{count:0,success:0};s.count++,i.outcome==="success"&&s.success++,o.set(i.agent,s)}e.stats.topAgents=Array.from(o.entries()).map(([i,s])=>({agent:i,count:s.count,successRate:s.success/s.count})).sort((i,s)=>s.count-i.count).slice(0,10)}function tc(){return j().adjustments.filter(t=>t.sampleCount>=ge)}function nc(e){let n=j().records.filter(o=>o.agent===e);return n.length<ge?null:n.filter(o=>o.outcome==="success").length/n.length}function rc(){return j().stats}function oc(){return j().records.length>=ge}function Ze(){return!!(process.env.CLAUDE_CODE_TEAM_NAME||process.env.CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS==="1")}var et=[{type:"product-thinking",name:"Product Thinking Pipeline",description:"Full product discovery and specification workflow",triggers:["should we build","product decision","feature validation","market research","user research"],steps:[{agent:"market-intelligence",description:"Analyze competitive landscape and market trends",dependsOn:[],skills:["market-research"],estimatedTokens:3e3},{agent:"ux-researcher",description:"Create personas and map user journeys",dependsOn:[0],skills:["user-research"],estimatedTokens:2500},{agent:"product-strategist",description:"Validate value proposition and alignment",dependsOn:[0,1],skills:["product-strategy"],estimatedTokens:2e3},{agent:"prioritization-analyst",description:"Score and prioritize using frameworks",dependsOn:[2],skills:["prioritization"],estimatedTokens:1500},{agent:"business-case-builder",description:"Build ROI and cost-benefit analysis",dependsOn:[2,3],skills:["business-case"],estimatedTokens:2e3},{agent:"requirements-translator",description:"Transform to PRD and user stories",dependsOn:[4],skills:["requirements"],estimatedTokens:2500}],estimatedTotalTokens:13500},{type:"full-stack-feature",name:"Full-Stack Feature Pipeline",description:"End-to-end feature implementation workflow",triggers:["full-stack feature","build a feature","implement end-to-end","create full feature","add complete feature"],steps:[{agent:"backend-system-architect",description:"Design API and database schema",dependsOn:[],skills:["api-design","database-patterns"],estimatedTokens:3e3},{agent:"frontend-ui-developer",description:"Build React components and UI",dependsOn:[0],skills:["react-server-components-framework","form-state-patterns"],estimatedTokens:3500},{agent:"test-generator",description:"Create unit and integration tests",dependsOn:[0,1],skills:["testing-patterns"],estimatedTokens:2e3},{agent:"security-auditor",description:"Audit for vulnerabilities",dependsOn:[0,1],skills:["security-patterns"],estimatedTokens:1500}],estimatedTotalTokens:1e4},{type:"ai-integration",name:"AI Integration Pipeline",description:"Add AI/LLM capabilities to application",triggers:["add rag","add llm","ai integration","implement rag","add ai feature","langgraph workflow"],steps:[{agent:"workflow-architect",description:"Design LangGraph workflow and state",dependsOn:[],skills:["langgraph"],estimatedTokens:2500},{agent:"llm-integrator",description:"Connect LLM APIs with function calling",dependsOn:[0],skills:["llm-integration"],estimatedTokens:2e3},{agent:"data-pipeline-engineer",description:"Build embeddings and data pipeline",dependsOn:[0],skills:["embeddings","rag-retrieval"],estimatedTokens:2500},{agent:"test-generator",description:"Create LLM testing infrastructure",dependsOn:[1,2],skills:["testing-patterns"],estimatedTokens:1500}],estimatedTotalTokens:8500},{type:"security-audit",name:"Security Audit Pipeline",description:"Comprehensive security review workflow",triggers:["security audit","security review","vulnerability scan","security assessment"],steps:[{agent:"security-auditor",description:"Scan for OWASP Top 10 vulnerabilities",dependsOn:[],skills:["security-patterns"],estimatedTokens:2e3},{agent:"security-layer-auditor",description:"Verify defense-in-depth layers",dependsOn:[0],skills:["security-patterns"],estimatedTokens:2e3},{agent:"ai-safety-auditor",description:"Audit AI/LLM security if applicable",dependsOn:[0],skills:["mcp-security-hardening"],estimatedTokens:1500}],estimatedTotalTokens:5500},{type:"frontend-compliance",name:"Frontend 2026 Compliance Pipeline",description:"Modernize frontend to 2026 patterns",triggers:["frontend compliance","modernize frontend","update react","frontend 2026"],steps:[{agent:"frontend-ui-developer",description:"Upgrade to React 19 patterns",dependsOn:[],skills:["react-server-components-framework","zustand-patterns"],estimatedTokens:3e3},{agent:"frontend-performance-engineer",description:"Optimize Core Web Vitals",dependsOn:[0],skills:["performance"],estimatedTokens:2e3},{agent:"accessibility-specialist",description:"Ensure WCAG 2.2 compliance",dependsOn:[0],skills:["testing-patterns","accessibility"],estimatedTokens:1500}],estimatedTotalTokens:6500}];function tt(e){if(Ze())return c("multi-agent-coordinator","Agent Teams active \u2014 yielding pipeline detection to native Teams"),null;let t=e.toLowerCase();for(let n of et)for(let r of n.triggers)if(t.includes(r))return c("multi-agent-coordinator",`Detected pipeline: ${n.type} (trigger: "${r}")`),n;return null}function lc(e){return et.find(t=>t.type===e)||null}function nt(e){let t=`pipeline-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,n=[],r={};for(let i=0;i<e.steps.length;i++){let s=e.steps[i],a=`task-${t}-${i}`;r[i]=a;let u={source:"pipeline",dispatchedAgent:s.agent,pipelineId:t,pipelineStep:i,relatedSkills:s.skills},p=s.dependsOn.map(d=>r[d]).filter(Boolean);n.push({subject:`[${e.name}] Step ${i+1}: ${s.description}`,description:`Pipeline step: ${s.agent}

${s.description}

Estimated tokens: ${s.estimatedTokens}`,activeForm:`Running ${s.agent}`,metadata:u,blockedBy:p.length>0?p:void 0})}return{execution:{pipelineId:t,type:e.type,startedAt:new Date().toISOString(),taskIds:r,currentStep:0,completedSteps:[],status:"running"},tasks:n}}function rt(e,t){We(e);for(let n=0;n<t.length;n++){let r=t[n],o=e.taskIds[n];o&&r.metadata.dispatchedAgent&&qe(o,r.metadata.dispatchedAgent,r.metadata.dispatchConfidence||100,e.pipelineId,n)}c("multi-agent-coordinator",`Registered pipeline ${e.pipelineId} with ${t.length} tasks`)}function ot(e,t,n){let r=`## \u{1F504} Pipeline Detected: ${e.name}

${e.description}

**Pipeline ID:** \`${t.pipelineId}\`
**Estimated Total Tokens:** ~${e.estimatedTotalTokens}

### Pipeline Steps

`;for(let o=0;o<e.steps.length;o++){let i=e.steps[o],s=i.dependsOn.length>0?` (after steps: ${i.dependsOn.map(a=>a+1).join(", ")})`:" (can start immediately)";r+=`**${o+1}. ${i.agent}**${s}
   ${i.description}
   Skills: ${i.skills?.join(", ")||"none"}

`}r+=`### Task Creation Instructions

Create these tasks to track the pipeline:

`;for(let o=0;o<n.length;o++){let i=n[o];r+=`**Task ${o+1}:**
\`\`\`
TaskCreate:
  subject: "${i.subject}"
  activeForm: "${i.activeForm}"
${i.blockedBy?`  blockedBy: ${JSON.stringify(i.blockedBy)}`:""}
\`\`\`

`}return r+=`### Start Pipeline

After creating all tasks, spawn the first agent:

\`\`\`
Task tool with subagent_type: "${e.steps[0].agent}"
\`\`\`

The orchestration layer will track progress and suggest next agents as steps complete.`,r}import{existsSync as N,readFileSync as bt,writeFileSync as kt,mkdirSync as _t}from"node:fs";import{join as K,dirname as Pr}from"node:path";import{existsSync as dr,readFileSync as pr,writeFileSync as gc,mkdirSync as fc}from"node:fs";import{execSync as it}from"node:child_process";import{createHash as gr}from"node:crypto";import*as st from"node:os";var fr=".claude/.user_identity.json",mr="orchestkit-user-identity-v1";var _=null;function z(e){return gr("sha256").update(e+mr).digest("hex").slice(0,32)}function hr(){try{return st.hostname()}catch{return"unknown-machine"}}function yr(e){let t=`${e}/${fr}`;if(!dr(t))return null;try{let n=pr(t,"utf8");return JSON.parse(n)}catch(n){return c("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function br(e){let t={};try{t.email=it("git config user.email",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{t.name=it("git config user.name",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return t}function kr(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function q(e){if(_)return _;let t=e||g(),n=hr(),r=yr(t);if(r?.user_id)return _={user_id:r.user_id,display_name:r.display_name||r.user_id,team_id:r.team_id,machine_id:n,source:"config",anonymous_id:z(r.user_id),email:r.user_id.includes("@")?r.user_id:void 0},c("user-identity",`Resolved from config: ${_.anonymous_id}`,"debug"),_;let o=br(t);if(o.email)return _={user_id:o.email,display_name:o.name||o.email.split("@")[0],team_id:r?.team_id,machine_id:n,source:"git",anonymous_id:z(o.email),email:o.email},c("user-identity",`Resolved from git: ${_.anonymous_id}`,"debug"),_;let i=kr();if(i.username){let a=`${i.username}@${n}`;return _={user_id:a,display_name:i.username,team_id:r?.team_id,machine_id:n,source:"env",anonymous_id:z(a)},c("user-identity",`Resolved from env: ${_.anonymous_id}`,"debug"),_}let s=z(n+process.pid);return _={user_id:`anon-${s.slice(0,8)}`,display_name:"Anonymous",team_id:r?.team_id,machine_id:n,source:"anonymous",anonymous_id:s},c("user-identity",`Resolved as anonymous: ${_.anonymous_id}`,"debug"),_}function W(){let e=q();return{session_id:y(),user_id:e.user_id,anonymous_id:e.anonymous_id,team_id:e.team_id,machine_id:e.machine_id,identity_source:e.source,timestamp:new Date().toISOString()}}import{existsSync as ut,appendFileSync as _r,mkdirSync as Sr,readFileSync as wr,writeFileSync as xr}from"node:fs";var Tr=/^[a-zA-Z0-9_-]{1,128}$/;function vr(e){return Tr.test(e)}function he(e,t){let n=e||y(),r=t||g();if(!vr(n))throw new Error("Invalid session ID format");return`${r}/.claude/memory/sessions/${n}`}function Ir(e,t){return`${he(e,t)}/events.jsonl`}function lt(e,t){let n=he(e,t);ut(n)||Sr(n,{recursive:!0})}var M=0,at=!1,fe=!1,ct=0,Rr=5e3;function dt(e,t){return`${he(e,t)}/counter.json`}function Er(e,t){if(!at){at=!0;try{let n=dt(e,t);if(ut(n)){let r=JSON.parse(wr(n,"utf8"));typeof r.counter=="number"&&r.counter>0&&(M=r.counter,c("session-tracker",`Loaded event counter: ${M}`,"debug"))}}catch{}}}function Cr(e,t){if(!fe)return;let n=Date.now();if(!(n-ct<Rr))try{lt(e,t);let r=dt(e,t);xr(r,JSON.stringify({counter:M,updated_at:new Date().toISOString()})),fe=!1,ct=n}catch{}}function Ar(){return Er(),M++,fe=!0,Cr(),`evt-${Date.now()}-${M}`}function P(e,t,n={}){try{let r={event_id:Ar(),event_type:e,identity:W(),payload:{name:t,input:me(n.input),output:me(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?ht(n.context,500):void 0,confidence:n.confidence}};lt();let o=Ir();_r(o,JSON.stringify(r)+`
`),c("session-tracker",`Tracked ${e}: ${t}`,"debug")}catch(r){c("session-tracker",`Failed to track event: ${r}`,"warn")}}function pt(e,t,n){P("decision_made","decision",{context:e,input:t?{rationale:t}:void 0,confidence:n,success:!0})}function gt(e,t){P("preference_stated","preference",{context:e,confidence:t,success:!0})}function ft(e){P("problem_reported","problem",{context:e,success:!0})}function mt(e){P("communication_style_detected","communication",{input:e,success:!0})}function ht(e,t){return e.length<=t?e:e.slice(0,t-3)+"..."}function me(e){if(!e)return;let t={},n=["password","secret","token","key","credential","auth"];for(let[r,o]of Object.entries(e)){if(n.some(i=>r.toLowerCase().includes(i))){t[r]="[REDACTED]";continue}if(typeof o=="string"&&o.length>500){t[r]=ht(o,500);continue}if(typeof o=="object"&&o!==null&&!Array.isArray(o)){t[r]=me(o);continue}t[r]=o}return t}var J=2;var Dr={1:e=>({...e,version:2,tool_preferences:e.tool_preferences||{},tool_usage_by_category:e.tool_usage_by_category||{}})};function $r(e){let t=e.version||1;for(;t<J;){let n=Dr[t];if(!n){c("user-profile",`Missing migration for version ${t}`,"warn");break}e=n(e),t=e.version,c("user-profile",`Migrated profile to version ${t}`,"info")}return e}function Or(){return D()}function jr(){return K(Or(),".claude","orchestkit")}function St(e){let t=e.replace(/[^a-zA-Z0-9@._-]/g,"_");return K(jr(),"users",t)}function ye(e){return K(St(e),"profile.json")}function Mr(e){let t=e.replace(/[^a-zA-Z0-9@._-]/g,"_");return K(g(),".claude","memory","users",t,"profile.json")}function Nr(e){let t=Mr(e),n=ye(e);if(N(n))return!1;if(N(t))try{let r=Pr(n);N(r)||_t(r,{recursive:!0});let o=bt(t,"utf8"),i=JSON.parse(o);kt(n,JSON.stringify(i,null,2));let s=e.replace(/@.*$/,"@***");return c("user-profile",`Migrated profile for ${s} to cross-project storage`,"info"),!0}catch(r){return c("user-profile",`Failed to migrate profile: ${r}`,"warn"),!1}return!1}function yt(e){let t=q(),n=new Date().toISOString();return{user_id:e,anonymous_id:t.anonymous_id,display_name:t.display_name,team_id:t.team_id,sessions_count:0,first_seen:n,last_seen:n,version:J,skill_usage:{},agent_usage:{},tool_usage:{},decisions:[],preferences:[],workflow_patterns:[],aggregated_sessions:[]}}function wt(e){let t=e||q().user_id;Nr(t);let n=ye(t);if(!N(n))return yt(t);try{let r=bt(n,"utf8"),o=JSON.parse(r),i=$r(o);return(o.version||1)<J&&(Hr(i),c("user-profile",`Auto-saved migrated profile (v${J})`,"info")),i}catch(r){return c("user-profile",`Failed to load profile: ${r}`,"warn"),yt(t)}}function Hr(e){let t=St(e.user_id),n=ye(e.user_id);try{return N(t)||_t(t,{recursive:!0}),e.last_seen=new Date().toISOString(),kt(n,JSON.stringify(e,null,2)),c("user-profile",`Saved profile for ${e.anonymous_id}`,"debug"),!0}catch(r){return c("user-profile",`Failed to save profile: ${r}`,"error"),!1}}function xt(e,t=5){return Object.entries(e.skill_usage).map(([n,r])=>({skill:n,stats:r})).sort((n,r)=>r.stats.count-n.stats.count).slice(0,t)}function Tt(e,t=5){return Object.entries(e.agent_usage).map(([n,r])=>({agent:n,stats:r})).sort((n,r)=>r.stats.count-n.stats.count).slice(0,t)}function vt(e,t=10){return e.decisions.slice(0,t)}var be=1200,Lr=3,Fr=3,Ur=2,It=50,Gr=2;function Br(e,t=Lr){let n=xt(e,t);return n.length===0?"":n.map(r=>r.skill).join(", ")}function zr(e,t=Fr){let n=Tt(e,t);return n.length===0?"":n.map(r=>r.agent).join(", ")}function qr(e,t=Ur){let n=vt(e,t);return n.length===0?"":n.map(r=>r.what).map(r=>r.length>It?r.slice(0,It-3)+"...":r).join("; ")}function Wr(e,t=Gr){return e.preferences.length===0?"":e.preferences.slice(0,t).map(n=>`${n.category}: ${n.preference}`).join(", ")}function Jr(e){return e.sessions_count>0||Object.keys(e.skill_usage).length>0||Object.keys(e.agent_usage).length>0||e.decisions.length>0||e.preferences.length>0}function Kr(e){let t=[];t.push(`## User Profile Context
`);let n=e.display_name||"User";e.sessions_count>0?t.push(`Working with **${n}** (${e.sessions_count} sessions)`):t.push(`Working with **${n}**`);let r=Br(e);r&&t.push(`

**Preferred skills:** ${r}`);let o=zr(e);o&&t.push(`

**Frequently used agents:** ${o}`);let i=qr(e);i&&t.push(`

**Recent decisions:** ${i}`);let s=Wr(e);s&&t.push(`

**Preferences:** ${s}`);let a=t.join("");return a.length>be&&(a=a.slice(0,be-3)+"...",c("profile-injector",`Context truncated to ${be} chars`,"debug")),a}function Rt(e){c("profile-injector","Loading user profile for session context");try{let t=wt();if(!Jr(t))return c("profile-injector","Empty profile, skipping injection","debug"),l();let n=Kr(t);return c("profile-injector",`Injecting profile context for ${t.display_name} (${n.length} chars)`,"info"),b(n)}catch(t){return c("profile-injector",`Error loading profile: ${t}`,"warn"),l()}}import{existsSync as Xr,readFileSync as Vr}from"node:fs";import{join as Yr}from"node:path";var H="memory-context-loader",Qr=10,Zr=3e3;function eo(e,t){try{return Vr(e,"utf8").trim().split(`
`).filter(o=>o.length>0).slice(-t)}catch{return[]}}function to(e){let t=[];for(let n of e)try{let r=JSON.parse(n);r&&r.content&&r.content.what&&t.push(r)}catch{}return t}function no(e){let t=[];t.push("## Recent Project Decisions"),t.push("");for(let n of e){let o=`- **[${n.type==="preference"?"Preference":"Decision"}]** ${n.content.what}`;if(n.content.why&&(o+=` _(because: ${n.content.why})_`),n.entities.length>0&&(o+=` [${n.entities.join(", ")}]`),t.push(o),t.join(`
`).length>Zr){t.pop(),t.push("- _(additional decisions available via mcp__memory__search_nodes)_");break}}return t.push(""),t.push("_For deeper graph traversal: use mcp__memory__search_nodes or mcp__memory__open_nodes_"),t.join(`
`)}function Et(e){try{let t=e.project_dir||g(),n=Yr(t,".claude","memory","decisions.jsonl");if(!Xr(n))return c(H,"No decisions.jsonl found, skipping"),l();let r=eo(n,Qr);if(r.length===0)return c(H,"decisions.jsonl is empty, skipping"),l();let o=to(r);if(o.length===0)return c(H,"No valid decisions found in file"),l();o.reverse();let i=no(o);return c(H,`Loaded ${o.length} recent decisions as context`),b(i)}catch(t){return c(H,`Error loading memory context: ${t}`,"warn"),l()}}var ro=[/\b(let'?s use|let'?s go with|going with|will use|should use)\s+([^.,!?\n]+)/gi,/\b(decided on|decided to use|decided to go with|decided to)\s+([^.,!?\n]+)/gi,/\b(chose|choose|selected|opting for|picked)\s+([^.,!?\n]+)/gi,/\b(using)\s+([^.,!?\n]+)\s+for\s+/gi,/\b(chose|prefer|selected|going with)\s+([\w][\w\s-]*?)\s+over\s+([\w][\w\s-]*)/gi,/\b(chose|prefer|selected|going with)\s+([\w][\w\s-]*?)\s+instead of\s+([\w][\w\s-]*)/gi,/\b(implementing|implement)\s+([^.,!?\n]+?)\s+(?:approach|pattern|solution)/gi,/\b(?:the|our)\s+(?:approach|decision|choice)\s+is\s+([^.,!?\n]+)/gi,/\bI\s+(decided|chose)\s+([^.,!?\n]+)/gi],oo=[/\bi (prefer|like|always use|never use|want|favor)\s+([^.,!?\n]+)/gi,/\bi'd prefer\s+([^.,!?\n]+)/gi,/\b(my preference is|I'd rather|rather use)\s+([^.,!?\n]+)/gi,/\b(style should be|convention is|naming should)\s+([^.,!?\n]+)/gi,/\b(always|never)\s+(use|do|add|include)\s+([^.,!?\n]+)/gi,/\bdon't\s+(use|like|want)\s+([^.,!?\n]+)/gi],io=[/\b(issue|problem|error|bug|doesn't work|isn't working|can't|failing|broken)\b[^.!?\n]*[.!?]?/gi,/\bthe (\w[\w\s-]*) (is broken|isn't working|fails|errors|crashes)/gi,/\b(getting|seeing|having)\s+(an error|errors|issues|problems)\s+(with|in|when)\s+([^.,!?\n]+)/gi,/\b(fails|failed|failing)\s+(to|when|with)\s+([^.,!?\n]+)/gi,/\b(not working|doesn't work|won't work)\s*([^.,!?\n]*)/gi,/\b(timeout|exception|crash|hang|freeze)\s+(in|with|when|on)\s+([^.,!?\n]+)/gi],so=[/\bhow do I\s+([^?.\n]+)/gi,/\bhow can I\s+([^?.\n]+)/gi,/\bhow to\s+([^?.\n]+)/gi,/\bwhat is\s+([^?.\n]+)/gi,/\bwhat are\s+([^?.\n]+)/gi,/\bwhat does\s+([^?.\n]+)/gi,/\bwhy does\s+([^?.\n]+)/gi,/\bwhy is\s+([^?.\n]+)/gi,/\bwhy do\s+([^?.\n]+)/gi,/\bcan you\s+(explain|show|help)\s+([^?.\n]+)/gi,/\bwhere (is|are|do|does|can)\s+([^?.\n]+)/gi,/\bwhen (should|do|does|can)\s+([^?.\n]+)/gi],ao=[/\bbecause\s+([^.,!?\n]+)/i,/\bsince\s+([^.,!?\n]+)/i,/\bdue to\s+([^.,!?\n]+)/i,/\bto avoid\s+([^.,!?\n]+)/i,/\bfor\s+(?:better|improved|faster|easier|simpler)\s+([^.,!?\n]+)/i,/\bso that\s+([^.,!?\n]+)/i,/\bin order to\s+([^.,!?\n]+)/i,/\bas it\s+([^.,!?\n]+)/i],co=[/\b(?:must|need to|required|constraint|requirement)\s+([^.,!?\n]+)/gi,/\b(?:have to|has to)\s+([^.,!?\n]+)/gi,/\b(?:mandatory|essential)\s+([^.,!?\n]+)/gi],uo=[/\b(?:tradeoff|trade-off|downside|drawback)\s*:?\s+([^.,!?\n]+)/gi,/\bbut\s+([^.,!?\n]+)/gi,/\bhowever\s+([^.,!?\n]+)/gi,/\balthough\s+([^.,!?\n]+)/gi,/\b(?:cost|limitation)\s+is\s+([^.,!?\n]+)/gi],lo={postgresql:"postgresql",postgres:"postgresql",pgvector:"pgvector",redis:"redis",mongodb:"mongodb",sqlite:"sqlite",mysql:"mysql",dynamodb:"dynamodb",fastapi:"fastapi",django:"django",flask:"flask",express:"express",nextjs:"nextjs","next.js":"nextjs",nest:"nest",nestjs:"nest",spring:"spring",rails:"rails",react:"react",vue:"vue",angular:"angular",svelte:"svelte",solid:"solid",qwik:"qwik",astro:"astro",typescript:"typescript",python:"python",javascript:"javascript",rust:"rust",go:"go",java:"java",kotlin:"kotlin",jwt:"jwt",oauth:"oauth2",oauth2:"oauth2",passkeys:"passkeys",saml:"saml",oidc:"oauth2",langchain:"langchain",langgraph:"langgraph",langfuse:"langfuse",openai:"openai",anthropic:"anthropic",llama:"llama",docker:"docker",kubernetes:"kubernetes",k8s:"kubernetes",terraform:"terraform",aws:"aws",gcp:"gcp",azure:"azure",pytest:"pytest",jest:"jest",vitest:"vitest",playwright:"playwright",cypress:"cypress",msw:"msw",webpack:"webpack",vite:"vite",esbuild:"esbuild",turbopack:"turbopack",bun:"bun",pnpm:"pnpm",yarn:"yarn"},po=Object.entries(lo).map(([e,t])=>{let n=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return[new RegExp(`\\b${n}\\b`,"i"),t]}),go=["cursor-pagination","offset-pagination","keyset-pagination","repository-pattern","service-layer","clean-architecture","dependency-injection","event-sourcing","cqrs","saga-pattern","circuit-breaker","rate-limiting","retry-pattern","cache-aside","write-through","read-through","rag","semantic-search","vector-search","tdd","bdd","ddd","microservices","monolith","serverless","rest","graphql","grpc","websocket","sse"],fo=["grep","read","write","edit","glob","bash","task","git","gh","npm","yarn","pnpm","claude","cursor","vscode","vim","neovim"];function X(e){let t=new Set;for(let[n,r]of po)n.test(e)&&t.add(r);for(let n of go){let r=n.replace(/-/g,"[- ]?");new RegExp(`\\b${r}\\b`,"i").test(e)&&t.add(n)}for(let n of fo)new RegExp(`\\b${n}\\b`,"i").test(e)&&t.add(n);return[...t]}function mo(e,t){let n=Math.max(0,t-50),r=Math.min(e.length,t+300),o=e.slice(n,r);for(let i of ao){let s=o.match(i);if(s&&s[1])return s[1].trim().slice(0,200)}}function ho(e,t){let n=Math.max(0,t-50),r=Math.min(e.length,t+400),o=e.slice(n,r),i=[];for(let s of co){s.lastIndex=0;let a=o.matchAll(s);for(let u of a){let p=(u[1]||u[2]||"").trim().slice(0,200);p.length>5&&i.push(p)}}return[...new Set(i)].slice(0,5)}function yo(e,t){let n=Math.max(0,t-50),r=Math.min(e.length,t+400),o=e.slice(n,r),i=[];for(let s of uo){s.lastIndex=0;let a=o.matchAll(s);for(let u of a){let p=(u[1]||u[2]||"").trim().slice(0,200);p.length>5&&i.push(p)}}return[...new Set(i)].slice(0,5)}function bo(e,t,n,r){let o=.5;return/\b(decided|chose|selected)\b/i.test(e)&&(o+=.2),t&&(o+=.15),n&&(o+=.1),r>=1&&(o+=.05),r>=2&&(o+=.05),e.length<20&&(o-=.1),Math.min(.99,Math.max(.1,o))}function Ct(e){let t=[];if(!e||e.length<10)return{intents:[],decisions:[],preferences:[],questions:[],problems:[],summary:"No intents detected (prompt too short)"};for(let u of ro){let p=e.matchAll(u);for(let d of p){let f=d[0],m=d.index||0,h="",T;if(d[3]?(h=d[2]?.trim()||"",T=[d[3].trim()]):d[2]&&(h=d[2].trim()),!h||h.length<2)continue;let v=mo(e,m),I=X(f+(v||"")),S=ho(e,m),w=yo(e,m),k=bo(f,!!v,!!T,I.length);t.push({type:"decision",confidence:k,text:f.slice(0,300),entities:I,rationale:v,alternatives:T,...S.length>0?{constraints:S}:{},...w.length>0?{tradeoffs:w}:{},position:m})}}for(let u of oo){let p=e.matchAll(u);for(let d of p){let f=d[0],m=d.index||0,h=X(f);t.push({type:"preference",confidence:h.length>0?.8:.6,text:f.slice(0,300),entities:h,position:m})}}for(let u of io){let p=e.matchAll(u);for(let d of p){let f=d[0],m=d.index||0,h=X(f);t.push({type:"problem",confidence:.75,text:f.slice(0,300),entities:h,position:m})}}for(let u of so){let p=e.matchAll(u);for(let d of p){let f=d[0],m=d.index||0,h=X(f);t.push({type:"question",confidence:.8,text:f.slice(0,300),entities:h,position:m})}}let n=ko(t),r=n.filter(u=>u.type==="decision"&&u.confidence>=.7),o=n.filter(u=>u.type==="preference"),i=n.filter(u=>u.type==="problem"),s=n.filter(u=>u.type==="question"),a=_o(r,o,i,s);return{intents:n,decisions:r,preferences:o,questions:s,problems:i,summary:a}}function ko(e){if(e.length<=1)return e;let t=[...e].sort((r,o)=>r.position-o.position),n=[];for(let r of t)if(!n.some(i=>{let s=i.position+i.text.length,a=r.position+r.text.length;return r.position>=i.position&&r.position<s||i.position>=r.position&&i.position<a}))n.push(r);else{let i=n.findIndex(s=>{let a=s.position+s.text.length,u=r.position+r.text.length;return s.type===r.type&&(r.position>=s.position&&r.position<a||s.position>=r.position&&s.position<u)});i>=0&&r.confidence>n[i].confidence&&(n[i]=r)}return n}function _o(e,t,n,r){let o=[];return e.length>0&&o.push(`${e.length} decision${e.length>1?"s":""}`),t.length>0&&o.push(`${t.length} preference${t.length>1?"s":""}`),n.length>0&&o.push(`${n.length} problem${n.length>1?"s":""}`),r.length>0&&o.push(`${r.length} question${r.length>1?"s":""}`),o.length===0?"No intents detected":`Detected: ${o.join(", ")}`}import{existsSync as ke,mkdirSync as So,readFileSync as wo,writeFileSync as At}from"node:fs";import{join as Pt,dirname as Dt,basename as xo}from"node:path";import{homedir as To}from"node:os";function vo(e){let t=[],n=new Date().toISOString(),r={name:e.id,entityType:Ro(e.type),observations:Io(e)},o=e.entities.map(s=>({name:s,entityType:Eo(s),observations:[`Mentioned in ${e.type}: ${e.content.what.slice(0,100)}`]}));t.push({type:"create_entities",payload:{entities:[r,...o]},timestamp:n});let i=[];for(let s of e.entities){let a=e.type==="decision"?"CHOSE":e.type==="preference"?"PREFERS":"MENTIONS";i.push({from:e.id,to:s,relationType:a})}if(e.content.alternatives?.length)for(let s of e.content.alternatives)i.push({from:e.content.what,to:s,relationType:"CHOSE_OVER"});if(e.content.constraints?.length)for(let s of e.content.constraints)i.push({from:e.id,to:s,relationType:"CONSTRAINT"});if(e.content.tradeoffs?.length)for(let s of e.content.tradeoffs)i.push({from:e.id,to:s,relationType:"TRADEOFF"});if(e.entities.length>=2)for(let s=0;s<e.entities.length;s++)for(let a=s+1;a<e.entities.length;a++)i.push({from:e.entities[s],to:e.entities[a],relationType:"RELATES_TO"});for(let s of e.relations)i.push({from:s.from,to:s.to,relationType:s.type});return i.length>0&&t.push({type:"create_relations",payload:{relations:i},timestamp:n}),t}function Io(e){let t=[];return t.push(`What: ${e.content.what}`),e.content.why&&t.push(`Rationale: ${e.content.why}`),e.content.alternatives?.length&&t.push(`Alternatives considered: ${e.content.alternatives.join(", ")}`),e.content.constraints?.length&&t.push(`Constraints: ${e.content.constraints.join("; ")}`),e.content.tradeoffs?.length&&t.push(`Tradeoffs: ${e.content.tradeoffs.join("; ")}`),t.push(`Category: ${e.metadata.category}`),t.push(`Confidence: ${(e.metadata.confidence*100).toFixed(0)}%`),t.push(`Source: ${e.metadata.source}`),t.push(`Project: ${e.metadata.project}`),t.push(`Timestamp: ${e.metadata.timestamp}`),t}function Ro(e){return{decision:"Decision",preference:"Preference","problem-solution":"Solution",pattern:"Pattern",workflow:"Workflow"}[e]||"Decision"}function Eo(e){let t=e.toLowerCase();return["postgresql","postgres","redis","mongodb","fastapi","django","react","vue","angular","typescript","python","docker","kubernetes"].some(i=>t.includes(i))?"Technology":["pagination","pattern","architecture","cqrs","saga","circuit","injection","sourcing","caching","rag"].some(i=>t.includes(i))?"Pattern":["grep","read","write","bash","git","npm","jest","pytest"].some(i=>t.includes(i))?"Tool":"Technology"}function $t(){let t=g().replace(/[\\/]/g,"-");return Pt(To(),".claude","projects",t,"memory")}function Co(){return Pt($t(),"MEMORY.md")}function Ot(){try{let e=$t(),t=Dt(e);return ke(t)}catch{return!1}}function Ao(e){let t=[],n=e.type==="decision"?"[Decision]":e.type==="preference"?"[Preference]":e.type==="pattern"?"[Pattern]":"[Note]";return t.push(`- **${n}** ${e.content.what}`),e.content.why&&t.push(`  _(because: ${e.content.why})_`),e.entities.length>0&&t.push(`  ${e.entities.map(r=>`\`${r}\``).join(", ")}`),t.join(`
`)}function Po(e){if(!Ot())return!1;try{let t=Co(),n=Dt(t);ke(n)||So(n,{recursive:!0});let r="";ke(t)&&(r=wo(t,"utf-8"));let o=`## Recent Project Decisions

`;r.includes("## Recent Project Decisions")||(r=o+r);let i=Ao(e);if(r.includes(e.content.what.slice(0,50)))return c("memory-writer","Skipping duplicate in CC native memory","debug"),!0;let s=r.indexOf(o)+o.length,a=r.slice(0,s)+i+`
`+r.slice(s);if(a.split(`
`).filter(d=>d.startsWith("- **[")).length>50){let d=a.lastIndexOf("- **[",a.length-1),f=a.slice(0,d)+`
_...older decisions archived..._
`;At(t,f)}else At(t,a);return c("memory-writer",`Stored to CC native memory: ${t}`,"debug"),!0}catch(t){return c("memory-writer",`Failed to write CC native memory: ${t}`,"warn"),!1}}async function _e(e){let t={graph_operations:[],cc_native:!1};t.graph_operations=vo(e),e.metadata.confidence>=.7&&Ot()&&(t.cc_native=Po(e));let n=[t.graph_operations.length>0?"graph":null,t.cc_native?"cc-native":null].filter(Boolean);return n.length>0&&c("memory-writer",`Stored ${e.type} ${e.id} to: ${n.join(", ")}`,"info"),t}function Do(e,t,n){if(t<.8||!e.why)return!1;let r=["pagination","caching","authentication","authorization","testing","deployment","security","performance","database","api","architecture"];return n.some(i=>r.some(s=>i.toLowerCase().includes(s)))}function Se(e,t,n,r){let o=new Date().toISOString(),i=$o(e),s=xo(g())||"unknown",a=W(),u=r.confidence??.5,p=Do(t,u,n);return e==="decision"?pt(t.what,t.why,u):e==="preference"&&gt(t.what,u),{id:i,type:e,content:t,entities:n,relations:[],identity:{user_id:a.user_id,anonymous_id:a.anonymous_id,team_id:a.team_id,machine_id:a.machine_id},metadata:{session_id:r.session_id,timestamp:o,confidence:u,source:r.source,project:s,category:r.category??"general",importance:r.importance,is_generalizable:p,sharing_scope:p?"global":"team"}}}function $o(e){let t=Date.now().toString(36),n=Math.random().toString(36).slice(2,8);return`${e}-${t}-${n}`}import{existsSync as Oo,appendFileSync as jo,mkdirSync as Mo}from"node:fs";import{join as No,dirname as Ho,basename as Lo}from"node:path";var C="capture-user-intent",Fo=15;function Uo(e){let t=Date.now().toString(36),n=Math.random().toString(36).slice(2,8);return`${e}-${t}-${n}`}function Go(){let e=g();return Lo(e)||"unknown"}function Bo(e,t){try{let n=Ho(e);Oo(n)||Mo(n,{recursive:!0});let r=JSON.stringify(t)+`
`;return jo(e,r),!0}catch(n){return c(C,`Failed to write to ${e}: ${n}`,"warn"),!1}}function zo(e,t){if(e.length===0)return 0;let n=g(),r=No(n,".claude","memory","open-problems.jsonl"),o=Go(),i=new Date().toISOString(),s=0;for(let a of e){let u={id:Uo("prob"),timestamp:i,session_id:t,type:"problem",text:a.text,confidence:a.confidence,entities:a.entities,project:o,status:"open"};Bo(r,u)&&s++}return s}function jt(e){if(e.length===0)return"general";let t=e.join(" ").toLowerCase(),n=[[["postgresql","postgres","mysql","sqlite","mongodb","redis","database","db"],"database"],[["react","vue","angular","svelte","frontend","css","tailwind","ui"],"frontend"],[["fastapi","django","express","nest","backend","api","rest","graphql"],"backend"],[["docker","kubernetes","k8s","ci","cd","deploy","infrastructure"],"infrastructure"],[["test","jest","vitest","pytest","testing","coverage"],"testing"],[["typescript","python","rust","go","java","language"],"language"],[["auth","security","jwt","oauth","encryption"],"security"],[["cache","caching","performance","optimization"],"performance"],[["architecture","pattern","design","structure"],"architecture"]];for(let[r,o]of n)if(r.some(i=>t.includes(i)))return o;return"general"}function qo(e,t){try{for(let n of e.decisions){let r=Se("decision",{what:n.text,why:n.rationale,...n.alternatives?.length?{alternatives:n.alternatives}:{},...n.constraints?.length?{constraints:n.constraints}:{},...n.tradeoffs?.length?{tradeoffs:n.tradeoffs}:{}},n.entities,{session_id:t,source:"user_prompt",confidence:n.confidence,category:jt(n.entities)});_e(r).catch(o=>{c(C,`storeDecision failed for decision: ${o}`,"warn")})}for(let n of e.preferences){let r=Se("preference",{what:n.text},n.entities,{session_id:t,source:"user_prompt",confidence:n.confidence,category:jt(n.entities)});_e(r).catch(o=>{c(C,`storeDecision failed for preference: ${o}`,"warn")})}for(let n of e.problems)ft(n.text)}catch(n){c(C,`Memory pipeline storage failed: ${n}`,"warn")}}function Mt(e){let t=e.prompt;if(!t||t.length<Fo)return l();let n=e.session_id||y(),r;try{r=Ct(t)}catch(i){return c(C,`Intent detection failed: ${i}`,"warn"),l()}if(r.intents.length===0)return l();qo(r,n);let o=zo(r.problems,n);return o>0&&c(C,`Captured: ${o} problems`,"info"),(r.decisions.length>0||r.preferences.length>0)&&c(C,`Tracked: ${r.decisions.length} decisions, ${r.preferences.length} preferences (to decisions.jsonl + queues)`,"debug"),l()}import{existsSync as we,readFileSync as Wo,writeFileSync as Jo,appendFileSync as Ko,mkdirSync as Nt}from"node:fs";import{join as xe,dirname as Xo}from"node:path";var Vo=2,Yo=[/\bthank/i,/\bgreat\b/i,/\bperfect\b/i,/\bexcellent\b/i,/\bawesome\b/i,/\bworks?\b.*\b(well|great|perfectly)/i,/\bthat('s| is) (exactly|just) what/i,/\bnice\b/i,/\bgood job\b/i,/\bwell done\b/i,/\blooks? good\b/i,/\blgtm\b/i,/\bship it\b/i],Qo=[/\bno(t| ).*right/i,/\bwrong\b/i,/\bdoesn't work/i,/\bbroken\b/i,/\bfailed\b/i,/\btry again\b/i,/\bstart over\b/i,/\bundo\b/i,/\brevert\b/i,/\bfrustrat/i,/\bannoy/i,/\bconfus/i,/\bstill (not|doesn't)/i,/\bdidn't (work|help)/i,/\bthat's not/i];function Zo(e){for(let t of Yo)if(t.test(e))return"positive";for(let t of Qo)if(t.test(e))return"negative";return"neutral"}function ei(e){return xe(e,".claude",".satisfaction-counter")}function ti(e){let t=ei(e),n=Xo(t);if(!we(n))try{Nt(n,{recursive:!0})}catch{}let r=0;if(we(t))try{r=parseInt(Wo(t,"utf8").trim(),10)||0}catch{}r++;try{Jo(t,String(r))}catch{}return r}function ni(e,t,n,r){let o=xe(r,".claude","feedback"),i=xe(o,"satisfaction.log");if(!we(o))try{Nt(o,{recursive:!0})}catch{return}let a=`${new Date().toISOString()} | ${e} | ${t} | ${n}
`;try{Ko(i,a)}catch{}}function V(e){let t=e.prompt||"",n=e.project_dir||g(),r=e.session_id||y(),o=parseInt(process.env.SATISFACTION_SAMPLE_RATE||"3",10),i=ti(n);if(o>1&&i%o!==0)return l();if(c("satisfaction-detector",`Satisfaction detector hook starting (sample ${i})`),!t)return l();if(t.length<Vo)return l();if(t.startsWith("/"))return l();let s=Zo(t);if(s!=="neutral"){let a=t.slice(0,50);t.length>50&&(a+="..."),ni(r,s,a,n);try{P("preference_stated",s,{context:a,success:!0})}catch{}c("satisfaction-detector",`Detected ${s} satisfaction signal`)}return l()}import{existsSync as Ht,readFileSync as ri,writeFileSync as oi,mkdirSync as ii}from"node:fs";import{join as si,dirname as ai}from"node:path";var Te="communication-style-tracker",ci=5,ui=30,li=150,di=[/^(how|what|why|when|where|which|who|can\s+(you|i)|could\s+(you|i)|would\s+(you|i)|is\s+(it|there|this)|are\s+(there|these)|do\s+(you|i)|does|should|will|has|have)\b/i,/\?$/,/\b(explain|tell me|show me|help me understand)\b/i],pi=[/^(fix|add|create|update|remove|delete|run|build|test|deploy|install|configure|set|get|make|write|read|edit|change|modify|implement|refactor)\b/i,/^(do|just|please|now|quickly)\s+(fix|add|create|update|run|build)/i,/^[a-z]+\s+(it|this|that|the)\b/i],gi=[/^(i think|i believe|maybe|perhaps|i was thinking|let's discuss|what if|consider|i'm wondering|could we|should we|might we)\b/i,/\b(alternatively|on the other hand|however|but|although|pros and cons|trade-?off)\b/i,/\b(in my experience|from what i've seen|generally|typically|usually)\b/i],fi=[/\b(what (is|are|does)|how (do|does) .* work|explain|eli5|basics?|beginner|newbie|starter|learning|tutorial)\b/i,/\b(i('m| am) (new|confused|stuck|lost)|don't understand|can you explain)\b/i,/\b(step by step|for dummies|simple|easy)\b/i],mi=[/\b(idempoten|determin|memoiz|currying|monad|functor|polymorphi|closure|hoisting|prototype chain)\b/i,/\b(HNSW|pgvector|FAISS|embeddings?|RAG|LLM|transformer|attention|tokeniz)\b/i,/\b(sharding|partition|replica|consistency|CAP theorem|ACID|eventual consistency)\b/i,/\b(microservic|kubernetes|k8s|helm|istio|service mesh|container orchestrat)\b/i,/\b(cursor.based pagination|connection pool|deadlock|race condition|mutex|semaphore)\b/i,/\b(dependency injection|inversion of control|SOLID|DRY|KISS|YAGNI)\b/i,/\b(async|await|promise|observable|event.loop|coroutine|generator)\b/i,/\b(O\(n\)|O\(log n\)|O\(1\)|big.?O|time complexity|space complexity)\b/i],hi=[/\b(API|REST|GraphQL|JWT|OAuth|middleware|endpoint|route|controller)\b/i,/\b(component|hook|state|props|context|redux|store|dispatch)\b/i,/\b(migration|schema|model|ORM|query|index|foreign key)\b/i,/\b(unit test|integration test|e2e|mock|stub|fixture|coverage)\b/i,/\b(git|branch|merge|rebase|commit|PR|pull request)\b/i];function yi(e){let t=e.trim(),n=t.length,r=(t.match(/[.!?]\s+[A-Z]/g)||[]).length>=2,o=/\b(because|since|so that|in order to|the reason)\b/i.test(t),i=/\b(context|background|currently|previously|before)\b/i.test(t);return n<=ui&&!o?"terse":n>li||r||o||i?"detailed":"moderate"}function Lt(e){let t=e.trim();for(let n of gi)if(n.test(t))return"discussion";for(let n of di)if(n.test(t))return"question";for(let n of pi)if(n.test(t))return"command";return t.length<50?"command":"discussion"}function bi(e){let t=e.trim(),n=0,r=0,o=0;for(let i of fi)i.test(t)&&(n+=2);for(let i of mi)i.test(t)&&(o+=2);for(let i of hi)i.test(t)&&(r+=1);return t.length<40&&!t.includes("?")&&Lt(t)==="command"&&(o+=1),n>o&&n>r?"beginner":o>=2||o>0&&r>=2?"expert":(r>=2||o>0,"intermediate")}function ki(e){return{verbosity:yi(e),interaction_type:Lt(e),technical_level:bi(e)}}function _i(e){return si(e,".claude",".comm-style-counter")}function Si(e){let t=_i(e),n=ai(t);if(!Ht(n))try{ii(n,{recursive:!0})}catch{}let r=0;if(Ht(t))try{r=parseInt(ri(t,"utf8").trim(),10)||0}catch{}r++;try{oi(t,String(r))}catch{}return r}function Y(e){let t=e.prompt||"",n=e.project_dir||g(),r=parseInt(process.env.COMM_STYLE_SAMPLE_RATE||"5",10),o=Si(n);if(r>1&&o%r!==0)return l();if(c(Te,`Analyzing communication style (sample ${o})`),!t||t.length<ci)return l();if(t.startsWith("/"))return l();try{let i=ki(t);mt(i),c(Te,`Detected: verbosity=${i.verbosity}, type=${i.interaction_type}, level=${i.technical_level}`)}catch(i){c(Te,`Error tracking communication style: ${i}`,"warn")}return l()}import{existsSync as Ft,readFileSync as Ut}from"node:fs";import{join as Gt}from"node:path";var wi=["implement","add","create","build","set up","setup","configure","use","write","make","develop"],xi=[{pattern:"offset pagination",warning:"Offset pagination causes performance issues on large tables. Use cursor-based pagination instead."},{pattern:"manual jwt validation",warning:"Manual JWT validation is error-prone. Use established libraries like python-jose or jsonwebtoken."},{pattern:"storing passwords in plaintext",warning:"Never store passwords in plaintext. Use bcrypt, argon2, or scrypt."},{pattern:"global state",warning:"Global mutable state causes testing and concurrency issues. Use dependency injection."},{pattern:"synchronous file operations",warning:"Synchronous file I/O blocks the event loop. Use async file operations."},{pattern:"n+1 query",warning:"N+1 queries cause performance problems. Use eager loading or batch queries."},{pattern:"polling for real-time",warning:"Polling is inefficient for real-time updates. Consider SSE or WebSocket."}];function Ti(e){let t=e.toLowerCase();for(let n of wi)if(t.includes(n))return!0;return!1}function vi(e,t){let n=e.toLowerCase(),r=[];for(let{pattern:s,warning:a}of xi)n.includes(s)&&r.push(a);let o=Gt(t,".claude","feedback","learned-patterns.json");if(Ft(o))try{let a=(JSON.parse(Ut(o,"utf8")).patterns||[]).filter(u=>u.outcome==="failed");for(let u of a)if(u.text){let d=u.text.toLowerCase().split(" ")[0];d&&n.includes(d)&&r.push(`Previously failed: ${u.text}`)}}catch{}let i=Gt(D(),".claude","global-patterns.json");if(Ft(i))try{let s=JSON.parse(Ut(i,"utf8"));for(let{pattern:a,warning:u}of s.antipatterns||[])n.includes(a.toLowerCase())&&r.push(`${a}: ${u}`)}catch{}return r}function Q(e){let t=e.prompt||"",n=e.project_dir||g();if(!t)return l();if(!Ti(t))return l();c("antipattern-warning","Checking prompt for anti-patterns...");let r=vi(t,n);if(r.length>0){c("antipattern-warning",`Found anti-pattern warnings: ${r.join(", ")}`);let o=`## Anti-Pattern Warning

The following patterns have previously caused issues:

${r.map(i=>`- ${i}`).join(`
`)}

Consider alternative approaches before proceeding.

Search knowledge graph for more context: mcp__memory__search_nodes with query="${t.slice(0,50)}"`;return b(o)}return l()}import{existsSync as Ii,readFileSync as Ri}from"node:fs";import{join as Ei}from"node:path";var Ci=["add","implement","create","build","design","refactor","update","modify","fix","change","continue","resume","remember","previous","last time","before","earlier","pattern","decision","how did we","what did we"],Ai=["relationship","related","connected","depends","uses","recommends","what does.*recommend","how does.*work with"],Pi=20;function Di(e){let t=e.toLowerCase();for(let n of Ci)if(t.includes(n))return!0;return!1}function $i(e){let t=e.toLowerCase();for(let n of Ai)if(new RegExp(n,"i").test(t))return!0;return!1}function Oi(e){let t=new Set(["the","a","an","to","for","in","on","at","is","are","was","were","be","been","being","have","has","had","do","does","did","will","would","could","should","can","may","might","must","shall","i","you","we","they","it","this","that","these","those","my","your","our","their","its","and","or","but","if","then","else","when","where","how","what","which","who","whom","with","from","into","onto","about","after","before","global"]);return e.toLowerCase().replace(/[^a-z\s]/g," ").split(/\s+/).filter(r=>r.length>2&&!t.has(r)).slice(0,5).join(" ")}function ji(e){let t=process.env.CLAUDE_AGENT_ID;if(t)return t;let n=Ei(e,".claude","session","current-agent-id");if(Ii(n))try{return Ri(n,"utf8").trim()}catch{}return""}function Z(e){let t=e.prompt||"",n=e.project_dir||g();if(c("memory-context","Memory context hook starting (graph-first)"),t.length<Pi)return c("memory-context",`Prompt too short (${t.length} chars), skipping memory search`),l();let r=t.startsWith("@global")||t.includes("cross-project")||t.includes("all projects"),o=$i(t);r&&c("memory-context","Detected @global prefix - will suggest cross-project search"),o&&c("memory-context","Detected graph-related query");let i=ji(n);if(i&&c("memory-context",`Agent context detected: ${i}`),!Di(t))return c("memory-context","No memory trigger keywords found, skipping"),l();let s=Oi(t);if(!s)return c("memory-context","No search terms extracted, skipping"),l();c("memory-context",`Search terms: ${s}`);let u=`[Memory Context] For relevant past ${r?"cross-project":"project"} decisions, use mcp__memory__search_nodes with query="${s}"`;return o&&(u+=" | For relationships: mcp__memory__open_nodes on found entities | Graph traversal available"),i&&(u+=` | Agent context: ${i}`),c("memory-context",`Memory context available for: ${s}`),b(u)}import{existsSync as zt,readFileSync as Mi,writeFileSync as Ni,mkdirSync as Hi}from"node:fs";import{join as Li}from"node:path";var Bt=.7,Fi=.95,Ui=8,Gi=15,Bi=5;function zi(e){if(!e)return 0;let t=Date.now(),n;if(/^\d+$/.test(e))n=parseInt(e,10);else if(n=new Date(e).getTime(),isNaN(n))return 0;let r=(t-n)/(1e3*60);return r<=5?10:r<=15?8:r<=30?6:r<=60?4:r<=120?2:0}function qi(e){return e>=10?10:e>=7?8:e>=4?6:e>=2?4:e>=1?2:0}function Wi(e,t){if(e.length===0||t.length===0)return 2;let n=new Set(e.map(s=>s.toLowerCase())),r=new Set(t.map(s=>s.toLowerCase())),o=0;for(let s of n)r.has(s)&&o++;let i=o/n.size;return i>=.75?10:i>=.5?8:i>=.3?6:i>=.15?4:o>0?2:0}function Ji(e){let t=new Set(["the","and","for","with","from","that","this","have","will","can","should","would","could"]);return e.toLowerCase().match(/\b[a-z]{3,}\b/g)?.filter(n=>!t.has(n)).slice(0,20)||[]}function Ki(){return`/tmp/claude-context-tracking-${y()}.json`}function Xi(){let e=Ki();if(zt(e))try{return JSON.parse(Mi(e,"utf8"))}catch{}let n={session_id:y(),updated_at:new Date().toISOString(),total_context_tokens:0,context_budget:12e3,items:[]};return Ni(e,JSON.stringify(n,null,2)),n}function Vi(e){let t=process.env.CLAUDE_CONTEXT_USAGE_PERCENT;if(t){let n=parseFloat(t);if(!isNaN(n))return n}return e.context_budget>0?e.total_context_tokens/e.context_budget:0}function Yi(e,t){let n=[];for(let r of e.items){let o=r.last_accessed||r.loaded_at,i=r.access_count||0,s=r.tags||[],a=zi(o),u=qi(i),p=Wi(s,t),d=a+u+p;c("context-pruning-advisor",`Scored ${r.id}: R=${a} F=${u} V=${p} Total=${d}`),d<=Gi&&n.push({score:d,priority:d<=Ui?"HIGH":"MED",itemId:r.id,tokens:r.estimated_tokens||500})}return n.sort((r,o)=>r.score-o.score).slice(0,Bi)}function Qi(e){let t=0,n=[];for(let r=0;r<e.length;r++){let{priority:o,itemId:i,score:s,tokens:a}=e[r];t+=a;let u=i.replace(/^(skill:|file:|agent:)/,"");n.push(`  ${r+1}. [${o}] ${u} (score: ${s}, saves ~${a}t)`)}return`Context usage >70%. Pruning recommendations:
${n.join(`
`)}

Potential savings: ~${t} tokens
To prune: Archive or unload low-scoring context items.`}function ee(e){let t=e.project_dir||g(),n=e.prompt||"",r=Li(t,"logs");if(!zt(r))try{Hi(r,{recursive:!0})}catch{}let o=Xi(),i=Vi(o);if(c("context-pruning-advisor",`Context usage: ${i} (trigger threshold: ${Bt})`),i<Bt)return c("context-pruning-advisor","Context usage within limits, no pruning needed"),l();if(i>=Fi){c("context-pruning-advisor",`CRITICAL: Context usage at ${i*100}% (>95%)`);let u=`CRITICAL: Context usage at ${Math.round(i*100)}% (>95%). Use /ork:context-optimization immediately or manually archive old decisions and patterns.`;return b(u)}if(!n)return c("context-pruning-advisor","No user prompt found in hook input, skipping analysis"),l();let s=Ji(n);c("context-pruning-advisor",`Extracted prompt keywords: ${s.join(", ")}`);let a=Yi(o,s);if(a.length>0){let u=Qi(a);return c("context-pruning-advisor",`Recommending ${a.length} pruning candidates`),b(u)}return l()}var Zi=15,es=["what is","explain","how does","tell me about","describe","list","show me"];function ts(e){let t=e.toLowerCase();for(let n of es)if(t.startsWith(n))return!0;return!!(e.endsWith("?")&&e.length<100)}function ns(){let e=Je();return e!==void 0&&e.status==="running"}function te(e){let t=e.prompt||"";if(t.length<Zi)return l();if(ts(t))return l();if(!de().enablePipelines)return l();if(ns())return c("pipeline-detector","Already in active pipeline, skipping detection"),l();c("pipeline-detector","Checking for pipeline triggers...");let r=tt(t);if(!r)return c("pipeline-detector","No pipeline triggers detected"),l();c("pipeline-detector",`Detected pipeline: ${r.type}`);let{execution:o,tasks:i}=nt(r);rt(o,i);let s=ot(r,o,i);return c("pipeline-detector",`Created pipeline ${o.pipelineId} with ${i.length} steps`),b(s)}var ne="prompt-dispatcher",qt=800,rs=[{name:"satisfaction-detector",fn:V,producesContext:!1},{name:"communication-style-tracker",fn:Y,producesContext:!1},{name:"context-pruning-advisor",fn:ee,producesContext:!0},{name:"antipattern-warning",fn:Q,producesContext:!0},{name:"memory-context",fn:Z,producesContext:!0},{name:"pipeline-detector",fn:te,producesContext:!0}];function os(e){return e.hookSpecificOutput?.additionalContext?e.hookSpecificOutput.additionalContext:e.systemMessage&&typeof e.systemMessage=="string"?e.systemMessage:null}function Wt(e){let t=[],n=0;for(let o of rs)try{let i=o.fn(e);if(!o.producesContext)continue;let s=os(i);if(!s)continue;let a=se(s);if(n+a>qt){c(ne,`Budget limit: skipping ${o.name} (${a}t would exceed ${qt}t cap)`);continue}t.push(s),n+=a,c(ne,`${o.name}: +${a}t (total: ${n}t)`)}catch(i){let s=i instanceof Error?i.message:String(i);c(ne,`${o.name} failed: ${s}`,"warn")}if(t.length===0)return l();let r=t.join(`

---

`);return c(ne,`Consolidated ${t.length} hooks into ${n}t`),b(r)}var is=["implement","add","create","build","set up","configure","pagination","authentication","caching","database","api","endpoint"];function ss(e){let t=e.toLowerCase();return/pagination|cursor|offset|page/i.test(t)?"pagination":/auth|jwt|oauth|login|session/i.test(t)?"authentication":/cache|redis|memo/i.test(t)?"caching":/database|sql|postgres|query/i.test(t)?"database":/api|endpoint|rest|graphql/i.test(t)?"api":/error|exception|handling/i.test(t)?"error-handling":/test|testing|spec/i.test(t)?"testing":"general"}function Jt(e){let t=e.prompt||"",n=e.project_dir||g();if(t.length<30)return l();let r=t.toLowerCase(),o="";for(let a of is)if(r.includes(a)){o=a;break}if(!o)return l();c("antipattern-detector",`Implementation keyword detected: ${o}`);let i=ss(t);c("antipattern-detector",`Suggesting antipattern check for: ${o} (category: ${i})`);let s=`[Antipattern Check] Before implementing ${o}, check for known failures:
Use \`mcp__memory__search_nodes\` with query: "${o} failed ${i}"`;return b(s)}import{existsSync as as}from"node:fs";import{join as cs}from"node:path";function Kt(e){let t=e.prompt||"",n=e.project_dir||g();c("context-injector",`User prompt received (${t.length} chars)`);let r=[];if(/issue|bug|fix|#[0-9]+/.test(t)){let o=cs(n,"docs","issues");as(o)&&r.push("Check docs/issues/ for issue documentation.")}return/test|testing|pytest|jest/.test(t.toLowerCase())&&r.push("Remember to use 'tee' for visible test output."),/deploy|ci|cd|pipeline|github.actions/.test(t.toLowerCase())&&r.push("Check .github/workflows/ for CI configuration."),r.length>0&&c("context-injector",`Context hints: ${r.join(" ")}`),l()}var us=[/implement/i,/refactor/i,/add feature/i,/create.*component/i,/build.*system/i,/fix.*multiple/i,/update.*across/i,/migrate/i],ls=500;function Xt(e){let t=e.prompt||"",n=t.length;c("todo-enforcer",`Prompt length: ${n} chars`);let r=!1;for(let o of us)if(o.test(t)){r=!0;break}return n>ls&&(r=!0),r&&c("todo-enforcer","Complex task detected - todo tracking recommended"),l()}var Vt={"prompt/unified-dispatcher":Wt,"prompt/profile-injector":Rt,"prompt/memory-context-loader":Et,"prompt/capture-user-intent":Mt,"prompt/antipattern-detector":Jt,"prompt/antipattern-warning":Q,"prompt/context-injector":Kt,"prompt/context-pruning-advisor":ee,"prompt/memory-context":Z,"prompt/satisfaction-detector":V,"prompt/todo-enforcer":Xt,"prompt/pipeline-detector":te,"prompt/communication-style-tracker":Y};function al(e){return Vt[e]}function cl(){return Object.keys(Vt)}export{Ys as DEFAULT_CONFIG,et as PIPELINES,$ as THRESHOLDS,ya as addToPromptHistory,Wa as analyzeAttemptHistory,ec as applyDecay,ka as cacheClassification,Qn as calculateBackoffDelay,ra as classifyIntent,xa as cleanupOldStates,Fa as cleanupOldTasks,ia as clearCache,wa as clearSessionState,qa as completeAttempt,La as completePipelineStep,za as createAttempt,nt as createPipelineExecution,tt as detectPipeline,Xs as escapeRegex,se as estimateTokenCount,ot as formatPipelinePlan,Ka as formatRetryDecision,Ca as formatTaskCreateForClaude,Pa as formatTaskDeleteForClaude,Da as formatTaskUpdateForClaude,Ra as generateTaskCreateInstruction,Aa as generateTaskDeleteInstruction,Ea as generateTaskUpdateInstruction,pa as getActiveAgent,Je as getActivePipeline,tc as getAdjustments,nc as getAgentSuccessRate,pe as getAlternativeAgent,Ds as getCachedBranch,rc as getCalibrationStats,Ps as getEnvFile,Js as getField,al as getHook,ha as getInjectedSkills,_a as getLastClassification,$e as getLogDir,Sn as getLogLevel,Na as getOrphanedTasks,lc as getPipelineByType,qn as getPipelineTasks,ie as getPluginRoot,g as getProjectDir,ba as getPromptHistory,y as getSessionId,Oa as getTaskByAgent,ja as getTaskById,Ma as getTasksBlockedBy,oc as hasMinimalCalibrationData,cr as hashPrompt,Vt as hooks,ga as isAgentDispatched,ps as isBashInput,fs as isEditInput,ms as isReadInput,Zn as isRetryableError,ma as isSkillInjected,gs as isWriteInput,cl as listHooks,j as loadCalibrationData,de as loadConfig,R as loadState,c as logHook,zs as logPermissionFeedback,Ba as makeRetryDecision,Ks as normalizeCommand,$s as normalizeLineEndings,Hs as outputAllowWithContext,js as outputBlock,Gs as outputDeny,Ls as outputError,b as outputPromptContext,qs as outputPromptContextBudgeted,Os as outputSilentAllow,l as outputSilentSuccess,Us as outputStderrWarning,Fs as outputWarning,Ms as outputWithContext,Ns as outputWithNotification,Bs as outputWithUpdatedInput,Ja as prepareForRetry,Ws as readHookInput,Za as recordOutcome,We as registerPipeline,rt as registerPipelineExecution,qe as registerTask,da as removeAgent,ar as saveCalibrationData,Sa as saveConfig,Ln as saveState,oa as shouldClassify,wn as shouldLog,er as suggestsAlternative,ua as trackDispatchedAgent,fa as trackInjectedSkill,la as updateAgentStatus,Ha as updatePipeline,A as updateState,$a as updateTaskStatus};
//# sourceMappingURL=prompt.mjs.map
