// OrchestKit Hooks - posttool bundle
// Generated: 2026-01-28T18:16:09.984Z

var v=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,n)=>(typeof require<"u"?require:e)[n]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});function Ao(t){return typeof t.command=="string"}function Oo(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function Po(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function Ho(t){return typeof t.file_path=="string"&&t.content===void 0}import{appendFileSync as gt,existsSync as pt,statSync as Ae,renameSync as Oe,mkdirSync as Pe,readSync as He}from"node:fs";import{execSync as je}from"node:child_process";function mt(){return process.env.CLAUDE_PLUGIN_ROOT?`${process.env.HOME||process.env.USERPROFILE||"/tmp"}/.claude/logs/ork`:`${g()}/.claude/logs`}function g(){return process.env.CLAUDE_PROJECT_DIR||"."}function D(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function m(){return process.env.CLAUDE_SESSION_ID||`fallback-${process.pid}-${Date.now()}`}function Lo(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let e=je("git branch --show-current",{cwd:t||g(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function Ne(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function Me(t){let e=["debug","info","warn","error"];return e.indexOf(t)>=e.indexOf(Ne())}function a(){return{continue:!0,suppressOutput:!0}}function Fo(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function Bo(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function Uo(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function Le(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function zo(t,e){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?n.systemMessage=e:n.suppressOutput=!0,n}function Jo(t){return{continue:!0,systemMessage:t}}function Wo(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function qo(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}var Fe=200*1024,Be=100*1024;function ft(t,e){if(pt(t))try{if(Ae(t).size>e){let r=`${t}.old.${Date.now()}`;Oe(t,r)}}catch{}}function yt(t){pt(t)||Pe(t,{recursive:!0})}function c(t,e,n="debug"){if(!Me(n))return;let r=mt(),s=`${r}/hooks.log`;try{yt(r),ft(s,Fe);let o=new Date().toISOString().replace("T"," ").slice(0,19);gt(s,`[${o}] [${n.toUpperCase()}] [${t}] ${e}
`)}catch{}}function Go(t,e,n){let r=mt(),s=`${r}/permission-feedback.log`;try{yt(r),ft(s,Be);let o=new Date().toISOString(),i=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",u=n?.session_id||m();gt(s,`${o} | ${t} | ${e} | tool=${i} | session=${u}
`)}catch{}}function tt(t){if(!t)return 0;let r=(t.match(/[{};()=><]/g)||[]).length/t.length>.03?2.8:3.5;return Math.ceil(t.length/r)}function Zo(t,e,n,r,s){let o=tt(t);return r&&r.isOverBudget(n)?(c(e,`Budget exhausted for ${n}, suppressing ${o}t`),a()):(s&&s.trackTokenUsage(e,n,o),Le(t))}function Ko(){try{let t=[],n=Buffer.allocUnsafe(256),r,s=0;for(;;)try{if(r=He(s,n,0,256,null),r===0)break;t.push(Buffer.from(n.subarray(0,r)))}catch{break}let o=Buffer.concat(t).toString("utf8").trim();return o?JSON.parse(o):{tool_name:"",session_id:m(),tool_input:{}}}catch{return{tool_name:"",session_id:m(),tool_input:{}}}}function p(t,e){let n=e.replace(/^\./,"").split("."),r=t;for(let s of n){if(r==null)return;r=r[s]}return r}function Xo(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function Yo(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}import{execSync as E}from"node:child_process";function Ue(t){let e=t||g();try{return E("git branch --show-current",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return"unknown"}}function ze(t){let e=t||Ue();return["dev","main","master"].includes(e)}function ei(t){let e=t||g();try{return E("git rev-parse --show-toplevel",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return e}}function ni(t){let e=t||g();try{return E("git rev-parse --git-dir",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),!0}catch{return!1}}function Je(t){let e=t||g();try{return E("git status --short",{cwd:e,encoding:"utf8",timeout:1e4,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function ri(t){return Je(t).length>0}function si(t){let e=t||g();try{return E("git rev-parse --verify main",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"main"}catch{try{return E("git rev-parse --verify master",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"master"}catch{return"main"}}}function We(t){let e=[/issue\/(\d+)/i,/feature\/(\d+)/i,/fix\/(\d+)/i,/bug\/(\d+)/i,/feat\/(\d+)/i,/^(\d+)-/,/-(\d+)$/,/#(\d+)/];for(let n of e){let r=t.match(n);if(r)return parseInt(r[1],10)}return null}function oi(t){if(ze(t))return null;let e=["issue/","feature/","fix/","bug/","feat/","chore/","docs/","refactor/","test/","ci/","perf/","style/","release/","hotfix/"];return e.some(r=>t.startsWith(r))?t.startsWith("issue/")&&!We(t)?"issue/ branches should include an issue number (e.g., issue/123-description)":null:`Branch name should start with a valid prefix: ${e.join(", ")}`}import{appendFileSync as qe,existsSync as kt,mkdirSync as Ge,statSync as Ze,renameSync as Ke}from"node:fs";var ht="/tmp/claude-read-count";function A(t){let e=t.tool_name||"";if(["Read","Glob","Grep"].includes(e))try{let{readFileSync:s,writeFileSync:o}=v("node:fs"),i=0;try{i=parseInt(s(ht,"utf8").trim(),10)||0}catch{}if(i++,o(ht,String(i)),i%10!==0)return a()}catch{}let n=process.env.CLAUDE_PROJECT_DIR||".",r=`${n}/.claude/logs/audit.log`;try{let s=`${n}/.claude/logs`;kt(s)||Ge(s,{recursive:!0}),Xe(r,200*1024);let o=new Date().toISOString().replace("T"," ").slice(0,19),i="";switch(e){case"Bash":{i=(p(t,"tool_input.command")||"").substring(0,100);break}case"Write":case"Edit":{i=p(t,"tool_input.file_path")||"";break}case"Task":{i=p(t,"tool_input.subagent_type")||"";break}}let u=i?`[${o}] ${e} | ${i}
`:`[${o}] ${e}
`;qe(r,u)}catch{}return a()}function Xe(t,e){if(kt(t))try{if(Ze(t).size>e){let r=`${t}.old.${Date.now()}`;Ke(t,r)}}catch{}}import{existsSync as C,appendFileSync as Ye,readFileSync as R,writeFileSync as O,mkdirSync as St,statSync as Ve,renameSync as Qe}from"node:fs";import{createHash as xt}from"node:crypto";var _t=/error:|Error:|ERROR|FATAL|exception|failed|denied|not found|does not exist|connection refused|timeout|ENOENT|EACCES|EPERM/i,tn=/^(echo |ls |ls$|pwd|cat |head |tail |wc |date|whoami)/,bt=2e3,en=10,nn=3,rn=1e3*1024;function sn(t){let e=String(p(t,"tool_output")||t.tool_output||""),n=String(t.tool_error||p(t,"error")||""),r=t.exit_code??0,s=!1,o="",i="";if(r!==0&&r!==void 0&&(s=!0,o="exit_code",i=`Exit code: ${r}`),n&&(s=!0,o=o||"tool_error",i=i||n),_t.test(e)){s=!0,o=o||"output_pattern";let u=e.split(`
`).filter(l=>_t.test(l));i=i||u[0]||""}return{isError:s,errorType:o,errorMessage:i,errorText:n||e}}function on(t){if(C(t))try{Ve(t).size>rn&&Qe(t,`${t}.old.${Date.now()}`)}catch{}}function an(t,e){let n=g(),r=`${n}/.claude/logs/errors.jsonl`,s="/tmp/claude-session-errors.json";try{St(`${n}/.claude/logs`,{recursive:!0}),on(r);let o=xt("md5").update(JSON.stringify(t.tool_input||{})).digest("hex"),i={timestamp:new Date().toISOString(),tool:t.tool_name,session_id:m(),error_type:e.errorType,error_message:e.errorMessage.substring(0,500),input_hash:o,tool_input:t.tool_input,output_preview:e.errorText.substring(0,1e3)};Ye(r,JSON.stringify(i)+`
`);try{let u={error_count:0,last_error_tool:"",last_error_time:""};C(s)&&(u=JSON.parse(R(s,"utf8"))),u.error_count=(u.error_count||0)+1,u.last_error_tool=t.tool_name||"",u.last_error_time=new Date().toISOString(),O(s,JSON.stringify(u,null,2))}catch{}c("unified-error-handler",`ERROR: ${t.tool_name} - ${e.errorType}`)}catch{c("unified-error-handler",`ERROR (fallback): ${t.tool_name}`)}}function cn(t,e){if(!C(e))return null;try{let n=JSON.parse(R(e,"utf8")),r=t.toLowerCase();for(let s of n.patterns||[])if(s.regex)try{if(new RegExp(s.regex,"i").test(r))return s}catch{}}catch{}return null}function un(t,e,n){if(!C(n))try{St(v("path").dirname(n),{recursive:!0}),O(n,JSON.stringify({suggestions:{},prompt_count:0}))}catch{return!0}try{let r=JSON.parse(R(n,"utf8")),s=xt("md5").update(`${t}|${e.substring(0,100)}`).digest("hex"),o=(r.prompt_count||0)+1;r.prompt_count=o;let i=r.suggestions[s]?.prompt_count||0;return i===0||o-i>=en?(r.suggestions[s]={pattern_id:t,prompt_count:o},O(n,JSON.stringify(r,null,2)),!0):(O(n,JSON.stringify(r,null,2)),!1)}catch{return!0}}function ln(t,e){let n=`${e}/${t}/SKILL.md`;if(!C(n))return"";try{let s=R(n,"utf8").match(/^---\n([\s\S]*?)\n---/);if(s){let o=s[1].match(/description:\s*(.+)/);if(o)return o[1].trim()}}catch{}return""}function dn(t,e,n){let r=t.solution?.brief||"An error was detected.",s=t.solution?.steps||[],o=`## Error Solution

`;o+=`**${r}**

`,s.length>0&&(o+=`### Quick Fixes

`,s.forEach((d,y)=>{o+=`  ${y+1}. ${d}
`}),o+=`
`);let i=t.skills||[],u=[];if(t.category&&C(e))try{u=JSON.parse(R(e,"utf8")).categories?.[t.category]?.related_skills||[]}catch{}let l=[...new Set([...i,...u])].slice(0,nn);if(l.length>0){o+=`### Related Skills

`;for(let d of l){let y=ln(d,n);o+=y?`- **${d}**: ${y}
`:`- **${d}**
`}o+="\nUse `/ork:<skill-name>` or `Read skills/<skill-name>/SKILL.md`"}return o.length>bt?o.substring(0,bt-20)+`...

(truncated)`:o}function vt(t){let e=t.tool_name||"";if(e==="Bash"){let r=p(t,"tool_input.command")||"";if(tn.test(r))return a()}let n=sn(t);if(!n.isError)return a();if(an(t,n),e==="Bash"){let r=D(),s=`${r}/.claude/rules/error_solutions.json`,o=`${r}/skills`,i=`/tmp/claude-error-suggestions-${m()}.json`,u=cn(n.errorText.substring(0,2e3),s);if(u&&un(u.id,n.errorText,i)){let l=dn(u,s,o);if(l)return c("unified-error-handler",`Suggesting solution for pattern: ${u.id}`),{continue:!0,hookSpecificOutput:{additionalContext:l}}}}return a()}import{existsSync as gn}from"node:fs";import{execSync as T}from"node:child_process";function pn(t){switch(t.split(".").pop()?.toLowerCase()){case"py":return"python";case"ts":case"tsx":return"typescript";case"js":case"jsx":return"javascript";case"json":return"json";case"css":case"scss":return"css";default:return null}}function et(t){try{return T(`which ${t}`,{stdio:"ignore"}),!0}catch{return!1}}function $t(t){let e=t.tool_name||"";if(e!=="Write"&&e!=="Edit")return a();let n=p(t,"tool_input.file_path")||"";if(!n||n.includes("/.claude/")||n.includes("/node_modules/")||n.includes("/.git/")||n.includes("/dist/")||n.endsWith(".lock"))return a();let r=process.env.CLAUDE_PROJECT_DIR||".",s=n.startsWith("/")?n:`${r}/${n}`;if(!gn(s))return a();if(process.env.SKIP_AUTO_LINT==="1")return a();let o=pn(n);if(!o)return a();let i=0,u=!1;try{switch(o){case"python":if(et("ruff")){try{let l=T(`timeout 5s ruff check --output-format=concise "${s}" 2>&1`,{encoding:"utf8",stdio:["pipe","pipe","pipe"]});l&&(i=l.split(`
`).filter(Boolean).length,T(`timeout 5s ruff check --fix --unsafe-fixes=false "${s}" 2>/dev/null`,{stdio:"ignore"}),u=!0)}catch{}try{T(`timeout 5s ruff format "${s}" 2>/dev/null`,{stdio:"ignore"})}catch{}}break;case"typescript":case"javascript":if(et("biome"))try{let l=T(`timeout 5s biome check --write "${s}" 2>&1`,{encoding:"utf8",stdio:["pipe","pipe","pipe"]});l.includes("Fixed")&&(u=!0),l.includes("error")&&(i=(l.match(/error/g)||[]).length)}catch{}break;case"json":case"css":if(et("biome"))try{T(`timeout 5s biome format --write "${s}" 2>/dev/null`,{stdio:"ignore"}),u=!0}catch{}break}}catch(l){c("auto-lint",`Error: ${l}`)}if(u&&i>0){let l=n.split("/").pop();return{continue:!0,systemMessage:`Auto-lint: fixed issues, ${i} remaining in ${l}`}}return a()}import{existsSync as nt,readFileSync as rt,writeFileSync as H,mkdirSync as mn}from"node:fs";var P=2200,It=.7,fn=.5,yn=.1;function hn(t){if(!nt(t))return 0;try{let e=rt(t,"utf8");return tt(e)}catch{return 0}}function wt(){let e=`${g()}/context`,n=[`${e}/identity.json`,`${e}/session/state.json`,`${e}/knowledge/index.json`,`${e}/knowledge/blockers/current.json`],r=0;for(let s of n)r+=hn(s);return r}function Et(){let t=parseInt(process.env.CLAUDE_MAX_CONTEXT||"200000",10);return Math.floor(t*(100-20)/100)}function kn(t){let e=Et();return e===0?!0:t/e>yn}function _n(t,e){let r=`/tmp/claude-mcp-defer-state-${m()}.json`,s=Et(),o={mcp_deferred:t,context_tokens:e,effective_window:s,updated_at:new Date().toISOString(),reason:t?"context > 10% threshold":"context within limits"};try{H(r,JSON.stringify(o,null,2))}catch{}c("context-budget-monitor",`MCP defer state updated: defer=${t}, tokens=${e}, window=${s}`)}function bn(){let e=`${g()}/context/session/state.json`;if(nt(e))try{let n=JSON.parse(rt(e,"utf8")),r={session_id:n.session_id,started:n.started,current_task:n.current_task,next_steps:(n.next_steps||[]).slice(-3),blockers:n.blockers,_compressed:!0,_compressed_at:new Date().toISOString(),_original_files_touched:(n.files_touched||[]).length,_original_decisions:(n.decisions_this_session||[]).length};H(e,JSON.stringify(r,null,2)),c("context-budget-monitor","Session state compressed")}catch{}}function Sn(){let t=g(),e=`${t}/context/knowledge/decisions/active.json`;if(nt(e))try{let n=JSON.parse(rt(e,"utf8")),r=n.decisions||[];if(r.length>10){c("context-budget-monitor","Archiving old decisions (keeping latest 5)...");let s=`${t}/context/archive/decisions`;mn(s,{recursive:!0});let o=new Date,i=`${s}/${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}.json`;H(i,JSON.stringify(r.slice(0,-5),null,2)),n.decisions=r.slice(-5),H(e,JSON.stringify(n,null,2)),c("context-budget-monitor",`Archived ${r.length-5} decisions to ${i}`)}}catch{}}function Ct(t){try{let e=wt(),n=e/P,r=Math.floor(n*100);c("context-budget-monitor",`Context usage: ${e} / ${P} tokens (${r}%)`);let s=kn(e);if(_n(s,e),n>It){c("context-budget-monitor",`WARNING: Context usage (${r}%) exceeds threshold (${It*100}%)`),c("context-budget-monitor","Triggering compression..."),bn(),Sn();let o=wt(),i=o/P,u=Math.floor(i*100);c("context-budget-monitor",`After compression: ${o} / ${P} tokens (${u}%)`),i>fn?c("context-budget-monitor","WARNING: Still above target. Manual review recommended."):c("context-budget-monitor","Compression successful. Target achieved.")}else c("context-budget-monitor","Context usage within budget. No compression needed.")}catch(e){c("context-budget-monitor",`Error: ${e}`)}return a()}import{existsSync as Tt,readFileSync as xn}from"node:fs";import{execSync as vn}from"node:child_process";function j(t){let e=g(),n=`${e}/.claude/coordination/lib/coordination.sh`;if(!Tt(n))return a();try{let r=`${e}/.claude/.instance_env`,s=process.env.CLAUDE_SESSION_ID||`fallback-${process.pid}`;if(Tt(r)){let i=xn(r,"utf8").match(/CLAUDE_INSTANCE_ID=["']?([^"'\n]+)/);i&&(s=i[1])}s&&vn(`source "${n}" && INSTANCE_ID="${s}" coord_heartbeat 2>/dev/null || true`,{shell:"/bin/bash",stdio:"ignore",timeout:5e3})}catch(r){c("coordination-heartbeat",`Heartbeat update failed: ${r}`)}return a()}function N(t){c("mem0-webhook-handler","Mem0 webhook handler starting");let e=t.tool_name||"",n=p(t,"tool_input.command")||"";if(e!=="Bash"||!n.includes("webhook-receiver.py"))return a();let r=p(t,"tool_result")||"";if(!r)return c("mem0-webhook-handler","No event data found in webhook call"),a();try{let s;try{s=JSON.parse(r)}catch{return c("mem0-webhook-handler","Could not parse event data"),a()}let o=s.result?.event_type||s.event_type||"",i=s.result?.memory_id||s.memory?.id||"";c("mem0-webhook-handler",`Processing webhook event: ${o} (memory: ${i})`),["memory.created","memory.updated","memory.deleted"].includes(o)?c("mem0-webhook-handler",`Received ${o} for memory ${i}`):c("mem0-webhook-handler",`Received unknown event type: ${o}`)}catch(s){c("mem0-webhook-handler",`Error processing webhook: ${s}`)}return a()}import{existsSync as $n}from"node:fs";var In={Technology:/fastapi|react|typescript|python|postgres|redis|docker|kubernetes|langchain|langgraph|pgvector|qdrant|openai|anthropic|celery|rabbitmq|kafka|nginx|vite|tailwind|prisma|sqlalchemy|alembic|pydantic|zod/i,Pattern:/singleton|factory|repository|service|controller|adapter|facade|strategy|observer|decorator|middleware|dependency.injection|cursor.pagination|rate.limiting|circuit.breaker/i,Decision:/decided|chose|selected|will.use|adopted|standardized|migrated/i,Architecture:/microservice|monolith|event.driven|cqrs|event.sourcing|hexagonal|clean.architecture|ddd|api.gateway|load.balancer/i,Database:/postgresql|mysql|mongodb|sqlite|dynamodb|cassandra|schema|migration|index|query/i,Security:/jwt|oauth|cors|csrf|xss|sql.injection|rate.limit|encryption|authentication|authorization/i};function wn(t){let e=t.toLowerCase(),n=[];for(let[r,s]of Object.entries(In)){let o=e.match(s);if(o)for(let i of[...new Set(o)].slice(0,5)){let u=i.split(/[\s-_]+/).map(d=>d.charAt(0).toUpperCase()+d.slice(1).toLowerCase()).join("-"),l="Used in project context";/decided.*/.test(e)&&e.includes(i)?l="Decided to use for project":/chose.*/.test(e)&&e.includes(i)?l="Chosen for implementation":/will.use.*/.test(e)&&e.includes(i)&&(l="Will be used in project"),n.push({name:u,entityType:r,observations:[l]})}}return n}function En(t,e){let n=t.toLowerCase(),r=[],s=e.map(o=>o.name);for(let o of s){let i=o.toLowerCase().replace(/-/g,".");for(let u of s){if(o===u)continue;let l=u.toLowerCase().replace(/-/g,".");new RegExp(`${i}.*(with|using|and|integrated|connected|for).*${l}`,"i").test(n)&&r.push({from:o,to:u,relationType:"uses"})}}return r}function M(t){switch(t.tool_name||""){case"mcp__mem0__add_memory":{c("memory-bridge","Processing mcp__mem0__add_memory - syncing to graph (primary)");let n=p(t,"tool_input.text")||"";if(!n||n.length<20)return c("memory-bridge","Memory text too short, skipping"),a();let s=`${D()}/bin/memory-fabric-agent.py`;$n(s)&&c("memory-bridge","Memory Fabric Agent available for bidirectional sync");let i=wn(n),u=i.length;if(u===0)return c("memory-bridge","No entities extracted"),a();let l=En(n,i),d=l.length;c("memory-bridge",`Extracted ${u} entities and ${d} relations`);let y=i.slice(0,5).map(h=>`- ${h.name} (${h.entityType}): ${h.observations[0]||"observed"}`).join(`
`),k=`[Memory Bridge] Sync to Graph (primary storage)

Mem0 content should be synced to the knowledge graph for durability.
Detected ${u} entities to preserve:

${y}

Store in graph with mcp__memory__create_entities:
\`\`\`json
{"entities": ${JSON.stringify(i)}}
\`\`\``;return d>0&&(k+=`

Then call mcp__memory__create_relations with:
\`\`\`json
{"relations": ${JSON.stringify(l)}}
\`\`\``),{continue:!0,systemMessage:k}}case"mcp__memory__create_entities":return c("memory-bridge","mcp__memory__create_entities - graph is primary, no sync needed"),a();default:return a()}}import{existsSync as Ot,readFileSync as Pt,writeFileSync as Ht,mkdirSync as Cn}from"node:fs";var Tn=/decided|chose|architecture|security|blocked|breaking|critical|must|cannot|deprecated|removed|migration/i,Rn=/pattern|convention|preference|style|format|naming/i,Dn=30,An=85,On=90;function Pn(){let t=parseInt(process.env.CLAUDE_CONTEXT_USED_PERCENTAGE||"0",10);if(t===0){let e=parseInt(process.env.CLAUDE_CONTEXT_TOKENS_USED||"0",10),n=parseInt(process.env.CLAUDE_CONTEXT_MAX_TOKENS||"0",10);if(n>0)return Math.floor(e*100/n)}return t}function Hn(t){return Tn.test(t)?"IMMEDIATE":Rn.test(t)?"BATCHED":"SESSION_END"}function Rt(t){let e=[/[^.]*\b(decided|chose|selected|will use|must|cannot|blocked|breaking)[^.]*/i,/[^.]*\b(architecture|security|migration|deprecated)[^.]*/i];for(let r of e){let s=t.match(r);if(s)return s[0].trim().substring(0,300)}let n=t.match(/^[^.]{30,200}\./);return n?n[0].trim():t.substring(0,300).trim()}function Dt(t){let e=t.toLowerCase();return/security|auth|jwt|oauth|cors|xss/.test(e)?"security":/architecture|design|structure|system/.test(e)?"architecture":/database|schema|migration|postgres|sql/.test(e)?"database":/blocked|issue|bug|problem|cannot/.test(e)?"blocker":/breaking|deprecated|removed|migration/.test(e)?"breaking-change":/api|endpoint|route|rest/.test(e)?"api":/decided|chose|selected/.test(e)?"decision":"general"}function jn(t){if(!Ot(t))try{Cn(v("path").dirname(t),{recursive:!0}),Ht(t,JSON.stringify({pending:[],created_at:new Date().toISOString()}))}catch{}}function Nn(t,e,n){jn(n);try{let r=JSON.parse(Pt(n,"utf8"));r.pending.push({content:t,category:e,queued_at:new Date().toISOString()}),Ht(n,JSON.stringify(r,null,2)),c("realtime-sync",`Added to pending queue: category=${e}, length=${t.length}`)}catch{}}function At(t){if(!Ot(t))return 0;try{return JSON.parse(Pt(t,"utf8")).pending?.length||0}catch{return 0}}function L(t){let e=t.tool_name||"";if(!["Bash","Write","Edit","Skill","Task"].includes(e))return a();let n="";switch(e){case"Bash":{n=String(p(t,"tool_output")||t.tool_output||"");let l=p(t,"tool_input.command")||"";l&&(n=`${l}
${n}`);break}case"Write":case"Edit":{let l=p(t,"tool_input.new_string")||p(t,"tool_input.content")||"",d=p(t,"tool_input.file_path")||"";n=d?`Writing to ${d}: ${l}`:l;break}case"Skill":case"Task":{n=String(p(t,"tool_result")||t.tool_output||"");break}}if(!n||n.length<Dn)return a();let r=Hn(n);c("realtime-sync",`Tool: ${e}, Priority: ${r}, Content length: ${n.length}`);let s=Pn(),o=g(),i=m(),u=`${o}/.claude/logs/.mem0-pending-sync-${i}.json`;if(r==="BATCHED"&&s>=An&&(r="IMMEDIATE",c("realtime-sync",`EMERGENCY: Context at ${s}%, upgrading BATCHED to IMMEDIATE`)),s>=On){let l=At(u);if(l>0)return c("realtime-sync",`CRITICAL: Context at ${s}%, flushing ${l} pending items`),{continue:!0,systemMessage:`[CRITICAL SYNC] Context at ${s}% - compaction imminent!

${l} items in pending queue need immediate sync to knowledge graph.
Pending sync file: ${u}

Execute mcp__memory__create_entities for each item in the pending file NOW
to preserve session context in the knowledge graph before compaction.`}}switch(r){case"IMMEDIATE":{let l=Rt(n);if(!l||l.length<20)return c("realtime-sync","Could not extract meaningful decision"),a();let d=Dt(l);return c("realtime-sync",`IMMEDIATE sync triggered: category=${d}`),{continue:!0,systemMessage:`[IMMEDIATE SYNC] Critical decision detected - store in knowledge graph now.

Category: ${d}
Decision: "${l.substring(0,200)}"

Store in knowledge graph with mcp__memory__create_entities:
\`\`\`json
{
  "entities": [{
    "name": "${d}-decision",
    "entityType": "Decision",
    "observations": ["${l.substring(0,300).replace(/"/g,'\\"')}"]
  }]
}
\`\`\`

This decision is critical and should be synced immediately for:
- Session continuity if interrupted
- Cross-agent knowledge sharing
- Future reference in similar contexts`}}case"BATCHED":{let l=Rt(n);if(l&&l.length>=20){let d=Dt(l);Nn(l,d,u);let y=At(u);if(y>=5)return c("realtime-sync",`BATCHED queue has ${y} items - triggering batch sync`),{continue:!0,systemMessage:`[BATCHED SYNC] ${y} patterns/conventions queued for graph sync.

Latest: "${l.substring(0,100)}..." (${d})

These will be synced to knowledge graph at session end, or trigger batch sync now with mcp__memory__create_entities for each item in:
${u}`}}return a()}default:return a()}}import{existsSync as Zn,appendFileSync as Kn,mkdirSync as Xn,readFileSync as Ui,readdirSync as zi}from"node:fs";import{existsSync as Mn,readFileSync as Ln,writeFileSync as Hi,mkdirSync as ji}from"node:fs";import{execSync as jt}from"node:child_process";import{createHash as Fn}from"node:crypto";import*as Nt from"node:os";var Bn=".claude/.user_identity.json",Un="orchestkit-user-identity-v1";var S=null;function F(t){return Fn("sha256").update(t+Un).digest("hex").slice(0,16)}function zn(){try{return Nt.hostname()}catch{return"unknown-machine"}}function Jn(t){let e=`${t}/${Bn}`;if(!Mn(e))return null;try{let n=Ln(e,"utf8");return JSON.parse(n)}catch(n){return c("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function Wn(t){let e={};try{e.email=jt("git config user.email",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{e.name=jt("git config user.name",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return e}function qn(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function Gn(t){if(S)return S;let e=t||g(),n=zn(),r=Jn(e);if(r?.user_id)return S={user_id:r.user_id,display_name:r.display_name||r.user_id,team_id:r.team_id,machine_id:n,source:"config",anonymous_id:F(r.user_id),email:r.user_id.includes("@")?r.user_id:void 0},c("user-identity",`Resolved from config: ${S.user_id}`,"debug"),S;let s=Wn(e);if(s.email)return S={user_id:s.email,display_name:s.name||s.email.split("@")[0],team_id:r?.team_id,machine_id:n,source:"git",anonymous_id:F(s.email),email:s.email},c("user-identity",`Resolved from git: ${S.user_id}`,"debug"),S;let o=qn();if(o.username){let u=`${o.username}@${n}`;return S={user_id:u,display_name:o.username,team_id:r?.team_id,machine_id:n,source:"env",anonymous_id:F(u)},c("user-identity",`Resolved from env: ${S.user_id}`,"debug"),S}let i=F(n+process.pid);return S={user_id:`anon-${i.slice(0,8)}`,display_name:"Anonymous",team_id:r?.team_id,machine_id:n,source:"anonymous",anonymous_id:i},c("user-identity",`Resolved as anonymous: ${S.user_id}`,"debug"),S}function Mt(){let t=Gn();return{session_id:m(),user_id:t.user_id,anonymous_id:t.anonymous_id,team_id:t.team_id,machine_id:t.machine_id,identity_source:t.source,timestamp:new Date().toISOString()}}function Ft(t){let e=t||m();return`${g()}/.claude/memory/sessions/${e}`}function Yn(t){return`${Ft(t)}/events.jsonl`}function Vn(t){let e=Ft(t);Zn(e)||Xn(e,{recursive:!0})}var Lt=0;function Qn(){return Lt++,`evt-${Date.now()}-${Lt}`}function ot(t,e,n={}){try{let r={event_id:Qn(),event_type:t,identity:Mt(),payload:{name:e,input:st(n.input),output:st(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?it(n.context,500):void 0,confidence:n.confidence}};Vn();let s=Yn();Kn(s,JSON.stringify(r)+`
`),c("session-tracker",`Tracked ${t}: ${e}`,"debug")}catch(r){c("session-tracker",`Failed to track event: ${r}`,"warn")}}function Bt(t,e,n=!0,r){ot("skill_invoked",t,{input:e?{args:e}:void 0,success:n,duration_ms:r})}function Ut(t,e,n=!0){ot("agent_spawned",t,{input:e?{prompt:it(e,200)}:void 0,success:n})}function zt(t,e=!0,n){ot("tool_used",t,{success:e,duration_ms:n})}function it(t,e){return t.length<=e?t:t.slice(0,e-3)+"..."}function st(t){if(!t)return;let e={},n=["password","secret","token","key","credential","auth"];for(let[r,s]of Object.entries(t)){if(n.some(o=>r.toLowerCase().includes(o))){e[r]="[REDACTED]";continue}if(typeof s=="string"&&s.length>500){e[r]=it(s,500);continue}if(typeof s=="object"&&s!==null&&!Array.isArray(s)){e[r]=st(s);continue}e[r]=s}return e}function tr(t){let e=t.tool_input;if(!e||typeof e!="object")return;let n=e.skill;if(typeof n=="string")return n}function er(t){let e=t.tool_input;if(!e||typeof e!="object")return;let n=e.subagent_type;if(typeof n=="string")return n}function nr(t){let e=t.tool_input;if(!e||typeof e!="object")return;let n=e.prompt;if(typeof n=="string")return n.length>200?n.slice(0,200)+"...":n}function rr(t){return!t.tool_error}function B(t){try{let e=t.tool_name||"unknown",n=rr(t);if(zt(e,n),e==="Skill"){let r=tr(t);r&&(Bt(r,void 0,n),c("user-tracking",`Tracked skill: ${r}`,"debug"))}if(e==="Task"){let r=er(t);if(r){let s=nr(t);Ut(r,s,n),c("user-tracking",`Tracked agent: ${r}`,"debug")}}return a()}catch(e){return c("user-tracking",`Error: ${e}`,"warn"),a()}}import{existsSync as sr,readFileSync as or,writeFileSync as ir}from"node:fs";var U="/tmp/claude-session-metrics.json",Vi=`${U}.lock`;function z(t){let e=t.tool_name||"";if(!e)return a();try{let n={tools:{},errors:0,warnings:0};if(sr(U))try{let s=or(U,"utf8").trim();s&&(n=JSON.parse(s))}catch{n={tools:{},errors:0,warnings:0}}n.tools||(n.tools={});let r=n.tools[e]||0;n.tools[e]=r+1,ir(U,JSON.stringify(n,null,2))}catch(n){c("session-metrics",`Error updating metrics: ${n}`)}return a()}import{existsSync as ar,readFileSync as cr,appendFileSync as ur,mkdirSync as lr}from"node:fs";var dr=[{name:"add_pagination",regex:/limit.*offset|page.*size|cursor.*pagination|paginate|Paginated/i},{name:"add_rate_limiting",regex:/rate.?limit|throttl|RateLimiter|requests.?per/i},{name:"add_caching",regex:/@cache|cache_key|TTL|redis|memcache|@cached/i},{name:"add_retry_logic",regex:/retry|backoff|max_attempts|tenacity|Retry/i},{name:"add_error_handling",regex:/try.*catch|except|raise.*Exception|throw.*Error|error.*handler/i},{name:"add_validation",regex:/validate|Validator|@validate|Pydantic|Zod|yup|schema/i},{name:"add_logging",regex:/logger[.]|logging[.]|console[.]log|winston|pino|structlog/i},{name:"add_types",regex:/: *(str|int|bool|List|Dict|Optional)|interface |type .*=/i},{name:"add_type_guards",regex:/isinstance|typeof|is.*Type|assert.*type/i},{name:"add_docstring",regex:/docstring|"""[^"]+"""|\/\*\*/i},{name:"remove_comments",regex:/^-.*#|^-.*\/\/|^-.*\*/m},{name:"add_auth_check",regex:/@auth|@require_auth|isAuthenticated|requiresAuth|@login_required/i},{name:"add_input_sanitization",regex:/escape|sanitize|htmlspecialchars|DOMPurify/i},{name:"add_test_case",regex:/def test_|it\(|describe\(|expect\(|assert|@pytest/i},{name:"add_mock",regex:/Mock|patch|jest[.]mock|vi[.]mock|MagicMock/i},{name:"modify_imports",regex:/^[+-].*import|^[+-].*from.*import|^[+-].*require\(/m},{name:"add_async",regex:/async |await |Promise|asyncio|async def/i}];function gr(t){if(!ar(t))return"";try{let e=JSON.parse(cr(t,"utf8")),r=Math.floor(Date.now()/1e3)-300;return(e.recentSkills||[]).filter(o=>o.timestamp>r).sort((o,i)=>i.timestamp-o.timestamp)[0]?.skillId||""}catch{return""}}function pr(t){let e=[];for(let{name:n,regex:r}of dr)r.test(t)&&e.push(n);return e}function mr(t,e,n,r){let s=m(),i={timestamp:new Date().toISOString(),skill_id:t,file_path:e,session_id:s,patterns:n};try{lr(v("path").dirname(r),{recursive:!0}),ur(r,JSON.stringify(i)+`
`)}catch{}}function J(t){let e=t.tool_name||"";if(e!=="Write"&&e!=="Edit")return a();let n=p(t,"tool_input.file_path")||"";if(!n)return a();let r=g(),s=`${r}/.claude/session/state.json`,o=gr(s);if(!o)return a();let i="";if(e==="Edit"){let l=p(t,"tool_input.old_string")||"",d=p(t,"tool_input.new_string")||"";if(l&&d){let y=l.split(`
`),k=d.split(`
`);i=y.map(h=>`-${h}`).join(`
`)+`
`+k.map(h=>`+${h}`).join(`
`)}}else i=p(t,"tool_input.content")||"";if(!i)return a();let u=pr(i);if(u.length>0){let l=`${r}/.claude/feedback/edit-patterns.jsonl`;mr(o,n,u,l),process.env.CLAUDE_HOOK_DEBUG&&c("skill-edit-tracker",`Detected ${u.length} patterns for ${o}: ${JSON.stringify(u)}`)}return a()}import{existsSync as Gt,readFileSync as fr,writeFileSync as yr,mkdirSync as hr}from"node:fs";import{createHash as kr}from"node:crypto";var Jt=500;var Wt=15,qt=3;function Zt(){return`${g()}/.claude/feedback/calibration-data.json`}function _r(){let t=`${g()}/.claude/feedback`;if(!Gt(t))try{hr(t,{recursive:!0})}catch{}}function br(){let t=Zt();if(Gt(t))try{return JSON.parse(fr(t,"utf8"))}catch{c("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function Sr(t){_r();let e=Zt();t.updatedAt=new Date().toISOString();try{yr(e,JSON.stringify(t,null,2)),c("calibration-engine","Saved calibration data")}catch(n){c("calibration-engine",`Failed to save calibration data: ${n}`)}}function xr(t){return kr("sha256").update(t.toLowerCase().trim()).digest("hex").slice(0,16)}function Kt(t,e,n,r,s,o,i){let u=br(),l={timestamp:new Date().toISOString(),sessionId:m(),agent:e,promptHash:xr(t),matchedKeywords:n,dispatchConfidence:r,outcome:s,durationMs:o,feedback:i};u.records.push(l),u.records.length>Jt&&(u.records=u.records.slice(-Jt)),vr(u,l),$r(u),Sr(u),c("calibration-engine",`Recorded outcome: ${e} -> ${s} (conf: ${r})`)}function vr(t,e){let n=e.outcome==="success",r=e.outcome==="failure"||e.outcome==="rejected";if(!n&&!r)return;let s=n?qt:-qt;for(let o of e.matchedKeywords){let i=t.adjustments.find(u=>u.keyword===o&&u.agent===e.agent);i?(i.adjustment=Math.max(-Wt,Math.min(Wt,i.adjustment+s)),i.sampleCount++,i.lastUpdated=new Date().toISOString()):t.adjustments.push({keyword:o,agent:e.agent,adjustment:s,sampleCount:1,lastUpdated:new Date().toISOString()})}}function $r(t){let e=t.records;if(e.length===0)return;t.stats.totalDispatches=e.length;let n=e.filter(o=>o.outcome==="success").length;t.stats.successRate=n/e.length;let r=e.reduce((o,i)=>o+i.dispatchConfidence,0)/e.length;t.stats.avgConfidence=Math.round(r);let s=new Map;for(let o of e){let i=s.get(o.agent)||{count:0,success:0};i.count++,o.outcome==="success"&&i.success++,s.set(o.agent,i)}t.stats.topAgents=Array.from(s.entries()).map(([o,i])=>({agent:o,count:i.count,successRate:i.success/i.count})).sort((o,i)=>i.count-o.count).slice(0,10)}import{existsSync as Ir,readFileSync as wr,writeFileSync as ca,mkdirSync as ua}from"node:fs";function Er(){let t=m();return`${g()}/.claude/orchestration/task-registry-${t}.json`}function Cr(){let t=Er();if(Ir(t))try{return JSON.parse(wr(t,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:m(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function Xt(t){return Cr().tasks.find(n=>n.taskId===t)}import{existsSync as Vt,readFileSync as Qt,writeFileSync as pa,mkdirSync as ma}from"node:fs";function Tr(){return`${g()}/.claude/orchestration`}function Rr(){let t=m();return`${Tr()}/session-${t}.json`}function Dr(){return`${g()}/.claude/orchestration/config.json`}function Ar(){let t=Rr();if(Vt(t))try{let e=Qt(t,"utf8");return JSON.parse(e)}catch(e){c("orchestration-state",`Failed to load state: ${e}`)}return{sessionId:m(),activeAgents:[],injectedSkills:[],promptHistory:[],maxHistorySize:10,updatedAt:new Date().toISOString()}}function te(){return Ar().lastClassification}var Yt={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function ee(){let t=Dr();if(Vt(t))try{let e=Qt(t,"utf8");return{...Yt,...JSON.parse(e)}}catch{}return Yt}function Or(t){let e=t.tool_input||{};return typeof e.taskId=="string"?e.taskId:null}function Pr(t){return t.tool_name!=="TaskUpdate"?!1:typeof(t.tool_input||{}).status=="string"}function Hr(t){switch(t){case"completed":return"success";case"pending":return null;default:return null}}function W(t){if(!Pr(t))return a();if(!ee().enableCalibration)return a();let n=t.tool_input||{},r=Or(t),s=n.status;if(!r)return a();let o=Hr(s);if(!o)return a();c("calibration-tracker",`Tracking task ${r} status update to ${s}`);let i=Xt(r);if(!i)return c("calibration-tracker",`Task ${r} not found in registry`),a();let u=i.agent;if(!u)return c("calibration-tracker",`No agent associated with task ${r}`),a();let d=te()?.agents.find($=>$.agent===u),y=d?.matchedKeywords||[],k=i.confidence||d?.confidence||0,h=i.createdAt?Date.now()-new Date(i.createdAt).getTime():void 0;return Kt("",u,y,k,o,h),c("calibration-tracker",`Recorded calibration: ${u} -> ${o} (conf: ${k})`),a()}import{existsSync as jr,readFileSync as Nr,writeFileSync as ne,mkdirSync as Mr}from"node:fs";var Lr={JWT:/jwt|jsonwebtoken/i,OAuth2:/oauth|oauth2/i,PostgreSQL:/postgres|postgresql|psql/i,Redis:/redis/i,React:/react/i,FastAPI:/fastapi/i,SQLAlchemy:/sqlalchemy/i,Alembic:/alembic/i,"cursor-pagination":/cursor.based|keyset/i,"offset-pagination":/offset.pagination/i,WebSocket:/websocket/i,SSE:/sse|server.sent/i,GraphQL:/graphql/i,REST:/rest.api|restful/i},Fr={feature:/^feat:|^feature:/i,bugfix:/^fix:|^bugfix:/i,refactor:/^refactor:/i,optimization:/^perf:|^performance:/i,security:/^security:|^sec:/i,testing:/^test:|^tests:/i},Br={pagination:/cursor|pagination|offset|limit|page/i,caching:/cache|redis|memcache|ttl/i,authentication:/auth|jwt|oauth|token|login/i,validation:/validate|validation|schema|pydantic|zod/i,testing:/test|spec|coverage|mock/i,security:/security|encrypt|hash|secret|credential/i,performance:/performance|optimize|cache|index/i,error_handling:/error|exception|retry|fallback/i};function Ur(){return g().split("/").pop()||"unknown"}function zr(t){let e=t.toLowerCase(),n="unknown",r="general";for(let[s,o]of Object.entries(Lr))if(o.test(e)){n=s;break}for(let[s,o]of Object.entries(Fr))if(o.test(t)){r=s;break}return{tech:n,pattern:r}}function Jr(t){for(let[e,n]of Object.entries(Br))if(n.test(t))return e;return"general"}function q(t,e,n,r,s){let o=new Date().toISOString(),i=Ur();if(!jr(s))try{Mr(v("path").dirname(s),{recursive:!0}),ne(s,JSON.stringify({patterns:[]}))}catch{return}try{let u=JSON.parse(Nr(s,"utf8"));u.patterns.push({text:t,category:e,outcome:n,source:r,timestamp:o,project:i}),ne(s,JSON.stringify(u,null,2)),c("pattern-extractor",`Queued pattern: category=${e} outcome=${n} source=${r}`)}catch{}}function Wr(t,e,n){let r="",s=t.match(/-m\s+["']([^"']+)["']/)||t.match(/-m\s+([^\s]+)/);if(s&&(r=s[1]),!r)return;let{tech:o,pattern:i}=zr(r),u=Jr(r),l=e===0?"success":"failed",d=r;o!=="unknown"&&(d=`[${o}] ${r}`),q(d,u,l,"commit",n)}function qr(t,e,n){if(e!==0)return;let r="PR merged successfully",s=t.match(/gh\s+pr\s+merge\s+(\d+)/);s&&(r=`PR #${s[1]} merged`),q(r,"decision","success","pr-merge",n)}function Gr(t,e,n){let r="unknown";/pytest|py\.test/.test(t)?r="pytest":/jest/.test(t)?r="jest":/vitest/.test(t)?r="vitest":/npm\s+test|yarn\s+test|bun\s+test/.test(t)?r="npm-test":/go\s+test/.test(t)&&(r="go-test");let s=e===0?"success":"failed",o=`Tests ${s==="success"?"passed":"failed"} (${r})`;q(o,"testing",s,"test-run",n)}function Zr(t,e,n){let r="unknown";/npm\s+run\s+build/.test(t)?r="npm":/yarn\s+build/.test(t)?r="yarn":/cargo\s+build/.test(t)?r="cargo":/make/.test(t)?r="make":/docker\s+build/.test(t)&&(r="docker");let s=e===0?"success":"failed",o=`Build ${s==="success"?"succeeded":"failed"} (${r})`;q(o,"build",s,"build",n)}function G(t){if((t.tool_name||"")!=="Bash")return a();let n=p(t,"tool_input.command")||"",r=t.exit_code??0;if(!n)return a();let s=n.toLowerCase(),i=`${g()}/.claude/feedback/patterns-queue.json`;return/git\s+commit/.test(s)?Wr(n,r,i):/gh\s+pr\s+merge/.test(s)?qr(n,r,i):/pytest|jest|vitest|npm\s+test|yarn\s+test|bun\s+test|go\s+test/.test(s)?Gr(n,r,i):/npm\s+run\s+build|yarn\s+build|cargo\s+build|make|docker\s+build/.test(s)&&Zr(n,r,i),a()}import{existsSync as se,readFileSync as oe,writeFileSync as Kr,mkdirSync as Xr}from"node:fs";var Yr=["py","ts","tsx","js","jsx","go","rs","java"];function Vr(t){switch(t.split(".").pop()?.toLowerCase()){case"py":return"python";case"ts":case"tsx":return"typescript";case"js":case"jsx":return"javascript";case"go":return"go";case"rs":return"rust";case"java":return"java";default:return null}}function Qr(t){let e=0,n=0,r=0;for(let s of t.split(`
`))s.startsWith("	")?e++:s.startsWith("    ")?r++:s.match(/^  [^ ]/)&&n++;return e>n+r?{style:"tabs",size:1}:n>r?{style:"spaces",size:2}:r>0?{style:"spaces",size:4}:{style:"unknown",size:4}}function ts(t){let e=(t.match(/'/g)||[]).length,n=(t.match(/"/g)||[]).length;return e>n?"single":"double"}function es(t){let e=0,n=0;for(let r of t.split(`
`)){let s=r.trim();!s||s.startsWith("//")||s.startsWith("*")||(/;\s*$/.test(r)?e++:/[a-zA-Z0-9\)\]\'\"]\\s*$/.test(r)&&n++)}return e>n?"always":"omit"}function re(t){return(t.match(/,\s*$/gm)||[]).length>5?"always":"minimal"}function ns(t){let e=/\) -> |: [A-Z][a-zA-Z]+(\[|$| =)/.test(t),n="unknown";return/"""[^"]+"""/.test(t)&&(/:param |:returns:|:raises:/.test(t)?n="sphinx":/Args:|Returns:|Raises:/.test(t)?n="google":/Parameters|Returns\n-+/.test(t)?n="numpy":n="simple"),{typeHints:e,docstringStyle:n}}function rs(t){if(se(t))try{return JSON.parse(oe(t,"utf8"))}catch{}return{version:"1.0.0",last_updated:null,samples_count:0,languages:{},global_preferences:{indentation:{style:"unknown",size:4,confidence:0},quotes:{style:"unknown",confidence:0}}}}function ss(t,e,n,r,s,o,i,u){t.last_updated=new Date().toISOString(),t.samples_count++,t.languages[e]||(t.languages[e]={samples:0,indentation:{tabs:0,spaces_2:0,spaces_4:0},quotes:{single:0,double:0},semicolons:{always:0,omit:0},trailing_comma:{always:0,minimal:0},type_hints:{used:0,not_used:0},docstring_style:{}});let l=t.languages[e];l.samples++,n.style==="tabs"?l.indentation.tabs++:n.size===2?l.indentation.spaces_2++:l.indentation.spaces_4++,r==="single"?l.quotes.single++:l.quotes.double++,s!=="unknown"&&(s==="always"?l.semicolons.always++:l.semicolons.omit++),o!=="unknown"&&(o==="always"?l.trailing_comma.always++:l.trailing_comma.minimal++),i!==null&&(i?l.type_hints.used++:l.type_hints.not_used++),u!=="unknown"&&(l.docstring_style[u]=(l.docstring_style[u]||0)+1)}function Z(t){let e=t.tool_name||"";if(e!=="Write"&&e!=="Edit")return a();let n=p(t,"tool_input.file_path")||"";if(!n||n.includes("/.claude/")||n.includes("/node_modules/")||n.includes("/.git/")||n.includes("/dist/")||n.endsWith(".lock"))return a();let r=n.split(".").pop()?.toLowerCase()||"";if(!Yr.includes(r))return a();let s=Vr(n);if(!s)return a();let o=p(t,"tool_input.content")||"";if(!o){let f=g(),_=n.startsWith("/")?n:`${f}/${n}`;if(se(_))try{o=oe(_,"utf8").split(`
`).slice(0,100).join(`
`)}catch{return a()}}if(!o)return a();let i=Qr(o),u=ts(o),l="unknown",d="unknown",y=null,k="unknown";switch(s){case"javascript":case"typescript":l=es(o),d=re(o);break;case"python":{let f=ns(o);y=f.typeHints,k=f.docstringStyle,d=re(o);break}}let h=g(),$=`${h}/.claude/feedback/code-style-profile.json`;try{Xr(`${h}/.claude/feedback`,{recursive:!0});let f=rs($);ss(f,s,i,u,l,d,y,k),Kr($,JSON.stringify(f,null,2))}catch(f){c("code-style-learner",`Error updating profile: ${f}`)}return c("code-style-learner",`Analyzed ${s} file: indent=${i.style}(${i.size}) quotes=${u}`),a()}import{existsSync as ie,readFileSync as ae,writeFileSync as os,mkdirSync as is}from"node:fs";var as=["py","ts","tsx","js","jsx","go","rs","java"];function cs(t){return t.length<2||/^[_0-9]+$/.test(t)?"unknown":/^[A-Z][A-Z0-9_]*$/.test(t)?"SCREAMING_SNAKE_CASE":/^[A-Z][a-zA-Z0-9]*$/.test(t)?"PascalCase":/^[a-z][a-zA-Z0-9]*$/.test(t)&&!t.includes("_")?"camelCase":/^[a-z][a-z0-9_]*$/.test(t)?"snake_case":/^_[a-z][a-z0-9_]*$/.test(t)?"private_snake_case":/^__[a-z][a-z0-9_]*__$/.test(t)?"dunder":"mixed"}function us(t){let e=(t.match(/def ([a-zA-Z_][a-zA-Z0-9_]*)/g)||[]).map(o=>o.replace("def ","")),n=(t.match(/class ([A-Za-z_][a-zA-Z0-9_]*)/g)||[]).map(o=>o.replace("class ","")),r=(t.match(/^\s*([a-zA-Z_][a-zA-Z0-9_]*)\s*=/gm)||[]).map(o=>o.replace(/\s*=.*/,"").trim()),s=(t.match(/^([A-Z][A-Z0-9_]*)\s*=/gm)||[]).map(o=>o.replace(/\s*=.*/,"").trim());return{functions:e,classes:n,variables:r,constants:s}}function ls(t){let e=[...(t.match(/(function|async function) ([a-zA-Z_][a-zA-Z0-9_]*)/g)||[]).map(i=>i.replace(/(async )?function /,"")),...(t.match(/const ([a-zA-Z_][a-zA-Z0-9_]*)\s*=\s*\(/g)||[]).map(i=>i.replace(/const /,"").replace(/\s*=.*/,""))],n=(t.match(/class ([A-Za-z_][a-zA-Z0-9_]*)/g)||[]).map(i=>i.replace("class ","")),r=(t.match(/interface ([A-Za-z_][a-zA-Z0-9_]*)/g)||[]).map(i=>i.replace("interface ","")),s=(t.match(/type ([A-Za-z_][a-zA-Z0-9_]*)/g)||[]).map(i=>i.replace("type ","")),o=(t.match(/(const|let|var) ([a-zA-Z_][a-zA-Z0-9_]*)/g)||[]).map(i=>i.replace(/(const|let|var) /,""));return{functions:e,classes:n,variables:o,interfaces:r,types:s}}function x(t){let e={camelCase:0,snake_case:0,PascalCase:0,SCREAMING_SNAKE_CASE:0,private_snake_case:0,dunder:0,mixed:0,unknown:0};for(let n of t){if(!n)continue;let r=cs(n);e[r]++}return e}function ds(t){let n=(t.split("/").pop()||"").replace(/\.[^.]+$/,"");return/^[a-z][a-z0-9_]*$/.test(n)?"snake_case":/^[a-z][a-z0-9-]*$/.test(n)?"kebab-case":/^[A-Z][a-zA-Z0-9]*$/.test(n)?"PascalCase":/^[a-z][a-zA-Z0-9]*$/.test(n)?"camelCase":"mixed"}function gs(t){switch(t.split(".").pop()?.toLowerCase()){case"py":return"python";case"ts":case"tsx":return"typescript";case"js":case"jsx":return"javascript";case"go":return"go";case"rs":return"rust";case"java":return"java";default:return null}}function ps(t){if(ie(t))try{return JSON.parse(ae(t,"utf8"))}catch{}return{version:"1.0.0",last_updated:null,samples_count:0,languages:{},file_naming:{},detected_patterns:{functions:{},classes:{},variables:{},constants:{},types:{}}}}function ms(){return{samples:0,functions:{camelCase:0,snake_case:0,PascalCase:0,SCREAMING_SNAKE_CASE:0,private_snake_case:0,dunder:0,mixed:0,unknown:0},classes:{camelCase:0,snake_case:0,PascalCase:0,SCREAMING_SNAKE_CASE:0,private_snake_case:0,dunder:0,mixed:0,unknown:0},variables:{camelCase:0,snake_case:0,PascalCase:0,SCREAMING_SNAKE_CASE:0,private_snake_case:0,dunder:0,mixed:0,unknown:0},constants:{camelCase:0,snake_case:0,PascalCase:0,SCREAMING_SNAKE_CASE:0,private_snake_case:0,dunder:0,mixed:0,unknown:0},types:{camelCase:0,snake_case:0,PascalCase:0,SCREAMING_SNAKE_CASE:0,private_snake_case:0,dunder:0,mixed:0,unknown:0}}}function K(t){let e=t.tool_name||"";if(e!=="Write"&&e!=="Edit")return a();let n=p(t,"tool_input.file_path")||"";if(!n||n.includes("/.claude/")||n.includes("/node_modules/")||n.includes("/.git/")||n.includes("/dist/")||n.endsWith(".lock"))return a();let r=n.split(".").pop()?.toLowerCase()||"";if(!as.includes(r))return a();let s=gs(n);if(!s)return a();let o=p(t,"tool_input.content")||"";if(!o){let f=g(),_=n.startsWith("/")?n:`${f}/${n}`;if(ie(_))try{o=ae(_,"utf8").split(`
`).slice(0,150).join(`
`)}catch{return a()}}if(!o)return a();let i=ds(n),u=x([]),l=x([]),d=x([]),y=x([]),k=x([]);switch(s){case"python":{let f=us(o);u=x(f.functions),l=x(f.classes),d=x(f.variables),y=x(f.constants);break}case"typescript":case"javascript":{let f=ls(o);u=x(f.functions),l=x(f.classes),d=x(f.variables),k=x([...f.interfaces,...f.types]);break}}let h=g(),$=`${h}/.claude/feedback/naming-conventions.json`;try{is(`${h}/.claude/feedback`,{recursive:!0});let f=ps($);f.last_updated=new Date().toISOString(),f.samples_count++,f.file_naming[i]=(f.file_naming[i]||0)+1,f.languages[s]||(f.languages[s]=ms());let _=f.languages[s];_.samples++;for(let b of Object.keys(u))_.functions[b]=(_.functions[b]||0)+u[b],_.classes[b]=(_.classes[b]||0)+l[b],_.variables[b]=(_.variables[b]||0)+d[b],_.constants[b]=(_.constants[b]||0)+y[b],_.types[b]=(_.types[b]||0)+k[b];os($,JSON.stringify(f,null,2))}catch(f){c("naming-convention-learner",`Error updating profile: ${f}`)}return c("naming-convention-learner",`Analyzed ${s} file (${n}): file=${i}`),a()}import{existsSync as fs,readFileSync as ys,writeFileSync as ce,mkdirSync as hs}from"node:fs";var ks={"api-design-framework|fastapi-advanced":"Both relate to API design. Consider using api-design-framework for patterns, fastapi-advanced for implementation.","sqlalchemy-2-async|database-schema-designer":"Both relate to database. Use database-schema-designer for schema design, sqlalchemy-2-async for async patterns.","caching-strategies|performance-optimization":"Both optimize performance. Consider consolidating caching queries.","auth-patterns|owasp-top-10":"Both relate to security. auth-patterns for implementation, owasp-top-10 for validation.","asyncio-advanced|connection-pooling":"Both relate to async. asyncio-advanced for patterns, connection-pooling for specific optimization."};function _s(t){if(!fs(t))try{hs(v("path").dirname(t),{recursive:!0}),ce(t,JSON.stringify({version:"1.0",skills:{},sessions:{},last_updated:""}))}catch{}}function X(t){_s(t);try{return JSON.parse(ys(t,"utf8"))}catch{return{version:"1.0",skills:{},sessions:{},last_updated:""}}}function bs(t,e,n){let r=X(n),s=new Date().toISOString();r.skills[t]=(r.skills[t]||0)+1,r.sessions[e]||(r.sessions[e]=[]),r.sessions[e].includes(t)||r.sessions[e].push(t),r.last_updated=s;try{ce(n,JSON.stringify(r,null,2)),c("skill-usage-optimizer",`Updated usage for skill: ${t} (session: ${e})`)}catch{}}function Ss(t,e){return X(e).sessions[t]||[]}function xs(t,e){for(let[n,r]of Object.entries(ks)){let[s,o]=n.split("|");if(t===s||t===o){let i=t===s?o:s;if(e.includes(i))return c("skill-usage-optimizer",`Overlap detected: ${s} + ${o}`),r}}return null}function vs(t){let e=X(t),n=Object.entries(e.skills);return n.length===0?"":n.sort((r,s)=>s[1]-r[1]).slice(0,3).map(([r,s])=>`${r}:${s}`).join(", ")}function Y(t){let e=t.tool_name||"",n=p(t,"tool_input.skill")||p(t,"tool_name")||"";if(e!=="Skill"&&!n?.startsWith("skills/")&&!n)return a();if(!n)return a();let s=`${g()}/.claude/feedback/skill-usage.json`,o=m();bs(n,o,s);let i=Ss(o,s),u=xs(n,i),l=vs(s),d="";u&&(d=`Skill overlap: ${u}`,c("skill-usage-optimizer",`Suggesting consolidation for: ${n}`));let k=X(s).skills[n]||0;return k>0&&k%5===0&&l&&(d?d=`${d} | Top skills: ${l}`:d=`Top skills this project: ${l}`),d?(d.length>200&&(d=d.substring(0,197)+"..."),{continue:!0,hookSpecificOutput:{additionalContext:d}}):a()}import{existsSync as $s,readFileSync as Is,writeFileSync as ue,mkdirSync as ws}from"node:fs";import{execSync as I}from"node:child_process";function Es(t){let e=t.match(/^(issue|fix|feature|bug|feat)\/(\d+)/);return e?e[2]:(e=t.match(/^(\d+)-/),e?e[1]:null)}function Cs(t){let e=t.match(/#(\d+)/);return e?e[1]:(e=t.match(/(fix|fixes|close|closes|resolve|resolves)\s+#?(\d+)/i),e?e[2]:null)}function Ts(){try{return I("git branch --show-current 2>/dev/null || git rev-parse --abbrev-ref HEAD 2>/dev/null",{encoding:"utf8",timeout:5e3}).trim()}catch{return""}}function Rs(){try{let t=I("git rev-parse --short HEAD 2>/dev/null",{encoding:"utf8",timeout:5e3}).trim(),e=I("git log -1 --pretty=%s 2>/dev/null",{encoding:"utf8",timeout:5e3}).trim(),n=I("git log -1 --pretty=%cI 2>/dev/null",{encoding:"utf8",timeout:5e3}).trim()||new Date().toISOString();return{sha:t,message:e,timestamp:n}}catch{return null}}function Ds(t,e){if(!$s(t))try{ws(v("path").dirname(t),{recursive:!0}),ue(t,JSON.stringify({session_id:e,issues:{}}))}catch{}}function As(t,e,n,r,s){Ds(r,s);try{let o=JSON.parse(Is(r,"utf8"));return o.issues[t]||(o.issues[t]={commits:[],tasks_completed:[],pr_url:null,branch:n}),o.issues[t].commits.push(e),o.issues[t].branch=n,ue(r,JSON.stringify(o,null,2)),c("issue-progress-commenter",`Queued commit for issue #${t}`),!0}catch{return c("issue-progress-commenter",`Error queuing commit for issue #${t}`),!1}}function V(t){if((t.tool_name||"")!=="Bash")return a();let n=p(t,"tool_input.command")||"",r=t.exit_code??0;if(!/git\s+commit/i.test(n)||r!==0)return a();c("issue-progress-commenter","Processing git commit command...");try{I("which gh",{stdio:"ignore",timeout:2e3})}catch{return c("issue-progress-commenter","gh CLI not available, skipping issue progress tracking"),a()}try{if(!I("git remote get-url origin 2>/dev/null",{encoding:"utf8",timeout:5e3}).includes("github"))return c("issue-progress-commenter","Not a GitHub repository, skipping"),a()}catch{return a()}let s=Ts();if(!s)return c("issue-progress-commenter","Could not determine current branch"),a();let o=Es(s);if(!o)try{let d=I("git log -1 --pretty=%s 2>/dev/null",{encoding:"utf8",timeout:5e3}).trim();o=Cs(d)}catch{}if(!o)return c("issue-progress-commenter",`No issue number found in branch '${s}' or commit message`),a();c("issue-progress-commenter",`Found issue #${o}`);try{I(`gh issue view ${o} --json number`,{stdio:"ignore",timeout:5e3})}catch{return c("issue-progress-commenter",`Issue #${o} not found or not accessible`),a()}let i=Rs();if(!i)return c("issue-progress-commenter","Could not get commit info"),a();let u=(t.session_id||m()).replace(/[^a-zA-Z0-9_-]/g,""),l=`/tmp/claude-session-${u}/issue-progress.json`;return As(o,i,s,l,u),a()}import{existsSync as Os,readFileSync as Ps,writeFileSync as Hs}from"node:fs";import{execSync as w}from"node:child_process";function js(t){let e=t.replace(/^[a-z]+(\([^)]*\))?:\s*/i,"");return e=e.replace(/\(#\d+\)/g,""),e.trim()}function le(t){return t.toLowerCase().replace(/\s+/g," ").trim()}function Ns(t,e){let n=le(t),r=le(e);if(n===r||n.includes(r)||r.includes(n))return!0;let s=new Set(n.split(" ").filter(u=>u.length>=3)),o=r.split(" ").filter(u=>u.length>=3),i=0;for(let u of o)s.has(u)&&i++;return i>=2}function Ms(t){let e=t.match(/^(issue|fix|feature|bug|feat)\/(\d+)/);return e?e[2]:(e=t.match(/^(\d+)-/),e?e[1]:null)}function Ls(t){let e=t.match(/#(\d+)/);return e?e[1]:null}function Fs(t){try{let n=w(`gh issue view ${t} --json body -q '.body' 2>/dev/null`,{encoding:"utf8",timeout:1e4}).split(`
`),r=[];for(let s of n){let o=s.match(/^\s*-\s*\[\s*\]\s+(.+)/);o&&r.push(o[1].trim())}return r}catch{return[]}}function Bs(t,e){c("issue-subtask-updater",`Attempting to update checkbox: '${e}' in issue #${t}`);try{let n=w(`gh issue view ${t} --json body -q '.body' 2>/dev/null`,{encoding:"utf8",timeout:1e4}),r=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),s=n.replace(new RegExp(`(^\\s*-\\s*)\\[\\s*\\](\\s+${r})`,"m"),"$1[x]$2");if(n===s)return c("issue-subtask-updater",`No change needed for checkbox: '${e}'`),!1;let o=w("gh repo view --json nameWithOwner -q '.nameWithOwner' 2>/dev/null",{encoding:"utf8",timeout:5e3}).trim(),i=JSON.stringify(s);return w(`gh api -X PATCH "repos/${o}/issues/${t}" -f body=${i}`,{stdio:"ignore",timeout:1e4}),c("issue-subtask-updater",`Successfully updated checkbox: '${e}'`),!0}catch(n){return c("issue-subtask-updater",`Failed to update issue body: ${n}`),!1}}function Us(t,e,n){if(Os(n))try{let r=JSON.parse(Ps(n,"utf8"));r.issues[t]||(r.issues[t]={commits:[],tasks_completed:[],pr_url:null}),r.issues[t].tasks_completed.includes(e)||(r.issues[t].tasks_completed.push(e),Hs(n,JSON.stringify(r,null,2)))}catch{}}function Q(t){if((t.tool_name||"")!=="Bash")return a();let n=p(t,"tool_input.command")||"",r=t.exit_code??0;if(!/git\s+commit/i.test(n)||r!==0)return a();c("issue-subtask-updater","Processing git commit for subtask updates...");try{w("which gh",{stdio:"ignore",timeout:2e3})}catch{return c("issue-subtask-updater","gh CLI not available, skipping subtask updates"),a()}try{if(!w("git remote get-url origin 2>/dev/null",{encoding:"utf8",timeout:5e3}).includes("github"))return c("issue-subtask-updater","Not a GitHub repository, skipping"),a()}catch{return a()}let s="",o="";try{s=w("git branch --show-current 2>/dev/null",{encoding:"utf8",timeout:5e3}).trim(),o=w("git log -1 --pretty=%s 2>/dev/null",{encoding:"utf8",timeout:5e3}).trim()}catch{return a()}let i=Ms(s);if(i||(i=Ls(o)),!i)return c("issue-subtask-updater","No issue number found"),a();c("issue-subtask-updater",`Found issue #${i}, checking for matching subtasks...`);let u=js(o);if(!u)return c("issue-subtask-updater","Could not extract task from commit message"),a();c("issue-subtask-updater",`Commit task: '${u}'`);let l=Fs(i);if(l.length===0)return c("issue-subtask-updater",`No unchecked tasks in issue #${i}`),a();let d=!1,k=`/tmp/claude-session-${(t.session_id||m()).replace(/[^a-zA-Z0-9_-]/g,"")}/issue-progress.json`;for(let h of l)Ns(u,h)&&(c("issue-subtask-updater",`Found matching checkbox: '${h}'`),Bs(i,h)&&(Us(i,h,k),d=!0));return d?{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:`Issue #${i}: Automatically marked sub-task as complete based on commit.`}}:(c("issue-subtask-updater",`No matching checkboxes found for task: '${u}'`),a())}var zs=[{name:"session-metrics",fn:z,matcher:"*"},{name:"audit-logger",fn:A,matcher:"*"},{name:"calibration-tracker",fn:W,matcher:"*"},{name:"pattern-extractor",fn:G,matcher:"Bash"},{name:"issue-progress-commenter",fn:V,matcher:"Bash"},{name:"issue-subtask-updater",fn:Q,matcher:"Bash"},{name:"mem0-webhook-handler",fn:N,matcher:"Bash"},{name:"code-style-learner",fn:Z,matcher:["Write","Edit"]},{name:"naming-convention-learner",fn:K,matcher:["Write","Edit"]},{name:"skill-edit-tracker",fn:J,matcher:["Write","Edit"]},{name:"coordination-heartbeat",fn:j,matcher:"Task"},{name:"skill-usage-optimizer",fn:Y,matcher:"Skill"},{name:"memory-bridge",fn:M,matcher:["mcp__mem0__add_memory","mcp__memory__create_entities"]},{name:"realtime-sync",fn:L,matcher:["Bash","Write","Edit","Skill","Task"]},{name:"user-tracking",fn:B,matcher:"*"}];function Js(t,e){return e==="*"?!0:Array.isArray(e)?e.includes(t):t===e}async function de(t){let e=t.tool_name||"",n=zs.filter(o=>Js(e,o.matcher));if(n.length===0)return a();let r=await Promise.allSettled(n.map(async o=>{try{let i=o.fn(t);return i instanceof Promise&&await i,{hook:o.name,status:"success"}}catch(i){let u=i instanceof Error?i.message:String(i);return c("unified-dispatcher",`${o.name} failed: ${u}`),{hook:o.name,status:"error",message:u}}})),s=[];for(let o of r)o.status==="rejected"?s.push("unknown"):o.value.status==="error"&&s.push(o.value.hook);return s.length>0&&c("posttool-dispatcher",`${s.length}/${n.length} hooks failed: ${s.join(", ")}`),a()}import{appendFileSync as ge,mkdirSync as Ws}from"node:fs";import{execSync as qs}from"node:child_process";function pe(t){if((t.tool_name||"")!=="Write")return a();let n=p(t,"tool_input.file_path")||process.env.TOOL_OUTPUT_FILE_PATH||"";if(!n)return a();if(n.includes("test")||n.includes("spec")||n.includes("__tests__"))return a();if(!/\.(py|ts|tsx|js|jsx)$/.test(n))return a();let r=g(),s="",o=n.split("/").pop()||"";if(n.endsWith(".py"))s=`test_${o.replace(".py","")}.py`;else if(/\.(ts|tsx|js|jsx)$/.test(n))s=`${o.replace(/\.[^.]+$/,"")}.test.*`;else return a();let i="";try{i=qs(`find "${r}" -type f -name "${s}" 2>/dev/null | head -1`,{encoding:"utf8",timeout:5e3}).trim()}catch{}let u=`${r}/.claude/hooks/logs`;try{Ws(u,{recursive:!0});let l=new Date().toISOString();if(i)ge(`${u}/coverage-predictor.log`,`[${l}] COVERAGE_OK: ${n} has tests at ${i}
`);else return ge(`${u}/coverage-predictor.log`,`[${l}] COVERAGE_WARN: ${n} may lack test coverage (expected: ${s})
`),{continue:!0,systemMessage:`Consider adding tests for: ${n}`}}catch{}return a()}import{existsSync as at,statSync as Gs,appendFileSync as Zs,mkdirSync as Ks}from"node:fs";function Xs(t,e){let n=t.split("/").pop()||"",r=t.split("/").slice(0,-1).join("/"),s=(t.split(".").pop()||"").toLowerCase();switch(n){case"package.json":if(at(`${e}/${t}`))try{let o=v(`${e}/${t}`);if(Object.keys(o.scripts||{}).length>5)return{changeType:"scripts",readmeSection:"Available Scripts",suggestion:"Update README with new npm scripts"}}catch{}break;case"pyproject.toml":case"setup.py":case"setup.cfg":return{changeType:"python-config",readmeSection:"Installation",suggestion:"Verify README installation instructions match project config"};case"Dockerfile":case"docker-compose.yml":case"docker-compose.yaml":return{changeType:"docker",readmeSection:"Docker / Deployment",suggestion:"Update README Docker instructions"};case".env.example":case".env.template":return{changeType:"env",readmeSection:"Environment Variables",suggestion:"Update README environment variable documentation"}}if(t.includes("/api/")||t.includes("/routes/")||t.includes("/endpoints/"))return{changeType:"api",readmeSection:"API Endpoints",suggestion:"Update README API documentation or OpenAPI spec"};if(r.includes("/config")||r.includes("/settings"))return{changeType:"config",readmeSection:"Configuration",suggestion:"Document new configuration options in README"};if(["index.ts","index.js","main.py","app.py","__init__.py"].includes(n)&&t.split("/").length<=4)return{changeType:"entry-point",readmeSection:"Getting Started",suggestion:"Review README getting started section for accuracy"};if((t.includes("/bin/")||t.includes("/cli/")||t.includes("/scripts/"))&&["sh","py","ts"].includes(s))return{changeType:"cli",readmeSection:"CLI / Commands",suggestion:"Update README CLI usage documentation"};if(n==="index.ts"||n==="index.js"){let o=`${e}/${t}`;if(at(o))try{let{readFileSync:i}=v("fs");if((i(o,"utf8").match(/^export/gm)||[]).length>5)return{changeType:"exports",readmeSection:"API Reference",suggestion:"Consider updating API reference with new exports"}}catch{}}return null}function Ys(t){for(let e of["README.md","Readme.md","readme.md","README.rst","README"])if(at(`${t}/${e}`))return`${t}/${e}`;return null}function me(t){if((t.tool_name||"")!=="Write")return a();let n=p(t,"tool_input.file_path")||"";if(!n)return a();if(n.includes("/.claude/")||n.includes("/node_modules/")||n.includes("/.git/")||n.includes("/dist/")||n.endsWith(".lock")||n.endsWith(".log"))return a();if(n.includes("test")||n.includes("spec")||n.includes("__tests__"))return a();let r=g(),s=Xs(n,r);if(!s)return a();let o=Ys(r),i;if(o){let l=0;try{let k=Gs(o).mtime.getTime(),h=Date.now();l=Math.floor((h-k)/(86400*1e3))}catch{}let d=s.suggestion;l>30&&(d=`${d} (README last updated ${l}+ days ago)`),i=`README sync: ${s.changeType} change in ${n.split("/").pop()}. Section: '${s.readmeSection}'. ${d}`}else i=`README sync: ${s.changeType} change detected but no README.md found. Consider creating one.`;i.length>200&&(i=`README sync: ${s.changeType} change detected. Consider updating '${s.readmeSection}' section.`);let u=`${r}/.claude/hooks/logs`;try{Ks(u,{recursive:!0});let l=new Date().toISOString();Zs(`${u}/readme-sync.log`,`[${l}] README_SYNC: ${s.changeType} change in ${n} -> ${s.readmeSection}
`)}catch{}return c("readme-sync",`README_SYNC: ${s.changeType} change suggests README update`),{continue:!0,hookSpecificOutput:{additionalContext:i}}}import{existsSync as Vs}from"node:fs";function fe(t){let n=`${g()}/.claude/coordination/lib/coordination.sh`;return Vs(n)?a():a()}import{existsSync as ct,readFileSync as Qs}from"node:fs";import{execSync as ye}from"node:child_process";function to(){try{ye("which sqlite3",{stdio:"ignore",timeout:2e3});let e=`${g()}/.claude/coordination/.claude.db`;return ct(e)}catch{return!1}}function eo(t,e){let r=`${g()}/.claude/coordination/.claude.db`;if(!ct(r))return!1;try{let s=t.replace(/'/g,"''"),o=e.replace(/'/g,"''");return ye(`sqlite3 "${r}" "DELETE FROM file_locks WHERE file_path = '${s}' AND instance_id = '${o}';"`,{stdio:"ignore",timeout:5e3}),c("file-lock-release",`Released lock for ${t}`),!0}catch(s){return c("file-lock-release",`Failed to release lock for ${t}: ${s}`),!1}}function no(){if(process.env.INSTANCE_ID)return process.env.INSTANCE_ID;let e=`${g()}/.claude/.instance_env`;if(ct(e))try{let r=Qs(e,"utf8").match(/CLAUDE_INSTANCE_ID=["']?([^"'\n]+)/);if(r)return r[1]}catch{}return m()}function he(t){let e=t.tool_name||"";if(e!=="Write"&&e!=="Edit")return a();if(!to())return a();let n=p(t,"tool_input.file_path")||"";if(!n)return a();if(n.includes("/.claude/coordination/"))return a();let r=String(p(t,"tool_result")||"");if(r.includes("error")||r.includes("Error"))return a();let s=no();return eo(n,s),a()}import{existsSync as ut,readFileSync as ke,writeFileSync as _e,mkdirSync as ro}from"node:fs";import{join as be,dirname as so}from"node:path";var lt=[/\b(all )?tests?\s*(passed|passing|pass)\b/i,/\b(test|tests)\s*(suite)?\s*(passed|successful|succeeded)\b/i,/\b\d+\s*passed?,?\s*0\s*failed\b/i,/\bOK\s*\(\d+\s*tests?\)/i,/\bbuild\s*(succeeded|successful|complete(d)?)\b/i,/\bcompiled?\s*successfully\b/i,/\bbundle\s*(created|generated)\b/i,/\bfixed\b/i,/\bresolved\b/i,/\bsolved\b/i,/\bnow works\b/i,/\bworking\s*(now|correctly|properly)\b/i,/\bno\s*(more\s*)?(errors?|issues?|problems?)\b/i,/\bsuccess(ful(ly)?)?\b/i,/\bready\s*(for|to)\b/i,/\bcomplete(d)?\b/i],Se=[/\b(tests?\s*)?(failed|failing|failure)\b/i,/\berror(s)?\b/i,/\bexception\b/i,/\bcrash(ed|ing)?\b/i,/\btimeout\b/i,/\bnot\s*(found|working|defined)\b/i,/\bundefined\b/i,/\bsyntax\s*error\b/i,/\btype\s*error\b/i,/\bcannot\s*(find|read|import)\b/i];function xe(){return be(g(),".claude","memory","open-problems.jsonl")}function oo(){return be(g(),".claude","memory","problem-solutions.jsonl")}function io(t){let e=xe();if(!ut(e))return[];try{let r=ke(e,"utf-8").trim().split(`
`).filter(Boolean),s=[];for(let o of r)try{let i=JSON.parse(o);i.status==="open"&&(!t||i.session_id===t)&&s.push(i)}catch{}return s.slice(-50).reverse()}catch(n){return c("problem-tracker",`Failed to load open problems: ${n}`,"warn"),[]}}function ao(t,e,n){let r=xe();if(!ut(r))return!1;try{let o=ke(r,"utf-8").trim().split(`
`).filter(Boolean),i=!1,u=o.map(l=>{try{let d=JSON.parse(l);return d.id===t?(d.status=e,n&&(d.solution=n),i=!0,JSON.stringify(d)):l}catch{return l}});return i&&_e(r,u.join(`
`)+`
`),i}catch(s){return c("problem-tracker",`Failed to update problem ${t}: ${s}`,"warn"),!1}}function co(t){let e=oo();try{let n=so(e);ut(n)||ro(n,{recursive:!0});let r=JSON.stringify(t)+`
`;return _e(e,r,{flag:"a"}),c("problem-tracker",`Stored problem-solution pair: ${t.problem_id} \u2192 ${t.tool}`,"info"),!0}catch(n){return c("problem-tracker",`Failed to store pair: ${n}`,"warn"),!1}}function dt(t){return lt.some(e=>e.test(t))}function uo(t){return Se.some(e=>e.test(t))}function lo(t,e,n,r){let s=.3;r===0?s+=.2:r!==void 0&&r!==0&&(s-=.3);let o=lt.filter(d=>d.test(e)).length;s+=Math.min(.3,o*.1);let i=Se.filter(d=>d.test(e)).length;s-=Math.min(.4,i*.15);let u=e.toLowerCase(),l=t.entities.filter(d=>u.includes(d.toLowerCase()));return s+=Math.min(.15,l.length*.05),n==="Bash"?/test|pytest|jest|vitest/i.test(e)&&(s+=.1):(n==="Write"||n==="Edit")&&(s+=.05),Math.max(0,Math.min(1,s))}function go(t,e,n){let r=t.split(`
`).filter(s=>s.trim());for(let s of lt){let o=t.match(s);if(o){let i=po(t,o.index||0);if(i)return i.slice(0,200)}}for(let s of r.slice(0,5)){let o=s.trim();if(o.length>10&&o.length<200)return o}return n?`${e} operation on ${n.split("/").pop()} completed`:`${e} completed successfully`}function po(t,e,n=100){let r=Math.max(0,e-20),s=Math.min(t.length,e+n),o=t.slice(r,s).trim();o=o.replace(/\s+/g," ");let i=o.search(/[.!?]\s/);return i>20&&(o=o.slice(0,i+1)),o}function ve(t,e,n,r,s){if(uo(t)&&!dt(t))return 0;let o=io(s);if(o.length===0)return 0;let i=g().split("/").pop()||"unknown",u=new Date().toISOString(),l=0;for(let d of o){let y=lo(d,t,e,r);if(y>=.6){let k={text:go(t,e,n),tool:e,file:n,timestamp:u,confidence:y,exit_code:r};if(ao(d.id,"solved",k)){let $={problem_id:d.id,problem_text:d.text,solution_text:k.text,tool:e,file:n,entities:d.entities,confidence:y,paired_at:u,session_id:s,project:i};co($)&&l++}}}return l}var $e="solution-detector",mo=20,fo=["Bash","Write","Edit","Task"];function Ie(t){let e=t.tool_name||"";if(!fo.includes(e))return a();let n=yo(t);if(!n||n.length<mo)return a();if(!dt(n))return a();let r=t.session_id||m(),s=t.exit_code,o=p(t,"tool_input.file_path");try{let i=ve(n,e,o,s,r);i>0&&c($e,`Paired ${i} problem(s) with solution from ${e}`,"info")}catch(i){c($e,`Error pairing solutions: ${i}`,"warn")}return a()}function yo(t){let e=t.tool_result;if(typeof e=="string")return e;if(e&&typeof e=="object"){let s=e.content;if(typeof s=="string")return s}let n=t.tool_output;if(typeof n=="string")return n;if(n&&typeof n=="object"){let s=n.content;if(typeof s=="string")return s}let r=t.output;return typeof r=="string"?r:""}import{existsSync as Ee,readFileSync as ho,writeFileSync as ko,mkdirSync as _o}from"node:fs";import{join as bo,dirname as So}from"node:path";var Ce="tool-preference-learner",xo={Glob:["file_search"],"Bash:find":["file_search"],"Bash:ls":["file_search"],Grep:["content_search"],"Bash:grep":["content_search"],"Bash:rg":["content_search"],"Bash:ag":["content_search"],Read:["code_reading"],"Bash:cat":["code_reading"],"Bash:head":["code_reading"],"Bash:tail":["code_reading"],Write:["code_writing"],Edit:["code_writing"],MultiEdit:["code_writing"],NotebookEdit:["code_writing"],"Bash:test":["testing"],"Bash:pytest":["testing"],"Bash:jest":["testing"],"Bash:vitest":["testing"],"Bash:npm_test":["testing"],"Bash:build":["building"],"Bash:npm_run_build":["building"],"Bash:make":["building"],"Bash:cargo_build":["building"],"Bash:tsc":["building"],"Bash:git":["git_operations"],"Bash:gh":["git_operations"],"Skill:commit":["git_operations"],"Skill:create-pr":["git_operations"],Task:["agent_spawn"]},vo=[[/\bfind\s+/,"Bash:find"],[/\bls\s+/,"Bash:ls"],[/\bgrep\s+/,"Bash:grep"],[/\brg\s+/,"Bash:rg"],[/\bag\s+/,"Bash:ag"],[/\bcat\s+/,"Bash:cat"],[/\bhead\s+/,"Bash:head"],[/\btail\s+/,"Bash:tail"],[/\bpytest\b/,"Bash:pytest"],[/\bjest\b/,"Bash:jest"],[/\bvitest\b/,"Bash:vitest"],[/\bnpm\s+test\b/,"Bash:npm_test"],[/\bnpm\s+run\s+build\b/,"Bash:npm_run_build"],[/\bmake\b/,"Bash:make"],[/\bcargo\s+build\b/,"Bash:cargo_build"],[/\btsc\b/,"Bash:tsc"],[/\bgit\s+/,"Bash:git"],[/\bgh\s+/,"Bash:gh"]];function $o(t){for(let[e,n]of vo)if(e.test(t))return n;return"Bash:other"}function Io(t,e,n){return t==="Bash"&&e?$o(e):t==="Skill"&&n?`Skill:${n}`:t}function wo(t){return xo[t]||["other"]}function Te(){return bo(g(),".claude","memory","tool-preferences.json")}function Eo(){let t=Te();if(!Ee(t))return we();try{let e=ho(t,"utf-8");return JSON.parse(e)}catch{return we()}}function Co(t){let e=Te();try{let n=So(e);return Ee(n)||_o(n,{recursive:!0}),ko(e,JSON.stringify(t,null,2)),!0}catch(n){return c(Ce,`Failed to save preferences: ${n}`,"warn"),!1}}function we(){let t=["file_search","content_search","code_reading","code_writing","testing","building","git_operations","agent_spawn","other"],e={},n={};for(let r of t)e[r]={},n[r]=null;return{usage:e,preferences:n,updated_at:new Date().toISOString()}}function To(t,e){let n=Object.entries(e);if(n.length===0)return null;n.sort((d,y)=>y[1]-d[1]);let[r,s]=n[0],o=n.reduce((d,[,y])=>d+y,0),i=Math.min(1,s/10),u=s/o,l=i*.4+u*.6;return l<.3||s<2?null:{category:t,preferred_tool:r,confidence:l,sample_count:s,updated_at:new Date().toISOString()}}function Ro(t){let e=Object.keys(t.usage);for(let n of e)t.preferences[n]=To(n,t.usage[n]);t.updated_at=new Date().toISOString()}function Re(t){let e=t.tool_name||"";if(!e)return a();let n=p(t,"tool_input.command"),r=p(t,"tool_input.skill"),s=Io(e,n,r),i=wo(s).filter(l=>l!=="other");if(i.length===0)return a();let u=Eo();for(let l of i)u.usage[l]||(u.usage[l]={}),u.usage[l][s]=(u.usage[l][s]||0)+1;Ro(u),Co(u);for(let l of i){let d=u.preferences[l];d&&d.confidence>.7&&d.sample_count===10&&c(Ce,`Strong preference detected: ${l} \u2192 ${d.preferred_tool} (${(d.confidence*100).toFixed(0)}%)`,"info")}return a()}var De={"posttool/audit-logger":A,"posttool/unified-error-handler":vt,"posttool/auto-lint":$t,"posttool/context-budget-monitor":Ct,"posttool/coordination-heartbeat":j,"posttool/mem0-webhook-handler":N,"posttool/memory-bridge":M,"posttool/realtime-sync":L,"posttool/user-tracking":B,"posttool/session-metrics":z,"posttool/skill-edit-tracker":J,"posttool/calibration-tracker":W,"posttool/unified-dispatcher":de,"posttool/write/code-style-learner":Z,"posttool/write/coverage-predictor":pe,"posttool/write/naming-convention-learner":K,"posttool/write/readme-sync":me,"posttool/write/release-lock-on-commit":fe,"posttool/bash/issue-progress-commenter":V,"posttool/bash/issue-subtask-updater":Q,"posttool/bash/pattern-extractor":G,"posttool/skill/skill-usage-optimizer":Y,"posttool/write-edit/file-lock-release":he,"posttool/solution-detector":Ie,"posttool/tool-preference-learner":Re};function ru(t){return De[t]}function su(){return Object.keys(De)}export{Yo as escapeRegex,tt as estimateTokenCount,We as extractIssueNumber,Lo as getCachedBranch,Ue as getCurrentBranch,si as getDefaultBranch,p as getField,Je as getGitStatus,ru as getHook,mt as getLogDir,Ne as getLogLevel,D as getPluginRoot,g as getProjectDir,ei as getRepoRoot,m as getSessionId,ri as hasUncommittedChanges,De as hooks,Ao as isBashInput,Po as isEditInput,ni as isGitRepo,ze as isProtectedBranch,Ho as isReadInput,Oo as isWriteInput,su as listHooks,c as logHook,Go as logPermissionFeedback,Xo as normalizeCommand,zo as outputAllowWithContext,Bo as outputBlock,qo as outputDeny,Jo as outputError,Le as outputPromptContext,Zo as outputPromptContextBudgeted,Fo as outputSilentAllow,a as outputSilentSuccess,Wo as outputWarning,Uo as outputWithContext,Ko as readHookInput,Me as shouldLog,oi as validateBranchName};
//# sourceMappingURL=posttool.mjs.map
