// OrchestKit Hooks - subagent bundle
// Generated: 2026-02-02T17:32:45.175Z

var Z=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,r)=>(typeof require<"u"?require:e)[r]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});function fs(t){return typeof t.command=="string"}function ys(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function ks(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function hs(t){return typeof t.file_path=="string"&&t.content===void 0}import{appendFileSync as Ct,existsSync as Ot,statSync as pn,renameSync as mn,mkdirSync as fn,readSync as yn}from"node:fs";import{execSync as kn}from"node:child_process";import We from"node:os";import B from"node:path";function Ve(){return process.env.HOME||process.env.USERPROFILE||We.homedir()}function tt(){return process.env.CLAUDE_PROJECT_DIR||"."}function wt(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function At(){return process.env.CLAUDE_PLUGIN_ROOT?B.join(Ve(),".claude","logs","ork"):B.join(tt(),".claude","logs")}var Is=B.join,vs=B.sep;import{execSync as Ke}from"node:child_process";import{createHash as Qe}from"node:crypto";import{existsSync as Tt,readFileSync as Xe,writeFileSync as Ye,mkdirSync as Ze}from"node:fs";import{join as et,basename as tn}from"node:path";var en=20,nn=15,rn=/[^a-z0-9-]/g;function sn(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),r=tn(e);return Dt(r,en)}function on(t){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let r=Ke("git branch --show-current",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),n=Dt(r||"detached",nn);return process.env.ORCHESTKIT_SESSION_BRANCH=n,n}catch{return"nobranch"}}function an(t){let e=t||new Date,r=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0");return`${r}${n}`}function cn(t){let e=t||new Date,r=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0");return`${r}${n}`}function un(){let t=`${process.pid}-${Date.now()}-${Math.random()}`;return Qe("sha256").update(t).digest("hex").slice(0,4)}function Dt(t,e){return t.toLowerCase().replace(rn,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,e)}function gn(t,e){let r=sn(t),n=on(t),i=an(e),s=cn(e),o=un();return`${r}-${n}-${i}-${s}-${o}`}function dn(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),r=et(e,".instance","session-id.json");if(Tt(r))try{let n=JSON.parse(Xe(r,"utf8"));if(n.session_id&&n.created_at){let i=Date.now()-new Date(n.created_at).getTime(),s=1440*60*1e3;if(i<s)return n.session_id}}catch{}}function ln(t,e){let r=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=et(r,".instance"),i=et(n,"session-id.json");try{Tt(n)||Ze(n,{recursive:!0}),Ye(i,JSON.stringify({session_id:t,created_at:new Date().toISOString()},null,2))}catch{}}function Rt(t){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let e=dn(t);if(e)return e;let r=gn(t);return ln(r,t),r}function Et(){return At()}function d(){return tt()}function hn(){return wt()}function Ps(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${hn()}/.claude/.instance_env`}function k(){return Rt()}function Ns(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let e=kn("git branch --show-current",{cwd:t||d(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function Sn(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function js(t){return t.replace(/\r\n/g,`
`)}function _n(t){let e=["debug","info","warn","error"];return e.indexOf(t)>=e.indexOf(Sn())}function l(){return{continue:!0,suppressOutput:!0}}function Hs(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function Fs(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function w(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function bn(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function Ms(t,e){let r={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?r.systemMessage=e:r.suppressOutput=!0,r}function Ls(t){return{continue:!0,systemMessage:t}}function j(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function nt(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}function Us(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:t}}}var In=200*1024,vn=100*1024;function Pt(t,e){if(Ot(t))try{if(pn(t).size>e){let n=`${t}.old.${Date.now()}`;mn(t,n)}}catch{}}function Nt(t){Ot(t)||fn(t,{recursive:!0})}function c(t,e,r="debug"){if(!_n(r))return;let n=Et(),i=`${n}/hooks.log`;try{Nt(n),Pt(i,In);let s=new Date().toISOString().replace("T"," ").slice(0,19);Ct(i,`[${s}] [${r.toUpperCase()}] [${t}] ${e}
`)}catch{}}function Bs(t,e,r){let n=Et(),i=`${n}/permission-feedback.log`;try{Nt(n),Pt(i,vn);let s=new Date().toISOString(),o=r?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",a=r?.session_id||k();Ct(i,`${s} | ${t} | ${e} | tool=${o} | session=${a}
`)}catch{}}function xn(t){if(!t)return 0;let n=(t.match(/[{};()=><]/g)||[]).length/t.length>.03?2.8:3.5;return Math.ceil(t.length/n)}function qs(t,e,r,n,i){let s=xn(t);return n&&n.isOverBudget(r)?(c(e,`Budget exhausted for ${r}, suppressing ${s}t`),l()):(i&&i.trackTokenUsage(e,r,s),bn(t))}function Gs(){try{let t=[],r=Buffer.allocUnsafe(256),n,i=0;for(;;)try{if(n=yn(i,r,0,256,null),n===0)break;t.push(Buffer.from(r.subarray(0,n)))}catch{break}let s=Buffer.concat(t).toString("utf8").trim();return s?JSON.parse(s):{tool_name:"",session_id:k(),tool_input:{}}}catch{return{tool_name:"",session_id:k(),tool_input:{}}}}function Js(t,e){let r=e.replace(/^\./,"").split("."),n=t;for(let i of r){if(n==null)return;n=n[i]}return n}function zs(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function Ws(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var Ks={AUTO_DISPATCH:85,SKILL_INJECT:80,STRONG_RECOMMEND:70,SUGGEST:50,MINIMUM:40},Qs={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};import{existsSync as H,readFileSync as Ht,writeFileSync as Ft,mkdirSync as $n}from"node:fs";function rt(){return`${d()}/.claude/orchestration`}function it(){let t=k();return`${rt()}/session-${t}.json`}function Mt(){return`${d()}/.claude/orchestration/config.json`}function Lt(){let t=rt();if(!H(t))try{$n(t,{recursive:!0})}catch{c("orchestration-state",`Failed to create state dir: ${t}`)}}function v(){let t=it();if(H(t))try{let e=Ht(t,"utf8");return JSON.parse(e)}catch(e){c("orchestration-state",`Failed to load state: ${e}`)}return{sessionId:k(),activeAgents:[],injectedSkills:[],promptHistory:[],maxHistorySize:10,updatedAt:new Date().toISOString()}}function wn(t){Lt();let e=it();t.updatedAt=new Date().toISOString();try{Ft(e,JSON.stringify(t,null,2))}catch(r){c("orchestration-state",`Failed to save state: ${r}`)}}function E(t){let e=v();return t(e),wn(e),e}function to(t,e,r){let n={agent:t,taskId:r,confidence:e,dispatchedAt:new Date().toISOString(),status:"pending",retryCount:0,maxRetries:3};return E(i=>{i.activeAgents=i.activeAgents.filter(s=>s.agent!==t),i.activeAgents.push(n)}),c("orchestration-state",`Tracked dispatched agent: ${t} (conf: ${e})`),n}function C(t,e,r){E(n=>{let i=n.activeAgents.find(s=>s.agent===t);i&&(i.status=e,r&&(i.taskId=r),e==="retrying"&&i.retryCount++)}),c("orchestration-state",`Updated agent status: ${t} -> ${e}`)}function st(t){E(e=>{e.activeAgents=e.activeAgents.filter(r=>r.agent!==t)})}function eo(){return v().activeAgents.find(e=>e.status==="in_progress")}function no(t){return v().activeAgents.some(r=>r.agent===t&&(r.status==="pending"||r.status==="in_progress"))}function ro(t){E(e=>{e.injectedSkills.includes(t)||e.injectedSkills.push(t)})}function io(t){return v().injectedSkills.includes(t)}function so(){return v().injectedSkills}function oo(t){E(e=>{e.promptHistory.push(t),e.promptHistory.length>e.maxHistorySize&&(e.promptHistory=e.promptHistory.slice(-e.maxHistorySize))})}function ao(){return v().promptHistory}function co(t){E(e=>{e.lastClassification=t})}function uo(){return v().lastClassification}var jt={enableAutoDispatch:!0,enableSkillInjection:!0,maxSkillInjectionTokens:800,enableCalibration:!0,enablePipelines:!0,maxRetries:3,retryDelayBaseMs:1e3};function ot(){let t=Mt();if(H(t))try{let e=Ht(t,"utf8");return{...jt,...JSON.parse(e)}}catch{}return jt}function go(t){Lt();let e=Mt(),n={...ot(),...t};try{Ft(e,JSON.stringify(n,null,2))}catch(i){c("orchestration-state",`Failed to save config: ${i}`)}}function lo(){let t=it();try{if(H(t)){let{unlinkSync:e}=Z("node:fs");e(t),c("orchestration-state","Cleared session state")}}catch{}}function po(){let t=rt();if(H(t))try{let{readdirSync:e,statSync:r,unlinkSync:n}=Z("node:fs"),i=e(t).filter(s=>s.startsWith("session-")&&s.endsWith(".json")).map(s=>({name:s,path:`${t}/${s}`,mtime:r(`${t}/${s}`).mtime.getTime()})).sort((s,o)=>o.mtime-s.mtime);for(let s of i.slice(5))try{n(s.path),c("orchestration-state",`Cleaned up old state: ${s.name}`)}catch{}}catch{}}var An=3,Tn=1e3,Dn=3e4,Rn={"backend-system-architect":["database-engineer","api-designer"],"frontend-ui-developer":["rapid-ui-designer","accessibility-specialist"],"test-generator":["debug-investigator","code-quality-reviewer"],"security-auditor":["security-layer-auditor"],"workflow-architect":["llm-integrator","data-pipeline-engineer"]},Cn=[/permission denied/i,/access denied/i,/not found.*(?:file|module|package)/i,/(?:file|module|package)\s+not\s+found/i,/missing required/i,/invalid (?:api|token|key)/i,/authentication failed/i,/quota exceeded/i,/rate limit/i],On=[/not my specialization/i,/outside my scope/i,/better suited for/i,/consider using/i,/specialized agent/i];function En(t,e=Tn){let r=e*Math.pow(2,t-1),n=Math.random()*.1*r;return Math.min(r+n,Dn)}function Pn(t){for(let e of Cn)if(e.test(t))return!1;return!0}function Nn(t){for(let e of On)if(e.test(t))return!0;return!1}function at(t,e=[]){let r=Rn[t];if(r){for(let n of r)if(!e.includes(n))return n}}function Ut(t,e,r,n=[],i=An){if(c("retry-manager",`Evaluating retry for ${t}, attempt ${e}`),e>=i){let o=at(t,n);return{shouldRetry:!1,retryCount:e,maxRetries:i,alternativeAgent:o,reason:`Max retries (${i}) exceeded`+(o?`. Consider trying ${o} instead.`:"")}}if(!Pn(r)){let o=at(t,n);return{shouldRetry:!1,retryCount:e,maxRetries:i,alternativeAgent:o,reason:`Non-retryable error detected: ${r.slice(0,100)}`}}if(Nn(r)){let o=at(t,n);if(o)return{shouldRetry:!1,retryCount:e,maxRetries:i,alternativeAgent:o,reason:`Error suggests using alternative agent: ${o}`}}let s=En(e);return{shouldRetry:!0,retryCount:e,maxRetries:i,delayMs:s,reason:`Retrying (attempt ${e+1}/${i}) after ${Math.round(s/1e3)}s`}}function Bt(t,e,r){return{agent:t,taskId:r,attemptNumber:e,startedAt:new Date().toISOString()}}function qt(t,e,r){let n=new Date().toISOString(),i=new Date(n).getTime()-new Date(t.startedAt).getTime();return{...t,completedAt:n,outcome:e,error:r,durationMs:i}}function yo(t){if(t.length===0)return{successRate:0,avgDuration:0,commonErrors:[]};let r=t.filter(a=>a.outcome==="success").length/t.length,n=t.filter(a=>a.durationMs!==void 0).map(a=>a.durationMs),i=n.length>0?n.reduce((a,u)=>a+u,0)/n.length:0,s=new Map;for(let a of t)if(a.error){let u=a.error.slice(0,50).toLowerCase();s.set(u,(s.get(u)||0)+1)}let o=Array.from(s.entries()).sort((a,u)=>u[1]-a[1]).slice(0,3).map(([a])=>a);return{successRate:r,avgDuration:i,commonErrors:o}}function ko(t,e){return{...t,status:"retrying",retryCount:e.retryCount}}function Gt(t,e){if(t.shouldRetry)return`## Retry Scheduled

Agent \`${e}\` will retry after ${Math.round((t.delayMs||0)/1e3)} seconds.

**Attempt:** ${t.retryCount+1} of ${t.maxRetries}
**Reason:** ${t.reason}`;let r=`## Retry Not Recommended

Agent \`${e}\` has ${t.retryCount>=t.maxRetries?"exhausted retries":"encountered a non-retryable error"}.

**Reason:** ${t.reason}`;return t.alternativeAgent&&(r+=`

### Alternative Suggestion

Consider using \`${t.alternativeAgent}\` instead:

\`\`\`
Task tool with subagent_type: "${t.alternativeAgent}"
\`\`\``),r}import{existsSync as Vt,readFileSync as jn,writeFileSync as Hn,mkdirSync as Fn}from"node:fs";import{createHash as Mn}from"node:crypto";var Jt=500,ct=3,zt=15,Wt=3,Ln=.9;function Kt(){return`${d()}/.claude/feedback/calibration-data.json`}function Un(){let t=`${d()}/.claude/feedback`;if(!Vt(t))try{Fn(t,{recursive:!0})}catch{}}function F(){let t=Kt();if(Vt(t))try{return JSON.parse(jn(t,"utf8"))}catch{c("calibration-engine","Failed to load calibration data, using defaults")}return{schemaVersion:"1.0.0",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),records:[],adjustments:[],stats:{totalDispatches:0,successRate:0,avgConfidence:0,topAgents:[]}}}function Bn(t){Un();let e=Kt();t.updatedAt=new Date().toISOString();try{Hn(e,JSON.stringify(t,null,2)),c("calibration-engine","Saved calibration data")}catch(r){c("calibration-engine",`Failed to save calibration data: ${r}`)}}function qn(t){return Mn("sha256").update(t.toLowerCase().trim()).digest("hex").slice(0,16)}function Io(t,e,r,n,i,s,o){let a=F(),u={timestamp:new Date().toISOString(),sessionId:k(),agent:e,promptHash:qn(t),matchedKeywords:r,dispatchConfidence:n,outcome:i,durationMs:s,feedback:o};a.records.push(u),a.records.length>Jt&&(a.records=a.records.slice(-Jt)),Gn(a,u),Jn(a),Bn(a),c("calibration-engine",`Recorded outcome: ${e} -> ${i} (conf: ${n})`)}function Gn(t,e){let r=e.outcome==="success",n=e.outcome==="failure"||e.outcome==="rejected";if(!r&&!n)return;let i=r?Wt:-Wt;for(let s of e.matchedKeywords){let o=t.adjustments.find(a=>a.keyword===s&&a.agent===e.agent);o?(o.adjustment=Math.max(-zt,Math.min(zt,o.adjustment+i)),o.sampleCount++,o.lastUpdated=new Date().toISOString()):t.adjustments.push({keyword:s,agent:e.agent,adjustment:i,sampleCount:1,lastUpdated:new Date().toISOString()})}}function vo(t){let e=Date.now(),r=1440*60*1e3;for(let n of t.adjustments){let i=e-new Date(n.lastUpdated).getTime();Math.floor(i/r)>7&&(n.adjustment=Math.round(n.adjustment*Ln),Math.abs(n.adjustment)<1&&(n.adjustment=0))}t.adjustments=t.adjustments.filter(n=>n.adjustment!==0)}function Jn(t){let e=t.records;if(e.length===0)return;t.stats.totalDispatches=e.length;let r=e.filter(s=>s.outcome==="success").length;t.stats.successRate=r/e.length;let n=e.reduce((s,o)=>s+o.dispatchConfidence,0)/e.length;t.stats.avgConfidence=Math.round(n);let i=new Map;for(let s of e){let o=i.get(s.agent)||{count:0,success:0};o.count++,s.outcome==="success"&&o.success++,i.set(s.agent,o)}t.stats.topAgents=Array.from(i.entries()).map(([s,o])=>({agent:s,count:o.count,successRate:o.success/o.count})).sort((s,o)=>o.count-s.count).slice(0,10)}function xo(){return F().adjustments.filter(e=>e.sampleCount>=ct)}function $o(t){let r=F().records.filter(i=>i.agent===t);return r.length<ct?null:r.filter(i=>i.outcome==="success").length/r.length}function wo(){return F().stats}function Ao(){return F().records.length>=ct}import{existsSync as zn,statSync as Wn}from"node:fs";import{resolve as Vn}from"node:path";var Xt={"database-engineer":"database schema SQL PostgreSQL migration pgvector","backend-system-architect":"API REST architecture backend FastAPI microservice","frontend-ui-developer":"React frontend UI component TypeScript Tailwind","security-auditor":"security OWASP vulnerability audit authentication","test-generator":"testing unit integration coverage pytest MSW","workflow-architect":"LangGraph workflow agent orchestration state","llm-integrator":"LLM API OpenAI Anthropic embeddings RAG function-calling","data-pipeline-engineer":"data pipeline embeddings vector ETL chunking","metrics-architect":"metrics OKR KPI analytics instrumentation","ux-researcher":"UX user research persona journey accessibility","code-quality-reviewer":"code quality review linting type-check patterns","infrastructure-architect":"infrastructure cloud Docker Kubernetes deployment","ci-cd-engineer":"CI CD pipeline GitHub Actions deployment automation","accessibility-specialist":"accessibility WCAG ARIA screen-reader a11y","product-strategist":"product strategy roadmap features prioritization"};function Kn(t){return Xt[t]||t}var Qt=100;function Yt(t){c("graph-memory-inject","Graph memory inject hook starting");let e=Vn(d(),".claude/memory/knowledge-graph.jsonl");if(!zn(e))return c("graph-memory-inject","No graph data file, skipping"),l();try{let u=Wn(e).size;if(u<Qt)return c("graph-memory-inject",`Graph too small (${u}B < ${Qt}B), skipping`),l()}catch{return c("graph-memory-inject","Could not stat graph file, skipping"),l()}let r=t.tool_input||{},n=r.subagent_type||r.type||"";if(!n&&r.prompt){let u=r.prompt.toLowerCase(),g=Object.keys(Xt);for(let p of g)if(u.includes(p)){n=p;break}}if(!n)return c("graph-memory-inject","No agent type detected, passing through"),l();let i=`ork:${n}`,s=Kn(n);c("graph-memory-inject",`Detected agent type: ${n} (agent_id: ${i})`);let o=`[Graph Memory - Agent Context Load]

Execute this MCP call to load graph context for ${n} agent:

## Graph Memory Entities
\`\`\`
mcp__memory__search_nodes
{"query": "${n} ${s}"}
\`\`\`

## Integration Instructions
1. Execute the graph search to retrieve relevant entities and relationships
2. Review entities for patterns, decisions, and constraints
3. Check relationships between concepts
4. Apply learned patterns to current task

Agent ID: ${i} | Domain: ${s}`,a=`[Graph Memory] Agent: ${n} | ID: ${i} | Load graph context via MCP call above`;return c("graph-memory-inject",`Outputting graph memory instructions for ${n}`),{continue:!0,systemMessage:a,hookSpecificOutput:{additionalContext:o}}}import{basename as Qn}from"node:path";var q=5,Xn="agents",Yn="decisions",te={"database-engineer":"database schema SQL PostgreSQL migration pgvector","backend-system-architect":"API REST architecture backend FastAPI microservice","frontend-ui-developer":"React frontend UI component TypeScript Tailwind","security-auditor":"security OWASP vulnerability audit authentication","test-generator":"testing unit integration coverage pytest MSW","workflow-architect":"LangGraph workflow agent orchestration state","llm-integrator":"LLM API OpenAI Anthropic embeddings RAG function-calling","data-pipeline-engineer":"data pipeline embeddings vector ETL chunking","metrics-architect":"metrics OKR KPI analytics instrumentation","ux-researcher":"UX user research persona journey accessibility","code-quality-reviewer":"code quality review linting type-check patterns","infrastructure-architect":"infrastructure cloud Docker Kubernetes deployment","ci-cd-engineer":"CI CD pipeline GitHub Actions deployment automation","accessibility-specialist":"accessibility WCAG ARIA screen-reader a11y","product-strategist":"product strategy roadmap features prioritization"},Zn={"database-engineer":["backend-system-architect","security-auditor","data-pipeline-engineer"],"backend-system-architect":["database-engineer","frontend-ui-developer","security-auditor","llm-integrator"],"frontend-ui-developer":["backend-system-architect","ux-researcher","accessibility-specialist","rapid-ui-designer"],"security-auditor":["backend-system-architect","database-engineer","infrastructure-architect"],"test-generator":["backend-system-architect","frontend-ui-developer","code-quality-reviewer"],"workflow-architect":["llm-integrator","backend-system-architect","data-pipeline-engineer"],"llm-integrator":["workflow-architect","data-pipeline-engineer","backend-system-architect"],"data-pipeline-engineer":["database-engineer","llm-integrator","workflow-architect"]};function tr(t){return te[t]||t}function er(t){return Zn[t]||[]}function ee(){let t=d();return(Qn(t)||"default-project").toLowerCase().replace(/ /g,"-").replace(/[^a-z0-9-]/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-")}function Zt(t){return`${ee()}-${t}`}function nr(t){return`orchestkit-global-${t}`}function ne(t){if(c("mem0-memory-inject","Mem0 memory inject hook starting"),!process.env.MEM0_API_KEY)return c("mem0-memory-inject","Mem0 not configured (no MEM0_API_KEY), skipping"),l();let e=t.tool_input||{},r=e.subagent_type||e.type||"";if(!r&&e.prompt){let R=e.prompt.toLowerCase(),N=Object.keys(te);for(let O of N)if(R.includes(O)){r=O;break}}if(!r)return c("mem0-memory-inject","No agent type detected, passing through"),l();let n=`ork:${r}`,i=ee(),s=Zt(Xn),o=Zt(Yn),a=nr("best-practices"),u=tr(r),g=`${r} patterns decisions ${u}`;c("mem0-memory-inject",`Detected agent type: ${r} (agent_id: ${n})`);let p=er(r),f=JSON.stringify({query:g,filters:{AND:[{user_id:s},{agent_id:n}]},limit:q,enable_graph:!0}),m=JSON.stringify({query:`${u} decisions`,filters:{AND:[{user_id:o}]},limit:q,enable_graph:!0}),_=JSON.stringify({query:`${u} best practices`,filters:{AND:[{user_id:a}]},limit:q,enable_graph:!0}),y=`[Mem0 Cloud - Agent Context Load]

Execute these MCP calls to load mem0 context for ${r} agent:

## 1. Agent-Specific Patterns (mem0)
\`\`\`
mcp__mem0__search_memories
${f}
\`\`\`

## 2. Project Decisions (mem0)
\`\`\`
mcp__mem0__search_memories
${m}
\`\`\`

## 3. Cross-Project Best Practices (mem0)
\`\`\`
mcp__mem0__search_memories
${_}
\`\`\``;if(p.length>0){let R=p.join(", "),N=[{agent_id:n},...p.map(ze=>({agent_id:`ork:${ze}`}))],O=JSON.stringify({query:u,filters:{AND:[{user_id:s},{OR:N}]},limit:q,enable_graph:!0});y+=`

## 4. Cross-Agent Knowledge (from: ${R})
\`\`\`
mcp__mem0__search_memories
${O}
\`\`\``}let h=p.length>0?p.join(", "):"none";y+=`

## Integration Instructions
1. Execute the above MCP calls to retrieve mem0 context
2. Review memories for patterns, decisions, and constraints
3. Apply learned patterns to current task
4. Avoid known anti-patterns (outcome: failed)

Agent ID: ${n} | Domain: ${u} | Related: ${h}`;let D=`[Mem0 Cloud] Agent: ${r} | ID: ${n} | Load mem0 context via MCP calls above | Related: ${h}`;return c("mem0-memory-inject",`Outputting mem0 memory instructions for ${r}`),{continue:!0,systemMessage:D,hookSpecificOutput:{additionalContext:y}}}import{existsSync as M,readFileSync as J,writeFileSync as gt,mkdirSync as rr}from"node:fs";import{dirname as ir}from"node:path";var G=4,ut=6,sr=3,or=/^(test-generator|backend-system-architect|workflow-architect|security-auditor|llm-integrator)$/;function dt(){return`${d()}/.claude/logs/agent-state.json`}function ie(){return`${d()}/.claude/logs/subagent-spawns.jsonl`}function ar(){let t=dt(),e=ir(t);try{rr(e,{recursive:!0})}catch{}if(!M(t)){let r={active_background:[],session_total:0,last_cleanup:null,blocked_count:0};try{gt(t,JSON.stringify(r,null,2))}catch{}}}function cr(){let t=ie();if(!M(t))return 0;try{let n=J(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),i=new Date(Date.now()-300*1e3).toISOString(),s=0;for(let o of n)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>i&&s++}catch{}return s}catch{return 0}}function ur(){let t=ie();if(!M(t))return 0;try{let n=J(t,"utf8").trim().split(`
`).filter(Boolean).slice(-20),i=new Date(Date.now()-2*1e3).toISOString(),s=0;for(let o of n)try{let a=JSON.parse(o);a.timestamp&&a.timestamp>i&&s++}catch{}return s}catch{return 0}}function gr(){let t=dt();try{if(M(t)){let e=JSON.parse(J(t,"utf8"));e.blocked_count=(e.blocked_count||0)+1,gt(t,JSON.stringify(e,null,2))}}catch{}}function re(){let t=dt();try{if(M(t)){let e=JSON.parse(J(t,"utf8"));e.session_total=(e.session_total||0)+1,gt(t,JSON.stringify(e,null,2))}}catch{}}function se(t){ar();let e=t.tool_input||{},r=e.subagent_type||"",n=e.description||"",i=e.run_in_background===!0||e.run_in_background==="true";c("context-gate",`Context gate check: ${r} (background=${i})`);let s=cr(),o=ur();return c("context-gate",`Active background: ${s}, Current response: ${o}`),o>=ut?(c("context-gate",`BLOCKED: Too many agents in single response (${o} >= ${ut})`),nt(`Context Overflow Protection

Too many agents spawned in a single response (${o} agents).

Maximum allowed: ${ut} per response

SOLUTION: Split into multiple responses or use sequential execution.
Consider using the /context-compression skill first.

Attempted: ${r} - ${n}`)):i&&s>=G?(c("context-gate",`BLOCKED: Too many concurrent background agents (${s} >= ${G})`),gr(),nt(`Background Agent Limit

Too many background agents running concurrently (${s} active).

Maximum allowed: ${G} concurrent background agents

SOLUTION:
1. Wait for existing agents to complete
2. Run this agent in foreground (remove run_in_background)
3. Use /context-compression to free up context

Attempted: ${r} - ${n}`)):s>=sr?(c("context-gate","WARNING: Approaching context budget limit"),re(),j(`Context Budget Warning

${s} background agents active (limit: ${G}).

Consider:
- Running remaining agents sequentially
- Using /context-compression skill
- Waiting for current agents to complete

Proceeding with: ${r} - ${n}`)):or.test(r)&&s>=2?(c("context-gate",`WARNING: Expensive agent type with multiple active: ${r}`),j(`Spawning expensive agent (${r}) with ${s} others active`)):(re(),c("context-gate",`Context gate passed: ${r}`),l())}import{existsSync as lt,readFileSync as ae,readdirSync as dr}from"node:fs";function lr(){return`${d()}/.claude/context/session/state.json`}function pr(){return`${d()}/.claude/context/knowledge/decisions/active.json`}function mr(){return`${d()}/docs/issues`}function fr(){let t=lr();if(!lt(t))return{count:0,summary:""};try{let r=JSON.parse(ae(t,"utf8")).tasks_pending||[],n=r.length;if(n===0)return{count:0,summary:""};let i=r.slice(0,3).map(s=>`- ${s}`).join(`
`);return{count:n,summary:i}}catch{return{count:0,summary:""}}}function oe(t,e){let r=pr();if(!lt(r))return"";try{return(JSON.parse(ae(r,"utf8")).decisions||[]).filter(o=>o.category===e||o.category==="api"||o.category==="database").slice(0,5).map(o=>`- ${o.title} (${o.status||"unknown"})`).join(`
`)}catch{return""}}function yr(t){let e=mr();if(!lt(e))return"";try{let n=dr(e).find(i=>i.includes(t));if(n)return`docs/issues/${n}`}catch{}return""}function ce(t){let e=t.tool_input||{},r=e.subagent_type||"",n=e.task_description||e.description||"";c("subagent-context-stager",`Staging context for ${r}`);let i="",{count:s,summary:o}=fr();s>0&&(c("subagent-context-stager",`Found ${s} pending tasks`),i+=`ACTIVE TODOS:
${o}

`);let a=n.toLowerCase();if(/backend|api|endpoint|database|migration/.test(a)){c("subagent-context-stager","Backend task detected - staging backend decisions");let u=oe(n,"backend");u&&(i+=`RELEVANT DECISIONS:
${u}

`)}if(/frontend|react|ui|component/.test(a)){c("subagent-context-stager","Frontend task detected - staging frontend decisions");let u=oe(n,"frontend");u&&(i+=`RELEVANT DECISIONS:
${u}

`)}if(/test|testing|pytest|jest/.test(a)&&(c("subagent-context-stager","Testing task detected - staging test context"),i+=`TESTING REMINDERS:
- Use 'tee' for visible test output
- Check test patterns in backend/tests/ or frontend/src/**/__tests__/
- Ensure coverage meets threshold requirements

`),/issue|#\d+|bug|fix/.test(a)){c("subagent-context-stager","Issue-related task detected");let u=n.match(/#(\d+)/);if(u){let g=u[1],p=yr(g);p&&(i+=`ISSUE DOCS: ${p}

`,c("subagent-context-stager",`Staged issue documentation for #${g}`))}}if(i){let u=`${i}
Task: ${n}
Subagent: ${r}`,g=i.split(`
`).filter(Boolean).length;return c("subagent-context-stager",`Staged context with ${g} lines`),{continue:!0,systemMessage:u}}return c("subagent-context-stager","No context staged for this task"),l()}import{existsSync as L,readFileSync as pt,mkdirSync as kr,appendFileSync as hr,readdirSync as Sr}from"node:fs";import{join as I,dirname as _r}from"node:path";var br=new Set(["general-purpose","Explore","Plan","claude-code-guide","statusline-setup","Bash"]);function Ir(){return I(d(),".claude","logs","subagent-spawns.jsonl")}function vr(){return I(d(),"plugin.json")}function mt(){return I(d(),"agents")}function ft(){return I(d(),".claude","agents")}function xr(){return I(d(),"skills")}function $r(){let t=new Set(br),e=vr();if(L(e))try{let i=JSON.parse(pt(e,"utf8")).agents||[];for(let s of i)s.id&&t.add(s.id)}catch{}let r=[mt(),ft()];for(let n of r)if(L(n))try{let i=Sr(n);for(let s of i)s.endsWith(".md")&&t.add(s.replace(".md",""))}catch{}return t}function wr(t){let e=[],r=[I(mt(),`${t}.md`),I(ft(),`${t}.md`)],n=null;for(let i of r)if(L(i)){n=i;break}if(!n)return e;try{let s=pt(n,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of s){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^skills:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let g=u.match(/^\s*-\s*(.+)$/);if(g){let p=g[1].trim();e.push(p)}}}}}catch{}return e}function Ar(t){let e=wr(t),r=[],n=xr();for(let i of e){let s=I(n,i,"SKILL.md");L(s)||r.push(i)}return r}function Tr(t){let e=[],r=[I(mt(),`${t}.md`),I(ft(),`${t}.md`)],n=null;for(let i of r)if(L(i)){n=i;break}if(!n)return e;try{let s=pt(n,"utf8").replace(/\r\n/g,`
`).split(`
`),o=!1,a=!1;for(let u of s){if(u==="---"){if(o)break;o=!0;continue}if(o){if(/^tools:/.test(u)){a=!0;continue}if(a&&/^[a-zA-Z]/.test(u)&&!/^\s/.test(u)){a=!1;continue}if(a){let g=u.match(/^\s*-\s*(.+)$/);g&&e.push(g[1].trim())}}}}catch{}return e}function Dr(t,e){if(e.length===0)return"";let r=e.every(o=>["Read","Glob","Grep"].includes(o)),n=e.includes("Bash"),i=e.includes("Write")||e.includes("Edit"),s="low";return n&&i?s="elevated":(n||i)&&(s="moderate"),`## Agent Permission Profile (CC 2.1.20)

**Agent**: \`${t}\`
**Tools**: ${e.join(", ")}
**Risk Level**: ${s}${r?" (read-only)":""}

${n?`> This agent requests Bash access. Review commands carefully.
`:""}`}function Rr(t,e,r){let n=Ir(),i=_r(n);try{kr(i,{recursive:!0})}catch{}let s={timestamp:new Date().toISOString(),subagent_type:t,description:e,session_id:r};try{hr(n,JSON.stringify(s)+`
`)}catch{}}function ue(t){let e=t.tool_input||{},r=e.subagent_type||"",n=e.description||"",i=t.session_id||k();c("subagent-validator",`Task invocation: ${r} - ${n}`),Rr(r,n,i);let s=r.replace(/^[^:]+:/,""),o=$r();!o.has(r)&&!o.has(s)&&c("subagent-validator",`WARNING: Unknown subagent type: ${r}`),c("subagent-validator",`Spawning ${r} agent: ${n}`);let a=Ar(s);if(a.length>0){let g=a.join(", ");c("subagent-validator",`WARNING: Agent '${s}' references missing skills: ${g}`),console.error(`Warning: Agent '${s}' references ${a.length} missing skill(s): ${g}`)}let u=Tr(s);if(u.length>0){let g=Dr(s,u);return c("subagent-validator",`Agent '${s}' tools: ${u.join(", ")}`),w(g)}return l()}import{existsSync as ge,readFileSync as Cr,writeFileSync as Or,mkdirSync as Er}from"node:fs";function de(){let t=k();return`${d()}/.claude/orchestration/task-registry-${t}.json`}function Pr(){let t=`${d()}/.claude/orchestration`;if(!ge(t))try{Er(t,{recursive:!0})}catch{}}function P(){let t=de();if(ge(t))try{return JSON.parse(Cr(t,"utf8"))}catch{}return{schemaVersion:"1.0.0",sessionId:k(),tasks:[],pipelines:[],updatedAt:new Date().toISOString()}}function yt(t){Pr();let e=de();t.updatedAt=new Date().toISOString();try{Or(e,JSON.stringify(t,null,2))}catch(r){c("task-integration",`Failed to save registry: ${r}`)}}function le(t,e){return`### Delete Orphaned Task

\`\`\`
TaskUpdate:
  taskId: "${t}"
  status: "deleted"
\`\`\`

**Reason**: ${e}`}function z(t){let e=`### Update Task

\`\`\`
TaskUpdate:
  taskId: "${t.taskId}"`;return t.status&&(e+=`
  status: "${t.status}"`),t.addBlockedBy&&t.addBlockedBy.length>0&&(e+=`
  addBlockedBy: ${JSON.stringify(t.addBlockedBy)}`),t.addBlocks&&t.addBlocks.length>0&&(e+=`
  addBlocks: ${JSON.stringify(t.addBlocks)}`),e+="\n```",e}function x(t,e){let r=P(),n=r.tasks.find(i=>i.taskId===t);n&&(n.status=e,yt(r),c("task-integration",`Updated task ${t} status to ${e}`))}function A(t){return P().tasks.find(r=>r.agent===t&&(r.status==="pending"||r.status==="in_progress"))}function pe(t){return P().tasks.filter(r=>r.status==="pending"&&r.blockedBy&&r.blockedBy.includes(t))}function kt(t){return P().tasks.filter(r=>r.pipelineId===t).sort((r,n)=>(r.pipelineStep||0)-(n.pipelineStep||0))}function me(){return P().pipelines.find(e=>e.status==="running")}function fe(t,e){let r=P(),n=r.pipelines.find(s=>s.pipelineId===t);if(!n)return null;n.completedSteps.includes(e)||(n.completedSteps.push(e),n.completedSteps.sort((s,o)=>s-o));let i=kt(t);for(let s of i){let o=s.pipelineStep;if(o===void 0||n.completedSteps.includes(o)||s.status!=="pending")continue;if(o===0||n.completedSteps.includes(o-1))return n.currentStep=o,yt(r),o}return n.status="completed",yt(r),null}function ye(t){let r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!r)return c("task-linker","No agent type found, skipping"),l();c("task-linker",`Processing SubagentStart for: ${r}`);let n=A(r);if(!n)return c("task-linker",`No orchestration task found for agent: ${r}`),l();c("task-linker",`Found task ${n.taskId} for agent ${r}`),x(n.taskId,"in_progress"),C(r,"in_progress",n.taskId);let i=z({taskId:n.taskId,status:"in_progress"}),s=`## Orchestration: Task Linked

Agent \`${r}\` has been linked to task **${n.taskId}**.

${i}

The task status should be updated to \`in_progress\`.`;return c("task-linker",`Linked agent ${r} to task ${n.taskId}`),w(s)}import{existsSync as Nr,mkdirSync as jr,appendFileSync as Hr,unlinkSync as Fr}from"node:fs";import{basename as Mr,dirname as Lr}from"node:path";var Ur=["decided to","chose","implemented using","selected","opted for","will use","pattern:","approach:","architecture:","recommends","best practice","anti-pattern","learned that"],Br="decisions";function qr(){return`${d()}/.claude/logs/agent-patterns.jsonl`}function Gr(){return`${d()}/.claude/session`}function ke(){let t=d();return(Mr(t)||"default-project").toLowerCase().replace(/ /g,"-").replace(/[^a-z0-9-]/g,"-").replace(/^-+|-+$/g,"").replace(/-+/g,"-")}function Jr(t){return`${ke()}-${t}`}function zr(t){let n=(t.length>10240?t.substring(0,10240):t).toLowerCase();return/pagination|cursor|offset/.test(n)?"pagination":/security|vulnerability|exploit|injection|xss|csrf|owasp|safety|guardrail/.test(n)?"security":/database|sql|postgres|schema/.test(n)?"database":/\bapi\b|endpoint|\brest\b|graphql/.test(n)?"api":/auth|login|jwt|oauth/.test(n)?"authentication":/\btest\b|testing|pytest|jest|vitest|coverage|\bmock\b|fixture|\bspec\b/.test(n)?"testing":/deploy|\bci\b|\bcd\b|pipeline|docker|kubernetes|helm|terraform/.test(n)?"deployment":/observability|monitoring|logging|tracing|metrics|prometheus|grafana|langfuse/.test(n)?"observability":/react|component|frontend|\bui\b/.test(n)?"frontend":/performance|optimization|cache|index/.test(n)?"performance":/llm|\brag\b|embedding|vector|semantic|\bai\b|\bml\b|langchain|langgraph|mem0|openai|anthropic/.test(n)?"ai-ml":/etl|data.*pipeline|streaming|batch.*processing|dataflow|spark/.test(n)?"data-pipeline":/architecture|design|structure/.test(n)?"architecture":/decided|chose|selected/.test(n)?"decision":"pattern"}function Wr(t){let e=[];if(t.length<50)return e;for(let n of Ur){let i=new RegExp(`^.*${n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}.*$`,"gim"),s=t.match(i)||[];for(let o of s){let a=o.trim().substring(0,200);a.length>20&&e.push(a)}}return[...new Set(e)].slice(0,5)}function W(t){c("agent-memory-store","Agent memory store hook starting");let e=t.tool_input||{},r=t.subagent_type||e.subagent_type||e.type||"",n=t.tool_result,i=typeof n=="string"?n:n?.content||t.agent_output||t.output||"",s=!0;if(t.error&&(s=!1),typeof n=="object"&&n?.is_error&&(s=!1),!r)return c("agent-memory-store","No agent type in input, skipping"),l();let o=`ork:${r}`,a=`${Gr()}/current-agent-id`;try{Nr(a)&&Fr(a)}catch{}c("agent-memory-store",`Processing completion for agent: ${r} (agent_id: ${o}, success: ${s})`);let u=s&&i?Wr(i):[];if(u.length===0)return c("agent-memory-store",`No patterns extracted from ${r} output`),l();let g=qr(),p=Lr(g);try{jr(p,{recursive:!0})}catch{}let f=ke(),m=new Date().toISOString(),_=Jr(Br);for(let h of u){let D=zr(h),R={agent:r,agent_id:o,pattern:h,project:f,timestamp:m,suggested_user_id:_,category:D,enable_graph:!0,pending_sync:!0};try{Hr(g,JSON.stringify(R)+`
`)}catch{}c("agent-memory-store",`Extracted pattern (${D}): ${h.substring(0,50)}...`)}return c("agent-memory-store",`Extracted ${u.length} patterns from ${r} output`),{continue:!0,systemMessage:`[Pattern Extraction] ${u.length} patterns extracted from ${r}. Use mcp__mem0__add_memory with user_id='${_}', agent_id='${o}' to persist (graph memory auto-enabled).`}}import{existsSync as Vr,writeFileSync as he,mkdirSync as ht,appendFileSync as Kr,readFileSync as Qr}from"node:fs";import{dirname as Xr}from"node:path";var Yr=[".env","credentials","secret","auth","password","token","api.key","private.key",".pem","oauth","jwt","session","cookie","encryption","crypto"];function Zr(){let t=`${d()}/.claude/hooks/logs`;try{ht(t,{recursive:!0})}catch{}return`${t}/auto-spawn-quality.log`}function ti(){return`${d()}/.claude/context/spawn-queue.json`}function b(t){let e=Zr(),r=new Date().toISOString();try{Kr(e,`[${r}] [auto-spawn-quality] ${t}
`)}catch{}}function ei(t){let e=t.toLowerCase();for(let r of Yr)if(e.includes(r))return b(`Detected sensitive pattern: ${r}`),!0;return!1}function ni(t,e,r,n,i,s){let o=`SPAWN-${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,14)}-${Math.floor(Math.random()*1e4).toString().padStart(4,"0")}`,a=ti(),u=Xr(a);try{ht(u,{recursive:!0})}catch{}let g;if(Vr(a))try{g=JSON.parse(Qr(a,"utf8"))}catch{g={schema_version:"1.0.0",created_at:s,queue:[]}}else g={schema_version:"1.0.0",created_at:s,queue:[]};let p={spawn_id:o,target_agent:e,trigger_agent:t,trigger_reason:r,priority:n,timestamp:s,session_id:i,status:"queued"};g.queue.push(p);try{he(a,JSON.stringify(g,null,2)),b(`Queued spawn request: ${o} for ${e} (reason: ${r})`)}catch{return b(`ERROR: Failed to queue spawn request for ${e}`),""}return o}function ri(t,e,r,n,i,s){let o=`${d()}/.claude/context/handoffs`;try{ht(o,{recursive:!0})}catch{}let a=`${o}/auto_spawn_${e}_${new Date().toISOString().replace(/[-:T.]/g,"").substring(0,15)}.json`,u={type:"auto_spawn_suggestion",from_agent:t,to_agent:e,timestamp:s,trigger_reason:r,priority:n,session_id:i,auto_triggered:!0,status:"suggested"};try{he(a,JSON.stringify(u,null,2)),b(`Created spawn suggestion: ${e} (reason: ${r})`)}catch{}}function ii(t,e,r){if(r&&r!=="null")return b(`Skipping auto-spawn - agent ${t} had errors: ${r}`),null;if(t==="test-generator")return b("Rule matched: test-generator -> code-quality-reviewer"),{target:"code-quality-reviewer",reason:"test-generator completed - validating test quality and coverage",priority:"high"};if(ei(e)&&t!=="security-auditor"&&t!=="security-layer-auditor")return b("Rule matched: sensitive files detected -> security-auditor"),{target:"security-auditor",reason:"sensitive file changes detected - security audit required",priority:"critical"};if(t==="code-quality-reviewer")return b("Rule matched: code-quality-reviewer -> security-auditor"),{target:"security-auditor",reason:"code-quality-reviewer completed - proceeding with security scan",priority:"high"};if(t==="backend-system-architect"){let n=e.toLowerCase();if(/authentication|authorization|security|access.control|rbac|acl/.test(n))return b("Rule matched: backend-system-architect with auth -> security-layer-auditor"),{target:"security-layer-auditor",reason:"backend-system-architect designed auth/security layer - validation required",priority:"high"}}return null}function Se(t){let e=new Date().toISOString(),n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",i=t.session_id||k(),s=t.agent_output||t.output||"",o=t.error||"";if(b(`Checking auto-spawn conditions for agent: ${n} (session: ${i})`),n==="unknown"||!n)return b("Skipping unknown agent type"),l();let a=ii(n,s,o);if(a){let u=ni(n,a.target,a.reason,a.priority,i,e);return ri(n,a.target,a.reason,a.priority,i,e),b(`=== AUTO-SPAWN QUALITY HOOK ===
Trigger Agent: ${n}
Target Agent: ${a.target}
Reason: ${a.reason}
Priority: ${a.priority}
Spawn ID: ${u}
Timestamp: ${e}
Session: ${i}`),{continue:!0,systemMessage:`Auto-spawn queued: ${a.target} (${a.priority} priority)`}}return b(`No auto-spawn conditions matched for ${n}`),l()}import{existsSync as si,writeFileSync as Ie,mkdirSync as oi,readFileSync as ai}from"node:fs";import{dirname as St}from"node:path";function ci(){return`${d()}/.claude/context/knowledge/decisions/active.json`}function ui(){return`${d()}/.claude/context/session/state.json`}function gi(){return`${d()}/.claude/logs/agent-context`}function V(t){try{oi(t,{recursive:!0})}catch{}}function _e(t,e){if(!si(t))return e;try{return JSON.parse(ai(t,"utf8"))}catch{return e}}function be(t,e){let r=St(t);V(r);try{Ie(t,JSON.stringify(e,null,2))}catch{}}function K(t){let e=process.env.CLAUDE_AGENT_NAME||"unknown",r=new Date().toISOString(),n=t.agent_output||t.output||"",i=n.substring(0,200);n.length>200&&(i+="...");let s=e.replace(/-/g,"_"),o=ci(),a=St(o);V(a);let g=_e(o,{schema_version:"2.0.0",decisions:{}});(!g.decisions||typeof g.decisions!="object")&&(g.decisions={});let p={timestamp:r,agent:e,summary:i,status:"completed"};g.decisions[s]=p,be(o,g);let f=ui(),m=St(f);V(m);let y=_e(f,{schema_version:"2.0.0",session_id:"",started_at:r,last_activity:r,active_agent:null,tasks_pending:[],tasks_completed:[]});Array.isArray(y.tasks_completed)||(y.tasks_completed=[]),Array.isArray(y.tasks_pending)||(y.tasks_pending=[]);let h={agent:e,timestamp:r,summary:i};y.tasks_completed.push(h),y.last_activity=r,y.active_agent=null,be(f,y);let D=gi();V(D);let R=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),N=`${D}/${e}_${R}.log`,O=`=== CONTEXT PUBLICATION (Protocol 2.0) ===
Agent: ${e}
Timestamp: ${r}
Decisions file: ${o}
Session state: ${f}

=== AGENT OUTPUT ===
${n}
`;try{Ie(N,O)}catch{}return l()}import{existsSync as di,writeFileSync as xe,mkdirSync as _t,readFileSync as li,appendFileSync as pi}from"node:fs";import{dirname as mi}from"node:path";var ve=[{type:"product-thinking",name:"Product Thinking Pipeline",description:"Full product discovery and specification workflow",triggers:["should we build","product decision","feature validation","market research","user research"],steps:[{agent:"market-intelligence",description:"Analyze competitive landscape and market trends",dependsOn:[],skills:["market-research"],estimatedTokens:3e3},{agent:"ux-researcher",description:"Create personas and map user journeys",dependsOn:[0],skills:["user-research"],estimatedTokens:2500},{agent:"product-strategist",description:"Validate value proposition and alignment",dependsOn:[0,1],skills:["product-strategy"],estimatedTokens:2e3},{agent:"prioritization-analyst",description:"Score and prioritize using frameworks",dependsOn:[2],skills:["prioritization"],estimatedTokens:1500},{agent:"business-case-builder",description:"Build ROI and cost-benefit analysis",dependsOn:[2,3],skills:["business-case"],estimatedTokens:2e3},{agent:"requirements-translator",description:"Transform to PRD and user stories",dependsOn:[4],skills:["requirements"],estimatedTokens:2500}],estimatedTotalTokens:13500},{type:"full-stack-feature",name:"Full-Stack Feature Pipeline",description:"End-to-end feature implementation workflow",triggers:["full-stack feature","build a feature","implement end-to-end","create full feature","add complete feature"],steps:[{agent:"backend-system-architect",description:"Design API and database schema",dependsOn:[],skills:["api-design-framework","database-schema-designer"],estimatedTokens:3e3},{agent:"frontend-ui-developer",description:"Build React components and UI",dependsOn:[0],skills:["react-server-components-framework","form-state-patterns"],estimatedTokens:3500},{agent:"test-generator",description:"Create unit and integration tests",dependsOn:[0,1],skills:["integration-testing","msw-mocking"],estimatedTokens:2e3},{agent:"security-auditor",description:"Audit for vulnerabilities",dependsOn:[0,1],skills:["owasp-top-10","auth-patterns"],estimatedTokens:1500}],estimatedTotalTokens:1e4},{type:"ai-integration",name:"AI Integration Pipeline",description:"Add AI/LLM capabilities to application",triggers:["add rag","add llm","ai integration","implement rag","add ai feature","langgraph workflow"],steps:[{agent:"workflow-architect",description:"Design LangGraph workflow and state",dependsOn:[],skills:["langgraph-state","langgraph-routing"],estimatedTokens:2500},{agent:"llm-integrator",description:"Connect LLM APIs with function calling",dependsOn:[0],skills:["function-calling","llm-streaming"],estimatedTokens:2e3},{agent:"data-pipeline-engineer",description:"Build embeddings and data pipeline",dependsOn:[0],skills:["embeddings","rag-retrieval"],estimatedTokens:2500},{agent:"test-generator",description:"Create LLM testing infrastructure",dependsOn:[1,2],skills:["llm-testing","property-based-testing"],estimatedTokens:1500}],estimatedTotalTokens:8500},{type:"security-audit",name:"Security Audit Pipeline",description:"Comprehensive security review workflow",triggers:["security audit","security review","vulnerability scan","security assessment"],steps:[{agent:"security-auditor",description:"Scan for OWASP Top 10 vulnerabilities",dependsOn:[],skills:["owasp-top-10","input-validation"],estimatedTokens:2e3},{agent:"security-layer-auditor",description:"Verify defense-in-depth layers",dependsOn:[0],skills:["defense-in-depth"],estimatedTokens:2e3},{agent:"ai-safety-auditor",description:"Audit AI/LLM security if applicable",dependsOn:[0],skills:["mcp-security-hardening"],estimatedTokens:1500}],estimatedTotalTokens:5500},{type:"frontend-compliance",name:"Frontend 2026 Compliance Pipeline",description:"Modernize frontend to 2026 patterns",triggers:["frontend compliance","modernize frontend","update react","frontend 2026"],steps:[{agent:"frontend-ui-developer",description:"Upgrade to React 19 patterns",dependsOn:[],skills:["react-server-components-framework","zustand-patterns"],estimatedTokens:3e3},{agent:"performance-engineer",description:"Optimize Core Web Vitals",dependsOn:[0],skills:["core-web-vitals","lazy-loading-patterns"],estimatedTokens:2e3},{agent:"accessibility-specialist",description:"Ensure WCAG 2.2 compliance",dependsOn:[0],skills:["a11y-testing","focus-management"],estimatedTokens:1500}],estimatedTotalTokens:6500}];function fi(){return`${d()}/.claude/coordination/decision-log.json`}function yi(){let t=`${d()}/.claude/hooks/logs`;try{_t(t,{recursive:!0})}catch{}return`${t}/agent-feedback.log`}function $(t){let e=yi(),r=new Date().toISOString();try{pi(e,`[${r}] [feedback-loop] ${t}
`)}catch{}}function ki(t){let e=me();if(e){let n=ve.find(i=>i.type===e.type);if(n){let i=n.steps.findIndex(s=>s.agent===t);if(i>=0){let s=n.steps.filter((o,a)=>o.dependsOn.includes(i)&&a>i).map(o=>o.agent);if(s.length>0)return s.join(" ")}}}return{"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"test-generator","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer"}[t]||""}function hi(t){return{"market-intelligence":"product-thinking","product-strategist":"product-thinking","prioritization-analyst":"product-thinking","business-case-builder":"product-thinking","requirements-translator":"specification","metrics-architect":"specification","backend-system-architect":"architecture","database-engineer":"architecture","data-pipeline-engineer":"architecture","frontend-ui-developer":"frontend","rapid-ui-designer":"frontend","ux-researcher":"frontend","test-generator":"quality","code-quality-reviewer":"quality","security-auditor":"security","security-layer-auditor":"security","workflow-architect":"ai-integration","llm-integrator":"ai-integration","debug-investigator":"debugging"}[t]||"general"}function Si(){return process.env.CLAUDE_INSTANCE_ID||`${Z("os").hostname()}-${process.pid}`}function _i(t){let e=t.substring(0,500);return t.length>500&&(e+="..."),e}function bi(t,e,r,n,i,s,o,a){let u=fi(),g=mi(u);try{_t(g,{recursive:!0})}catch{}let p;if(di(u))try{p=JSON.parse(li(u,"utf8"))}catch{p={schema_version:"2.0.0",log_created_at:o,decisions:[]}}else p={schema_version:"2.0.0",log_created_at:o,decisions:[]};let f={decision_id:t,timestamp:o,made_by:{instance_id:Si(),agent_type:e},category:r,title:`Agent ${e} completed`,description:n,impact:{scope:"agent-pipeline",downstream_agents:i.split(" ").filter(Boolean)},status:s,task_id:a};p.decisions.push(f);try{xe(u,JSON.stringify(p,null,2)),$(`Decision ${t} logged for agent ${e}`)}catch{$("ERROR: Failed to write decision to log")}}function Ii(t,e,r,n,i,s,o){if(!e)return;let a=`${d()}/.claude/context/handoffs`;try{_t(a,{recursive:!0})}catch{}let u=e.split(" ").filter(Boolean),g=new Date().toISOString().replace(/[-:]/g,"").substring(0,15);for(let p of u){let f=`${a}/${t}_to_${p}_${g}.json`,m={from_agent:t,to_agent:p,timestamp:s,decision_id:n,summary:r,session_id:i,status:"pending",feedback_loop:!0,task_id:o};try{xe(f,JSON.stringify(m,null,2)),$(`Created handoff context: ${t} -> ${p}`)}catch{}}}function Q(t){let e=new Date().toISOString(),n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",i=t.session_id||k(),s=t.agent_output||t.output||"",o=t.error||"";if($(`Processing feedback for agent: ${n} (session: ${i})`),n==="unknown"||!n)return $("Skipping unknown agent type"),l();let a=new Date().toISOString().replace(/[-:T.]/g,"").substring(0,8),u=Math.floor(Math.random()*1e4).toString().padStart(4,"0"),g=`DEC-${a}-${u}`,f=A(n)?.taskId,m=ki(n),_=hi(n),y,h;return o&&o!=="null"?(y=`Agent failed: ${o}`,h="failed"):(y=_i(s),h="completed"),f&&(x(f,h==="completed"?"completed":"failed"),$(`Updated task ${f} status to ${h}`)),bi(g,n,_,y,m,h,e,f),m?(Ii(n,m,y,g,i,e,f),$(`Routed findings to downstream agents: ${m}`)):$(`No downstream agents for ${n} (terminal agent)`),$(`=== AGENT FEEDBACK LOOP ===
Agent: ${n}
Category: ${_}
Decision ID: ${g}
Task ID: ${f||"none"}
Timestamp: ${e}
Status: ${h}
Downstream: ${m||"none"}

Summary: ${y}`),m?{continue:!0,systemMessage:`Feedback loop: routed to ${m}${f?` (task: ${f})`:""}`}:l()}import{writeFileSync as $e,mkdirSync as we}from"node:fs";var vi=new Set(["market-intelligence","product-strategist","prioritization-analyst","business-case-builder","requirements-translator","metrics-architect","backend-system-architect","code-quality-reviewer","data-pipeline-engineer","database-engineer","debug-investigator","frontend-ui-developer","llm-integrator","rapid-ui-designer","security-auditor","security-layer-auditor","system-design-reviewer","test-generator","ux-researcher","workflow-architect"]),xi={"market-intelligence":"product-strategist","product-strategist":"prioritization-analyst","prioritization-analyst":"business-case-builder","business-case-builder":"requirements-translator","requirements-translator":"metrics-architect","metrics-architect":"backend-system-architect","backend-system-architect":"frontend-ui-developer","frontend-ui-developer":"test-generator","test-generator":"code-quality-reviewer","code-quality-reviewer":"security-auditor","workflow-architect":"llm-integrator","llm-integrator":"data-pipeline-engineer","data-pipeline-engineer":"code-quality-reviewer","database-engineer":"backend-system-architect","rapid-ui-designer":"frontend-ui-developer","ux-researcher":"rapid-ui-designer","security-auditor":"none","security-layer-auditor":"none","debug-investigator":"none","system-design-reviewer":"none"},$i={"market-intelligence":"Next: product-strategist should define product vision based on market analysis","product-strategist":"Next: prioritization-analyst should rank features from strategy","prioritization-analyst":"Next: business-case-builder should create ROI justification","business-case-builder":"Next: requirements-translator should convert to technical specs","requirements-translator":"Next: metrics-architect should define success criteria","metrics-architect":"Next: backend-system-architect should design API endpoints","backend-system-architect":"Next: frontend-ui-developer should build UI components","frontend-ui-developer":"Next: test-generator should create test coverage","test-generator":"Next: code-quality-reviewer should validate implementation","code-quality-reviewer":"Next: security-auditor should perform security scan","workflow-architect":"Next: llm-integrator should configure LLM providers","llm-integrator":"Next: data-pipeline-engineer should set up embeddings","data-pipeline-engineer":"Next: code-quality-reviewer should validate data pipeline","database-engineer":"Next: backend-system-architect should integrate schema","rapid-ui-designer":"Next: frontend-ui-developer should implement designs","ux-researcher":"Next: rapid-ui-designer should create mockups"};function wi(t){return xi[t]||"none"}function Ai(t){return $i[t]||"Pipeline complete"}function Ti(t,e,r,n,i){let s=`${d()}/.claude/context/handoffs`;try{we(s,{recursive:!0})}catch{}let o=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),a=`${s}/${t}_to_${e}_${o}.json`,u={from_agent:t,to_agent:e,timestamp:r,summary:n,suggestions:i,status:"ready_for_handoff"};try{$e(a,JSON.stringify(u,null,2))}catch{}return a}function Di(t,e,r,n,i,s){let o=`${d()}/.claude/logs/agent-handoffs`;try{we(o,{recursive:!0})}catch{}let a=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),u=`${o}/${t}_${a}.log`,g=`=== HANDOFF PREPARATION ===
From: ${t}
To: ${e}
Timestamp: ${r}
Handoff file: ${s}

Summary: ${n}

Next Steps: ${i}
`;try{$e(u,g)}catch{}}function X(t){let e=new Date().toISOString(),n=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown";if(!vi.has(n))return l();let i=wi(n),s=t.agent_output||t.output||"",o=s.length,a;o>0?(a=s.substring(0,300),o>300&&(a+="...")):a=`Agent ${n} completed`;let u=Ai(n),g=Ti(n,i,e,a,u);return Di(n,i,e,a,u,g),l()}import{writeFileSync as Ri,mkdirSync as Ae,appendFileSync as Ci}from"node:fs";var Oi=["\\.env","auth","secret","credential","password","token","api[_-]?key","jwt","session","oauth","permission","\\.pem$","\\.key$","config.*prod"];function Ei(){let t=`${d()}/.claude/logs/multi-claude`;try{Ae(t,{recursive:!0})}catch{}return t}function T(t,e,r){let n=Ei(),i=new Date().toISOString().substring(0,10).replace(/-/g,""),s=`${n}/verifier_${i}.log`,o=new Date().toISOString();try{Ci(s,`[${o}] [${t}] ${e}: ${r}
`)}catch{}}function Pi(t){for(let e of Oi)if(new RegExp(e,"i").test(t))return!0;return!1}function Te(t){let e=new Date().toISOString(),r=d(),i=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"unknown",s=t.agent_output||t.output||"",o=[];if(i==="test-generator"&&(o.push({agent:"code-quality-reviewer",reason:"Test generation complete - quality review recommended"}),T(i,"TRIGGER","test-generator completion triggers code-quality-reviewer")),i==="frontend-ui-developer"&&/form|input|validation|submit|auth|login/i.test(s)&&(o.push({agent:"security-auditor",reason:"Frontend auth/form components - security review recommended"}),T(i,"TRIGGER","frontend auth components trigger security-auditor")),i==="backend-system-architect"&&/endpoint|route|api|auth|jwt|session/i.test(s)&&(o.push({agent:"security-auditor",reason:"Backend API endpoints - security review recommended"}),T(i,"TRIGGER","backend API endpoints trigger security-auditor")),Pi(s)&&(o.some(u=>u.agent==="security-auditor")||(o.push({agent:"security-auditor",reason:"Sensitive files modified - security review required"}),T(i,"TRIGGER","sensitive file patterns detected"))),i==="database-engineer"&&(o.push({agent:"code-quality-reviewer",reason:"Database schema changes - review for consistency"}),T(i,"TRIGGER","database changes trigger code-quality-reviewer")),i==="workflow-architect"&&(o.push({agent:"security-layer-auditor",reason:"LangGraph workflow created - layer audit recommended"}),T(i,"TRIGGER","workflow-architect triggers security-layer-auditor")),o.length>0){let a=`${r}/.claude/context/verification-queue`;try{Ae(a,{recursive:!0})}catch{}let u=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),g=`${a}/pending_${u}_${i}.json`,p={triggered_by:i,timestamp:e,verifications:o.map(m=>({agent:m.agent,reason:m.reason,status:"pending"}))};try{Ri(g,JSON.stringify(p,null,2))}catch{}let f="Multi-Claude Verification Triggered: "+o.map(m=>`${m.agent} (${m.reason})`).join("; ");return T(i,"QUEUE",`Created verification queue: ${g}`),{continue:!0,systemMessage:f}}return T(i,"SKIP","No verification triggers matched"),l()}import{writeFileSync as Ni,mkdirSync as ji}from"node:fs";function Hi(){let t=`${d()}/.claude/logs/agent-validation`;try{ji(t,{recursive:!0})}catch{}return t}function De(t){let e=process.env.CLAUDE_AGENT_NAME||"unknown",r=new Date().toISOString(),n=t.agent_output||t.output||"",i=[],s=[];n||i.push("Agent produced empty output");let o=n.length;if(o<50&&s.push(`Output seems very short (${o} chars)`),/error|failed|exception/i.test(n)&&s.push("Output contains error-related keywords"),e==="backend-system-architect"&&n.includes("{")){let _=n.match(/\{[^}]*\}/);if(_)try{JSON.parse(_[0])}catch{s.push("JSON structure may be malformed")}}let a=i.length>0?"failed":"passed",u=`Output Validation [${a}] - Agent: ${e}, Timestamp: ${r}, Output length: ${o} chars`;i.length>0&&(u+=" | Errors: "+i.join("; ")),s.length>0&&(u+=" | Warnings: "+s.join("; "));let g=Hi(),p=new Date().toISOString().replace(/[-:]/g,"").substring(0,15),f=`${g}/${e}_${p}.log`,m=`=== OUTPUT VALIDATION ===
${u}

=== AGENT OUTPUT ===
${n}
`;try{Ni(f,m)}catch{}return a==="failed"?{continue:!1,systemMessage:u,hookSpecificOutput:{hookEventName:"SubagentStop"}}:{continue:!0,suppressOutput:!0,systemMessage:u}}import{existsSync as Fi,writeFileSync as Mi,readFileSync as Li}from"node:fs";var bt="/tmp/claude-session-metrics.json";function Ui(){if(Fi(bt))try{let t=JSON.parse(Li(bt,"utf8"));t.errors=(t.errors||0)+1,Mi(bt,JSON.stringify(t,null,2))}catch{}}function Re(t){let e=t.agent_id||"",r=t.subagent_type||"",n=t.error||"";return c("subagent-quality-gate",`Quality gate check: ${r} (${e})`),n&&n!=="null"?(c("subagent-quality-gate",`ERROR: Subagent failed - ${n}`),Ui(),j(`Subagent ${r} failed: ${n}`)):l()}function Bi(t){let e=t.error||t.tool_error,r=t.exit_code;if(e&&e!=="null"&&e!==""||r!==void 0&&r!==0)return!1;let n=t.agent_output||t.output||"",i=[/\bfailed\b/i,/\berror:\s/i,/\bexception\b/i,/\bcould not\b/i,/\bunable to\b/i],s=n.slice(0,500);for(let o of i)o.test(s)&&c("task-completer",`Warning: possible error in output: ${o}`);return!0}function Ce(t){let r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!r)return c("task-completer","No agent type found, skipping"),l();c("task-completer",`Processing SubagentStop for: ${r}`);let n=A(r);if(!n)return c("task-completer",`No orchestration task found for agent: ${r}`),st(r),l();let i=Bi(t),s=i?"completed":"failed";c("task-completer",`Agent ${r} completed with status: ${s}`),x(n.taskId,s),C(r,s);let o=`## Orchestration: Task ${i?"Completed":"Failed"}

Agent \`${r}\` has finished with status: **${s}**

${z({taskId:n.taskId,status:i?"completed":"pending"})}
`;if(i&&n.pipelineId&&n.pipelineStep!==void 0){let a=fe(n.pipelineId,n.pipelineStep);if(a!==null){let u=kt(n.pipelineId).filter(g=>g.pipelineStep===a&&g.status==="pending");u.length>0&&(o+=`
### Pipeline Progress

Pipeline \`${n.pipelineId}\` step ${n.pipelineStep} complete.
Next step (${a}) is now unblocked.

**Next agent(s) to spawn:**
${u.map(g=>`- \`${g.agent}\` (task: ${g.taskId})`).join(`
`)}

Consider spawning the next agent to continue the pipeline.`)}else o+=`
### Pipeline Complete

Pipeline \`${n.pipelineId}\` has completed all steps.`}if(!i){let a=t.error||t.tool_error||"Unknown error";o+=`
### Error Details

The agent encountered an issue:
\`\`\`
${a.slice(0,500)}
\`\`\`

Consider:
1. Retrying with more specific instructions
2. Using an alternative agent
3. Breaking down the task further`;let u=pe(n.taskId);if(u.length>0){o+=`

### Orphaned Tasks (CC 2.1.20)

The following tasks were blocked by the failed task and should be deleted:
`;for(let g of u)o+=`
${le(g.taskId,`Blocked by failed task ${n.taskId} (agent: ${r})`)}`,x(g.taskId,"failed")}}return s==="completed"&&st(r),c("task-completer",`Completed task ${n.taskId} with status ${s}`),w(o)}var It=new Map;function qi(t,e){let r=It.get(t)||[];r.push(e),r.length>10&&r.shift(),It.set(t,r)}function Gi(){let t=[];for(let[e,r]of It)r.some(n=>n.outcome==="failure")&&t.push(e);return t}function Ji(t){let e=t.error||t.tool_error,r=t.exit_code,n=t.agent_output||t.output||"";if(e&&e!=="null"&&e!=="")return{outcome:"failure",error:e};if(r!==void 0&&r!==0)return{outcome:"failure",error:`Exit code: ${r}`};let i=[/i cannot|i can't|i am unable/i,/outside my scope/i,/not appropriate/i,/i refuse/i];for(let o of i)if(o.test(n.slice(0,500)))return{outcome:"rejected",error:"Agent rejected the task"};let s=[/partial(?:ly)?/i,/incomplete/i,/some.*failed/i,/couldn't finish/i];for(let o of s)if(o.test(n.slice(0,500)))return{outcome:"partial"};return{outcome:"success"}}function Oe(t){let r=(t.tool_input||{}).subagent_type||t.subagent_type||t.agent_type||"";if(!r)return l();let{outcome:n,error:i}=Ji(t);if(n==="success")return l();c("retry-handler",`Agent ${r} completed with outcome: ${n}`);let s=ot(),a=v().activeAgents.find(y=>y.agent===r),u=a?.retryCount||0,g=Bt(r,u+1,a?.taskId),p=qt(g,n,i||void 0);qi(r,p);let f=Gi(),m=Ut(r,u+1,i||"Unknown failure",f,s.maxRetries);if(c("retry-handler",`Retry decision for ${r}: shouldRetry=${m.shouldRetry}, alternative=${m.alternativeAgent||"none"}`),m.shouldRetry)C(r,"retrying");else{C(r,"failed");let y=A(r);y&&x(y.taskId,"failed")}let _=Gt(m,r);return w(_)}import{existsSync as Fe,appendFileSync as ns,mkdirSync as rs,readFileSync as is,writeFileSync as ss}from"node:fs";import{existsSync as zi,readFileSync as Wi,writeFileSync as Xa,mkdirSync as Ya}from"node:fs";import{execSync as Ee}from"node:child_process";import{createHash as Vi}from"node:crypto";import*as Pe from"node:os";var Ki=".claude/.user_identity.json",Qi="orchestkit-user-identity-v1";var S=null;function Y(t){return Vi("sha256").update(t+Qi).digest("hex").slice(0,32)}function Xi(){try{return Pe.hostname()}catch{return"unknown-machine"}}function Yi(t){let e=`${t}/${Ki}`;if(!zi(e))return null;try{let r=Wi(e,"utf8");return JSON.parse(r)}catch(r){return c("user-identity",`Failed to read user config: ${r}`,"warn"),null}}function Zi(t){let e={};try{e.email=Ee("git config user.email",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{e.name=Ee("git config user.name",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return e}function ts(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function es(t){if(S)return S;let e=t||d(),r=Xi(),n=Yi(e);if(n?.user_id)return S={user_id:n.user_id,display_name:n.display_name||n.user_id,team_id:n.team_id,machine_id:r,source:"config",anonymous_id:Y(n.user_id),email:n.user_id.includes("@")?n.user_id:void 0},c("user-identity",`Resolved from config: ${S.anonymous_id}`,"debug"),S;let i=Zi(e);if(i.email)return S={user_id:i.email,display_name:i.name||i.email.split("@")[0],team_id:n?.team_id,machine_id:r,source:"git",anonymous_id:Y(i.email),email:i.email},c("user-identity",`Resolved from git: ${S.anonymous_id}`,"debug"),S;let s=ts();if(s.username){let a=`${s.username}@${r}`;return S={user_id:a,display_name:s.username,team_id:n?.team_id,machine_id:r,source:"env",anonymous_id:Y(a)},c("user-identity",`Resolved from env: ${S.anonymous_id}`,"debug"),S}let o=Y(r+process.pid);return S={user_id:`anon-${o.slice(0,8)}`,display_name:"Anonymous",team_id:n?.team_id,machine_id:r,source:"anonymous",anonymous_id:o},c("user-identity",`Resolved as anonymous: ${S.anonymous_id}`,"debug"),S}function Ne(){let t=es();return{session_id:k(),user_id:t.user_id,anonymous_id:t.anonymous_id,team_id:t.team_id,machine_id:t.machine_id,identity_source:t.source,timestamp:new Date().toISOString()}}var os=/^[a-zA-Z0-9_-]{1,128}$/;function as(t){return os.test(t)}function $t(t,e){let r=t||k(),n=e||d();if(!as(r))throw new Error("Invalid session ID format");return`${n}/.claude/memory/sessions/${r}`}function cs(t,e){return`${$t(t,e)}/events.jsonl`}function Me(t,e){let r=$t(t,e);Fe(r)||rs(r,{recursive:!0})}var U=0,je=!1,vt=!1,He=0,us=5e3;function Le(t,e){return`${$t(t,e)}/counter.json`}function gs(t,e){if(!je){je=!0;try{let r=Le(t,e);if(Fe(r)){let n=JSON.parse(is(r,"utf8"));typeof n.counter=="number"&&n.counter>0&&(U=n.counter,c("session-tracker",`Loaded event counter: ${U}`,"debug"))}}catch{}}}function ds(t,e){if(!vt)return;let r=Date.now();if(!(r-He<us))try{Me(t,e);let n=Le(t,e);ss(n,JSON.stringify({counter:U,updated_at:new Date().toISOString()})),vt=!1,He=r}catch{}}function ls(){return gs(),U++,vt=!0,ds(),`evt-${Date.now()}-${U}`}function Ue(t,e,r={}){try{let n={event_id:ls(),event_type:t,identity:Ne(),payload:{name:e,input:xt(r.input),output:xt(r.output),duration_ms:r.duration_ms,success:r.success??!0,context:r.context?Be(r.context,500):void 0,confidence:r.confidence}};Me();let i=cs();ns(i,JSON.stringify(n)+`
`),c("session-tracker",`Tracked ${t}: ${e}`,"debug")}catch(n){c("session-tracker",`Failed to track event: ${n}`,"warn")}}function Be(t,e){return t.length<=e?t:t.slice(0,e-3)+"..."}function xt(t){if(!t)return;let e={},r=["password","secret","token","key","credential","auth"];for(let[n,i]of Object.entries(t)){if(r.some(s=>n.toLowerCase().includes(s))){e[n]="[REDACTED]";continue}if(typeof i=="string"&&i.length>500){e[n]=Be(i,500);continue}if(typeof i=="object"&&i!==null&&!Array.isArray(i)){e[n]=xt(i);continue}e[n]=i}return e}var qe=[{name:"context-publisher",fn:K},{name:"handoff-preparer",fn:X},{name:"feedback-loop",fn:Q},{name:"agent-memory-store",fn:W}];function ps(t){try{let e=t.subagent_type||t.agent_type||"unknown",r=!t.error,n=t.duration_ms,i=t.agent_output||t.output||"",s=typeof i=="string"?i.length:0;Ue("agent_spawned",e,{success:r,duration_ms:n,output:{has_output:s>0,output_length:s,has_error:!!t.error},context:t.agent_id})}catch{}}async function Ge(t){ps(t);let r=(await Promise.allSettled(qe.map(async n=>{try{let i=n.fn(t);return i instanceof Promise&&await i,{hook:n.name,status:"success"}}catch(i){let s=i instanceof Error?i.message:String(i);return c("subagent-stop-dispatcher",`${n.name} failed: ${s}`),{hook:n.name,status:"error",message:s}}}))).filter(n=>n.status==="rejected"||n.status==="fulfilled"&&n.value.status==="error");return r.length>0&&c("subagent-stop-dispatcher",`${r.length}/${qe.length} hooks had errors`),l()}var Je={"subagent-start/graph-memory-inject":Yt,"subagent-start/mem0-memory-inject":ne,"subagent-start/context-gate":se,"subagent-start/subagent-context-stager":ce,"subagent-start/subagent-validator":ue,"subagent-start/task-linker":ye,"subagent-stop/agent-memory-store":W,"subagent-stop/auto-spawn-quality":Se,"subagent-stop/context-publisher":K,"subagent-stop/feedback-loop":Q,"subagent-stop/handoff-preparer":X,"subagent-stop/multi-claude-verifier":Te,"subagent-stop/output-validator":De,"subagent-stop/subagent-quality-gate":Re,"subagent-stop/task-completer":Ce,"subagent-stop/retry-handler":Oe,"subagent-stop/unified-dispatcher":Ge};function Cc(t){return Je[t]}function Oc(){return Object.keys(Je)}export{Qs as DEFAULT_CONFIG,Ks as THRESHOLDS,oo as addToPromptHistory,yo as analyzeAttemptHistory,vo as applyDecay,co as cacheClassification,En as calculateBackoffDelay,po as cleanupOldStates,lo as clearSessionState,qt as completeAttempt,Bt as createAttempt,Ws as escapeRegex,xn as estimateTokenCount,Gt as formatRetryDecision,eo as getActiveAgent,xo as getAdjustments,$o as getAgentSuccessRate,at as getAlternativeAgent,Ns as getCachedBranch,wo as getCalibrationStats,Ps as getEnvFile,Js as getField,Cc as getHook,so as getInjectedSkills,uo as getLastClassification,Et as getLogDir,Sn as getLogLevel,hn as getPluginRoot,d as getProjectDir,ao as getPromptHistory,k as getSessionId,Ao as hasMinimalCalibrationData,qn as hashPrompt,Je as hooks,no as isAgentDispatched,fs as isBashInput,ks as isEditInput,hs as isReadInput,Pn as isRetryableError,io as isSkillInjected,ys as isWriteInput,Oc as listHooks,F as loadCalibrationData,ot as loadConfig,v as loadState,c as logHook,Bs as logPermissionFeedback,Ut as makeRetryDecision,zs as normalizeCommand,js as normalizeLineEndings,Ms as outputAllowWithContext,Fs as outputBlock,nt as outputDeny,Ls as outputError,bn as outputPromptContext,qs as outputPromptContextBudgeted,Hs as outputSilentAllow,l as outputSilentSuccess,j as outputWarning,w as outputWithContext,Us as outputWithUpdatedInput,ko as prepareForRetry,Gs as readHookInput,Io as recordOutcome,st as removeAgent,Bn as saveCalibrationData,go as saveConfig,wn as saveState,_n as shouldLog,Nn as suggestsAlternative,to as trackDispatchedAgent,ro as trackInjectedSkill,C as updateAgentStatus,E as updateState};
//# sourceMappingURL=subagent.mjs.map
