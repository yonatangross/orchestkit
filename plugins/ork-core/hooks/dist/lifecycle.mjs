// OrchestKit Hooks - lifecycle bundle
// Generated: 2026-02-01T10:12:17.679Z

function nr(t){return typeof t.command=="string"}function or(t){return typeof t.file_path=="string"&&typeof t.content=="string"}function rr(t){return typeof t.file_path=="string"&&typeof t.old_string=="string"&&typeof t.new_string=="string"}function ir(t){return typeof t.file_path=="string"&&t.content===void 0}import{appendFileSync as ut,existsSync as lt,statSync as Ie,renameSync as xe,mkdirSync as $e,readSync as we}from"node:fs";import{execSync as He}from"node:child_process";import ie from"node:os";import I from"node:path";function S(){return process.env.HOME||process.env.USERPROFILE||ie.homedir()}function U(){return process.env.CLAUDE_PROJECT_DIR||"."}function rt(){return process.env.CLAUDE_PLUGIN_ROOT||process.env.CLAUDE_PROJECT_DIR||"."}function it(){return process.env.CLAUDE_PLUGIN_ROOT?I.join(S(),".claude","logs","ork"):I.join(U(),".claude","logs")}var ur=I.join,lr=I.sep;import{execSync as se}from"node:child_process";import{createHash as ce}from"node:crypto";import{existsSync as st,readFileSync as ae,writeFileSync as ue,mkdirSync as le}from"node:fs";import{join as M,basename as pe}from"node:path";var de=20,me=15,ge=/[^a-z0-9-]/g;function fe(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=pe(e);return ct(n,de)}function ye(t){if(process.env.ORCHESTKIT_SESSION_BRANCH)return process.env.ORCHESTKIT_SESSION_BRANCH;let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd();try{let n=se("git branch --show-current",{cwd:e,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim(),o=ct(n||"detached",me);return process.env.ORCHESTKIT_SESSION_BRANCH=o,o}catch{return"nobranch"}}function he(t){let e=t||new Date,n=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${n}${o}`}function Se(t){let e=t||new Date,n=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0");return`${n}${o}`}function ke(){let t=`${process.pid}-${Date.now()}-${Math.random()}`;return ce("sha256").update(t).digest("hex").slice(0,4)}function ct(t,e){return t.toLowerCase().replace(ge,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").slice(0,e)}function _e(t,e){let n=fe(t),o=ye(t),r=he(e),s=Se(e),c=ke();return`${n}-${o}-${r}-${s}-${c}`}function ve(t){let e=t||process.env.CLAUDE_PROJECT_DIR||process.cwd(),n=M(e,".instance","session-id.json");if(st(n))try{let o=JSON.parse(ae(n,"utf8"));if(o.session_id&&o.created_at){let r=Date.now()-new Date(o.created_at).getTime(),s=1440*60*1e3;if(r<s)return o.session_id}}catch{}}function be(t,e){let n=e||process.env.CLAUDE_PROJECT_DIR||process.cwd(),o=M(n,".instance"),r=M(o,"session-id.json");try{st(o)||le(o,{recursive:!0}),ue(r,JSON.stringify({session_id:t,created_at:new Date().toISOString()},null,2))}catch{}}function at(t){if(process.env.CLAUDE_SESSION_ID)return process.env.CLAUDE_SESSION_ID;let e=ve(t);if(e)return e;let n=_e(t);return be(n,t),n}function x(){return it()}function u(){return U()}function Ce(){return rt()}function pt(){return process.env.CLAUDE_ENV_FILE?process.env.CLAUDE_ENV_FILE:`${Ce()}/.claude/.instance_env`}function g(){return at()}function dt(t){if(process.env.ORCHESTKIT_BRANCH)return process.env.ORCHESTKIT_BRANCH;try{let e=He("git branch --show-current",{cwd:t||u(),encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim();return process.env.ORCHESTKIT_BRANCH=e,e}catch{return"unknown"}}function Re(){return process.env.ORCHESTKIT_LOG_LEVEL||"warn"}function vr(t){return t.replace(/\r\n/g,`
`)}function Oe(t){let e=["debug","info","warn","error"];return e.indexOf(t)>=e.indexOf(Re())}function a(){return{continue:!0,suppressOutput:!0}}function br(){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{permissionDecision:"allow"}}}function Ir(t){return{continue:!1,stopReason:t,hookSpecificOutput:{permissionDecision:"deny",permissionDecisionReason:t}}}function K(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PostToolUse",additionalContext:t}}}function Ee(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"UserPromptSubmit",additionalContext:t}}}function xr(t,e){let n={continue:!0,hookSpecificOutput:{hookEventName:"PreToolUse",additionalContext:t,permissionDecision:"allow"}};return e?n.systemMessage=e:n.suppressOutput=!0,n}function $r(t){return{continue:!0,systemMessage:t}}function wr(t){return{continue:!0,systemMessage:`\u26A0 ${t}`}}function Hr(t){return{continue:!1,stopReason:t,hookSpecificOutput:{hookEventName:"PreToolUse",permissionDecision:"deny",permissionDecisionReason:t}}}function Cr(t){return{continue:!0,suppressOutput:!0,hookSpecificOutput:{hookEventName:"PreToolUse",updatedInput:t}}}var De=200*1024,Pe=100*1024;function mt(t,e){if(lt(t))try{if(Ie(t).size>e){let o=`${t}.old.${Date.now()}`;xe(t,o)}}catch{}}function gt(t){lt(t)||$e(t,{recursive:!0})}function i(t,e,n="debug"){if(!Oe(n))return;let o=x(),r=`${o}/hooks.log`;try{gt(o),mt(r,De);let s=new Date().toISOString().replace("T"," ").slice(0,19);ut(r,`[${s}] [${n.toUpperCase()}] [${t}] ${e}
`)}catch{}}function Rr(t,e,n){let o=x(),r=`${o}/permission-feedback.log`;try{gt(o),mt(r,Pe);let s=new Date().toISOString(),c=n?.tool_name||process.env.HOOK_TOOL_NAME||"unknown",l=n?.session_id||g();ut(r,`${s} | ${t} | ${e} | tool=${c} | session=${l}
`)}catch{}}function Te(t){if(!t)return 0;let o=(t.match(/[{};()=><]/g)||[]).length/t.length>.03?2.8:3.5;return Math.ceil(t.length/o)}function Or(t,e,n,o,r){let s=Te(t);return o&&o.isOverBudget(n)?(i(e,`Budget exhausted for ${n}, suppressing ${s}t`),a()):(r&&r.trackTokenUsage(e,n,s),Ee(t))}function Er(){try{let t=[],n=Buffer.allocUnsafe(256),o,r=0;for(;;)try{if(o=we(r,n,0,256,null),o===0)break;t.push(Buffer.from(n.subarray(0,o)))}catch{break}let s=Buffer.concat(t).toString("utf8").trim();return s?JSON.parse(s):{tool_name:"",session_id:g(),tool_input:{}}}catch{return{tool_name:"",session_id:g(),tool_input:{}}}}function Dr(t,e){let n=e.replace(/^\./,"").split("."),o=t;for(let r of n){if(o==null)return;o=o[r]}return o}function Pr(t){return t.replace(/\\\s*[\r\n]+/g," ").replace(/\n/g," ").replace(/\s+/g," ").trim()}function Tr(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}import{execSync as v}from"node:child_process";function je(t){let e=t||u();try{return v("git branch --show-current",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return"unknown"}}function Ne(t){let e=t||je();return["dev","main","master"].includes(e)}function Ar(t){let e=t||u();try{return v("git rev-parse --show-toplevel",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{return e}}function Lr(t){let e=t||u();try{return v("git rev-parse --git-dir",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),!0}catch{return!1}}function Fe(t){let e=t||u();try{return v("git status --short",{cwd:e,encoding:"utf8",timeout:1e4,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function Ur(t){return Fe(t).length>0}function Mr(t){let e=t||u();try{return v("git rev-parse --verify main",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"main"}catch{try{return v("git rev-parse --verify master",{cwd:e,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}),"master"}catch{return"main"}}}function Ae(t){let e=[/issue\/(\d+)/i,/feature\/(\d+)/i,/fix\/(\d+)/i,/bug\/(\d+)/i,/feat\/(\d+)/i,/^(\d+)-/,/-(\d+)$/,/#(\d+)/];for(let n of e){let o=t.match(n);if(o)return parseInt(o[1],10)}return null}function Kr(t){if(Ne(t))return null;let e=["issue/","feature/","fix/","bug/","feat/","chore/","docs/","refactor/","test/","ci/","perf/","style/","release/","hotfix/"];return e.some(o=>t.startsWith(o))?t.startsWith("issue/")&&!Ae(t)?"issue/ branches should include an issue number (e.g., issue/123-description)":null:`Branch name should start with a valid prefix: ${e.join(", ")}`}import{existsSync as ft,readFileSync as yt}from"node:fs";function Le(t){let e=`${t}/.claude/feedback/consent-status.json`;if(!ft(e))return{consented:!1,asked:!1};try{let n=JSON.parse(yt(e,"utf-8"));return{consented:n.consented===!0,asked:n.asked===!0}}catch{return{consented:!1,asked:!1}}}function Ue(t){let e=`${t}/.claude/feedback/consent-log.json`;if(!ft(e))return null;try{let n=JSON.parse(yt(e,"utf-8"));if(n.events&&n.events.length>0)return n.events[n.events.length-1]}catch{}return null}function Me(t){try{let e=new Date(t);return Math.floor((new Date().getTime()-e.getTime())/(1e3*60*60*24))>=30}catch{return!1}}function ht(t){let e=t.project_dir||u(),n=Le(e);if(n.consented)return i("analytics-consent-check","User has consented to analytics"),a();if(n.asked){let o=Ue(e);return o&&(o.action==="declined"||o.action==="revoked")&&Me(o.timestamp)?(i("analytics-consent-check","Showing 30-day reminder"),{continue:!0,systemMessage:"Reminder: Anonymous analytics help improve OrchestKit. Enable with /ork:feedback opt-in"}):(i("analytics-consent-check","User recently declined, not prompting"),a())}return i("analytics-consent-check","First time user, showing brief notice"),{continue:!0,systemMessage:"OrchestKit collects local usage metrics. Share anonymously with /ork:feedback opt-in"}}import{existsSync as $,readFileSync as St,writeFileSync as Ke,unlinkSync as Je}from"node:fs";function Be(t){let e=`${t}/.claude/.instance_env`;if(!$(e))return null;try{let o=St(e,"utf-8").match(/CLAUDE_INSTANCE_ID=([^\n]+)/);if(o)return o[1].trim()}catch{}return null}function We(t,e){let o=`${`${t}/.claude/coordination/heartbeats`}/${e}.json`;if($(o))try{let r=JSON.parse(St(o,"utf-8"));r.status="stopping",Ke(o,JSON.stringify(r,null,2)),i("coordination-cleanup",`Updated heartbeat status to 'stopping' for ${e}`)}catch(r){i("coordination-cleanup",`Failed to update heartbeat: ${r}`)}}function ze(t,e){let n=`${t}/.claude/coordination/.claude.db`;if(!$(n)){i("coordination-cleanup","No coordination database found");return}i("coordination-cleanup",`Would unregister instance: ${e}`)}function Ve(t){let e=`${t}/.claude/.instance_env`;try{$(e)&&(Je(e),i("coordination-cleanup","Removed instance environment file"))}catch(n){i("coordination-cleanup",`Failed to remove instance env: ${n}`)}}function kt(t){i("coordination-cleanup","Starting coordination cleanup");let e=t.project_dir||u(),n=Be(e);return n&&(We(e,n),ze(e,n)),Ve(e),i("coordination-cleanup","Coordination cleanup complete"),a()}import{existsSync as Ge,readFileSync as qe,writeFileSync as Ye,mkdirSync as _t,appendFileSync as Ze}from"node:fs";function Qe(){return process.env.CLAUDE_MULTI_INSTANCE==="1"}function Xe(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function tn(t){let e=`${t}/.claude/context/session/state.json`;if(!Ge(e))return"General development";try{return JSON.parse(qe(e,"utf-8")).current_task?.description||"General development"}catch{return"General development"}}function en(){return process.env.CLAUDE_SUBAGENT_ROLE||"main"}function nn(){let t=g(),e=new Date().toISOString().replace(/[-:T.Z]/g,"").slice(0,14),n=Math.random().toString(36).substring(2,8);return`${t.slice(0,8)}-${e}-${n}`}function on(t,e){let n=pt();try{_t(`${t}/.claude`,{recursive:!0}),Ze(n,`CLAUDE_INSTANCE_ID=${e}
`),i("coordination-init",`Saved instance ID: ${e}`)}catch(o){i("coordination-init",`Failed to save instance ID: ${o}`)}}function rn(t,e,n,o){let r=`${t}/.claude/coordination/heartbeats`;try{_t(r,{recursive:!0});let s={instance_id:e,task:n,role:o,status:"active",started_at:new Date().toISOString(),last_heartbeat:new Date().toISOString()};Ye(`${r}/${e}.json`,JSON.stringify(s,null,2)),i("coordination-init",`Initialized heartbeat for ${e}`)}catch(s){i("coordination-init",`Failed to initialize heartbeat: ${s}`)}}function vt(t){if(!Qe())return i("coordination-init","Multi-instance not enabled, skipping"),a();if(Xe())return i("coordination-init","Skipping coordination init (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();i("coordination-init","Starting coordination initialization");let e=t.project_dir||u(),n=tn(e),o=en(),r=nn();return process.env.CLAUDE_INSTANCE_ID=r,on(e,r),rn(e,r,n,o),i("coordination-init",`Coordination initialized: ${r}`),a()}import{existsSync as J,readFileSync as B,writeFileSync as bt,readdirSync as sn,unlinkSync as cn,mkdirSync as an}from"node:fs";function un(){return process.env.CLAUDE_MULTI_INSTANCE==="1"}function ln(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function pn(){return process.env.CLAUDE_INSTANCE_ID||g()}function dn(t){let e=`${t}/.claude/.instance_env`;if(!J(e))return null;try{let o=B(e,"utf-8").match(/CLAUDE_INSTANCE_ID=([^\n]+)/);if(o)return o[1].trim()}catch{}return null}function mn(t,e){let n=`${t}/.claude/coordination/heartbeats`,o=`${n}/${e}.json`;if(!J(o)){an(n,{recursive:!0});let r={instance_id:e,status:"active",last_heartbeat:new Date().toISOString()};bt(o,JSON.stringify(r,null,2)),i("instance-heartbeat",`Created heartbeat for ${e}`);return}try{let r=JSON.parse(B(o,"utf-8"));r.last_heartbeat=new Date().toISOString(),r.status="active",bt(o,JSON.stringify(r,null,2)),i("instance-heartbeat",`Updated heartbeat for ${e}`)}catch(r){i("instance-heartbeat",`Failed to update heartbeat: ${r}`)}}function gn(t,e){let n=`${t}/.claude/coordination/heartbeats`;if(!J(n))return 0;let o=300*1e3,r=Date.now(),s=0;try{let c=sn(n).filter(l=>l.endsWith(".json"));for(let l of c){let p=`${n}/${l}`;try{let d=JSON.parse(B(p,"utf-8"));if(d.instance_id===e)continue;let f=new Date(d.last_heartbeat).getTime();r-f>o&&(cn(p),s++,i("instance-heartbeat",`Cleaned up stale instance: ${d.instance_id}`))}catch{}}}catch(c){i("instance-heartbeat",`Failed to scan heartbeats: ${c}`)}return s}function w(t){if(!un())return a();if(ln())return i("instance-heartbeat","Skipping instance heartbeat (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();let e=t.project_dir||u(),n=pn();if((!n||n==="unknown")&&(n=dn(e)||n),!n)return i("instance-heartbeat","No instance ID available"),a();mn(e,n);let o=gn(e,n);return o>0&&i("instance-heartbeat",`Cleaned up ${o} stale instance(s)`),a()}import{mkdirSync as fn,appendFileSync as yn}from"node:fs";function hn(){return!!process.env.MEM0_API_KEY}function H(t){i("mem0-analytics-tracker","Mem0 analytics tracker starting");let e=t.project_dir||u(),n=`${e}/.claude/logs/mem0-analytics.jsonl`,o=t.session_id||g(),r=new Date().toISOString(),s=JSON.stringify({session_id:o,timestamp:r,event:"session_start",mem0_available:hn()});try{fn(`${e}/.claude/logs`,{recursive:!0}),yn(n,s+`
`),i("mem0-analytics-tracker","Mem0 analytics tracked")}catch(c){i("mem0-analytics-tracker",`Failed to write analytics: ${c}`)}return a()}import{existsSync as Sn,readFileSync as xt,mkdirSync as kn,renameSync as _n}from"node:fs";function vn(t){let e=t.split("/");return(e[e.length-1]||"unknown").toLowerCase().replace(/\s+/g,"-")}function bn(){return!!process.env.MEM0_API_KEY}function It(t){if(!Sn(t))return!1;try{let e=xt(t,"utf-8"),n=JSON.parse(e);return!(!n||Object.keys(n).length===0)}catch{return!1}}function In(t,e){let n=`${e}/.claude/logs/mem0-processed`,o=new Date().toISOString().replace(/[:.]/g,"-");try{kn(n,{recursive:!0});let s=(t.split("/").pop()||"pending-sync").replace(".json",`.processed-${o}.json`),c=`${n}/${s}`;_n(t,c),i("mem0-context-retrieval",`Archived pending sync to ${c}`)}catch(r){i("mem0-context-retrieval",`Warning: Could not archive ${t}: ${r}`)}}function C(t){i("mem0-context-retrieval","Mem0 context retrieval starting");let e=t.project_dir||u(),n=vn(e),o=`${e}/.mem0-pending-sync.json`,r=`${S()}/.claude/.mem0-pending-sync.json`,s=null;if(It(o))s=o,i("mem0-context-retrieval",`Found pending sync in project: ${o}`);else if(It(r))try{let c=JSON.parse(xt(r,"utf-8"));c.project_id===n?(s=r,i("mem0-context-retrieval","Found pending sync in global location for this project")):i("mem0-context-retrieval",`Global pending sync exists but for different project: ${c.project_id}`)}catch{}return s&&(i("mem0-context-retrieval","Found pending sync, archiving for processing"),In(s,e),i("mem0-context-retrieval","Pending sync archived - will be processed on next memory operation")),bn()?i("mem0-context-retrieval","Graph + mem0 available for this session"):i("mem0-context-retrieval","Graph available (mem0 not configured) for this session"),a()}import{writeFileSync as xn,mkdirSync as $n}from"node:fs";function wn(){return!!process.env.MEM0_API_KEY}function Hn(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function $t(t){if(Hn())return i("mem0-webhook-setup","Skipping mem0 webhook setup (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();if(i("mem0-webhook-setup","Mem0 webhook setup starting"),!wn())return i("mem0-webhook-setup","Mem0 not available, skipping webhook setup"),a();let e=t.project_dir||u(),n=`${e}/.claude/mem0-webhooks.json`,o="orchestkit-auto-sync",r=["memory.created","memory.updated","memory.deleted"],s=process.env.MEM0_WEBHOOK_URL||"https://example.com/webhook/mem0";i("mem0-webhook-setup","Checking for existing webhooks"),process.env.MEM0_WEBHOOK_URL||i("mem0-webhook-setup","Webhook URL not configured (set MEM0_WEBHOOK_URL), skipping creation");try{$n(`${e}/.claude`,{recursive:!0}),xn(n,JSON.stringify({webhook_name:o,events:r,url:s},null,2)),i("mem0-webhook-setup","Webhook config saved")}catch(c){i("mem0-webhook-setup",`Failed to save webhook config: ${c}`)}return i("mem0-webhook-setup","Webhook setup complete"),a()}import{existsSync as y,readFileSync as Cn,writeFileSync as wt,mkdirSync as R}from"node:fs";import{execSync as W}from"node:child_process";function Rn(){return process.env.CLAUDE_MULTI_INSTANCE==="1"}function On(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function En(){try{return W("which sqlite3",{encoding:"utf-8",stdio:"pipe"}),!0}catch{return!1}}function Dn(t){let e=t.split("/").pop()||"unknown",n=new Date().toISOString().replace(/[-:T.Z]/g,"").slice(0,14),o=Math.random().toString(16).substring(2,10);return`${e}-${n}-${o}`}function Pn(t){try{return W("git branch --show-current",{cwd:t,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim()}catch{return"unknown"}}function Tn(t){let e=[];return(y(`${t}/backend`)||y(`${t}/src/backend`))&&e.push("backend"),(y(`${t}/frontend`)||y(`${t}/src/frontend`)||y(`${t}/package.json`))&&e.push("frontend"),(y(`${t}/tests`)||y(`${t}/__tests__`))&&e.push("testing"),(y(`${t}/infrastructure`)||y(`${t}/docker-compose.yml`)||y(`${t}/Dockerfile`))&&e.push("devops"),e}function jn(t,e){let n=Pn(t),o=Tn(t),r=new Date().toISOString(),s={instance_id:e,worktree_name:t.split("/").pop()||"unknown",worktree_path:t,branch:n,capabilities:o,agent_type:null,model:"claude-opus-4-5-20251101",priority:1,created_at:r,status:"active",heartbeat_interval_ms:5e3,last_heartbeat:r},c=`${t}/.instance`;return R(c,{recursive:!0}),wt(`${c}/id.json`,JSON.stringify(s,null,2)),i("multi-instance-init",`Instance identity created: ${e}`),s}function Nn(t){let e=`${t}/.claude/coordination`,n=`${e}/.claude.db`,o=`${e}/schema.sql`;if(y(n))return!0;if(!y(o))return i("multi-instance-init",`WARNING: Schema file not found at ${o}`),!1;try{return R(e,{recursive:!0}),W(`sqlite3 "${n}" < "${o}"`,{encoding:"utf-8",stdio:["pipe","pipe","pipe"]}),i("multi-instance-init","Database initialized from schema"),!0}catch(r){return i("multi-instance-init",`Failed to initialize database: ${r}`),!1}}function Fn(t,e){let n=`${t}/.instance`;wt(`${n}/heartbeat.pid`,String(process.pid)),i("multi-instance-init",`Heartbeat marker created for ${e}`)}function O(t){if(!Rn())return a();if(!En())return i("multi-instance-init","sqlite3 not available, skipping"),a();if(On())return i("multi-instance-init","Skipping multi-instance init (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();i("multi-instance-init","Starting multi-instance coordination initialization...");let e=t.project_dir||u(),n=`${e}/.instance`,o=`${e}/.claude/coordination`;if(R(`${o}/locks`,{recursive:!0}),R(n,{recursive:!0}),!Nn(e))return i("multi-instance-init","ERROR: Failed to initialize database"),a();let r=`${n}/id.json`,s=`${n}/heartbeat.pid`;if(y(r)&&y(s))try{let l=JSON.parse(Cn(r,"utf-8"));return i("multi-instance-init",`Reusing existing instance: ${l.instance_id}`),a()}catch{}let c=Dn(e);return jn(e,c),Fn(e,c),i("multi-instance-init","Multi-instance coordination initialized successfully"),a()}import{existsSync as E,readFileSync as z,writeFileSync as An,statSync as Ln,mkdirSync as Un}from"node:fs";var Mn=1*1024*1024;function Kn(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Jn(t){let e=`${t}/.claude/feedback/sync-config.json`;if(!E(e))return!0;try{return JSON.parse(z(e,"utf-8")).sync_enabled!==!1}catch{return!0}}function Ht(t){if(!E(t))return!0;try{let e=Ln(t);return e.size>Mn?(i("pattern-sync-pull",`WARN: Skipping - file too large: ${t} (${e.size} bytes)`),!1):!0}catch{return!0}}function Bn(t){let n=`${S()}/.claude/global-patterns.json`,o=`${t}/.claude/feedback/learned-patterns.json`;if(!E(n)){i("pattern-sync-pull","No global patterns file found");return}try{let s=JSON.parse(z(n,"utf-8")).patterns||[];if(s.length===0){i("pattern-sync-pull","No global patterns to pull");return}let c={version:"1.0",patterns:[]};if(E(o))try{c=JSON.parse(z(o,"utf-8"))}catch{}let l=c.patterns||[],p=new Set(l.map(m=>m.text)),d=s.filter(m=>!p.has(m.text));if(d.length===0){i("pattern-sync-pull","All global patterns already in project");return}let f=[...l,...d];c.patterns=f,Un(`${t}/.claude/feedback`,{recursive:!0}),An(o,JSON.stringify(c,null,2)),i("pattern-sync-pull",`Pulled ${d.length} new patterns from global`)}catch(r){i("pattern-sync-pull",`Failed to pull global patterns: ${r}`)}}function D(t){if(Kn())return i("pattern-sync-pull","Skipping pattern sync (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();let e=t.project_dir||u();if(!Jn(e))return i("pattern-sync-pull","Global sync disabled, skipping pull"),a();let n=`${S()}/.claude/global-patterns.json`,o=`${e}/.claude/feedback/learned-patterns.json`;return!Ht(n)||!Ht(o)?(i("pattern-sync-pull","Skipping pattern sync due to large files"),a()):(i("pattern-sync-pull","Pulling global patterns..."),Bn(e),i("pattern-sync-pull","Global patterns pulled successfully"),a())}import{existsSync as V,readFileSync as G,writeFileSync as Wn,mkdirSync as zn}from"node:fs";function Vn(t){let e=`${t}/.claude/feedback/sync-config.json`;if(!V(e))return!0;try{return JSON.parse(G(e,"utf-8")).sync_enabled!==!1}catch{return!0}}function Gn(t){let e=`${t}/.claude/feedback/learned-patterns.json`,n=S(),o=`${n}/.claude/global-patterns.json`;if(!V(e)){i("pattern-sync-push","No project patterns file found");return}try{let s=JSON.parse(G(e,"utf-8")).patterns||[];if(s.length===0){i("pattern-sync-push","No project patterns to push");return}let c={version:"1.0",patterns:[],updated:""};if(V(o))try{c=JSON.parse(G(o,"utf-8"))}catch{}let l=c.patterns||[],p=new Set(l.map(m=>m.text)),d=s.filter(m=>!p.has(m.text));if(d.length===0){i("pattern-sync-push","All project patterns already in global");return}let f=[...l,...d];c.patterns=f,c.updated=new Date().toISOString(),zn(`${n}/.claude`,{recursive:!0}),Wn(o,JSON.stringify(c,null,2)),i("pattern-sync-push",`Pushed ${d.length} new patterns to global`)}catch(r){i("pattern-sync-push",`Failed to push project patterns: ${r}`)}}function Ct(t){let e=t.project_dir||u();return Vn(e)?(i("pattern-sync-push","Pushing project patterns to global..."),Gn(e),a()):(i("pattern-sync-push","Global sync disabled, skipping push"),a())}import{execSync as Rt}from"node:child_process";var qn=new Set(["main","master","dev","develop"]);function Ot(t){i("pr-status-enricher","Checking for open PR on current branch");let e=t.project_dir||u(),n;try{n=dt(e)}catch{return i("pr-status-enricher","Could not determine branch, skipping"),a()}if(!n||qn.has(n))return i("pr-status-enricher",`Branch "${n}" skipped for PR detection`),a();try{let o=Rt("gh pr view --json state,reviewDecision,url,title,isDraft",{cwd:e,timeout:1e4,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim(),r=JSON.parse(o);if(!r.url)return i("pr-status-enricher","No PR found for current branch"),a();process.env.ORCHESTKIT_PR_URL=r.url,process.env.ORCHESTKIT_PR_STATE=r.state;let s=0;try{let d=Rt("gh pr view --json reviewThreads",{cwd:e,timeout:1e4,encoding:"utf-8",stdio:["pipe","pipe","pipe"]}).trim();s=(JSON.parse(d).reviewThreads||[]).filter(m=>!m.isResolved).length}catch{}let c=r.isDraft?" (DRAFT)":"",l=r.reviewDecision?` | Review: ${r.reviewDecision}`:"",p=s>0?` | ${s} unresolved`:"";i("pr-status-enricher",`PR: ${r.title}${c} [${r.state}${l}${p}]`),i("pr-status-enricher",`URL: ${r.url}`)}catch{i("pr-status-enricher","No PR found or gh CLI unavailable")}return a()}import{existsSync as P,readFileSync as Yn,mkdirSync as Zn,readdirSync as Et,unlinkSync as Dt,copyFileSync as Qn}from"node:fs";function Xn(t){if(!P(t))return 0;try{let n=JSON.parse(Yn(t,"utf-8")).tools||{};return Object.values(n).reduce((o,r)=>o+r,0)}catch{return 0}}function to(t,e){if(!P(t))return;let n=Xn(t);if(n<=5){i("session-cleanup",`Session had only ${n} tool calls, not archiving`);return}try{Zn(e,{recursive:!0});let r=`session-${new Date().toISOString().replace(/[:.]/g,"-")}.json`,s=`${e}/${r}`;Qn(t,s),i("session-cleanup",`Archived session metrics to ${r}`)}catch(o){i("session-cleanup",`Failed to archive metrics: ${o}`)}}function eo(t,e=20){if(P(t))try{let n=Et(t).filter(r=>r.startsWith("session-")&&r.endsWith(".json")).sort().reverse();if(n.length<=e)return;let o=n.slice(e);for(let r of o)try{Dt(`${t}/${r}`),i("session-cleanup",`Deleted old archive: ${r}`)}catch{}}catch(n){i("session-cleanup",`Failed to cleanup old archives: ${n}`)}}function no(t){if(!P(t))return;let e=["hooks.log.old*","audit.log.old*"];for(let n of e)try{let o=n.replace("*",""),r=Et(t).filter(c=>c.startsWith(o)).sort().reverse();if(r.length<=5)continue;let s=r.slice(5);for(let c of s)try{Dt(`${t}/${c}`)}catch{}}catch{}}function Pt(t){i("session-cleanup","Session cleanup starting");let e=t.project_dir||u(),n="/tmp/claude-session-metrics.json",o=`${e}/.claude/logs/sessions`,r=`${e}/.claude/logs`;return to(n,o),eo(o,20),no(r),i("session-cleanup","Session cleanup complete"),a()}import{existsSync as q,readFileSync as Tt}from"node:fs";function T(t){if(!q(t))return!1;try{return JSON.parse(Tt(t,"utf-8")),!0}catch{return!1}}function jt(t){i("session-context-loader","Session starting - loading context (Protocol 2.0)");let e=t.project_dir||u(),n=0,o=process.env.AGENT_TYPE||"",r=`${e}/.claude/context/session/state.json`,s=`${e}/.claude/context/identity.json`,c=`${e}/.claude/context/knowledge/index.json`;T(r)&&(i("session-context-loader","Session state loaded"),n++),T(s)&&(i("session-context-loader","Identity loaded"),n++),T(c)&&(i("session-context-loader","Knowledge index available"),n++);let l=`${e}/docs/CURRENT_STATUS.md`;if(q(l)&&i("session-context-loader","Current status document exists"),o){i("session-context-loader",`Agent-type aware initialization: ${o}`);let d=`${e}/.claude/agents/${o}.md`;q(d)&&(i("session-context-loader",`Agent configuration found: ${d}`),n++)}let p=`${e}/.claude/context/session/compaction-manifest.json`;if(T(p))try{let d=JSON.parse(Tt(p,"utf-8"));i("session-context-loader",`Compaction manifest loaded: session=${d.sessionId}, decisions=${(d.keyDecisions||[]).length}, files=${(d.filesTouched||[]).length}`),process.env.ORCHESTKIT_LAST_SESSION=d.sessionId||"",process.env.ORCHESTKIT_LAST_DECISIONS=JSON.stringify(d.keyDecisions||[]),n++}catch(d){i("session-context-loader",`Error loading compaction manifest: ${d}`)}return n>0&&(o?i("session-context-loader",`Session context loaded (Protocol 2.0) - Agent: ${o}`):i("session-context-loader","Session context loaded (Protocol 2.0)")),a()}import{existsSync as oo,readFileSync as ro,writeFileSync as Nt,mkdirSync as io}from"node:fs";import{execSync as so}from"node:child_process";function co(t){try{return so("git branch --show-current",{cwd:t,encoding:"utf-8",timeout:500,stdio:["pipe","pipe","pipe"]}).trim()}catch{return""}}function j(t){i("session-env-setup","Setting up session environment");let e=t.project_dir||u(),n=t.session_id||g(),o="/tmp/claude-session-metrics.json";try{io(`${e}/.claude/logs`,{recursive:!0})}catch{}let r=process.env.AGENT_TYPE||"";!r&&t.agent_type&&(r=t.agent_type);let s={session_id:n,started_at:new Date().toISOString(),agent_type:r,tools:{},errors:0,warnings:0};try{Nt(o,JSON.stringify(s,null,2)),i("session-env-setup","Initialized session metrics")}catch(p){i("session-env-setup",`Failed to initialize metrics: ${p}`)}let c=`${e}/.claude/context/session/state.json`;if(oo(c)&&r)try{let p=JSON.parse(ro(c,"utf-8"));p.agent_type=r,p.session_id=n,p.last_activity=new Date().toISOString(),Nt(c,JSON.stringify(p,null,2)),i("session-env-setup",`Updated session state with agent_type: ${r}`)}catch(p){i("session-env-setup",`Failed to update session state: ${p}`)}let l=co(e);return l&&i("session-env-setup",`Git branch: ${l}`),r&&i("session-env-setup",`Agent type: ${r}`),a()}import{existsSync as Kt,appendFileSync as ko,mkdirSync as _o,readFileSync as vo,writeFileSync as bo}from"node:fs";import{existsSync as ao,readFileSync as uo,writeFileSync as Ki,mkdirSync as Ji}from"node:fs";import{execSync as Ft}from"node:child_process";import{createHash as lo}from"node:crypto";import*as At from"node:os";var po=".claude/.user_identity.json",mo="orchestkit-user-identity-v1";var h=null;function N(t){return lo("sha256").update(t+mo).digest("hex").slice(0,32)}function go(){try{return At.hostname()}catch{return"unknown-machine"}}function fo(t){let e=`${t}/${po}`;if(!ao(e))return null;try{let n=uo(e,"utf8");return JSON.parse(n)}catch(n){return i("user-identity",`Failed to read user config: ${n}`,"warn"),null}}function yo(t){let e={};try{e.email=Ft("git config user.email",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}try{e.name=Ft("git config user.name",{cwd:t,encoding:"utf8",timeout:2e3,stdio:["pipe","pipe","pipe"]}).trim()}catch{}return e}function ho(){return{username:process.env.USER||process.env.USERNAME||process.env.LOGNAME}}function So(t){if(h)return h;let e=t||u(),n=go(),o=fo(e);if(o?.user_id)return h={user_id:o.user_id,display_name:o.display_name||o.user_id,team_id:o.team_id,machine_id:n,source:"config",anonymous_id:N(o.user_id),email:o.user_id.includes("@")?o.user_id:void 0},i("user-identity",`Resolved from config: ${h.anonymous_id}`,"debug"),h;let r=yo(e);if(r.email)return h={user_id:r.email,display_name:r.name||r.email.split("@")[0],team_id:o?.team_id,machine_id:n,source:"git",anonymous_id:N(r.email),email:r.email},i("user-identity",`Resolved from git: ${h.anonymous_id}`,"debug"),h;let s=ho();if(s.username){let l=`${s.username}@${n}`;return h={user_id:l,display_name:s.username,team_id:o?.team_id,machine_id:n,source:"env",anonymous_id:N(l)},i("user-identity",`Resolved from env: ${h.anonymous_id}`,"debug"),h}let c=N(n+process.pid);return h={user_id:`anon-${c.slice(0,8)}`,display_name:"Anonymous",team_id:o?.team_id,machine_id:n,source:"anonymous",anonymous_id:c},i("user-identity",`Resolved as anonymous: ${h.anonymous_id}`,"debug"),h}function Lt(){let t=So();return{session_id:g(),user_id:t.user_id,anonymous_id:t.anonymous_id,team_id:t.team_id,machine_id:t.machine_id,identity_source:t.source,timestamp:new Date().toISOString()}}var Io=/^[a-zA-Z0-9_-]{1,128}$/;function xo(t){return Io.test(t)}function Q(t,e){let n=t||g(),o=e||u();if(!xo(n))throw new Error("Invalid session ID format");return`${o}/.claude/memory/sessions/${n}`}function $o(t,e){return`${Q(t,e)}/events.jsonl`}function Jt(t,e){let n=Q(t,e);Kt(n)||_o(n,{recursive:!0})}var b=0,Ut=!1,Y=!1,Mt=0,wo=5e3;function Bt(t,e){return`${Q(t,e)}/counter.json`}function Ho(t,e){if(!Ut){Ut=!0;try{let n=Bt(t,e);if(Kt(n)){let o=JSON.parse(vo(n,"utf8"));typeof o.counter=="number"&&o.counter>0&&(b=o.counter,i("session-tracker",`Loaded event counter: ${b}`,"debug"))}}catch{}}}function Co(t,e){if(!Y)return;let n=Date.now();if(!(n-Mt<wo))try{Jt(t,e);let o=Bt(t,e);bo(o,JSON.stringify({counter:b,updated_at:new Date().toISOString()})),Y=!1,Mt=n}catch{}}function Ro(){return Ho(),b++,Y=!0,Co(),`evt-${Date.now()}-${b}`}function Oo(t,e,n={}){try{let o={event_id:Ro(),event_type:t,identity:Lt(),payload:{name:e,input:Z(n.input),output:Z(n.output),duration_ms:n.duration_ms,success:n.success??!0,context:n.context?zt(n.context,500):void 0,confidence:n.confidence}};Jt();let r=$o();ko(r,JSON.stringify(o)+`
`),i("session-tracker",`Tracked ${t}: ${e}`,"debug")}catch(o){i("session-tracker",`Failed to track event: ${o}`,"warn")}}function Eo(t){return t>=5&&t<12?"morning":t>=12&&t<17?"afternoon":t>=17&&t<21?"evening":"night"}function Wt(t){let e=new Date,n={project_dir:t?.project_dir,git_branch:t?.git_branch,time_of_day:t?.time_of_day||Eo(e.getHours()),started_at:e.toISOString()};Oo("session_start","session",{success:!0,input:n})}function zt(t,e){return t.length<=e?t:t.slice(0,e-3)+"..."}function Z(t){if(!t)return;let e={},n=["password","secret","token","key","credential","auth"];for(let[o,r]of Object.entries(t)){if(n.some(s=>o.toLowerCase().includes(s))){e[o]="[REDACTED]";continue}if(typeof r=="string"&&r.length>500){e[o]=zt(r,500);continue}if(typeof r=="object"&&r!==null&&!Array.isArray(r)){e[o]=Z(r);continue}e[o]=r}return e}import{execSync as Do}from"node:child_process";function Po(t){try{return Do("git rev-parse --abbrev-ref HEAD",{cwd:t,encoding:"utf8",timeout:5e3,stdio:["pipe","pipe","pipe"]}).trim()||void 0}catch{return}}function F(t){try{let e=t.project_dir||u(),n=Po(e);return Wt({project_dir:e,git_branch:n}),i("session-tracking",`Tracked session start: branch=${n||"unknown"}`,"debug"),a()}catch(e){return i("session-tracking",`Error: ${e}`,"warn"),a()}}import{existsSync as To,readFileSync as jo}from"node:fs";function Vt(t){i("session-metrics-summary","Session ending - generating summary");let e="/tmp/claude-session-metrics.json";if(!To(e))return i("session-metrics-summary","No metrics file found"),a();try{let n=JSON.parse(jo(e,"utf-8")),o=n.tools||{},r=n.errors||0,s=Object.values(o).reduce((l,p)=>l+p,0),c=Object.entries(o).sort(([,l],[,p])=>p-l).slice(0,3).map(([l,p])=>`${l}: ${p}`).join(", ");i("session-metrics-summary",`Session stats: ${s} tool calls, ${r} errors`),s>0&&i("session-metrics-summary",`Top tools: ${c}`)}catch(n){i("session-metrics-summary",`Failed to read metrics: ${n}`)}return a()}import{existsSync as _,readFileSync as tt,writeFileSync as No,mkdirSync as Fo}from"node:fs";var Ao=[{package:"lodash",pattern:"<4.17.21",severity:"high",cve:"CVE-2021-23337",description:"Prototype pollution"},{package:"minimist",pattern:"<1.2.6",severity:"critical",cve:"CVE-2021-44906",description:"Prototype pollution"},{package:"node-fetch",pattern:"<2.6.7",severity:"high",cve:"CVE-2022-0235",description:"Information exposure"},{package:"axios",pattern:"<0.21.2",severity:"high",cve:"CVE-2021-3749",description:"ReDoS vulnerability"},{package:"jsonwebtoken",pattern:"<9.0.0",severity:"critical",cve:"CVE-2022-23529",description:"Insecure token verification"},{package:"express",pattern:"<4.17.3",severity:"medium",cve:"CVE-2022-24999",description:"Open redirect"},{package:"tar",pattern:"<6.1.11",severity:"critical",cve:"CVE-2021-37701",description:"Arbitrary file overwrite"},{package:"path-parse",pattern:"<1.0.7",severity:"medium",cve:"CVE-2021-23343",description:"ReDoS vulnerability"},{package:"django",pattern:"<3.2.14",severity:"high",cve:"CVE-2022-34265",description:"SQL injection"},{package:"flask",pattern:"<2.0.2",severity:"medium",cve:"CVE-2021-28091",description:"Path traversal"},{package:"requests",pattern:"<2.28.0",severity:"medium",cve:"CVE-2023-32681",description:"Information disclosure"},{package:"urllib3",pattern:"<1.26.5",severity:"high",cve:"CVE-2021-33503",description:"ReDoS vulnerability"},{package:"pillow",pattern:"<9.0.0",severity:"high",cve:"CVE-2022-22817",description:"Buffer overflow"},{package:"pyyaml",pattern:"<5.4",severity:"critical",cve:"CVE-2020-14343",description:"Arbitrary code execution"},{package:"jinja2",pattern:"<3.0.3",severity:"medium",cve:"CVE-2020-28493",description:"XSS vulnerability"},{package:"sqlalchemy",pattern:"<1.4.46",severity:"medium",cve:"CVE-2023-30533",description:"SQL injection"}],Lo=24;function Uo(){return process.env.ORCHESTKIT_SKIP_SLOW_HOOKS==="1"}function Mo(t,e){let n=t.split(".").map(r=>parseInt(r,10)||0),o=e.split(".").map(r=>parseInt(r,10)||0);for(let r=0;r<Math.max(n.length,o.length);r++){let s=n[r]||0,c=o[r]||0;if(s<c)return!0;if(s>c)return!1}return!1}function Ko(t,e){let n=e.charAt(0),o=e.substring(1);return n==="<"?Mo(t,o):n==="="?t===o:!1}function Jo(t){return t.replace(/^[^~>=<]/,"").replace(/,.*$/,"").trim()}function Gt(t,e){let n=Jo(e),o=t.toLowerCase();for(let r of Ao)if(o===r.package&&Ko(n,r.pattern))return r;return null}function Bo(t){if(!_(t))return null;try{let e=JSON.parse(tt(t,"utf-8"));if((Date.now()-e.timestamp)/(1e3*60*60)<Lo)return e.warnings}catch{}return null}function X(t,e){try{Fo(t.replace(/\/[^/]+$/,""),{recursive:!0});let n={warnings:e,timestamp:Date.now()};No(t,JSON.stringify(n,null,2))}catch{}}function Wo(t){let e=0,n=0,o="";if(!_(t))return{criticalCount:e,highCount:n,warnings:o};try{let r=JSON.parse(tt(t,"utf-8")),s={...r.dependencies,...r.devDependencies};for(let[c,l]of Object.entries(s)){let p=Gt(c,l);p&&(p.severity==="critical"&&e++,p.severity==="high"&&n++,o+=`
- ${c}@${l}: ${p.description} (${p.cve}, ${p.severity}) - upgrade to ${p.pattern}`)}}catch{}return{criticalCount:e,highCount:n,warnings:o}}function zo(t){let e=0,n=0,o="";if(!_(t))return{criticalCount:e,highCount:n,warnings:o};try{let s=tt(t,"utf-8").split(`
`);for(let c of s){let l=c.trim();if(!l||l.startsWith("#"))continue;let p=l.match(/^([a-zA-Z0-9_-]+)(?:==|>=|~=|!=|<|>)\s*([0-9.]+)/);if(!p)continue;let[,d,f]=p,m=Gt(d,f);m&&(m.severity==="critical"&&e++,m.severity==="high"&&n++,o+=`
- ${d}==${f}: ${m.description} (${m.cve}, ${m.severity}) - upgrade to ${m.pattern}`)}}catch{}return{criticalCount:e,highCount:n,warnings:o}}function qt(t){if(Uo())return i("dependency-version-check","Skipping dependency check (ORCHESTKIT_SKIP_SLOW_HOOKS=1)"),a();i("dependency-version-check","Starting dependency version check");let e=t.project_dir||u(),n=`${e}/.claude/feedback/dependency-check-cache.json`,o=_(`${e}/package.json`),r=_(`${e}/requirements.txt`),s=_(`${e}/pyproject.toml`),c=_(`${e}/go.mod`);if(!o&&!r&&!s&&!c)return i("dependency-version-check","No package files found, skipping check"),X(n,"none"),a();let l=Bo(n);if(l!==null)return i("dependency-version-check","Using cached dependency warnings"),l!=="none"?K(`DEPENDENCY SECURITY CHECK (cached): ${l}`):a();let p=0,d=0,f="";if(o){let m=Wo(`${e}/package.json`);p+=m.criticalCount,d+=m.highCount,m.warnings&&(f+=`

Node.js (package.json):${m.warnings}`)}if(r){let m=zo(`${e}/requirements.txt`);p+=m.criticalCount,d+=m.highCount,m.warnings&&(f+=`

Python (requirements.txt):${m.warnings}`)}if(f){let m=`Found ${p} critical and ${d} high severity vulnerabilities`,ot=`DEPENDENCY SECURITY CHECK: ${m}${f}

Run 'npm audit' or 'pip-audit' for full details.`;if(X(n,ot),i("dependency-version-check",m),p>0||d>0)return K(ot)}else X(n,"none"),i("dependency-version-check","No known vulnerabilities found");return a()}import{existsSync as L,readFileSync as et,appendFileSync as Vo,mkdirSync as Go}from"node:fs";import{join as k,dirname as qo}from"node:path";function A(t){if(!L(t))return 0;try{return et(t,"utf8").trim().split(`
`).filter(n=>n.trim()).length}catch{return 0}}function Yt(t,e){let n={};if(!L(t))return n;try{let r=et(t,"utf8").trim().split(`
`).filter(s=>s.trim());for(let s of r)try{let c=JSON.parse(s),l=e.includes(".")?e.split(".").reduce((p,d)=>p?.[d],c):c[e];l&&typeof l=="string"&&(n[l]=(n[l]||0)+1)}catch{}}catch{}return n}function Yo(t){if(!L(t))return 0;try{let n=et(t,"utf8").trim().split(`
`).filter(r=>r.trim()),o=0;for(let r of n)try{JSON.parse(r).event==="session_start"&&o++}catch{}return o}catch{return 0}}function nt(t){let e=t||u(),n=k(e,".claude","memory"),o=k(e,".claude","logs"),r=k(n,"decisions.jsonl"),s=k(n,"graph-queue.jsonl"),c=k(n,"mem0-queue.jsonl"),l=k(n,"completed-flows.jsonl"),p=k(o,"mem0-analytics.jsonl");return{timestamp:new Date().toISOString(),decisions:{total:A(r),byCategory:Yt(r,"metadata.category"),byType:Yt(r,"type")},queues:{graphQueueDepth:A(s),mem0QueueDepth:A(c)},completedFlows:A(l),sessionCount:Yo(p),mem0Available:!!process.env.MEM0_API_KEY}}function Zt(t,e){let n=t||u(),o=k(n,".claude","logs","memory-metrics.jsonl"),r=e||nt(n);try{let s=qo(o);L(s)||Go(s,{recursive:!0}),Vo(o,JSON.stringify(r)+`
`),i("memory-metrics",`Metrics snapshot appended: ${r.decisions.total} decisions`,"debug")}catch(s){i("memory-metrics",`Failed to write metrics: ${s}`,"warn")}}function Qt(t){i("memory-metrics-collector","Collecting memory metrics");try{let e=t.project_dir||u(),n=nt(e);Zt(e,n)}catch(e){i("memory-metrics-collector",`Failed to collect metrics: ${e}`,"warn")}return a()}var Xt=[{name:"mem0-context-retrieval",fn:C},{name:"mem0-analytics-tracker",fn:H},{name:"pattern-sync-pull",fn:D},{name:"multi-instance-init",fn:O},{name:"instance-heartbeat",fn:w},{name:"session-env-setup",fn:j},{name:"session-tracking",fn:F},{name:"memory-metrics-collector",fn:Qt}];async function te(t){let e=await Promise.allSettled(Xt.map(async o=>{try{let r=o.fn(t);return r instanceof Promise&&await r,{hook:o.name,status:"success"}}catch(r){let s=r instanceof Error?r.message:String(r);return i("session-start-dispatcher",`${o.name} failed: ${s}`),{hook:o.name,status:"error",message:s}}})),n=[];for(let o of e)o.status==="rejected"?n.push("unknown"):o.value.status==="error"&&n.push(o.value.hook);return n.length>0&&i("session-start-dispatcher",`${n.length}/${Xt.length} hooks failed: ${n.join(", ")}`),a()}import{writeFileSync as Zo,existsSync as ne,readFileSync as Qo,mkdirSync as Xo}from"node:fs";import{join as ee}from"node:path";function tr(){let t=x(),e=ee(t,"sessions");return ne(e)||Xo(e,{recursive:!0}),ee(e,`${g()}-state.json`)}function er(t){try{if(ne(t))return JSON.parse(Qo(t,"utf8"))}catch{}return{}}function oe(t){try{let e=tr(),n=er(e);n.lastCompaction=new Date().toISOString(),n.compactionCount=(n.compactionCount||0)+1,n.preservedContext={branch:process.env.ORCHESTKIT_BRANCH||void 0,sessionNotes:`Compaction #${n.compactionCount} at ${n.lastCompaction}`},Zo(e,JSON.stringify(n,null,2)),i("pre-compact-saver",`Saved state before compaction #${n.compactionCount}`)}catch(e){let n=e instanceof Error?e.message:String(e);i("pre-compact-saver",`Failed to save state: ${n}`,"warn")}return a()}var re={"lifecycle/analytics-consent-check":ht,"lifecycle/coordination-cleanup":kt,"lifecycle/coordination-init":vt,"lifecycle/instance-heartbeat":w,"lifecycle/mem0-analytics-tracker":H,"lifecycle/mem0-context-retrieval":C,"lifecycle/mem0-webhook-setup":$t,"lifecycle/multi-instance-init":O,"lifecycle/pattern-sync-pull":D,"lifecycle/pattern-sync-push":Ct,"lifecycle/pr-status-enricher":Ot,"lifecycle/session-cleanup":Pt,"lifecycle/session-context-loader":jt,"lifecycle/session-env-setup":j,"lifecycle/session-tracking":F,"lifecycle/session-metrics-summary":Vt,"lifecycle/dependency-version-check":qt,"lifecycle/unified-dispatcher":te,"lifecycle/pre-compact-saver":oe};function Gs(t){return re[t]}function qs(){return Object.keys(re)}export{Tr as escapeRegex,Te as estimateTokenCount,Ae as extractIssueNumber,dt as getCachedBranch,je as getCurrentBranch,Mr as getDefaultBranch,pt as getEnvFile,Dr as getField,Fe as getGitStatus,Gs as getHook,x as getLogDir,Re as getLogLevel,Ce as getPluginRoot,u as getProjectDir,Ar as getRepoRoot,g as getSessionId,Ur as hasUncommittedChanges,re as hooks,nr as isBashInput,rr as isEditInput,Lr as isGitRepo,Ne as isProtectedBranch,ir as isReadInput,or as isWriteInput,qs as listHooks,i as logHook,Rr as logPermissionFeedback,Pr as normalizeCommand,vr as normalizeLineEndings,xr as outputAllowWithContext,Ir as outputBlock,Hr as outputDeny,$r as outputError,Ee as outputPromptContext,Or as outputPromptContextBudgeted,br as outputSilentAllow,a as outputSilentSuccess,wr as outputWarning,K as outputWithContext,Cr as outputWithUpdatedInput,Er as readHookInput,Oe as shouldLog,Kr as validateBranchName};
//# sourceMappingURL=lifecycle.mjs.map
